"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.useInitialValue = useInitialValue;
exports.useInitialValueResolverContext = useInitialValueResolverContext;

var _react = require("react");

var _studio = require("../../studio");

var _useUnique = require("../../util/useUnique");

var _datastores = require("../datastores");

var _hooks = require("../../hooks");

var _user = require("../user");

/**
 * @internal
 */
function useInitialValue(props) {
  const {
    documentId,
    documentType,
    templateName,
    templateParams: templateParamsRaw
  } = props;
  const templateParams = (0, _useUnique.useUnique)(templateParamsRaw);
  const documentStore = (0, _datastores.useDocumentStore)();
  const context = useInitialValueResolverContext();
  const defaultValue = (0, _react.useMemo)(() => ({
    _id: documentId,
    _type: documentType
  }), [documentId, documentType]);
  const [state, setState] = (0, _react.useState)({
    loading: false,
    error: null,
    value: defaultValue
  });
  (0, _react.useEffect)(() => {
    const initialValueOptions = {
      documentId,
      documentType,
      templateName,
      templateParams
    };

    if (!templateName) {
      setState({
        loading: true,
        error: null,
        value: defaultValue
      });
      return undefined;
    }

    const initialValueMsg$ = documentStore.initialValue(initialValueOptions, context);
    const sub = initialValueMsg$.subscribe(msg => {
      if (msg.type === 'loading') {
        setState({
          loading: true,
          error: null,
          value: defaultValue
        });
      }

      if (msg.type === 'success') {
        setState({
          loading: false,
          error: null,
          value: msg.value ? { ...defaultValue,
            ...msg.value
          } : defaultValue
        });
      }

      if (msg.type === 'error') {
        setState({
          loading: false,
          error: msg.error,
          value: defaultValue
        });
      }
    });
    setState({
      loading: true,
      error: null,
      value: defaultValue
    });
    return () => sub.unsubscribe();
  }, [defaultValue, documentId, documentStore, documentType, templateName, templateParams, context]);
  return state;
}
/**
 * @internal
 */


function useInitialValueResolverContext() {
  const source = (0, _studio.useSource)();
  const schema = (0, _hooks.useSchema)();
  const currentUser = (0, _user.useCurrentUser)();
  const projectId = (0, _hooks.useProjectId)();
  const dataset = (0, _hooks.useDataset)();
  const getClient = source.getClient;
  return (0, _react.useMemo)(() => {
    return {
      projectId,
      dataset,
      getClient,
      schema,
      currentUser
    };
  }, [getClient, schema, currentUser, projectId, dataset]);
}