const _excluded=["getClient","loginMethod","redirectOnSingle"],_excluded2=["projectId","dataset","loginMethod"],_excluded3=["collapsedProps","expandedProps","tooltipProps","tooltipText","dividerBefore","fontSize","padding","text","icon","selected"],_excluded4=["callback","children","options"],_excluded5=["hidden"],_excluded6=["collapsedProps","expandedProps","tooltipProps","tooltipText","dividerBefore"],_excluded7=["intent","params","target"],_excluded8=["onClick","href","target","replace"],_excluded9=["onClick","replace","state","target","toIndex"],_excluded10=["name"],_excluded11=["context","isDrawerOpen"],_excluded12=["children"],_excluded13=["ConfigErrorsComponent"],_excluded14=["user"],_excluded15=["user"],_excluded16=["children","selected","as"],_excluded17=["onIntersection","io","id"],_excluded18=["height"],_excluded19=["_upload"],_excluded20=["description","icon","layout","media","subtitle","title","value"],_excluded21=["layout","ordering","schemaType","style","value"],_excluded22=["documentId","documentType","onClick"],_excluded23=["name","logo","navbar","tools"],_excluded24=["resultRev"],_excluded25=["_id","_rev","_updatedAt"],_excluded26=["id","type","permission"],_excluded27=["document","permission"],_excluded28=["templateItems"],_excluded29=["_updatedAt"],_excluded30=["children"],_excluded31=["children","currentMinWidth","currentMaxWidth","flex","id","minWidth","maxWidth","selected"],_excluded32=["as","children","overflow","padding"],_excluded33=["children","minWidth","onCollapse","onExpand"],_excluded34=["intent"],_excluded35=["childId","childPayload","childParameters"],_excluded36=["documentId","documentType","parentRefPath","children","template"],_excluded37=["params","payload"],_excluded38=["params","payload"],_excluded39=["params","payload"],_excluded40=["as","onScroll"],_excluded41=["bounds"],_excluded42=["children","className","isReviewChangesOpen","onOpenReviewChanges","onSetFocus"],_excluded43=["children","status","suffix","title"],_excluded44=["children","open","icon","title"],_excluded45=["validation","__unstable_presence","children","description","inputId","level","title"],_excluded46=["validation","__unstable_presence","children","collapsible","columns","description","level","onFocus","onCollapse","onExpand","collapsed","tabIndex","title"],_excluded47=["value","onFocus","vertical"],_excluded48=["children"],_excluded49=["children"],_excluded50=["children"],_excluded51=["children"],_excluded52=["children"],_excluded53=["children"],_excluded54=["children"],_excluded55=["children"],_excluded56=["crop","diff","hash","hotspot","width","height"],_excluded57=["crop","width","height"],_excluded58=["hotspot","offset","width","height"],_excluded59=["children","diff","object","schemaType","path"],_excluded60=["diff","children","object","schemaType","path"],_excluded61=["diff","object","schemaType"],_excluded62=["diff","object","path","schemaType"],_excluded63=["diff","childDiff","children","path","segment"],_excluded64=["diff","childDiff","children","path","segment"],_excluded65=["fieldFilter"],_excluded66=["fieldFilter"],_excluded67=["diff","path"],_excluded68=["annotations","children","description"],_excluded69=["annotation","as","children","className","diff","disableHoverEffect","path","style","tooltip"],_excluded70=["direction"],_excluded71=["children","as","change"],_excluded72=["align","layout","from","to","style"],_excluded73=["selected"],_excluded74=["change","readOnly","hidden"],_excluded75=["badges","children","badgeProps"],_excluded76=["collapsed","status","lastUpdated"],_excluded77=["actionsBoxElement","activeIndex","children","id","onActionStart","onKeyDown","rootRef","states"],_excluded78=["actionsBoxElement","children"],_excluded79=["tone","dimmed","muted"],_excluded80=["plugins"],_excluded81=["config","context","initialValue","propertyName"],_excluded82=["children","status","title"],_excluded83=["enabled"],_excluded84=["createOptions","onCreate","id"],_excluded85=["isSortable","isGrid","onSortEnd"],_excluded86=["isSortable","isGrid"],_excluded87=["disabled","onChange","onFocus","placeholder","readOnly","value"],_excluded88=["onFiles","onFilesOver","onFilesOut","disabled"],_excluded89=["children","resolveUploader","onUpload","types"],_excluded90=["children"],_excluded91=["isSortable","value","onClick","onFocus","type","readOnly","presence","onInsert","insertableTypes","onRemove","renderPreview","validation"],_excluded92=["isSortable","value","onClick","onFocus","onInsert","insertableTypes","type","readOnly","presence","onRemove","renderPreview","validation"],_excluded93=["name","title"],_excluded94=["onClick","disabled"],_excluded95=["onChange","onBlur","onKeyPress","value"],_excluded96=["onChange"],_excluded97=["selectTime","onFocusedDateChange","selectedDate","focusedDate","timeStep","onSelect"],_excluded98=["value","onChange"],_excluded99=["value","inputValue","onInputChange","onChange","selectTime","timeStep"],_excluded100=["id","deserialize","formatInputValue","onChange","parseInputValue","placeholder","readOnly","selectTime","serialize","timeStep","value"],_excluded101=["icon","id","accept","capture","fontSize","multiple","onSelect","padding","space","textAlign","text","disabled"],_excluded102=["icon","id","accept","capture","fontSize","multiple","onSelect","padding","space","textAlign","text","disabled"],_excluded103=["readOnly","onDragStart","onDragEnd","onDrag"],_excluded104=["drag","readOnly","isRejected","src"],_excluded105=["unstable_sources"];var _templateObject,_templateObject2,_templateObject3,_templateObject4,_templateObject5,_templateObject6,_templateObject7,_templateObject8,_templateObject9,_templateObject10,_templateObject11,_templateObject12,_templateObject13,_templateObject14,_templateObject15,_templateObject16,_templateObject17,_templateObject18,_templateObject19,_templateObject20,_templateObject21,_templateObject22,_templateObject23,_templateObject24,_templateObject25,_templateObject26,_templateObject27,_templateObject28,_templateObject29,_templateObject30,_templateObject31,_templateObject32,_templateObject33,_templateObject34,_templateObject35,_templateObject36,_templateObject37,_templateObject38,_templateObject39,_templateObject40,_templateObject41,_templateObject42,_templateObject43,_templateObject44,_templateObject45,_templateObject46,_templateObject47,_templateObject48,_templateObject49,_templateObject50,_templateObject51,_templateObject52,_templateObject53,_templateObject54,_templateObject55,_templateObject56,_templateObject57,_templateObject58,_templateObject59,_templateObject60,_templateObject61,_templateObject62,_templateObject63,_templateObject64,_templateObject65,_templateObject66,_templateObject67,_templateObject68,_templateObject69,_templateObject70,_templateObject71,_templateObject72,_templateObject73,_templateObject74,_templateObject75,_templateObject76,_templateObject77,_templateObject78,_templateObject79,_templateObject80,_templateObject81,_templateObject82,_templateObject83,_templateObject84,_templateObject85,_templateObject86,_templateObject87,_templateObject88,_templateObject89,_templateObject90,_templateObject91,_templateObject92,_templateObject93,_templateObject94,_templateObject95,_templateObject96,_templateObject97,_templateObject98,_templateObject99,_templateObject100,_templateObject101,_templateObject102,_templateObject103,_templateObject104,_templateObject105,_templateObject106,_templateObject107,_templateObject108,_templateObject109,_templateObject110,_templateObject111,_templateObject112,_templateObject113,_templateObject114,_templateObject115,_templateObject116,_templateObject117,_templateObject118,_templateObject119,_templateObject120,_templateObject121,_templateObject122,_templateObject123,_templateObject124,_templateObject125,_templateObject126,_templateObject127,_templateObject128,_templateObject129,_templateObject130,_templateObject131,_templateObject132,_templateObject133,_templateObject134,_templateObject135,_templateObject136,_templateObject137,_templateObject138,_templateObject139,_templateObject140,_templateObject141,_templateObject142,_templateObject143,_templateObject144,_templateObject145,_templateObject146,_templateObject147,_templateObject148,_templateObject149,_templateObject150,_templateObject151,_templateObject152,_templateObject153,_templateObject154,_templateObject155,_templateObject156,_templateObject157,_templateObject158,_templateObject159,_templateObject160,_templateObject161,_templateObject162,_templateObject163,_templateObject164,_templateObject165,_templateObject166,_templateObject167,_templateObject168,_templateObject169,_templateObject170,_templateObject171,_templateObject172,_templateObject173,_templateObject174,_templateObject175,_templateObject176,_templateObject177,_templateObject178,_templateObject179,_templateObject180,_templateObject181,_templateObject182,_templateObject183,_templateObject184,_templateObject185,_templateObject186,_templateObject187,_templateObject188,_templateObject189,_templateObject190,_templateObject191,_templateObject192,_templateObject193,_templateObject194,_templateObject195,_templateObject196,_templateObject197,_templateObject198,_templateObject199,_templateObject200,_templateObject201,_templateObject202,_templateObject203,_templateObject204,_templateObject205,_templateObject206,_templateObject207,_templateObject208,_templateObject209,_templateObject210,_templateObject211,_templateObject212,_templateObject213,_templateObject214,_templateObject215,_templateObject216,_templateObject217,_templateObject218,_templateObject219,_templateObject220,_templateObject221,_templateObject222,_templateObject223,_templateObject224,_templateObject225,_templateObject226,_templateObject227,_templateObject228,_templateObject229,_templateObject230,_templateObject231,_templateObject232,_templateObject233,_templateObject234,_templateObject235,_templateObject236,_templateObject237,_templateObject238,_templateObject239,_templateObject240,_templateObject241,_templateObject242,_templateObject243,_templateObject244,_templateObject245,_templateObject246,_templateObject247,_templateObject248,_templateObject249,_templateObject250,_templateObject251,_templateObject252,_templateObject253,_templateObject254,_templateObject255,_templateObject256,_templateObject257,_templateObject258,_templateObject259,_templateObject260,_templateObject261,_templateObject262,_templateObject263,_templateObject264,_templateObject265,_templateObject266,_templateObject267,_templateObject268,_templateObject269,_templateObject270,_templateObject271,_templateObject272,_templateObject273,_templateObject274,_templateObject275,_templateObject276,_templateObject277,_templateObject278,_templateObject279,_templateObject280,_templateObject281,_templateObject282,_templateObject283,_templateObject284,_templateObject285,_templateObject286,_templateObject287,_templateObject288,_templateObject289,_templateObject290,_templateObject291,_templateObject292,_templateObject293,_templateObject294,_templateObject295,_templateObject296,_templateObject297,_templateObject298,_templateObject299,_templateObject300,_templateObject301,_templateObject302,_templateObject303,_templateObject304,_templateObject305,_templateObject306,_templateObject307,_templateObject308,_templateObject309,_templateObject310,_templateObject311,_templateObject312,_templateObject313,_templateObject314,_templateObject315,_templateObject316,_templateObject317,_templateObject318,_templateObject319,_templateObject320,_templateObject321,_templateObject322,_templateObject323,_templateObject324,_templateObject325,_templateObject326,_templateObject327,_templateObject328,_templateObject329,_templateObject330;function _objectWithoutProperties(source,excluded){if(source==null)return{};var target=_objectWithoutPropertiesLoose(source,excluded);var key,i;if(Object.getOwnPropertySymbols){var sourceSymbolKeys=Object.getOwnPropertySymbols(source);for(i=0;i<sourceSymbolKeys.length;i++){key=sourceSymbolKeys[i];if(excluded.indexOf(key)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(source,key))continue;target[key]=source[key];}}return target;}function _objectWithoutPropertiesLoose(source,excluded){if(source==null)return{};var target={};var sourceKeys=Object.keys(source);var key,i;for(i=0;i<sourceKeys.length;i++){key=sourceKeys[i];if(excluded.indexOf(key)>=0)continue;target[key]=source[key];}return target;}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;})),keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}return target;}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _taggedTemplateLiteral(strings,raw){if(!raw){raw=strings.slice(0);}return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}import{distinctUntilChanged,switchMap,map,scan,catchError,filter,shareReplay,startWith,tap,mergeMapTo,takeUntil,take,mergeMap,toArray as toArray$1,mergeScan,share,delay,combineAll,mergeAll,publishReplay,refCount,mapTo,withLatestFrom,concatMap,groupBy as groupBy$1,throttleTime,last,debounceTime,first,auditTime,switchMapTo,flatMap,pairwise,concat as concat$1,merge as merge$1}from'rxjs/operators';import{Flex,Text as Text$1,Spinner,Stack,Heading,Button,MenuButton,Menu,MenuDivider,MenuItem,useElementRect,Tooltip,Box,usePrefersDark,ThemeProvider,studioTheme,LayerProvider,Card,Breadcrumbs,Container as Container$1,Inline,Label,Dialog,useToast,Code,ErrorBoundary,ToastProvider,Avatar,rem,TextSkeleton,Skeleton,Grid,AvatarStack,Layer,useGlobalKeyDown,Portal,AvatarCounter,Popover,Autocomplete,PortalProvider,Badge,useMediaIndex,useForwardedRef,BoundaryElementProvider,rgba,_raf2,useLayer,useClickOutside,useTheme as useTheme$1,Hotkeys,useBoundaryElement,usePortal,TextInput as TextInput$1,TabList,Tab,TabPanel,DialogProvider,useRootTheme,Checkbox as Checkbox$1,isHTMLElement,MenuGroup,Radio,Select,Switch as Switch$1,ElementQuery,TextArea,LabelSkeleton}from'@sanity/ui';import{isEqual as isEqual$1,throttle,memoize as memoize$1,intersection,difference,pick,flatten as flatten$1,identity,startCase,escapeRegExp as escapeRegExp$1,capitalize,omit,orderBy,keyBy,uniq,compact,words,toLower,union,flow,sortBy,debounce,uniqBy,groupBy,get as get$2,isPlainObject,isString as isString$1,values,sample,uniqueId,partition as partition$1,kebabCase,camelCase,pickBy,find,castArray,xor,upperFirst,negate as negate$1,assignWith,isNumber,once,findIndex as findIndex$1,clone,isObject,range}from'lodash';import{fromUrl}from'@sanity/bifur-client';import React,{useRef,useMemo,useEffect,useState,forwardRef,useCallback,cloneElement,createContext,useContext,createElement,isValidElement,Fragment as Fragment$1,memo,Suspense,useImperativeHandle,lazy,createRef,useLayoutEffect,useReducer}from'react';import{isValidElementType}from'react-is';import SchemaBuilder from'@sanity/schema';import{validateSchema,groupProblems,isActionEnabled}from'@sanity/schema/_internal';import{inferFromSchema,validateDocument}from'@sanity/validation';import createClient from'@sanity/client';import{concat,of,fromEvent,Subject,merge,defer,throwError,timer,NEVER,from,empty,Observable,combineLatest,EMPTY as EMPTY$1,isObservable,BehaviorSubject,asyncScheduler,partition,ReplaySubject,forkJoin}from'rxjs';import{useAsObservable,useObservable,useMemoObservable,useObservableCallback}from'react-rx';import shallowEquals from'shallow-equals';import{ResizeObserver as ResizeObserver$1}from'@juggle/resize-observer';import createPubSub from'nano-pubsub';import{jsx,jsxs,Fragment}from'react/jsx-runtime';import styled,{css,useTheme,keyframes}from'styled-components';import{observableCallback}from'observable-callback';import{EllipsisVerticalIcon,UnknownIcon,PlugIcon,ErrorOutlineIcon,WarningOutlineIcon,CheckmarkIcon,ArrowLeftIcon,AddIcon,ChevronRightIcon,SelectIcon,ChevronDownIcon,SunIcon,MoonIcon,CogIcon,LeaveIcon,AccessDeniedIcon,ComposeIcon,LinkIcon,UsersIcon,CloseIcon,DocumentIcon,SearchIcon,ToggleArrowRightIcon,PackageIcon,MenuIcon,TrashIcon,ChevronUpIcon,DownloadIcon,ImageIcon,DocumentsIcon,SortIcon,SyncIcon,InfoOutlineIcon,BulbOutlineIcon,EyeOpenIcon,EditIcon,BoldIcon,ItalicIcon,StrikethroughIcon,UnderlineIcon,CodeIcon,OlistIcon,UlistIcon,BlockElementIcon,InlineElementIcon,CollapseIcon,ExpandIcon,ArrowDownIcon,ArrowRightIcon,RevertIcon,AddCircleIcon,PublishIcon,UnpublishIcon,ReadOnlyIcon,SplitVerticalIcon,PlayIcon,RestoreIcon,BinaryDocumentIcon,EarthAmericasIcon,ClipboardIcon,ResetIcon,CopyIcon,HelpCircleIcon,LaunchIcon,UploadIcon,DragHandleIcon,InsertAboveIcon,InsertBelowIcon,ChevronLeftIcon,CalendarIcon,CropIcon}from'@sanity/icons';import Debug from'debug';import Refractor from'react-refractor';import bash from'refractor/lang/bash';import javascript from'refractor/lang/javascript';import json from'refractor/lang/json';import jsx2 from'refractor/lang/jsx';import typescript from'refractor/lang/typescript';import{COLOR_HUES,hues}from'@sanity/color';import{createMemoryHistory,createBrowserHistory}from'history';import{useHotModuleReload}from'use-hot-module-reload';import'react-dom';import{differenceInMonths,differenceInYears,format,differenceInWeeks,differenceInDays,differenceInHours,differenceInMinutes,differenceInSeconds,getWeek,startOfMonth,eachWeekOfInterval,lastDayOfMonth,addDays,isSameDay,isSameMonth,setDate,setMonth,addMonths,setYear,setMinutes,setHours,parseISO,getMinutes}from'date-fns';import pluralize from'pluralize-esm';import imageUrlBuilder from'@sanity/image-url';import{isImage,isReference as isReference$1,isBlock,isSpan,isTitledListValue,isCrossDatasetReferenceSchemaType,isCrossDatasetReference,isReferenceSchemaType,isObjectSchemaType,isArraySchemaType,isKeyedObject,isPrimitiveSchemaType,isKeySegment,isIndexSegment,isIndexTuple,isNumberSchemaType,isBooleanSchemaType,isStringSchemaType,isArrayOfObjectsSchemaType,isArrayOfPrimitivesSchemaType,isTypedObject,isValidationErrorMarker,isValidationWarningMarker,isValidationInfoMarker}from'@sanity/types';import classNames from'classnames';import{getDevicePixelRatio as getDevicePixelRatio$2}from'use-device-pixel-ratio';import{Mutation,BufferedDocument,arrayToJSONMatchPath}from'@sanity/mutator';import reduceJSON from'json-reduce';import{exhaustMapToWithTrailing}from'rxjs-exhaustmap-with-trailing';import{randomKey as randomKey$1,isEmpty as isEmpty$3,resolveTypeName as resolveTypeName$1}from'@sanity/util/content';import*as PathUtils from'@sanity/util/paths';import{toString,startsWith,isEqual as isEqual$2,trimLeft,pathFor,trimChildPath,FOCUS_TERMINATOR,fromString,get as get$3}from'@sanity/util/paths';import DataLoader from'dataloader';import raf from'raf';import{parse,evaluate}from'groq-js';import{refCountDelay}from'rxjs-etc/operators';import{applyPatch as applyPatch$1,incremental}from'mendoza';import{diffInput,wrap as wrap$1}from'@sanity/diff';import{nanoid}from'nanoid';import{uuid}from'@sanity/uuid';import{darken,lighten,hasBadContrast,readableColor}from'color2k';import{useId}from'@reach/auto-id';import deepCompare from'react-fast-compare';import{SortableHandle,SortableElement,SortableContainer}from'react-sortable-hoc';import{usePortableTextEditor,PortableTextEditor,usePortableTextEditorSelection,PortableTextEditable}from'@sanity/portable-text-editor';import scrollIntoView$1 from'scroll-into-view-if-needed';import getRandomValues from'get-random-values-esm';import{normalizeBlock}from'@sanity/block-tools';import exif from'exif-component';import*as DMP from'diff-match-patch';import{diff_match_patch,DIFF_INSERT,DIFF_DELETE,DIFF_EQUAL}from'diff-match-patch';import isValidDate$1 from'date-fns/isValid';import*as legacyDateFormat from'@sanity/util/legacyDateFormat';import{format as format$1,parse as parse$1}from'@sanity/util/legacyDateFormat';import FocusLock from'react-focus-lock';import speakingurl from'speakingurl';import{getProject,getImageDimensions,isDefaultCrop,isDefaultHotspot,isImageSource,isFileSource}from'@sanity/asset-utils';import formatDistanceToNow from'date-fns/formatDistanceToNow';import{generateHelpUrl}from'@sanity/generate-help-url';import isHotkey from'is-hotkey';import{CopyToClipboard}from'react-copy-to-clipboard';import{diffItem}from'sanity-diff-patch';import JSONInspector from'@rexxars/react-json-inspector';import HLRU from'hashlru';import{motion}from'framer-motion';import{withPropsStream}from'react-props-stream';import{SanityLogo,SanityMonogram}from'@sanity/logos';import{PortableText as PortableText$1}from'@portabletext/react';const SANITY_VERSION="0.0.0-development";var slug={title:"Slug",name:"slug",type:"object",fields:[{name:"current",title:"Current slug",type:"string"},{name:"source",title:"Source field",type:"string",hidden:true}]};var geopoint={title:"Geographical Point",name:"geopoint",type:"object",fields:[{name:"lat",type:"number",title:"Latitude"},{name:"lng",type:"number",title:"Longitude"},{name:"alt",type:"number",title:"Altitude"}]};var imageCrop={name:"sanity.imageCrop",title:"Image crop",type:"object",fields:[{name:"top",type:"number"},{name:"bottom",type:"number"},{name:"left",type:"number"},{name:"right",type:"number"}]};var imageHotspot={name:"sanity.imageHotspot",title:"Image hotspot",type:"object",fields:[{name:"x",type:"number"},{name:"y",type:"number"},{name:"height",type:"number"},{name:"width",type:"number"}]};var assetSourceData={name:"sanity.assetSourceData",title:"Asset Source Data",type:"object",fields:[{name:"name",title:"Source name",description:"A canonical name for the source this asset is originating from",type:"string"},{name:"id",title:"Asset Source ID",description:"The unique ID for the asset within the originating source so you can programatically find back to it",type:"string"},{name:"url",title:"Asset information URL",description:"A URL to find more information about this asset in the originating source",type:"string"}]};var imageAsset={name:"sanity.imageAsset",title:"Image",type:"document",fieldsets:[{name:"system",title:"System fields",description:"These fields are managed by the system and not editable"}],fields:[{name:"originalFilename",type:"string",title:"Original file name",readOnly:true},{name:"label",type:"string",title:"Label"},{name:"title",type:"string",title:"Title"},{name:"description",type:"string",title:"Description"},{name:"altText",type:"string",title:"Alternative text"},{name:"sha1hash",type:"string",title:"SHA1 hash",readOnly:true,fieldset:"system"},{name:"extension",type:"string",readOnly:true,title:"File extension",fieldset:"system"},{name:"mimeType",type:"string",readOnly:true,title:"Mime type",fieldset:"system"},{name:"size",type:"number",title:"File size in bytes",readOnly:true,fieldset:"system"},{name:"assetId",type:"string",title:"Asset ID",readOnly:true,fieldset:"system"},{name:"uploadId",type:"string",readOnly:true,hidden:true,fieldset:"system"},{name:"path",type:"string",title:"Path",readOnly:true,fieldset:"system"},{name:"url",type:"string",title:"Url",readOnly:true,fieldset:"system"},{name:"metadata",type:"sanity.imageMetadata",title:"Metadata"},{name:"source",type:"sanity.assetSourceData",title:"Source",readOnly:true,fieldset:"system"}],preview:{select:{id:"_id",title:"originalFilename",mimeType:"mimeType",size:"size"},prepare(doc){return{title:doc.title||typeof doc.path==="string"&&doc.path.split("/").slice(-1)[0],media:{asset:{_ref:doc.id}},subtitle:"".concat(doc.mimeType," (").concat((Number(doc.size)/1024/1024).toFixed(2)," MB)")};}},orderings:[{title:"File size",name:"fileSizeDesc",by:[{field:"size",direction:"desc"}]}]};var imagePalette={name:"sanity.imagePalette",title:"Image palette",type:"object",fields:[{name:"darkMuted",type:"sanity.imagePaletteSwatch",title:"Dark Muted"},{name:"lightVibrant",type:"sanity.imagePaletteSwatch",title:"Light Vibrant"},{name:"darkVibrant",type:"sanity.imagePaletteSwatch",title:"Dark Vibrant"},{name:"vibrant",type:"sanity.imagePaletteSwatch",title:"Vibrant"},{name:"dominant",type:"sanity.imagePaletteSwatch",title:"Dominant"},{name:"lightMuted",type:"sanity.imagePaletteSwatch",title:"Light Muted"},{name:"muted",type:"sanity.imagePaletteSwatch",title:"Muted"}]};var imagePaletteSwatch={name:"sanity.imagePaletteSwatch",title:"Image palette swatch",type:"object",fields:[{name:"background",type:"string",title:"Background",readOnly:true},{name:"foreground",type:"string",title:"Foreground",readOnly:true},{name:"population",type:"number",title:"Population",readOnly:true},{name:"title",type:"string",title:"String",readOnly:true}]};var imageDimensions={name:"sanity.imageDimensions",type:"object",title:"Image dimensions",fields:[{name:"height",type:"number",title:"Height",readOnly:true},{name:"width",type:"number",title:"Width",readOnly:true},{name:"aspectRatio",type:"number",title:"Aspect ratio",readOnly:true}]};var imageMetadata={name:"sanity.imageMetadata",title:"Image metadata",type:"object",fieldsets:[{name:"extra",title:"Extra metadata\u2026",options:{collapsable:true}}],fields:[{name:"location",type:"geopoint"},{name:"dimensions",title:"Dimensions",type:"sanity.imageDimensions",fieldset:"extra"},{name:"palette",type:"sanity.imagePalette",title:"Palette",fieldset:"extra"},{name:"lqip",title:"LQIP (Low-Quality Image Placeholder)",type:"string",readOnly:true},{name:"blurHash",title:"BlurHash",type:"string",readOnly:true},{name:"hasAlpha",title:"Has alpha channel",type:"boolean",readOnly:true},{name:"isOpaque",title:"Is opaque",type:"boolean",readOnly:true}]};var fileAsset={name:"sanity.fileAsset",title:"File",type:"document",fieldsets:[{name:"system",title:"System fields",description:"These fields are managed by the system and not editable"}],fields:[{name:"originalFilename",type:"string",title:"Original file name",readOnly:true},{name:"label",type:"string",title:"Label"},{name:"title",type:"string",title:"Title"},{name:"description",type:"string",title:"Description"},{name:"altText",type:"string",title:"Alternative text"},{name:"sha1hash",type:"string",title:"SHA1 hash",readOnly:true,fieldset:"system"},{name:"extension",type:"string",title:"File extension",readOnly:true,fieldset:"system"},{name:"mimeType",type:"string",title:"Mime type",readOnly:true,fieldset:"system"},{name:"size",type:"number",title:"File size in bytes",readOnly:true,fieldset:"system"},{name:"assetId",type:"string",title:"Asset ID",readOnly:true,fieldset:"system"},{name:"path",type:"string",title:"Path",readOnly:true,fieldset:"system"},{name:"url",type:"string",title:"Url",readOnly:true,fieldset:"system"},{name:"source",type:"sanity.assetSourceData",title:"Source",readOnly:true,fieldset:"system"}],preview:{select:{title:"originalFilename",path:"path",mimeType:"mimeType",size:"size"},prepare(doc){return{title:doc.title||doc.path.split("/").slice(-1)[0],subtitle:"".concat(doc.mimeType," (").concat((doc.size/1024/1024).toFixed(2)," MB)")};}},orderings:[{title:"File size",name:"fileSizeDesc",by:[{field:"size",direction:"desc"}]}]};const isError=problem=>problem.severity==="error";const builtinTypes=[assetSourceData,slug,geopoint,imageAsset,fileAsset,imageCrop,imageHotspot,imageMetadata,imageDimensions,imagePalette,imagePaletteSwatch];function createSchema(schemaDef){const validated=validateSchema(schemaDef.types).getTypes();const validation=groupProblems(validated);const hasErrors=validation.some(group=>group.problems.some(isError));const compiled=SchemaBuilder.compile({name:schemaDef.name,types:hasErrors?[]:[...schemaDef.types,...builtinTypes].filter(Boolean)});compiled._validation=validation;return inferFromSchema(compiled);}class CorsOriginError extends Error{constructor(_ref2){let{projectId}=_ref2;super("CorsOriginError");this.projectId=projectId;}}function useUnique(value){const valueRef=useRef(value);if(!isEqual$1(valueRef.current,value)){valueRef.current=value;}return valueRef.current;}function defaultArgsAreEqual(prev,next){if(prev.length!==next.length)return false;for(let i=0;i<next.length;i++){if(!shallowEquals(prev[i],next[i]))return false;}return true;}function createHookFromObservableFactory(observableFactory,options){const{initialValue,argsAreEqual=defaultArgsAreEqual}=options||{};const initialLoadingTuple=[initialValue,true];const asLoadingTuple=args$=>args$.pipe(distinctUntilChanged(argsAreEqual),switchMap(distinctArgs=>concat(of({type:"loading"}),observableFactory(...distinctArgs).pipe(map(value=>({type:"value",value}))))),scan((_ref3,next)=>{let[prevValue]=_ref3;if(next.type==="loading")return[prevValue,true];return[next.value,false];},initialLoadingTuple),distinctUntilChanged((_ref4,_ref5)=>{let[prevValue,prevIsLoading]=_ref4;let[nextValue,nextIsLoading]=_ref5;if(prevValue!==nextValue)return false;if(prevIsLoading!==nextIsLoading)return false;return true;}),map(tuple=>({type:"tuple",tuple})),catchError(error=>of({type:"error",error})));return function useLoadableFromCreateLoadable(){for(var _len=arguments.length,args=new Array(_len),_key2=0;_key2<_len;_key2++){args[_key2]=arguments[_key2];}const _args=useUnique(args);const tuple$=useAsObservable(_args,asLoadingTuple);const result=useObservable(tuple$,{type:"tuple",tuple:initialLoadingTuple});if(result.type==="error")throw result.error;return result.tuple;};}function isNonNullable$4(value){return value!==null&&value!==void 0;}const DRAFTS_FOLDER="drafts";const DRAFTS_PREFIX="".concat(DRAFTS_FOLDER,".");function isDraftId(id){return id.startsWith(DRAFTS_PREFIX);}function getIdPair(id){return{draftId:getDraftId(id),publishedId:getPublishedId(id)};}function getDraftId(id){return isDraftId(id)?id:DRAFTS_PREFIX+id;}function getPublishedId(id){return isDraftId(id)?id.slice(DRAFTS_PREFIX.length):id;}function collate(documents){const byId=documents.reduce((res,doc)=>{const publishedId=getPublishedId(doc._id);let entry=res.get(publishedId);if(!entry){entry={id:publishedId,type:doc._type,published:void 0,draft:void 0};res.set(publishedId,entry);}entry[publishedId===doc._id?"published":"draft"]=doc;return res;},/* @__PURE__ */new Map());return Array.from(byId.values());}function removeDupes(documents){return collate(documents).map(entry=>entry.draft||entry.published).filter(isNonNullable$4);}function isRecord$2(value){return Boolean(value)&&typeof value==="object"&&!Array.isArray(value);}function isString(value){return typeof value==="string";}const ResizeObserver=typeof document==="object"&&typeof window==="object"&&window.ResizeObserver?window.ResizeObserver:ResizeObserver$1;const createSharedResizeObserver=()=>{const event=createPubSub();const resizeObserver2=new ResizeObserver(entries=>event.publish(entries));return{observe:(element,observer,options)=>{const unsubscribe=event.subscribe(entries=>{const entry=entries.find(e=>e.target===element);if(entry){observer(entry);}});resizeObserver2.observe(element,options);return()=>{unsubscribe();resizeObserver2.unobserve(element);};}};};const resizeObserver=createSharedResizeObserver();const BUNDLED_DOC_TYPES=["sanity.imageAsset","sanity.fileAsset"];function _isSanityDocumentTypeDefinition(def){return def.type==="document"&&BUNDLED_DOC_TYPES.includes(def.name);}function _isCustomDocumentTypeDefinition(def){return def.type==="document"&&!_isSanityDocumentTypeDefinition(def);}const GROQ_KEYWORDS=["match","in","asc","desc","true","false","null"];const VALID_FIELD=/^[a-zA-Z_][a-zA-Z0-9_]*$/;const fieldNeedsEscape=fieldName=>!VALID_FIELD.test(fieldName)||GROQ_KEYWORDS.includes(fieldName);const escapeField=fieldName=>"[\"".concat(fieldName,"\"]");const escapeFirst=fieldName=>"@".concat(escapeField(fieldName));const isEmptyArray=value=>Array.isArray(value)&&value.length===0;const joinPath=pathArray=>{let path="";for(let i=0;i<pathArray.length;i++){const pathSegment=pathArray[i];if(isEmptyArray(pathSegment)){path+="[]";continue;}const isFirst=i===0;const needsEscape=fieldNeedsEscape(pathSegment);if(needsEscape){path=isFirst?escapeFirst(pathSegment):"".concat(path).concat(escapeField(pathSegment));}else{path=isFirst?pathSegment:"".concat(path,".").concat(pathSegment);}}return path;};const LOADING_STATE$2={isLoading:true,value:void 0,error:null};function useLoadable(value$,initialValue){const initial=typeof initialValue==="undefined"?LOADING_STATE$2:{isLoading:false,value:initialValue,error:null};return useMemoObservable(()=>value$.pipe(asLoadable()),[value$],initial);}function asLoadable(){return value$=>value$.pipe(map(value=>({isLoading:false,value,error:null})),catchError(error=>of({isLoading:false,value:void 0,error})));}function useThrottledCallback(callback,wait,options){const throttledCallback=useMemo(()=>throttle(callback,wait,options),[callback,options,wait]);useEffect(()=>()=>{throttledCallback.flush();},[throttledCallback]);return throttledCallback;}const supportsLocalStorage$1=(()=>{const key="__tmp_supports_local_storage";try{if(typeof localStorage==="undefined"){return false;}localStorage.setItem(key,"---");localStorage.removeItem(key);return true;}catch(err){return false;}})();const memStore={};function setItem(key,value){if(supportsLocalStorage$1){localStorage[key]=value;}else{memStore[key]=value;}}function getItem(key){return supportsLocalStorage$1?localStorage[key]:memStore[key];}function removeItem(key){if(supportsLocalStorage$1){localStorage.removeItem(key);}else{delete memStore[key];}}function createBroadcastChannel(namespace){const storageEvents$=typeof window==="undefined"?of():fromEvent(window,"storage");const storageKey="__studio_local_storage_messaging_".concat(namespace);const broadcastedMessages$=new Subject();const messages$=merge(broadcastedMessages$,storageEvents$.pipe(filter(event=>event.key===storageKey),map(event=>event.newValue),filter(isNonNullable$4),map(newValue=>JSON.parse(newValue)))).pipe(shareReplay(1));function broadcast(message){try{setItem(storageKey,JSON.stringify(message));removeItem(storageKey);broadcastedMessages$.next(message);}catch(err){}}return{messages:messages$,broadcast};}const sidPattern=/sid=[^&]{20,}/;function consumeSessionId(){if(typeof window==="undefined"||typeof window.location!=="object"){return null;}const hash=window.location.hash;const[sidParam]=hash.match(sidPattern)||[];if(!sidParam){return null;}const sid=sidParam.slice(sidParam.indexOf("=")+1);const newHash=hash.replace(sidPattern,"");const newUrl=new URL(window.location.href);newUrl.hash=newHash.length>1?newHash:"";history.replaceState(null,"",newUrl);return sid;}const sessionId=consumeSessionId();const GithubRoot=styled.svg(_ref6=>{let{theme}=_ref6;const{fg}=theme.sanity.color.base;return css(_templateObject||(_templateObject=_taggedTemplateLiteral(["\n    fill: ",";\n  "])),fg);});const GithubLogo=()=>/* @__PURE__ */jsx(GithubRoot,{width:"1em",height:"1em",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 438.55 438.55",children:/* @__PURE__ */jsx("path",{d:"M409.13 114.57a218.32 218.32 0 0 0-79.8-79.8Q278.94 5.36 219.27 5.36T109.21 34.77a218.29 218.29 0 0 0-79.8 79.8Q0 165 0 224.63q0 71.67 41.83 128.91t108.06 79.23q7.71 1.43 11.42-2a11.17 11.17 0 0 0 3.69-8.57q0-.86-.14-15.42t-.14-25.41l-6.57 1.14a83.77 83.77 0 0 1-15.85 1 120.73 120.73 0 0 1-19.84-2 44.34 44.34 0 0 1-19.11-8.51 36.23 36.23 0 0 1-12.56-17.6l-2.86-6.57a71.34 71.34 0 0 0-9-14.56q-6.14-8-12.42-10.85l-2-1.43a21 21 0 0 1-3.71-3.43 15.66 15.66 0 0 1-2.57-4q-.86-2 1.43-3.29C61.2 310.42 64 310 68 310l5.71.85q5.71 1.14 14.13 6.85a46.08 46.08 0 0 1 13.85 14.84q6.57 11.71 15.85 17.85t18.7 6.14a81.19 81.19 0 0 0 16.27-1.42 56.78 56.78 0 0 0 12.85-4.29q2.57-19.14 14-29.41a195.49 195.49 0 0 1-29.36-5.13 116.52 116.52 0 0 1-26.83-11.14 76.86 76.86 0 0 1-23-19.13q-9.14-11.42-15-30t-5.8-42.81q0-34.55 22.56-58.82-10.57-26 2-58.24 8.28-2.57 24.55 3.85t23.84 11q7.57 4.56 12.13 7.71a206.2 206.2 0 0 1 109.64 0l10.85-6.85a153.65 153.65 0 0 1 26.26-12.56q15.13-5.71 23.13-3.14 12.84 32.26 2.28 58.24 22.55 24.27 22.56 58.82 0 24.27-5.85 43t-15.12 30a79.82 79.82 0 0 1-23.13 19 116.74 116.74 0 0 1-26.84 11.14 195.29 195.29 0 0 1-29.23 5.07q14.8 12.84 14.81 40.58v60.2a11.37 11.37 0 0 0 3.57 8.56q3.57 3.42 11.28 2 66.24-22 108.07-79.23t41.83-128.91q-.03-59.62-29.43-110.05z"})});const GoogleLogo=()=>/* @__PURE__ */jsxs("svg",{width:"1em",height:"1em",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48",children:[/* @__PURE__ */jsx("path",{d:"M11 24a13 13 0 0 1 .66-4.08l-7.4-5.66a22.18 22.18 0 0 0 0 19.49l7.4-5.67A13 13 0 0 1 11 24z",fill:"#fbbc05"}),/* @__PURE__ */jsx("path",{d:"M24 11a12.72 12.72 0 0 1 8.1 2.9l6.4-6.4a22 22 0 0 0-34.24 6.75l7.4 5.66A13 13 0 0 1 24 11z",fill:"#ea4335"}),/* @__PURE__ */jsx("path",{d:"M24 37a13 13 0 0 1-12.34-8.92l-7.4 5.66A21.93 21.93 0 0 0 24 46a21 21 0 0 0 14.33-5.48l-7-5.44A13.59 13.59 0 0 1 24 37zm-12.35-8.93l-7.4 5.67 7.4-5.66z",fill:"#34a853"}),/* @__PURE__ */jsx("path",{d:"M44.5 20H24v8.5h11.8a9.91 9.91 0 0 1-4.49 6.58l7 5.44C42.37 36.76 45 31.17 45 24a18.25 18.25 0 0 0-.5-4z",fill:"#4285f4"})]});function CustomLogo(props){const{provider}=props;return provider.logo?/* @__PURE__ */jsx("img",{src:provider.logo,alt:"Logo for ".concat(provider.name)}):void 0;}const providerLogos={google:GoogleLogo,github:GithubLogo,custom:CustomLogo};async function getProviders(_ref7){let{client,mode,providers:customProviders=[]}=_ref7;const{providers,thirdPartyLogin,sso}=await client.request({uri:"/auth/providers"});if(!customProviders.length)return providers;const custom=customProviders.map(provider=>{const isOfficial=providers.some(official=>official.url===provider.url);const isSupported=isOfficial||thirdPartyLogin||sso&&Object.values(sso).some(Boolean);return _objectSpread(_objectSpread({},provider),{},{custom:!isOfficial,supported:isSupported});});if(mode==="replace")return custom;return providers.filter(official=>custom.some(provider=>provider.url!==official.url)).concat(custom);}function createHrefForProvider(_ref8){let{loginMethod,projectId,url,basePath}=_ref8;const params=new URLSearchParams();params.set("origin","".concat(window.location.origin).concat(basePath));params.set("projectId",projectId);params.set("type",loginMethod);return"".concat(url,"?").concat(params);}function createLoginComponent(_ref9){let{getClient,loginMethod,redirectOnSingle}=_ref9,providerOptions=_objectWithoutProperties(_ref9,_excluded);const useClient=createHookFromObservableFactory(getClient);function LoginComponent(_ref10){let{projectId,basePath}=_ref10;const[providers,setProviders]=useState(null);const[error,setError]=useState(null);if(error)throw error;const[client]=useClient();useEffect(()=>{if(!client)return;getProviders(_objectSpread({client},providerOptions)).then(setProviders).catch(setError);},[client]);const redirectUrl=redirectOnSingle&&(providers==null?void 0:providers.length)===1&&(providers==null?void 0:providers[0])&&createHrefForProvider({loginMethod,projectId,url:providers[0].url,basePath});const loading=!providers||redirectUrl;useEffect(()=>{if(redirectUrl){window.location.href=redirectUrl;}},[redirectUrl]);if(loading){return/* @__PURE__ */jsxs(Flex,{align:"center",direction:"column",gap:4,justify:"center",padding:6,sizing:"border",children:[/* @__PURE__ */jsx(Text$1,{muted:true,children:"Loading\u2026"}),/* @__PURE__ */jsx(Spinner,{muted:true})]});}return/* @__PURE__ */jsxs(Stack,{space:4,children:[/* @__PURE__ */jsx(Heading,{align:"center",size:1,children:"Choose login provider"}),/* @__PURE__ */jsx(Stack,{space:2,children:providers.map((provider,index)=>/* @__PURE__ */jsx(Button,{icon:providerLogos[provider.name],as:"a",href:createHrefForProvider({loginMethod,projectId,url:provider.url,basePath}),mode:"ghost",text:provider.title},"".concat(provider.url,"_").concat(index)))})]});}return LoginComponent;}const getStorageKey=projectId=>{if(!projectId)throw new Error("Invalid project id");return"__studio_auth_token_".concat(projectId);};const getToken=projectId=>{try{const item=getItem(getStorageKey(projectId));if(item){const{token}=JSON.parse(item);if(token&&typeof token==="string"){return token;}}}catch(err){console.error(err);}return null;};const clearToken=projectId=>{try{removeItem(getStorageKey(projectId));}catch(err){console.error(err);}};const saveToken=_ref11=>{let{token,projectId}=_ref11;try{setItem(getStorageKey(projectId),JSON.stringify({token,time:new Date().toISOString()}));}catch(err){console.error(err);}};const getCurrentUser=async(client,broadcastToken)=>{var _a;try{const user=await client.request({uri:"/users/me",withCredentials:true,tag:"users.get-current"});return typeof(user==null?void 0:user.id)==="string"?user:null;}catch(err){if(err.statusCode===401){clearToken(client.config().projectId||"");broadcastToken(null);return null;}const invalidCorsConfig=await client.request({uri:"/ping",withCredentials:false,tag:"cors-check"}).then(()=>true,()=>false);if(invalidCorsConfig){throw new CorsOriginError({projectId:(_a=client.config())==null?void 0:_a.projectId});}if(err.isNetworkError&&!err.message&&err.request&&err.request.url){const host=new URL(err.request.url).host;throw new Error("Unknown network error attempting to reach ".concat(host));}throw err;}};function _createAuthStore(_ref12){let{projectId,dataset,loginMethod="dual"}=_ref12,providerOptions=_objectWithoutProperties(_ref12,_excluded2);const{broadcast,messages}=createBroadcastChannel("dual_mode_auth_".concat(projectId));const token$=messages.pipe(startWith(loginMethod==="dual"?getToken(projectId):null));const state$=token$.pipe(map(token=>createClient(_objectSpread(_objectSpread({projectId,dataset,apiVersion:"2021-06-07",useCdn:false},token&&{token}),{},{withCredentials:true,requestTagPrefix:"sanity.studio",ignoreBrowserTokenWarning:true,allowReconfigure:false}))),switchMap(client=>defer(async()=>{const currentUser=await getCurrentUser(client,broadcast);return{currentUser,client,authenticated:!!currentUser};})),shareReplay(1));async function handleCallbackUrl(){if(sessionId&&loginMethod==="dual"){const requestClient=createClient({projectId,dataset,useCdn:true,withCredentials:true,apiVersion:"2021-06-07",requestTagPrefix:"sanity.studio"});const currentUser=await getCurrentUser(requestClient,broadcast);if(currentUser){broadcast(null);}else{const{token}=await requestClient.request({method:"GET",uri:"/auth/fetch",query:{sid:sessionId},tag:"auth.fetch-token"});saveToken({token,projectId});broadcast(token);}}else{broadcast(loginMethod==="dual"?getToken(projectId):null);}}async function logout(){const requestClient=createClient({projectId,dataset,useCdn:true,withCredentials:true,apiVersion:"2021-06-07",requestTagPrefix:"sanity.studio"});clearToken(projectId);await requestClient.auth.logout();broadcast(null);}const LoginComponent=createLoginComponent(_objectSpread(_objectSpread({},providerOptions),{},{getClient:()=>state$.pipe(map(state=>state.client)),loginMethod}));return{handleCallbackUrl,token:token$,state:state$,LoginComponent,logout};}function hash(value){if(typeof value!=="object"||value===null)return"".concat(value);return JSON.stringify(Object.fromEntries(Object.entries(value).sort((_ref13,_ref14)=>{let[a]=_ref13;let[b]=_ref14;return a.localeCompare(b,"en");}).map(_ref15=>{let[k,v]=_ref15;return[k,hash(v)];})));}const createAuthStore=memoize$1(_createAuthStore,hash);function catchWithCount(selector){return input$=>{let errors=[];const errorOp=catchError((err,caught)=>{errors.push(err);return selector(err,errors.length,caught).pipe(errorOp);});return input$.pipe(tap(()=>{errors=[];}),errorOp);};}const onOnline$=typeof window==="undefined"?of({}):fromEvent(window,"online");const onOffline$=typeof window==="undefined"?of({}):fromEvent(window,"offline");const expBackoff=retryCount=>Math.pow(2,retryCount)*100;const CONNECTING={type:"connecting"};const[onRetry$,onRetry]=observableCallback();const createErrorStatus=_ref16=>{let{error,isOffline,attemptNo,retryAt}=_ref16;return{type:"error",error,attemptNo,isOffline,retryAt};};function createConnectionStatusStore(_ref17){let{bifur}=_ref17;const connectionStatus$=merge(bifur.heartbeats,onOffline$.pipe(mergeMapTo(throwError(new Error("The browser went offline"))))).pipe(map(ts=>({type:"connected",lastHeartbeat:ts})),catchWithCount((error,successiveErrorsCount,caught)=>{const timeUntilRetry=Math.min(1e3*240,expBackoff(successiveErrorsCount));const retryAt=new Date(new Date().getTime()+timeUntilRetry);const expiry$=timer(retryAt);const isOffline=!navigator.onLine;const initialErrorStatus=createErrorStatus({error,retryAt,isOffline,attemptNo:successiveErrorsCount});const triggerRetry$=NEVER.pipe(takeUntil(isOffline?onOnline$:merge(expiry$,onOnline$,onRetry$)));return concat(of(initialErrorStatus),triggerRetry$.pipe(take(1)),caught);}),startWith(CONNECTING));return{connectionStatus$};}const TOKEN_DOCUMENT_ID_BASE="secrets.sanity.sharedContent";function isNonNullable$3(value){return value!==null;}function __tmp_wrap_crossProjectToken(_ref18){let{client:_client}=_ref18;const versionedClient=_client.withConfig({apiVersion:"1"});function fetchTokenDocument(client,id){return client.observable.fetch("*[_id == $id]{_id, _type, _updatedAt, token}[0]",{id});}return{getTokenDocumentId,getProjectIdFromTokenDocumentId,fetchCrossProjectToken,fetchAllCrossProjectTokens};function getTokenDocumentId(_ref19){let{tokenId,projectId}=_ref19;return[TOKEN_DOCUMENT_ID_BASE,projectId,tokenId].filter(Boolean).join(".");}function getProjectIdFromTokenDocumentId(id){if(!id.startsWith(TOKEN_DOCUMENT_ID_BASE)){return null;}const[,,,projectId]=id.split(".");return projectId;}function fetchCrossProjectToken(client,_ref20){let{projectId,tokenId}=_ref20;if(client.config().projectId===projectId){return of(void 0);}return fetchTokenDocument(client,getTokenDocumentId({projectId,tokenId})).pipe(map(tokenDoc=>tokenDoc.token));}function fetchAllCrossProjectTokens(){return versionedClient.observable.fetch("*[_id in path(\"".concat(TOKEN_DOCUMENT_ID_BASE,".**\")]{_id, _type, _updatedAt, token}")).pipe(mergeMap(tokenDocs=>from(tokenDocs)),map(doc=>{const projectId=getProjectIdFromTokenDocumentId(doc._id);return projectId?{projectId,token:doc.token}:null;}),filter(isNonNullable$3),toArray$1());}}const MENU_BUTTON_POPOVER_PROPS={portal:true,constrainSize:true};function CollapseOverflowMenu(props){const{disableRestoreFocusOnClose,menuButton,menuButtonProps,menuOptionsArray,onMenuClose}=props;return/* @__PURE__ */jsx(MenuButton,_objectSpread(_objectSpread({__unstable_disableRestoreFocusOnClose:disableRestoreFocusOnClose,id:"menu-button",onClose:onMenuClose,popover:MENU_BUTTON_POPOVER_PROPS},menuButtonProps),{},{button:menuButton,menu:/* @__PURE__ */jsx(Menu,{children:menuOptionsArray.map((c,index)=>{const _c$props=c.props,{collapsedProps={},expandedProps={},tooltipProps={},tooltipText,dividerBefore,fontSize,padding,text,icon,selected}=_c$props,rest=_objectWithoutProperties(_c$props,_excluded3);return/* @__PURE__ */jsxs(React.Fragment,{children:[dividerBefore&&index!==0&&/* @__PURE__ */jsx(MenuDivider,{}),/* @__PURE__ */jsx(MenuItem,_objectSpread({text,icon,pressed:selected},rest))]},c.key);})})}));}function ObserveElement(props){const{callback,children,options}=props,rest=_objectWithoutProperties(props,_excluded4);const[el,setEl]=useState(null);useEffect(()=>{if(!el)return void 0;const io=new IntersectionObserver(callback,options);io.observe(el);return()=>{io.unobserve(el);io.disconnect();};},[el,callback,options]);return/* @__PURE__ */jsx(Flex,_objectSpread(_objectSpread({ref:setEl},rest),{},{children}));}const DividerDiv=styled.div(_templateObject2||(_templateObject2=_taggedTemplateLiteral(["\n  border-right: 1px solid var(--card-border-color);\n  height: auto;\n\n  &[data-hidden] {\n    opacity: 0;\n  }\n"])));function CollapseMenuDivider(props){const{hidden}=props,rest=_objectWithoutProperties(props,_excluded5);return/* @__PURE__ */jsx(DividerDiv,_objectSpread({"data-ui":"CollapseMenuDivider","data-hidden":hidden?"":void 0},rest));}const FOCUS_RING_PADDING=3;const OPTION_STYLE=css(_templateObject3||(_templateObject3=_taggedTemplateLiteral(["\n  list-style: none;\n  display: flex;\n  white-space: nowrap;\n\n  &[data-hidden='true'] {\n    opacity: 0;\n    visibility: hidden;\n  }\n"])));const OuterFlex=styled(Flex)(_templateObject4||(_templateObject4=_taggedTemplateLiteral(["\n  padding: ","px;\n  margin: -","px;\n  box-sizing: border-box;\n"])),FOCUS_RING_PADDING,FOCUS_RING_PADDING);const RootFlex$3=styled(Flex)(_templateObject5||(_templateObject5=_taggedTemplateLiteral(["\n  border-radius: inherit;\n  position: relative;\n"])));const RowFlex=styled(Flex)(_templateObject6||(_templateObject6=_taggedTemplateLiteral(["\n  width: max-content;\n\n  &[data-hidden='true'] {\n    height: 0px;\n    visibility: hidden;\n  }\n"])));const OptionObserveElement=styled(ObserveElement)(_templateObject7||(_templateObject7=_taggedTemplateLiteral(["\n  ","\n"])),OPTION_STYLE);const OptionHiddenFlex=styled(Flex)(_templateObject8||(_templateObject8=_taggedTemplateLiteral(["\n  ","\n"])),OPTION_STYLE);function _isReactElement(node){return Boolean(node);}const CollapseMenu=forwardRef(function CollapseMenu2(props,ref){const{children:childrenProp,collapsed,collapseText=true,disableRestoreFocusOnClose,gap,menuButtonProps,onMenuClose}=props;const[rootEl,setRootEl]=useState(null);const[hiddenRowEl,setHiddenRowEl]=useState(null);const rootRect=useElementRect(rootEl);const[menuOptions,setMenuOptions]=useState([]);const hasOverflow=useMemo(()=>{if(rootRect&&rootEl&&hiddenRowEl){return rootRect.width<hiddenRowEl.scrollWidth;}return false;},[hiddenRowEl,rootEl,rootRect]);const menuButton=useMemo(()=>(menuButtonProps==null?void 0:menuButtonProps.button)||/* @__PURE__ */jsx(Button,{icon:EllipsisVerticalIcon,mode:"bleed"}),[menuButtonProps]);const intersectionOptions=useMemo(()=>({root:rootEl,threshold:1,rootMargin:"2px"}),[rootEl]);const children=useMemo(()=>React.Children.toArray(childrenProp).filter(_isReactElement),[childrenProp]);const menuOptionsArray=useMemo(()=>children.filter(_ref21=>{let{key}=_ref21;return menuOptions.find(o=>o.key===key);}),[children,menuOptions]);const menuIsVisible=useMemo(()=>collapsed||menuOptionsArray.length>0,[collapsed,menuOptionsArray.length]);const isInMenu=useCallback(childKey=>menuOptionsArray.some(o=>o.key===childKey),[menuOptionsArray]);const handleIntersection=useCallback((e,child)=>{const exists=isInMenu(child.key);if(!e.isIntersecting&&!exists){setMenuOptions(prev=>[child,...prev]);}if(e.isIntersecting&&exists){const updatedOptions=menuOptionsArray.filter(_ref22=>{let{key}=_ref22;return key!==child.key;});setMenuOptions(updatedOptions);}},[isInMenu,menuOptionsArray]);const items=useMemo(()=>children.map(child=>{const{collapsedProps,expandedProps}=child.props;const modeProps=hasOverflow?collapsedProps:expandedProps;const text=hasOverflow&&collapseText?void 0:child.props.text;return cloneElement(child,_objectSpread(_objectSpread({},modeProps),{},{text}));}),[children,collapseText,hasOverflow]);if(collapsed){return/* @__PURE__ */jsx(CollapseOverflowMenu,{disableRestoreFocusOnClose,menuButton,menuButtonProps,menuOptionsArray:children,onMenuClose});}return/* @__PURE__ */jsxs(OuterFlex,{align:"center","data-ui":"CollapseMenu",overflow:"hidden",sizing:"border",ref,children:[/* @__PURE__ */jsxs(RootFlex$3,{direction:"column",flex:1,justify:"center",ref:setRootEl,children:[/* @__PURE__ */jsx(RowFlex,{gap,children:items.map((child,index)=>{const{dividerBefore,tooltipText="",tooltipProps={}}=child.props;const hidden=isInMenu(child.key);return/* @__PURE__ */jsxs(React.Fragment,{children:[dividerBefore&&index!==0&&/* @__PURE__ */jsx(CollapseMenuDivider,{hidden}),/* @__PURE__ */jsx(OptionObserveElement,{options:intersectionOptions,callback:e=>handleIntersection(e[0],child),"aria-hidden":hidden,"data-hidden":hidden,children:/* @__PURE__ */jsx(Tooltip,_objectSpread(_objectSpread({portal:true,disabled:!tooltipText,content:/* @__PURE__ */jsx(Box,{padding:2,sizing:"border",children:/* @__PURE__ */jsx(Text$1,{size:1,children:tooltipText})})},tooltipProps),{},{children:/* @__PURE__ */jsx(Flex,{children:cloneElement(child,{disabled:child.props.disabled||hidden,"aria-hidden":hidden})})}))})]},child.key);})}),/* @__PURE__ */jsx(RowFlex,{"data-hidden":true,"aria-hidden":"true",gap,ref:setHiddenRowEl,children:children.map((child,index)=>{const{dividerBefore}=child.props;return/* @__PURE__ */jsxs(React.Fragment,{children:[dividerBefore&&index!==0&&/* @__PURE__ */jsx(CollapseMenuDivider,{}),/* @__PURE__ */jsx(OptionHiddenFlex,{children:cloneElement(child,{disabled:true,"aria-hidden":true})},child.key)]},child.key);})})]}),menuIsVisible&&/* @__PURE__ */jsx(Flex,{marginLeft:gap,children:/* @__PURE__ */jsx(CollapseOverflowMenu,{disableRestoreFocusOnClose,menuButton,menuButtonProps,menuOptionsArray,onMenuClose})})]});});const CollapseMenuButton=forwardRef(function CollapseMenuButton2(props,ref){const{collapsedProps={},expandedProps={},tooltipProps={},tooltipText,dividerBefore}=props,rest=_objectWithoutProperties(props,_excluded6);return/* @__PURE__ */jsx(Button,_objectSpread(_objectSpread({"data-ui":"CollapseMenuButton"},rest),{},{ref}));});const MUTATION_ATTRIBUTE_FILTER=["aria-hidden","disabled","href"];const FOCUSABLE='a[href], button, input, textarea, select, details, [tabindex]:not([tabindex="-1"])';function getFocusableElements(element){return[...element.querySelectorAll(FOCUSABLE)].filter(el=>!el.hasAttribute("disabled")&&el.getAttribute("aria-hidden")!=="true");}function useRovingFocus(props){const{direction="horizontal",initialFocus,loop=true,navigation=["arrows"],pause=false,rootElement}=props;const[focusedIndex,setFocusedIndex]=useState(-1);const[focusableElements,setFocusableElements]=useState([]);const focusableLen=focusableElements.length;const lastFocusableIndex=focusableLen-1;const nextKey=direction==="horizontal"?"ArrowRight":"ArrowDown";const prevKey=direction==="horizontal"?"ArrowLeft":"ArrowUp";const handleSetElements=useCallback(()=>{if(rootElement){const els=getFocusableElements(rootElement);setFocusableElements(els);}},[rootElement]);const handleFocus=useCallback(index=>{setFocusedIndex(index);},[]);const handleKeyDown=useCallback(event=>{if(pause){return;}const focusPrev=()=>{event.preventDefault();setFocusedIndex(prevIndex=>{const next=(prevIndex+lastFocusableIndex)%focusableLen;if(!loop&&next===lastFocusableIndex){return prevIndex;}return next;});};const focusNext=()=>{event.preventDefault();setFocusedIndex(prevIndex=>{const next=(prevIndex+1)%focusableLen;if(!loop&&next===0){return prevIndex;}return next;});};if(event.key==="Tab"&&navigation.includes("tab")){if(event.shiftKey){focusPrev();}else{focusNext();}}if(navigation.includes("arrows")){if(event.key===prevKey){focusPrev();}if(event.key===nextKey){focusNext();}}},[pause,prevKey,navigation,nextKey,lastFocusableIndex,focusableLen,loop]);useEffect(()=>{handleSetElements();},[handleSetElements,initialFocus,direction]);useEffect(()=>{const mo=new MutationObserver(handleSetElements);if(rootElement){mo.observe(rootElement,{childList:true,subtree:true,attributeFilter:MUTATION_ATTRIBUTE_FILTER});}return()=>{mo.disconnect();};},[focusableElements,handleSetElements,rootElement]);useEffect(()=>{var _a;focusableElements.forEach((el,index)=>{if(index===focusedIndex){el.setAttribute("tabIndex","0");el.setAttribute("aria-selected","true");el.focus();el.onfocus=()=>handleFocus(index);el.onblur=()=>handleFocus(-1);}else{el.setAttribute("tabIndex","-1");el.setAttribute("aria-selected","false");el.onfocus=()=>handleFocus(index);}});if(focusedIndex===-1&&focusableElements){const initialIndex=initialFocus==="last"?lastFocusableIndex:0;(_a=focusableElements[initialIndex])==null?void 0:_a.setAttribute("tabIndex","0");}},[focusableElements,focusedIndex,handleFocus,initialFocus,lastFocusableIndex]);useEffect(()=>{rootElement==null?void 0:rootElement.addEventListener("keydown",handleKeyDown);return()=>{rootElement==null?void 0:rootElement.removeEventListener("keydown",handleKeyDown);};},[handleKeyDown,rootElement]);return void 0;}const ColorSchemeContext=createContext(null);function ColorSchemeProvider(_ref23){let{children,onSchemeChange,scheme:schemeProp}=_ref23;const prefersDark=usePrefersDark();const[scheme,setScheme]=useState(schemeProp||"light");useEffect(()=>{const nextScheme=prefersDark?"dark":"light";setScheme(nextScheme);onSchemeChange==null?void 0:onSchemeChange(nextScheme);},[onSchemeChange,prefersDark]);const colorScheme=useMemo(()=>({scheme,setScheme}),[scheme]);return/* @__PURE__ */jsx(ColorSchemeContext.Provider,{value:colorScheme,children:/* @__PURE__ */jsx(ThemeProvider,{scheme,theme:studioTheme,children})});}function useColorScheme(){const value=useContext(ColorSchemeContext);if(!value)throw new Error("Could not find `colorScheme` context");return value;}const RouterContext=React.createContext(null);function useRouter(){const router=useContext(RouterContext);if(!router){throw new Error("Router: missing context value");}return router;}function isLeftClickEvent(event){return event.button===0;}function isModifiedEvent(event){return!!(event.metaKey||event.altKey||event.ctrlKey||event.shiftKey);}function useLink(props){const{onClick:onClickProp,href,target,replace=false}=props;const{navigateUrl}=useRouter();const onClick=useCallback(event=>{if(event.isDefaultPrevented()){return;}if(!href)return;if(onClickProp){onClickProp(event);}if(isModifiedEvent(event)||!isLeftClickEvent(event)){return;}if(target){return;}event.preventDefault();navigateUrl({path:href,replace});},[href,navigateUrl,onClickProp,replace,target]);return{onClick};}function useIntentLink(props){const{intent,onClick:onClickProp,params,replace,target}=props;const{resolveIntentLink}=useRouter();const href=resolveIntentLink(intent,params);const{onClick}=useLink({href,onClick:onClickProp,replace,target});return{onClick,href};}const IntentLink=forwardRef(function IntentLink2(props,ref){const{intent,params,target}=props,restProps=_objectWithoutProperties(props,_excluded7);const{onClick,href}=useIntentLink({intent,params,target,onClick:props.onClick});return/* @__PURE__ */jsx("a",_objectSpread(_objectSpread({},restProps),{},{href,onClick,ref,target}));});const Link=forwardRef(function Link2(props,ref){const{onClick:onClickProp,href,target,replace}=props,restProps=_objectWithoutProperties(props,_excluded8);const{onClick}=useLink({onClick:onClickProp,href,target,replace});return/* @__PURE__ */jsx("a",_objectSpread(_objectSpread({},restProps),{},{onClick,href,target,ref}));});const _hasOWn=Object.prototype.hasOwnProperty;const hasOwn$1=_hasOWn.call.bind(_hasOWn);function isEmpty$2(object){for(const key in object){if(hasOwn$1(object,key)){return false;}}return true;}function addScope(routerState,scope,scopedState){return scopedState&&_objectSpread(_objectSpread({},routerState),{},{[scope]:scopedState});}function RouteScope(props){const{children,scope}=props;const parent=useRouter();const{resolvePathFromState:parent_resolvePathFromState,navigate:parent_navigate}=parent;const resolvePathFromState=useCallback(nextState=>{const nextStateScoped=isEmpty$2(nextState)?{}:addScope(parent.state,scope,nextState);return parent_resolvePathFromState(nextStateScoped);},[parent_resolvePathFromState,parent.state,scope]);const navigate=useCallback((nextState,options)=>{const nextScopedState=addScope(parent.state,scope,nextState);parent_navigate(nextScopedState,options);},[parent_navigate,parent.state,scope]);const scopedRouter=useMemo(()=>_objectSpread(_objectSpread({},parent),{},{navigate,resolvePathFromState,state:parent.state[scope]}),[navigate,parent,resolvePathFromState,scope]);return/* @__PURE__ */jsx(RouterContext.Provider,{value:scopedRouter,children});}function RouterProvider(props){const{onNavigate,router:routerProp,state:stateProp}=props;const[state,setState]=useState(stateProp);const stateRef=useRef(state);const navigateUrl=useCallback(opts=>{onNavigate(opts);},[onNavigate]);const resolveIntentLink=useCallback((intentName,parameters)=>{const[params,payload]=Array.isArray(parameters)?parameters:[parameters];return routerProp.encode({intent:intentName,params,payload});},[routerProp]);const resolvePathFromState=useCallback(nextState=>{return routerProp.encode(nextState);},[routerProp]);const navigate=useCallback(function(nextState){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};navigateUrl({path:resolvePathFromState(nextState),replace:options.replace});},[navigateUrl,resolvePathFromState]);const navigateIntent=useCallback(function(intentName,params){let options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};navigateUrl({path:resolveIntentLink(intentName,params),replace:options.replace});},[navigateUrl,resolveIntentLink]);const router=useMemo(()=>({navigate,navigateIntent,navigateUrl,resolveIntentLink,resolvePathFromState,state}),[navigate,navigateIntent,navigateUrl,resolveIntentLink,resolvePathFromState,state]);useEffect(()=>{const prevState=stateRef.current;const nextState=stateProp;if(!isEqual$1(nextState,prevState)){setState(nextState);}},[stateProp]);return/* @__PURE__ */jsx(RouterContext.Provider,{value:router,children:props.children});}const EMPTY_STATE$4={};function useStateLink(props){const{onClick:onClickProp,replace,state,target,toIndex=false}=props;if(state&&toIndex){throw new Error("Passing both `state` and `toIndex={true}` as props to StateLink is invalid");}if(!state&&!toIndex){console.error(new Error("No state passed to StateLink. If you want to link to an empty state, its better to use the the `toIndex` property"));}const{resolvePathFromState}=useRouter();const href=useMemo(()=>resolvePathFromState(toIndex?EMPTY_STATE$4:state||EMPTY_STATE$4),[resolvePathFromState,state,toIndex]);const{onClick}=useLink({href,onClick:onClickProp,replace,target});return{onClick,href};}const StateLink=forwardRef(function StateLink2(props,ref){const{onClick:onClickProp,replace,state,target,toIndex=false}=props,restProps=_objectWithoutProperties(props,_excluded9);const{onClick,href}=useStateLink({onClick:onClickProp,replace,state,target,toIndex});return/* @__PURE__ */jsx("a",_objectSpread(_objectSpread({},restProps),{},{href,onClick,ref}));});const VALID_PARAM_SEGMENT=/^[a-zA-Z0-9_-]+$/;function createSegment(segment){if(!segment){return null;}if(segment.startsWith(":")){const paramName=segment.substring(1);if(!VALID_PARAM_SEGMENT.test(paramName)){const addendum=segment.includes("*")?" Splats are not supported. Consider using child routes instead":"";console.error(new Error("Warning: Param segments \"".concat(segment,"\" includes invalid characters.").concat(addendum)));}return{type:"param",name:paramName};}return{type:"dir",name:segment};}function _parseRoute(route){const[pathname]=route.split("?");const segments=pathname.split("/").map(createSegment).filter(Boolean);return{raw:route,segments};}const debug$2=Debug("state-router");function arrayify(val){if(Array.isArray(val)){return val;}return val?[val]:[];}function matchPath(node,path){const parts=path.split("/").filter(Boolean);const segmentsLength=node.route.segments.length;if(parts.length<segmentsLength){return null;}const state={};const isMatching=node.route.segments.every((segment,i)=>{if(segment.type==="dir"){return segment.name===parts[i];}const transform=node.transform&&node.transform[segment.name];state[segment.name]=transform?transform.toState(parts[i]):parts[i];return true;});if(!isMatching){return null;}const rest=parts.slice(segmentsLength);let childState=null;const children=typeof node.children==="function"?arrayify(node.children(state)):node.children;children.some(childNode=>{if(childNode){childState=matchPath(childNode,rest.join("/"));return childState;}return void 0;});if(rest.length>0&&!childState){return null;}const mergedState=_objectSpread(_objectSpread({},state),childState||{});return node.scope?{[node.scope]:mergedState}:mergedState;}function _resolveStateFromPath(node,path){debug$2("resolving state from path %s",path);const pathMatch=matchPath(node,path.split("?")[0]);debug$2("resolved: %o",pathMatch||null);return pathMatch||null;}function createMatchResult(nodes,missing,remaining){return{nodes,missing,remaining};}function _findMatchingRoutes(node,_state){if(!_state){return createMatchResult([],[],[]);}const state=node.scope?_state[node.scope]:_state;const requiredParams=node.route.segments.filter(seg=>seg.type==="param").map(seg=>seg.name);const stateKeys=isRecord$2(state)?Object.keys(state):[];const consumedParams=intersection(stateKeys,requiredParams);const missingParams=difference(requiredParams,consumedParams);const remainingParams=difference(stateKeys,consumedParams);if(missingParams.length>0){return createMatchResult([],missingParams,[]);}if(remainingParams.length===0){return createMatchResult([node],[],[]);}const children=arrayify((typeof node.children==="function"?node.children(isRecord$2(state)?state:{}):node.children)||[]);if(remainingParams.length>0&&children.length===0){return createMatchResult([],remainingParams,[]);}const remainingState=pick(state,remainingParams);let matchingChild={nodes:[],remaining:[],missing:[]};arrayify(children).some(childNode=>{matchingChild=_findMatchingRoutes(childNode,remainingState);return matchingChild.nodes.length>0;});if(matchingChild.nodes.length===0){return createMatchResult([],missingParams,remainingParams);}return createMatchResult([node,...matchingChild.nodes],matchingChild.missing,matchingChild.remaining);}function _resolvePathFromState(node,state){debug$2("Resolving path from state %o",state);const match=_findMatchingRoutes(node,state);if(match.remaining.length>0){const remaining=match.remaining;throw new Error("Unable to find matching route for state. Could not map the following state key".concat(remaining.length==1?"":"s"," to a valid url: ").concat(remaining.join(", ")));}if(match.nodes.length===0){throw new Error("Unable to resolve path from given state: ".concat(JSON.stringify(state)));}let scopedState=state;const relative=flatten$1(match.nodes.map(matchNode=>{if(matchNode.scope&&matchNode.scope in scopedState){scopedState=scopedState[matchNode.scope];}return matchNode.route.segments.map(segment=>{if(segment.type==="dir"){return segment.name;}const transform=matchNode.transform&&matchNode.transform[segment.name];return transform?transform.toPath(scopedState[segment.name]):scopedState[segment.name];});})).join("/");debug$2("Resolved to /%s",relative);return"/".concat(relative);}function decodeJsonParams(){let pathsegment=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";const segment=decodeURIComponent(pathsegment);if(!segment){return{};}try{return JSON.parse(atob(segment));}catch(err){}try{return JSON.parse(segment);}catch(err){console.warn("Failed to parse JSON parameters");}return{};}function encodeJsonParams(params){return params?btoa(JSON.stringify(params)):"";}function decodeParams(pathSegment){return pathSegment.split(";").reduce((params,pair)=>{const[key,value]=pair.split("=");params[decodeURIComponent(key)]=decodeURIComponent(value);return params;},{});}function encodeParams(params){return Object.entries(params).filter(_ref24=>{let[,value]=_ref24;return value!==void 0&&value!==null;}).map(_ref25=>{let[key,value]=_ref25;return"".concat(encodeURIComponent(key),"=").concat(encodeURIComponent(value));}).join(";");}const route={create:createRoute,scope:routeScope,intents:routeIntents};function normalizeChildren(children){if(Array.isArray(children)||typeof children==="function"){return children;}return children?[children]:[];}function isRoute(val){return val&&"_isRoute"in val;}function normalizeArgs(path,childrenOrOpts,children){if(typeof path==="object"){return path;}if(Array.isArray(childrenOrOpts)||typeof childrenOrOpts==="function"||isRoute(childrenOrOpts)){return{path,children:normalizeChildren(childrenOrOpts)};}if(children){return _objectSpread(_objectSpread({path},childrenOrOpts),{},{children:normalizeChildren(children)});}return _objectSpread({path},childrenOrOpts);}function createRoute(routeOrOpts,childrenOrOpts,children){return createNode(normalizeArgs(routeOrOpts,childrenOrOpts,children));}function routeScope(scopeName){for(var _len2=arguments.length,rest=new Array(_len2>1?_len2-1:0),_key3=1;_key3<_len2;_key3++){rest[_key3-1]=arguments[_key3];}const options=normalizeArgs(...rest);return createNode(_objectSpread(_objectSpread({},options),{},{scope:scopeName}));}function normalize(){for(var _len3=arguments.length,paths=new Array(_len3),_key4=0;_key4<_len3;_key4++){paths[_key4]=arguments[_key4];}return paths.reduce((acc,path)=>acc.concat(path.split("/")),[]).filter(Boolean);}function routeIntents(base){const basePath=normalize(base).join("/");return route.create("".concat(basePath,"/:intent"),[route.create(":params",{transform:{params:{toState:decodeParams,toPath:encodeParams}}},[route.create(":payload",{transform:{payload:{toState:decodeJsonParams,toPath:encodeJsonParams}}})])]);}const EMPTY_STATE$3={};function isRoot(pathname){return pathname.split("/").every(segment=>!segment);}function createNode(options){const{path,scope,transform,children}=options;if(!path){throw new TypeError("Missing path");}const parsedRoute=_parseRoute(path);return{_isRoute:true,scope,route:parsedRoute,children:children||[],transform,encode(state){return _resolvePathFromState(this,state);},decode(_path){return _resolveStateFromPath(this,_path);},isRoot,isNotFound(pathname){return this.decode(pathname)===null;},getBasePath(){return this.encode(EMPTY_STATE$3);},getRedirectBase(pathname){if(isRoot(pathname)){const basePath=this.getBasePath();if(pathname!==basePath){return basePath;}}return null;}};}function useRouterState$1(){let selector=arguments.length>0&&arguments[0]!==undefined?arguments[0]:identity;const{state}=useRouter();const[selectedState,setState]=useState(()=>selector(state));useEffect(()=>setState(selector(state)),[selector,state]);return selectedState;}function withRouter(Component){function WithRouter2(props){const router=useRouter();return/* @__PURE__ */jsx(Component,_objectSpread(_objectSpread({},props),{},{router}));}WithRouter2.displayName="withRouter(".concat(Component.displayName||Component.name,")");return WithRouter2;}const WithRouter=withRouter(props=>props.children(props.router));const ToolLink=forwardRef(function ToolLink2(props,ref){const{name}=props,rest=_objectWithoutProperties(props,_excluded10);const routerState=useRouterState$1();const state=useMemo(()=>_objectSpread(_objectSpread({},routerState),{},{tool:name,[name]:void 0}),[routerState,name]);return/* @__PURE__ */jsx(StateLink,_objectSpread(_objectSpread({state},rest),{},{ref}));});function ToolCollapseMenu(props){const{activeToolName,tools}=props;const{scheme}=useColorScheme();const[collapseMenuEl,setCollapseMenuEl]=useState(null);useRovingFocus({rootElement:collapseMenuEl,navigation:["arrows"]});const menuButtonProps=useMemo(()=>({popover:{constrainSize:true,portal:true,scheme}}),[scheme]);const children=useMemo(()=>tools.map((tool,index)=>{const title=(tool==null?void 0:tool.title)||startCase(tool.name)||void 0;const Link=forwardRef(function Link2(linkProps,ref){return/* @__PURE__ */jsx(ToolLink,_objectSpread(_objectSpread({},linkProps),{},{ref,name:tool.name}));});return/* @__PURE__ */jsx(CollapseMenuButton,{as:Link,collapsedProps:{tooltipText:tool.title},icon:tool.icon||UnknownIcon,mode:"bleed",selected:activeToolName===tool.name,text:title,tooltipProps:{scheme}},"".concat(tool.name,"-").concat(index));}),[activeToolName,scheme,tools]);return/* @__PURE__ */jsx(CollapseMenu,{gap:1,menuButtonProps,ref:setCollapseMenuEl,children});}function ToolVerticalMenu(props){const{activeToolName,isVisible,tools}=props;return useMemo(()=>/* @__PURE__ */jsx(Stack,{as:"ul",space:[1,2],children:tools.map(tool=>{const title=(tool==null?void 0:tool.title)||startCase(tool.name)||void 0;const Link=forwardRef(function Link2(linkProps,ref){return/* @__PURE__ */jsx(ToolLink,_objectSpread(_objectSpread({},linkProps),{},{ref,name:tool.name}));});return/* @__PURE__ */jsx(Stack,{as:"li",children:/* @__PURE__ */jsx(Button,{as:Link,icon:tool.icon||PlugIcon,justify:"flex-start",mode:"bleed",selected:activeToolName===tool.name,tabIndex:isVisible?0:-1,text:title})},tool.name);})}),[activeToolName,isVisible,tools]);}function ToolMenu(props){const{context,isDrawerOpen}=props,restProps=_objectWithoutProperties(props,_excluded11);if(context==="drawer"){return/* @__PURE__ */jsx(ToolVerticalMenu,_objectSpread({isVisible:isDrawerOpen},restProps));}return/* @__PURE__ */jsx(ToolCollapseMenu,_objectSpread({},restProps));}const UserColorManagerContext=createContext(null);function useUserColorManager(){const userColorManager=useContext(UserColorManagerContext);if(!userColorManager){throw new Error("UserColorManager: missing context value");}return userColorManager;}function useUserColor(userId){const manager=useUserColorManager();return useMemoObservable(userId?manager.listen(userId):empty(),[userId],manager.get(null));}const defaultCurrentUserHue="purple";const USER_COLOR_EXCLUDE_HUES=["green","red","gray"];const defaultHues=COLOR_HUES.filter(hue=>!USER_COLOR_EXCLUDE_HUES.includes(hue));const defaultColors=defaultHues.reduce((colors,hue)=>{colors[hue]={name:hue,background:hues[hue][100].hex,border:hues[hue][300].hex,text:hues[hue][700].hex,tints:hues[hue]};return colors;},{});const defaultAnonymousColor={name:"gray",background:hues.gray[100].hex,border:hues.gray[300].hex,text:hues.gray[700].hex,tints:hues.gray};function createUserColorManager(options){const userColors=options&&options.colors||defaultColors;const anonymousColor=(options==null?void 0:options.anonymousColor)||defaultAnonymousColor;const currentUserColor=options&&options.currentUserColor||defaultCurrentUserHue;if(!userColors.hasOwnProperty(currentUserColor)){throw new Error("'colors' must contain 'currentUserColor' (".concat(currentUserColor,")"));}const userColorKeys=Object.keys(userColors);const subscriptions=/* @__PURE__ */new Map();const previouslyAssigned=/* @__PURE__ */new Map();const assignedCounts=userColorKeys.reduce((counts,color)=>{counts[color]=0;return counts;},{});const assigned=/* @__PURE__ */new Map();let currentUserId;if(options==null?void 0:options.userStore){options.userStore.me.subscribe(user=>setCurrentUser(user?user.id:null));}return{get,listen};function get(userId){if(!userId){return anonymousColor;}return userColors[getUserHue(userId)];}function getUserHue(userId){if(userId===currentUserId){return currentUserColor;}const assignedHue=assigned.get(userId);if(assignedHue){return assignedHue;}const prevHue=previouslyAssigned.get(userId);if(prevHue&&(assignedCounts[prevHue]===0||!hasUnusedColor())){return assignHue(userId,prevHue);}const preferredHue=getPreferredHue(userId);if(assignedCounts[preferredHue]===0){return assignHue(userId,preferredHue);}return assignHue(userId,getLeastUsedHue(prevHue));}function listen(userId){let subscription=subscriptions.get(userId);if(subscription){return subscription;}const hue=getUserHue(userId);subscription=getObservableColor(userId,hue);subscriptions.set(userId,subscription);return subscription;}function assignHue(userId,hue){assigned.set(userId,hue);previouslyAssigned.set(userId,hue);assignedCounts[hue]++;return hue;}function unassignHue(userId,hue){assigned.delete(userId);assignedCounts[hue]--;}function getUnusedColor(){return userColorKeys.find(colorHue=>assignedCounts[colorHue]===0);}function hasUnusedColor(){return Boolean(getUnusedColor());}function getLeastUsedHue(tieBreakerPreference){let leastUses=Infinity;let leastUsed=[];userColorKeys.forEach(colorHue=>{const uses=assignedCounts[colorHue];if(uses===leastUses){leastUsed.push(colorHue);}else if(uses<leastUses){leastUses=uses;leastUsed=[colorHue];}});return tieBreakerPreference&&leastUsed.includes(tieBreakerPreference)?tieBreakerPreference:leastUsed[0];}function getObservableColor(userId,hue){return new Observable(subscriber=>{const userColor=userColors[hue];subscriber.next(userColor);return()=>{subscriptions.delete(userId);unassignHue(userId,hue);};}).pipe(shareReplay({refCount:true}));}function setCurrentUser(userId){currentUserId=userId;assignedCounts[currentUserColor]+=userId?1:-1;}function getPreferredHue(userId){let hash=0;for(let i=0;i<userId.length;i++){hash=(hash<<5)-hash+userId.charCodeAt(i)|0;}return userColorKeys[Math.abs(hash)%userColorKeys.length];}}function UserColorManagerProvider(_ref26){let{children,manager:managerFromProps}=_ref26;const manager=useMemo(()=>{return managerFromProps||createUserColorManager();},[managerFromProps]);return/* @__PURE__ */jsx(UserColorManagerContext.Provider,{value:manager,children});}function createMultiKeyWeakMap(){const rootMap=/* @__PURE__ */new WeakMap();const idCache=/* @__PURE__ */new WeakMap();function randomId(){return Array.from({length:10}).map(()=>Math.floor(Math.random()*255).toString(16).padStart(2,"0")).join("");}function assignId(key){const cachedId=idCache.get(key);if(cachedId)return cachedId;const id=randomId();idCache.set(key,id);return id;}function arrangeKeys(keys){return Array.from(new Set(keys)).map(key=>[assignId(key),key]).sort((_ref27,_ref28)=>{let[a]=_ref27;let[b]=_ref28;return a.localeCompare(b,"en");}).map(_ref29=>{let[,key]=_ref29;return key;});}function getDeep(keys,map){if(!keys.length)return void 0;const[firstKey,...restOfKeys]=keys;const node=map.get(firstKey);if(!node)return void 0;if(!restOfKeys.length)return node.value;return getDeep(restOfKeys,node.next);}function setDeep(keys,map,value){if(!keys.length)return;const[firstKey,...restOfKeys]=keys;const node=map.get(firstKey)||{type:"multi-key-weak-map-node",value:void 0,next:/* @__PURE__ */new WeakMap()};map.set(firstKey,node);if(!restOfKeys.length){node.value=value;return;}setDeep(restOfKeys,node.next,value);}function get(keys){return getDeep(arrangeKeys(keys),rootMap);}function set(keys,value){setDeep(arrangeKeys(keys),rootMap,value);}return{get,set};}const ResourceCacheContext=createContext(null);function ResourceCacheProvider(_ref30){let{children}=_ref30;const resourceCache=useMemo(()=>{const namespaces=/* @__PURE__ */new Map();const nullReplacer={};return{get:_ref31=>{let{namespace,dependencies}=_ref31;const dependenciesWithoutNull=dependencies.map(dep=>dep===null?nullReplacer:dep);const namespaceMap=namespaces.get(namespace);return namespaceMap==null?void 0:namespaceMap.get(dependenciesWithoutNull);},set:_ref32=>{let{namespace,dependencies,value}=_ref32;const namespaceMap=namespaces.get(namespace)||createMultiKeyWeakMap();const dependenciesWithoutNull=dependencies.map(dep=>dep===null?nullReplacer:dep);namespaces.set(namespace,namespaceMap);namespaceMap.set(dependenciesWithoutNull,value);}};},[]);return/* @__PURE__ */jsx(ResourceCacheContext.Provider,{value:resourceCache,children});}function useResourceCache(){const cache=useContext(ResourceCacheContext);if(!cache)throw new Error("Could not find `cache` context");return cache;}const ActiveWorkspaceMatcherContext=createContext(null);const WorkspacesContext=createContext(null);function useWorkspaces(){const workspaces=useContext(WorkspacesContext);if(!workspaces)throw new Error("Could not find `workspaces` context");return workspaces;}function WorkspacesProvider(_ref33){let{config,children}=_ref33;const{workspaces}=useMemo(()=>prepareConfig(config),[config]);return/* @__PURE__ */jsx(WorkspacesContext.Provider,{value:workspaces,children});}function matchWorkspace(_ref34){let{pathname,workspaces}=_ref34;const normalized=workspaces.map(workspace=>({workspace,name:workspace.name,basePath:workspace.basePath||"/"}));const[firstWorkspace]=normalized;for(const{workspace,basePath}of normalized){if(new RegExp("^".concat(escapeRegExp$1(basePath),"(\\/|$)"),"i").test(pathname)||basePath==="/"){return{type:"match",workspace};}}const workspaceSegments=normalized.map(workspace=>workspace.basePath.substring(1).split("/"));if(pathname==="/"){return{type:"redirect",pathname:firstWorkspace.basePath};}const commonBasePath=workspaceSegments.reduce((commonSegments,segments)=>{for(let i=0;i<commonSegments.length;i++){const commonSegment=commonSegments[i];const segment=segments[i].toLowerCase();if(commonSegment!==segment){return commonSegments.slice(0,i);}}return commonSegments;});function createCommonBasePathRegex(_ref35){let[first,...rest]=_ref35;if(!first)return"";return"(\\/".concat(escapeRegExp$1(first)).concat(createCommonBasePathRegex(rest),"(\\/|$))?");}if(new RegExp("^".concat(createCommonBasePathRegex(commonBasePath),"$"),"i").test(pathname)){return{type:"redirect",pathname:firstWorkspace.basePath};}return{type:"not-found"};}const createHistory=()=>typeof document==="undefined"?createMemoryHistory():createBrowserHistory();function ActiveWorkspaceMatcher(_ref36){let{children,LoadingComponent,NotFoundComponent,unstable_history:historyProp}=_ref36;const[error,setError]=useState(null);if(error)throw error;const workspaces=useWorkspaces();const[activeWorkspace,setActiveWorkspace]=useState(null);const[notFound,setNotFound]=useState(false);const history=useMemo(()=>historyProp||createHistory(),[historyProp]);useEffect(()=>{const pathname$=new Observable(observer=>{const unlisten=history.listen(location=>observer.next(location.pathname));observer.next(history.location.pathname||"/");return unlisten;});const subscription=pathname$.pipe(map(pathname=>matchWorkspace({pathname,workspaces}))).subscribe({error:setError,next:result=>{if(result.type==="match"){setNotFound(false);setActiveWorkspace(result.workspace);}if(result.type==="redirect"){history.replace(result.pathname);}if(result.type==="not-found"){setNotFound(true);}}});return()=>subscription.unsubscribe();},[history,workspaces]);const setActiveWorkspaceName=useCallback(workspaceName=>{const foundWorkspace=workspaces.find(workspace=>workspace.name===workspaceName);if(foundWorkspace){history.push(foundWorkspace.basePath);}},[history,workspaces]);const defaultWorkspaceName=workspaces[0].name;const handleNavigateToDefaultWorkspace=useCallback(()=>{setActiveWorkspaceName(defaultWorkspaceName);},[setActiveWorkspaceName,defaultWorkspaceName]);const value=useMemo(()=>({__internal:{history},activeWorkspace,setActiveWorkspace:setActiveWorkspaceName}),[history,activeWorkspace,setActiveWorkspaceName]);if(notFound){return/* @__PURE__ */jsx(NotFoundComponent,{onNavigateToDefaultWorkspace:handleNavigateToDefaultWorkspace});}if(!value.activeWorkspace){return/* @__PURE__ */jsx(LoadingComponent,{});}return/* @__PURE__ */jsx(ActiveWorkspaceMatcherContext.Provider,{value,children});}function useActiveWorkspace(){const value=useContext(ActiveWorkspaceMatcherContext);if(!value)throw new Error("Could not find `ActiveWorkspaceMatcher` context");return value;}function StudioThemeProvider(_ref37){let{children}=_ref37;const theme=useActiveWorkspace().activeWorkspace.theme;const{scheme}=useColorScheme();return/* @__PURE__ */jsx(ThemeProvider,{scheme,theme,children:/* @__PURE__ */jsx(LayerProvider,{children})});}function getGlobalScope(){if(typeof globalThis!=="undefined")return globalThis;if(typeof window!=="undefined")return window;if(typeof self!=="undefined")return self;if(typeof global!=="undefined")return global;throw new Error("@sanity/ui: could not locate global scope");}const globalScope=getGlobalScope();function LoadingScreen(){return/* @__PURE__ */jsxs(Flex,{as:Card,justify:"center",align:"center",height:"fill",direction:"column",gap:4,children:[/* @__PURE__ */jsx(Text$1,{muted:true,children:"Loading\u2026"}),/* @__PURE__ */jsx(Spinner,{muted:true})]});}const TONES={error:"critical",warning:"caution"};const SegmentSpan=styled.code(_templateObject9||(_templateObject9=_taggedTemplateLiteral(["\n  && {\n    background: none;\n    color: inherit;\n  }\n"])));const ErrorMessageText=styled(Text$1)(_templateObject10||(_templateObject10=_taggedTemplateLiteral(["\n  white-space: pre-line;\n"])));function SchemaProblemGroups(props){const{problemGroups}=props;const items=useMemo(()=>{const ret=[];for(const problemGroup of problemGroups){for(const problem of problemGroup.problems){ret.push({group:problemGroup,problem});}}return ret;},[problemGroups]);return/* @__PURE__ */jsx(Stack,{as:"ul",space:4,children:items.map((_ref38,i)=>{let{group,problem}=_ref38;const isError=problem.severity==="error";const isWarning=problem.severity==="warning";const schemaType=getTypeInfo(group);return/* @__PURE__ */jsxs(Card,{border:true,padding:4,radius:2,tone:TONES[problem.severity],children:[/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{marginRight:3,children:/* @__PURE__ */jsxs(Text$1,{muted:true,size:1,children:[isError&&/* @__PURE__ */jsx(ErrorOutlineIcon,{}),isWarning&&/* @__PURE__ */jsx(WarningOutlineIcon,{})]})}),/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:schemaType?/* @__PURE__ */jsxs(Fragment,{children:[capitalize(schemaType.type),' type "',schemaType.name,'"']}):null})})]}),/* @__PURE__ */jsx(Box,{marginTop:4,children:/* @__PURE__ */jsx(Card,{border:true,overflow:"auto",padding:2,tone:"inherit",children:/* @__PURE__ */jsx(Breadcrumbs,{separator:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:"\u2192"}),children:group.path.map((segment,j)=>{if(segment.kind==="type"){return/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(SegmentSpan,{children:"".concat(_renderSegmentName(segment.name),":").concat(segment.type)})},j);}if(segment.kind==="property"){return/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(SegmentSpan,{children:segment.name})},j);}return null;})})})}),/* @__PURE__ */jsx(Box,{as:"ul",marginTop:4,children:/* @__PURE__ */jsx(Box,{as:"li",children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(ErrorMessageText,{muted:true,size:1,children:problem.message}),problem.helpId&&/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:/* @__PURE__ */jsx("a",{href:generateHelpUrl(problem.helpId),target:"_blank",rel:"noopener noreferrer",children:"View documentation \u2192"})})]})})})]},i);})});}function getTypeInfo(problem){const first=problem.path[0];if(first.kind==="type"){return{name:first.name,type:first.type};}return null;}function _renderSegmentName(str){if(str.startsWith("<unnamed_type_@_index")){const parts=str.slice(1,-1).split("_");return"[".concat(parts[4],"]");}return str;}function renderPath(path){return path.map(segment=>{if(segment.kind==="type"){return"".concat(segment.name||"<unnamed>","(").concat(segment.type,")");}if(segment.kind==="property"){return segment.name;}return null;}).filter(Boolean).join(" > ");}function reportWarnings(schema){const problemGroups=schema._validation;const groupsWithWarnings=problemGroups==null?void 0:problemGroups.filter(group=>group.problems.some(problem=>problem.severity==="warning"));if((groupsWithWarnings==null?void 0:groupsWithWarnings.length)===0){return;}console.groupCollapsed("\u26A0\uFE0F Schema has ".concat(groupsWithWarnings==null?void 0:groupsWithWarnings.length," warnings"));groupsWithWarnings==null?void 0:groupsWithWarnings.forEach(group=>{const path=renderPath(group.path);console.group("%cAt ".concat(path),"color: #FF7636");group.problems.forEach(problem=>{console.log(problem.message);});console.groupEnd();});console.groupEnd();}function SchemaErrorsScreen(_ref39){let{schema}=_ref39;var _a;const groupsWithErrors=((_a=schema._validation)==null?void 0:_a.filter(group=>group.problems.some(problem=>problem.severity==="error")))||[];useEffect(()=>reportWarnings(schema),[schema]);return/* @__PURE__ */jsx(Card,{height:"fill",overflow:"auto",paddingY:[4,5,6,7],paddingX:4,sizing:"border",children:/* @__PURE__ */jsx(Container$1,{width:1,children:/* @__PURE__ */jsxs(Stack,{space:5,children:[/* @__PURE__ */jsx(Heading,{as:"h1",children:"Schema errors"}),/* @__PURE__ */jsx(SchemaProblemGroups,{problemGroups:groupsWithErrors})]})})});}function NotFoundScreen(props){return/* @__PURE__ */jsx(Card,{height:"fill",sizing:"border",tone:"caution",display:"flex",children:/* @__PURE__ */jsx(Flex,{direction:"row",justify:"center",flex:1,align:"center",children:/* @__PURE__ */jsxs(Stack,{space:4,children:[/* @__PURE__ */jsx(Heading,{as:"h1",children:"Workspace not found"}),/* @__PURE__ */jsx(Inline,{children:/* @__PURE__ */jsx(Button,{text:"Go to default workspace",onClick:props.onNavigateToDefaultWorkspace,mode:"ghost"})})]})})});}const STATE_TITLES={"logged-in":"","logged-out":"Signed out","no-access":""};const MediaCard$1=styled(Card)(_templateObject11||(_templateObject11=_taggedTemplateLiteral(["\n  width: 35px;\n  height: 35px;\n\n  svg {\n    width: 100%;\n    height: 100%;\n  }\n"])));const createIcon=icon=>{if(isValidElementType(icon))return createElement(icon);if(isValidElement(icon))return icon;return void 0;};function WorkspacePreview(props){const{state,subtitle,selected,title,icon,iconRight}=props;const iconComponent=useMemo(()=>createIcon(icon),[icon]);const iconRightComponent=useMemo(()=>createIcon(iconRight),[iconRight]);return/* @__PURE__ */jsxs(Flex,{align:"center",flex:"none",gap:3,children:[/* @__PURE__ */jsx(MediaCard$1,{radius:2,tone:"transparent",children:iconComponent}),/* @__PURE__ */jsxs(Stack,{flex:1,space:2,children:[/* @__PURE__ */jsx(Text$1,{textOverflow:"ellipsis",weight:"medium",children:title}),subtitle&&/* @__PURE__ */jsx(Text$1,{muted:true,size:1,textOverflow:"ellipsis",children:subtitle})]}),state&&STATE_TITLES[state]&&/* @__PURE__ */jsx(Box,{paddingLeft:1,children:/* @__PURE__ */jsx(Text$1,{size:1,muted:true,textOverflow:"ellipsis",children:STATE_TITLES[state]})}),(selected||iconRightComponent)&&/* @__PURE__ */jsxs(Flex,{align:"center",gap:4,paddingLeft:3,paddingRight:2,children:[selected&&/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:/* @__PURE__ */jsx(CheckmarkIcon,{})}),iconRightComponent&&/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:iconRightComponent})]})]});}const useWorkspaceAuthStates=createHookFromObservableFactory(workspaces=>combineLatest(workspaces.map(workspace=>workspace.auth.state.pipe(map(state=>[workspace.name,state])))).pipe(map(entries=>Object.fromEntries(entries))));const workspacesDocsUrl="https://beta.sanity.io/docs/platform/studio/workspaces";const LINKS=[{url:"https://slack.sanity.io/",title:"Community"},{url:"https://www.sanity.io/docs",title:"Docs"},{url:"https://www.sanity.io/legal/privacy",title:"Privacy"},{url:"https://www.sanity.io",title:"sanity.io"}];const StyledText$4=styled(Text$1)(_templateObject12||(_templateObject12=_taggedTemplateLiteral(["\n  a {\n    color: inherit;\n  }\n"])));function Layout$1(props){const{children,footer,header}=props;return/* @__PURE__ */jsxs(Stack,{space:6,children:[/* @__PURE__ */jsx(Card,{border:true,radius:3,overflow:"auto",children:/* @__PURE__ */jsxs(Stack,{children:[typeof header==="object"&&/* @__PURE__ */jsx(Box,{children:header}),typeof header==="string"&&/* @__PURE__ */jsx(Box,{paddingY:4,children:/* @__PURE__ */jsx(Heading,{align:"center",size:1,children:header})}),/* @__PURE__ */jsx(Box,{paddingX:1,children:/* @__PURE__ */jsx(Card,{borderTop:Boolean(header),borderBottom:Boolean(footer),children})}),footer&&/* @__PURE__ */jsx(Box,{children:footer})]})}),/* @__PURE__ */jsxs(Flex,{direction:"column",gap:4,justify:"center",align:"center",children:[/* @__PURE__ */jsx(Text$1,{size:3,children:/* @__PURE__ */jsx(SanityLogo,{})}),/* @__PURE__ */jsx(Flex,{align:"center",gap:2,children:LINKS.map((link,index)=>/* @__PURE__ */jsxs(React.Fragment,{children:[/* @__PURE__ */jsx(StyledText$4,{muted:true,size:1,children:/* @__PURE__ */jsx("a",{href:link.url,target:"_blank",rel:"noopener noreferrer",children:link.title})}),index<LINKS.length-1&&/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:"\u2022"})]},link.title))})]})]});}function WorkspaceAuth(){var _a;const workspaces=useWorkspaces();const{activeWorkspace,setActiveWorkspace}=useActiveWorkspace();const[authStates]=useWorkspaceAuthStates(workspaces);const[selectedWorkspaceName,setSelectedWorkspaceName]=useState((activeWorkspace==null?void 0:activeWorkspace.name)||null);const selectedWorkspace=workspaces.length===1?workspaces[0]:workspaces.find(workspace=>workspace.name===selectedWorkspaceName);const LoginComponent=(_a=selectedWorkspace==null?void 0:selectedWorkspace.auth)==null?void 0:_a.LoginComponent;const handleBack=useCallback(()=>setSelectedWorkspaceName(null),[]);if(!authStates)return/* @__PURE__ */jsx(LoadingScreen,{});if(LoginComponent&&selectedWorkspace){return/* @__PURE__ */jsxs(Stack,{space:2,children:[workspaces.length>1&&/* @__PURE__ */jsx(Flex,{children:/* @__PURE__ */jsx(Button,{fontSize:1,icon:ArrowLeftIcon,mode:"bleed",onClick:handleBack,padding:2,text:"Choose another workspace"})}),/* @__PURE__ */jsx(Layout$1,{header:/* @__PURE__ */jsx(Box,{padding:3,children:/* @__PURE__ */jsx(WorkspacePreview,{icon:selectedWorkspace.icon,title:selectedWorkspace.title,subtitle:selectedWorkspace.dataset})}),children:/* @__PURE__ */jsx(Stack,{padding:2,paddingBottom:3,paddingTop:4,children:/* @__PURE__ */createElement(LoginComponent,_objectSpread(_objectSpread({},omit(selectedWorkspace,["type","__internal"])),{},{key:selectedWorkspaceName}))})})]});}return/* @__PURE__ */jsx(Layout$1,{header:"Choose your workspace",footer:/* @__PURE__ */jsx(Stack,{padding:1,children:/* @__PURE__ */jsx(Button,{as:"a",href:workspacesDocsUrl,icon:AddIcon,justify:"flex-start",mode:"bleed",rel:"noopener noreferrer",target:"__blank",text:"Add workspace"})}),children:/* @__PURE__ */jsx(Stack,{space:1,paddingX:1,paddingY:2,children:workspaces.map(workspace=>{const authState=authStates[workspace.name];const state=authState.authenticated?"logged-in":workspace.auth.LoginComponent?"logged-out":"no-access";const handleSelectWorkspace=()=>{if(state==="logged-in"&&workspace.name!==activeWorkspace.name){setActiveWorkspace(workspace.name);}if(state==="logged-out"){setSelectedWorkspaceName(workspace.name);}};return/* @__PURE__ */jsx(Card,{as:"button",radius:2,padding:2,onClick:handleSelectWorkspace,children:/* @__PURE__ */jsx(WorkspacePreview,{icon:workspace==null?void 0:workspace.icon,iconRight:ChevronRightIcon,state,subtitle:workspace.dataset,title:(workspace==null?void 0:workspace.title)||workspace.name})},workspace.name);})})});}const StyledMenu$2=styled(Menu)(_templateObject13||(_templateObject13=_taggedTemplateLiteral(["\n  max-width: 350px;\n  min-width: 250px;\n"])));const FooterCard=styled(Card)(_templateObject14||(_templateObject14=_taggedTemplateLiteral(["\n  position: sticky;\n  bottom: 0;\n"])));function WorkspaceMenuButton(props){const{scheme}=useColorScheme();const workspaces=useWorkspaces();const{activeWorkspace,setActiveWorkspace}=useActiveWorkspace();const[authStates]=useWorkspaceAuthStates(workspaces);const{navigateUrl}=useRouter();const popoverProps=useMemo(()=>({constrainSize:true,scheme,portal:true}),[scheme]);return/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,_objectSpread(_objectSpread({icon:SelectIcon,mode:"bleed"},props),{},{disabled:!authStates})),id:"workspace-menu",menu:/* @__PURE__ */jsxs(StyledMenu$2,{paddingBottom:0,children:[/* @__PURE__ */jsx(Box,{paddingX:3,paddingY:3,children:/* @__PURE__ */jsx(Label,{size:1,muted:true,children:"Workspaces"})}),authStates&&workspaces.map(workspace=>{const authState=authStates[workspace.name];const state=authState.authenticated?"logged-in":workspace.auth.LoginComponent?"logged-out":"no-access";const handleSelectWorkspace=()=>{if(state==="logged-in"&&workspace.name!==activeWorkspace.name){setActiveWorkspace(workspace.name);}if(state==="logged-out"){navigateUrl({path:workspace.basePath});}};return/* @__PURE__ */jsx(MenuItem,{onClick:handleSelectWorkspace,padding:2,pressed:workspace.name===activeWorkspace.name,children:/* @__PURE__ */jsx(WorkspacePreview,{icon:workspace==null?void 0:workspace.icon,selected:workspace.name===activeWorkspace.name,state,subtitle:workspace.dataset,title:(workspace==null?void 0:workspace.title)||workspace.name})},workspace.name);}),/* @__PURE__ */jsx(FooterCard,{borderTop:true,paddingY:1,children:/* @__PURE__ */jsx(MenuItem,{as:"a",href:workspacesDocsUrl,icon:AddIcon,rel:"noopener noreferrer",target:"__blank",text:"Add workspace"})})]}),popover:popoverProps});}function AuthenticateScreen(){return/* @__PURE__ */jsx(Card,{height:"fill",children:/* @__PURE__ */jsx(Flex,{align:"center",justify:"center",height:"fill",children:/* @__PURE__ */jsx(Container$1,{width:0,children:/* @__PURE__ */jsx(WorkspaceAuth,{})})})});}function ConfigErrorsScreen(){return/* @__PURE__ */jsx(Fragment,{children:"TODO: implement config errors screen"});}const getProviderTitle=provider=>{if(provider==="google"){return"Google";}if(provider==="github"){return"GitHub";}if(provider==="sanity"){return"Sanity";}if(provider==null?void 0:provider.startsWith("saml-")){return"SAML/SSO";}return void 0;};function NotAuthenticatedScreen(){const[currentUser,setCurrentUser]=useState(null);const[error,handleError]=useState(null);if(error)throw error;const{activeWorkspace}=useActiveWorkspace();const handleLogout=useCallback(()=>{var _a,_b;(_b=(_a=activeWorkspace.auth).logout)==null?void 0:_b.call(_a);},[activeWorkspace]);useEffect(()=>{const subscription=activeWorkspace.auth.state.subscribe({next:_ref40=>{let{currentUser:user}=_ref40;setCurrentUser(user);},error:handleError});return()=>{subscription.unsubscribe();};},[activeWorkspace]);const providerTitle=getProviderTitle(currentUser==null?void 0:currentUser.provider);const providerHelp=providerTitle?" through ".concat(providerTitle):"";return/* @__PURE__ */jsx(Card,{height:"fill",children:/* @__PURE__ */jsx(Dialog,{id:"not-authorized-dialog",header:"Not authorized",width:1,footer:/* @__PURE__ */jsx(Stack,{paddingX:3,paddingY:2,children:/* @__PURE__ */jsx(Button,{text:"Sign out",onClick:handleLogout})}),children:/* @__PURE__ */jsxs(Stack,{paddingX:4,paddingY:5,space:4,children:[/* @__PURE__ */jsx(Text$1,{children:"You are not authorized to access this studio. Maybe you could ask someone to invite you to collaborate on this project?"}),/* @__PURE__ */jsxs(Text$1,{children:["If you think this is an error, verify that you are signed in with the correct account. You are currently signed in as"," ",/* @__PURE__ */jsxs("strong",{children:[currentUser==null?void 0:currentUser.name," (",currentUser==null?void 0:currentUser.email,")"]}),providerHelp,"."]})]})})});}function CorsOriginErrorScreen(props){const{projectId}=props;const corsUrl="https://sanity.io/manage/project/".concat(projectId,"/settings/api");const origin=window.location.origin;const handleRetry=useCallback(()=>{window.location.reload();},[]);return/* @__PURE__ */jsx(Card,{height:"fill",children:/* @__PURE__ */jsx(Dialog,{id:"cors-error-dialog",header:"Error",width:1,footer:/* @__PURE__ */jsx(Stack,{paddingX:3,paddingY:2,children:/* @__PURE__ */jsx(Button,{text:"Retry",onClick:handleRetry})}),children:/* @__PURE__ */jsxs(Stack,{paddingX:4,paddingY:5,space:4,children:[/* @__PURE__ */jsxs(Text$1,{children:["It looks like the error is being caused by the current origin (",/* @__PURE__ */jsx("code",{children:origin}),") not being allowed for this project."]}),/* @__PURE__ */jsxs(Text$1,{children:["If you are a project administrator or developer, you can head to"," ",/* @__PURE__ */jsx("a",{rel:"noopener noreferrer",target:"_blank",href:corsUrl,children:"the project management"})," ","interface to configure CORS origins for this project."]}),/* @__PURE__ */jsxs(Text$1,{children:[/* @__PURE__ */jsx("a",{href:"https://www.sanity.io/docs/front-ends/cors",target:"_blank",rel:"noopener noreferrer",children:"Read more about CORS Origins"}),"."]})]})})});}const errorChannel=globalScope.__sanityErrorChannel;function isKnownError(err){if(err instanceof SchemaError){return true;}if(err instanceof CorsOriginError){return true;}return false;}function StudioErrorBoundary(_ref41){let{children}=_ref41;const[{error},setError]=useState({error:null});const{push:pushToast}=useToast();const message=isRecord$2(error)&&typeof error.message==="string"&&error.message;const stack=isRecord$2(error)&&typeof error.stack==="string"&&error.stack;const handleResetError=useCallback(()=>setError({error:null}),[setError]);useHotModuleReload(handleResetError);useEffect(()=>{if(!errorChannel)return void 0;return errorChannel.subscribe(msg=>{if(!msg.error){return;}if(isKnownError(msg.error)){return;}console.error(msg.error);pushToast({closable:true,description:msg.error.message,duration:5e3,title:"Uncaught error",status:"error"});});},[pushToast]);if(error instanceof CorsOriginError){return/* @__PURE__ */jsx(CorsOriginErrorScreen,{projectId:error==null?void 0:error.projectId});}if(error instanceof SchemaError){return/* @__PURE__ */jsx(SchemaErrorsScreen,{schema:error.schema});}if(error){return/* @__PURE__ */jsx(Card,{height:"fill",overflow:"auto",paddingY:[4,5,6,7],paddingX:4,sizing:"border",tone:"critical",children:/* @__PURE__ */jsx(Container$1,{width:3,children:/* @__PURE__ */jsxs(Stack,{space:4,children:[/* @__PURE__ */jsx(Heading,{children:"An error occurred"}),/* @__PURE__ */jsx("div",{children:/* @__PURE__ */jsx(Button,{onClick:handleResetError,text:"Retry",tone:"default"})}),/* @__PURE__ */jsx(Card,{border:true,radius:2,overflow:"auto",padding:4,tone:"inherit",children:/* @__PURE__ */jsxs(Stack,{space:4,children:[message&&/* @__PURE__ */jsx(Code,{size:1,children:/* @__PURE__ */jsxs("strong",{children:["Error: ",message]})}),stack&&/* @__PURE__ */jsx(Code,{size:1,children:stack})]})})]})})});}return/* @__PURE__ */jsx(ErrorBoundary,{onCatch:setError,children});}styled(Flex)(_templateObject15||(_templateObject15=_taggedTemplateLiteral([""])));styled(Box).attrs({padding:4})(_templateObject16||(_templateObject16=_taggedTemplateLiteral([""])));function createRouter(opts){const{basePath="/",tools}=opts;const toolRoute=route.create("/:tool",toolParams=>{const tool=tools.find(current=>current.name===toolParams.tool);return tool?route.scope(tool.name,"/",tool.router):route.create("/");});return route.create(basePath,[route.intents("/intent"),toolRoute]);}function getOrderedTools(tools){const pluginConfig={};const config=pluginConfig.toolSwitcher||{};const order=config.order||[];const hidden=config.hidden||[];if(!order.length&&!hidden.length){return tools;}const keyed=tools.reduce((target,tool)=>{const title=tool.title||"<unknown>";if(!tool.name){console.warn("Tool \"".concat(title,"\" does not have the required \"name\" property"));return target;}if(target[tool.name]){const existing=target[tool.name].tool.title;console.warn("Tools with duplicate name \"".concat(tool.name,"\" found (\"").concat(title,"\" and \"").concat(existing,"\")"));return target;}const toolIndex=order.indexOf(tool.name);target[tool.name]={tool,index:toolIndex===-1?Infinity:toolIndex};return target;},{});const isVisible=tool=>hidden.indexOf(tool.name)===-1;const ret=tools.filter(isVisible);ret.sort((tool1,tool2)=>{const toolA=keyed[tool1.name];const toolB=keyed[tool2.name];const indexA=toolA?toolA.index:Infinity;const indexB=toolB?toolB.index:Infinity;if(indexA===indexB){return 0;}return indexA-indexB;});return ret;}function resolveUrlStateWithDefaultTool(tools,state){const orderedTools=getOrderedTools(tools);const defaultTool=orderedTools[0];if(!state||state.tool||!defaultTool){return state;}return Object.assign({},state,{tool:defaultTool.name});}function makeBackwardsCompatible(tools,state){if(!state){return state;}if(getOrderedTools(tools).find(tool=>tool.name===state.space)){return _objectSpread(_objectSpread({},state),{},{tool:state.space,space:void 0});}return state;}function resolveDefaultState(tools,state){const urlStateWithDefaultTool=resolveUrlStateWithDefaultTool(tools,makeBackwardsCompatible(tools,state));return urlStateWithDefaultTool;}function resolveIntentState(tools,currentState,intentState){const{intent,params,payload}=intentState;if(typeof intent!=="string"){throw new Error("intent must be a string");}if(!isRecord$2(params)){throw new Error("intent params must be a string");}const orderedTools=getOrderedTools(tools);const currentTool=(currentState==null?void 0:currentState.tool)?orderedTools.find(tool=>tool.name===currentState.tool):null;const matchingTool=(currentTool?[currentTool,...orderedTools]:orderedTools).find(tool=>tool&&typeof tool.canHandleIntent==="function"&&tool.canHandleIntent(intent,params,currentState&&currentState[tool.name]));if(matchingTool==null?void 0:matchingTool.getIntentState){const toolState=matchingTool.getIntentState(intent,params,currentState&&currentState[matchingTool.name],payload);return{type:"state",isNotFound:false,state:_objectSpread(_objectSpread({},currentState),{},{tool:matchingTool.name,[matchingTool.name]:toolState})};}return{type:"intent",isNotFound:true,intent:{name:intent,params}};}function decodeUrlState(rootRouter,pathname){return{type:"state",state:rootRouter.decode(pathname)||{},isNotFound:rootRouter.isNotFound(pathname)};}function isNonNullable$2(value){return value!==null&&value!==void 0;}function createRouterEventStream(_ref42){let{unstable_history:history,router,tools}=_ref42;function maybeHandleIntent(prevEvent,currentEvent){var _a;if((currentEvent==null?void 0:currentEvent.type)==="state"&&((_a=currentEvent.state)==null?void 0:_a.intent)){const redirectState=resolveIntentState(tools,(prevEvent==null?void 0:prevEvent.type)==="state"?prevEvent.state:{},currentEvent.state);if((redirectState==null?void 0:redirectState.type)==="state"){history.replace(router.encode(redirectState.state));return EMPTY$1;}}return of(currentEvent);}function maybeRedirectDefaultState(event){if(event.type==="state"){const defaultState=resolveDefaultState(tools,event.state);if(defaultState&&defaultState!==event.state){history.replace(router.encode(defaultState));return null;}}return event;}const routerBasePath=router.getBasePath();const state$=new Observable(observer=>{const unlisten=history.listen(location=>observer.next(location));observer.next(history.location);return unlisten;}).pipe(filter(_ref43=>{let{pathname}=_ref43;return routerBasePath==="/"?true:new RegExp("^".concat(escapeRegExp$1(routerBasePath),"(\\/|$)"),"i").test(pathname);}),map(_ref44=>{let{pathname}=_ref44;return decodeUrlState(router,pathname);}),mergeScan(maybeHandleIntent,null),filter(isNonNullable$2),map(maybeRedirectDefaultState),filter(isNonNullable$2),distinctUntilChanged(isEqual$1),shareReplay(1));return state$;}const WorkspaceContext=createContext(null);function WorkspaceProvider(_ref45){let{children,workspace}=_ref45;return/* @__PURE__ */jsx(WorkspaceContext.Provider,{value:workspace,children});}function useWorkspace(){const workspace=useContext(WorkspaceContext);if(!workspace)throw new Error("Could not find `workspace` context");return workspace;}const SourceContext=createContext(null);function SourceProvider(_ref46){let{children}=_ref46,props=_objectWithoutProperties(_ref46,_excluded12);const parentSource=useContext(SourceContext);const{unstable_sources:sources}=useWorkspace();if("source"in props){const{source}=props;return/* @__PURE__ */jsx(SourceContext.Provider,{value:source,children});}if("name"in props){const{name}=props;const source=sources.find(s=>s.name===name);if(!source){throw new Error("Could not find source with name `".concat(name,"` in current workspace"));}if(parentSource===source)return/* @__PURE__ */jsx(Fragment,{children});return/* @__PURE__ */jsx(SourceContext.Provider,{value:source,children});}throw new Error("Invalid props passed into SourceProvider. A `name` or a `source` object is required.");}function useSource(){const source=useContext(SourceContext);if(!source)throw new Error("Could not find `source` context");return source;}const isStateEvent=e=>e.type==="state";const initialState={isNotFound:true,state:{}};const useRouterState=createHookFromObservableFactory(_ref47=>{let{tools,unstable_history,router}=_ref47;if(!router||!tools)return of(initialState);return createRouterEventStream({unstable_history,router,tools}).pipe(filter(isStateEvent),scan((prevState,event)=>{return _objectSpread(_objectSpread({},prevState),{},{isNotFound:event.isNotFound,state:event.state});},initialState));},{initialValue:initialState});function WorkspaceLoader(_ref48){let{children,LoadingComponent}=_ref48;const[error,handleError]=useState(null);if(error)throw error;const{activeWorkspace,__internal:{history}}=useActiveWorkspace();const[workspace,setWorkspace]=useState(null);const handleNavigate=useCallback(opts=>{if(opts.replace){history.replace(opts.path);}else{history.push(opts.path);}},[history]);useEffect(()=>{const subscription=combineLatest(activeWorkspace.__internal.sources.map(_ref49=>{let{source}=_ref49;return source.pipe(catchError(err=>{if(err instanceof ConfigResolutionError)return of(err);throw err;}));})).pipe(map(results=>{const errors=results.filter(result=>result instanceof ConfigResolutionError);if(errors.length){throw new ConfigResolutionError({name:activeWorkspace.name,causes:errors,type:"workspace"});}return results;}),map(_ref50=>{let[rootSource,...restOfSources]=_ref50;return _objectSpread(_objectSpread(_objectSpread({},activeWorkspace),rootSource),{},{unstable_sources:[rootSource,...restOfSources],type:"workspace"});})).subscribe({next:setWorkspace,error:handleError});return()=>subscription.unsubscribe();},[activeWorkspace]);const tools=workspace==null?void 0:workspace.tools;const router=useMemo(()=>{if(!workspace)return void 0;return createRouter(workspace);},[workspace]);const[routerState]=useRouterState({unstable_history:history,router,tools});if(!router||!workspace)return/* @__PURE__ */jsx(LoadingComponent,{});return/* @__PURE__ */jsx(WorkspaceProvider,{workspace,children:/* @__PURE__ */jsx(SourceProvider,{source:workspace.unstable_sources[0],children:/* @__PURE__ */jsx(RouterProvider,{onNavigate:handleNavigate,router,state:routerState.state,children})})});}function WorkspaceLoaderBoundary(_ref51){let{ConfigErrorsComponent}=_ref51,props=_objectWithoutProperties(_ref51,_excluded13);const[{error},setError]=useState({error:null});if(error instanceof ConfigResolutionError)return/* @__PURE__ */jsx(ConfigErrorsComponent,{});if(error)throw error;return/* @__PURE__ */jsx(ErrorBoundary,{onCatch:setError,children:/* @__PURE__ */jsx(WorkspaceLoader,_objectSpread({},props))});}function AuthBoundary(_ref52){let{children,AuthenticateComponent=AuthenticateScreen,LoadingComponent=LoadingScreen,NotAuthenticatedComponent=NotAuthenticatedScreen}=_ref52;const[error,handleError]=useState(null);if(error)throw error;const[loggedIn,setLoggedIn]=useState("loading");const{activeWorkspace}=useActiveWorkspace();useEffect(()=>{var _a,_b;(_b=(_a=activeWorkspace.auth).handleCallbackUrl)==null?void 0:_b.call(_a).catch(handleError);},[activeWorkspace.auth]);useEffect(()=>{const subscription=activeWorkspace.auth.state.subscribe({next:_ref53=>{let{authenticated,currentUser}=_ref53;var _a;if(((_a=currentUser==null?void 0:currentUser.roles)==null?void 0:_a.length)===0){setLoggedIn("unauthorized");return;}setLoggedIn(authenticated?"logged-in":"logged-out");},error:handleError});return()=>{subscription.unsubscribe();};},[activeWorkspace]);if(loggedIn==="loading")return/* @__PURE__ */jsx(LoadingComponent,{});if(loggedIn==="unauthorized")return/* @__PURE__ */jsx(NotAuthenticatedComponent,{});if(loggedIn==="logged-out")return/* @__PURE__ */jsx(AuthenticateComponent,{});return/* @__PURE__ */jsx(Fragment,{children});}const Z_OFFSET={toast:[100,11e3]};Refractor.registerLanguage(bash);Refractor.registerLanguage(javascript);Refractor.registerLanguage(json);Refractor.registerLanguage(jsx2);Refractor.registerLanguage(typescript);function StudioProvider(_ref54){let{children,config,onSchemeChange,scheme,unstable_history:history,unstable_noAuthBoundary:noAuthBoundary}=_ref54;const ConditionalAuthBoundary=useMemo(()=>noAuthBoundary?Fragment$1:AuthBoundary,[noAuthBoundary]);return/* @__PURE__ */jsx(ColorSchemeProvider,{onSchemeChange,scheme,children:/* @__PURE__ */jsx(ToastProvider,{paddingY:7,zOffset:Z_OFFSET.toast,children:/* @__PURE__ */jsx(StudioErrorBoundary,{children:/* @__PURE__ */jsx(WorkspacesProvider,{config,children:/* @__PURE__ */jsx(ActiveWorkspaceMatcher,{unstable_history:history,NotFoundComponent:NotFoundScreen,LoadingComponent:LoadingScreen,children:/* @__PURE__ */jsx(StudioThemeProvider,{children:/* @__PURE__ */jsx(UserColorManagerProvider,{children:/* @__PURE__ */jsx(ConditionalAuthBoundary,{LoadingComponent:LoadingScreen,AuthenticateComponent:AuthenticateScreen,NotAuthenticatedComponent:NotAuthenticatedScreen,children:/* @__PURE__ */jsx(WorkspaceLoaderBoundary,{LoadingComponent:LoadingScreen,ConfigErrorsComponent:ConfigErrorsScreen,children:/* @__PURE__ */jsx(ResourceCacheProvider,{children})})})})})})})})})});}const isDev=process.env.NODE_ENV!=="production";const isProd=!isDev;const symbols=/[^\p{Alpha}\p{White_Space}]/gu;const whitespace=/\p{White_Space}+/u;const LEGACY_TO_UI_AVATAR_SIZES={small:0,medium:1,large:2};function nameToInitials(fullName){const namesArray=fullName.replace(symbols,"").split(whitespace);if(namesArray.length===1){return"".concat(namesArray[0].charAt(0)).toUpperCase();}return"".concat(namesArray[0].charAt(0)).concat(namesArray[namesArray.length-1].charAt(0));}function UserAvatar(props){const{user}=props,restProps=_objectWithoutProperties(props,_excluded14);if(isRecord$2(user)){if(restProps.withTooltip){return/* @__PURE__ */jsx(TooltipUserAvatar,_objectSpread(_objectSpread({},restProps),{},{user}));}return/* @__PURE__ */jsx(StaticUserAvatar,_objectSpread(_objectSpread({},restProps),{},{user}));}return/* @__PURE__ */jsx(UserAvatarLoader,_objectSpread(_objectSpread({},props),{},{user}));}function TooltipUserAvatar(props){const{user:{displayName}}=props;return/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:displayName})}),placement:"top",portal:true,children:/* @__PURE__ */jsx("div",{style:{display:"inline-block"},children:/* @__PURE__ */jsx(StaticUserAvatar,_objectSpread({},props))})});}const StaticUserAvatar=forwardRef(function StaticUserAvatar2(props,ref){const{user,animateArrowFrom,position,size,status,tone}=props;const[imageLoadError,setImageLoadError]=useState(null);const userColor=useUserColor(user.id);const imageUrl=imageLoadError?void 0:user==null?void 0:user.imageUrl;return/* @__PURE__ */jsx(Avatar,{animateArrowFrom,arrowPosition:position,color:userColor.name,"data-legacy-tone":tone,initials:(user==null?void 0:user.displayName)&&nameToInitials(user.displayName),src:imageUrl,onImageLoadError:setImageLoadError,ref,size:typeof size==="string"?LEGACY_TO_UI_AVATAR_SIZES[size]:size,status});});function UserAvatarLoader(_ref55){let{user}=_ref55,loadedProps=_objectWithoutProperties(_ref55,_excluded15);const[value]=useUser(user);if(!value){return null;}return/* @__PURE__ */jsx(UserAvatar,_objectSpread(_objectSpread({},loadedProps),{},{user:value}));}const Root$A=styled.div(_templateObject17||(_templateObject17=_taggedTemplateLiteral(["\n  position: absolute;\n  width: 18px;\n  height: 18px;\n  background: var(--card-bg-color);\n  bottom: -4px;\n  right: -4px;\n  border-radius: 50%;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  border: 1px solid var(--card-bg-color);\n  box-sizing: content-box;\n\n  svg {\n    box-sizing: content-box;\n    border: 1px solid var(--card-hairline-soft-color);\n    border-radius: 50%;\n    padding: 2px;\n    width: 12px;\n    height: 12px;\n  }\n\n  &[data-logo='github'] {\n    svg {\n      path {\n        fill: var(--card-fg-color);\n      }\n    }\n  }\n\n  &[data-logo='saml'] {\n    svg {\n      path {\n        fill: var(--card-fg-color);\n      }\n    }\n  }\n"])));const Google=/* @__PURE__ */jsxs("svg",{width:"12",height:"12",viewBox:"0 0 12 12",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[/* @__PURE__ */jsxs("g",{clipPath:"url(#clip0)",children:[/* @__PURE__ */jsx("path",{d:"M12 6.13764C12 5.72977 11.9663 5.31971 11.8943 4.91846H6.12036V7.22895H9.42684C9.28963 7.97412 8.84876 8.63332 8.20322 9.05221V10.5514H10.1759C11.3342 9.50637 12 7.9631 12 6.13764Z",fill:"#4285F4"}),/* @__PURE__ */jsx("path",{d:"M6.12019 12.0002C7.77118 12.0002 9.16349 11.4688 10.1779 10.5517L8.20529 9.05253C7.65646 9.41851 6.94793 9.62574 6.12244 9.62574C4.52544 9.62574 3.17136 8.56971 2.68552 7.1499H0.649902V8.69537C1.68908 10.7215 3.80567 12.0002 6.12019 12.0002V12.0002Z",fill:"#34A853"}),/* @__PURE__ */jsx("path",{d:"M2.68332 7.14986C2.4269 6.40469 2.4269 5.59778 2.68332 4.8526V3.30713H0.649951C-0.218278 5.00252 -0.218278 6.99995 0.649951 8.69533L2.68332 7.14986V7.14986Z",fill:"#FBBC04"}),/* @__PURE__ */jsx("path",{d:"M6.12019 2.37483C6.99291 2.3616 7.8364 2.68348 8.46845 3.27433L10.2161 1.56131C9.1095 0.542752 7.64071 -0.017233 6.12019 0.000404333C3.80566 0.000404333 1.68908 1.27911 0.649902 3.3074L2.68326 4.85288C3.16686 3.43087 4.52319 2.37483 6.12019 2.37483V2.37483Z",fill:"#EA4335"})]}),/* @__PURE__ */jsx("defs",{children:/* @__PURE__ */jsx("clipPath",{id:"clip0",children:/* @__PURE__ */jsx("rect",{width:"12",height:"12",fill:"white"})})})]});const GitHub=/* @__PURE__ */jsxs("svg",{width:"12",height:"12",viewBox:"0 0 12 12",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[/* @__PURE__ */jsx("g",{clipPath:"url(#clip0)",children:/* @__PURE__ */jsx("path",{d:"M11.195 3.13503C10.6711 2.22838 9.91808 1.47537 9.01144 0.951471C8.09222 0.414976 7.08837 0.146729 5.99987 0.146729C4.91137 0.146729 3.90752 0.414976 2.98831 0.951471C2.08163 1.47534 1.32862 2.22836 0.804744 3.13503C0.268248 4.05497 0 5.05883 0 6.14659C0 7.45399 0.381531 8.62978 1.14459 9.67394C1.90765 10.7181 2.89327 11.4408 4.10143 11.8419C4.24208 11.868 4.34624 11.8497 4.41392 11.7872C4.44666 11.7577 4.47263 11.7215 4.49006 11.681C4.50749 11.6405 4.51595 11.5967 4.51488 11.5527C4.51488 11.537 4.51361 11.3963 4.51105 11.1307C4.5085 10.8651 4.50722 10.6334 4.50722 10.4355L4.32745 10.4666C4.18407 10.4895 4.03885 10.4986 3.89375 10.494C3.71159 10.4908 3.53001 10.4725 3.35087 10.4393C3.16049 10.4045 2.98119 10.3246 2.82796 10.2064C2.66705 10.0846 2.54715 9.91661 2.48428 9.72484L2.40602 9.54506C2.34022 9.40286 2.25754 9.2691 2.15976 9.14666C2.04775 9.00072 1.93447 8.90176 1.81991 8.84977L1.76518 8.81064C1.72769 8.78356 1.6936 8.75205 1.66367 8.71679C1.63479 8.6841 1.61108 8.64719 1.59334 8.60734C1.57766 8.57085 1.5907 8.54085 1.63247 8.51731C1.67461 8.49405 1.75123 8.48256 1.86068 8.48256L2.01692 8.50582C2.12108 8.52662 2.24996 8.5891 2.40356 8.69326C2.5585 8.79876 2.68797 8.93748 2.78254 9.09932C2.90239 9.31294 3.04695 9.47575 3.21624 9.58775C3.38552 9.69976 3.55609 9.75576 3.72793 9.75576C3.87725 9.7578 4.02641 9.74479 4.17312 9.7169C4.29459 9.69195 4.41264 9.65254 4.52473 9.59952C4.57162 9.25037 4.69931 8.98212 4.90782 8.79477C4.63684 8.76849 4.36827 8.72157 4.10444 8.6544C3.84797 8.58382 3.60133 8.48141 3.37029 8.34958C3.12825 8.218 2.91442 8.04015 2.74095 7.82613C2.57421 7.6178 2.4374 7.34417 2.3305 7.00524C2.2236 6.6663 2.1707 6.27584 2.1718 5.83383C2.1718 5.20357 2.37757 4.66708 2.7891 4.22435C2.59629 3.75006 2.61453 3.21885 2.84383 2.63073C2.99487 2.58385 3.21879 2.61897 3.51559 2.73608C3.81239 2.85319 4.02983 2.95352 4.16792 3.03707C4.30601 3.12025 4.41665 3.19058 4.49983 3.24804C5.48153 2.9773 6.51821 2.9773 7.49991 3.24804L7.79679 3.0606C8.0249 2.92356 8.26549 2.80849 8.51535 2.71693C8.79135 2.61276 9.00231 2.58412 9.14825 2.63101C9.38248 3.21949 9.40327 3.7507 9.21064 4.22462C9.62199 4.66735 9.82776 5.20385 9.82795 5.83411C9.82795 6.27684 9.77459 6.66904 9.66787 7.01071C9.56116 7.35238 9.42325 7.62601 9.25415 7.8316C9.07785 8.04326 8.86311 8.21966 8.62124 8.35149C8.39008 8.48329 8.14337 8.5857 7.88682 8.65632C7.62412 8.72277 7.35674 8.76915 7.087 8.79505C7.35698 9.02927 7.49206 9.3994 7.49225 9.90543V11.5527C7.49115 11.5964 7.49929 11.6398 7.51612 11.6802C7.53295 11.7206 7.5581 11.7569 7.58993 11.7869C7.65505 11.8493 7.75794 11.8675 7.89858 11.8416C9.10693 11.4403 10.0926 10.7177 10.8557 9.67367C11.6188 8.62968 12.0003 7.4539 12.0003 6.14632C11.9997 5.05873 11.7313 4.05497 11.195 3.13503V3.13503Z",fill:"black"})}),/* @__PURE__ */jsx("defs",{children:/* @__PURE__ */jsx("clipPath",{id:"clip0",children:/* @__PURE__ */jsx("rect",{width:"12",height:"12",fill:"white"})})})]});const Saml=/* @__PURE__ */jsxs("svg",{width:"17",height:"9",viewBox:"0 0 17 9",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[/* @__PURE__ */jsx("path",{d:"M0.0691681 5.98162C0.115833 7.24157 1.07247 8.00221 2.59841 8.00221C4.17102 8.00221 5.12299 7.19957 5.12299 5.86962C5.12299 4.83832 4.55367 4.25501 3.25172 3.96569L2.56108 3.80703C1.8331 3.64837 1.53445 3.38704 1.53445 2.91106C1.53445 2.40708 1.94977 2.09442 2.61708 2.09442C3.27505 2.09442 3.6997 2.43508 3.75103 2.99039H5.00166C4.95966 1.78643 4.01236 0.997795 2.60308 0.997795C1.14713 0.997795 0.218496 1.79577 0.218496 3.05105C0.218496 4.04968 0.815808 4.69366 2.03376 4.96898L2.73374 5.13231C3.51304 5.30497 3.8117 5.54763 3.8117 6.00495C3.8117 6.55093 3.34972 6.90092 2.62174 6.90092C1.85644 6.90092 1.38045 6.56493 1.31979 5.98162H0.0691681Z"}),/* @__PURE__ */jsx("path",{d:"M5.97695 5.98162C6.02362 7.24157 6.98025 8.00221 8.5062 8.00221C10.0788 8.00221 11.0308 7.19957 11.0308 5.86962C11.0308 4.83832 10.4615 4.25501 9.15951 3.96569L8.46886 3.80703C7.74089 3.64837 7.44223 3.38704 7.44223 2.91106C7.44223 2.40708 7.85755 2.09442 8.52486 2.09442C9.18284 2.09442 9.60749 2.43508 9.65882 2.99039H10.9094C10.8674 1.78643 9.92015 0.997795 8.51086 0.997795C7.05492 0.997795 6.12628 1.79577 6.12628 3.05105C6.12628 4.04968 6.72359 4.69366 7.94155 4.96898L8.64153 5.13231C9.42083 5.30497 9.71949 5.54763 9.71949 6.00495C9.71949 6.55093 9.2575 6.90092 8.52953 6.90092C7.76422 6.90092 7.28824 6.56493 7.22758 5.98162H5.97695Z"}),/* @__PURE__ */jsx("path",{d:"M16.9852 5.01565V3.98435C16.9852 2.11309 16.0099 0.997795 14.3953 0.997795C12.7807 0.997795 11.8054 2.11309 11.8054 3.98435V5.01565C11.8054 6.88692 12.7807 8.00221 14.3953 8.00221C16.0099 8.00221 16.9852 6.88692 16.9852 5.01565ZM14.3953 6.82625C13.5833 6.82625 13.154 6.21494 13.154 5.00165V3.99835C13.154 2.78506 13.5833 2.17375 14.3953 2.17375C15.2073 2.17375 15.6366 2.78506 15.6366 3.99835V5.00165C15.6366 6.21494 15.2073 6.82625 14.3953 6.82625Z"})]});const LoginProviderLogo=_ref56=>{let{provider}=_ref56;const isSaml=provider==null?void 0:provider.startsWith("saml-");const logoName=isSaml?"saml":provider;return/* @__PURE__ */jsxs(Root$A,{"data-logo":logoName,children:[provider==="google"&&Google,provider==="github"&&GitHub,provider==="sanity"&&/* @__PURE__ */jsx(SanityMonogram,{}),isSaml&&Saml]});};const StyledMenu$1=styled(Menu)(_templateObject18||(_templateObject18=_taggedTemplateLiteral(["\n  min-width: 125px;\n  max-width: 350px;\n"])));const AvatarBox=styled(Box)(_templateObject19||(_templateObject19=_taggedTemplateLiteral(["\n  position: relative;\n"])));function UserMenu(){const{currentUser,projectId,auth}=useWorkspace();const{scheme,setScheme}=useColorScheme();const providerTitle=getProviderTitle(currentUser==null?void 0:currentUser.provider);const popoverProps=useMemo(()=>({placement:"bottom-end",portal:true,preventOverflow:true,scheme}),[scheme]);const handleToggleScheme=useCallback(()=>{setScheme(scheme==="dark"?"light":"dark");},[scheme,setScheme]);return/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{mode:"bleed",padding:0,paddingX:1,children:/* @__PURE__ */jsxs(Flex,{align:"center",gap:1,children:[/* @__PURE__ */jsx(UserAvatar,{user:"me",size:1}),/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:/* @__PURE__ */jsx(ChevronDownIcon,{})})]})}),id:"user-menu",menu:/* @__PURE__ */jsxs(StyledMenu$1,{children:[/* @__PURE__ */jsxs(Card,{padding:2,children:[/* @__PURE__ */jsx(Box,{marginBottom:3,children:/* @__PURE__ */jsx(Label,{size:1,muted:true,children:"Signed in as"})}),/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Tooltip,{disabled:!providerTitle,portal:true,content:providerTitle&&/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsxs(Text$1,{size:1,children:["Signed in with ",providerTitle]})}),children:/* @__PURE__ */jsxs(AvatarBox,{marginRight:3,children:[/* @__PURE__ */jsx(UserAvatar,{size:1,user:"me"}),(currentUser==null?void 0:currentUser.provider)&&/* @__PURE__ */jsx(LoginProviderLogo,{provider:currentUser.provider})]})}),/* @__PURE__ */jsxs(Stack,{space:2,flex:1,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",textOverflow:"ellipsis",children:currentUser==null?void 0:currentUser.name}),/* @__PURE__ */jsx(Text$1,{size:1,muted:true,textOverflow:"ellipsis",children:currentUser==null?void 0:currentUser.email})]})]})]}),/* @__PURE__ */jsx(MenuDivider,{}),/* @__PURE__ */jsx(MenuItem,{icon:scheme==="dark"?SunIcon:MoonIcon,onClick:handleToggleScheme,text:scheme==="dark"?"Switch to light mode":"Switch to dark mode"}),/* @__PURE__ */jsx(MenuDivider,{}),/* @__PURE__ */jsx(MenuItem,{as:"a",href:"https://sanity.io/manage/project/".concat(projectId),target:"_blank",text:"Manage project",icon:CogIcon}),auth.logout&&/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(MenuDivider,{}),/* @__PURE__ */jsx(MenuItem,_objectSpread({iconRight:LeaveIcon,text:"Sign out",disabled:!auth.logout},auth.logout&&{onClick:auth.logout}))]})]}),popover:popoverProps});}const PREVIEW_MEDIA_SIZE={block:{width:33,height:33},blockImage:{width:600,height:400},default:{width:35,height:35},detail:{width:75,height:75},inline:{width:15,height:15},media:{width:160,height:160}};const PREVIEW_ICON_SIZE={block:31,blockImage:45,default:33,detail:45,inline:15,media:45};const MediaWrapper=styled.span(props=>{const{$dimensions,$layout,$radius,$responsive}=props;const width=$dimensions.width||0;const height=$dimensions.width||0;const iconSize=PREVIEW_ICON_SIZE[$layout];return css(_templateObject20||(_templateObject20=_taggedTemplateLiteral(["\n    position: relative;\n    width: ",";\n    height: ",";\n    min-width: ",";\n    border-radius: ",";\n    display: flex;\n    align-items: center;\n    justify-content: center;\n\n    & img {\n      position: absolute;\n      left: 0;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      object-fit: contain;\n      border-radius: inherit;\n    }\n\n    & svg {\n      display: block;\n      font-size: calc(21 / 16 * 1em);\n    }\n\n    & [data-sanity-icon] {\n      display: block;\n      font-size: calc("," / 16 * 1em);\n    }\n\n    /*\n      NOTE on why we can\u2019t use the \":after\" pseudo-element:\n      The thing is we only want the shadow when then <MediaWrapper> contains\n      something else than <svg> \u2013 icons should not have the shadow.\n      This is why we use the \"*:not(svg) + span\" selector to target only that\n      situation to render the shadow.\n    */\n    & *:not(svg) + span {\n      display: block;\n      position: absolute;\n      left: 0;\n      top: 0;\n      right: 0;\n      bottom: 0;\n      box-shadow: inset 0 0 0 1px var(--card-fg-color);\n      opacity: 0.2;\n      border-radius: inherit;\n    }\n  "])),$responsive?"100%":rem(width),$responsive?"100%":rem(height),$responsive?void 0:rem(width),_ref57=>{let{theme}=_ref57;return rem(theme.sanity.radius[$radius]);},iconSize);});MediaWrapper.displayName="MediaWrapper";function Media(props){const{border=true,dimensions,layout,media,radius=1,responsive=false,styles}=props;return/* @__PURE__ */jsxs(MediaWrapper,{$dimensions:dimensions,$layout:layout,$radius:radius,$responsive:responsive,className:styles==null?void 0:styles.media,"data-testid":"Media",children:[renderMedia({dimensions,layout,media}),border&&/* @__PURE__ */jsx("span",{})]});}function renderMedia(props){const{dimensions,layout,media,styles}=props;if(isValidElementType(media)){return createElement(media,{dimensions,layout});}if(typeof media==="string"){return/* @__PURE__ */jsx(Text$1,{as:"span",className:styles==null?void 0:styles.mediaString,children:media});}if(isValidElement(media)){return media;}return null;}function renderPreviewMedia(value,layout,dimensions){if(isValidElementType(value)){return createElement(value,{layout,dimensions});}if(typeof value==="string"){return/* @__PURE__ */jsx("div",{children:value});}return value;}function renderPreviewNode(value,layout,fallbackNode){if(typeof value==="string"){return value;}if(isValidElementType(value)){return createElement(value,{layout});}return value||fallbackNode;}const DEFAULT_MEDIA_DIMENSIONS$5=_objectSpread(_objectSpread({},PREVIEW_MEDIA_SIZE.default),{},{aspect:1,fit:"crop",dpr:getDevicePixelRatio$2()});const Root$z=styled(Flex)(_templateObject21||(_templateObject21=_taggedTemplateLiteral(["\n  height: ",";\n"])),rem(PREVIEW_MEDIA_SIZE.default.height));const TitleSkeleton$2=styled(TextSkeleton).attrs({animated:true,radius:1})(_templateObject22||(_templateObject22=_taggedTemplateLiteral(["\n  max-width: ",";\n  width: 80%;\n"])),rem(160));const SubtitleSkeleton$2=styled(TextSkeleton).attrs({animated:true,radius:1,size:1})(_templateObject23||(_templateObject23=_taggedTemplateLiteral(["\n  max-width: ",";\n  width: 60%;\n"])),rem(120));function DefaultPreview(props){const{title,subtitle,media,status,isPlaceholder,children,styles}=props;const rootClassName=classNames(styles==null?void 0:styles.root,Boolean(subtitle)&&(styles==null?void 0:styles.hasSubtitle));const statusNode=status&&/* @__PURE__ */jsx(Box,{className:styles==null?void 0:styles.status,"data-testid":"default-preview__status",paddingLeft:3,paddingRight:1,children:renderPreviewNode(status,"default")});if(isPlaceholder){return/* @__PURE__ */jsxs(Root$z,{align:"center",className:styles==null?void 0:styles.placeholder,"data-testid":"default-preview",children:[media!==false&&/* @__PURE__ */jsx(Skeleton,{animated:true,marginRight:2,radius:2,style:PREVIEW_MEDIA_SIZE.default}),/* @__PURE__ */jsxs(Stack,{"data-testid":"default-preview__heading",flex:1,paddingLeft:media===false?1:2,paddingRight:status?0:1,space:2,children:[/* @__PURE__ */jsx(TitleSkeleton$2,{}),/* @__PURE__ */jsx(SubtitleSkeleton$2,{})]}),statusNode]});}return/* @__PURE__ */jsxs(Root$z,{align:"center",className:rootClassName,"data-testid":"default-preview",children:[media!==false&&media!==void 0&&/* @__PURE__ */jsx(Media,{dimensions:DEFAULT_MEDIA_DIMENSIONS$5,layout:"default",media,styles}),/* @__PURE__ */jsxs(Stack,{className:styles==null?void 0:styles.heading,"data-testid":"default-preview__header",flex:1,paddingLeft:media?2:1,paddingRight:status?0:1,space:2,children:[/* @__PURE__ */jsxs(Text$1,{className:styles==null?void 0:styles.title,style:{color:"inherit"},textOverflow:"ellipsis",children:[title&&renderPreviewNode(title,"default"),!title&&/* @__PURE__ */jsx("span",{style:{color:"var(--card-muted-fg-color)"},children:"Untitled"})]}),subtitle&&/* @__PURE__ */jsx(Text$1,{muted:true,size:1,textOverflow:"ellipsis",className:styles==null?void 0:styles.subtitle,children:renderPreviewNode(subtitle,"default")}),children&&/* @__PURE__ */jsx("div",{className:styles==null?void 0:styles.children,children})]}),statusNode]});}const RootFlex$2=styled(Flex).attrs({align:"center"})(_templateObject24||(_templateObject24=_taggedTemplateLiteral(["\n  height: ",";\n"])),rem(PREVIEW_MEDIA_SIZE.detail.height));const StatusBox=styled(Box)(_templateObject25||(_templateObject25=_taggedTemplateLiteral(["\n  white-space: nowrap;\n"])));const MediaSkeleton$1=styled(Skeleton).attrs({animated:true,radius:2})(_templateObject26||(_templateObject26=_taggedTemplateLiteral(["\n  width: ",";\n  height: ",";\n"])),rem(PREVIEW_MEDIA_SIZE.detail.width),rem(PREVIEW_MEDIA_SIZE.detail.height));const TitleSkeleton$1=styled(TextSkeleton).attrs({animated:true,radius:1})(_templateObject27||(_templateObject27=_taggedTemplateLiteral(["\n  max-width: ","; /* 80% of 200px */\n  width: 80%;\n"])),rem(160));const SubtitleSkeleton$1=styled(TextSkeleton).attrs({animated:true,radius:1,size:1})(_templateObject28||(_templateObject28=_taggedTemplateLiteral(["\n  max-width: ","; /* 60% of 200px */\n  width: 60%;\n"])),rem(120));const DescriptionSkeleton=styled(TextSkeleton).attrs({animated:true,radius:1,size:1})(_templateObject29||(_templateObject29=_taggedTemplateLiteral(["\n  max-width: ","; /* 90% of 200px */\n  width: 90%;\n"])),rem(180));const DescriptionText=styled(Text$1)(_ref58=>{let{theme}=_ref58;const{fonts}=theme.sanity;const textSize1=fonts.text.sizes[1];const maxLines=2;const maxHeight=textSize1.lineHeight*maxLines;return css(_templateObject30||(_templateObject30=_taggedTemplateLiteral(["\n    & > span {\n      max-height: ",";\n\n      /* Multi-line text overflow */\n      display: -webkit-box;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      -webkit-line-clamp: ",";\n      -webkit-box-orient: vertical;\n    }\n  "])),rem(maxHeight),maxLines);});const DEFAULT_MEDIA_DIMENSIONS$4=_objectSpread(_objectSpread({},PREVIEW_MEDIA_SIZE.detail),{},{fit:"crop",aspect:1,dpr:getDevicePixelRatio$2()});function DetailPreview(props){const{title,subtitle,description,mediaDimensions=DEFAULT_MEDIA_DIMENSIONS$4,media,status,children,isPlaceholder}=props;const statusNode=status&&/* @__PURE__ */jsx(StatusBox,{marginLeft:3,paddingRight:1,children:renderPreviewNode(status,"detail")});if(isPlaceholder){return/* @__PURE__ */jsxs(RootFlex$2,{"data-testid":"detail-preview",children:[media!==false&&/* @__PURE__ */jsx(MediaSkeleton$1,{"data-testid":"detail-preview__media"}),/* @__PURE__ */jsxs(Box,{flex:1,paddingLeft:media===false?1:2,children:[/* @__PURE__ */jsxs(Flex,{align:"center","data-testid":"detail-preview__header",children:[/* @__PURE__ */jsxs(Stack,{flex:1,space:2,children:[/* @__PURE__ */jsx(TitleSkeleton$1,{}),/* @__PURE__ */jsx(SubtitleSkeleton$1,{})]}),statusNode]}),description&&/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(DescriptionSkeleton,{})})]})]});}return/* @__PURE__ */jsxs(RootFlex$2,{"data-testid":"detail-preview",children:[media!==false&&/* @__PURE__ */jsx(Media,{dimensions:mediaDimensions,layout:"detail",media}),/* @__PURE__ */jsxs(Box,{flex:1,paddingLeft:media===false?1:2,children:[/* @__PURE__ */jsxs(Flex,{align:"center","data-testid":"detail-preview__header",children:[/* @__PURE__ */jsxs(Stack,{flex:1,space:2,children:[/* @__PURE__ */jsxs(Text$1,{textOverflow:"ellipsis",style:{color:"inherit"},children:[title&&renderPreviewNode(title,"detail"),!title&&/* @__PURE__ */jsx(Fragment,{children:"Untitled"})]}),subtitle&&/* @__PURE__ */jsx(Text$1,{muted:true,size:1,textOverflow:"ellipsis",children:renderPreviewNode(subtitle,"detail")})]}),statusNode]}),description&&/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(DescriptionText,{muted:true,size:1,children:renderPreviewNode(description,"detail")})})]}),children]});}const SIZE=43;const STROKE_WIDTH$2=3;const Root$y=styled.svg(_templateObject31||(_templateObject31=_taggedTemplateLiteral(["\n  width: ","px;\n  height: ","px;\n  transform: rotate(-90deg);\n"])),SIZE,SIZE);const BgCircle=styled.circle(_ref59=>{let{theme}=_ref59;const{color}=theme.sanity;return css(_templateObject32||(_templateObject32=_taggedTemplateLiteral(["\n    fill: none;\n    stroke: ",";\n    stroke-width: ","px;\n  "])),hues.gray[color.dark?900:100].hex,STROKE_WIDTH$2);});const ProgressCircle=styled.circle(_ref60=>{let{theme}=_ref60;const{color}=theme.sanity;return css(_templateObject33||(_templateObject33=_taggedTemplateLiteral(["\n    fill: none;\n    stroke: ",";\n    stroke-width: ","px;\n    transition: stroke-dashoffset 75ms;\n  "])),hues.blue[color.dark?400:500].hex,STROKE_WIDTH$2);});function CircularProgress(props){const{value:valueProp}=props;const value=Math.min(Math.max(valueProp,0),100);const radius=SIZE/2-STROKE_WIDTH$2/2;const circ=2*Math.PI*radius;const offset=(100-value)/100*circ;const viewBox="".concat(SIZE/2," ").concat(SIZE/2," ").concat(SIZE," ").concat(SIZE);return/* @__PURE__ */jsxs(Root$y,{viewBox,children:[/* @__PURE__ */jsx(BgCircle,{cx:SIZE,cy:SIZE,r:radius}),/* @__PURE__ */jsx(ProgressCircle,{cx:SIZE,cy:SIZE,r:radius,style:{strokeDasharray:circ,strokeDashoffset:"".concat(offset,"px")}})]});}const STROKE_WIDTH$1=0.5;const Root$x=styled(Card)(_templateObject34||(_templateObject34=_taggedTemplateLiteral(["\n  overflow: hidden;\n"])));const Bar=styled(Card)(_ref61=>{let{theme}=_ref61;const{color}=theme.sanity;return css(_templateObject35||(_templateObject35=_taggedTemplateLiteral(["\n    height: ","rem;\n    background: ",";\n    transition: transform 75ms;\n  "])),STROKE_WIDTH$1,hues.blue[color.dark?400:500].hex);});function LinearProgress(props){const{value}=props;return/* @__PURE__ */jsx(Root$x,{radius:5,children:/* @__PURE__ */jsx(Bar,{radius:5,style:{transform:"translate3d(".concat(value-100,"%, 0, 0)")}})});}const RootBox$2=styled(Box)(_templateObject36||(_templateObject36=_taggedTemplateLiteral(["\n  position: relative;\n"])));const MediaFlex=styled(Flex).attrs({align:"center",justify:"center"})(_templateObject37||(_templateObject37=_taggedTemplateLiteral(["\n  position: absolute;\n  left: 0;\n  top: 0;\n  right: 0;\n  bottom: 0;\n"])));const MediaSkeleton=styled(Skeleton).attrs({animated:true,radius:2})(_templateObject38||(_templateObject38=_taggedTemplateLiteral(["\n  width: 100%;\n  height: 100%;\n"])));const ProgressFlex=styled(Flex).attrs({align:"center",justify:"center"})(_templateObject39||(_templateObject39=_taggedTemplateLiteral(["\n  position: absolute;\n  left: 0;\n  top: 0;\n  right: 0;\n  bottom: 0;\n\n  &:before {\n    background-color: var(--card-bg-color);\n    opacity: 0.75;\n    content: '';\n    display: block;\n    position: absolute;\n    left: 0;\n    top: 0;\n    right: 0;\n    bottom: 0;\n  }\n\n  > svg {\n    position: relative;\n    z-index: 2;\n  }\n"])));const TooltipContentStack=styled(Stack).attrs({padding:2,space:2})(_templateObject40||(_templateObject40=_taggedTemplateLiteral(["\n  max-width: ",";\n"])),rem(200));const DEFAULT_MEDIA_DIMENSIONS$3=_objectSpread(_objectSpread({},PREVIEW_MEDIA_SIZE.media),{},{aspect:1,fit:"crop",dpr:getDevicePixelRatio$2()});function MediaPreview(props){const{media,mediaDimensions=DEFAULT_MEDIA_DIMENSIONS$3,children,isPlaceholder,progress=-1,subtitle,title,withBorder=true,withRadius=true}=props;const aspect=mediaDimensions.aspect||1;const STYLES_PADDER=useMemo(()=>({paddingBottom:"".concat(100/aspect,"%")}),[aspect]);const tooltipContent=useMemo(()=>{if(!title||!subtitle){return null;}return/* @__PURE__ */jsxs(TooltipContentStack,{children:[title&&/* @__PURE__ */jsx(Text$1,{align:"center",size:1,weight:"semibold",children:renderPreviewNode(title,"media")}),subtitle&&/* @__PURE__ */jsx(Text$1,{align:"center",muted:true,size:1,children:renderPreviewNode(subtitle,"media")})]});},[subtitle,title]);return/* @__PURE__ */jsxs(RootBox$2,{"data-testid":"media-preview",overflow:"hidden",flex:1,children:[/* @__PURE__ */jsx("div",{style:STYLES_PADDER}),/* @__PURE__ */jsx(Tooltip,{content:tooltipContent,disabled:!tooltipContent,placement:"top",portal:true,children:/* @__PURE__ */jsxs(MediaFlex,{children:[isPlaceholder?/* @__PURE__ */jsx(MediaSkeleton,{}):/* @__PURE__ */jsx(Media,{border:withBorder,dimensions:mediaDimensions,layout:"media",media,radius:withRadius?1:0,responsive:true}),typeof progress==="number"&&progress>-1&&/* @__PURE__ */jsx(ProgressFlex,{children:/* @__PURE__ */jsx(CircularProgress,{value:progress})})]})}),children]});}const HeaderFlex$2=styled(Flex).attrs({align:"center"})(_templateObject41||(_templateObject41=_taggedTemplateLiteral(["\n  box-shadow: 0 0 0 1px var(--card-border-color);\n  height: ",";\n  white-space: nowrap;\n  position: relative;\n  z-index: 1;\n"])),rem(PREVIEW_MEDIA_SIZE.block.height));const MediaCard=styled(Card)(_templateObject42||(_templateObject42=_taggedTemplateLiteral(["\n  position: relative;\n  padding-bottom: ","%;\n\n  & > span {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n  }\n"])),_ref62=>{let{$ratio}=_ref62;return $ratio;});const RootBox$1=styled(Box).attrs({overflow:"hidden"})(_templateObject43||(_templateObject43=_taggedTemplateLiteral(["\n  border-radius: ","px;\n"])),_ref63=>{let{theme}=_ref63;return theme.sanity.radius[1];});const DEFAULT_MEDIA_DIMENSIONS$2=_objectSpread(_objectSpread({},PREVIEW_MEDIA_SIZE.blockImage),{},{fit:"fillmax",dpr:getDevicePixelRatio$2()});const getRatio=dimensions=>{const{height,width}=dimensions;if(!height||!width){return 1;}return height/width*100;};function BlockImagePreview(props){const{actions,title,subtitle,description,fallbackTitle="Untitled",mediaDimensions=DEFAULT_MEDIA_DIMENSIONS$2,media,children,status}=props;return/* @__PURE__ */jsxs(RootBox$1,{children:[/* @__PURE__ */jsxs(Stack,{children:[/* @__PURE__ */jsxs(HeaderFlex$2,{paddingLeft:2,paddingRight:1,paddingY:1,children:[/* @__PURE__ */jsxs(Stack,{flex:1,space:2,children:[/* @__PURE__ */jsx(Text$1,{size:1,textOverflow:"ellipsis",weight:"semibold",children:title||fallbackTitle}),subtitle&&/* @__PURE__ */jsx(Text$1,{muted:true,size:1,textOverflow:"ellipsis",children:renderPreviewNode(subtitle,"block")})]}),/* @__PURE__ */jsxs(Flex,{gap:1,paddingLeft:1,children:[status&&/* @__PURE__ */jsx(Box,{paddingX:2,paddingY:3,children:renderPreviewNode(status,"block")}),actions]})]}),/* @__PURE__ */jsx(MediaCard,{$ratio:getRatio(mediaDimensions),__unstable_checkered:true,display:"flex",sizing:"border",tone:"inherit",children:/* @__PURE__ */jsx(Media,{border:false,dimensions:mediaDimensions,layout:"blockImage",media,radius:0,responsive:true})})]}),description&&/* @__PURE__ */jsx(Box,{paddingX:2,paddingY:3,children:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:renderPreviewNode(description,"block")})}),children&&/* @__PURE__ */jsx("div",{children})]});}const DEFAULT_MEDIA_DIMENSIONS$1=_objectSpread(_objectSpread({},PREVIEW_MEDIA_SIZE.block),{},{aspect:1,fit:"crop",dpr:getDevicePixelRatio$2()});const HeaderFlex$1=styled(Flex).attrs({align:"center"})(_templateObject44||(_templateObject44=_taggedTemplateLiteral(["\n  min-height: ",";\n"])),rem(PREVIEW_MEDIA_SIZE.block.height));function BlockPreview$1(props){const{actions,title,subtitle,description,mediaDimensions=DEFAULT_MEDIA_DIMENSIONS$1,media,status,children}=props;return/* @__PURE__ */jsxs(Stack,{"data-testid":"block-preview",space:1,children:[/* @__PURE__ */jsxs(HeaderFlex$1,{"data-testid":"block-preview__header",children:[media&&/* @__PURE__ */jsx(Media,{dimensions:mediaDimensions,layout:"block",media}),/* @__PURE__ */jsxs(Box,{flex:1,paddingLeft:media?2:1,children:[/* @__PURE__ */jsxs(Text$1,{size:1,textOverflow:"ellipsis",weight:"semibold",children:[title&&renderPreviewNode(title,"block"),!title&&/* @__PURE__ */jsx(Fragment,{children:"Untitled"})]}),subtitle&&/* @__PURE__ */jsx(Box,{marginTop:2,children:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,textOverflow:"ellipsis",children:renderPreviewNode(subtitle,"block")})}),description&&/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,textOverflow:"ellipsis",children:renderPreviewNode(description,"block")})})]}),/* @__PURE__ */jsxs(Flex,{gap:1,paddingLeft:1,children:[status&&/* @__PURE__ */jsx(Box,{paddingX:2,paddingY:3,children:renderPreviewNode(status,"block")}),actions]})]}),children&&/* @__PURE__ */jsx("div",{"data-testid":"block-preview__children",children})]});}const RootSpan=styled.span(_templateObject45||(_templateObject45=_taggedTemplateLiteral(["\n  display: inline-flex;\n  align-items: center;\n  vertical-align: top;\n  height: calc(1em - 1px);\n  max-width: 100%;\n"])));const MediaSpan=styled.span(_templateObject46||(_templateObject46=_taggedTemplateLiteral(["\n  position: relative;\n  display: inline-block;\n  width: calc(1em - 1px);\n  height: calc(1em - 1px);\n  min-width: calc(1em - 1px);\n\n  & img {\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    object-fit: cover;\n    border-radius: ",";\n  }\n\n  & img + span {\n    position: absolute;\n    left: 0;\n    top: 0;\n    right: 0;\n    bottom: 0;\n    box-shadow: inset 0 0 0 1px var(--card-fg-color);\n    opacity: 0.2;\n    border-radius: ",";\n  }\n\n  & svg {\n    display: block;\n    font-size: calc(14 / 16 * 1em);\n    margin: 1px 0;\n\n    &[data-sanity-icon] {\n      font-size: calc(18 / 16 * 1em);\n      margin: calc(1px + (2 / 18 * -1em)) 0;\n    }\n  }\n"])),_ref64=>{let{theme}=_ref64;return rem(theme.sanity.radius[1]);},_ref65=>{let{theme}=_ref65;return rem(theme.sanity.radius[1]);});const TextSpan=styled(Text$1).attrs({forwardedAs:"span"})(_ref66=>{let{theme}=_ref66;const textFont=theme.sanity.fonts.text;const textSize=textFont.sizes[1];return css(_templateObject47||(_templateObject47=_taggedTemplateLiteral(["\n    font-size: calc("," / 16 * 1em);\n    font-weight: ",";\n    box-sizing: border-box;\n    display: inline-block;\n    vertical-align: top;\n    line-height: ",";\n    padding-left: 0.5em;\n    padding-right: calc(0.5em - 2px);\n    min-width: 0;\n\n    & > span {\n      display: block;\n      white-space: nowrap;\n      text-overflow: ellipsis;\n      overflow: hidden;\n    }\n  "])),textSize.fontSize,textFont.weights.medium,textSize.lineHeight/textSize.fontSize);});const DEFAULT_MEDIA_DIMENSIONS=_objectSpread(_objectSpread({},PREVIEW_MEDIA_SIZE.inline),{},{fit:"crop",aspect:1,dpr:getDevicePixelRatio$2()});function InlinePreview(props){const{title,fallbackTitle="Untitled",media,mediaDimensions=DEFAULT_MEDIA_DIMENSIONS}=props;return/* @__PURE__ */jsxs(RootSpan,{"data-testid":"inline-preview",children:[media&&/* @__PURE__ */jsxs(MediaSpan,{"data-testid":"inline-preview-media",children:[renderPreviewMedia(media,"inline",mediaDimensions),/* @__PURE__ */jsx("span",{})]}),/* @__PURE__ */jsx(TextSpan,{"data-testid":"inline-preview-title",size:1,children:renderPreviewNode(title,"inline",fallbackTitle)})]});}const DEFAULT_MEDIA_DIMENSION=_objectSpread(_objectSpread({},PREVIEW_MEDIA_SIZE.default),{},{aspect:1,fit:"crop",dpr:getDevicePixelRatio$2()});const Root$w=styled(Box)(_templateObject48||(_templateObject48=_taggedTemplateLiteral(["\n  height: 100%;\n\n  a {\n    color: currentColor;\n    text-decoration: none;\n  }\n\n  svg[data-sanity-icon] {\n    margin: 0;\n  }\n"])));const HeaderFlex=styled(Flex).attrs({align:"center"})(_templateObject49||(_templateObject49=_taggedTemplateLiteral(["\n  height: ",";\n"])),rem(PREVIEW_MEDIA_SIZE.default.height));const TitleSkeleton=styled(TextSkeleton).attrs({animated:true,radius:1})(_templateObject50||(_templateObject50=_taggedTemplateLiteral(["\n  max-width: ",";\n  width: 80%;\n"])),rem(160));const SubtitleSkeleton=styled(TextSkeleton).attrs({animated:true,radius:1,size:1})(_templateObject51||(_templateObject51=_taggedTemplateLiteral(["\n  max-width: ",";\n  width: 60%;\n"])),rem(120));function TemplatePreview(props){const{description,isPlaceholder,media,mediaDimensions=DEFAULT_MEDIA_DIMENSION,subtitle,title="Untitled"}=props;if(isPlaceholder){return/* @__PURE__ */jsx(Root$w,{children:/* @__PURE__ */jsx(HeaderFlex,{children:/* @__PURE__ */jsxs(Stack,{flex:1,space:2,children:[/* @__PURE__ */jsx(TitleSkeleton,{}),/* @__PURE__ */jsx(SubtitleSkeleton,{})]})})});}return/* @__PURE__ */jsxs(Root$w,{children:[/* @__PURE__ */jsxs(HeaderFlex,{children:[/* @__PURE__ */jsxs(Stack,{flex:1,space:2,children:[/* @__PURE__ */jsxs(Text$1,{textOverflow:"ellipsis",children:[typeof title!=="function"&&title,typeof title==="function"&&title({layout:"default"})]}),subtitle&&/* @__PURE__ */jsx(Text$1,{muted:true,size:1,textOverflow:"ellipsis",children:typeof subtitle==="function"&&subtitle({layout:"default"})||subtitle})]}),media&&/* @__PURE__ */jsx(Flex,{align:"flex-start",paddingLeft:2,children:/* @__PURE__ */jsx(Media,{dimensions:mediaDimensions,layout:"default",media})})]}),description&&/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,style:{whiteSpace:"break-spaces"},children:description})})]});}function InsufficientPermissionsMessage(props){const{currentUser,title="Insufficient permissions",operationLabel="access this feature"}=props;const roles=(currentUser==null?void 0:currentUser.roles)||[];const plural=roles.length!==1;return/* @__PURE__ */jsxs(Box,{padding:2,children:[/* @__PURE__ */jsxs(Inline,{space:2,children:[/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(AccessDeniedIcon,{})}),/* @__PURE__ */jsx(Text$1,{weight:"semibold",children:title})]}),/* @__PURE__ */jsx(Inline,{marginTop:4,children:/* @__PURE__ */jsx(Text$1,{size:1,children:roles.length===0?/* @__PURE__ */jsxs(Fragment,{children:["You have no role that grants you permission to ",operationLabel]}):/* @__PURE__ */jsxs(Fragment,{children:["Your role",plural&&"s"," ",join$2(roles.map(r=>/* @__PURE__ */jsx("code",{children:r.title},r.name)),/* @__PURE__ */jsx(Fragment,{children:", "}))," ","do",plural||"es"," not have permissions to ",operationLabel]})})})]});}function join$2(array,sep){return array.reduce((result,item)=>result===null?[item]:[...result,sep,item],null);}const DocumentButton=styled(Button)(_templateObject52||(_templateObject52=_taggedTemplateLiteral(["\n  text-decoration: none;\n"])));const TooltipContentBox$1=styled(Box)(_templateObject53||(_templateObject53=_taggedTemplateLiteral(["\n  max-width: 300px;\n"])));const DisabledButtonWrapper=styled.div(_templateObject54||(_templateObject54=_taggedTemplateLiteral(["\n  & > * {\n    width: 100%;\n  }\n"])));function NewDocumentButton(){const[newDocumentButtonEl,setNewDocumentButtonEl]=useState(null);const[open,setOpen]=useState(false);const{scheme}=useColorScheme();const{__internal:{staticInitialValueTemplateItems},currentUser}=useSource();const[permissions,loading]=useTemplatePermissions({templateItems:staticInitialValueTemplateItems});const keyedPermissions=useMemo(()=>{if(!permissions)return{};return permissions.reduce((acc,next)=>{acc[next.id]=next;return acc;},{});},[permissions]);const hasNewDocumentOptions=staticInitialValueTemplateItems.length>0;const canCreateDocument=staticInitialValueTemplateItems.some(t=>{var _a;return(_a=keyedPermissions[t.id])==null?void 0:_a.granted;});const tooltipContent=useMemo(()=>{if(!hasNewDocumentOptions){return/* @__PURE__ */jsx(Text$1,{size:1,children:"No document types"});}if(canCreateDocument){return/* @__PURE__ */jsx(Text$1,{size:1,children:"New document..."});}return/* @__PURE__ */jsx(InsufficientPermissionsMessage,{currentUser,operationLabel:"create any document"});},[canCreateDocument,currentUser,hasNewDocumentOptions]);const handleOpen=useCallback(()=>{setOpen(true);},[]);const handleClose=useCallback(()=>{setOpen(false);newDocumentButtonEl==null?void 0:newDocumentButtonEl.focus();},[newDocumentButtonEl]);const handleLinkClick=useCallback(()=>{setOpen(false);},[]);return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(TooltipContentBox$1,{padding:2,children:tooltipContent}),disabled:loading,placement:"bottom",portal:true,scheme,children:/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Button,{"aria-label":"New document\u2026",disabled:!canCreateDocument||!hasNewDocumentOptions||loading,icon:ComposeIcon,mode:"bleed",onClick:handleOpen,ref:setNewDocumentButtonEl,style:{cursor:!canCreateDocument||!hasNewDocumentOptions?"not-allowed":void 0}})})}),open&&/* @__PURE__ */jsxs(Dialog,{header:"New document",id:"new-document-dialog",onClickOutside:handleClose,onClose:handleClose,scheme,width:2,children:[loading&&/* @__PURE__ */jsx(Flex,{padding:4,align:"center",justify:"center",children:/* @__PURE__ */jsx(Spinner,{muted:true,"aria-label":"Loading\u2026"})}),!loading&&/* @__PURE__ */jsx(Grid,{padding:4,columns:[1,1,2,3],gap:3,children:staticInitialValueTemplateItems.map(template=>{var _a;if((_a=keyedPermissions[template.id])==null?void 0:_a.granted){return/* @__PURE__ */jsx(DocumentButton,{forwardedAs:IntentLink,intent:"create",mode:"ghost",onClick:handleLinkClick,padding:2,params:{template:template.templateId,type:template.schemaType},children:/* @__PURE__ */jsx(DefaultPreview,{media:template.icon,subtitle:template.subtitle,title:template.title})},template.id);}return/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(TooltipContentBox$1,{padding:2,children:/* @__PURE__ */jsx(InsufficientPermissionsMessage,{currentUser,operationLabel:"create this document"})}),children:/* @__PURE__ */jsx(DisabledButtonWrapper,{children:/* @__PURE__ */jsx(DocumentButton,{mode:"ghost",padding:2,disabled:true,children:/* @__PURE__ */jsx(DefaultPreview,{media:template.icon,subtitle:template.subtitle,title:template.title})},template.id)})},template.id);})})]})]});}const dot=css(_templateObject55||(_templateObject55=_taggedTemplateLiteral(["\n  &:after {\n    content: '';\n    width: 6px;\n    height: 6px;\n    background-color: var(--status-button-dot-bg);\n    position: absolute;\n    top: 0;\n    right: 0;\n    border-radius: 50%;\n    transform: translate(-7px, 7px);\n    border: 1px solid var(--card-bg-color);\n  }\n"])));const StatusButton=styled(Button)(_ref67=>{let{theme,active,statusTone}=_ref67;const{color}=theme.sanity;const tone=color.selectable&&color.selectable[statusTone].selected.bg;const showDot=active&&tone;return css(_templateObject56||(_templateObject56=_taggedTemplateLiteral(["\n      position: relative;\n      --status-button-dot-bg: ",";\n\n      ","\n    "])),tone,showDot&&dot);});const AvatarCard=styled(Card)(_templateObject57||(_templateObject57=_taggedTemplateLiteral(["\n  background: transparent;\n  margin: calc((-35px + 11px) / 2);\n"])));const PresenceMenuItem=memo(function PresenceMenuItem2(_ref68){let{presence}=_ref68;const lastActiveLocation=orderBy(presence.locations||[],["lastActiveAt"],["desc"]).find(location=>location.documentId);const hasLink=Boolean(lastActiveLocation==null?void 0:lastActiveLocation.documentId);const LinkComponent=useMemo(()=>forwardRef(function LinkComponent2(linkProps,ref){if(!(lastActiveLocation==null?void 0:lastActiveLocation.path))return null;return/* @__PURE__ */jsx(IntentLink,_objectSpread(_objectSpread({},linkProps),{},{intent:"edit",params:{id:lastActiveLocation==null?void 0:lastActiveLocation.documentId,path:PathUtils.toString(lastActiveLocation==null?void 0:lastActiveLocation.path)},ref}));}),[lastActiveLocation]);return/* @__PURE__ */jsx(MenuItem,{as:lastActiveLocation?LinkComponent:"div","data-as":lastActiveLocation?"a":"div",padding:4,paddingRight:3,children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(AvatarCard,{children:/* @__PURE__ */jsx(UserAvatar,{size:1,user:presence.user},presence.user.id)}),/* @__PURE__ */jsx(Box,{flex:1,marginLeft:4,children:/* @__PURE__ */jsx(Text$1,{textOverflow:"ellipsis",children:presence.user.displayName})}),hasLink&&/* @__PURE__ */jsx(Box,{marginLeft:3,children:/* @__PURE__ */jsx(Text$1,{children:/* @__PURE__ */jsx(LinkIcon,{})})})]})});});const MAX_AVATARS=4;const AvatarStackCard$1=styled(Card)(_templateObject58||(_templateObject58=_taggedTemplateLiteral(["\n  background: transparent;\n"])));const StyledMenu=styled(Menu)(_templateObject59||(_templateObject59=_taggedTemplateLiteral(["\n  max-width: 350px;\n  min-width: 250px;\n"])));const FooterStack=styled(Stack)(_templateObject60||(_templateObject60=_taggedTemplateLiteral(["\n  position: sticky;\n  bottom: 0;\n"])));function PresenceMenu(props){const{collapse}=props;const presence=useGlobalPresence();const{projectId}=useWorkspace();const hasPresence=presence.length>0;const{scheme}=useColorScheme();const button=useMemo(()=>{if(collapse){return/* @__PURE__ */jsx(StatusButton,{icon:UsersIcon,mode:"bleed",active:hasPresence,statusTone:"positive"});}return/* @__PURE__ */jsx(Button,{mode:"bleed",padding:1,children:/* @__PURE__ */jsx(AvatarStackCard$1,{children:/* @__PURE__ */jsx(AvatarStack,{maxLength:MAX_AVATARS,children:presence.map(item=>/* @__PURE__ */jsx(UserAvatar,{user:item.user},item.user.id))})})});},[collapse,hasPresence,presence]);const popoverProps=useMemo(()=>({constrainSize:true,portal:true,scheme}),[scheme]);return/* @__PURE__ */jsx(MenuButton,{id:"global-presence-menu",button,menu:/* @__PURE__ */jsxs(StyledMenu,{padding:1,children:[hasPresence&&/* @__PURE__ */jsx(Stack,{space:2,children:presence.map(item=>/* @__PURE__ */jsx(PresenceMenuItem,{presence:item},item.user.id))}),!hasPresence&&/* @__PURE__ */jsx(Box,{paddingX:3,paddingY:4,children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(Text$1,{weight:"semibold",size:2,children:"No one else is here"}),/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:"Invite people to the project to see their online status."})]})}),/* @__PURE__ */jsxs(FooterStack,{space:1,children:[/* @__PURE__ */jsx(MenuDivider,{}),/* @__PURE__ */jsx(MenuItem,{as:"a",href:"https://sanity.io/manage/project/".concat(projectId),iconRight:CogIcon,paddingY:4,rel:"noopener noreferrer",target:"_blank",text:"Manage members"})]})]}),popover:popoverProps});}const Root$v=styled(Layer)(_templateObject61||(_templateObject61=_taggedTemplateLiteral(["\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  pointer-events: none;\n"])));const Backdrop=styled(Card)(_templateObject62||(_templateObject62=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: var(--card-shadow-penumbra-color);\n  transition: 200ms opacity ease-in-out;\n  pointer-events: none;\n  opacity: 0;\n\n  &[data-open='true'] {\n    opacity: 1;\n    pointer-events: all;\n  }\n"])));const InnerCard=styled(Card)(_templateObject63||(_templateObject63=_taggedTemplateLiteral(["\n  position: relative;\n  pointer-events: all;\n  flex-direction: column;\n  min-width: 200px;\n  max-width: 280px;\n  transition: 200ms transform ease-in-out;\n  transform: translate3d(calc(-100% - 1px), 0, 0);\n\n  &[data-open='true'] {\n    transform: translate3d(0, 0, 0);\n  }\n"])));const NavDrawer=memo(function NavDrawer2(props){const{activeToolName,isOpen,onClose,tools}=props;const[closeButtonElement,setCloseButtonElement]=useState(null);const[innerCardElement,setInnerCardElement]=useState(null);const tabIndex=isOpen?0:-1;const{currentUser,navbar,auth}=useWorkspace();const{ToolMenu:ToolMenu$1=ToolMenu}=(navbar==null?void 0:navbar.components)||{};useRovingFocus({rootElement:innerCardElement,navigation:["tab"]});useGlobalKeyDown(e=>{if(e.key==="Escape"&&isOpen){onClose();}});useEffect(()=>{if(isOpen){closeButtonElement==null?void 0:closeButtonElement.focus();}},[closeButtonElement,isOpen]);return/* @__PURE__ */jsxs(Root$v,{children:[/* @__PURE__ */jsx(Backdrop,{"data-open":isOpen,onClick:onClose}),/* @__PURE__ */jsxs(InnerCard,{display:"flex",height:"fill","data-open":isOpen,shadow:1,ref:setInnerCardElement,children:[/* @__PURE__ */jsx(Card,{borderBottom:true,children:/* @__PURE__ */jsxs(Stack,{space:3,padding:[3,3,4],children:[/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Flex,{flex:1,align:"center",paddingRight:2,children:/* @__PURE__ */jsxs(Flex,{flex:1,align:"center",children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(UserAvatar,{size:1,user:"me"})}),/* @__PURE__ */jsx(Box,{flex:1,marginLeft:2,title:(currentUser==null?void 0:currentUser.name)||(currentUser==null?void 0:currentUser.email),children:/* @__PURE__ */jsx(Text$1,{textOverflow:"ellipsis",children:(currentUser==null?void 0:currentUser.name)||(currentUser==null?void 0:currentUser.email)})})]})}),/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Button,{icon:CloseIcon,mode:"bleed",onClick:onClose,ref:setCloseButtonElement,tabIndex,title:"Close menu"})})]}),/* @__PURE__ */jsx(WorkspaceMenuButton,{text:"Select workspace",justify:"flex-start"})]})}),/* @__PURE__ */jsx(Box,{flex:"auto",overflow:"auto",padding:[3,3,4],children:/* @__PURE__ */jsx(ToolMenu$1,{activeToolName,closeDrawer:onClose,context:"drawer",isDrawerOpen:isOpen,tools})}),auth.logout&&/* @__PURE__ */jsx(Card,{flex:"none",padding:[3,3,4],borderTop:true,children:/* @__PURE__ */jsx(Stack,{children:/* @__PURE__ */jsx(Button,{iconRight:LeaveIcon,justify:"flex-start",mode:"bleed",onClick:auth.logout,tabIndex,text:"Sign out"})})})]})]});});const isDocumentType=type=>Boolean(type.type&&type.type.name==="document");const isSanityType=type=>type.name.startsWith("sanity.");const getSearchableTypes=schema=>schema.getTypeNames().map(typeName=>schema.get(typeName)).filter(isNonNullable$4).filter(schemaType=>isDocumentType(schemaType)).filter(type=>!isSanityType(type));const SPECIAL_CHARS=/([^!@#$%^&*(),\\/?";:{}|[\]+<>\s-])+/g;const STRIP_EDGE_CHARS=/(^[.]+)|([.]+$)/;function tokenize(string){return(string.match(SPECIAL_CHARS)||[]).map(token=>token.replace(STRIP_EDGE_CHARS,""));}const calculateScore=(searchTerms,value)=>{const uniqueValueTerms=uniq(compact(words(toLower(value))));const uniqueSearchTerms=uniq(searchTerms.map(toLower));const matches=intersection(uniqueSearchTerms,uniqueValueTerms);const all=union(uniqueValueTerms,uniqueSearchTerms);const fieldScore=matches.length/all.length;return fieldScore===1?[1,"Exact match"]:[fieldScore/2,"Matched ".concat(matches.length," of ").concat(all.length," terms: [").concat(matches.join(", "),"]")];};const stringify=value=>typeof value==="string"?value:JSON.stringify(value);function applyWeights(searchSpec,hits){let terms=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];const specByType=keyBy(searchSpec,spec=>spec.typeName);return hits.map((hit,index)=>{var _a;const typeSpec=specByType[hit._type];const stories=((_a=typeSpec.paths)==null?void 0:_a.map((pathSpec,idx)=>{const value=stringify(hit["w".concat(idx)]);if(!value){return{path:pathSpec.path,score:0,why:"No match"};}const[score,why]=calculateScore(terms,value);return{path:pathSpec.path,score:score*pathSpec.weight,why:"".concat(why," (*").concat(pathSpec.weight,")")};}))||[];const totalScore=stories.reduce((acc,rank)=>acc+rank.score,0);return{hit,resultIndex:hits.length-index,score:totalScore,stories};});}const combinePaths=flow([flatten$1,union,compact]);const toGroqParams=terms=>{const params={};return terms.reduce((acc,term,i)=>{acc["t".concat(i)]="".concat(term,"*");return acc;},params);};const pathWithMapper=_ref69=>{let{mapWith,path}=_ref69;return mapWith?"".concat(mapWith,"(").concat(path,")"):path;};function createWeightedSearch(types,client){let options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};if(!types){throw new Error("missing types");}const{filter,params,tag}=options;const searchSpec=types.map(type=>{var _a;return{typeName:type.name,paths:(_a=type.__experimental_search)==null?void 0:_a.map(config=>({weight:config.weight,path:joinPath(config.path),mapWith:config.mapWith}))};});const combinedSearchPaths=combinePaths(searchSpec.map(configForType=>{var _a;return(_a=configForType.paths)==null?void 0:_a.map(opt=>pathWithMapper(opt));}));const selections=searchSpec.map(spec=>{var _a;const constraint="_type == \"".concat(spec.typeName,"\" => ");const selection="{ ".concat((_a=spec.paths)==null?void 0:_a.map((cfg,i)=>"\"w".concat(i,"\": ").concat(pathWithMapper(cfg)))," }");return"".concat(constraint).concat(selection);});return function search(queryString){let searchOpts=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var _a;const terms=uniq(compact(tokenize(toLower(queryString))));const constraints=terms.map((term,i)=>combinedSearchPaths.map(joinedPath=>"".concat(joinedPath," match $t").concat(i))).filter(constraint=>constraint.length>0);const filters=["_type in $__types",searchOpts.includeDrafts===false&&"!(_id in path('drafts.**'))",...constraints.map(constraint=>"(".concat(constraint.join("||"),")")),filter?"(".concat(filter,")"):""].filter(Boolean);const selection=selections.length>0?"...select(".concat(selections.join(",\n"),")"):"";const query="*[".concat(filters.join("&&"),"][0...$__limit]{_type, _id, ").concat(selection,"}");return client.observable.fetch(query,_objectSpread(_objectSpread({},toGroqParams(terms)),{},{__types:searchSpec.map(spec=>spec.typeName),__limit:(_a=searchOpts.limit)!=null?_a:1e3},params||{}),{tag}).pipe(options.unique?map(removeDupes):tap(),map(hits=>applyWeights(searchSpec,hits,terms)),map(hits=>sortBy(hits,hit=>-hit.score)));};}function createSearch(client,schema){const searchClient=client.withConfig({apiVersion:"2021-03-25"});return createWeightedSearch(getSearchableTypes(schema),searchClient,{unique:true,tag:"search.global"});}const DEFAULT_STUDIO_CLIENT_OPTIONS={apiVersion:"2022-09-09"};const EMPTY_STATE$2={loading:false,error:null,value:[]};const LOADING_STATE$1={loading:true,error:null,value:[]};const DEBOUNCE_VALUE=400;function useDocumentSearchResults(props){const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const schema=useSchema();const{includeDrafts=false,limit=1e3,query:queryProp}=props;const[state,setState]=useState(EMPTY_STATE$2);const paramsSubject=useMemo(()=>new Subject(),[]);const search=useMemo(()=>createSearch(client,schema),[client,schema]);const state$=useMemo(()=>paramsSubject.asObservable().pipe(share(),distinctUntilChanged(),filter(isNonNullable$4),switchMap(_ref70=>{let{query,options}=_ref70;return query?concat(of(LOADING_STATE$1),timer(DEBOUNCE_VALUE).pipe(mergeMapTo(EMPTY$1)),search(query,options).pipe(map(results=>({loading:false,error:null,value:results})),catchError(error=>{return of({loading:false,error,value:[]});}))):of(EMPTY_STATE$2);})),[paramsSubject,search]);useEffect(()=>{paramsSubject.next({options:{includeDrafts,limit},query:queryProp});},[includeDrafts,limit,queryProp,paramsSubject]);useEffect(()=>{const sub=state$.subscribe(setState);return()=>{sub.unsubscribe();};},[state$]);return state;}const StyledCard$2=styled(Card)(_templateObject64||(_templateObject64=_taggedTemplateLiteral(["\n  flex-direction: column;\n"])));const SearchFullscreenContent=forwardRef(function SearchFullscreenContent2(props,ref){const{scheme}=useColorScheme();return/* @__PURE__ */jsx(Portal,{children:/* @__PURE__ */jsx(StyledCard$2,_objectSpread({display:"flex",flex:1,ref,scheme},props))});});const StyledCard$1=styled(Card)(()=>{return css(_templateObject65||(_templateObject65=_taggedTemplateLiteral(["\n    /* TextWithTone uses its own logic to set color, and we therefore need */\n    /* to override this logic in order to set the correct color in different states */\n    &[data-selected],\n    &[data-pressed],\n    &:active {\n      [data-ui='TextWithTone'] {\n        color: inherit;\n      }\n    }\n  "])));});const PreviewCardContext=createContext({selected:false});function usePreviewCard(){const context=useContext(PreviewCardContext);if(!context){throw new Error("PreviewCard: missing context value");}return context;}const PreviewCard$2=forwardRef(function PreviewCard2(props,ref){const{children,selected,as}=props,rest=_objectWithoutProperties(props,_excluded16);return/* @__PURE__ */jsx(StyledCard$1,_objectSpread(_objectSpread({"data-ui":"PreviewCard"},rest),{},{forwardedAs:as,selected,ref,children:/* @__PURE__ */jsx(PreviewCardContext.Provider,{value:{selected},children})}));});const PRESENCE_MENU_POPOVER_PROPS={portal:true};const AvatarStackCard=styled(Card)(_ref71=>{let{theme,$selected}=_ref71;var _a;const{color}=theme.sanity;return css(_templateObject66||(_templateObject66=_taggedTemplateLiteral(["\n    --card-bg-color: inherit;\n    --card-fg-color: inherit;\n    --card-hairline-hard-color: ",";\n  "])),$selected?(_a=color.selectable)==null?void 0:_a.default.pressed.border:void 0);});const TooltipContentBox=styled(Box)(_templateObject67||(_templateObject67=_taggedTemplateLiteral(["\n  max-width: 150px;\n"])));const getTooltipText=presence=>{if(presence.length===1){return"".concat(presence[0].user.displayName," is editing this document");}if(presence.length>1){return"".concat(presence.length," people are editing this document right now");}return void 0;};function DocumentPreviewPresence(props){const{presence}=props;const{color}=useTheme().sanity;const invertedScheme=color.dark?"light":"dark";const{selected}=usePreviewCard();const uniqueUsers=useMemo(()=>Array.from(new Set(presence.map(a=>a.user.id))).map(id=>{return presence.find(a=>a.user.id===id);}).filter(isNonNullable$4),[presence]);const tooltipContent=useMemo(()=>{return/* @__PURE__ */jsx(TooltipContentBox,{padding:2,children:/* @__PURE__ */jsx(Text$1,{align:"center",size:1,children:getTooltipText(uniqueUsers)})});},[uniqueUsers]);return/* @__PURE__ */jsx(Tooltip,_objectSpread(_objectSpread({content:tooltipContent},PRESENCE_MENU_POPOVER_PROPS),{},{children:/* @__PURE__ */jsx(AvatarStackCard,{scheme:selected?invertedScheme:void 0,$selected:selected,children:/* @__PURE__ */jsx(AvatarStack,{maxLength:2,children:uniqueUsers.map(item=>/* @__PURE__ */jsx(UserAvatar,{user:item.user},item.user.id))})})}));}const MAX_AVATARS_DOCK=3;const DEFAULT_MAX_AVATARS_FIELDS=3;const AVATAR_DISTANCE=-4;const AVATAR_SIZE=23;const AVATAR_ARROW_HEIGHT=4;const INTERSECTION_THRESHOLDS=[0,0.25,0.75,1];const INTERSECTION_ELEMENT_PADDING=23;const SNAP_TO_DOCK_DISTANCE_TOP=8;const SNAP_TO_DOCK_DISTANCE_BOTTOM=8;const SLIDE_RIGHT_THRESHOLD_TOP=20;const SLIDE_RIGHT_THRESHOLD_BOTTOM=20;const DEBUG$1=false;const splitRight=(array,max)=>{const indexFromMax=array.length>max?max-1:max;const idx=Math.max(0,array.length-indexFromMax);return[array.slice(0,idx),array.slice(idx)];};const FlexWrapper$1=styled(Flex)(_templateObject68||(_templateObject68=_taggedTemplateLiteral(["\n  & > div:first-child {\n    flex: 1;\n    min-width: 0;\n  }\n"])));const InnerBox=styled(Flex)(_templateObject69||(_templateObject69=_taggedTemplateLiteral(["\n  height: 23px;\n  min-width: 23px;\n  vertical-align: top;\n"])));const FormFieldPresenceContext=React.createContext([]);function PresenceTooltip(props){const{children,items}=props;const content=useMemo(()=>/* @__PURE__ */jsx(Stack,{padding:1,children:items.map(item=>/* @__PURE__ */jsxs(Flex,{align:"center",gap:2,padding:1,children:[/* @__PURE__ */jsx("div",{children:/* @__PURE__ */jsx(UserAvatar,{user:item.user,status:"online"})}),/* @__PURE__ */jsx(Text$1,{size:1,children:item.user.displayName})]},item.user.id))}),[items]);return/* @__PURE__ */jsx(Tooltip,{content,placement:"top",portal:"documentScrollElement",children});}function isFunc(value){return typeof value==="function";}function read(value){return isFunc(value)?value():value;}const noop$4=()=>void 0;function createUseReporter(Context){return function useReporter(id,value){let isEqual=arguments.length>2&&arguments[2]!==undefined?arguments[2]:Object.is;const{add,update,remove}=React.useContext(Context);const previous=React.useRef();React.useLayoutEffect(()=>{if(id===null){return noop$4;}const current=read(value);add(id,current);previous.current=current;return()=>{remove(id);};},[add,id,remove,value]);React.useLayoutEffect(()=>{const current=read(value);if(typeof previous.current!=="undefined"&&!isEqual(previous.current,current)&&id!==null){update(id,current);}previous.current=current;});};}function createStore(){const reportedValues=/* @__PURE__ */new Map();const{publish,subscribe}=createPubSub();const debouncedPublish=debounce(publish,10,{trailing:true});const read=()=>Array.from(reportedValues.entries());function add(id,value){if(reportedValues.has(id));reportedValues.set(id,value);debouncedPublish(read());}function update(id,value){if(!reportedValues.has(id));reportedValues.set(id,value);debouncedPublish(read());}function remove(id){if(!reportedValues.has(id));reportedValues.delete(id);debouncedPublish(read());}return{add,remove,update,read,subscribe};}let didWarn=false;const useReporterGuard=id2=>{if(!didWarn){console.warn(new Error("No context provided for reporter. Make sure that the component calling \"useReporter(".concat(id2,", ...)\", is wrapped in a <Tracker> element")));}didWarn=true;};function useReportedValueGuard(){if(!didWarn){console.warn(new Error('No context provided for reporter. Make sure that the component calling "useReportedValues()", is wrapped inside a <Tracker> element'));}didWarn=true;return[];}const useSubscribeGuard=()=>{if(!didWarn){console.warn(new Error('No context provided for reporter. Make sure that the component calling "useReportedValues()", is wrapped inside a <Tracker> element'));}didWarn=true;return()=>{};};const DEFAULT_CONTEXT={add:useReporterGuard,update:useReporterGuard,remove:useReporterGuard,subscribe:useSubscribeGuard,read:useReportedValueGuard};let id$1=0;const getNextId=()=>++id$1;function createScope(){const Context=React.createContext(DEFAULT_CONTEXT);function useReportedValues(){const context=React.useContext(Context);const[values,setValues]=React.useState(context.read());React.useLayoutEffect(()=>{setValues(context.read());return context.subscribe(setValues);},[context]);return values;}function Tracker(props){const store=React.useMemo(()=>createStore(),[]);return/* @__PURE__ */jsx(Context.Provider,{value:store,children:props.children});}const useReporter=createUseReporter(Context);return{Tracker,useReportedValues,useReporter,useAutoIdReporter:function(value){let isEqual=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Object.is;return useReporter("element-".concat(React.useRef(getNextId()).current),value,isEqual);}};}const{Tracker:Tracker$1,useReporter:useReporter$1,useReportedValues:useReportedValues$1}=createScope();const FieldPresence=FieldPresenceWithOverlay;function FieldPresenceWithOverlay(props){const contextPresence=useContext(FormFieldPresenceContext);const{presence=contextPresence,maxAvatars=DEFAULT_MAX_AVATARS_FIELDS}=props;const ref=React.useRef(null);useReporter$1(useId()||"",()=>({presence,element:ref.current,maxAvatars}));const minWidth=-AVATAR_DISTANCE+(AVATAR_SIZE+AVATAR_DISTANCE)*props.maxAvatars;return/* @__PURE__ */jsx(FlexWrapper$1,{justify:"flex-end",ref,style:{minWidth,minHeight:AVATAR_SIZE}});}function FieldPresenceWithoutOverlay(props){const contextPresence=useContext(FormFieldPresenceContext);const{presence=contextPresence,maxAvatars=DEFAULT_MAX_AVATARS_FIELDS}=props;if(!presence.length){return null;}return/* @__PURE__ */jsx(FieldPresenceInner,{presence,maxAvatars});}function calcAvatarStackWidth(len){return-AVATAR_DISTANCE+(AVATAR_SIZE+AVATAR_DISTANCE)*len;}const FieldPresenceInner=memo(function FieldPresenceInner2(_ref72){let{presence,position="inside",animateArrowFrom="inside",maxAvatars=DEFAULT_MAX_AVATARS_FIELDS,stack=true}=_ref72;const uniquePresence=uniqBy(presence||[],item=>item.user.id);const sorted=sortBy(uniquePresence,_presence=>_presence.lastActiveAt);const[hidden,visible]=stack?splitRight(sorted,maxAvatars):[[],sorted];const avatars=[...visible.reverse().map(_visible=>({key:_visible.user.id,element:/* @__PURE__ */jsx(UserAvatar,{animateArrowFrom,position,status:"online",user:_visible.user})})),hidden.length>=2?{key:"counter",element:/* @__PURE__ */jsx(AvatarCounter,{count:hidden.length})}:null].filter(Boolean);const maxWidth=calcAvatarStackWidth(maxAvatars);const currWidth=Math.min(calcAvatarStackWidth(uniquePresence.length),maxWidth);return/* @__PURE__ */jsxs(FlexWrapper$1,{justify:"flex-end",style:{width:maxWidth},children:[/* @__PURE__ */jsx("div",{}),/* @__PURE__ */jsx(PresenceTooltip,{items:uniquePresence,children:/* @__PURE__ */jsx(InnerBox,{direction:"row-reverse",style:{width:currWidth},children:avatars.map((av,i)=>av&&/* @__PURE__ */jsx("div",{style:{position:"absolute",transform:"translate3d(".concat(-i*(AVATAR_SIZE+AVATAR_DISTANCE),"px, 0px, 0px)"),transitionProperty:"transform",transitionDuration:"200ms",transitionTimingFunction:"cubic-bezier(0.85, 0, 0.15, 1)",zIndex:100-i},children:av.element},av.key))})})]});});const createIntersectionObserver=options=>{const entries$=new Subject();const intersectionObserver=new IntersectionObserver(entries=>{entries.forEach(entry=>{entries$.next(entry);});},options);return{observe:element=>{return new Observable(subscriber=>{const subscription=entries$.pipe(filter(entry=>entry.target===element)).subscribe(subscriber);intersectionObserver.observe(element);return()=>{subscription.unsubscribe();intersectionObserver.unobserve(element);};});}};};const WithIntersection=props=>{const{onIntersection,io,id}=props,rest=_objectWithoutProperties(props,_excluded17);const element=React.useRef(null);React.useEffect(()=>{const el=element.current;if(!el)return void 0;const subscription=io.observe(el).pipe(tap(entry=>onIntersection(id,entry))).subscribe();return()=>subscription.unsubscribe();},[io,id,onIntersection]);return/* @__PURE__ */jsx("div",_objectSpread({ref:element},rest));};const RootWrapper=styled.div(_templateObject70||(_templateObject70=_taggedTemplateLiteral(["\n  position: relative;\n"])));const OverlayWrapper=styled.div(_templateObject71||(_templateObject71=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  pointer-events: none;\n  z-index: 13;\n"])));const RegionWrapper=css(_templateObject72||(_templateObject72=_taggedTemplateLiteral(["\n  overflow: hidden;\n  pointer-events: none;\n  position: absolute;\n"])));const TopRegionWrapper=styled(WithIntersection)(_ref73=>{let{$debug,margins}=_ref73;return css(_templateObject73||(_templateObject73=_taggedTemplateLiteral(["\n    ","\n\n    z-index: 100;\n    position: sticky;\n    height: 1px;\n    top: ",";\n    background-color: ",";\n  "])),RegionWrapper,margins?"".concat(margins[0]-1,"px"):void 0,$debug?"red":"none");});const MiddleRegionWrapper=styled(WithIntersection)(_ref74=>{let{$debug}=_ref74;return css(_templateObject74||(_templateObject74=_taggedTemplateLiteral(["\n    ","\n\n    visibility: none;\n\n    ","\n  "])),RegionWrapper,$debug&&css(_templateObject75||(_templateObject75=_taggedTemplateLiteral(["\n      background: rgba(255, 0, 0, 0.25);\n      outline: 1px solid #00b;\n      visibility: visible;\n    "]))));});const BottomRegionWrapper=styled(WithIntersection)(_ref75=>{let{$debug}=_ref75;return css(_templateObject76||(_templateObject76=_taggedTemplateLiteral(["\n    ","\n\n    position: sticky;\n    bottom: -1px;\n    height: 1px;\n    background-color: ",";\n  "])),RegionWrapper,$debug?"blue":"transparent");});const toPx=num=>"".concat(num,"px");const negate=num=>0-num;const RegionsWithIntersections=forwardRef(function RegionsWithIntersections2(props,ref){const{regions,render,children,margins:marginsProp}=props;const overlayRef=useRef(null);const margins=useMemo(()=>marginsProp,[JSON.stringify(marginsProp)]);const io=useMemo(()=>createIntersectionObserver({rootMargin:margins.map(negate).map(toPx).join(" "),threshold:INTERSECTION_THRESHOLDS}),[margins]);const[intersections,setIntersections]=useState({});const onIntersection=useCallback((id,entry)=>{setIntersections(current=>_objectSpread(_objectSpread({},current),{},{[id]:entry}));},[]);const top=intersections["::top"];const bottom=intersections["::bottom"];const regionsWithIntersectionDetails=useMemo(()=>top&&bottom?regions.filter(region=>{var _a;return((_a=region.presence)==null?void 0:_a.length)>0;}).map(region=>{const intersection=intersections[region.id];if(!intersection){return null;}const{bottom:boundsBottom,top:boundsTop}=intersection.boundingClientRect;const aboveTop=intersection.boundingClientRect.top<top.boundingClientRect.bottom;const belowBottom=intersection.boundingClientRect.top<bottom.boundingClientRect.top;const distanceTop=intersection.isIntersecting?boundsTop-(intersection.intersectionRect.top-INTERSECTION_ELEMENT_PADDING):aboveTop?-top.boundingClientRect.bottom:bottom.boundingClientRect.top;const distanceBottom=intersection.isIntersecting?-(boundsBottom-(intersection.intersectionRect.bottom+INTERSECTION_ELEMENT_PADDING)):belowBottom?bottom.boundingClientRect.top:-top.boundingClientRect.bottom;const position=distanceTop<=SNAP_TO_DOCK_DISTANCE_TOP?"top":distanceBottom<=SNAP_TO_DOCK_DISTANCE_BOTTOM?"bottom":"inside";return{distanceTop,distanceBottom,region,position};}).filter(Boolean):[],[bottom,intersections,regions,top]);return/* @__PURE__ */jsxs(RootWrapper,{ref,children:[/* @__PURE__ */jsx(TopRegionWrapper,{$debug:DEBUG$1,io,id:"::top",onIntersection,margins}),/* @__PURE__ */jsx("div",{children}),/* @__PURE__ */jsx(OverlayWrapper,{ref:overlayRef,children:overlayRef.current&&render(regionsWithIntersectionDetails,overlayRef.current.offsetWidth)}),regions.map(region=>{const forceWidth=region.rect.width===0;return/* @__PURE__ */jsx(MiddleRegionWrapper,{$debug:DEBUG$1,io,onIntersection,id:region.id,style:{width:forceWidth?1:region.rect.width,left:region.rect.left-(forceWidth?1:0),top:region.rect.top-INTERSECTION_ELEMENT_PADDING,height:region.rect.height+INTERSECTION_ELEMENT_PADDING*2}},region.id);}),/* @__PURE__ */jsx(BottomRegionWrapper,{$debug:DEBUG$1,id:"::bottom",io,onIntersection})]});});const ITEM_TRANSITION={transitionProperty:"transform",transitionDuration:"200ms",transitionTimingFunction:"cubic-bezier(0.85, 0, 0.15, 1)"};const bottom=rect=>rect.top+rect.height;function withSpacerHeight(regionsWithIntersectionDetails){return regionsWithIntersectionDetails.map((withIntersection,idx,_regionsWithIntersectionDetails)=>{var _a;const prevRect=(_a=_regionsWithIntersectionDetails[idx-1])==null?void 0:_a.region.rect;const prevBottom=prevRect?bottom(prevRect):0;return _objectSpread(_objectSpread({},withIntersection),{},{spacerHeight:withIntersection.region.rect.top-prevBottom});});}const orderByTop=regionsWithIntersectionDetails=>orderBy(regionsWithIntersectionDetails,withIntersection=>withIntersection.region.rect.top);const plus=(a,b)=>a+b;const sum=array=>array.reduce(plus,0);function group(regionsWithIntersectionDetails){const regionsWithSpacerHeight=withSpacerHeight(orderByTop(regionsWithIntersectionDetails));const grouped=_objectSpread({top:[],inside:[],bottom:[]},groupBy(regionsWithSpacerHeight,_withSpacerHeight=>_withSpacerHeight.position));return{top:orderByTop(grouped.top).map((withIntersection,i,grp)=>_objectSpread(_objectSpread({},withIntersection),{},{indent:grp.slice(i+1).reduce((w,_withIntersection)=>w+_withIntersection.region.rect.width,0)})),inside:orderByTop(grouped.inside).map(withIntersection=>_objectSpread(_objectSpread({},withIntersection),{},{indent:0})),bottom:orderByTop(grouped.bottom).map((withIntersection,i,grp)=>_objectSpread(_objectSpread({},withIntersection),{},{indent:grp.slice(0,i).reduce((w,_withIntersection)=>w+_withIntersection.region.rect.width,0)}))};}const Spacer=_ref76=>{let{height}=_ref76,rest=_objectWithoutProperties(_ref76,_excluded18);return/* @__PURE__ */jsx("div",{style:_objectSpread({height:Math.max(0,height)},rest==null?void 0:rest.style)});};const DEFAULT_MARGINS$1=[0,0,0,0];const getOffsetsTo$1=(source,target)=>{let el=source;let top=-el.scrollTop;let left=0;while(el&&el!==target){top+=el.offsetTop-el.scrollTop;left+=el.offsetLeft;el=el.offsetParent instanceof HTMLElement?el.offsetParent:null;}return{top,left};};function getRelativeRect(element,parent){return _objectSpread(_objectSpread({},getOffsetsTo$1(element,parent)),{},{width:element.offsetWidth,height:element.offsetHeight});}function regionsWithComputedRects(regions,parent){return regions.map(_ref77=>{let[id,region]=_ref77;return _objectSpread(_objectSpread({},region),{},{id,rect:getRelativeRect(region.element,parent)});});}function StickyOverlay(props){const{children,margins=DEFAULT_MARGINS$1}=props;const reportedValues=useReportedValues$1();const ref=React.useRef(null);const regions=React.useMemo(()=>ref.current?regionsWithComputedRects(reportedValues,ref.current):EMPTY_ARRAY$7,[reportedValues]);const renderCallback=React.useCallback((regionsWithIntersectionDetails,containerWidth)=>{const grouped=group(regionsWithIntersectionDetails.filter(item=>item.region.presence.length>0));const topSpacing=sum(grouped.top.map(n=>n.region.rect.height+n.spacerHeight));const bottomSpacing=sum([...grouped.inside,...grouped.bottom].map(n=>n.region.rect.height+n.spacerHeight));const counts=grouped.inside.reduce((_counts,withIntersection)=>{const{distanceTop,distanceBottom}=withIntersection;const nearTop=distanceTop<=SLIDE_RIGHT_THRESHOLD_TOP;const nearBottom=distanceBottom<=SLIDE_RIGHT_THRESHOLD_BOTTOM;return{nearTop:_counts.nearTop+(nearTop?withIntersection.region.presence.length:0),nearBottom:_counts.nearBottom+(nearBottom?withIntersection.region.presence.length:0)};},{nearTop:0,nearBottom:0});return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(PresenceDock,{closeCount:counts.nearTop,margins,position:"top",regionsWithIntersectionDetails:grouped.top}),/* @__PURE__ */jsx(Spacer,{height:topSpacing}),/* @__PURE__ */jsx(PresenceInside,{containerWidth,regionsWithIntersectionDetails:grouped.inside}),/* @__PURE__ */jsx(Spacer,{height:bottomSpacing}),/* @__PURE__ */jsx(PresenceDock,{closeCount:counts.nearBottom,margins,position:"bottom",regionsWithIntersectionDetails:grouped.bottom})]});},[margins]);return/* @__PURE__ */jsx(RegionsWithIntersections,{ref,margins,regions,render:renderCallback,children});}const EMPTY_ARRAY$7=[];const PresenceDock=memo(function PresenceDock2(props){const{closeCount,margins,position,regionsWithIntersectionDetails}=props;const dir=position==="top"?1:-1;const allPresenceItems=useMemo(()=>{if(!regionsWithIntersectionDetails.length){return EMPTY_ARRAY$7;}return flatten$1(sortBy(regionsWithIntersectionDetails,r=>r.region.rect.top*dir).map(withIntersection=>withIntersection.region.presence||EMPTY_ARRAY$7));},[dir,regionsWithIntersectionDetails]);const[topMargin,rightMargin,bottomMargin,leftMargin]=margins;const leftOffset=(leftMargin||0)+(allPresenceItems.length>0?-closeCount*(AVATAR_SIZE+AVATAR_DISTANCE):0)-rightMargin;const margin=position==="top"?topMargin:bottomMargin;const style=useMemo(()=>_objectSpread(_objectSpread({zIndex:2,position:"sticky",display:"flex",flexDirection:"column",alignItems:"flex-end"},ITEM_TRANSITION),{},{transform:"translate3d(".concat(leftOffset,"px, 0px, 0px)"),top:AVATAR_ARROW_HEIGHT+1+margin,bottom:AVATAR_ARROW_HEIGHT+1+margin}),[leftOffset,margin]);return/* @__PURE__ */jsx("div",{"data-dock":position,style,children:/* @__PURE__ */jsx(FieldPresenceInner,{position,maxAvatars:MAX_AVATARS_DOCK,presence:allPresenceItems})},"sticky-".concat(position));});function PresenceInside(props){const{regionsWithIntersectionDetails,containerWidth}=props;return/* @__PURE__ */jsx(Fragment,{children:regionsWithIntersectionDetails.map(withIntersection=>{const originalLeft=withIntersection.region.rect.left;const{distanceTop,distanceBottom}=withIntersection;const nearTop=distanceTop<=SLIDE_RIGHT_THRESHOLD_TOP;const nearBottom=distanceBottom<=SLIDE_RIGHT_THRESHOLD_BOTTOM;const diffRight=containerWidth-originalLeft-withIntersection.region.rect.width;const{presence,maxAvatars}=withIntersection.region;return/* @__PURE__ */jsx(React.Fragment,{children:/* @__PURE__ */jsx("div",{style:_objectSpread(_objectSpread({zIndex:2,position:"absolute",pointerEvents:"all"},ITEM_TRANSITION),{},{left:originalLeft,transform:"translate3d(".concat(nearTop||nearBottom?diffRight:0,"px, 0px, 0px)"),height:withIntersection.region.rect.height,top:withIntersection.region.rect.top}),children:/* @__PURE__ */jsx(DebugValue,{value:()=>"\u2912".concat(distanceTop," | ").concat(distanceBottom,"\u2913"),children:/* @__PURE__ */jsx(FieldPresenceInner,{stack:!nearTop&&!nearBottom,position:nearTop?"top":nearBottom?"bottom":"inside",maxAvatars,presence})})})},withIntersection.region.id);})});}const PassThrough=props=>props.children;const DebugValue=PassThrough;const DEFAULT_MARGINS=[0,0,0,0];function OverlayEnabled(_ref78){let{children,margins}=_ref78;return/* @__PURE__ */jsx(Tracker$1,{children:/* @__PURE__ */jsx(StickyOverlay,{margins:margins||DEFAULT_MARGINS,children})});}function OverlayDisabled(props){return props.children;}const PresenceOverlay=OverlayEnabled;function _extractUploadState(value){if(isRecord$2(value)){const{_upload}=value,restValue=_objectWithoutProperties(value,_excluded19);return{_upload:_resolveUploadValue(_upload),value:restValue};}return{_upload:void 0,value};}function _resolveUploadValue(value){if(!isRecord$2(value))return void 0;const progress=typeof value.progress==="number"?value.progress:void 0;const initiated=isString(value.initiated)?value.initiated:void 0;const updated=isString(value.updated)?value.updated:void 0;const fileName=isRecord$2(value.file)&&isString(value.file.name)?value.file.name:void 0;const fileType=isRecord$2(value.file)&&isString(value.file.type)?value.file.type:void 0;const previewImage=isString(value.previewImage)?value.previewImage:void 0;if(progress&&initiated&&updated&&fileName&&fileType){return{progress,initiated,updated,file:{name:fileName,type:fileType},previewImage};}return void 0;}const _previewComponents={default:DefaultPreview,media:MediaPreview,detail:DetailPreview,inline:InlinePreview,block:BlockPreview$1,blockImage:BlockImagePreview};function FallbackIcon(){return/* @__PURE__ */jsx(DocumentIcon,{className:"sanity-studio__preview-fallback-icon"});}function SanityDefaultPreview(props){const{description:descriptionProp,icon,layout,media:mediaProp,subtitle:subtitleProp,title:titleProp,value:valueProp}=props,restProps=_objectWithoutProperties(props,_excluded20);const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const imageBuilder=useMemo(()=>imageUrlBuilder(client),[client]);const component=_previewComponents[layout||"default"]||_previewComponents.default;const{_upload,value}=useMemo(()=>{return valueProp?_extractUploadState(valueProp):{_upload:void 0,value:void 0};},[valueProp]);const description=descriptionProp||(isRecord$2(value)&&(value==null?void 0:value.description)?String(value==null?void 0:value.description):void 0);const title=titleProp||(isRecord$2(value)&&(value==null?void 0:value.title)?String(value==null?void 0:value.title):void 0);const subtitle=subtitleProp||(isRecord$2(value)&&(value==null?void 0:value.subtitle)?String(value==null?void 0:value.subtitle):void 0);const renderMedia=useCallback(options=>{if(!isImage(mediaProp)){return null;}const{dimensions}=options;return/* @__PURE__ */jsx("img",{alt:isString(title)?title:void 0,referrerPolicy:"strict-origin-when-cross-origin",src:imageBuilder.image(mediaProp).width(dimensions.width||100).height(dimensions.height||100).fit(dimensions.fit).dpr(dimensions.dpr||1).url()||""});},[imageBuilder,mediaProp,title]);const renderIcon=useCallback(()=>{return createElement(icon||FallbackIcon);},[icon]);const media=useMemo(()=>{if(icon===false){return false;}if(typeof mediaProp==="function"){return mediaProp;}if(isValidElement(mediaProp)){return mediaProp;}if(isReference$1(mediaProp)&&mediaProp._type==="reference"){return renderMedia;}if(isImage(mediaProp)){return renderMedia;}return renderIcon;},[icon,mediaProp,renderIcon,renderMedia]);return createElement(component,_objectSpread(_objectSpread({imageUrl:_upload==null?void 0:_upload.previewImage,progress:_upload==null?void 0:_upload.progress},restProps),{},{media,description,title,subtitle,value}));}function useDocumentPreview(props){const{enabled=true,ordering,schemaType,value:previewValue}=props||{};const{observeForPreview}=useDocumentPreviewStore();const[error,setError]=useState(null);const[value,setValue]=useState(null);useEffect(()=>{if(!enabled||!previewValue||!schemaType)return void 0;const snapshotEvent$=observeForPreview(previewValue,schemaType,{ordering});const sub=snapshotEvent$.subscribe({error(nextError){setError(nextError);},next(nextValue){setValue(nextValue.snapshot||null);}});return()=>sub.unsubscribe();},[enabled,observeForPreview,ordering,schemaType,previewValue]);return{error,value};}const resize$=typeof window==="undefined"?EMPTY$1:fromEvent(window,"resize").pipe(shareReplay(1));const scroll$=typeof window==="undefined"?EMPTY$1:fromEvent(window,"scroll",{passive:true,capture:true}).pipe(shareReplay(1));const orientationChange$=typeof window==="undefined"?EMPTY$1:fromEvent(window,"orientationchange").pipe(shareReplay(1));const ROOT_MARGIN_PX=150;function isIntersectionObserverSupported(){if(typeof window!=="undefined"&&"IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in IntersectionObserverEntry.prototype){if(!("isIntersecting"in IntersectionObserverEntry.prototype)){Object.defineProperty(IntersectionObserverEntry.prototype,"isIntersecting",{get(){return this.intersectionRatio>0;}});}return true;}return false;}const intersectionObservableFor=isIntersectionObserverSupported()?createIntersectionObserverBased():createLegacyBased();function createIntersectionObserverBased(){const intersectionObserverEntriesSubject=new Subject();const intersectionObserver=new IntersectionObserver(entries=>{entries.forEach(entry=>{intersectionObserverEntriesSubject.next(entry);});},{threshold:0,rootMargin:"".concat(ROOT_MARGIN_PX,"px")});return function intersectionObservableFor2(element){return new Observable(observer=>{intersectionObserver.observe(element);observer.next();return()=>intersectionObserver.unobserve(element);}).pipe(mergeMap(()=>intersectionObserverEntriesSubject.asObservable()),filter(entry=>entry.target===element),map(ev=>({isIntersecting:ev.isIntersecting})));};}function createLegacyBased(){function getViewport(){return{left:0,right:window.innerWidth,top:0,bottom:window.innerHeight};}function intersects(rect,viewport,margin){return rect.left<=viewport.right+margin&&rect.right>=viewport.left-margin&&rect.top<=viewport.bottom+margin&&rect.bottom>=viewport.top-margin;}function inViewport(element){return()=>intersects(element.getBoundingClientRect(),getViewport(),ROOT_MARGIN_PX);}return function intersectionObservableFor2(element){const isElementInViewport=inViewport(element);return merge(of(isElementInViewport()),resize$,scroll$,orientationChange$).pipe(map(isElementInViewport),map(isIntersecting=>({isIntersecting})));};}const visibilityChange$=typeof window==="undefined"?EMPTY$1:fromEvent(document,"visibilitychange").pipe(shareReplay(1));function useVisibility(props){const{element,hideDelay=0}=props;const[visible,setVisible]=useState(false);useEffect(()=>{if(!element){return void 0;}const isDocumentVisible$=concat(of(!document.hidden),visibilityChange$.pipe(map(event=>{var _a;return event.target instanceof Document?!((_a=event==null?void 0:event.target)==null?void 0:_a.hidden):false;}))).pipe(distinctUntilChanged());const inViewport$=intersectionObservableFor(element).pipe(map(event=>event.isIntersecting));const visible$=isDocumentVisible$.pipe(switchMap(isDocumentVisible=>isDocumentVisible?inViewport$:of(false)),switchMap(isVisible=>isVisible?of(true):of(false).pipe(delay(hideDelay))),distinctUntilChanged());const sub=visible$.subscribe(setVisible);return()=>sub.unsubscribe();},[element,hideDelay]);return visible;}const _HIDE_DELAY=1e3*2;function _resolvePreviewComponent(type){var _a;return((_a=type.components)==null?void 0:_a.preview)||SanityDefaultPreview;}function SanityPreview(props){const{layout="default",ordering,schemaType,style:styleProp,value:valueProp}=props,restProps=_objectWithoutProperties(props,_excluded21);const component=_resolvePreviewComponent(schemaType);const[element,setElement]=useState(null);const isPTE=["inline","block","blockImage"].includes(layout);const visibility=useVisibility({element:isPTE?null:element,hideDelay:_HIDE_DELAY});const{error,value}=useDocumentPreview({enabled:isPTE||visibility,ordering,schemaType,value:valueProp});const setRef=useCallback(refValue=>{setElement(refValue);},[]);const style=useMemo(()=>_objectSpread(_objectSpread({},styleProp),{},{minWidth:(styleProp==null?void 0:styleProp.minWidth)||1,minHeight:(styleProp==null?void 0:styleProp.minHeight)||1}),[styleProp]);return/* @__PURE__ */jsx("div",{ref:setRef,style,children:createElement(component,_objectSpread(_objectSpread({},restProps),{},{description:value==null?void 0:value.description,error,isPlaceholder:!value,layout,media:isImage(valueProp)?valueProp:value==null?void 0:value.media,schemaType,subtitle:value==null?void 0:value.subtitle,title:value==null?void 0:value.title,value}))});}function getPreviewPaths(preview){const selection=preview==null?void 0:preview.select;if(!selection)return void 0;return Object.values(selection).map(value=>String(value).split("."));}const INCLUDE_FIELDS_QUERY=["_id","_rev","_type"];const INCLUDE_FIELDS=[...INCLUDE_FIELDS_QUERY,"_key"];const AVAILABILITY_READABLE$1={available:true,reason:"READABLE"};const AVAILABILITY_PERMISSION_DENIED$1={available:false,reason:"PERMISSION_DENIED"};const AVAILABILITY_NOT_FOUND$1={available:false,reason:"NOT_FOUND"};const INVALID_PREVIEW_FALLBACK={title:"Invalid preview config",subtitle:"Check the error log in the console",media:/* @__PURE__ */jsx(WarningOutlineIcon,{})};function isPortableTextArray(blocks){return Array.isArray(blocks)&&(blocks.length===0||blocks.some(isBlock));}function extractTextFromBlocks(blocks){const firstBlock=blocks.find(isBlock);if(!firstBlock||!firstBlock.children){return"";}return firstBlock.children.filter(isSpan).map(span=>span.text).join("");}function keysOf(value){return Object.keys(value);}const PRESERVE_KEYS=["_id","_type","_upload","_createdAt","_updatedAt"];const EMPTY=[];const errorCollector=(()=>{let errorsByType={};return{add:(type,value,error)=>{if(!errorsByType[type.name]){errorsByType[type.name]=[];}errorsByType[type.name].push({error,type,value});},getAll(){return errorsByType;},clear(){errorsByType={};}};})();const reportErrors=debounce(()=>{const errorsByType=errorCollector.getAll();const uniqueErrors=flatten$1(Object.keys(errorsByType).map(typeName=>{const entries=errorsByType[typeName];return uniqBy(entries,entry=>entry.error.message);}));const errorCount=uniqueErrors.length;if(errorCount===0){return;}console.groupCollapsed("%cHeads up! Got ".concat(errorCount===1?"error":"".concat(errorCount," errors")," while preparing data for preview. Click for details."),"color: #ff7e7c");Object.keys(errorsByType).forEach(typeName=>{const entries=errorsByType[typeName];const first=entries[0];console.group("Check the preview config for schema type \"".concat(typeName,"\": %o"),first.type.preview);const uniqued=uniqBy(entries,entry=>entry.error.message);uniqued.forEach(entry=>{var _a;if(entry.error.type==="returnValueError"){const hasPrepare=typeof((_a=entry.type.preview)==null?void 0:_a.prepare)==="function";const{value,error}=entry;console.log("Encountered an invalid ".concat(hasPrepare?"return value when calling prepare(%o)":"value targeted by preview.select",":"),value);console.error(error);}if(entry.error.type==="prepareError"){const{value,error}=entry;console.log("Encountered an error when calling prepare(%o):",value);console.error(error);}});console.groupEnd();});console.groupEnd();errorCollector.clear();},1e3);const isRenderable=fieldName=>value=>{const type=typeof value;if(value===null||type==="undefined"||type==="string"||type==="number"||type==="boolean"){return EMPTY;}return[assignType("returnValueError",new Error("The \"".concat(fieldName,"\" field should be a string, number, boolean, undefined or null, instead saw ").concat(inspect(value))))];};const FIELD_NAME_VALIDATORS={media:()=>{return EMPTY;},title:isRenderable("title"),subtitle:isRenderable("subtitle"),description:isRenderable("description"),imageUrl:isRenderable("imageUrl"),date:isRenderable("date")};function inspect(val){let prefixType=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(isRecord$2(val)){const keys=Object.keys(val);const ellipse=keys.length>3?"...":"";const prefix="object with keys ";return"".concat(prefixType?prefix:"","{").concat(keys.slice(0,3).join(", ")).concat(ellipse,"}");}if(Array.isArray(val)){const ellipse=val.length>3?"...":"";const prefix="array with ";return"".concat(prefixType?prefix:"","[").concat(val.map(v=>inspect(v,false))).concat(ellipse,"]");}return"the ".concat(typeof val," ").concat(val);}function validateFieldValue(fieldName,fieldValue){if(typeof fieldValue==="undefined"){return EMPTY;}const validator=FIELD_NAME_VALIDATORS[fieldName];return validator&&validator(fieldValue)||EMPTY;}function assignType(type,error){return Object.assign(error,{type});}function validatePreparedValue(preparedValue){if(!isPlainObject(preparedValue)||preparedValue===null){return[assignType("returnValueError",new Error("Invalid return value. Expected a plain object with at least a 'title' field, instead saw ".concat(inspect(preparedValue))))];}return Object.entries(preparedValue).reduce((acc,_ref79)=>{let[fieldName,fieldValue]=_ref79;return[...acc,...validateFieldValue(fieldName,fieldValue)];},EMPTY);}function validateReturnedPreview(result){return _objectSpread(_objectSpread({},result),{},{errors:[...(result.errors||[]),...validatePreparedValue(result.returnValue)]});}function defaultPrepare(value){return keysOf(value).reduce((acc,fieldName)=>{const val=value[fieldName];return _objectSpread(_objectSpread({},acc),{},{[fieldName]:isPortableTextArray(val)?extractTextFromBlocks(val):value[fieldName]});},{});}function invokePrepare(type,value){let viewOptions=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var _a;const prepare=(_a=type.preview)==null?void 0:_a.prepare;try{return{returnValue:prepare?prepare(value,viewOptions):defaultPrepare(value),errors:EMPTY};}catch(error){return{returnValue:null,errors:[assignType("prepareError",error)]};}}function withErrors(result,type,selectedValue){result.errors.forEach(error=>errorCollector.add(type,selectedValue,error));reportErrors();return INVALID_PREVIEW_FALLBACK;}function hasEnumListOptions(type){const options=type.options&&typeof type.options==="object"?type.options:false;if(!options||!("list"in options)){return false;}const listOptions=options.list;return Array.isArray(listOptions);}function getListOptions(type){if(!hasEnumListOptions(type)){return void 0;}const listOptions=type.options.list;return listOptions.map(option=>isTitledListValue(option)?option:{title:option,value:option});}function prepareForPreview(rawValue,type){let viewOptions=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var _a,_b;const hasCustomPrepare=typeof((_a=type.preview)==null?void 0:_a.prepare)==="function";const selection=((_b=type.preview)==null?void 0:_b.select)||{};const targetKeys=Object.keys(selection);const selectedValue=targetKeys.reduce((acc,key)=>{var _a2;const typeWithFields="fields"in type?type:null;const targetFieldName=selection[key];const valueField=(_a2=typeWithFields==null?void 0:typeWithFields.fields)==null?void 0:_a2.find(f=>f.name===targetFieldName);const listOptions=valueField&&getListOptions(valueField.type);if(!hasCustomPrepare&&listOptions){const selectedOption=listOptions&&listOptions.find(opt=>opt.value===get$2(rawValue,selection[key]));acc[key]=selectedOption?selectedOption.value:get$2(rawValue,selection[key]);}else{acc[key]=get$2(rawValue,selection[key]);}return acc;},{});const prepareResult=invokePrepare(type,selectedValue,viewOptions);if(prepareResult.errors.length>0){return withErrors(prepareResult,type,selectedValue);}const returnValueResult=validateReturnedPreview(invokePrepare(type,selectedValue,viewOptions));return returnValueResult.errors.length>0?withErrors(returnValueResult,type,selectedValue):_objectSpread(_objectSpread({},pick(rawValue,PRESERVE_KEYS)),prepareResult.returnValue);}function setKey(source,key,value){return _objectSpread(_objectSpread({},source),{},{[key]:value});}function props(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return source=>{return new Observable(observer=>source.subscribe(observer)).pipe(switchMap(object=>{const keyObservables=keysOf(object).map(key=>{const value=object[key];return isObservable(value)?from(value).pipe(map(val=>[key,val])):of([key,value]);});return options.wait?from(keyObservables).pipe(combineAll(),map(pairs=>pairs.reduce((acc,_ref80)=>{let[key,value]=_ref80;return setKey(acc,key,value);},{}))):from(keyObservables).pipe(mergeAll(),scan((acc,_ref81)=>{let[key,value]=_ref81;return setKey(acc,key,value);},{}));}));};}function createEmpty(fields){return fields.reduce((result,field)=>{result[field]=void 0;return result;},{});}function resolveMissingHeads(value,paths){return paths.filter(path=>!(path[0]in value));}function observePaths(value,paths,observeFields,apiConfig){if(!value||typeof value!=="object"){return of(value);}const id=isReference$1(value)?value._ref:value._id;const currentValue=_objectSpread(_objectSpread({},value),{},{_id:id});if(currentValue._type==="reference"){delete currentValue._type;delete currentValue._ref;delete currentValue._weak;delete currentValue._dataset;delete currentValue._projectId;delete currentValue._strengthenOnPublish;}const pathsWithMissingHeads=resolveMissingHeads(currentValue,paths);if(id&&pathsWithMissingHeads.length>0){const nextHeads=uniq(pathsWithMissingHeads.map(path=>path[0]));const dataset=isRecord$2(value)&&isString$1(value._dataset)?value._dataset:void 0;const projectId=isRecord$2(value)&&isString$1(value._projectId)?value._projectId:void 0;const refApiConfig=dataset&&projectId?{projectId,dataset}:apiConfig;return observeFields(id,nextHeads,refApiConfig).pipe(switchMap(snapshot=>{if(snapshot===null){return of(null);}return observePaths(_objectSpread(_objectSpread(_objectSpread({},createEmpty(nextHeads)),isReference$1(value)?_objectSpread(_objectSpread({},value),refApiConfig):value),snapshot),paths,observeFields,refApiConfig);}));}const leads={};paths.forEach(path=>{const[head,...tail]=path;if(!leads[head]){leads[head]=[];}leads[head].push(tail);});const next=Object.keys(leads).reduce((res,head)=>{const tails=leads[head].filter(tail=>tail.length>0);if(tails.length===0){res[head]=isRecord$2(value)?value[head]:void 0;}else{res[head]=observePaths(value[head],tails,observeFields,apiConfig);}return res;},currentValue);return of(next).pipe(props({wait:true}));}function normalizePaths(path){return path.map(segment=>typeof segment==="string"?segment.split("."):segment);}function createPathObserver(context){const{observeFields}=context;return{observePaths(value,paths,apiConfig){return observePaths(value,normalizePaths(paths),observeFields,apiConfig);}};}function isRecord$1(value){return isPlainObject(value);}function isReference(value){return isPlainObject(value);}function createPreviewObserver(context){const{observeDocumentTypeFromId,observePaths}=context;return function observeForPreview(value,type,viewOptions,apiConfig){if(isCrossDatasetReferenceSchemaType(type)){if(!isCrossDatasetReference(value)){return of({snapshot:void 0});}const refApiConfig={projectId:value._projectId,dataset:value._dataset};return observeDocumentTypeFromId(value._ref,refApiConfig).pipe(switchMap(typeName=>{if(typeName){const refType=type.to.find(toType=>toType.type===typeName);return observeForPreview(value,refType,{},refApiConfig);}return of({snapshot:void 0});}));}if(isReferenceSchemaType(type)){if(!isReference(value)){return of({snapshot:void 0});}return observeDocumentTypeFromId(value._ref).pipe(switchMap(typeName=>{if(typeName){const refType=type.to.find(toType=>toType.name===typeName);return observeForPreview(value,refType);}return of({snapshot:void 0});}));}const paths=getPreviewPaths(type.preview);if(paths){return observePaths(value,paths,apiConfig).pipe(map(snapshot=>({type,snapshot:snapshot&&prepareForPreview(snapshot,type,viewOptions)})));}return of({type,snapshot:value&&isRecord$1(value)?invokePrepare(type,value,viewOptions).returnValue:null});};}function debounceCollect(fn,wait){let timer;let queue={};let idx=0;return function debounced(){for(var _len4=arguments.length,args=new Array(_len4),_key5=0;_key5<_len4;_key5++){args[_key5]=arguments[_key5];}return new Observable(obs=>{clearTimeout(timer);timer=setTimeout(flush,wait);const queueItem={args,observer:obs,completed:false};const id=idx++;queue[id]=queueItem;return()=>{queueItem.completed=true;};});};function flush(){const currentlyFlushingQueue=queue;queue={};const queueItemIds=Object.keys(currentlyFlushingQueue).filter(id=>{const queueItem=currentlyFlushingQueue[id];return queueItem&&!queueItem.completed;});if(queueItemIds.length===0){return;}const collectedArgs=queueItemIds.map(id=>{const queueItem=currentlyFlushingQueue[id];return queueItem&&queueItem.args;}).filter(isNonNullable$4);fn(collectedArgs).subscribe({next(results){results.forEach((result,i)=>{const queueItem=currentlyFlushingQueue[queueItemIds[i]];if(queueItem&&!queueItem.completed){queueItem.observer.next(results[i]);}});},complete(){queueItemIds.forEach(id=>{const entry=currentlyFlushingQueue[id];if(entry&&!entry.completed){entry.observer.complete();}});},error(err){queueItemIds.forEach(id=>{const entry=currentlyFlushingQueue[id];if(entry&&!entry.completed){entry.observer.error(err);}});}});}}function combineSelections(selections){return values(selections.reduce((output,_ref82,index)=>{let[id,fields]=_ref82;const key=sortBy(fields.join(","),identity).join(".");if(!output[key]){output[key]={fields,ids:[],map:[]};}const idx=output[key].ids.length;output[key].ids[idx]=id;output[key].map[idx]=index;return output;},{}));}function stringifyId(id){return JSON.stringify(id);}const maybeEscape=fieldName=>fieldNeedsEscape(fieldName)?"\"".concat(fieldName,"\": @").concat(escapeField(fieldName)):fieldName;function toSubQuery(_ref83){let{ids,fields}=_ref83;const allFields=[...INCLUDE_FIELDS_QUERY,...fields];return"*[_id in [".concat(ids.map(stringifyId).join(","),"]][0...").concat(ids.length,"]{").concat(allFields.map(maybeEscape).join(","),"}");}function toQuery(combinedSelections){return"[".concat(combinedSelections.map(toSubQuery).join(","),"][0...").concat(combinedSelections.length,"]");}function reassemble(queryResult,combinedSelections){return queryResult.reduce((reprojected,subResult,index)=>{const map=combinedSelections[index].map;map.forEach((resultIdx,i)=>{const id=combinedSelections[index].ids[i];const found=subResult.find(doc=>doc._id===id);reprojected[resultIdx]=found||null;});return reprojected;},[]);}function hasEqualFields(fields){return(object,otherObject)=>{if(object===otherObject){return true;}if(!object||!otherObject){return false;}if(typeof object!=="object"||typeof otherObject!=="object"){return false;}return fields.every(field=>object[field]===otherObject[field]);};}const id=value=>value;function isUniqueBy(array){let itemSelector=arguments.length>1&&arguments[1]!==undefined?arguments[1]:id;let prevItem;let currItem;for(let i=0;i<array.length;i++){if(i===0){prevItem=itemSelector(array[i]);continue;}currItem=itemSelector(array[i]);if(prevItem!==currItem){return false;}prevItem=currItem;}return true;}function create_preview_observeFields(context){const{crossProjectTokenStore,observePaths,versionedClient}=context;let _globalListener;const getGlobalEvents=()=>{if(!_globalListener){const allEvents$=from(versionedClient.listen('*[!(_id in path("_.**"))]',{},{events:["welcome","mutation"],includeResult:false,visibility:"query",tag:"preview.global"})).pipe(share());const welcome$=allEvents$.pipe(filter(event=>event.type==="welcome"),publishReplay(1),refCount());welcome$.subscribe();const mutations$=allEvents$.pipe(filter(event=>event.type==="mutation"));_globalListener={welcome$,mutations$};}return _globalListener;};function listen(id){const globalEvents=getGlobalEvents();return merge(globalEvents.welcome$,globalEvents.mutations$.pipe(filter(event=>event.documentId===id)));}function fetchAllDocumentPathsWith(client,token){const headers=token?{"sanity-project-tokens":"".concat(token.projectId,"=").concat(token.value)}:{};return function fetchAllDocumentPath(selections){const combinedSelections=combineSelections(selections);return client.observable.fetch(toQuery(combinedSelections),{},{tag:"preview.document-paths",headers}).pipe(map(result=>reassemble(result,combinedSelections)));};}const fetchDocumentPathsFast=debounceCollect(fetchAllDocumentPathsWith(versionedClient),100);const fetchDocumentPathsSlow=debounceCollect(fetchAllDocumentPathsWith(versionedClient),1e3);function currentDatasetListenFields(id,fields){return listen(id).pipe(switchMap(event=>{if(event.type==="welcome"||event.visibility==="query"){return fetchDocumentPathsFast(id,fields).pipe(mergeMap(result=>{return concat(of(result),result===void 0?fetchDocumentPathsSlow(id,fields):[]);}));}return fetchDocumentPathsSlow(id,fields);}));}const CACHE={};const getBatchFetcherForDataset=memoize$1(function getBatchFetcherForDataset2(apiConfig,token){const client=versionedClient.withConfig(apiConfig);const fetchAll=fetchAllDocumentPathsWith(client,token);return debounceCollect(fetchAll,10);},apiConfig=>apiConfig.dataset+apiConfig.projectId);const CROSS_DATASET_PREVIEW_POLL_INTERVAL=1e4;const visiblePoll$=fromEvent(document,"visibilitychange").pipe(startWith(0),map(()=>document.visibilityState==="visible"),switchMap(visible=>visible?timer(0,CROSS_DATASET_PREVIEW_POLL_INTERVAL):EMPTY$1),share());function crossDatasetListenFields(id,fields,apiConfig){const token$=observePaths({_type:"reference",_ref:crossProjectTokenStore.getTokenDocumentId({projectId:apiConfig.projectId})},["token"]).pipe(map(document2=>document2==null?void 0:document2.token));return combineLatest([token$,visiblePoll$.pipe(startWith(0))]).pipe(switchMap(_ref84=>{let[token]=_ref84;const batchFetcher=getBatchFetcherForDataset(apiConfig,token?{projectId:apiConfig.projectId,value:token}:void 0);return batchFetcher(id,fields);}));}function createCachedFieldObserver(id,fields,apiConfig){let latest=null;const changes$=merge(defer(()=>latest===null?EMPTY$1:of(latest)),apiConfig?crossDatasetListenFields(id,fields,apiConfig):currentDatasetListenFields(id,fields)).pipe(tap(v=>latest=v),publishReplay(1),refCount());return{id,fields,changes$};}function cachedObserveFields(id,fields,apiConfig){const cacheKey=apiConfig?"".concat(apiConfig.projectId,":").concat(apiConfig.dataset,":").concat(id):"$current$-".concat(id);if(!(cacheKey in CACHE)){CACHE[cacheKey]=[];}const existingObservers=CACHE[cacheKey];const missingFields=difference(fields,flatten$1(existingObservers.map(cachedFieldObserver=>cachedFieldObserver.fields)));if(missingFields.length>0){existingObservers.push(createCachedFieldObserver(id,fields,apiConfig));}const cachedFieldObservers=existingObservers.filter(observer=>observer.fields.some(fieldName=>fields.includes(fieldName))).map(cached=>cached.changes$);return combineLatest(cachedFieldObservers).pipe(map(snapshots=>snapshots.filter(Boolean)),filter(snapshots=>isUniqueBy(snapshots,snapshot=>snapshot._rev)),map(snapshots=>snapshots.length===0?null:pickFrom(snapshots,fields)),distinctUntilChanged(hasEqualFields(fields)));}return{observeFields:cachedObserveFields};function pickFrom(objects,fields){return[...INCLUDE_FIELDS,...fields].reduce((result,fieldName)=>{const value=getFirstFieldValue(objects,fieldName);if(value!==void 0){result[fieldName]=value;}return result;},{});}function getFirstFieldValue(objects,fieldName){let value;objects.some(object=>{if(fieldName in object){value=object[fieldName];return true;}return false;});return value;}}const MAX_DOCUMENT_ID_CHUNK_SIZE=11164;function chunkDocumentIds(documentIds){let chunk=[];let chunkSize=0;const chunks=[];for(const documentId of documentIds){if(chunkSize+documentId.length+1>=MAX_DOCUMENT_ID_CHUNK_SIZE){chunks.push(chunk);chunk=[];chunkSize=0;}chunkSize+=documentId.length+1;chunk.push(documentId);}if(!chunks.includes(chunk)){chunks.push(chunk);}return chunks;}function create_preview_availability(versionedClient,observePaths){function observeDocumentPairAvailability(value){const draftId=getDraftId("_id"in value?value._id:value._ref);const publishedId=getPublishedId("_id"in value?value._id:value._ref);return combineLatest([observeDocumentAvailability({_type:"reference",_ref:draftId}),observeDocumentAvailability({_type:"reference",_ref:publishedId})]).pipe(distinctUntilChanged(shallowEquals),map(_ref85=>{let[draftReadability,publishedReadability]=_ref85;return{draft:draftReadability,published:publishedReadability};}));}function observeDocumentAvailability(value){const id="_id"in value?value._id:value._ref;return observePaths(value,[["_rev"]]).pipe(map(res=>isRecord$2(res)&&Boolean("_rev"in res&&(res==null?void 0:res._rev))),distinctUntilChanged(),switchMap(hasRev=>{return hasRev?of(AVAILABILITY_READABLE$1):fetchDocumentReadability(id);}));}const fetchDocumentReadability=debounceCollect(function fetchDocumentReadability2(args){const uniqueIds=[...new Set(flatten$1(args))];return from(chunkDocumentIds(uniqueIds)).pipe(mergeMap(fetchDocumentReadabilityChunked,10),map(res=>args.map(_ref86=>{let[id]=_ref86;return res[uniqueIds.indexOf(id)];})));},1);function fetchDocumentReadabilityChunked(ids){return defer(()=>{const requestOptions={uri:versionedClient.getDataUrl("doc",ids.join(",")),json:true,query:{excludeContent:"true"},tag:"preview.documents-availability"};return versionedClient.observable.request(requestOptions).pipe(map(response=>{const omitted=keyBy(response.omitted||[],entry=>entry.id);return ids.map(id=>{const omittedEntry=omitted[id];if(!omittedEntry){return AVAILABILITY_READABLE$1;}if(omittedEntry.reason==="existence"){return AVAILABILITY_NOT_FOUND$1;}if(omittedEntry.reason==="permission"){return AVAILABILITY_PERMISSION_DENIED$1;}throw new Error("Unexpected reason for omission: \"".concat(omittedEntry.reason,"\""));});}));});}return{observeDocumentPairAvailability};}function create_preview_documentPair(versionedClient,observePaths){const{observeDocumentPairAvailability}=create_preview_availability(versionedClient,observePaths);const ALWAYS_INCLUDED_SNAPSHOT_PATHS=[["_updatedAt"],["_createdAt"],["_type"]];return{observePathsDocumentPair};function observePathsDocumentPair(value,paths){const{draftId,publishedId}=getIdPair("_id"in value?value._id:value._ref);return observeDocumentPairAvailability(value).pipe(switchMap(availability=>{if(!availability.draft.available&&!availability.published.available){return of({id:publishedId,type:null,draft:{availability:availability.draft,snapshot:void 0},published:{availability:availability.published,snapshot:void 0}});}const snapshotPaths=[...paths,...ALWAYS_INCLUDED_SNAPSHOT_PATHS];return combineLatest([observePaths({_type:"reference",_ref:draftId},snapshotPaths),observePaths({_type:"reference",_ref:publishedId},snapshotPaths)]).pipe(map(_ref87=>{let[draftSnapshot,publishedSnapshot]=_ref87;const type=isRecord$2(draftSnapshot)&&"_type"in draftSnapshot&&draftSnapshot._type||isRecord$2(publishedSnapshot)&&"_type"in publishedSnapshot&&publishedSnapshot._type||null;return{id:publishedId,type:typeof type==="string"?type:null,draft:{availability:availability.draft,snapshot:draftSnapshot},published:{availability:availability.published,snapshot:publishedSnapshot}};}));}));}}function createDocumentPreviewStore(_ref88){let{crossProjectTokenStore,client}=_ref88;const versionedClient=client.withConfig({apiVersion:"1"});const __proxy_observePaths=(value,paths,apiConfig)=>{return observePaths(value,paths,apiConfig);};const{observeFields}=create_preview_observeFields({crossProjectTokenStore,observePaths:__proxy_observePaths,versionedClient});const{observePaths}=createPathObserver({observeFields});function observeDocumentTypeFromId(id,apiConfig){return observePaths({_type:"reference",_ref:id},["_type"]).pipe(map(res=>isRecord$2(res)&&typeof res._type==="string"?res._type:void 0),distinctUntilChanged());}const observeForPreview=createPreviewObserver({observeDocumentTypeFromId,observePaths});const{observeDocumentPairAvailability}=create_preview_availability(versionedClient,observePaths);const{observePathsDocumentPair}=create_preview_documentPair(versionedClient,observePaths);return{observePaths,observeForPreview,observeDocumentTypeFromId,unstable_observeDocumentPairAvailability:observeDocumentPairAvailability,unstable_observePathsDocumentPair:observePathsDocumentPair};}function SearchItem(props){const{documentId,documentType,onClick}=props,restProps=_objectWithoutProperties(props,_excluded22);const documentPresence=useDocumentPresence(documentId);const schema=useSchema();const schemaType=schema.get(documentType);const params=useMemo(()=>({id:getPublishedId(documentId),type:documentType}),[documentId,documentType]);const previewValue=useMemo(()=>({_id:documentId,_type:documentType}),[documentId,documentType]);const LinkComponent=useMemo(()=>forwardRef(function LinkComponent2(linkProps,ref){return/* @__PURE__ */jsx(IntentLink,_objectSpread(_objectSpread({},linkProps),{},{intent:"edit",params,tabIndex:-1,ref}));}),[params]);if(!schemaType)return null;return/* @__PURE__ */jsx(PreviewCard$2,_objectSpread(_objectSpread({"data-as":"a",as:LinkComponent,onClick},restProps),{},{radius:2,children:/* @__PURE__ */jsx(SanityPreview,{layout:"default",schemaType,status:/* @__PURE__ */jsxs(Inline,{space:3,children:[documentPresence&&documentPresence.length>0&&/* @__PURE__ */jsx(DocumentPreviewPresence,{presence:documentPresence}),/* @__PURE__ */jsx(Label,{size:0,muted:true,children:documentType||"NONE"})]}),value:previewValue})}));}const ResultsPopover=styled(Popover)(_templateObject77||(_templateObject77=_taggedTemplateLiteral(["\n  & > div {\n    min-height: 43px;\n    overflow: auto;\n    -webkit-overflow-scrolling: touch;\n  }\n\n  &[data-popper-reference-hidden='true'] {\n    display: none;\n  }\n"])));const SearchPopoverContent=forwardRef(function SearchPopoverContent2(props,ref){const{scheme}=useColorScheme();return/* @__PURE__ */jsx(ResultsPopover,_objectSpread({arrow:false,constrainSize:true,matchReferenceWidth:true,placement:"bottom",portal:true,radius:2,ref,scheme},props));});const StyledText$3=styled(Text$1)(_templateObject78||(_templateObject78=_taggedTemplateLiteral(["\n  word-break: break-word;\n"])));const filterOption=()=>true;function SearchField(props){const{fullScreen,onSearchItemClick,portalElement,relatedElements,setSearchInputElement}=props;const[query,setQuery]=useState(null);const results=useDocumentSearchResults({includeDrafts:true,query:query||""});const handleClickItem=useCallback(()=>{if(fullScreen&&onSearchItemClick){onSearchItemClick();}},[fullScreen,onSearchItemClick]);const renderOption=useCallback(option=>{const{data}=option.payload;const documentId=data.hit._id;const documentType=data.hit._type;return/* @__PURE__ */jsx(SearchItem,{onClick:handleClickItem,padding:2,documentId,documentType},documentId);},[handleClickItem]);const renderPopoverFullscreen=useCallback((popoverProps,ref)=>{var _a;if(!popoverProps.hidden&&results.error){return/* @__PURE__ */jsx(SearchFullscreenContent,{tone:"critical",children:/* @__PURE__ */jsx(Flex,{align:"center",flex:1,height:"fill",justify:"center",padding:4,sizing:"border",children:/* @__PURE__ */jsx(StyledText$3,{align:"center",muted:true,children:((_a=results==null?void 0:results.error)==null?void 0:_a.message)||"Something went wrong while searching"})})});}if(!popoverProps.hidden&&query&&!results.loading&&results.value.length===0){return/* @__PURE__ */jsx(SearchFullscreenContent,{children:/* @__PURE__ */jsx(Flex,{align:"center",flex:1,height:"fill",justify:"center",padding:4,sizing:"border",children:/* @__PURE__ */jsxs(StyledText$3,{align:"center",muted:true,children:["No results for ",/* @__PURE__ */jsxs("strong",{children:["\u2018",query,"\u2019"]})]})})});}if(!popoverProps.hidden&&results.value.length>0){return/* @__PURE__ */jsx(SearchFullscreenContent,{hidden:popoverProps.hidden,ref,children:popoverProps.content});}return void 0;},[query,results]);const renderPopover=useCallback((popoverProps,ref)=>{var _a;if(!popoverProps.hidden&&results.error){return/* @__PURE__ */jsx(SearchPopoverContent,{content:/* @__PURE__ */jsx(Box,{padding:4,children:/* @__PURE__ */jsx(Flex,{align:"center",height:"fill",justify:"center",children:/* @__PURE__ */jsx(StyledText$3,{align:"center",muted:true,children:((_a=results==null?void 0:results.error)==null?void 0:_a.message)||"Something went wrong while searching"})})}),open:!popoverProps.hidden,ref,referenceElement:popoverProps.inputElement});}if(!popoverProps.hidden&&query&&!results.loading&&results.value.length===0){return/* @__PURE__ */jsx(SearchPopoverContent,{content:/* @__PURE__ */jsx(Box,{padding:4,children:/* @__PURE__ */jsx(Flex,{align:"center",height:"fill",justify:"center",children:/* @__PURE__ */jsxs(StyledText$3,{align:"center",muted:true,children:["No results for ",/* @__PURE__ */jsxs("strong",{children:["\u201C",query,"\u201D"]})]})})}),open:!popoverProps.hidden,ref,referenceElement:popoverProps.inputElement});}if(!popoverProps.hidden&&results.value.length>0){return/* @__PURE__ */jsx(SearchPopoverContent,{content:popoverProps.content,open:!popoverProps.hidden,ref,referenceElement:popoverProps.inputElement});}return void 0;},[query,results]);const autoComplete=useMemo(()=>/* @__PURE__ */jsx(Autocomplete,{filterOption,icon:SearchIcon,id:"studio-search",listBox:{padding:fullScreen?2:1},loading:results.loading,onQueryChange:setQuery,options:results.value.map(hit=>{return{value:hit.hit._id,payload:{data:hit}};}),placeholder:"Search",radius:2,ref:setSearchInputElement,relatedElements,renderOption,renderPopover:fullScreen?renderPopoverFullscreen:renderPopover},"studio-search"),[fullScreen,relatedElements,renderOption,renderPopover,renderPopoverFullscreen,results.loading,results.value,setSearchInputElement]);return/* @__PURE__ */jsx(PortalProvider,{element:fullScreen?portalElement:null,children:autoComplete});}const listStyles=css(_templateObject79||(_templateObject79=_taggedTemplateLiteral(["\n  --margin-top: ","px;\n\n  &:not([data-list-type='number']) {\n    counter-reset: section;\n  }\n\n  &[data-list-type='bullet'] {\n    --bullet-marker: '\u25CF';\n    margin-top: var(--margin-top);\n\n    [data-list-type='bullet'] {\n      --bullet-marker: '\u25CB';\n      margin-top: var(--margin-top);\n\n      [data-list-type='bullet'] {\n        --bullet-marker: '\u25A0';\n        margin-top: var(--margin-top);\n\n        [data-list-type='bullet'] {\n          --bullet-marker: '\u25CF';\n          margin-top: var(--margin-top);\n\n          [data-list-type='bullet'] {\n            --bullet-marker: '\u25CB';\n            margin-top: var(--margin-top);\n\n            [data-list-type='bullet'] {\n              --bullet-marker: '\u25A0';\n              margin-top: var(--margin-top);\n\n              [data-list-type='bullet'] {\n                --bullet-marker: '\u25CF';\n                margin-top: var(--margin-top);\n\n                [data-list-type='bullet'] {\n                  --bullet-marker: '\u25CB';\n                  margin-top: var(--margin-top);\n\n                  [data-list-type='bullet'] {\n                    --bullet-marker: '\u25A0';\n                    margin-top: var(--margin-top);\n\n                    [data-list-type='bullet'] {\n                      --bullet-marker: '\u25CF';\n                      margin-top: var(--margin-top);\n\n                      [data-list-type='bullet'] {\n                        --bullet-marker: '\u25CB';\n                        margin-top: var(--margin-top);\n\n                        [data-list-type='bullet'] {\n                          --bullet-marker: '\u25A0';\n                          margin-top: var(--margin-top);\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n\n  &[data-list-type='number'] {\n    --bullet-marker: counter(section, number) '. ';\n    counter-reset: section;\n    margin-top: var(--margin-top);\n\n    [data-list-type='number'] {\n      --bullet-marker: counter(section, lower-alpha) '. ';\n      counter-reset: section;\n      margin-top: var(--margin-top);\n\n      [data-list-type='number'] {\n        --bullet-marker: counter(section, lower-roman) '. ';\n        counter-reset: section;\n        margin-top: var(--margin-top);\n\n        [data-list-type='number'] {\n          --bullet-marker: counter(section, number) '. ';\n          counter-reset: section;\n          margin-top: var(--margin-top);\n\n          [data-list-type='number'] {\n            --bullet-marker: counter(section, lower-alpha) '. ';\n            counter-reset: section;\n            margin-top: var(--margin-top);\n\n            [data-list-type='number'] {\n              --bullet-marker: counter(section, lower-roman) '. ';\n              counter-reset: section;\n              margin-top: var(--margin-top);\n\n              [data-list-type='number'] {\n                --bullet-marker: counter(section, number) '. ';\n                counter-reset: section;\n                margin-top: var(--margin-top);\n\n                [data-list-type='number'] {\n                  --bullet-marker: counter(section, lower-alpha) '. ';\n                  counter-reset: section;\n                  margin-top: var(--margin-top);\n\n                  [data-list-type='number'] {\n                    --bullet-marker: counter(section, lower-roman) '. ';\n                    counter-reset: section;\n                    margin-top: var(--margin-top);\n\n                    [data-list-type='number'] {\n                      --bullet-marker: counter(section, number) '. ';\n                      counter-reset: section;\n                      margin-top: var(--margin-top);\n\n                      [data-list-type='number'] {\n                        --bullet-marker: counter(section, lower-alpha) '. ';\n                        counter-reset: section;\n                        margin-top: var(--margin-top);\n\n                        [data-list-type='number'] {\n                          --bullet-marker: counter(section, lower-roman) '. ';\n                          counter-reset: section;\n                          margin-top: var(--margin-top);\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n"])),_ref89=>{let{theme}=_ref89;return theme.sanity.space[1];});const SpaceBox=styled(Box)(_templateObject80||(_templateObject80=_taggedTemplateLiteral(["\n  ",";\n"])),listStyles);const RootBox=styled(Box)(_templateObject81||(_templateObject81=_taggedTemplateLiteral(["\n  ",":first-child {\n    &:not([data-list-type='number'], [data-list-type='bullet']) {\n      margin-top: 0;\n    }\n  }\n\n  ",":last-child {\n    margin-bottom: 0;\n  }\n"])),SpaceBox,SpaceBox);const ListBoxOuter=styled(Box)(_templateObject82||(_templateObject82=_taggedTemplateLiteral(["\n  line-height: 1;\n"])));const ListBox=styled(Box)(()=>{return css(_templateObject83||(_templateObject83=_taggedTemplateLiteral(["\n    &:not([hidden]) {\n      position: relative;\n      padding-left: 2rem;\n      display: inline-flex;\n    }\n\n    & > [data-list-prefix] {\n      position: absolute;\n      width: 3rem;\n      left: -2rem;\n      text-align: right;\n\n      &[data-list-prefix='bullet'] {\n        top: -0.1875em;\n\n        & > span:before {\n          content: var(--bullet-marker);\n          font-size: 0.46666em;\n        }\n      }\n\n      &[data-list-prefix='number'] {\n        counter-increment: section;\n\n        & > span:before {\n          font-size: 1em;\n          content: var(--bullet-marker);\n        }\n      }\n    }\n  "])));});const ImageCard=styled(Card)(_templateObject84||(_templateObject84=_taggedTemplateLiteral(["\n  position: relative;\n  padding-bottom: ","%;\n  background-image: ",";\n  background-size: cover;\n\n  img {\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    object-fit: cover;\n  }\n"])),_ref90=>{let{$aspectRatio}=_ref90;return $aspectRatio;},_ref91=>{let{$lqip}=_ref91;return"url(".concat($lqip,")");});function Image$3(_ref92){let{value}=_ref92;if(!(value==null?void 0:value.asset)){return null;}const project=getProject(value.asset);const url=imageUrlBuilder(project).image(value).fit("max").auto("format").url();const{asset,alt,caption}=value;const{dimensions,lqip}=(asset==null?void 0:asset.metadata)||{};const aspectRatio=dimensions.height/dimensions.width*100;return/* @__PURE__ */jsx(SpaceBox,{marginY:4,children:/* @__PURE__ */jsxs(Stack,{space:3,as:"figure",children:[/* @__PURE__ */jsx(ImageCard,{radius:1,shadow:1,overflow:"hidden",$aspectRatio:aspectRatio,$lqip:lqip,children:/* @__PURE__ */jsx("img",{src:url,alt:alt||caption,referrerPolicy:"strict-origin-when-cross-origin"})}),caption&&/* @__PURE__ */jsx(Text$1,{align:"center",as:"figcaption",muted:true,size:1,children:value.caption})]})});}const components={types:{image:_ref93=>{let{value}=_ref93;return/* @__PURE__ */jsx(Image$3,{value});},code:_ref94=>{let{value}=_ref94;return/* @__PURE__ */jsx(SpaceBox,{marginY:4,children:/* @__PURE__ */jsx(Card,{padding:3,tone:"transparent",radius:1,overflow:"auto",children:/* @__PURE__ */jsx(Code,{size:1,language:value==null?void 0:value.language,children:value==null?void 0:value.code})})});}},block:{h1:_ref95=>{let{children}=_ref95;return/* @__PURE__ */jsx(SpaceBox,{marginBottom:4,marginTop:5,children:/* @__PURE__ */jsx(Heading,{size:5,children})});},h2:_ref96=>{let{children}=_ref96;return/* @__PURE__ */jsx(SpaceBox,{marginBottom:4,marginTop:5,children:/* @__PURE__ */jsx(Heading,{size:4,children})});},h3:_ref97=>{let{children}=_ref97;return/* @__PURE__ */jsx(SpaceBox,{marginBottom:4,marginTop:5,children:/* @__PURE__ */jsx(Heading,{size:3,children})});},h4:_ref98=>{let{children}=_ref98;return/* @__PURE__ */jsx(SpaceBox,{marginBottom:4,marginTop:5,children:/* @__PURE__ */jsx(Heading,{size:2,children})});},h5:_ref99=>{let{children}=_ref99;return/* @__PURE__ */jsx(SpaceBox,{marginBottom:4,marginTop:5,children:/* @__PURE__ */jsx(Heading,{size:1,children})});},h6:_ref100=>{let{children}=_ref100;return/* @__PURE__ */jsx(SpaceBox,{marginBottom:4,marginTop:5,children:/* @__PURE__ */jsx(Heading,{size:0,children})});},normal:_ref101=>{let{children}=_ref101;return/* @__PURE__ */jsx(SpaceBox,{marginY:4,children:/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children})});}},list:{bullet:_ref102=>{let{children}=_ref102;return/* @__PURE__ */jsx(SpaceBox,{"data-list-type":"bullet",marginBottom:4,children:/* @__PURE__ */jsx(Box,{as:"ul",children})});},number:_ref103=>{let{children}=_ref103;return/* @__PURE__ */jsx(SpaceBox,{"data-list-type":"number",marginBottom:4,children:/* @__PURE__ */jsx(Box,{as:"ol",children})});}},listItem:{bullet:_ref104=>{let{children}=_ref104;return/* @__PURE__ */jsx(ListBoxOuter,{marginBottom:1,forwardedAs:"li",children:/* @__PURE__ */jsxs(ListBox,{children:[/* @__PURE__ */jsx(Text$1,{muted:true,size:1,"data-list-prefix":"bullet"}),/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children})]})});},number:_ref105=>{let{children}=_ref105;return/* @__PURE__ */jsx(ListBoxOuter,{marginBottom:1,forwardedAs:"li",children:/* @__PURE__ */jsxs(ListBox,{children:[/* @__PURE__ */jsx(Text$1,{muted:true,"data-list-prefix":"number",size:1}),/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children})]})});}}};function PortableTextContent(props){const{value}=props;return/* @__PURE__ */jsx(RootBox,{children:/* @__PURE__ */jsx(PortableText$1,{value,components})});}const LABELS={bugfix:"Bugfixes",feature:"Feature"};function ChangelogItem(props){const{changeType,description,title}=props;const label=LABELS[changeType];return/* @__PURE__ */jsx(Card,{padding:4,shadow:1,radius:2,children:/* @__PURE__ */jsxs(Stack,{space:title?4:3,children:[label&&/* @__PURE__ */jsx(Label,{size:1,children:label}),/* @__PURE__ */jsxs(Stack,{space:3,children:[title&&/* @__PURE__ */jsx(Heading,{size:1,children:title}),description&&/* @__PURE__ */jsx(PortableTextContent,{value:description})]})]})});}function ChangelogList(props){const{changeItems,isLatest,version}=props;const features=changeItems.filter(c=>c.changeType==="feature");const bugfixes=changeItems.filter(c=>c.changeType==="bugfix");const bugFixesDescription=bugfixes.map(_ref106=>{let{description}=_ref106;return description;}).flat();return/* @__PURE__ */jsxs(Stack,{space:4,children:[/* @__PURE__ */jsxs(Flex,{align:"center",gap:2,children:[/* @__PURE__ */jsxs(Heading,{size:1,children:["v",version]}),isLatest&&/* @__PURE__ */jsx(Badge,{tone:"positive",children:"Latest"})]}),/* @__PURE__ */jsxs(Stack,{space:3,children:[features==null?void 0:features.map(change=>/* @__PURE__ */jsx(ChangelogItem,{changeType:change.changeType,description:change==null?void 0:change.description,title:change.title},change.title)),bugFixesDescription.length>0&&/* @__PURE__ */jsx(ChangelogItem,{changeType:"bugfix",description:bugFixesDescription})]}),/* @__PURE__ */jsx(Flex,{justify:"flex-end",children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx("a",{href:"https://github.com/sanity-io/sanity/releases",rel:"noreferrer noopener",target:"_blank",children:"See full changelog on GitHub"})})})]});}const StickyBox=styled(Box)(_templateObject85||(_templateObject85=_taggedTemplateLiteral(["\n  position: sticky;\n  top: 0;\n  z-index: 1;\n"])));const EMPTY_ARRAY$6=[];function ChangelogDialog(props){const{changelog,currentVersion,dialogProps,latestVersion}=props;const changelogWithChangeItems=(changelog||EMPTY_ARRAY$6).filter(c=>{var _a;return((_a=(c==null?void 0:c.changeItems)||EMPTY_ARRAY$6)==null?void 0:_a.length)>0;});const hasChangelog=changelogWithChangeItems.length>0;return/* @__PURE__ */jsx(Dialog,_objectSpread(_objectSpread({header:"Upgrade the Sanity Studio",width:1},dialogProps),{},{id:"changelog-dialog",children:/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(StickyBox,{children:/* @__PURE__ */jsx(Card,{padding:4,borderBottom:hasChangelog,children:/* @__PURE__ */jsx(Stack,{space:4,children:/* @__PURE__ */jsxs(Stack,{space:3,children:[hasChangelog&&/* @__PURE__ */jsx(Text$1,{weight:"semibold",children:"Changelog"}),currentVersion&&latestVersion&&/* @__PURE__ */jsxs(Text$1,{muted:true,size:1,children:["Your Sanity Studio is version ",/* @__PURE__ */jsx("code",{children:currentVersion}),". The latest version is ",/* @__PURE__ */jsx("code",{children:latestVersion}),"."]})]})})})}),hasChangelog&&/* @__PURE__ */jsx(Stack,{space:5,paddingY:4,children:changelogWithChangeItems==null?void 0:changelogWithChangeItems.map((log,index)=>{const{changeItems,version}=log;const showDivider=index<changelogWithChangeItems.length-1;const isLatest=version===latestVersion;return/* @__PURE__ */jsxs(React.Fragment,{children:[/* @__PURE__ */jsx(Box,{paddingX:4,children:/* @__PURE__ */jsx(ChangelogList,{changeItems:changeItems||EMPTY_ARRAY$6,version,isLatest})}),showDivider&&/* @__PURE__ */jsx(MenuDivider,{})]},version);})})]})}));}const sanityModuleVersions={sanity:SANITY_VERSION};const CACHED_LOOKUPS=/* @__PURE__ */new Map();function checkModuleStatus(options){const{moduleVersions=getInstalledModules(),client}=options;const query=buildQueryString(moduleVersions);const hash=hashQuery(query.m);let request$=CACHED_LOOKUPS.get(hash);if(request$){return request$;}request$=client.observable.request({url:"/versions",query,json:true,tag:"module.version-check"}).pipe(map(result=>_objectSpread(_objectSpread({},result),{},{installed:moduleVersions})),shareReplay(1));CACHED_LOOKUPS.set(hash,request$);return request$;}function buildQueryString(versions){return{m:Object.keys(versions).sort().filter(pkg=>versions[pkg]).map(pkg=>"".concat(pkg,"@").concat(versions[pkg]))};}function getInstalledModules(){return sanityModuleVersions;}function hashQuery(items){return items.join(",").replace(/@?sanity[/-]/g,"");}function useModuleStatus(options){const moduleStatus$=useMemo(()=>checkModuleStatus(options),[options]);return useLoadable(moduleStatus$);}const COMMANDS=["npm i @sanity/cli -g","sanity upgrade"];const Icon=styled(ToggleArrowRightIcon)(_templateObject86||(_templateObject86=_taggedTemplateLiteral(["\n  &[data-rotate='true'] {\n    transform: rotate(90deg);\n  }\n"])));function ChangelogAccordion(props){const{defaultOpen}=props;const[open,setOpen]=useState(defaultOpen);const handleClick=useCallback(()=>setOpen(v=>!v),[]);return/* @__PURE__ */jsxs(Card,{overflow:"hidden",children:[/* @__PURE__ */jsx(Stack,{children:/* @__PURE__ */jsx(Button,{"aria-controls":"upgrade-commands",icon:/* @__PURE__ */jsx(Icon,{"data-rotate":open}),justify:"flex-start",mode:"bleed",onClick:handleClick,padding:4,radius:0,space:2,text:"How to upgrade"})}),/* @__PURE__ */jsx(Card,{"aria-hidden":!open,hidden:!open,id:"upgrade-commands",overflow:"auto",paddingX:4,paddingY:2,role:"region",tone:"inherit",children:/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsx(Card,{tone:"transparent",padding:3,radius:2,children:/* @__PURE__ */jsx(Stack,{space:3,children:/* @__PURE__ */jsx(Code,{language:"bash",size:1,children:["# Run these commands to upgrade",...COMMANDS].join("\n")})})}),/* @__PURE__ */jsx(Box,{paddingX:2,paddingY:3,children:/* @__PURE__ */jsxs(Text$1,{size:1,muted:true,children:["If you have problems upgrading, please get in touch with us in the"," ",/* @__PURE__ */jsx("a",{href:"https://slack.sanity.io/",rel:"noopener noreferrer",target:"_blank",children:"Sanity Community"}),"."]})})]})})]});}const EMPTY_ARRAY$5=[];function ChangelogButton(){const[open,setOpen]=useState(false);const[buttonElement,setButtonElement]=useState(null);const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const versionedClient=useMemo(()=>client.withConfig({apiVersion:"1"}),[client]);const{scheme}=useColorScheme();const{value,error,isLoading}=useModuleStatus({client:versionedClient});const{changelog,currentVersion,latestVersion,isUpToDate}=value||{};const handleOpen=useCallback(()=>setOpen(true),[]);const handleClose=useCallback(()=>{setOpen(false);if(buttonElement){buttonElement.focus();}},[buttonElement]);const dialogProps=useMemo(()=>({footer:/* @__PURE__ */jsx(ChangelogAccordion,{defaultOpen:isDev}),onClickOutside:handleClose,onClose:handleClose,scheme}),[handleClose,scheme]);if(error||isLoading||isUpToDate){return null;}return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(StatusButton,{active:true,icon:PackageIcon,mode:"bleed",onClick:handleOpen,ref:setButtonElement,selected:open,statusTone:"primary"}),open&&/* @__PURE__ */jsx(ChangelogDialog,{changelog:changelog||EMPTY_ARRAY$5,currentVersion,dialogProps,latestVersion})]});}function ConfigIssuesButton(){var _a;const schema=useSchema();const groupsWithWarnings=((_a=schema._validation)==null?void 0:_a.filter(group=>group.problems.some(problem=>problem.severity==="warning")))||[];const{scheme}=useColorScheme();const dialogId=useId()||"config-issues-dialog";const[isDialogOpen,setDialogOpen]=useState(false);const[buttonElement,setButtonElement]=useState(null);const handleOpen=useCallback(()=>setDialogOpen(true),[]);const handleClose=useCallback(()=>{setDialogOpen(false);if(buttonElement){buttonElement.focus();}},[buttonElement]);if(groupsWithWarnings.length===0){return null;}return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:"Found configuration issues"})}),placement:"bottom",portal:true,scheme,children:/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Button,{icon:WarningOutlineIcon,mode:"bleed",tone:"caution",onClick:handleOpen,ref:setButtonElement,selected:isDialogOpen})})}),isDialogOpen&&/* @__PURE__ */jsx(Dialog,{header:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(Text$1,{weight:"semibold",children:"Configuration issues"}),/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:"Configuration checks are only performed during development and will not be visible in production builds"})]}),width:2,onClickOutside:handleClose,onClose:handleClose,scheme,id:dialogId,children:/* @__PURE__ */jsxs(Stack,{space:4,padding:4,children:[/* @__PURE__ */jsxs(Heading,{as:"h2",size:1,children:["Found ",groupsWithWarnings.length," schema warnings"]}),/* @__PURE__ */jsx(SchemaProblemGroups,{problemGroups:groupsWithWarnings})]})})]});}const RootLayer=styled(Layer)(_templateObject87||(_templateObject87=_taggedTemplateLiteral(["\n  min-height: auto;\n  position: relative;\n\n  &[data-search-open='true'] {\n    top: 0;\n    position: sticky;\n  }\n"])));const SearchCard=styled(Card)(_templateObject88||(_templateObject88=_taggedTemplateLiteral(["\n  z-index: 1;\n  top: 0;\n  left: 0;\n  bottom: 0;\n  right: 0;\n\n  &[data-fullscreen='true'] {\n    position: absolute;\n  }\n\n  &[data-fullscreen='false'] {\n    min-width: 253px;\n    max-width: 350px;\n  }\n"])));const LeftFlex=styled(Flex)(_templateObject89||(_templateObject89=_taggedTemplateLiteral(["\n  width: max-content;\n"])));function Navbar(props){var _a;const{fullscreenSearchPortalEl,onSearchOpenChange}=props;const _useWorkspace=useWorkspace(),{name,logo,navbar,tools}=_useWorkspace,workspace=_objectWithoutProperties(_useWorkspace,_excluded23);const workspaces=useWorkspaces();const routerState=useRouterState$1();const ToolMenu$1=((_a=navbar==null?void 0:navbar.components)==null?void 0:_a.ToolMenu)||ToolMenu;const{scheme}=useColorScheme();const{href:rootHref,onClick:handleRootClick}=useStateLink({state:{}});const mediaIndex=useMediaIndex();const activeToolName=typeof routerState.tool==="string"?routerState.tool:void 0;const[searchOpen,setSearchOpen]=useState(false);const[drawerOpen,setDrawerOpen]=useState(false);const routerStateRef=useRef(routerState);const workspaceNameRef=useRef(name);useEffect(()=>{if(routerStateRef.current.tool!==routerState.tool||name!==workspaceNameRef.current){setDrawerOpen(false);}routerStateRef.current=routerState;workspaceNameRef.current=name;},[name,routerState]);const[drawerButtonEl,setDrawerButtonEl]=useState(null);const[searchInputElement,setSearchInputElement]=useState(null);const[searchOpenButtonEl,setSearchOpenButtonEl]=useState(null);const[searchCloseButtonEl,setSearchCloseButtonEl]=useState(null);const shouldRender=useMemo(()=>({brandingCenter:mediaIndex<=1,changelog:mediaIndex>1,collapsedPresenceMenu:mediaIndex<=1,loginStatus:mediaIndex>1,searchFullscreen:mediaIndex<=1,configIssues:mediaIndex>1&&isDev,workspaces:mediaIndex>=3&&workspaces.length>1,tools:mediaIndex>=3}),[mediaIndex,workspaces.length]);const formattedName=typeof name==="string"&&name!=="root"?startCase(name):null;const title=workspace.title||formattedName||"Studio";useEffect(()=>{onSearchOpenChange(searchOpen);if(searchOpen)searchInputElement==null?void 0:searchInputElement.focus();},[searchOpen,searchInputElement,onSearchOpenChange]);useGlobalKeyDown(e=>{if(e.key==="Escape"&&searchOpen){handleCloseSearch();}});const handleOpenSearch=useCallback(()=>{setSearchOpen(true);},[]);const handleCloseSearch=useCallback(()=>{setSearchOpen(false);searchOpenButtonEl==null?void 0:searchOpenButtonEl.focus();},[searchOpenButtonEl]);const handleCloseDrawer=useCallback(()=>{setDrawerOpen(false);drawerButtonEl==null?void 0:drawerButtonEl.focus();},[drawerButtonEl]);const handleOpenDrawer=useCallback(()=>{setDrawerOpen(true);},[]);const rootLinkContent=(()=>{if(isValidElementType(logo))return createElement(logo);if(isValidElement(logo))return logo;return/* @__PURE__ */jsx(Text$1,{weight:"bold",children:title});})();const brandingComponent=useMemo(()=>/* @__PURE__ */jsx(Button,{"aria-label":title,as:"a",href:rootHref,mode:"bleed",onClick:handleRootClick,padding:3,children:rootLinkContent}),[handleRootClick,rootHref,rootLinkContent,title]);const searchRelatedElements=useMemo(()=>[searchCloseButtonEl].filter(Boolean),[searchCloseButtonEl]);return/* @__PURE__ */jsxs(RootLayer,{zOffset:100,"data-search-open":searchOpen,children:[/* @__PURE__ */jsx(Card,{scheme:"dark",shadow:scheme==="dark"?1:void 0,style:{lineHeight:0},padding:2,sizing:"border","data-ui":"Navbar",children:/* @__PURE__ */jsxs(Flex,{align:"center",justify:"space-between",children:[/* @__PURE__ */jsxs(LeftFlex,{align:"center",flex:shouldRender.brandingCenter?void 0:1,children:[!shouldRender.tools&&/* @__PURE__ */jsx(Box,{marginRight:1,children:/* @__PURE__ */jsx(Button,{mode:"bleed",icon:MenuIcon,onClick:handleOpenDrawer,ref:setDrawerButtonEl})}),!shouldRender.brandingCenter&&/* @__PURE__ */jsx(Box,{marginRight:1,children:brandingComponent}),shouldRender.workspaces&&/* @__PURE__ */jsx(Box,{marginRight:2,children:/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:"Select workspace"})}),placement:"bottom",portal:true,scheme,children:/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(WorkspaceMenuButton,{})})})}),/* @__PURE__ */jsx(Box,{marginRight:shouldRender.brandingCenter?void 0:2,children:/* @__PURE__ */jsx(NewDocumentButton,{})}),(searchOpen||!shouldRender.searchFullscreen)&&/* @__PURE__ */jsx(SearchCard,{"data-fullscreen":shouldRender.searchFullscreen,"data-ui":"SearchRoot",flex:1,padding:shouldRender.searchFullscreen?2:void 0,scheme:shouldRender.searchFullscreen?"light":void 0,shadow:shouldRender.searchFullscreen?1:void 0,children:/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{flex:1,marginRight:shouldRender.tools?void 0:[1,1,2],children:/* @__PURE__ */jsx(SearchField,{fullScreen:shouldRender.searchFullscreen,onSearchItemClick:handleCloseSearch,portalElement:fullscreenSearchPortalEl,setSearchInputElement,relatedElements:searchRelatedElements})}),shouldRender.searchFullscreen&&/* @__PURE__ */jsx(Button,{"aria-label":"Close search",icon:CloseIcon,mode:"bleed",onClick:handleCloseSearch,ref:setSearchCloseButtonEl})]})}),shouldRender.tools&&/* @__PURE__ */jsx(Card,{borderRight:true,flex:1,marginX:2,overflow:"visible",paddingRight:1,children:/* @__PURE__ */jsx(ToolMenu$1,{activeToolName,context:"topbar",isDrawerOpen:false,tools,closeDrawer:handleCloseDrawer})})]}),shouldRender.brandingCenter&&/* @__PURE__ */jsx(Box,{marginX:1,children:brandingComponent}),/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Box,{marginRight:1,children:/* @__PURE__ */jsx(PresenceMenu,{collapse:shouldRender.collapsedPresenceMenu})}),shouldRender.changelog&&/* @__PURE__ */jsx(Box,{marginRight:1,children:/* @__PURE__ */jsx(ChangelogButton,{})}),shouldRender.configIssues&&/* @__PURE__ */jsx(Box,{marginRight:2,children:/* @__PURE__ */jsx(ConfigIssuesButton,{})}),shouldRender.tools&&/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(UserMenu,{})}),shouldRender.searchFullscreen&&/* @__PURE__ */jsx(Button,{"aria-label":"Open search",icon:SearchIcon,mode:"bleed",onClick:handleOpenSearch,ref:setSearchOpenButtonEl})]})]})}),!shouldRender.tools&&/* @__PURE__ */jsx(NavDrawer,{activeToolName,isOpen:drawerOpen,onClose:handleCloseDrawer,tools})]});}function NoToolsScreen(){return/* @__PURE__ */jsx(Card,{height:"fill",children:/* @__PURE__ */jsx(Flex,{align:"center",height:"fill",justify:"center",padding:4,sizing:"border",children:/* @__PURE__ */jsx(Container$1,{width:0,children:/* @__PURE__ */jsx(Card,{padding:4,radius:2,shadow:1,tone:"caution",children:/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(WarningOutlineIcon,{})})}),/* @__PURE__ */jsxs(Stack,{flex:1,marginLeft:3,space:3,children:[/* @__PURE__ */jsx(Text$1,{as:"h1",size:1,weight:"bold",children:"No configured tools!"}),/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"Please configure a tool in your Studio configuration."}),/* @__PURE__ */jsx(Text$1,{as:"p",hidden:true,muted:true,size:1,children:/* @__PURE__ */jsx("a",{href:"",children:"Learn how to add a tool \u2192"})})]})]})})})})});}function ToolNotFoundScreen(props){const{toolName}=props;return/* @__PURE__ */jsx(Card,{height:"fill",children:/* @__PURE__ */jsx(Flex,{align:"center",height:"fill",justify:"center",padding:4,sizing:"border",children:/* @__PURE__ */jsx(Container$1,{width:0,children:/* @__PURE__ */jsx(Card,{padding:4,radius:2,shadow:1,tone:"caution",children:/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(WarningOutlineIcon,{})})}),/* @__PURE__ */jsx(Stack,{flex:1,marginLeft:3,space:3,children:/* @__PURE__ */jsxs(Text$1,{as:"h1",size:1,weight:"bold",children:["Tool not found: ",/* @__PURE__ */jsx("code",{children:toolName})]})})]})})})})});}const SearchFullscreenPortalCard=styled(Card)(_templateObject90||(_templateObject90=_taggedTemplateLiteral(["\n  display: flex;\n  flex-direction: column;\n  min-height: 100%;\n  flex: 1;\n"])));function StudioLayout(){const{state:routerState}=useRouter();const{name,title,tools}=useWorkspace();const activeToolName=typeof routerState.tool==="string"?routerState.tool:void 0;const activeTool=tools.find(tool=>tool.name===activeToolName);const[toolError,setToolError]=useState(null);const[searchOpen,setSearchOpen]=useState(false);const[fullscreenSearchPortalEl,setFullscreenSearchPortalEl]=useState(null);const documentTitle=useMemo(()=>{const mainTitle=title||startCase(name);if(activeToolName){return"".concat(mainTitle," \u2013 ").concat(startCase(activeToolName));}return mainTitle;},[activeToolName,name,title]);useEffect(()=>{document.title=documentTitle;},[documentTitle]);const handleSearchOpenChange=useCallback(open=>{setSearchOpen(open);},[]);const resetToolError=useCallback(()=>setToolError(null),[setToolError]);useEffect(resetToolError,[activeToolName,resetToolError]);useHotModuleReload(resetToolError);return/* @__PURE__ */jsxs(Flex,{"data-ui":"ToolScreen",direction:"column",height:"fill",children:[/* @__PURE__ */jsx(Navbar,{onSearchOpenChange:handleSearchOpenChange,fullscreenSearchPortalEl}),tools.length===0&&/* @__PURE__ */jsx(NoToolsScreen,{}),tools.length>0&&!activeTool&&activeToolName&&/* @__PURE__ */jsx(ToolNotFoundScreen,{toolName:activeToolName}),toolError&&activeTool&&/* @__PURE__ */jsxs(Card,{flex:1,overflow:"auto",padding:4,children:[/* @__PURE__ */jsxs(Heading,{as:"h1",children:["The ",/* @__PURE__ */jsx("code",{children:activeToolName})," tool crashed"]}),/* @__PURE__ */jsx(Box,{marginTop:4,children:/* @__PURE__ */jsx(Button,{onClick:resetToolError,text:"Retry"})}),/* @__PURE__ */jsx(Card,{marginTop:4,overflow:"auto",padding:3,tone:"critical",children:/* @__PURE__ */jsx(Code,{size:1,children:toolError.error.stack})}),/* @__PURE__ */jsx(Card,{marginTop:4,overflow:"auto",padding:3,tone:"critical",children:/* @__PURE__ */jsx(Code,{size:1,children:toolError.info.componentStack})})]}),searchOpen&&/* @__PURE__ */jsx(SearchFullscreenPortalCard,{ref:setFullscreenSearchPortalEl,overflow:"auto"}),/* @__PURE__ */jsx(Card,{flex:1,hidden:searchOpen,children:!toolError&&activeTool&&activeToolName&&/* @__PURE__ */jsx(RouteScope,{scope:activeToolName,children:/* @__PURE__ */jsx(ErrorBoundary,{onCatch:setToolError,children:/* @__PURE__ */jsx(Suspense,{fallback:/* @__PURE__ */jsx(LoadingTool,{}),children:createElement(activeTool.component,{tool:activeTool})})})})})]});}function LoadingTool(){return/* @__PURE__ */jsx(Flex,{align:"center",height:"fill",justify:"center",children:/* @__PURE__ */jsx(Spinner,{muted:true})});}function useClient(clientOptions){const source=useSource();if(!clientOptions){console.warn('Calling `useClient()` without specifying an API version is deprecated and will stop working in the next dev-preview release - please migrate to use `useClient({apiVersion: "2021-06-07"})`.');return source.getClient({apiVersion:"2021-06-07"});}return source.getClient(clientOptions);}function useDataset(){return useSource().dataset;}function useProjectId(){return useSource().projectId;}function useSchema(){return useSource().schema;}function useTemplates(){return useSource().templates;}const FIVE_SECONDS=1e3*5;const TWENTY_SECONDS=1e3*20;const ONE_MINUTE=1e3*60;const ONE_HOUR=ONE_MINUTE*60;function useTimeAgo(time){let{minimal,agoSuffix}=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};const[resolved,setResolved]=useState(()=>formatRelativeTime(time,{minimal,agoSuffix}));useEffect(()=>{setResolved(formatRelativeTime(time,{minimal,agoSuffix}));},[time,minimal,agoSuffix]);useEffect(()=>{const id=Number.isFinite(resolved.refreshInterval)?window.setInterval(()=>setResolved(formatRelativeTime(time,{minimal,agoSuffix})),resolved.refreshInterval):void 0;return()=>clearInterval(id);},[time,minimal,resolved.refreshInterval,agoSuffix]);return resolved.timestamp;}function formatRelativeTime(date){let opts=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};const parsedDate=date instanceof Date?date:new Date(date);if(!parsedDate.getTime()){return{timestamp:"",refreshInterval:Infinity};}const now=Date.now();const diffMonths=differenceInMonths(now,parsedDate);const diffYears=differenceInYears(now,parsedDate);if(diffMonths||diffYears){if(opts.minimal&&diffYears===0){return{timestamp:format(parsedDate,"MMM d"),refreshInterval:Infinity};}if(opts.minimal){return{timestamp:format(parsedDate,"MMM d, yyyy"),refreshInterval:Infinity};}return{timestamp:format(parsedDate,"MMM d, yyyy, hh:mm a"),refreshInterval:Infinity};}const diffWeeks=differenceInWeeks(now,parsedDate);const weekSuffix=pluralize("week",diffWeeks);if(diffWeeks){if(opts.minimal){return{timestamp:opts.agoSuffix?"".concat(diffWeeks,"w ago"):"".concat(diffWeeks,"w"),refreshInterval:ONE_HOUR};}return{timestamp:opts.agoSuffix?"".concat(diffWeeks," ").concat(weekSuffix," ago"):"".concat(diffWeeks," ").concat(weekSuffix),refreshInterval:ONE_HOUR};}const diffDays=differenceInDays(now,parsedDate);const daysSuffix=pluralize("days",diffDays);if(diffDays){if(opts.minimal){const daysSince2=opts.agoSuffix?"".concat(diffDays,"d ago"):"".concat(diffDays,"d");return{timestamp:diffDays===1?"yesterday":daysSince2,refreshInterval:ONE_HOUR};}const daysSince=opts.agoSuffix?"".concat(diffDays," ").concat(daysSuffix," ago"):"".concat(diffDays," ").concat(daysSuffix);return{timestamp:diffDays===1?"yesterday":daysSince,refreshInterval:ONE_HOUR};}const diffHours=differenceInHours(now,parsedDate);const hoursSuffix=pluralize("hour",diffHours);if(diffHours){if(opts.minimal){return{timestamp:opts.agoSuffix?"".concat(diffHours,"h ago"):"".concat(diffHours,"h"),refreshInterval:ONE_MINUTE};}return{timestamp:opts.agoSuffix?"".concat(diffHours," ").concat(hoursSuffix," ago"):"".concat(diffHours," ").concat(hoursSuffix),refreshInterval:ONE_MINUTE};}const diffMins=differenceInMinutes(now,parsedDate);const minsSuffix=pluralize("minute",diffMins);if(diffMins){if(opts.minimal){return{timestamp:opts.agoSuffix?"".concat(diffMins,"m ago"):"".concat(diffMins,"m"),refreshInterval:TWENTY_SECONDS};}return{timestamp:opts.agoSuffix?"".concat(diffMins," ").concat(minsSuffix," ago"):"".concat(diffMins," ").concat(minsSuffix),refreshInterval:TWENTY_SECONDS};}const diffSeconds=differenceInSeconds(now,parsedDate);const secsSuffix=pluralize("second",diffSeconds);if(diffSeconds>10){if(opts.minimal){return{timestamp:opts.agoSuffix?"".concat(diffSeconds,"s ago"):"".concat(diffSeconds,"s"),refreshInterval:FIVE_SECONDS};}return{timestamp:opts.agoSuffix?"".concat(diffSeconds," ").concat(secsSuffix," ago"):"".concat(diffSeconds," ").concat(secsSuffix),refreshInterval:FIVE_SECONDS};}return{timestamp:"just now",refreshInterval:FIVE_SECONDS};}const INITIAL$1="connecting";function useConnectionState(publishedDocId,docTypeName){const documentStore=useDocumentStore();return useMemoObservable(()=>documentStore.pair.documentEvents(publishedDocId,docTypeName).pipe(map(ev=>ev.type),map(eventType=>eventType!=="reconnect"),switchMap(isConnected=>isConnected?of("connected"):timer(200).pipe(mapTo("reconnecting"))),startWith(INITIAL$1),distinctUntilChanged()),[publishedDocId,docTypeName],INITIAL$1);}function useDocumentOperation(publishedDocId,docTypeName){const documentStore=useDocumentStore();const operations$=useMemo(()=>{return documentStore.pair.editOperations(publishedDocId,docTypeName);},[documentStore,publishedDocId,docTypeName]);return useObservable(operations$);}function useDocumentOperationEvent(publishedDocId,docTypeName){const documentStore=useDocumentStore();return useMemoObservable(()=>documentStore.pair.operationEvents(publishedDocId,docTypeName),[publishedDocId,docTypeName]);}function useEditState(publishedDocId,docTypeName){const documentStore=useDocumentStore();return useMemoObservable(()=>documentStore.pair.editState(publishedDocId,docTypeName),[publishedDocId,docTypeName]);}const SYNCING={isSyncing:true};const NOT_SYNCING={isSyncing:false};function useSyncState(publishedDocId,documentType){const documentStore=useDocumentStore();return useMemoObservable(()=>documentStore.pair.consistencyStatus(publishedDocId,documentType).pipe(map(isConsistent=>isConsistent?NOT_SYNCING:SYNCING)),[publishedDocId],NOT_SYNCING);}const INITIAL={validation:[],isValidating:false};function useValidationStatus(publishedDocId,docTypeName){const documentStore=useDocumentStore();return useMemoObservable(()=>documentStore.pair.validation(publishedDocId,docTypeName),[publishedDocId,docTypeName],INITIAL);}const getUpdatedSnapshot=bufferedDocument=>{const LOCAL=bufferedDocument.LOCAL;const HEAD=bufferedDocument.document.HEAD;if(!LOCAL){return LOCAL;}return _objectSpread(_objectSpread({},LOCAL),{},{_type:(HEAD||LOCAL)._type,_rev:(HEAD||LOCAL)._rev,_updatedAt:new Date().toISOString()});};const toSnapshotEvent=document=>({type:"snapshot",document});const getDocument=event=>event.document;const createObservableBufferedDocument=(listenerEvent$,commitMutations)=>{const actions$=new Subject();const consistency$=new BehaviorSubject(true);const mutations$=new Subject();const rebase$=new Subject();const remoteMutations=new Subject();const createInitialBufferedDocument=initialSnapshot=>{const bufferedDocument=new BufferedDocument(initialSnapshot);bufferedDocument.onMutation=_ref107=>{let{mutation,remote}=_ref107;mutations$.next({type:"mutation",document:getUpdatedSnapshot(bufferedDocument),mutations:mutation.mutations,origin:remote?"remote":"local"});};bufferedDocument.onRemoteMutation=mutation=>{remoteMutations.next({type:"remoteMutation",head:bufferedDocument.document.HEAD,transactionId:mutation.transactionId,timestamp:mutation.timestamp,author:mutation.identity,effects:mutation.effects});};bufferedDocument.onRebase=(edge,nextRemoteMutations,localMutations)=>{rebase$.next({type:"rebase",document:edge,remoteMutations:nextRemoteMutations,localMutations});};bufferedDocument.onConsistencyChanged=isConsistent=>{consistency$.next(isConsistent);};bufferedDocument.commitHandler=opts=>{const _opts$mutation$params=opts.mutation.params,{resultRev}=_opts$mutation$params,mutation=_objectWithoutProperties(_opts$mutation$params,_excluded24);commitMutations(mutation).then(opts.success,error=>{const isBadRequest="statusCode"in error&&typeof error.statusCode==="number"&&error.statusCode>=400&&error.statusCode<=500;if(isBadRequest){opts.cancel(error);}else{opts.failure();}return Promise.reject(error);});};return bufferedDocument;};const currentBufferedDocument$=listenerEvent$.pipe(scan((bufferedDocument,listenerEvent)=>{if(listenerEvent.type==="snapshot"){if(bufferedDocument){bufferedDocument.commit();}return createInitialBufferedDocument(listenerEvent.document||null);}if(bufferedDocument===null){console.warn('Ignoring event of type "%s" since buffered document has not yet been set up with snapshot',listenerEvent.type);return null;}return bufferedDocument;},null),distinctUntilChanged(),publishReplay(1),refCount());const snapshotAfterSync$=listenerEvent$.pipe(filter(ev=>ev.type==="mutation"),withLatestFrom(currentBufferedDocument$),map(_ref108=>{let[mutationEvent,bufferedDocument]=_ref108;bufferedDocument.arrive(new Mutation(mutationEvent));return getUpdatedSnapshot(bufferedDocument);}));const actionHandler$=actions$.pipe(withLatestFrom(currentBufferedDocument$),tap(_ref109=>{let[action,bufferedDocument]=_ref109;if(action.type==="mutation"){bufferedDocument.add(new Mutation({mutations:action.mutations}));}if(action.type==="commit"){bufferedDocument.commit();}}),mergeMapTo(EMPTY$1),share());const emitAction=action=>actions$.next(action);const addMutations=mutations=>emitAction({type:"mutation",mutations});const addMutation=mutation=>addMutations([mutation]);const commit=()=>{return currentBufferedDocument$.pipe(take(1),mergeMap(bufferedDocument=>bufferedDocument.commit()),mergeMapTo(EMPTY$1));};const snapshot$=merge(currentBufferedDocument$.pipe(map(bufferedDocument=>bufferedDocument.LOCAL)),mutations$.pipe(map(getDocument)),rebase$.pipe(map(getDocument)),snapshotAfterSync$).pipe(map(toSnapshotEvent),publishReplay(1),refCount());const remoteSnapshot$=merge(currentBufferedDocument$.pipe(map(bufferedDocument=>bufferedDocument.document.HEAD),map(toSnapshotEvent)),remoteMutations).pipe(publishReplay(1),refCount());return{updates$:merge(snapshot$,actionHandler$,mutations$,rebase$),consistency$:consistency$.pipe(distinctUntilChanged(),publishReplay(1),refCount()),remoteSnapshot$,addMutation,addMutations,commit};};const prepare=id=>document=>{const{_id,_rev,_updatedAt}=document,rest=_objectWithoutProperties(document,_excluded25);return _objectSpread({_id:id},rest);};const createBufferedDocument=(documentId,listenerEvent$,commitMutations)=>{const bufferedDocument=createObservableBufferedDocument(listenerEvent$,commitMutations);const prepareDoc=prepare(documentId);const DELETE={delete:{id:documentId}};return{events:bufferedDocument.updates$,consistency$:bufferedDocument.consistency$,remoteSnapshot$:bufferedDocument.remoteSnapshot$,patch:patches=>patches.map(patch=>({patch:_objectSpread(_objectSpread({},patch),{},{id:documentId})})),create:document=>({create:prepareDoc(document)}),createIfNotExists:document=>({createIfNotExists:prepareDoc(document)}),createOrReplace:document=>({createOrReplace:prepareDoc(document)}),delete:()=>DELETE,mutate:mutations=>bufferedDocument.addMutations(mutations),commit:()=>bufferedDocument.commit()};};function getPairListener(client,idPair){let options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};const{publishedId,draftId}=idPair;return defer(()=>client.observable.listen("*[_id == $publishedId || _id == $draftId]",{publishedId,draftId},{includeResult:false,events:["welcome","mutation","reconnect"],effectFormat:"mendoza",tag:options.tag||"document.pair-listener"})).pipe(concatMap(event=>event.type==="welcome"?fetchInitialDocumentSnapshots().pipe(concatMap(snapshots=>[createSnapshotEvent(draftId,snapshots.draft),createSnapshotEvent(publishedId,snapshots.published)])):of(event)));function fetchInitialDocumentSnapshots(){return client.observable.getDocuments([draftId,publishedId],{tag:"document.snapshots"}).pipe(map(_ref110=>{let[draft,published]=_ref110;return{draft,published};}));}}function createSnapshotEvent(documentId,document){return{type:"snapshot",documentId,document};}const isEventForDocId=id=>event=>event.type!=="reconnect"&&event.documentId===id;function commitMutations(client,mutations){return client.dataRequest("mutate",mutations,{visibility:"async",returnDocuments:false,tag:"document.commit"});}function setVersion(version){return ev=>_objectSpread(_objectSpread({},ev),{},{version});}function checkoutPair(client,idPair){const{publishedId,draftId}=idPair;const listenerEvents$=getPairListener(client,idPair).pipe(share());const reconnect$=listenerEvents$.pipe(filter(ev=>ev.type==="reconnect"));const draft=createBufferedDocument(draftId,listenerEvents$.pipe(filter(isEventForDocId(draftId))),mut=>commitMutations(client,mut));const published=createBufferedDocument(publishedId,listenerEvents$.pipe(filter(isEventForDocId(publishedId))),mut=>commitMutations(client,mut));return{draft:_objectSpread(_objectSpread({},draft),{},{events:merge(reconnect$,draft.events).pipe(map(setVersion("draft"))),consistency$:draft.consistency$,remoteSnapshot$:draft.remoteSnapshot$.pipe(map(setVersion("draft")))}),published:_objectSpread(_objectSpread({},published),{},{events:merge(reconnect$,published.events).pipe(map(setVersion("published"))),consistency$:published.consistency$,remoteSnapshot$:published.remoteSnapshot$.pipe(map(setVersion("published")))})};}function memoize(fn,keyGen){const MEMO=/* @__PURE__ */Object.create(null);return function(){const key=keyGen(...arguments);if(!(key in MEMO)){MEMO[key]=fn(...arguments);}return MEMO[key];};}const memoizedPair=memoize((client,idPair,_typeName)=>{return new Observable(subscriber=>{subscriber.next(checkoutPair(client,idPair));}).pipe(publishReplay(1),refCount());},(_client,idPair)=>idPair.publishedId);function isSnapshotEvent(event){return event.type==="snapshot";}function withSnapshots(pair){return{snapshots$:pair.events.pipe(filter(isSnapshotEvent),map(event=>event.document),publishReplay(1),refCount()),patch:pair.patch,create:pair.create,createIfNotExists:pair.createIfNotExists,createOrReplace:pair.createOrReplace,delete:pair.delete,mutate:pair.mutate,commit:pair.commit};}const snapshotPair=memoize((client,idPair,typeName)=>{return memoizedPair(client,idPair,typeName).pipe(map(_ref111=>{let{published,draft}=_ref111;return{published:withSnapshots(published),draft:withSnapshots(draft)};}),publishReplay(1),refCount());},(_client,idPair,typeName)=>idPair.publishedId+typeName);const operationArgs=memoize((ctx,idPair,typeName)=>{return snapshotPair(ctx.client,idPair,typeName).pipe(switchMap(versions=>combineLatest([versions.draft.snapshots$,versions.published.snapshots$]).pipe(map(_ref112=>{let[draft,published]=_ref112;return _objectSpread(_objectSpread({},ctx),{},{idPair,typeName,snapshots:{draft,published},draft:versions.draft,published:versions.published});}))),publishReplay(1),refCount());},(_ctx,idPair,typeName)=>idPair.publishedId+typeName);const isLiveEditEnabled$1=(schema,typeName)=>{var _a;return((_a=schema.get(typeName))==null?void 0:_a.liveEdit)===true;};const editState=(ctx,idPair,typeName)=>{const liveEdit=isLiveEditEnabled$1(ctx.schema,typeName);return operationArgs(ctx,idPair,typeName).pipe(map(_ref113=>{let{snapshots}=_ref113;return{id:idPair.publishedId,type:typeName,draft:snapshots.draft,published:snapshots.published,liveEdit,ready:true};}),startWith({id:idPair.publishedId,type:typeName,draft:null,published:null,liveEdit,ready:false}),publishReplay(1),refCount());};const del={disabled:_ref114=>{let{snapshots}=_ref114;return snapshots.draft||snapshots.published?false:"NOTHING_TO_DELETE";},execute:_ref115=>{let{client,idPair,schema,typeName}=_ref115;const tx=client.observable.transaction().delete(idPair.publishedId);if(isLiveEditEnabled$1(schema,typeName)){return tx.commit({tag:"document.delete"});}return tx.delete(idPair.draftId).commit({tag:"document.delete",visibility:"async",skipCrossDatasetReferenceValidation:true});}};function strengthenOnPublish(obj){if(isReference$1(obj)){if(obj._strengthenOnPublish){return omit(obj,["_strengthenOnPublish"].concat(obj._strengthenOnPublish.weak?[]:["_weak"]));}return obj;}if(typeof obj!=="object"||!obj)return obj;if(Array.isArray(obj))return obj.map(strengthenOnPublish);return Object.fromEntries(Object.entries(obj).map(_ref116=>{let[key,value]=_ref116;return[key,strengthenOnPublish(value)];}));}const publish={disabled:_ref117=>{let{schema,typeName,snapshots}=_ref117;if(isLiveEditEnabled$1(schema,typeName)){return"LIVE_EDIT_ENABLED";}if(!snapshots.draft){return snapshots.published?"ALREADY_PUBLISHED":"NO_CHANGES";}return false;},execute:_ref118=>{let{client,idPair,snapshots}=_ref118;const tx=client.observable.transaction();if(!snapshots.draft){throw new Error('cannot execute "publish" when draft is missing');}const value=strengthenOnPublish(omit(snapshots.draft,"_updatedAt"));if(snapshots.published){tx.patch(idPair.publishedId,{unset:["_revision_lock_pseudo_field_"],ifRevisionID:snapshots.published._rev});tx.createOrReplace(_objectSpread(_objectSpread({},value),{},{_id:idPair.publishedId,_type:snapshots.draft._type}));}else{tx.create(_objectSpread(_objectSpread({},value),{},{_id:idPair.publishedId,_type:snapshots.draft._type}));}tx.delete(idPair.draftId);return tx.commit({tag:"document.publish",visibility:"async"});}};const patch={disabled:()=>false,execute:function(_ref119){let{schema,snapshots,idPair,draft,published,typeName}=_ref119;let patches=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let initialValue=arguments.length>2?arguments[2]:undefined;if(isLiveEditEnabled$1(schema,typeName)){published.mutate([published.createIfNotExists(_objectSpread({_type:typeName},initialValue)),...published.patch(patches)]);}else{draft.mutate([draft.createIfNotExists(_objectSpread(_objectSpread(_objectSpread({},initialValue),snapshots.published),{},{_id:idPair.draftId,_type:typeName})),...draft.patch(patches)]);}}};const commit={disabled:()=>false,execute:_ref120=>{let{draft,published}=_ref120;return merge(draft.commit(),published.commit());}};const discardChanges={disabled:_ref121=>{let{snapshots}=_ref121;if(!snapshots.draft){return"NO_CHANGES";}if(!snapshots.published){return"NOT_PUBLISHED";}return false;},execute:_ref122=>{let{client,idPair}=_ref122;return client.observable.transaction().delete(idPair.draftId).commit({tag:"document.discard-changes",visibility:"async"});}};const unpublish={disabled:_ref123=>{let{schema,snapshots,typeName}=_ref123;if(isLiveEditEnabled$1(schema,typeName)){return"LIVE_EDIT_ENABLED";}return snapshots.published?false:"NOT_PUBLISHED";},execute:_ref124=>{let{client,idPair,snapshots}=_ref124;let tx=client.observable.transaction().delete(idPair.publishedId);if(snapshots.published){tx=tx.createIfNotExists(_objectSpread(_objectSpread({},omit(snapshots.published,"_updatedAt")),{},{_id:idPair.draftId,_type:snapshots.published._type}));}return tx.commit({tag:"document.unpublish",visibility:"async",skipCrossDatasetReferenceValidation:true});}};const omitProps=["_createdAt","_updatedAt"];const duplicate={disabled:_ref125=>{let{snapshots}=_ref125;return snapshots.published||snapshots.draft?false:"NOTHING_TO_DUPLICATE";},execute:(_ref126,dupeId)=>{let{client,schema,snapshots,typeName}=_ref126;const source=snapshots.draft||snapshots.published;if(!source){throw new Error("cannot execute on empty document");}return client.observable.create(_objectSpread(_objectSpread({},omit(source,omitProps)),{},{_id:isLiveEditEnabled$1(schema,typeName)?dupeId:getDraftId(dupeId),_type:source._type}),{visibility:"async",tag:"document.duplicate"});}};const restore$1={disabled:()=>false,execute:(_ref127,fromRevision)=>{let{historyStore,idPair,schema,typeName}=_ref127;const targetId=isLiveEditEnabled$1(schema,typeName)?idPair.publishedId:idPair.draftId;return historyStore.restore(idPair.publishedId,targetId,fromRevision);}};const consistencyStatus=memoize((client,idPair,typeName)=>{return memoizedPair(client,idPair,typeName).pipe(switchMap(_ref128=>{let{draft,published}=_ref128;return combineLatest([draft.consistency$,published.consistency$]);}),map(_ref129=>{let[draftIsConsistent,publishedIsConsistent]=_ref129;return draftIsConsistent&&publishedIsConsistent;}),distinctUntilChanged(),publishReplay(1),refCount());},(_client,idPair,typeName)=>idPair.publishedId+typeName);function maybeObservable(v){return typeof v==="undefined"?of(null):v;}const operationImpls={del,delete:del,publish,patch,commit,discardChanges,unpublish,duplicate,restore:restore$1};const execute=(operationName,operationArguments,extraArgs)=>{const operation=operationImpls[operationName];return defer(()=>merge(of(null),maybeObservable(operation.execute(operationArguments,...extraArgs)))).pipe(last());};const operationCalls$=new Subject();function emitOperation(operationName,idPair,typeName,extraArgs){operationCalls$.next({operationName,idPair,typeName,extraArgs});}const REQUIRES_CONSISTENCY=["publish","unpublish","discardChanges","delete"];const listenerCache=/* @__PURE__ */new Map();function getOperationEvents(ctx){const{dataset,projectId}=ctx.client.config();const cacheKey="".concat(projectId,"-").concat(dataset);if(listenerCache.has(cacheKey)){return listenerCache.get(cacheKey);}const result$=operationCalls$.pipe(groupBy$1(op=>op.idPair.publishedId),mergeMap(groups$=>groups$.pipe(switchMap(args=>operationArgs(ctx,args.idPair,args.typeName).pipe(take(1),switchMap(operationArguments=>{const requiresConsistency=REQUIRES_CONSISTENCY.includes(args.operationName);if(requiresConsistency){operationArguments.published.commit();operationArguments.draft.commit();}const isConsistent$=consistencyStatus(ctx.client,args.idPair,args.typeName).pipe(filter(Boolean));const ready$=requiresConsistency?isConsistent$.pipe(take(1)):of(null);return ready$.pipe(mergeMap(()=>execute(args.operationName,operationArguments,args.extraArgs)));}),map(()=>({type:"success",args})),catchError(err=>of({type:"error",args,error:err})))))),share());const AUTOCOMMIT_INTERVAL=1e3;const autoCommit$=result$.pipe(filter(result=>result.type==="success"&&result.args.operationName==="patch"),throttleTime(AUTOCOMMIT_INTERVAL,asyncScheduler,{leading:true,trailing:true}),tap(result=>{emitOperation("commit",result.args.idPair,result.args.typeName,[]);}));const cache=/* @__PURE__ */new Map();function listener(idPair,typeName){const key="".concat(idPair.publishedId,":").concat(typeName);let ret=cache.get(key);if(!ret){ret=merge(result$,autoCommit$.pipe(mergeMapTo(EMPTY$1))).pipe(filter(result=>result.args.idPair.publishedId===idPair.publishedId),map(result=>{const{operationName,idPair:documentIds}=result.args;return result.type==="success"?{type:"success",op:operationName,id:documentIds.publishedId}:{type:"error",op:operationName,id:documentIds.publishedId,error:result.error};}));cache.set(key,ret);}return ret;}listenerCache.set(cacheKey,listener);return listener;}function createOperationGuard(opName){return{disabled:"NOT_READY",execute:()=>{throw new Error("Called ".concat(opName," before it was ready."));}};}const GUARDED={commit:createOperationGuard("commit"),delete:createOperationGuard("delete"),del:createOperationGuard("del"),publish:createOperationGuard("publish"),patch:createOperationGuard("patch"),discardChanges:createOperationGuard("discardChanges"),unpublish:createOperationGuard("unpublish"),duplicate:createOperationGuard("duplicate"),restore:createOperationGuard("restore")};const createEmitter=(operationName,idPair,typeName)=>{return function(){for(var _len5=arguments.length,executeArgs=new Array(_len5),_key6=0;_key6<_len5;_key6++){executeArgs[_key6]=arguments[_key6];}return emitOperation(operationName,idPair,typeName,executeArgs);};};function wrap(opName,op,operationArgs){const disabled=op.disabled(operationArgs);return{disabled,execute:createEmitter(opName,operationArgs.idPair,operationArgs.typeName)};}function createOperationsAPI(args){return{commit:wrap("commit",commit,args),delete:wrap("delete",del,args),del:wrap("delete",del,args),publish:wrap("publish",publish,args),patch:wrap("patch",patch,args),discardChanges:wrap("discardChanges",discardChanges,args),unpublish:wrap("unpublish",unpublish,args),duplicate:wrap("duplicate",duplicate,args),restore:wrap("restore",restore$1,args)};}const remoteSnapshots=memoize((client,idPair,typeName)=>{return memoizedPair(client,idPair,typeName).pipe(switchMap(_ref130=>{let{published,draft}=_ref130;return merge(published.remoteSnapshot$,draft.remoteSnapshot$);}));},(_client,idPair,typeName)=>idPair.publishedId+typeName);const INITIAL_VALIDATION_STATUS={isValidating:true,validation:[]};function findReferenceIds(obj){return reduceJSON(obj,(acc,node)=>{if(isReference$1(node)){acc.add(node._ref);}return acc;},/* @__PURE__ */new Set());}const listenDocumentExists=(previewStore,id)=>previewStore.unstable_observeDocumentPairAvailability({_type:"reference",_ref:id}).pipe(map(_ref131=>{let{published}=_ref131;return published.available;}));const validation=memoize((ctx,_ref132,typeName)=>{let{draftId,publishedId}=_ref132;const getDocumentExists=_ref133=>{let{id}=_ref133;return listenDocumentExists(ctx.documentPreviewStore,id).pipe(first()).toPromise();};const document$=editState(ctx,{draftId,publishedId},typeName).pipe(map(_ref134=>{let{draft,published}=_ref134;return draft||published;}),debounceTime(300),share());const referenceIds$=document$.pipe(map(document=>findReferenceIds(document)),distinctUntilChanged((curr,next)=>{if(curr.size!==next.size)return false;for(const item of curr){if(!next.has(item))return false;}return true;}));const referencedDocumentUpdate$=referenceIds$.pipe(switchMap(idSet=>from(idSet).pipe(mergeMap(id=>listenDocumentExists(ctx.documentPreviewStore,id).pipe(map(result=>[id,result]))),scan((acc,_ref135)=>{let[id,result]=_ref135;return _objectSpread(_objectSpread({},acc),{},{[id]:result});},{}))),distinctUntilChanged((curr,next)=>{const currKeys=Object.keys(curr);const nextKeys=Object.keys(next);if(currKeys.length!==nextKeys.length)return false;for(const key of currKeys){if(curr[key]!==next[key])return false;}return true;}));return combineLatest([document$,concat(of(null),referencedDocumentUpdate$).pipe(debounceTime(50))]).pipe(map(_ref136=>{let[document]=_ref136;return document;}),switchMap(document=>concat(of({isValidating:true}),defer(async()=>{if(!(document==null?void 0:document._type)){return{validation:[],isValidating:false};}const markers=await validateDocument(ctx.getClient,document,ctx.schema,{getDocumentExists});return{validation:markers,isValidating:false};}))),scan((acc,next)=>_objectSpread(_objectSpread({},acc),next),INITIAL_VALIDATION_STATUS),publishReplay(1),refCount());},(_ctx,idPair)=>idPair.publishedId);function documentEvents(client,idPair,typeName){return memoizedPair(client,idPair).pipe(switchMap(_ref137=>{let{draft,published}=_ref137;return merge(draft.events,published.events);}));}const cache=/* @__PURE__ */new Map();const editOperations=(ctx,idPair,typeName)=>{const key="".concat(idPair.publishedId,":").concat(typeName);let ret=cache.get(key);if(!ret){const operationEvents=getOperationEvents(ctx);const operationResults$=operationEvents(idPair,typeName).pipe(mergeMapTo(EMPTY$1));const operationArgs$=operationArgs(ctx,idPair,typeName);const operations$=operationArgs$.pipe(map(createOperationsAPI));ret=concat(of(GUARDED),merge(operationResults$,operations$)).pipe(publishReplay(1),refCount());cache.set(key,ret);}return ret;};const fetch$1=(client,query,params,options)=>defer(()=>client.observable.fetch(query,params,{tag:options.tag,filterResponse:true}));const listen=(client,query,params,options)=>defer(()=>client.listen(query,params,{events:["welcome","mutation","reconnect"],includeResult:false,visibility:"query",tag:options.tag}));function isWelcomeEvent(event){return event.type==="welcome";}const listenQuery=function(client,query){let params=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};let options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};const fetchQuery=typeof query==="string"?query:query.fetch;const listenerQuery=typeof query==="string"?query:query.listen;const fetchOnce$=fetch$1(client,fetchQuery,params,options);const events$=listen(client,listenerQuery,params,options).pipe(mergeMap((ev,i)=>{const isFirst=i===0;if(isFirst&&!isWelcomeEvent(ev)){return throwError(new Error(ev.type==="reconnect"?"Could not establish EventSource connection":"Received unexpected type of first event \"".concat(ev.type,"\"")));}return of(ev);}),share());const[welcome$,mutationAndReconnect$]=partition(events$,isWelcomeEvent);const isRelevantEvent=event=>{if(!options.transitions||event.type!=="mutation"){return true;}return options.transitions.includes(event.transition);};return merge(welcome$.pipe(take(1)),mutationAndReconnect$.pipe(filter(isRelevantEvent),throttleTime(options.throttleTime||1e3,asyncScheduler,{leading:true,trailing:true}))).pipe(exhaustMapToWithTrailing(fetchOnce$));};function resolveTypeForDocument$1(client,id){let specifiedType=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"*";if(specifiedType&&specifiedType!=="*"){return of(specifiedType);}const query="*[_id in [$documentId, $draftId]]._type";const documentId=getPublishedId(id);const draftId=getDraftId(documentId);return client.observable.fetch(query,{documentId,draftId}).pipe(map(types=>types[0]));}function isRecord(value){return isPlainObject(value);}const ALLOWED_REF_PROPS=["_key","_ref","_weak","_type"];function quote(str){return str&&str.length>0?"\"".concat(str,"\""):str;}function validateInitialObjectValue(value,template){const contextError=msg=>"Template \"".concat(template.id,"\" initial value: ").concat(msg);if(!isRecord(value)){throw new Error(contextError("resolved to a non-object"));}if(value._type&&template.schemaType!==value._type){throw new Error(contextError("includes \"_type\"-property (".concat(value._type,") that does not match template (").concat(template.schemaType,")")));}try{return validateValue(value);}catch(err){err.message=contextError(err.message);throw err;}}function validateValue(value){let path=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let parentIsArray=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(Array.isArray(value)){return value.map((item,i)=>{if(Array.isArray(item)){throw new Error("multidimensional arrays are not supported (at path \"".concat(toString(path),"\")"));}return validateValue(item,path.concat(i),true);});}if(!isRecord(value)){return value;}const initial=parentIsArray&&!value._key?{_key:randomKey$1()}:{};if(path.length>0&&!value._type){if(value._ref){initial._type="reference";}}if(value._ref){validateReference(value,path);}return Object.keys(value).reduce((acc,key)=>{acc[key]=validateValue(value[key],path.concat([key]));return acc;},initial);}function validateReference(value){let path=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];if(!value._type&&value.type){throw new Error("Reference is missing \"_type\", but has a \"type\" property at path \"".concat(toString(path),"\""));}const disallowed=Object.keys(value).filter(key=>!ALLOWED_REF_PROPS.includes(key));if(disallowed.length>0){const plural=disallowed.length>1?"properties":"property";throw new Error("Disallowed ".concat(plural," found in reference: ").concat(disallowed.map(quote).join(", ")," at path \"").concat(toString(path),"\""));}}function deepAssign(target,source){const result=_objectSpread(_objectSpread({},target),source);Object.keys(result).forEach(key=>{const sourceVal=source[key];const targetVal=target[key];if(isRecord(sourceVal)&&isRecord(targetVal)){result[key]=deepAssign(targetVal,sourceVal);}});return result;}function isBuilder(template){return isRecord(template)&&typeof template.serialize==="function";}async function resolveValue(initialValueOpt,params,context){return typeof initialValueOpt==="function"?initialValueOpt(params,context):initialValueOpt;}async function resolveInitialValue(schema,template){let params=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};let context=arguments.length>3?arguments[3]:undefined;if(isBuilder(template)){return resolveInitialValue(schema,template.serialize(),params,context);}const{id,schemaType:schemaTypeName,value}=template;if(!value){throw new Error("Template \"".concat(id,"\" has invalid \"value\" property"));}let resolvedValue=await resolveValue(value,params,context);if(!isRecord(resolvedValue)){throw new Error("Template \"".concat(id,"\" has invalid \"value\" property - must be a plain object or a resolver function returning a plain object"));}resolvedValue=validateInitialObjectValue(resolvedValue,template);const schemaType=schema.get(schemaTypeName);if(!schemaType){throw new Error("Could not find schema type with name \"".concat(schemaTypeName,"\"."));}const newValue=deepAssign((await resolveInitialValueForType(schemaType,params,DEFAULT_MAX_RECURSION_DEPTH,context))||{},resolvedValue);return validateInitialObjectValue(newValue,template);}function getItemType$1(arrayType,item){const itemTypeName=resolveTypeName$1(item);return itemTypeName==="object"&&arrayType.of.length===1?arrayType.of[0]:arrayType.of.find(memberType=>memberType.name===itemTypeName);}const DEFAULT_MAX_RECURSION_DEPTH=10;function resolveInitialValueForType(type,params){let maxDepth=arguments.length>2&&arguments[2]!==undefined?arguments[2]:DEFAULT_MAX_RECURSION_DEPTH;let context=arguments.length>3?arguments[3]:undefined;if(maxDepth<=0){return Promise.resolve(void 0);}if(isObjectSchemaType(type)){return resolveInitialObjectValue(type,params,maxDepth,context);}if(isArraySchemaType(type)){return resolveInitialArrayValue(type,params,maxDepth,context);}return resolveValue(type.initialValue,params,context);}async function resolveInitialArrayValue(type,params,maxDepth,context){const initialArray=await resolveValue(type.initialValue,void 0,context);if(!Array.isArray(initialArray)){return void 0;}return Promise.all(initialArray.map(async initialItem=>{const itemType=getItemType$1(type,initialItem);return isObjectSchemaType(itemType)?_objectSpread(_objectSpread(_objectSpread({},initialItem),await resolveInitialValueForType(itemType,params,maxDepth-1,context)),{},{_key:randomKey$1()}):initialItem;}));}async function resolveInitialObjectValue(type,params,maxDepth,context){const initialObject=_objectSpread({},(await resolveValue(type.initialValue,params,context))||{});const fieldValues={};await Promise.all(type.fields.map(async field=>{const initialFieldValue=await resolveInitialValueForType(field.type,params,maxDepth-1,context);if(initialFieldValue!==void 0&&initialFieldValue!==null){fieldValues[field.name]=initialFieldValue;}}));const merged=deepAssign(fieldValues,initialObject);if(isEmpty$3(merged)){return void 0;}if(type.name!=="object"){merged._type=type.name;}return merged;}const LOADING_MSG={type:"loading"};function getInitialValueStream(schema,initialValueTemplates,documentPreviewStore,opts,context){const draft$=documentPreviewStore.observePaths({_type:"reference",_ref:getDraftId(opts.documentId)},["_type"]);const published$=documentPreviewStore.observePaths({_type:"reference",_ref:getPublishedId(opts.documentId)},["_type"]);const value$=merge(draft$.pipe(map(draft=>({draft}))),published$.pipe(map(published=>({published})))).pipe(scan((prev,res)=>_objectSpread(_objectSpread({},prev),res),{}),filter(res=>"draft"in res&&"published"in res),map(res=>res.draft||res.published),distinctUntilChanged((prev,next)=>Boolean(prev)!==Boolean(next)),debounceTime(25));return value$.pipe(switchMap(document=>{if(document){return of({type:"success",value:null});}if(!opts.templateName){return of({isResolving:false,initialValue:void 0});}const template=initialValueTemplates.find(t=>t.id===opts.templateName);if(!template){console.warn('Template "%s" not defined, using empty initial value',opts.templateName);return of({isResolving:false,initialValue:void 0});}const initialValueWithParams$=from(resolveInitialValue(schema,template,opts.templateParams,context)).pipe(map(initialValue=>({isResolving:false,initialValue}))).pipe(catchError(resolveError=>{console.group("Failed to resolve initial value");console.error(resolveError);console.error("Template ID: %s",opts.templateName);console.error("Parameters: %o",opts.templateParams);console.groupEnd();const msg={type:"error",error:resolveError};return of(msg);}));return merge(of({isResolving:true}),initialValueWithParams$).pipe(switchMap(_ref138=>{let{isResolving,initialValue,resolveError}=_ref138;if(resolveError){return of({type:"error",message:"Failed to resolve initial value"});}if(isResolving){return of(LOADING_MSG);}const msg={type:"success",value:initialValue};return of(msg);}));}),startWith(LOADING_MSG),distinctUntilChanged());}function getIdPairFromPublished(publishedId){if(isDraftId(publishedId)){throw new Error("editOpsOf does not expect a draft id.");}return{publishedId,draftId:getDraftId(publishedId)};}function createDocumentStore(_ref139){let{getClient,documentPreviewStore,historyStore,initialValueTemplates,schema}=_ref139;const client=getClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const ctx={client,getClient,documentPreviewStore,historyStore,schema};const caches={pair:{editOperations:/* @__PURE__ */new Map(),editState:/* @__PURE__ */new Map()}};const operationEvents=getOperationEvents(ctx);return{checkoutPair(idPair){return checkoutPair(client,idPair);},initialValue(opts,context){return getInitialValueStream(schema,initialValueTemplates,documentPreviewStore,opts,context);},listenQuery(query,params,options){return listenQuery(client,query,params,options);},resolveTypeForDocument(id,specifiedType){return resolveTypeForDocument$1(client,id,specifiedType);},pair:{consistencyStatus(publishedId,type){return consistencyStatus(ctx.client,getIdPairFromPublished(publishedId),type);},documentEvents(publishedId,type){return documentEvents(ctx.client,getIdPairFromPublished(publishedId));},editOperations(publishedId,type){const cache=caches.pair.editOperations;const key="".concat(publishedId,":").concat(type);const cached=cache.get(key);if(cached){return cached;}const ops=editOperations(ctx,getIdPairFromPublished(publishedId),type);cache.set(key,ops);return ops;},editState(publishedId,type){const cache=caches.pair.editState;const key="".concat(publishedId,":").concat(type);const cached=cache.get(key);if(cached){return cached;}const state=editState(ctx,getIdPairFromPublished(publishedId),type);cache.set(key,state);return state;},operationEvents(publishedId,type){return operationEvents(getIdPairFromPublished(publishedId),type);},validation(publishedId,type){return validation(ctx,getIdPairFromPublished(publishedId),type);}}};}const LOADING_STATE={isLoaded:false,documentType:void 0};function useDocumentType(documentId){let specifiedType=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"*";const documentStore=useDocumentStore();const publishedId=getPublishedId(documentId);const isResolved=Boolean(specifiedType&&specifiedType!=="*");const SYNC_RESOLVED_STATE=useMemo(()=>({documentType:specifiedType,isLoaded:true}),[specifiedType]);const[resolvedState,setDocumentType]=useState(isResolved?SYNC_RESOLVED_STATE:LOADING_STATE);useEffect(()=>setDocumentType(LOADING_STATE),[publishedId,specifiedType]);useEffect(()=>{if(isResolved){return void 0;}const sub=documentStore.resolveTypeForDocument(publishedId,specifiedType).subscribe(documentType=>setDocumentType({documentType,isLoaded:true}));return()=>sub.unsubscribe();},[documentStore,publishedId,specifiedType,isResolved]);return isResolved?SYNC_RESOLVED_STATE:resolvedState;}function useDocumentValues(documentId,paths){const documentPreviewStore=useDocumentPreviewStore();const documentValues$=useMemo(()=>documentId?documentPreviewStore.observePaths({_type:"reference",_ref:documentId},paths):of(void 0),[documentId,documentPreviewStore,paths]);return useLoadable(documentValues$);}const useUserViaUserStore=createHookFromObservableFactory((userStore,userId)=>from(userStore.getUser(userId)));function useUser(userId){const userStore=useUserStore();return useUserViaUserStore(userStore,userId);}function useCurrentUser(){const{currentUser}=useSource();return currentUser;}function createUserStore(_ref140){let{client:_client,currentUser}=_ref140;const client=_client.withConfig({apiVersion:"2021-06-07"});const userLoader=new DataLoader(async userIds=>{const value=await client.request({uri:"/users/".concat(userIds.join(",")),withCredentials:true,tag:"users.get"});const response=Array.isArray(value)?value:[value];const users=response.reduce((acc,next)=>{if(next==null?void 0:next.id){acc[next.id]=next;}return acc;},{});return userIds.map(id=>users[id]||null);},{batchScheduleFn:cb=>raf(cb)});const userFromCurrentUser=currentUser&&{id:currentUser.id,displayName:currentUser.name,imageUrl:currentUser.profileImage};userLoader.prime("me",userFromCurrentUser);if(userFromCurrentUser==null?void 0:userFromCurrentUser.id){userLoader.prime(userFromCurrentUser.id,userFromCurrentUser);}return{getUser:userId=>userLoader.load(userId),getUsers:async userIds=>{const results=await userLoader.loadMany(userIds);return results.filter(result=>isRecord$2(result)&&typeof result.id==="string");}};}function useInitialValue(props){const{documentId,documentType,templateName,templateParams:templateParamsRaw}=props;const templateParams=useUnique(templateParamsRaw);const documentStore=useDocumentStore();const context=useInitialValueResolverContext();const defaultValue=useMemo(()=>({_id:documentId,_type:documentType}),[documentId,documentType]);const[state,setState]=useState({loading:false,error:null,value:defaultValue});useEffect(()=>{const initialValueOptions={documentId,documentType,templateName,templateParams};if(!templateName){setState({loading:true,error:null,value:defaultValue});return void 0;}const initialValueMsg$=documentStore.initialValue(initialValueOptions,context);const sub=initialValueMsg$.subscribe(msg=>{if(msg.type==="loading"){setState({loading:true,error:null,value:defaultValue});}if(msg.type==="success"){setState({loading:false,error:null,value:msg.value?_objectSpread(_objectSpread({},defaultValue),msg.value):defaultValue});}if(msg.type==="error"){setState({loading:false,error:msg.error,value:defaultValue});}});setState({loading:true,error:null,value:defaultValue});return()=>sub.unsubscribe();},[defaultValue,documentId,documentStore,documentType,templateName,templateParams,context]);return state;}function useInitialValueResolverContext(){const source=useSource();const schema=useSchema();const currentUser=useCurrentUser();const projectId=useProjectId();const dataset=useDataset();const getClient=source.getClient;return useMemo(()=>{return{projectId,dataset,getClient,schema,currentUser};},[getClient,schema,currentUser,projectId,dataset]);}function useResolveInitialValueForType(){const initialValueContext=useInitialValueResolverContext();return useCallback((type,params)=>{return resolveInitialValueForType(type,params,DEFAULT_MAX_RECURSION_DEPTH,initialValueContext);},[initialValueContext]);}function getSchemaType(schema,typeName){const type=schema.get(typeName);if(!type){throw new Error("No such schema type: ".concat(typeName));}return type;}function getPairPermissions(_ref141){let{grantsStore,permission,draft,published,liveEdit}=_ref141;const effectiveVersion=draft||published;const effectiveVersionType=effectiveVersion===draft?"draft":"published";const{checkDocumentPermission}=grantsStore;switch(permission){case"delete":{if(liveEdit){return[["delete published document (live-edit)",checkDocumentPermission("update",published)]];}return[["delete draft document",checkDocumentPermission("update",draft)],["delete published document",checkDocumentPermission("update",published)]];}case"discardDraft":{if(liveEdit)return[];return[["delete draft document",checkDocumentPermission("update",draft)]];}case"publish":{if(liveEdit)return[];return[["update published document at its current state",checkDocumentPermission("update",published)],["delete draft document",checkDocumentPermission("update",draft)],["create published document from draft",checkDocumentPermission("create",draft&&_objectSpread(_objectSpread({},draft),{},{_id:getPublishedId(draft._id)}))]];}case"unpublish":{if(liveEdit)return[];return[["update draft document at its current state",checkDocumentPermission("create",draft)],["delete published document",checkDocumentPermission("update",published)],["create draft document from published version",checkDocumentPermission("create",published&&_objectSpread(_objectSpread({},published),{},{_id:getDraftId(published._id)}))]];}case"update":{if(liveEdit){return[["update published document (live-edit)",checkDocumentPermission("update",published)]];}return[["update ".concat(effectiveVersionType," document"),checkDocumentPermission("update",effectiveVersion)]];}case"duplicate":{if(liveEdit){return[["create new published document from existing document (live-edit)",checkDocumentPermission("create",_objectSpread(_objectSpread({},published),{},{_id:"dummy-id"}))]];}return[["create new draft document from existing ".concat(effectiveVersionType," document"),checkDocumentPermission("create",_objectSpread(_objectSpread({},effectiveVersion),{},{_id:getDraftId("dummy-id")}))]];}default:{throw new Error("Could not match permission: ".concat(permission));}}}function getDocumentPairPermissions(_ref142){let{client,grantsStore,schema,id,permission,type}=_ref142;if(type==="*"){return of({granted:false,reason:"Type specified was `*`"});}const liveEdit=Boolean(getSchemaType(schema,type).liveEdit);return snapshotPair(client,{draftId:getDraftId(id),publishedId:getPublishedId(id)},type).pipe(switchMap(pair=>combineLatest([pair.draft.snapshots$,pair.published.snapshots$]).pipe(map(_ref143=>{let[draft,published]=_ref143;return{draft,published};}))),switchMap(_ref144=>{let{draft,published}=_ref144;const pairPermissions=getPairPermissions({grantsStore,permission,draft,published,liveEdit}).map(_ref145=>{let[label,observable]=_ref145;return observable.pipe(map(_ref146=>{let{granted,reason}=_ref146;return{granted,reason:granted?"":"not allowed to ".concat(label,": ").concat(reason),label,permission};}));});if(!pairPermissions.length)return of({granted:true,reason:""});return combineLatest(pairPermissions).pipe(map(permissionResults=>{const granted=permissionResults.every(permissionResult=>permissionResult.granted);const reason=granted?"":"Unable to ".concat(permission,":\n\t").concat(permissionResults.filter(permissionResult=>!permissionResult.granted).map(permissionResult=>permissionResult.reason).join("\n	"));return{granted,reason};}));}));}const useDocumentPairPermissionsFromHookFactory=createHookFromObservableFactory(getDocumentPairPermissions);function useDocumentPairPermissions(_ref147){let{id,type,permission}=_ref147,rest=_objectWithoutProperties(_ref147,_excluded26);const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const schema=useSchema();const grantsStore=useGrantsStore();return useDocumentPairPermissionsFromHookFactory({client:rest.client||client,grantsStore:rest.grantsStore||grantsStore,schema:rest.schema||schema,id,permission,type});}function getDocumentValuePermissions(_ref148){let{grantsStore,document,permission}=_ref148;const{checkDocumentPermission}=grantsStore;return checkDocumentPermission(permission,document);}const useDocumentValuePermissionsFromHookFactory=createHookFromObservableFactory(getDocumentValuePermissions);function useDocumentValuePermissions(_ref149){let{document,permission}=_ref149,rest=_objectWithoutProperties(_ref149,_excluded27);const grantsStore=useGrantsStore();return useDocumentValuePermissionsFromHookFactory({grantsStore:rest.grantsStore||grantsStore,document,permission});}function serialize$2(item){if(item&&"serialize"in item)return serialize$2(item.serialize());return item;}function getTemplatePermissions(_ref150){let{grantsStore,templateItems,templates,schema,context}=_ref150;if(!(templateItems==null?void 0:templateItems.length))return of([]);return combineLatest(templateItems.map(serialize$2).map(async item=>{const template=templates.find(t=>t.id===item.templateId);if(!template){throw new Error("template not found: \"".concat(item.templateId,"\""));}const resolvedInitialValue=await resolveInitialValue(schema,template,item.parameters,context);return{template,item,resolvedInitialValue};}).map(promise=>from(promise).pipe(switchMap(_ref151=>{let{item,resolvedInitialValue,template}=_ref151;const schemaType=schema.get(template.schemaType);if(!schemaType){throw new Error("schema type not found: \"".concat(template.schemaType,"\""));}const liveEdit=schemaType==null?void 0:schemaType.liveEdit;const{initialDocumentId="dummy-id"}=item;return getDocumentValuePermissions({grantsStore,permission:"create",document:_objectSpread({_id:liveEdit?getPublishedId(initialDocumentId):getDraftId(initialDocumentId)},resolvedInitialValue)}).pipe(map(_ref152=>{let{granted,reason}=_ref152;const title=item.title||template.title;const result=_objectSpread(_objectSpread({},item),{},{granted,reason,resolvedInitialValue,template,title,subtitle:schemaType.title===title?void 0:schemaType.title,description:item.description||template.description,icon:item.icon||template.icon});return result;}));}))));}const useTemplatePermissionsFromHookFactory=createHookFromObservableFactory(getTemplatePermissions);function useTemplatePermissions(_ref153){let{templateItems}=_ref153,rest=_objectWithoutProperties(_ref153,_excluded28);const schema=useSchema();const templates=useTemplates();const grantsStore=useGrantsStore();const initialValueContext=useInitialValueResolverContext();return useTemplatePermissionsFromHookFactory({templateItems,grantsStore:rest.grantsStore||grantsStore,schema:rest.schema||schema,templates:rest.templates||templates,context:initialValueContext});}const DEBUG_PREFIX="_debug_";const hashchange$=typeof window==="undefined"?of({}):fromEvent(window,"hashchange");const debugParams$=concat(of(0),hashchange$).pipe(map(()=>typeof document==="undefined"?"#":document.location.hash),distinctUntilChanged(),map(hash=>hash.substring(1).split(";").filter(p=>p.toLowerCase().startsWith(DEBUG_PREFIX)).map(param=>param.substring(DEBUG_PREFIX.length))));const debugRolesParam$=debugParams$.pipe(map(args=>args.find(arg=>arg.startsWith("roles="))),map(arg=>(arg==null?void 0:arg.split("roles=")[1].split(",").map(r=>r.trim()))||[]));const administrator=[{filter:'_id in path("**")',permissions:["read","create","history","update"]}];const editor=[{filter:'_id in path("**")',permissions:["read","create","history","update"]}];const developer=[{filter:'_id in path("**")',permissions:["read","create","history","update"]}];const contributor=[{filter:'_id in path("**")',permissions:["read"]},{filter:'_id in path("drafts.**")',permissions:["create","history","update"]}];const viewer=[{filter:'_id in path("**")',permissions:["read","history"]}];const requiresApproval=[{filter:"!locked",permissions:["read","create","update"]}];const restricted=[{filter:'_id in path("drafts.**") && _type in ["stringsTest", "book", "author", "referenceTest"]',permissions:["read","create","history","update"]},{filter:'_id in path("**")',permissions:["read"]}];const DEBUG_ROLE_GRANTS_MAP={administrator:administrator,editor:editor,developer:developer,contributor:contributor,viewer:viewer,restricted:restricted,requiresApproval:requiresApproval,read:viewer,write:editor};const debugGrants$=debugRolesParam$.pipe(map(roles=>{if(!roles.length)return null;return roles.filter(value=>Boolean(value)&&value in DEBUG_ROLE_GRANTS_MAP).flatMap(roleName=>DEBUG_ROLE_GRANTS_MAP[roleName]||[]);}));async function getDatasetGrants(client,projectId,dataset){const grants=await client.request({uri:"/projects/".concat(projectId,"/datasets/").concat(dataset,"/acl"),tag:"acl.get",withCredentials:true});return grants;}function getParams(currentUser){const params={};if(currentUser!==null){params.identity=currentUser.id;}return params;}const PARSED_FILTERS_MEMO=/* @__PURE__ */new Map();async function matchesFilter(currentUser,filter,document){if(!PARSED_FILTERS_MEMO.has(filter)){PARSED_FILTERS_MEMO.set(filter,parse("*[".concat(filter,"]")));}const parsed=PARSED_FILTERS_MEMO.get(filter);const params=getParams(currentUser);const data=await(await evaluate(parsed,{dataset:[document],params})).get();return(data==null?void 0:data.length)===1;}function createGrantsStore(_ref154){let{client,currentUser}=_ref154;const versionedClient=client.withConfig({apiVersion:"2021-06-07"});const datasetGrants$=defer(()=>of(versionedClient.config())).pipe(switchMap(_ref155=>{let{projectId,dataset}=_ref155;if(!projectId||!dataset){throw new Error("Missing projectId or dataset");}return getDatasetGrants(versionedClient,projectId,dataset);}));const currentUserDatasetGrants=debugGrants$.pipe(switchMap(debugGrants=>debugGrants?of(debugGrants):datasetGrants$),publishReplay(1),refCountDelay(1e3));return{checkDocumentPermission(permission,document){return currentUserDatasetGrants.pipe(switchMap(grants=>grantsPermissionOn(currentUser,grants,permission,document)),distinctUntilChanged(shallowEquals));}};}async function grantsPermissionOn(currentUser,grants,permission,document){if(!document){return{granted:true,reason:"Null document, nothing to check"};}if(!grants.length){return{granted:false,reason:"No document grants"};}const matchingGrants=[];for(const grant of grants){if(await matchesFilter(currentUser,grant.filter,document)){matchingGrants.push(grant);}}const foundMatch=matchingGrants.some(grant=>grant.permissions.some(p=>p===permission));return{granted:foundMatch,reason:foundMatch?"Matching grant":"No matching grants found"};}async function getJsonStream(url,token){const options=token?{headers:{Authorization:"Bearer ".concat(token)}}:{credentials:"include"};const response=await fetch(url,options);return getStream(response);}function getStream(response){const body=response.body;if(!body){throw new Error("Failed to read body from response");}let reader;let cancelled=false;return new ReadableStream({start(controller){reader=body.getReader();const decoder=new TextDecoder();let buffer="";reader.read().then(function processResult(result){if(result.done){if(cancelled){return;}buffer=buffer.trim();if(buffer.length===0){controller.close();return;}controller.enqueue(JSON.parse(buffer));controller.close();return;}buffer+=decoder.decode(result.value,{stream:true});const lines=buffer.split("\n");for(let i=0;i<lines.length-1;++i){const line=lines[i].trim();if(line.length===0){continue;}try{controller.enqueue(JSON.parse(line));}catch(err){controller.error(err);cancelled=true;reader.cancel();return;}}buffer=lines[lines.length-1];return reader.read().then(processResult).catch(err=>controller.error(err));}).catch(err=>controller.error(err));},cancel(){cancelled=true;reader.cancel();}});}function emptyVersionState(id){return{id,hasAttrs:false,attrs:null,rev:null,events:[],aligned:false};}function align(history,state){const idx=state.events.findIndex(evt=>history.id===evt.transactionId);if(idx>=0){return idx+1;}if(state.rev){return state.rev===history.id?0:-1;}return 0;}function startFromSnapshot(state,doc){state.hasAttrs=true;if(doc){state.attrs=_objectSpread({},doc);if(typeof state.attrs._rev!="string")throw new Error("snapshot has no _rev");state.rev=state.attrs._rev;delete state.attrs._rev;}else{state.attrs=null;state.rev=null;}state.events=[];}class Aligner{constructor(timeline){this.earliestTransactionId=null;this.timeline=timeline;this._states={draft:emptyVersionState(timeline.draftId),published:emptyVersionState(timeline.publishedId)};}appendRemoteSnapshotEvent(evt){const state=this._states[evt.version];if(evt.type==="snapshot"){this._maybeInvalidateHistory();startFromSnapshot(state,evt.document);return;}if(evt.type==="remoteMutation"){if(state.aligned){this._apply(state,evt);this.timeline.addRemoteMutation(evt);}else if(state.hasAttrs){state.events.push(evt);}else{startFromSnapshot(state,evt.head);}}}prependHistoryEvent(evt){if(!this.acceptsHistory)throw new Error("cannot prepend history at this point");for(const state of Object.values(this._states)){if(!state.aligned){const idx=align(evt,state);if(idx>=0){this._alignAtIndex(state,idx);}}}this.timeline.addTranslogEntry(evt);this.earliestTransactionId=evt.id;}didReachEarliestEntry(){for(const state of Object.values(this._states)){if(!state.aligned){if(state.attrs!==null)throw new Error("unable to find translog entry to align to");this._alignAtIndex(state,0);}}this.timeline.didReachEarliestEntry();}get isAligned(){return Object.values(this._states).every(state=>state.aligned);}get acceptsHistory(){return this._isComplete;}get currentDocument(){return{draft:this._states.draft.attrs,published:this._states.published.attrs};}_alignAtIndex(state,idx){for(const mutEvt of state.events.slice(0,idx)){this._apply(state,mutEvt);}for(const mutEvt of state.events.slice(idx)){this._apply(state,mutEvt);this.timeline.addRemoteMutation(mutEvt);}state.events=[];state.aligned=true;}get _isComplete(){return Object.values(this._states).every(state=>state.hasAttrs);}_apply(state,evt){state.attrs=applyPatch$1(state.attrs,evt.effects.apply);state.rev=evt.transactionId;}_maybeInvalidateHistory(){if(this._isComplete){for(const state of Object.values(this._states)){state.aligned=false;}this.earliestTransactionId=null;this.timeline.reset();}}}class Reconstruction{constructor(timeline,doc,start,end){this.timeline=timeline;this.start=start;this.end=end;this.doc=doc;}same(start,end){return this.start===start&&this.end===end;}endAttributes(){return getAttrs$1(this.endDocument());}endDocument(){if(!this._endDocument){this._endDocument=this.timeline.replayBackwardsUntil(this.end.end,this.doc);}return this._endDocument;}startAttributes(){return getAttrs$1(this.startDocument());}startDocument(){if(!this.start)throw new Error("start required");if(!this._startDocument){this._startDocument=this.timeline.replayBackwardsBetween(this.start.end,this.end.end-1,this.endDocument());}return this._startDocument;}diff(){if(!this._diff){if(!this.start)throw new Error("start required");this._diff=this.timeline.calculateDiff(this.startDocument(),this.endDocument(),this.start.index+1,this.end.index);}return this._diff;}}function getAttrs$1(doc){return doc.draft||doc.published;}const TRANSLOG_ENTRY_LIMIT=50;class TimelineController{constructor(options){this.version=0;this.selectionState="inactive";this._fetchMore=false;this._fetchAtLeast=0;this._isRunning=false;this._didErr=false;this._since=null;this._sinceTime=null;this._rev=null;this._revTime=null;this.timeline=options.timeline;this.client=options.client;this.handler=options.handler;this._aligner=new Aligner(this.timeline);this.markChange();}clearRange(){this.setRange(null,null);}setRange(since,rev){if(rev!==this._rev)this.setRevTime(rev);if(since!==this._since)this.setSinceTime(since);let _fetchAtLeast=10;if(this._sinceTime==="loading"||this._revTime==="loading"||!this._aligner.isAligned){this.selectionState="loading";}else if(this._sinceTime==="invalid"||this._revTime==="invalid"){this.selectionState="invalid";}else if(this._sinceTime){this.selectionState="range";const targetRev=this._revTime||this.timeline.lastChunk();if(this._sinceTime.index>targetRev.index){this._revTime="invalid";this.selectionState="invalid";}else{this.setReconstruction(this._sinceTime,targetRev);}}else if(this._revTime){this.selectionState="rev";this.setReconstruction(null,this._revTime);}else{this.selectionState="inactive";_fetchAtLeast=0;}this._fetchAtLeast=_fetchAtLeast;this.start();}setLoadMore(flag){this._fetchMore=flag;this.start();}get sinceTime(){return this._sinceTime&&typeof this._sinceTime==="object"?this._sinceTime:null;}get revTime(){return this._revTime&&typeof this._revTime==="object"?this._revTime:null;}get realRevChunk(){return this.revTime||this.timeline.lastChunk();}onOlderRevision(){return Boolean(this._rev)&&(this.selectionState==="range"||this.selectionState==="rev");}changesPanelActive(){return Boolean(this._since)&&this.selectionState==="range";}findRangeForNewRev(rev){const revTimeId=this.timeline.isLatestChunk(rev)?null:this.timeline.createTimeId(rev);if(!this._since){return[null,revTimeId];}const sinceChunk=this.sinceTime;if(sinceChunk&&sinceChunk.index<rev.index){return[this._since,revTimeId];}return["@lastPublished",revTimeId];}findRangeForNewSince(since){const revChunk=this.revTime;if(revChunk&&since.index<revChunk.index){return[this.timeline.createTimeId(since),this._rev];}return[this.timeline.createTimeId(since),null];}setRevTime(rev){this._rev=rev;this._revTime=rev?this.timeline.parseTimeId(rev):null;if(this._since==="@lastPublished"){this._since=null;this._sinceTime=null;}}setSinceTime(since){if(since==="@lastPublished"){if(typeof this._revTime==="string"){this._sinceTime=this._revTime;}else{this._sinceTime=this.timeline.findLastPublishedBefore(this._revTime);}}else{this._sinceTime=since?this.timeline.parseTimeId(since):null;}this._since=since;}sinceAttributes(){return this._sinceTime&&this._reconstruction?this._reconstruction.startAttributes():null;}displayed(){return this._revTime&&this._reconstruction?this._reconstruction.endAttributes():null;}setReconstruction(since,rev){if(this._reconstruction&&this._reconstruction.same(since,rev))return;this._reconstruction=new Reconstruction(this.timeline,this._aligner.currentDocument,since,rev);}currentDiff(){return this._reconstruction?this._reconstruction.diff():null;}currentObjectDiff(){const diff=this.currentDiff();if(diff){if(diff.type==="null")return null;if(diff.type!=="object")throw new Error("ObjectDiff expected, got ".concat(diff.type));}return diff;}handleRemoteMutation(ev){this._aligner.appendRemoteSnapshotEvent(ev);this.markChange();if(this._aligner.acceptsHistory)this.start();}start(){if(this._didErr)return;if(!this._isRunning){this._isRunning=true;this.tick().then(()=>{this._isRunning=false;});}}async tick(){const shouldFetchMore=this._aligner.acceptsHistory&&!this.timeline.reachedEarliestEntry&&(this.selectionState==="loading"||this._fetchMore||this.timeline.chunkCount<=this._fetchAtLeast);if(!shouldFetchMore){return;}try{await this.fetchMoreTransactions();}catch(err){this._didErr=true;this.handler(err,this);return;}await this.tick();}async fetchMoreTransactions(){const publishedId=this.timeline.publishedId;const draftId=this.timeline.draftId;const{dataset,token}=this.client.config();const limit=TRANSLOG_ENTRY_LIMIT;let queryParams="tag=sanity.studio.desk.history&effectFormat=mendoza&excludeContent=true&excludeMutations=true&includeIdentifiedDocumentsOnly=true&reverse=true&limit=".concat(limit);let tid=this._aligner.earliestTransactionId;if(tid){queryParams+="&toTransaction=".concat(tid);}const url="/data/history/".concat(dataset,"/transactions/").concat(publishedId,",").concat(draftId,"?").concat(queryParams);const stream=await getJsonStream(this.client.getUrl(url),token);const reader=stream.getReader();let count=0;for(;;){const result=await reader.read();if(result.done)break;if("error"in result.value){throw new Error(result.value.error.description||result.value.error.type);}count++;if(result.value.id===tid){continue;}if(this._aligner.earliestTransactionId!==tid||!this._aligner.acceptsHistory){return;}this._aligner.prependHistoryEvent(result.value);tid=this._aligner.earliestTransactionId;}if(this._aligner.earliestTransactionId!==tid||!this._aligner.acceptsHistory){return;}if(count<limit){this._aligner.didReachEarliestEntry();}this.markChange();}markChange(){this.timeline.updateChunks();this.setRevTime(this._rev);this.setSinceTime(this._rev);this.version++;this.handler(null,this);}}function createObservableController(options){return new Observable(observer=>{const controller=new TimelineController(_objectSpread(_objectSpread({},options),{},{handler:(err,innerController)=>{if(err){observer.error(err);}else{observer.next({historyController:innerController});}}}));return remoteSnapshots(options.client,{publishedId:options.documentId,draftId:"drafts.".concat(options.documentId)},options.documentType).subscribe(ev=>{controller.handleRemoteMutation(ev);});});}function isSameAnnotation(a,b){if(a&&b){return a.author===b.author&&a.chunk===b.chunk;}if(!a&&!b){return true;}return false;}function getAttrs(doc){return doc.draft||doc.published;}class ArrayContentWrapper{constructor(content,value,annotation,extractor){this.type="array";this.elements=[];this.content=content;this.value=value;this.annotation=annotation;this.extractor=extractor;this.length=content.elements.length;}at(idx){if(idx>=this.length)throw new Error("out of bounds");const input=this.elements[idx];if(input){return input;}return this.elements[idx]=wrapValue(this.content.elements[idx],this.value[idx],this.extractor);}annotationAt(idx){const meta=this.content.metas[idx];return this.extractor.fromMeta(meta);}}class ObjectContentWrapper{constructor(content,value,annotation,extractor){this.type="object";this.fields={};this.content=content;this.value=value;this.annotation=annotation;this.extractor=extractor;this.keys=Object.keys(content.fields);}get(key){const input=this.fields[key];if(input){return input;}const value=this.content.fields[key];if(!value)return void 0;return this.fields[key]=wrapValue(value,this.value[key],this.extractor);}}class StringContentWrapper{constructor(content,value,annotation,extractor){this.type="string";this.content=content;this.value=value;this.annotation=annotation;this.extractor=extractor;}sliceAnnotation(start,end){const result=[];let idx=0;function push(text,annotation){if(result.length>0){const lst=result[result.length-1];if(isSameAnnotation(lst.annotation,annotation)){lst.text+=text;return;}}result.push({text,annotation});}for(const part of this.content.parts){const length=part.value.length;const subStart=Math.max(0,start-idx);if(subStart<length){const subEnd=Math.min(length,end-idx);if(subEnd<=0)break;push(part.value.slice(subStart,subEnd),this.extractor.fromValue(part));}idx+=length;}return result;}}function wrapValue(value,raw,extractor){const annotation=extractor.fromValue(value);if(value.content){switch(value.content.type){case"array":return new ArrayContentWrapper(value.content,raw,annotation,extractor);case"object":return new ObjectContentWrapper(value.content,raw,annotation,extractor);case"string":return new StringContentWrapper(value.content,raw,annotation,extractor);}}return wrap$1(raw,annotation);}function extractAnnotationForFromInput(timeline,firstChunk,meta){if(meta){return annotationForTransactionIndex(timeline,meta.transactionIndex+1,meta.chunk.index);}else if(firstChunk){return annotationForTransactionIndex(timeline,firstChunk.start,firstChunk.index);}return null;}function extractAnnotationForToInput(timeline,meta){if(meta){return annotationForTransactionIndex(timeline,meta.transactionIndex,meta.chunk.index);}return null;}function annotationForTransactionIndex(timeline,idx,chunkIdx){const tx=timeline.transactionByIndex(idx);if(!tx)return null;const chunk=timeline.chunkByTransactionIndex(idx,chunkIdx);if(!chunk)return null;return{chunk,timestamp:tx.timestamp,author:tx.author};}function diffValue(timeline,firstChunk,from,fromRaw,to,toRaw){const fromInput=wrapValue(from,fromRaw,{fromValue(value){return extractAnnotationForFromInput(timeline,firstChunk,value.endMeta);},fromMeta(meta){return extractAnnotationForFromInput(timeline,firstChunk,meta);}});const toInput=wrapValue(to,toRaw,{fromValue(value){return extractAnnotationForToInput(timeline,value.startMeta);},fromMeta(meta){return extractAnnotationForToInput(timeline,meta);}});return diffInput(fromInput,toInput);}class TwoEndedArray{constructor(){this._postive=[];this._negative=[];}addToEnd(elem){elem.index=this._postive.length;this._postive.push(elem);}addToBeginning(elem){if(this.length==0){this.addToEnd(elem);return;}elem.index=-(this._negative.length+1);this._negative.push(elem);}mergeAtEnd(value,merger){if(this.length===0){this.addToEnd(value);return;}const idx=this.lastIdx;const result=merger(this.get(idx),value);if(Array.isArray(result)){this.set(idx,result[0]);this.addToEnd(result[1]);}else{this.set(idx,result);}}mergeAtBeginning(value,merger){if(this.length===0){this.addToEnd(value);return;}const idx=this.firstIdx;const result=merger(value,this.get(idx));if(Array.isArray(result)){this.set(idx,result[1]);this.addToBeginning(result[0]);}else{this.set(idx,result);}}removeFromEnd(){if(this._postive.length===0){this._negative.shift();}else{this._postive.pop();}}has(idx){if(idx>=0){return idx<this._postive.length;}return-(idx+1)<this._negative.length;}get(idx){if(idx>=0){return this._postive[idx];}return this._negative[-(idx+1)];}set(idx,value){if(idx>=0){value.index=idx;this._postive[idx]=value;}else{value.index=idx;this._negative[-(idx+1)]=value;}}get lastIdx(){return this._postive.length-1;}get last(){return this.get(this.lastIdx);}get firstIdx(){return-this._negative.length;}get first(){return this.get(this.firstIdx);}get length(){return this._postive.length+this._negative.length;}}function canMergeEdit(type){return type==="create"||type==="editDraft";}const CHUNK_WINDOW=5*60*1e3;function isWithinMergeWindow(a,b){return Date.parse(b)-Date.parse(a)<CHUNK_WINDOW;}function mergeChunk(left,right){if(left.end!==right.start)throw new Error("chunks are not next to each other");const draftState=combineState(left.draftState,right.draftState);const publishedState=combineState(left.publishedState,right.publishedState);if(left.type==="delete"&&right.type==="editDraft"){return[left,_objectSpread(_objectSpread({},right),{},{type:"create",draftState,publishedState})];}if(right.type==="delete"){if(draftState==="missing"&&publishedState==="present"){return[left,_objectSpread(_objectSpread({},right),{},{type:"discardDraft",draftState,publishedState})];}if(draftState==="present"&&publishedState==="missing"){return[left,_objectSpread(_objectSpread({},right),{},{type:"unpublish",draftState,publishedState})];}}if(canMergeEdit(left.type)&&right.type==="editDraft"&&isWithinMergeWindow(left.endTimestamp,right.startTimestamp)){const authors=/* @__PURE__ */new Set();for(const author of left.authors)authors.add(author);for(const author of right.authors)authors.add(author);return{index:0,id:right.id,type:left.type,start:left.start,end:right.end,startTimestamp:left.startTimestamp,endTimestamp:right.endTimestamp,authors,draftState,publishedState};}return[left,_objectSpread(_objectSpread({},right),{},{draftState,publishedState})];}function getChunkState(effect){const modified=Boolean(effect);const deleted=effect&&isDeletePatch(effect==null?void 0:effect.apply);if(deleted){return"deleted";}if(modified){return"upsert";}return"unedited";}function getChunkType(transaction){const draftState=getChunkState(transaction.draftEffect);const publishedState=getChunkState(transaction.publishedEffect);if(publishedState==="unedited"){if(draftState==="deleted"){return"delete";}if(draftState==="upsert"){return"editDraft";}}if(publishedState==="deleted"){return"delete";}if(publishedState==="upsert"){if(draftState==="unedited"){return"editLive";}if(draftState==="deleted"){return"publish";}if(draftState==="upsert"){return"editLive";}}return"editLive";}function chunkFromTransaction(transaction){const modifiedDraft=Boolean(transaction.draftEffect);const modifiedPublished=Boolean(transaction.publishedEffect);const draftDeleted=transaction.draftEffect&&isDeletePatch(transaction.draftEffect.apply);const publishedDeleted=transaction.publishedEffect&&isDeletePatch(transaction.publishedEffect.apply);const type=getChunkType(transaction);return{index:0,id:transaction.id,type,start:transaction.index,end:transaction.index+1,startTimestamp:transaction.timestamp,endTimestamp:transaction.timestamp,authors:/* @__PURE__ */new Set([transaction.author]),draftState:modifiedDraft?draftDeleted?"missing":"present":"unknown",publishedState:modifiedPublished?publishedDeleted?"missing":"present":"unknown"};}function combineState(left,right){return right==="unknown"?left:right;}function isDeletePatch(patch){return patch[0]===0&&patch[1]===null;}class Timeline$1{constructor(opts){this.reachedEarliestEntry=false;this._transactions=new TwoEndedArray();this._chunks=new TwoEndedArray();this._possiblePendingTransactions=/* @__PURE__ */new Map();this.publishedId=opts.publishedId;this.draftId="drafts.".concat(opts.publishedId);if(opts.enableTrace){this._trace=[];this._trace.push({type:"initial",publishedId:opts.publishedId});window.__sanityTimelineTrace=this._trace;}}get chunkCount(){return this._chunks.length;}mapChunks(mapper){const result=[];const firstIdx=this._chunks.firstIdx;const lastIdx=this._chunks.lastIdx;for(let idx=lastIdx;idx>=firstIdx;idx--){result.push(mapper(this._chunks.get(idx),idx));}return result;}reset(){this._transactions=new TwoEndedArray();this._chunks=new TwoEndedArray();this._possiblePendingTransactions=/* @__PURE__ */new Map();this._recreateTransactionsFrom=void 0;this.reachedEarliestEntry=false;}addRemoteMutation(entry){if(this._trace)this._trace.push({type:"addRemoteMutation",event:entry});const pending=this._possiblePendingTransactions.get(entry.transactionId);const transaction=pending?pending.transaction:{index:0,id:entry.transactionId,timestamp:entry.timestamp.toISOString(),author:entry.author};if(entry.version==="draft"){transaction.draftEffect=entry.effects;}else{transaction.publishedEffect=entry.effects;}if(pending){this._possiblePendingTransactions.delete(entry.transactionId);this._invalidateTransactionFrom(pending.idx);}else{this._transactions.addToEnd(transaction);this._possiblePendingTransactions.set(entry.transactionId,{transaction,idx:this._transactions.lastIdx});}}addTranslogEntry(event){if(this._trace)this._trace.push({type:"addTranslogEntry",event});this._transactions.addToBeginning({index:0,id:event.id,author:event.author,timestamp:event.timestamp,draftEffect:event.effects[this.draftId],publishedEffect:event.effects[this.publishedId]});}didReachEarliestEntry(){if(this._trace)this._trace.push({type:"didReachEarliestEntry"});this.reachedEarliestEntry=true;}updateChunks(){if(this._trace)this._trace.push({type:"updateChunks"});this._removeInvalidatedChunks();this._addChunksFromTransactions();this._createInitialChunk();}_removeInvalidatedChunks(){if(this._recreateTransactionsFrom){while(this._chunks.length>0){const chunk=this._chunks.last;if(this._recreateTransactionsFrom<chunk.end){this._chunks.removeFromEnd();}else{break;}}this._recreateTransactionsFrom=void 0;}}_addChunksFromTransactions(){const firstIdx=this._transactions.firstIdx;const lastIdx=this._transactions.lastIdx;const nextTransactionToChunk=this._chunks.length>0?this._chunks.last.end:firstIdx;for(let idx=nextTransactionToChunk;idx<=lastIdx;idx++){const transaction=this._transactions.get(idx);this._chunks.mergeAtEnd(chunkFromTransaction(transaction),mergeChunk);}if(this._chunks.length==0)return;const firstTransactionChunked=this._chunks.first.start;for(let idx=firstTransactionChunked-1;idx>=firstIdx;idx--){const transaction=this._transactions.get(idx);this._chunks.mergeAtBeginning(chunkFromTransaction(transaction),mergeChunk);}}_invalidateTransactionFrom(idx){if(this._recreateTransactionsFrom===void 0||idx<this._recreateTransactionsFrom){this._recreateTransactionsFrom=idx;}}_createInitialChunk(){var _a;if(this.reachedEarliestEntry){if(((_a=this._chunks.first)==null?void 0:_a.type)==="initial")return;const firstTx=this._transactions.first;if(!firstTx)return;const initialChunk=chunkFromTransaction(firstTx);initialChunk.type="initial";initialChunk.id="@initial";initialChunk.end=initialChunk.start;this._chunks.addToBeginning(initialChunk);}}parseTimeId(id){if(this._chunks.length===0){return this.reachedEarliestEntry?"invalid":"loading";}const[timestampStr,chunkId]=id.split("/",3);const timestamp=Number(timestampStr);for(let idx=this._chunks.lastIdx;idx>=this._chunks.firstIdx;idx--){const chunk=this._chunks.get(idx);if(chunk.id===chunkId){return chunk;}if(Date.parse(chunk.endTimestamp)+60*60*1e3<timestamp){return"invalid";}}return this.reachedEarliestEntry?"invalid":"loading";}findLastPublishedBefore(chunk){for(let chunkIdx=chunk?chunk.index-1:this._chunks.lastIdx;chunkIdx>=this._chunks.firstIdx;chunkIdx--){const currentChunk=this._chunks.get(chunkIdx);if(currentChunk.type==="publish"||currentChunk.type==="initial"){return currentChunk;}}if(!this.reachedEarliestEntry)return"loading";return this._chunks.first;}isLatestChunk(chunk){return chunk===this._chunks.last;}createTimeId(chunk){return"".concat(chunk.endTimestamp.valueOf(),"/").concat(chunk.id);}lastChunk(){return this._chunks.last;}transactionByIndex(idx){if(!this._transactions.has(idx))return null;return this._transactions.get(idx);}chunkByTransactionIndex(idx){let startChunkIdx=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;let chunkIdx=startChunkIdx;for(;;){const chunk=this._chunks.get(chunkIdx);if(!chunk)throw new Error("transaction does not belong in any chunk");if(idx>=chunk.end){chunkIdx++;}else if(idx<chunk.start){chunkIdx--;}else{return chunk;}}}replayBackwardsBetween(firstIdx,lastIdx,doc){let draft=doc.draft;let published=doc.published;for(let idx=lastIdx;idx>=firstIdx;idx--){const transaction=this._transactions.get(idx);if(transaction.draftEffect){draft=applyPatch$1(draft,transaction.draftEffect.revert);}if(transaction.publishedEffect){published=applyPatch$1(published,transaction.publishedEffect.revert);}}return{draft,published};}replayBackwardsUntil(firstIdx,doc){return this.replayBackwardsBetween(firstIdx,this._transactions.lastIdx,doc);}calculateDiff(initialDoc,finalDoc,firstIdx,lastIdx){let draftValue=incremental.wrap(initialDoc.draft,null);let publishedValue=incremental.wrap(initialDoc.published,null);const initialValue=getValue(draftValue,publishedValue);const initialAttributes=getAttrs(initialDoc);let firstChunk=null;for(let chunkIdx=firstIdx;chunkIdx<=lastIdx;chunkIdx++){const chunk=this._chunks.get(chunkIdx);if(!firstChunk)firstChunk=chunk;for(let idx=chunk.start;idx<chunk.end;idx++){const transaction=this._transactions.get(idx);const meta={chunk,transactionIndex:idx};const preDraftValue=draftValue;const prePublishedValue=publishedValue;if(transaction.draftEffect){draftValue=incremental.applyPatch(draftValue,transaction.draftEffect.apply,meta);}if(transaction.publishedEffect){publishedValue=incremental.applyPatch(publishedValue,transaction.publishedEffect.apply,meta);}const didHaveDriaft=incremental.getType(preDraftValue)!=="null";const haveDraft=incremental.getType(draftValue)!=="null";const havePublished=incremental.getType(publishedValue)!=="null";if(havePublished&&!haveDraft){publishedValue=incremental.rebaseValue(preDraftValue,publishedValue);}if(haveDraft&&!didHaveDriaft){draftValue=incremental.rebaseValue(prePublishedValue,draftValue);}}}const finalValue=incremental.getType(draftValue)==="null"?publishedValue:draftValue;const finalAttributes=getAttrs(finalDoc);return diffValue(this,firstChunk,initialValue,initialAttributes,finalValue,finalAttributes);}}function getValue(draftValue,publishedValue){return incremental.getType(draftValue)==="null"?publishedValue:draftValue;}const documentRevisionCache=/* @__PURE__ */Object.create(null);const getHistory=function(client,documentIds){let options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};const ids=Array.isArray(documentIds)?documentIds:[documentIds];const{time,revision}=options;if(time&&revision){throw new Error("getHistory can't handle both time and revision parameters");}const dataset=client.clientConfig.dataset;let url="/data/history/".concat(dataset,"/documents/").concat(ids.join(","));if(revision){url="".concat(url,"?revision=").concat(revision);}else{const timestamp=time||new Date().toISOString();url="".concat(url,"?time=").concat(timestamp);}return client.request({url});};const getDocumentAtRevision=(client,documentId,revision)=>{const publishedId=getPublishedId(documentId);const draftId=getDraftId(documentId);const cacheKey="".concat(publishedId,"@").concat(revision);const cached=documentRevisionCache[cacheKey];if(cached){return cached;}const dataset=client.clientConfig.dataset;const url="/data/history/".concat(dataset,"/documents/").concat(publishedId,",").concat(draftId,"?revision=").concat(revision);const entry=client.request({url}).then(result=>{const documents=result.documents||[];const published=documents.find(res=>res._id===publishedId);const draft=documents.find(res=>res._id===draftId);return draft||published;});documentRevisionCache[cacheKey]=entry;return entry;};const getTransactions=async(client,documentIds)=>{const ids=Array.isArray(documentIds)?documentIds:[documentIds];const dataset=client.clientConfig.dataset;const query={excludeContent:"true",includeIdentifiedDocumentsOnly:"true"};const url="/data/history/".concat(dataset,"/transactions/").concat(ids.join(","));const result=await client.request({url,query});const transactions=result.toString("utf8").split("\n").filter(Boolean).map(line=>JSON.parse(line));return transactions;};const getAllRefIds=doc=>reduceJSON(doc,(acc,node)=>isReference$1(node)&&!acc.includes(node._ref)?[...acc,node._ref]:acc,[]);function jsonMap(value,mapFn){if(Array.isArray(value)){return mapFn(value.map(item=>jsonMap(item,mapFn)).filter(item=>typeof item!=="undefined"));}if(isRecord$2(value)){return mapFn(Object.keys(value).reduce((res,key)=>{const mappedValue=jsonMap(value[key],mapFn);if(typeof mappedValue!=="undefined"){res[key]=mappedValue;}return res;},{}));}return mapFn(value);}const mapRefNodes=(doc,mapFn)=>jsonMap(doc,node=>isReference$1(node)?mapFn(node):node);const removeMissingReferences=(doc,existingIds)=>mapRefNodes(doc,refNode=>{const documentExists=existingIds[refNode._ref];return documentExists?refNode:void 0;});function restore(client,documentId,targetDocumentId,rev){return from(getDocumentAtRevision(client,documentId,rev)).pipe(mergeMap(documentAtRevision=>{if(!documentAtRevision){throw new Error("Unable to find document with ID ".concat(documentId," at revision ").concat(rev));}const existingIdsQuery=getAllRefIds(documentAtRevision).map(refId=>"\"".concat(refId,"\": defined(*[_id==\"").concat(refId,"\"]._id)")).join(",");return client.observable.fetch("{".concat(existingIdsQuery,"}")).pipe(map(existingIds=>removeMissingReferences(documentAtRevision,existingIds)));}),map(documentAtRevision=>{const{_updatedAt}=documentAtRevision,document=_objectWithoutProperties(documentAtRevision,_excluded29);return _objectSpread(_objectSpread({},document),{},{_id:targetDocumentId});}),mergeMap(restoredDraft=>client.observable.createOrReplace(restoredDraft,{visibility:"async"})));}function createHistoryStore(_ref156){let{client}=_ref156;return{getDocumentAtRevision:(documentId,revision)=>getDocumentAtRevision(client,documentId,revision),getHistory:(documentIds,options)=>getHistory(client,documentIds,options),getTransactions:documentIds=>getTransactions(client,documentIds),restore:(id,targetId,rev)=>restore(client,id,targetId,rev),getTimeline:options=>new Timeline$1(options),getTimelineController:options=>createObservableController(options)};}const USERIDS=["pqSMwf6hH","pnLYqNfv5","priDVVmy8","p0NFOU0j8","pTDl2jw8d","pHMeQnTse","pDQYzJbyS","pZyoPHKUs","p4Tyi2Be5","pb9vii060","pE8yhOisw","p7Fd2C6Cj","p3exSgYCx","pbIQRYViC","p8GJaTEhN","p27ewL8aM","pYg97z75S","pdLr4quHv","pkJXiDgg6","pkl4UAKcA","pNoExists"];const PATHS=[["nested","first"],["nested","second"],["nestedArray",{_key:"565c867c8dac"},"arrayNo1",{_key:"a645548a8f01"},"arrayNo1",{_key:"1685e372c40f"},"fieldNo0"],["nestedArray",{_key:"565c867c8dac"},"fieldNo0"],["nestedArray",{_key:"565c867c8dac"},"arrayNo19",{_key:"a02e7a93e2a2"},"fieldNo0"],["nestedArray",{_key:"565c867c8dac"},"arrayNo19",{_key:"a02e7a93e2a2"},"fieldNo19"],["address","country"],["address","street"],["customInputWithDefaultPresence","row3","cell3"]];const mock$=defer(()=>timer(0,1e4)).pipe(mergeMapTo(USERIDS),map((id,n)=>({type:"state",userId:id,sessionId:id+n,timestamp:new Date().toISOString(),locations:[{type:"document",documentId:"presence-debug",lastActiveAt:new Date().toISOString(),path:sample(PATHS)}]})),shareReplay());const handleIncomingMessage=event=>{if(event.type==="rollCall"){return{type:"rollCall",userId:event.i,sessionId:event.session};}if(event.type==="state"){const{sessionId,locations}=event.m;return{type:"state",userId:event.i,sessionId,timestamp:new Date().toISOString(),locations};}if(event.type==="disconnect"){return{type:"disconnect",userId:event.i,sessionId:event.m.session,timestamp:new Date().toISOString()};}throw new Error("Got unknown presence event: ".concat(JSON.stringify(event)));};const createBifurTransport=(bifur,sessionId)=>{const incomingEvents$=bifur.request("presence").pipe(map(handleIncomingMessage));const dispatchMessage=message=>{if(message.type==="rollCall"){return bifur.request("presence_rollcall",{session:sessionId});}if(message.type==="state"){return bifur.request("presence_announce",{data:{locations:message.locations,sessionId}});}if(message.type==="disconnect"){return bifur.request("presence_disconnect",{session:sessionId});}return EMPTY$1;};return[incomingEvents$.pipe(share()),dispatchMessage];};const KEY="presence_session_id";const generate=()=>nanoid(16);function getSessionId(){try{return window.sessionStorage.getItem(KEY);}catch(err){}return null;}function setSessionId(id){try{window.sessionStorage.setItem(KEY,id);}catch(err){}return id;}const SESSION_ID=getSessionId()||setSessionId(generate());function __tmp_wrap_presenceStore(context){const{bifur,connectionStatusStore,userStore}=context;const[presenceEvents$,sendMessage]=createBifurTransport(bifur,SESSION_ID);const currentLocation$=new BehaviorSubject([]);const locationChange$=currentLocation$.pipe(distinctUntilChanged());const setLocation=nextLocation=>{currentLocation$.next(nextLocation);};const reportLocations=locations=>sendMessage({type:"state",locations});const requestRollCall=()=>sendMessage({type:"rollCall"});const rollCallRequests$=presenceEvents$.pipe(filter(event=>event.type==="rollCall"),filter(event=>event.sessionId!==SESSION_ID));const REPORT_MIN_INTERVAL=3e4;const reportLocationInterval$=timer(0,REPORT_MIN_INTERVAL);const reportLocation$=defer(()=>merge(locationChange$,rollCallRequests$)).pipe(switchMap(()=>reportLocationInterval$),withLatestFrom(currentLocation$),map(_ref157=>{let[,locations]=_ref157;return locations;}),auditTime(200),switchMap(locations=>reportLocations(locations)),mergeMapTo(EMPTY$1),share());const myRollCall$=defer(()=>requestRollCall()).pipe(mergeMapTo(EMPTY$1));const connectionChange$=connectionStatusStore.connectionStatus$.pipe(map(status=>status.type),filter(statusType=>statusType==="connected"||statusType==="error"),distinctUntilChanged());const debugPresenceParam$=debugParams$.pipe(map(args=>args.find(arg=>arg.startsWith("presence="))),map(arg=>(arg==null?void 0:arg.split("presence=")[1].split(",").map(r=>r.trim()))||[]));const useMock$=debugPresenceParam$.pipe(filter(args=>args.includes("fake_others")),tap(()=>{console.log('Faking other users present in the studio. They will hang out in the document with _type: "presence" and _id: "presence-debug"');}),switchMapTo(mock$));const debugIntrospect$=debugPresenceParam$.pipe(map(args=>args.includes("show_own")));const syncEvent$=merge(myRollCall$,presenceEvents$).pipe(filter(event=>event.type==="state"||event.type==="disconnect"));const stateEventToSession=stateEvent=>{return{lastActiveAt:stateEvent.timestamp,locations:stateEvent.locations,sessionId:stateEvent.sessionId,userId:stateEvent.userId};};const states$=merge(syncEvent$,useMock$).pipe(scan((keyed,event)=>event.type==="disconnect"?omit(keyed,event.sessionId):_objectSpread(_objectSpread({},keyed),{},{[event.sessionId]:stateEventToSession(event)}),{}));const allSessions$=connectionChange$.pipe(switchMap(status=>status==="connected"?merge(states$,reportLocation$):NEVER),map(keyedSessions=>Object.values(keyedSessions)),switchMap(sessions=>{const userIds=uniq(sessions.map(sess=>sess.userId));return from(userStore.getUsers(userIds)).pipe(map(users=>sessions.map(session=>({user:users.find(res=>res.id===session.userId),session})).filter(userSessionPairHasUser)));}),takeUntil(fromEvent(window,"beforeunload").pipe(switchMap(()=>sendMessage({type:"disconnect"})))),shareReplay({refCount:true,bufferSize:1}));function userSessionPairHasUser(pair){return Boolean(pair.user&&pair.session);}const globalPresence$=allSessions$.pipe(map(sessions=>{const grouped=groupBy(sessions.map(s=>s.session),e=>e.userId);return Object.keys(grouped).map(userId=>{var _a;return{user:(_a=sessions.find(s=>s.user.id===userId))==null?void 0:_a.user,sessions:grouped[userId]};});}),withLatestFrom(debugIntrospect$),map(_ref158=>{let[userAndSessions,debugIntrospect]=_ref158;return userAndSessions.filter(userAndSession=>{if(debugIntrospect){return true;}const isCurrent=userAndSession.sessions.some(sess=>sess.sessionId===SESSION_ID);return!isCurrent;});}),map(userAndSessions=>userAndSessions.map(userAndSession=>{var _a;return{user:userAndSession.user,status:"online",lastActiveAt:(_a=userAndSession.sessions.sort()[0])==null?void 0:_a.lastActiveAt,locations:flatten$1((userAndSession.sessions||[]).map(session=>session.locations||[])).map(location=>({type:location.type,documentId:location.documentId,path:location.path,lastActiveAt:location.lastActiveAt})).reduce((prev,curr)=>prev.concat(curr),[])};})));const documentPresence=documentId=>{return allSessions$.pipe(withLatestFrom(debugIntrospect$),switchMap(_ref159=>{let[userAndSessions,debugIntrospect]=_ref159;return from(userAndSessions).pipe(filter(userAndSession=>debugIntrospect||userAndSession.session.sessionId!==SESSION_ID),flatMap(userAndSession=>(userAndSession.session.locations||[]).filter(item=>item.documentId===documentId).map(location=>({user:userAndSession.user,lastActiveAt:userAndSession.session.lastActiveAt,path:location.path||[],sessionId:userAndSession.session.sessionId}))),toArray$1());}));};return{setLocation,reportLocations,debugPresenceParam$,globalPresence$,documentPresence};}function useGlobalPresence(){const[presence,setPresence]=useState([]);const presenceStore=usePresenceStore();useEffect(()=>{const subscription=presenceStore.globalPresence$.subscribe(setPresence);return()=>{subscription.unsubscribe();};},[presenceStore]);return presence;}function useDocumentPresence(documentId){const presenceStore=usePresenceStore();const[presence,setPresence]=useState([]);useEffect(()=>{const subscription=presenceStore.documentPresence(documentId).subscribe(setPresence);return()=>{subscription.unsubscribe();};},[documentId,presenceStore]);return presence;}function createProjectStore(context){const{client}=context;const projectId=client.config().projectId;const versionedClient=client.withConfig({apiVersion:"2021-12-15"});function get(){return versionedClient.observable.request({url:"/projects/".concat(projectId)});}function getDatasets(){return versionedClient.observable.request({url:"/projects/".concat(projectId,"/datasets")});}return{get,getDatasets};}const tryParse=(val,defValue)=>{try{return JSON.parse(val);}catch(err){console.warn("Failed to parse settings: ".concat(err.message));return defValue;}};const get$1=(key,defValue)=>{const val=localStorage.getItem(key);return of(val===null?defValue:tryParse(val,defValue));};const set$2=(key,nextValue)=>{if(typeof nextValue==="undefined"||nextValue===null){localStorage.removeItem(key);}else{localStorage.setItem(key,JSON.stringify(nextValue));}return of(nextValue);};const localStorageBackend={get:get$1,set:set$2};const DB=/* @__PURE__ */Object.create(null);const get=(key,defValue)=>of(key in DB?DB[key]:defValue);const set$1=(key,nextValue)=>{if(typeof nextValue==="undefined"||nextValue===null){delete DB[key];}else{DB[key]=nextValue;}return of(nextValue);};const memoryBackend={get,set:set$1};let isSupported=null;function supportsLocalStorage(){if(isSupported!==null){return isSupported;}const testKey="__test__";try{localStorage.setItem(testKey,testKey);localStorage.removeItem(testKey);isSupported=true;}catch(evt){isSupported=false;}return isSupported;}function resolveBackend(){return supportsLocalStorage()?localStorageBackend:memoryBackend;}function createSettingsStore(){const storageBackend=resolveBackend();const set$=new Subject();const prefixNamespace=(ns,key)=>"".concat(ns,"::").concat(key);const updates$=set$.pipe(switchMap(event=>storageBackend.set(event.key,event.value).pipe(map(nextValue=>({key:event.key,value:nextValue})))));const listen=(key,defValue)=>{return merge(storageBackend.get(key,defValue),updates$.pipe(filter(update=>update.key===key),map(update=>update.value)));};const set=(key,value)=>{set$.next({key,value});};const forNamespace=ns=>{return{forKey:key=>{const namespacedKey=prefixNamespace(ns,key);return{listen:defaultValue=>listen(namespacedKey,defaultValue),set:value=>set(namespacedKey,value),del:()=>set(namespacedKey,void 0)};},listen:(key,defaultValue)=>{return listen(prefixNamespace(ns,key),defaultValue);},set:(key,value)=>{return set(prefixNamespace(ns,key),value);},del:key=>{return set(prefixNamespace(ns,key),void 0);},forNamespace:sub=>{return forNamespace(prefixNamespace(ns,sub));}};};return{forNamespace};}function useUserStore(){const{getClient,currentUser}=useSource();const resourceCache=useResourceCache();const client=getClient(DEFAULT_STUDIO_CLIENT_OPTIONS);return useMemo(()=>{const userStore=resourceCache.get({namespace:"userStore",dependencies:[client,currentUser]})||createUserStore({client,currentUser});resourceCache.set({namespace:"userStore",dependencies:[client,currentUser],value:userStore});return userStore;},[client,currentUser,resourceCache]);}function useGrantsStore(){const{getClient}=useSource();const client=getClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const currentUser=useCurrentUser();const resourceCache=useResourceCache();return useMemo(()=>{const grantsStore=resourceCache.get({namespace:"grantsStore",dependencies:[client,currentUser]})||createGrantsStore({client,currentUser});resourceCache.set({namespace:"grantsStore",dependencies:[client,currentUser],value:grantsStore});return grantsStore;},[client,currentUser,resourceCache]);}function useHistoryStore(){const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const resourceCache=useResourceCache();return useMemo(()=>{const historyStore=resourceCache.get({namespace:"historyStore",dependencies:[client]})||createHistoryStore({client});resourceCache.set({namespace:"historyStore",dependencies:[client],value:historyStore});return historyStore;},[client,resourceCache]);}function useDocumentPreviewStore(){const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const resourceCache=useResourceCache();const crossProjectTokenStore=useCrossProjectTokenStore();return useMemo(()=>{const documentPreviewStore=resourceCache.get({namespace:"documentPreviewStore",dependencies:[client,crossProjectTokenStore]})||createDocumentPreviewStore({client,crossProjectTokenStore});resourceCache.set({namespace:"documentPreviewStore",dependencies:[client,crossProjectTokenStore],value:documentPreviewStore});return documentPreviewStore;},[client,resourceCache,crossProjectTokenStore]);}function useCrossProjectTokenStore(){const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const resourceCache=useResourceCache();return useMemo(()=>{const crossProjectTokenStore=resourceCache.get({namespace:"crossProjectTokenStore",dependencies:[client]})||__tmp_wrap_crossProjectToken({client});resourceCache.set({namespace:"crossProjectTokenStore",dependencies:[client],value:crossProjectTokenStore});return crossProjectTokenStore;},[client,resourceCache]);}function useDocumentStore(){const getClient=useSource().getClient;const schema=useSchema();const templates=useTemplates();const resourceCache=useResourceCache();const historyStore=useHistoryStore();const documentPreviewStore=useDocumentPreviewStore();return useMemo(()=>{const documentStore=resourceCache.get({namespace:"documentStore",dependencies:[getClient,documentPreviewStore,historyStore,schema]})||createDocumentStore({getClient,documentPreviewStore,historyStore,initialValueTemplates:templates,schema});resourceCache.set({namespace:"documentStore",dependencies:[getClient,documentPreviewStore,historyStore,schema],value:documentStore});return documentStore;},[getClient,documentPreviewStore,historyStore,resourceCache,schema,templates]);}function useConnectionStatusStore(){const{bifur}=useSource().__internal;const resourceCache=useResourceCache();return useMemo(()=>{const connectionStatusStore=resourceCache.get({namespace:"connectionStatusStore",dependencies:[bifur]})||createConnectionStatusStore({bifur});resourceCache.set({namespace:"connectionStatusStore",dependencies:[bifur],value:connectionStatusStore});return connectionStatusStore;},[bifur,resourceCache]);}function usePresenceStore(){const{__internal:{bifur}}=useSource();const resourceCache=useResourceCache();const userStore=useUserStore();const connectionStatusStore=useConnectionStatusStore();return useMemo(()=>{const presenceStore=resourceCache.get({namespace:"presenceStore",dependencies:[bifur,connectionStatusStore,userStore]})||__tmp_wrap_presenceStore({bifur,connectionStatusStore,userStore});resourceCache.set({namespace:"presenceStore",dependencies:[bifur,connectionStatusStore,userStore],value:presenceStore});return presenceStore;},[bifur,connectionStatusStore,resourceCache,userStore]);}function useProjectStore(){const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const resourceCache=useResourceCache();return useMemo(()=>{const projectStore=resourceCache.get({namespace:"projectStore",dependencies:[client]})||createProjectStore({client});resourceCache.set({namespace:"projectStore",dependencies:[client],value:projectStore});return projectStore;},[client,resourceCache]);}function useSettingsStore(){const resourceCache=useResourceCache();const workspace=useWorkspace();return useMemo(()=>{const settingsStore=resourceCache.get({dependencies:[workspace],namespace:"settingsStore"})||createSettingsStore();resourceCache.set({dependencies:[workspace],namespace:"settingsStore",value:settingsStore});return settingsStore;},[resourceCache,workspace]);}const FullscreenLayer=styled(Layer)(_templateObject91||(_templateObject91=_taggedTemplateLiteral(["\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  top: 0;\n"])));function FullscreenSpinner(){return/* @__PURE__ */jsx(FullscreenLayer,{children:/* @__PURE__ */jsx(Flex,{height:"fill",align:"center",justify:"center",children:/* @__PURE__ */jsx(Spinner,{})})});}const WithReferringDocuments=withPropsStream(connect,function _WithReferringDocuments(_ref160){let{children}=_ref160,props=_objectWithoutProperties(_ref160,_excluded30);return children(props);});function connect(receivedProps$){return receivedProps$.pipe(distinctUntilChanged((prev,next)=>prev.id===next.id),switchMap(receivedProps=>concat(of(_objectSpread(_objectSpread({},receivedProps),{},{referringDocuments:[],isLoading:true})),receivedProps.documentStore.listenQuery("*[references($docId)] [0...101]",{docId:receivedProps.id},{tag:"with-referring-documents"}).pipe(map(docs=>_objectSpread(_objectSpread({},receivedProps),{},{referringDocuments:docs,isLoading:false}))))));}function SpinnerWithText(props){const{text}=props;return/* @__PURE__ */jsxs(Flex,{direction:"row",justify:"center",align:"center",children:[/* @__PURE__ */jsx(Spinner,{}),/* @__PURE__ */jsx(Box,{marginLeft:2,children:/* @__PURE__ */jsx(Text$1,{children:text})})]});}const DocumentList=_ref161=>{let{asset,assetType,referringDocuments}=_ref161;const count=referringDocuments.length;const hasResults=count>0;const filenamePlaceholder=asset.originalFilename?/* @__PURE__ */jsx("strong",{children:asset.originalFilename}):"this ".concat(assetType);if(!hasResults){return/* @__PURE__ */jsxs(Text$1,{size:[1,1,2,2],as:"h2",weight:"regular",children:["No documents are using ",filenamePlaceholder]});}return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Card,{borderBottom:true,marginTop:2,paddingBottom:2,marginBottom:1,children:/* @__PURE__ */jsxs(Text$1,{as:"h2",size:[1,1,2,2],weight:"regular",textOverflow:"ellipsis",children:[count," ",count===1?"document is":"documents are"," using ",filenamePlaceholder]})}),referringDocuments.map(document=>/* @__PURE__ */jsx(DocumentLink,{document},document._id))]});};const DocumentLink=_ref162=>{let{document}=_ref162;const schema=useSchema();const LinkComponent=useCallback(linkProps=>/* @__PURE__ */jsx(IntentLink,_objectSpread(_objectSpread({},linkProps),{},{params:{id:document._id,type:document._type},intent:"edit"})),[document]);return/* @__PURE__ */jsx(Card,{as:LinkComponent,paddingY:2,paddingX:1,radius:2,"data-as":"a",tabIndex:0,children:/* @__PURE__ */jsx(Flex,{align:"center",gap:2,children:/* @__PURE__ */jsx(SanityPreview,{layout:"default",value:{_type:"reference",_ref:document._id},schemaType:schema.get(document._type)})})},document._id);};const STYLE_ASSET_IMAGE={maxWidth:"100%",height:"120px",objectFit:"contain",objectPosition:"center"};const STYLE_CONFIRM_CARD={gridColumn:"span 1",overflow:"hidden",display:"flex",alignSelf:"center",justifyContent:"center"};const STYLE_IMAGE_WRAPPER={height:"100%"};const ConfirmMessage=_ref163=>{let{asset,assetType,hasResults=false}=_ref163;const isImage=assetType==="image";const filenamePlaceholder=asset.originalFilename?/* @__PURE__ */jsxs(Fragment,{children:["The ",assetType," ",/* @__PURE__ */jsx("strong",{children:asset.originalFilename})]}):"this ".concat(assetType);if(hasResults){return/* @__PURE__ */jsx(Card,{tone:"caution",padding:[3,3,4],border:true,radius:2,marginBottom:3,children:/* @__PURE__ */jsxs(Grid,{columns:3,gap:[2,3,4],children:[/* @__PURE__ */jsxs(Flex,{gap:[3,4],align:"center",style:{gridColumn:isImage?"span 2":"span 3"},children:[/* @__PURE__ */jsx(Text$1,{children:/* @__PURE__ */jsx(WarningOutlineIcon,{})}),/* @__PURE__ */jsxs(Text$1,{size:1,children:[filenamePlaceholder," cannot be deleted because it's being used. In order to delete the ",assetType," you need the remove all uses of it."]})]}),isImage&&/* @__PURE__ */jsx(Card,{__unstable_checkered:true,border:true,radius:1,style:STYLE_CONFIRM_CARD,children:/* @__PURE__ */jsx(Flex,{align:"center",justify:"center",style:STYLE_IMAGE_WRAPPER,children:/* @__PURE__ */jsx("img",{src:"".concat(asset.url,"?w=200"),style:STYLE_ASSET_IMAGE,alt:"Preview of image",referrerPolicy:"strict-origin-when-cross-origin"})})})]})});}return/* @__PURE__ */jsx(Card,{paddingX:[2,3,4],paddingY:[3,3,3,4],children:/* @__PURE__ */jsxs(Grid,{columns:3,gap:3,children:[/* @__PURE__ */jsx(Flex,{style:{gridColumn:isImage?"span 2":"span 3"},align:"center",children:/* @__PURE__ */jsxs(Text$1,{children:["You are about to delete the ",assetType,asset.originalFilename&&/* @__PURE__ */jsxs(Fragment,{children:[" ",/* @__PURE__ */jsx("strong",{children:asset.originalFilename})]})," ","and its metadata.",/* @__PURE__ */jsx("br",{}),/* @__PURE__ */jsx("br",{}),"Are you sure?"]})}),isImage&&/* @__PURE__ */jsx(Card,{__unstable_checkered:true,border:true,radius:1,style:STYLE_CONFIRM_CARD,children:/* @__PURE__ */jsx(Flex,{align:"center",justify:"center",style:STYLE_IMAGE_WRAPPER,children:/* @__PURE__ */jsx("img",{src:"".concat(asset.url,"?w=200"),style:STYLE_ASSET_IMAGE,alt:"Preview of image",referrerPolicy:"strict-origin-when-cross-origin"})})})]})});};const MODE_CONFIRM_DELETE="confirmDelete";const MODE_LIST_USAGE="listUsage";function AssetUsageDialog(props){const documentStore=useDocumentStore();return/* @__PURE__ */jsx(WithReferringDocuments,{documentStore,id:props.asset._id,children:_ref164=>{let{isLoading,referringDocuments}=_ref164;return/* @__PURE__ */jsx(InnerAssetUsageDialog,_objectSpread(_objectSpread({},props),{},{assetIsLoading:isLoading,referringDocuments}));}});}const InnerAssetUsageDialog=_ref165=>{let{asset,assetType="image",mode=MODE_LIST_USAGE,isDeleting=false,assetIsLoading=false,referringDocuments=[],onClose,onDelete}=_ref165;const isListMode=mode===MODE_LIST_USAGE;const defaultHeaderTitle=isListMode?"Documents using ".concat(assetType):"Delete ".concat(assetType);const[canDelete,setCanDelete]=useState(false);const[isLoadingParent,setIsLoadingParent]=useState(true);const[publishedDocuments,setPublishedDocuments]=useState([]);const showActionFooter=mode===MODE_CONFIRM_DELETE;const hasResults=publishedDocuments.length>0;const showDocumentList=mode===MODE_LIST_USAGE||hasResults;const noPaddingOnStack=mode===MODE_CONFIRM_DELETE&&!hasResults;const footer=showActionFooter?/* @__PURE__ */jsxs(Grid,{padding:2,gap:2,columns:2,children:[/* @__PURE__ */jsx(Button,{mode:"bleed",text:"Cancel",onClick:onClose}),/* @__PURE__ */jsx(Button,{text:"Delete",tone:"critical",icon:TrashIcon,onClick:onDelete,loading:isDeleting,disabled:!canDelete})]}):void 0;useEffect(()=>{const drafts=referringDocuments.reduce((acc,doc)=>doc._id.startsWith("drafts.")?acc.concat(doc._id.slice(7)):acc,[]);const documentsWithoutDrafts=referringDocuments.filter(doc=>!drafts.includes(doc._id));setPublishedDocuments(documentsWithoutDrafts);setCanDelete(documentsWithoutDrafts.length===0&&!assetIsLoading);setIsLoadingParent(assetIsLoading);},[assetIsLoading,referringDocuments]);return/* @__PURE__ */jsxs(Dialog,{id:"asset-dialog",header:defaultHeaderTitle,width:1,onClose,footer,__unstable_autoFocus:!isLoadingParent,children:[isLoadingParent&&/* @__PURE__ */jsx(Box,{padding:4,children:/* @__PURE__ */jsx(SpinnerWithText,{text:"Loading..."})}),!isLoadingParent&&/* @__PURE__ */jsxs(Stack,{paddingX:noPaddingOnStack?0:[2,3,4],paddingY:noPaddingOnStack?0:[3,3,3,4],space:1,children:[mode===MODE_CONFIRM_DELETE&&/* @__PURE__ */jsx(ConfirmMessage,{asset,assetType,hasResults}),showDocumentList&&/* @__PURE__ */jsx(DocumentList,{asset,referringDocuments:publishedDocuments,assetType})]})]});};function AssetMenu(_ref166){let{isSelected,border=true,onAction}=_ref166;const triggerButtonMode=isSelected?"default":"bleed";const triggerButtonTone=isSelected?"primary":"default";return/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{padding:2,mode:border?"ghost":triggerButtonMode,icon:EllipsisVerticalIcon,tone:border?"default":triggerButtonTone}),id:"asset-menu",portal:true,menu:/* @__PURE__ */jsxs(Menu,{children:[/* @__PURE__ */jsx(MenuItem,{text:"Show uses",icon:LinkIcon,onClick:()=>{onAction({type:"showUsage"});}}),/* @__PURE__ */jsx(MenuItem,{text:"Delete",icon:TrashIcon,tone:"critical",onClick:()=>{onAction({type:"delete"});}})]}),placement:"right"});}const DPI=typeof window==="undefined"||!window.devicePixelRatio?1:Math.round(window.devicePixelRatio);const Image$2=styled.img(_templateObject92||(_templateObject92=_taggedTemplateLiteral(["\n  position: absolute;\n  z-index: 1;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  display: block;\n  object-fit: contain;\n"])));const Container=styled(Card)(_templateObject93||(_templateObject93=_taggedTemplateLiteral(["\n  position: relative;\n  z-index: 1;\n  padding-bottom: 100%;\n"])));const Root$u=styled.div(_templateObject94||(_templateObject94=_taggedTemplateLiteral(["\n  position: relative;\n  display: inherit;\n"])));const MenuContainer=styled.div(_templateObject95||(_templateObject95=_taggedTemplateLiteral(["\n  box-sizing: border-box;\n  position: absolute;\n  z-index: 2;\n  display: none;\n  top: 3px;\n  right: 3px;\n\n  ",":hover & {\n    display: block;\n  }\n"])),Root$u);const AssetThumb=React.memo(function AssetThumb2(props){const versionedClient=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const toast=useToast();const deleteRef$=useRef();const{asset,onClick,onKeyPress,onDeleteFinished,isSelected}=props;const[showUsageDialog,setShowUsageDialog]=useState(false);const[showDeleteDialog,setShowDeleteDialog]=useState(false);const[isDeleting,setIsDeleting]=useState(false);useEffect(()=>{return()=>{if(deleteRef$.current){deleteRef$.current.unsubscribe();}};},[]);const handleConfirmDelete=useCallback(()=>{setShowDeleteDialog(true);},[setShowDeleteDialog]);const handleDialogClose=useCallback(()=>{setShowUsageDialog(false);setShowDeleteDialog(false);},[setShowUsageDialog,setShowDeleteDialog]);const handleToggleUsageDialog=useCallback(()=>{setShowUsageDialog(true);},[setShowUsageDialog]);const handleDeleteError=useCallback(error=>{toast.push({closable:true,status:"error",title:"Image could not be deleted",description:error.message});},[toast]);const handleDeleteSuccess=useCallback(()=>{toast.push({status:"success",title:"Image was deleted"});},[toast]);const handleDeleteAsset=useCallback(()=>{setIsDeleting(true);deleteRef$.current=versionedClient.observable.delete(asset._id).subscribe({next:()=>{setIsDeleting(false);onDeleteFinished(asset._id);setShowDeleteDialog(false);handleDeleteSuccess();},error:err=>{setIsDeleting(false);handleDeleteError(err);console.error("Could not delete asset",err);}});},[asset._id,handleDeleteError,handleDeleteSuccess,onDeleteFinished]);const handleMenuAction=useCallback(action=>{if(action.type==="delete"){handleConfirmDelete();}if(action.type==="showUsage"){handleToggleUsageDialog();}},[handleConfirmDelete,handleToggleUsageDialog]);const{originalFilename,_id,url}=asset;const imgH=200*Math.max(1,DPI);const imageUrl=url.includes(".gif")?"".concat(url,"?h=").concat(imgH,"&fit=max&fm=jpg"):"".concat(url,"?h=").concat(imgH,"&fit=max");return/* @__PURE__ */jsxs(Root$u,{children:[/* @__PURE__ */jsx(Button,{tone:"primary",selected:isSelected,tabIndex:0,"data-id":_id,mode:"ghost",onKeyPress,padding:0,style:{padding:2},children:/* @__PURE__ */jsxs(Container,{__unstable_checkered:true,children:[/* @__PURE__ */jsx(Image$2,{alt:originalFilename,src:imageUrl,onClick,"data-id":_id}),isDeleting&&/* @__PURE__ */jsx(FullscreenSpinner,{})]})}),/* @__PURE__ */jsx(MenuContainer,{children:/* @__PURE__ */jsx(AssetMenu,{isSelected,onAction:handleMenuAction})}),(showUsageDialog||showDeleteDialog)&&/* @__PURE__ */jsx(AssetUsageDialog,{asset,mode:showDeleteDialog?"confirmDelete":"listUsage",onClose:handleDialogClose,onDelete:handleDeleteAsset,isDeleting})]});});const BYTE_UNITS=["B","kB","MB","GB","TB","PB","EB","ZB","YB"];const BIBYTE_UNITS=["B","kiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];const BIT_UNITS=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"];const BIBIT_UNITS=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"];const toLocaleString=(number,locale,options)=>{let result=number;if(typeof locale==="string"||Array.isArray(locale)){result=number.toLocaleString(locale,options);}else if(locale===true||options!==void 0){result=number.toLocaleString(void 0,options);}return result;};function prettyBytes(input){let{bits=false,binary=false,signed=false,minimumFractionDigits,maximumFractionDigits,locale}=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};let number=input;if(!Number.isFinite(number)){throw new TypeError("Expected a finite number, got ".concat(typeof number,": ").concat(number));}const UNITS=bits?binary?BIBIT_UNITS:BIT_UNITS:binary?BIBYTE_UNITS:BYTE_UNITS;if(signed&&number===0){return" 0 ".concat(UNITS[0]);}const isNegative=number<0;const prefix=isNegative?"-":signed?"+":"";if(isNegative){number=-number;}let localeOptions;if(minimumFractionDigits!==void 0){localeOptions={minimumFractionDigits};}if(maximumFractionDigits!==void 0){localeOptions=_objectSpread({maximumFractionDigits},localeOptions);}if(number<1){const numberString2=toLocaleString(number,locale,localeOptions);return"".concat(prefix+numberString2," ").concat(UNITS[0]);}const exponent=Math.min(Math.floor(binary?Math.log(number)/Math.log(1024):Math.log10(number)/3),UNITS.length-1);number/=(binary?1024:1e3)**exponent;if(!localeOptions){number=number.toPrecision(3);}const numberString=toLocaleString(Number(number),locale,localeOptions);const unit=UNITS[exponent];return"".concat(prefix+numberString," ").concat(unit);}const MIME_TYPES={"image/bmp":{title:"Bitmap Image"},"image/jpeg":{title:"JPEG Image"},"image/gif":{title:"GIF Image"},"image/vnd.microsoft.icon":{title:"Icon"},"image/png":{title:"PNG Image"},"image/svg+xml":{title:"SVG Image"},"image/webp":{title:"WebP Image"},"image/tiff":{title:"TIFF Image"},"image/heic":{title:"HEIC Image"},"audio/midi":{title:"MIDI Audio"},"audio/midi-x":{title:"MIDI Audio"},"audio/mpeg":{title:"MP3 Audio"},"audio/ogg":{title:"OGG Audio"},"audio/wav":{title:"WAV Audio"},"audio/webm":{title:"WebM Audio"},"audio/aac":{title:"AAC Audio"},"video/x-msvideo":{title:"AVI Video"},"video/mp4":{title:"MP4 Video"},"video/mpeg":{title:"MPEG Video"},"video/ogg":{title:"OGG Video"},"video/webm":{title:"WebM Video"},"video/quicktime":{title:"QuickTime Video"},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{title:"Excel Spreadsheet"},"application/vnd.ms-excel":{title:"Excel Spreadsheet"},"text/plain":{title:"Text"},"text/javascript":{title:"JavaScript"},"text/markdown":{title:"Markdown"},"text/csv":{title:"CSV"},"text/css":{title:"CSS"},"application/pdf":{title:"PDF Document"},"application/xml":{title:"XML Document"},"text/xml":{title:"XML Document"},"application/zip":{title:"ZIP Archive"},"application/vnd.rar":{title:"RAR Archive"},"application/x-7z-compressed":{title:"7-zip Archive"},"application/octet-stream":{title:"Binary"}};function convertMimeTypeToSomethingNice(mimeType){const part=mimeType.replace("x-","").split("/")[1];return part.charAt(0).toUpperCase()+part.slice(1);}function formatMimeType(mimeType){if(MIME_TYPES==null?void 0:MIME_TYPES[mimeType]){return MIME_TYPES[mimeType].title;}return convertMimeTypeToSomethingNice(mimeType);}const CardIconWrapper=styled.span(_templateObject96||(_templateObject96=_taggedTemplateLiteral(["\n  background-color: transparent;\n  flex-shrink: 0;\n"])));const CustomFlex=styled(Flex)(_templateObject97||(_templateObject97=_taggedTemplateLiteral([""])));const CustomText=styled(Text$1)(_templateObject98||(_templateObject98=_taggedTemplateLiteral([""])));const CustomCard=styled(Card)(_templateObject99||(_templateObject99=_taggedTemplateLiteral(["\n  &:hover-within "," {\n    --card-muted-fg-color: var(--card-muted-fg-color);\n    --card-fg-color: var(--card-fg-color);\n  }\n\n  ","\n"])),CustomText,props=>props.isSelected&&css(_templateObject100||(_templateObject100=_taggedTemplateLiteral(["\n      --card-muted-fg-color: var(--card-bg-color);\n      --card-fg-color: var(--card-bg-color);\n    "]))));const RowButton=styled(Button)(_templateObject101||(_templateObject101=_taggedTemplateLiteral(["\n  box-shadow: none;\n  min-width: 0;\n  cursor: pointer;\n  position: initial;\n\n  &:before,\n  &:after {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    z-index: 2;\n  }\n\n  &:before {\n    z-index: 0;\n    pointer-events: none;\n    border-radius: 0.1875rem;\n  }\n\n  ","\n\n  ","\n"])),props=>props.isSelected&&css(_templateObject102||(_templateObject102=_taggedTemplateLiteral(["\n      --card-muted-fg-color: var(--card-bg-color);\n      --card-fg-color: var(--card-bg-color);\n\n      &:before {\n        background-color: var(--card-focus-ring-color);\n      }\n\n      "," {\n        --card-muted-fg-color: var(--card-bg-color);\n      }\n\n      "," {\n        --card-muted-fg-color: var(--card-bg-color);\n        --card-fg-color: var(--card-bg-color);\n      }\n    "])),CardIconWrapper,CustomFlex),props=>!props.isSelected&&css(_templateObject103||(_templateObject103=_taggedTemplateLiteral(["\n      &:hover:before {\n        background-color: var(--card-bg-color);\n      }\n\n      &:focus:before {\n        background-color: var(--card-code-bg-color);\n      }\n\n      &:focus-within:before {\n        background-color: var(--card-bg-color);\n      }\n    "]))));const STYLES_ROW_CARD={position:"relative"};const STYLES_ICON_CARD={flexShrink:0};const STYLES_BUTTON_TEXT={minWidth:0};const STYLES_ASSETMENU_WRAPPER={zIndex:3,marginTop:"-0.5rem",marginBottom:"-0.5rem"};const DISABLED_DELETE_TITLE="Cannot delete current file";const AssetRow=props=>{const versionedClient=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const toast=useToast();const deleteRef$=useRef();const[showUsageDialog,setShowUsageDialog]=useState(false);const[showDeleteDialog,setShowDeleteDialog]=useState(false);const[isDeleting,setIsDeleting]=useState(false);const[isOpen,setIsOpen]=useState(false);const{asset,onClick,onKeyPress,onDeleteFinished,isSelected,isMobile}=props;const{originalFilename,_id,mimeType,size,_createdAt}=asset;const formattedTime=useTimeAgo(_createdAt,{agoSuffix:true});const formattedMimeType=formatMimeType(mimeType);const formattedSize=prettyBytes(size);const showTooltip=(originalFilename||"").length>37;const handleConfirmDelete=()=>{setShowDeleteDialog(true);};const handleDeleteError=error=>{toast.push({closable:true,status:"error",title:"File could not be deleted",description:error.message});};const handleDeleteSuccess=()=>{toast.push({status:"success",title:"File was deleted"});};const handleDeleteAsset=()=>{setIsDeleting(true);deleteRef$.current=versionedClient.observable.delete(asset._id).subscribe({next:()=>{setIsDeleting(false);onDeleteFinished==null?void 0:onDeleteFinished(asset._id);setShowDeleteDialog(false);handleDeleteSuccess();},error:err=>{setIsDeleting(false);handleDeleteError(err);console.error("Could not delete asset",err);}});};const handleDialogClose=()=>{setShowUsageDialog(false);setShowDeleteDialog(false);};const handleToggleUsageDialog=()=>{setShowUsageDialog(true);};const handleToggleOpen=()=>{setIsOpen(!isOpen);};const handleMenuAction=action=>{if(action.type==="delete"){handleConfirmDelete();}if(action.type==="showUsage"){handleToggleUsageDialog();}};if(isMobile){return/* @__PURE__ */jsxs(Card,{paddingBottom:2,style:STYLES_ROW_CARD,children:[/* @__PURE__ */jsxs(Grid,{columns:4,gap:1,style:{position:"relative",gridTemplateColumns:"1fr 30px",opacity:isDeleting?0.5:1},children:[/* @__PURE__ */jsx(RowButton,{asset,mode:"bleed",padding:0,"data-id":_id,onClick,paddingY:1,children:/* @__PURE__ */jsxs(Flex,{gap:2,flex:2,align:"center",children:[/* @__PURE__ */jsx(Card,{as:CardIconWrapper,padding:2,tone:"transparent",radius:2,children:/* @__PURE__ */jsx(Text$1,{muted:true,size:2,style:STYLES_ICON_CARD,children:/* @__PURE__ */jsx(DocumentIcon,{})})}),/* @__PURE__ */jsx(Text$1,{size:1,align:"left",textOverflow:"ellipsis",style:STYLES_BUTTON_TEXT,children:originalFilename})]})}),/* @__PURE__ */jsx(Flex,{justify:"flex-end",align:"center",paddingRight:1,style:STYLES_ASSETMENU_WRAPPER,children:/* @__PURE__ */jsx(Button,{mode:"bleed",fontSize:1,padding:2,onClick:handleToggleOpen,icon:isOpen?ChevronUpIcon:ChevronDownIcon})})]}),isOpen&&/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsxs(Grid,{marginTop:3,columns:3,gap:1,children:[/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsx(Label,{size:1,muted:true,children:"Size"}),/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:formattedSize})]}),/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsx(Label,{size:1,muted:true,children:"Type"}),/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:formattedMimeType})]}),/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsx(Label,{size:1,muted:true,children:"Date added"}),/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:formattedTime})]})]}),/* @__PURE__ */jsxs(Stack,{space:2,marginTop:3,children:[/* @__PURE__ */jsx(Button,{fontSize:1,tone:"default",mode:"ghost",text:"Show uses",onClick:handleToggleUsageDialog,icon:LinkIcon}),/* @__PURE__ */jsx(Button,{fontSize:1,tone:"critical",mode:"ghost",text:"Delete",icon:TrashIcon,disabled:isSelected,title:isSelected?DISABLED_DELETE_TITLE:"Delete file",onClick:handleConfirmDelete})]})]}),(showUsageDialog||showDeleteDialog)&&/* @__PURE__ */jsx(AssetUsageDialog,{assetType:"file",asset,mode:showDeleteDialog?"confirmDelete":"listUsage",onClose:handleDialogClose,onDelete:handleDeleteAsset,isDeleting})]});}return/* @__PURE__ */jsxs(CustomCard,{asset,paddingBottom:1,style:STYLES_ROW_CARD,radius:0,overflow:"hidden",isSelected,"aria-selected":"true",children:[/* @__PURE__ */jsxs(Grid,{columns:4,gap:1,"data-id":_id,paddingY:1,style:{position:"relative",gridTemplateColumns:"3fr 1fr 1fr 2fr 30px",opacity:isDeleting?0.5:1},children:[/* @__PURE__ */jsx(RowButton,{asset,mode:"bleed","data-id":_id,onClick,padding:0,onKeyPress,title:"Select the file ".concat(originalFilename),isSelected,children:/* @__PURE__ */jsxs(CustomFlex,{gap:2,flex:2,paddingRight:1,align:"center",onClick,onKeyPress,"data-id":_id,title:"Select the file ".concat(originalFilename),children:[/* @__PURE__ */jsx(Card,{as:CardIconWrapper,padding:2,tone:"transparent",radius:2,style:STYLES_ICON_CARD,children:/* @__PURE__ */jsx(Text$1,{muted:true,size:2,children:/* @__PURE__ */jsx(DocumentIcon,{})})}),showTooltip&&/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:originalFilename})}),fallbackPlacements:["right","left"],placement:"top",portal:true,children:/* @__PURE__ */jsx(Text$1,{size:1,align:"left",textOverflow:"ellipsis",style:STYLES_BUTTON_TEXT,children:originalFilename})}),!showTooltip&&/* @__PURE__ */jsx(Text$1,{size:1,align:"left",textOverflow:"ellipsis",style:STYLES_BUTTON_TEXT,children:originalFilename})]})}),/* @__PURE__ */jsx(CustomFlex,{align:"center",children:/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:formattedSize})}),/* @__PURE__ */jsx(CustomFlex,{align:"center",children:/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:formattedMimeType})}),/* @__PURE__ */jsx(CustomFlex,{align:"center",children:/* @__PURE__ */jsx(Text$1,{as:"time",size:1,muted:true,dateTime:_createdAt,children:formattedTime})}),/* @__PURE__ */jsx(CustomFlex,{justify:"flex-end",align:"center",paddingX:1,paddingY:1,style:STYLES_ASSETMENU_WRAPPER,children:/* @__PURE__ */jsx(AssetMenu,{border:false,isSelected:false,onAction:handleMenuAction})})]}),(showUsageDialog||showDeleteDialog)&&/* @__PURE__ */jsx(AssetUsageDialog,{assetType:"file",asset,mode:showDeleteDialog?"confirmDelete":"listUsage",onClose:handleDialogClose,onDelete:handleDeleteAsset,isDeleting})]});};const STYLES_FILENAME={paddingLeft:"2.2rem"};const STYLES_GRID={gridTemplateColumns:"3fr 1fr 1fr 2fr 30px"};function TableList(props){const mediaIndex=useMediaIndex();const isMobile=mediaIndex<2;const{assets,onClick,onKeyPress,onDeleteFinished,selectedAssets,isLoading}=props;return/* @__PURE__ */jsxs(Box,{padding:4,children:[/* @__PURE__ */jsx(Card,{borderBottom:true,paddingBottom:2,marginBottom:1,children:isMobile?/* @__PURE__ */jsx(Grid,{style:STYLES_GRID,children:/* @__PURE__ */jsx(Box,{flex:2,paddingLeft:5,children:/* @__PURE__ */jsx(Label,{muted:true,size:1,children:"Filename"})})}):/* @__PURE__ */jsxs(Grid,{gap:1,style:STYLES_GRID,children:[/* @__PURE__ */jsx(Box,{flex:2,style:STYLES_FILENAME,children:/* @__PURE__ */jsx(Label,{muted:true,size:1,children:"Filename"})}),/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(Label,{muted:true,size:1,children:"Size"})}),/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(Label,{muted:true,size:1,children:"Type"})}),/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(Label,{muted:true,size:1,children:"Date added"})})]})}),/* @__PURE__ */jsxs(Stack,{children:[isLoading&&assets.length===0&&/* @__PURE__ */jsx(Box,{paddingTop:4,paddingBottom:2,children:/* @__PURE__ */jsx(Flex,{justify:"center",children:/* @__PURE__ */jsx(Spinner,{muted:true})})}),assets.map(asset=>/* @__PURE__ */jsx(AssetRow,{asset,isMobile,isSelected:selectedAssets.some(selected=>selected._id===asset._id),onClick,onKeyPress,onDeleteFinished},asset._id))]})]});}const PER_PAGE=200;const ASSET_TYPE_IMAGE="sanity.imageAsset";const ASSET_TYPE_FILE="sanity.fileAsset";const buildQuery=function(){let start=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;let end=arguments.length>1&&arguments[1]!==undefined?arguments[1]:PER_PAGE;let assetType=arguments.length>2&&arguments[2]!==undefined?arguments[2]:ASSET_TYPE_IMAGE;return"\n  *[_type == \"".concat(assetType,"\"] | order(_updatedAt desc) [").concat(start,"...").concat(end,"] {\n    _id,\n    _updatedAt,\n    _createdAt,\n    url,\n    originalFilename,\n    mimeType,\n    extension,\n    size,\n    metadata {dimensions}\n  }\n");};const ThumbGrid=styled(Grid)(_templateObject104||(_templateObject104=_taggedTemplateLiteral(["\n  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));\n"])));const CardLoadMore=styled(Card)(_templateObject105||(_templateObject105=_taggedTemplateLiteral(["\n  border-top: 1px solid var(--card-border-color);\n  position: sticky;\n  bottom: 0;\n  z-index: 200;\n"])));const DefaultAssetSource=function DefaultAssetSource2(props,ref){const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const versionedClient=useMemo(()=>client.withConfig({apiVersion:"1"}),[client]);const _elementId=useRef("default-asset-source-".concat(uniqueId()));const currentPageNumber=useRef(0);const fetch$=useRef();const[assets,setAssets]=useState([]);const[isLastPage,setIsLastPage]=useState(false);const[hasResetAutoFocus,setHasResetFocus]=useState(false);const[isLoading,setIsLoading]=useState(true);const{selectedAssets,assetType="image",dialogHeaderTitle="Select image",onClose,onSelect}=props;const fetchPage=useCallback(pageNumber=>{const start=pageNumber*PER_PAGE;const end=start+PER_PAGE;const isImageAssetType=assetType==="image";const tag=isImageAssetType?"asset.image-list":"asset.file-list";const assetTypeParam=isImageAssetType?ASSET_TYPE_IMAGE:ASSET_TYPE_FILE;setIsLoading(true);fetch$.current=versionedClient.observable.fetch(buildQuery(start,end,assetTypeParam),{},{tag}).subscribe(result=>{setIsLastPage(result.length<PER_PAGE);setAssets(prevState=>prevState.concat(result));setIsLoading(false);});},[assetType,setIsLoading,setAssets,setIsLastPage,versionedClient]);const handleDeleteFinished=useCallback(id=>{setAssets(prevState=>prevState.filter(asset=>asset._id!==id));},[setAssets]);const select=useCallback(id=>{const selected=assets.find(doc=>doc._id===id);if(selected){const selectedSource=[{kind:"assetDocumentId",value:id}];onSelect(selectedSource);}},[assets,onSelect]);const handleItemClick=useCallback(event=>{event.preventDefault();select(event.currentTarget.getAttribute("data-id"));},[select]);const handleItemKeyPress=useCallback(event=>{if(event.key==="Enter"){event.preventDefault();select(event.currentTarget.getAttribute("data-id"));}},[select]);const handleClose=useCallback(()=>{if(onClose){onClose();}},[onClose]);const handleFetchNextPage=useCallback(event=>{event.preventDefault();fetchPage(++currentPageNumber.current);},[fetchPage]);useEffect(()=>{fetchPage(currentPageNumber.current);return()=>{if(fetch$.current){fetch$.current.unsubscribe();}};},[fetchPage]);useEffect(()=>{if(!isLoading&&(!currentPageNumber.current||currentPageNumber.current===0)){setHasResetFocus(true);}},[isLoading]);const renderedThumbView=useMemo(()=>{return/* @__PURE__ */jsxs(Box,{padding:4,children:[/* @__PURE__ */jsx(ThumbGrid,{gap:2,children:assets.map(asset=>/* @__PURE__ */jsx(AssetThumb,{asset,isSelected:selectedAssets.some(selected=>selected._id===asset._id),onClick:handleItemClick,onKeyPress:handleItemKeyPress,onDeleteFinished:handleDeleteFinished},asset._id))}),isLoading&&assets.length===0&&/* @__PURE__ */jsx(Flex,{justify:"center",children:/* @__PURE__ */jsx(Spinner,{muted:true})}),!isLoading&&assets.length===0&&/* @__PURE__ */jsx(Text$1,{align:"center",muted:true,children:"No images"})]});},[assets,handleDeleteFinished,handleItemClick,handleItemKeyPress,isLoading,selectedAssets]);const renderedTableView=useMemo(()=>{return/* @__PURE__ */jsx(TableList,{isLoading,assets,selectedAssets,onClick:handleItemClick,onKeyPress:handleItemKeyPress,onDeleteFinished:handleDeleteFinished});},[isLoading,assets,selectedAssets,handleItemClick,handleItemKeyPress,handleDeleteFinished]);return/* @__PURE__ */jsxs(Dialog,{ref,id:_elementId.current,header:dialogHeaderTitle,width:2,onClose:handleClose,__unstable_autoFocus:hasResetAutoFocus,children:[assetType==="image"&&renderedThumbView,assetType==="file"&&renderedTableView,assets.length>0&&!isLastPage&&/* @__PURE__ */jsx(CardLoadMore,{tone:"default",padding:4,children:/* @__PURE__ */jsx(Flex,{direction:"column",children:/* @__PURE__ */jsx(Button,{type:"button",icon:DownloadIcon,loading:isLoading,onClick:handleFetchNextPage,text:"Load more",tone:"primary"})})})]});};const DefaultSource=React.memo(React.forwardRef(DefaultAssetSource));const ImageSource={name:"sanity-default",title:"Uploaded images",component:DefaultSource,icon:ImageIcon};const FileSource={name:"sanity-default",title:"Uploaded files",component:DefaultSource,icon:DocumentsIcon};const defaultFileAssetSources=[FileSource];const defaultImageAssetSources=[ImageSource];class WorkspaceValidationError extends Error{constructor(message,options){super(message);this.index=options==null?void 0:options.index;this.identifier=(options==null?void 0:options.workspace)&&getWorkspaceIdentifier(options.workspace,options.index);}}const getWorkspaceIdentifier=getIdentifier;function validateWorkspaces(_ref167){let{workspaces}=_ref167;if(workspaces.length===0){throw new WorkspaceValidationError("At least one workspace is required.");}validateNames(workspaces);validateBasePaths(workspaces);}function validateNames(workspaces){const isSingleWorkspace=workspaces.length===1;const names=/* @__PURE__ */new Map();workspaces.forEach((workspace,index)=>{const{name:rawName,title}=workspace;const thisIdentifier=getNamelessIdentifier(title,index);if(!rawName&&!isSingleWorkspace){throw new WorkspaceValidationError("All workspaces must have a `name`, unless only a single workspace is defined. Workspace ".concat(thisIdentifier," did not define a `name`."),{workspace,index});}const name=isSingleWorkspace&&typeof rawName==="undefined"?"default":rawName;if(typeof name!=="string"){throw new WorkspaceValidationError("Workspace at index ".concat(index," defined an invalid `name` - must be a string."),{workspace,index});}const normalized=name.toLowerCase();const existingWorkspace=names.get(normalized);if(existingWorkspace){const prevIdentifier=getNamelessIdentifier(existingWorkspace.workspace.title,existingWorkspace.index);throw new WorkspaceValidationError("`name`s must be unique. Workspace ".concat(prevIdentifier," and workspace ").concat(thisIdentifier," both have the `name` `").concat(name,"`"),{workspace,index});}names.set(normalized,{index,workspace});if(!/^[a-z0-9][a-z0-9_-]*$/i.test(name)){throw new WorkspaceValidationError("All workspace `name`s must consist of only a-z, 0-9, underscore and dashes, and cannot begin with an underscore or dash. Workspace ".concat(thisIdentifier," has the invalid name `").concat(name,"`"),{workspace,index});}});}function validateBasePaths(workspaces){if(workspaces.length>1){workspaces.every(hasBasePath);}workspaces.every(validateBasePath);const[firstWorkspace,...restOfWorkspaces]=workspaces;const firstWorkspaceSegmentCount=(firstWorkspace.basePath||"/").substring(1).split("/").length;restOfWorkspaces.forEach((workspace,index)=>{const workspaceSegmentCount=(workspace.basePath||"/").substring(1).split("/").length;if(firstWorkspaceSegmentCount!==workspaceSegmentCount){throw new WorkspaceValidationError("All workspace `basePath`s must have the same amount of segments. Workspace `".concat(getIdentifier(firstWorkspace,index),"` had ").concat(firstWorkspaceSegmentCount," segment").concat(firstWorkspaceSegmentCount===1?"":"s"," `").concat(firstWorkspace.basePath,"` but workspace `").concat(getIdentifier(workspace,index),"` had ").concat(workspaceSegmentCount," segment").concat(workspaceSegmentCount===1?"":"s"," `").concat(workspace.basePath,"`"),{workspace,index});}});const basePaths=/* @__PURE__ */new Map();workspaces.forEach((workspace,index)=>{const basePath=(workspace.basePath||"").toLowerCase();const existingWorkspace=basePaths.get(basePath);if(existingWorkspace){throw new WorkspaceValidationError("`basePath`s must be unique. Workspaces `".concat(existingWorkspace,"` and `").concat(getIdentifier(workspace,index),"` both have the `basePath` `").concat(basePath,"`"),{workspace,index});}basePaths.set(basePath,getIdentifier(workspace,index));});}function hasBasePath(workspace,index){const{name,basePath}=workspace;if(basePath&&typeof basePath==="string"){return true;}if(typeof basePath==="undefined"){throw new WorkspaceValidationError("If more than one workspace is defined, every workspace must have a `basePath` defined. Workspace `".concat(name,"` is missing a `basePath`"),{workspace,index});}throw new WorkspaceValidationError("If more than one workspace is defined, every workspace must have a `basePath` defined. Workspace `".concat(name,"` has an invalid `basePath` (must be a non-empty string)"),{workspace,index});}function validateBasePath(workspace,index){const{name,basePath}=workspace;if(!basePath||basePath==="/"){return;}if(!/^\/[a-z0-9/_-]*[a-z0-9_-]+$/i.test(basePath)){throw new WorkspaceValidationError("All workspace `basePath`s must start with a leading `/`, consist of only URL safe characters, and cannot end with a trailing `/`. Workspace `".concat(name,"`'s basePath is `").concat(basePath,"`"),{workspace,index});}}function getIdentifier(_ref168,index){let{name,title}=_ref168;if(typeof name==="string"&&name.trim().length>0){return name;}return getNamelessIdentifier(title,index);}function getNamelessIdentifier(title,index){const withTitle=typeof title==="string"&&title.trim().length>0?" (titled \"".concat(title,"\")"):"";return"at index ".concat(index).concat(withTitle);}const actionIds=/* @__PURE__ */new WeakMap();let counter=0;function getHookId(actionHook){const cachedId=actionIds.get(actionHook);if(cachedId)return cachedId;const id="".concat(actionHook.name||actionHook.displayName||"<anonymous>","-").concat(counter++);actionIds.set(actionHook,id);return id;}function useShallowCompareMemoize(value){const ref=useRef(void 0);if(!shallowEquals(value,ref.current)){ref.current=value;}return[ref.current];}function useShallowCompareEffect(callback,dependencies){useEffect(callback,useShallowCompareMemoize(dependencies));}const HookStateContainer=memo(function HookStateContainer2(props){const{hook,args,id,onNext,onReset,onRequestUpdate}=props;const hookState=hook(_objectSpread(_objectSpread({},args),{},{onComplete:()=>{onReset(id);}}));useShallowCompareEffect(()=>{onNext(id,hookState);onRequestUpdate();return()=>{onNext(id,null);onRequestUpdate();};},hookState);return null;},(prev,next)=>prev.args===next.args);const requestIdleCallbackShim=callback=>{const start=Date.now();return setTimeout(()=>{callback({didTimeout:false,timeRemaining(){return Math.max(0,Date.now()-start);}});},1);};const cancelIdleCallbackShim=handle=>{return clearTimeout(handle);};const _requestIdleCallback=typeof requestIdleCallback==="undefined"?requestIdleCallbackShim:requestIdleCallback;const _cancelIdleCallback=typeof cancelIdleCallback==="undefined"?cancelIdleCallbackShim:cancelIdleCallbackShim;function GetHookCollectionState(props){const{hooks,args,children,onReset}=props;const statesRef=useRef({});const[tickId,setTick]=useState(0);const[keys,setKeys]=useState({});const mountedRef=useRef(true);useEffect(()=>{return()=>{mountedRef.current=false;};},[]);const ricHandle=useRef(null);const handleRequestUpdate=useCallback(()=>{if(ricHandle.current){_cancelIdleCallback(ricHandle.current);}ricHandle.current=_requestIdleCallback(()=>{ricHandle.current=null;if(mountedRef.current){setTick(tick=>tick+1);}});},[]);const handleRequestUpdateThrottled=useThrottledCallback(handleRequestUpdate,60,{trailing:true});const handleNext=useCallback((id,hookState)=>{if(hookState===null){delete statesRef.current[id];}else{const current=statesRef.current[id];statesRef.current[id]=_objectSpread(_objectSpread({},current),{},{value:hookState});}},[]);const handleReset=useCallback(id=>{setKeys(currentKeys=>_objectSpread(_objectSpread({},currentKeys),{},{[id]:(currentKeys[id]||0)+1}));if(onReset){onReset();}},[onReset]);const hookIds=useMemo(()=>hooks.map(hook=>getHookId(hook)),[hooks]);const states=useMemo(()=>hookIds.map(id=>{var _a;return(_a=statesRef.current[id])==null?void 0:_a.value;}).filter(isNonNullable$4),[hookIds,tickId]);return/* @__PURE__ */jsxs(Fragment,{children:[hooks.map(hook=>{const id=getHookId(hook);const key=keys[id]||0;return/* @__PURE__ */jsx(HookStateContainer,{hook,id,args,onNext:handleNext,onRequestUpdate:handleRequestUpdateThrottled,onReset:handleReset},"".concat(id,"-").concat(key));}),children({states})]});}const RenderActionCollectionState=props=>{const{actions,children,actionProps,onActionComplete}=props;return/* @__PURE__ */jsx(GetHookCollectionState,{onReset:onActionComplete,hooks:actions,args:actionProps,children});};const CONTEXT_MENU_POPOVER_PROPS={constrainSize:true,placement:"bottom",portal:true};function PaneContextMenuButton(props){const{items,itemGroups,onAction}=props;const id=useId()||"";const groups=useMemo(()=>{if(!itemGroups||itemGroups.length===0){return[{id:"$default",items}];}const defaultGroup={id:"$default",items:[]};const groupMap=itemGroups.reduce((acc,group)=>{acc[group.id]={id:group.id,title:group.title,items:[]};return acc;},{});for(const item of items){const group=groupMap[item.group||"$default"]||defaultGroup;group.items.push(item);}return Object.values(groupMap).concat([defaultGroup]).filter(g=>g.items.length>0);},[items,itemGroups]);return/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{icon:EllipsisVerticalIcon,mode:"bleed",padding:3,title:"Show menu"}),id,menu:/* @__PURE__ */jsx(Menu,{children:groups.map((group,groupIndex)=>/* @__PURE__ */jsxs(Fragment$1,{children:[groupIndex>0&&/* @__PURE__ */jsx(MenuDivider,{}),group.title&&/* @__PURE__ */jsx(Box,{paddingX:3,paddingTop:3,paddingBottom:2,children:/* @__PURE__ */jsx(Label,{muted:true,children:group.title})}),group.items.map((item,itemIndex)=>/* @__PURE__ */jsx(PaneContextMenuItem,{item,onAction},"".concat(itemIndex,"-").concat(item.title)))]},groupIndex))}),popover:CONTEXT_MENU_POPOVER_PROPS,portal:true});}function PaneContextMenuItem(props){const{item,onAction}=props;const handleClick=useCallback(()=>{onAction(item);},[item,onAction]);const hotkeys=useMemo(()=>{if(!item.shortcut)return void 0;return item.shortcut.split("+");},[item]);const IntentButtonOrActionButton=forwardRef((linkProps,linkRef)=>item.intent?/* @__PURE__ */jsx(IntentLink,_objectSpread(_objectSpread({},linkProps),{},{intent:item.intent.type,params:item.intent.params,ref:linkRef})):/* @__PURE__ */jsx("button",_objectSpread({type:"button"},linkProps)));IntentButtonOrActionButton.displayName="Link";return/* @__PURE__ */jsx(MenuItem,{as:IntentButtonOrActionButton,"data-as":item.intent?"a":"button",hotkeys,icon:item.icon,onClick:handleClick,text:item.title});}const ImperativeToast=forwardRef((_,ref)=>{const{push}=useToast();useImperativeHandle(ref,()=>({push}));return null;});ImperativeToast.displayName="ImperativeToast";const defaults={navbar:200,navbarPopover:5e5,navbarDialog:500001,pane:100,paneHeader:[110,15e3],paneFooter:[120,2e4],paneResizer:[130,25e3],popover:200,modal:200,movingItem:1e4,drawershade:1e6,drawer:1000001,fullscreen:12e5,toast:[100,11e3],portal:200,dropdown:200,navbarFixed:1010,fullscreenEdit:1050,popoverBackground:1060,tooltip:200,modalBackground:2e3,spinner:3e3};const ZIndexContext=createContext(defaults);function useZIndex(){return useContext(ZIndexContext);}function LegacyLayerProvider(_ref169){let{children,zOffset:zOffsetKey}=_ref169;const zIndex=useZIndex();const zOffset=zIndex[zOffsetKey];return/* @__PURE__ */jsx(LayerProvider,{zOffset,children});}const PANE_DEBUG=false;const PANE_COLLAPSED_WIDTH=51;const PANE_DEFAULT_MIN_WIDTH=PANE_COLLAPSED_WIDTH*4;const PaneContext=createContext(null);const PaneLayoutContext=createContext(null);function usePaneLayout(){const pane=useContext(PaneLayoutContext);if(!pane){throw new Error("PaneLayout: missing context value");}return pane;}const Root$t=styled(Layer)(_templateObject106||(_templateObject106=_taggedTemplateLiteral(["\n  position: relative;\n  width: 1px;\n  min-width: 1px;\n\n  &:before {\n    content: '';\n    display: block;\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    width: 1px;\n    background-color: var(--card-border-color);\n  }\n\n  &:not([data-disabled]) {\n    cursor: ew-resize;\n    width: 9px;\n    min-width: 9px;\n    margin: 0 -4px;\n\n    &:before {\n      left: 4px;\n    }\n\n    &:after {\n      content: '';\n      display: block;\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 9px;\n      bottom: 0;\n      background-color: var(--card-border-color);\n      opacity: 0;\n      transition: opacity 150ms;\n    }\n\n    &[data-dragging]:after,\n    &:hover:after {\n      opacity: 0.2;\n    }\n  }\n"])));function PaneDivider(_ref170){let{disabled,element}=_ref170;const{resize}=usePaneLayout();const[dragging,setDragging]=useState(false);const handleMouseDown=useCallback(event=>{if(!element)return;setDragging(true);event.preventDefault();const startX=event.pageX;resize("start",element,0);const handleMouseMove=e=>{e.preventDefault();const deltaX=e.pageX-startX;resize("move",element,deltaX);};const handleMouseUp=e=>{e.preventDefault();setDragging(false);window.removeEventListener("mousemove",handleMouseMove);window.removeEventListener("mouseup",handleMouseUp);resize("end",element,0);};window.addEventListener("mousemove",handleMouseMove);window.addEventListener("mouseup",handleMouseUp);},[element,resize]);return/* @__PURE__ */jsx(Root$t,{"data-disabled":disabled?"":void 0,"data-dragging":dragging?"":void 0,onMouseDown:handleMouseDown});}const Root$s=styled(Card)(_templateObject107||(_templateObject107=_taggedTemplateLiteral(["\n  outline: none;\n\n  // NOTE: This will render a border to the right side of each pane\n  // without taking up physical space.\n  box-shadow: 1px 0 0 var(--card-border-color);\n"])));const Pane=forwardRef(function Pane2(props,ref){var _a,_b,_c;const{children,currentMinWidth:currentMinWidthProp,currentMaxWidth:currentMaxWidthProp,flex:flexProp=1,id,minWidth:minWidthProp,maxWidth:maxWidthProp,selected=false}=props,restProps=_objectWithoutProperties(props,_excluded31);const[rootElement,setRootElement]=useState(null);const{collapse,collapsed:layoutCollapsed,expand,expandedElement,mount,panes}=usePaneLayout();const pane=panes.find(p=>p.element===rootElement);const paneIndex=pane&&panes.indexOf(pane);const nextPane=typeof paneIndex==="number"?panes[paneIndex+1]:void 0;const isLast=paneIndex===panes.length-1;const collapsed=layoutCollapsed?false:(pane==null?void 0:pane.collapsed)||false;const nextCollapsed=(nextPane==null?void 0:nextPane.collapsed)||false;const forwardedRef=useForwardedRef(ref);const flex=(_a=pane==null?void 0:pane.flex)!=null?_a:flexProp;const currentMinWidth=(_b=pane==null?void 0:pane.currentMinWidth)!=null?_b:currentMinWidthProp;const currentMaxWidth=(_c=pane==null?void 0:pane.currentMaxWidth)!=null?_c:currentMaxWidthProp;const setRef=useCallback(refValue=>{setRootElement(refValue);forwardedRef.current=refValue;},[forwardedRef]);useEffect(()=>{if(!rootElement)return void 0;return mount(rootElement,{currentMinWidth:currentMinWidthProp,currentMaxWidth:currentMaxWidthProp,flex:flexProp,id,minWidth:minWidthProp,maxWidth:maxWidthProp});},[currentMinWidthProp,currentMaxWidthProp,flexProp,id,minWidthProp,maxWidthProp,mount,rootElement]);const handleCollapse=useCallback(()=>{if(!rootElement)return;collapse(rootElement);},[collapse,rootElement]);const handleExpand=useCallback(()=>{if(!rootElement)return;expand(rootElement);},[expand,rootElement]);const contextValue=useMemo(()=>({collapse:handleCollapse,collapsed:layoutCollapsed?false:collapsed,expand:handleExpand,index:paneIndex,isLast,rootElement}),[collapsed,handleCollapse,handleExpand,isLast,layoutCollapsed,paneIndex,rootElement]);const minWidth=useMemo(()=>{if(layoutCollapsed){return void 0;}if(collapsed)return PANE_COLLAPSED_WIDTH;if(currentMinWidth===0){return minWidthProp||PANE_DEFAULT_MIN_WIDTH;}if(isLast){return minWidthProp||PANE_DEFAULT_MIN_WIDTH;}return currentMinWidth||minWidthProp||PANE_DEFAULT_MIN_WIDTH;},[collapsed,currentMinWidth,isLast,layoutCollapsed,minWidthProp]);const maxWidth=useMemo(()=>{if(collapsed)return PANE_COLLAPSED_WIDTH;if(layoutCollapsed&&isLast){return void 0;}if(isLast){if(maxWidthProp){return currentMaxWidth!=null?currentMaxWidth:maxWidthProp;}return void 0;}return currentMaxWidth!=null?currentMaxWidth:maxWidthProp;},[collapsed,currentMaxWidth,isLast,layoutCollapsed,maxWidthProp]);const hidden=layoutCollapsed&&!isLast;const divider=useMemo(()=>!isLast&&!layoutCollapsed&&/* @__PURE__ */jsx(LegacyLayerProvider,{zOffset:"paneResizer",children:/* @__PURE__ */jsx(PaneDivider,{disabled:collapsed||nextCollapsed,element:rootElement})}),[collapsed,isLast,layoutCollapsed,nextCollapsed,rootElement]);const style=useMemo(()=>({flex,minWidth,maxWidth:maxWidth===Infinity?void 0:maxWidth}),[flex,minWidth,maxWidth]);return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(LegacyLayerProvider,{zOffset:"pane",children:/* @__PURE__ */jsx(PaneContext.Provider,{value:contextValue,children:/* @__PURE__ */jsxs(Root$s,_objectSpread(_objectSpread({"data-testid":"pane",tone:"inherit",hidden,id,overflow:layoutCollapsed?void 0:"hidden"},restProps),{},{"data-pane-collapsed":collapsed?"":void 0,"data-pane-index":paneIndex,"data-pane-selected":selected?"":void 0,ref:setRef,style,children:[PANE_DEBUG,/* @__PURE__ */jsx(BoundaryElementProvider,{element:rootElement,children:!hidden&&/* @__PURE__ */jsx(Flex,{direction:"column",height:"fill",children})})]}))})}),divider]});});function usePane(){const pane=useContext(PaneContext);if(!pane){throw new Error("Pane: missing context value");}return pane;}const Root$r=styled(Card)(_templateObject108||(_templateObject108=_taggedTemplateLiteral(["\n  position: relative;\n  outline: none;\n"])));Root$r.displayName="PaneContent__root";const PaneContent=forwardRef(function PaneContent2(props,ref){const{as,children,overflow,padding}=props,restProps=_objectWithoutProperties(props,_excluded32);const{collapsed}=usePane();const{collapsed:layoutCollapsed}=usePaneLayout();return/* @__PURE__ */jsx(Root$r,_objectSpread(_objectSpread({"data-testid":"pane-content",forwardedAs:as},restProps),{},{flex:1,hidden:collapsed,overflow:layoutCollapsed?void 0:overflow,padding,ref,tone:"inherit",children}));});const Root$q=styled(Layer)(_templateObject109||(_templateObject109=_taggedTemplateLiteral(["\n  position: sticky;\n  bottom: 0;\n\n  &:before {\n    content: '';\n    display: block;\n    position: absolute;\n    left: 0;\n    right: 0;\n    top: -1px;\n    border-bottom: 1px solid var(--card-shadow-outline-color);\n  }\n"])));const RootCard=styled(Card)(_templateObject110||(_templateObject110=_taggedTemplateLiteral(["\n  padding-bottom: env(safe-area-inset-bottom);\n"])));const PaneFooter=forwardRef(function PaneFooter2(props,ref){const{children,padding}=props;const{collapsed}=usePane();return/* @__PURE__ */jsx(LegacyLayerProvider,{zOffset:"paneFooter",children:/* @__PURE__ */jsx(Root$q,{"data-testid":"pane-footer",hidden:collapsed,ref,children:/* @__PURE__ */jsx(RootCard,{tone:"inherit",children:/* @__PURE__ */jsx(Box,{padding,children})})})});});const Root$p=styled(Layer)(_templateObject111||(_templateObject111=_taggedTemplateLiteral(["\n  line-height: 0;\n  position: sticky;\n  top: 0;\n\n  &:not([data-collapsed]):after {\n    content: '';\n    display: block;\n    position: absolute;\n    left: 0;\n    right: 0;\n    bottom: -1px;\n    border-bottom: 1px solid var(--card-shadow-outline-color);\n  }\n"])));const Layout=styled(Flex)(_templateObject112||(_templateObject112=_taggedTemplateLiteral(["\n  transform-origin: calc(51px / 2);\n\n  [data-collapsed] > div > & {\n    transform: rotate(90deg);\n  }\n"])));const TitleBox=styled(Box)(_templateObject113||(_templateObject113=_taggedTemplateLiteral([""])));const TitleTextSkeleton=styled(TextSkeleton)(_templateObject114||(_templateObject114=_taggedTemplateLiteral(["\n  width: 66%;\n  max-width: 175px;\n"])));const TitleText=styled(Text$1)(_templateObject115||(_templateObject115=_taggedTemplateLiteral(["\n  cursor: default;\n  outline: none;\n"])));const TABS_SCROLL_PADDING=100;const TabsBox=styled(Box)(_ref171=>{let{theme}=_ref171;const{color,space}=theme.sanity;return css(_templateObject116||(_templateObject116=_taggedTemplateLiteral(["\n    margin: -","px 0 -","px -","px;\n    overflow: hidden;\n    position: relative;\n\n    & > div {\n      white-space: nowrap;\n      padding: ","px 0 calc(","px + ","px) ","px;\n      margin-bottom: ","px;\n      overflow: auto;\n\n      /* right padding */\n      & > div:after {\n        content: '';\n        display: inline-block;\n        top: 0;\n        right: 0;\n        bottom: 0;\n        width: ","px;\n        height: 1px;\n      }\n    }\n\n    /* Gradient that makes it look like tabs disappear into nothing (looks nicer) */\n    &:after {\n      content: '';\n      display: block;\n      position: absolute;\n      top: 0;\n      right: 0;\n      bottom: 0;\n      background: linear-gradient(to right, ",", var(--card-bg-color));\n      width: ","px;\n      pointer-events: none;\n    }\n  "])),space[2],space[2],space[3],space[2],TABS_SCROLL_PADDING,space[2],space[3],0-TABS_SCROLL_PADDING,space[3],rgba(color.base.bg,0),space[3]);});const PaneHeader=forwardRef(function PaneHeader2(props,ref){const{actions,backButton,loading,subActions,tabs,title}=props;const{collapse,collapsed,expand,rootElement:paneElement}=usePane();const paneRect=useElementRect(paneElement||null);const layoutStyle=useMemo(()=>({width:collapsed?(paneRect==null?void 0:paneRect.height)||window.innerHeight:void 0}),[collapsed,paneRect]);const handleTitleClick=useCallback(()=>{if(collapsed)return;collapse();},[collapse,collapsed]);const handleLayoutClick=useCallback(()=>{if(!collapsed)return;expand();},[collapsed,expand]);return/* @__PURE__ */jsx(LayerProvider,{zOffset:100,children:/* @__PURE__ */jsx(Root$p,{"data-collapsed":collapsed?"":void 0,"data-testid":"pane-header",ref,children:/* @__PURE__ */jsx(LegacyLayerProvider,{zOffset:"paneHeader",children:/* @__PURE__ */jsxs(Card,{"data-collapsed":collapsed?"":void 0,tone:"inherit",children:[/* @__PURE__ */jsxs(Layout,{onClick:handleLayoutClick,padding:2,paddingBottom:tabs||subActions?1:2,sizing:"border",style:layoutStyle,children:[backButton,/* @__PURE__ */jsxs(TitleBox,{flex:1,onClick:handleTitleClick,paddingY:3,paddingLeft:backButton?1:3,children:[loading&&/* @__PURE__ */jsx(TitleTextSkeleton,{animated:true,radius:1}),!loading&&/* @__PURE__ */jsx(TitleText,{tabIndex:0,textOverflow:"ellipsis",weight:"semibold",children:title})]}),actions&&/* @__PURE__ */jsx(Box,{hidden:collapsed,paddingLeft:1,children:/* @__PURE__ */jsx(LegacyLayerProvider,{zOffset:"paneHeader",children:actions})})]}),(tabs||subActions)&&/* @__PURE__ */jsxs(Flex,{align:"center",hidden:collapsed,paddingTop:0,paddingRight:2,paddingBottom:2,paddingLeft:3,overflow:"auto",children:[/* @__PURE__ */jsx(TabsBox,{flex:1,marginRight:subActions?3:0,children:/* @__PURE__ */jsx("div",{children:tabs})}),subActions&&/* @__PURE__ */jsx(Box,{children:subActions})]})]})})})});});const Root$o=styled(Card)(_templateObject117||(_templateObject117=_taggedTemplateLiteral(["\n  transition: opacity 200ms;\n  position: relative;\n  z-index: 1;\n  padding-left: env(safe-area-inset-left);\n  padding-right: env(safe-area-inset-right);\n  opacity: 0;\n\n  &:not([hidden]) {\n    display: flex;\n  }\n\n  &:not([data-collapsed]) {\n    overflow: auto;\n  }\n\n  &[data-mounted] {\n    opacity: 1;\n  }\n\n  &[data-resizing] {\n    pointer-events: none;\n  }\n"])));function _calcPaneResize(cache,left,right,deltaX){var _a,_b;const sum={flex:cache.left.flex+cache.right.flex,width:cache.left.width+cache.right.width};const leftMinWidth=(_a=left.minWidth)!=null?_a:PANE_DEFAULT_MIN_WIDTH;const rightMinWidth=(_b=right.minWidth)!=null?_b:PANE_DEFAULT_MIN_WIDTH;const leftMaxWidth=Math.min(left.maxWidth||Infinity,sum.width-rightMinWidth);const rightMaxWidth=Math.min(right.maxWidth||Infinity,sum.width-leftMinWidth);let minDeltaX=leftMinWidth-cache.left.width;const rightMinDeltaX=cache.right.width-rightMaxWidth;if(minDeltaX<rightMinDeltaX){minDeltaX=rightMinDeltaX;}let maxDeltaX=cache.right.width-rightMinWidth;const leftMaxDeltaX=leftMaxWidth-cache.left.width;if(maxDeltaX>leftMaxDeltaX){maxDeltaX=leftMaxDeltaX;}const _deltaX=Math.min(Math.max(deltaX,minDeltaX),maxDeltaX);const leftW=cache.left.width+_deltaX;const rightW=cache.right.width-_deltaX;const leftFlex=leftW/sum.width*sum.flex;const rightFlex=rightW/sum.width*sum.flex;return{leftFlex,leftW,rightFlex,rightW};}function _getDOMPath(rootElement,el){const path=[];let e=el;while(e!==rootElement){const parentElement=e.parentElement;if(!parentElement)return path;const children=Array.from(parentElement.childNodes);const index=children.indexOf(e);path.unshift(index);if(parentElement===rootElement){return path;}e=parentElement;}return path;}const EMPTY_PATH$2=[];function _sortElements(rootElement,elements){const map=/* @__PURE__ */new WeakMap();for(const element of elements){map.set(element,_getDOMPath(rootElement,element));}const _sortByElementPath=(a,b)=>{const _a=map.get(a)||EMPTY_PATH$2;const _b=map.get(b)||EMPTY_PATH$2;const len=Math.max(_a.length,_b.length);for(let i=0;i<len;i+=1){const aIndex=_a[i]||-1;const bIndex=_b[i]||-1;if(aIndex!==bIndex){return aIndex-bIndex;}}return 0;};elements.sort(_sortByElementPath);}function createPaneLayoutController(){const observers=[];const elements=[];const optionsMap=/* @__PURE__ */new WeakMap();const userCollapsedElementSet=/* @__PURE__ */new Set();const cache={};let rootElement=null;let rootWidth=0;let expandedElement=null;let resizeDataMap=/* @__PURE__ */new Map();let resizing=false;function collapse(element){userCollapsedElementSet.add(element);if(expandedElement===element){expandedElement=null;}_notifyObservers();}function expand(element){userCollapsedElementSet.delete(element);expandedElement=element;_notifyObservers();}function mount(element,options){optionsMap.set(element,_objectSpread(_objectSpread({},options),{},{original:options}));elements.push(element);if(rootElement){_sortElements(rootElement,elements);}expand(element);return()=>{const idx=elements.indexOf(element);if(idx>-1){elements.splice(idx,1);}optionsMap.delete(element);_notifyObservers();};}function resize(type,leftElement,deltaX){var _a,_b,_c,_d;const leftIndex=elements.indexOf(leftElement);const leftOptions=optionsMap.get(leftElement);if(!leftOptions)return;const rightElement=elements[leftIndex+1];const rightOptions=optionsMap.get(rightElement);if(!rightOptions)return;if(type==="start"){resizing=true;cache.left={element:leftElement,flex:leftOptions.flex||1,width:leftElement.offsetWidth};cache.right={element:rightElement,flex:rightOptions.flex||1,width:rightElement.offsetWidth};_notifyObservers();}if(type==="move"&&cache.left&&cache.right){resizeDataMap=/* @__PURE__ */new Map();const{leftW,rightW,leftFlex,rightFlex}=_calcPaneResize(cache,leftOptions,rightOptions,deltaX);resizeDataMap.set(leftElement,{flex:leftFlex,width:leftW});resizeDataMap.set(rightElement,{flex:rightFlex,width:rightW});_notifyObservers();}if(type==="end"){resizing=false;const leftResizeData=resizeDataMap.get(leftElement);const rightResizeData=resizeDataMap.get(rightElement);optionsMap.set(leftElement,_objectSpread(_objectSpread({},leftOptions),{},{currentMinWidth:0,currentMaxWidth:(_a=leftOptions.maxWidth)!=null?_a:Infinity,flex:(_b=leftResizeData==null?void 0:leftResizeData.flex)!=null?_b:leftOptions.flex}));optionsMap.set(rightElement,_objectSpread(_objectSpread({},rightOptions),{},{currentMinWidth:0,currentMaxWidth:(_c=leftOptions.maxWidth)!=null?_c:Infinity,flex:(_d=rightResizeData==null?void 0:rightResizeData.flex)!=null?_d:rightOptions.flex}));resizeDataMap=/* @__PURE__ */new Map();delete cache.left;delete cache.right;_notifyObservers();}}function setRootElement(nextRootElement){rootElement=nextRootElement;}function setRootWidth(nextRootWidth){rootWidth=nextRootWidth;_notifyObservers();}function subscribe(observer){observers.push(observer);return()=>{const idx=observers.push(observer);if(idx>-1){observers.splice(idx,1);}};}return{collapse,expand,mount,resize,setRootElement,setRootWidth,subscribe};function _notifyObservers(){var _a,_b,_c,_d;if(!rootWidth)return;const _elements=[];for(const element of elements){if(element!==expandedElement){_elements.unshift(element);}}if(expandedElement){_elements.unshift(expandedElement);}const dataMap=/* @__PURE__ */new WeakMap();const len=_elements.length;const lastElement=_elements[0];const collapsedWidth=(len-1)*PANE_COLLAPSED_WIDTH;let remaingWidth=rootWidth-collapsedWidth;for(const element of _elements){const options=optionsMap.get(element);if(!options){continue;}const minWidth=options.currentMinWidth||options.minWidth||PANE_DEFAULT_MIN_WIDTH;const isLast=element===lastElement;const userCollapsed=userCollapsedElementSet.has(element);const sizeCollapsed=minWidth>remaingWidth;const collapsed=isLast?false:userCollapsed||sizeCollapsed;const resizeData=resizeDataMap.get(element);dataMap.set(element,{element,collapsed,currentMinWidth:(_a=resizeData==null?void 0:resizeData.width)!=null?_a:options.currentMinWidth,currentMaxWidth:(_b=resizeData==null?void 0:resizeData.width)!=null?_b:options.currentMaxWidth,flex:(_d=(_c=resizeData==null?void 0:resizeData.flex)!=null?_c:options.flex)!=null?_d:1});if(collapsed){remaingWidth-=PANE_COLLAPSED_WIDTH;}else{remaingWidth-=minWidth-PANE_COLLAPSED_WIDTH;}}const panes=[];for(const element of elements){const data=dataMap.get(element);if(data)panes.push(data);}for(const observer of observers){observer({expandedElement:expandedElement||elements[elements.length-1]||null,panes,resizing});}}}function PaneLayout(props){const{children,minWidth,onCollapse,onExpand}=props,restProps=_objectWithoutProperties(props,_excluded33);const controller=useMemo(()=>createPaneLayoutController(),[]);const[rootElement,setRootElement]=useState(null);const rootRect=useElementRect(rootElement);const width=(rootRect==null?void 0:rootRect.width)||0;const collapsed=width===void 0||!minWidth?void 0:width<minWidth;const[state,setState]=useState({expandedElement:null,panes:[],resizing:false});useEffect(()=>controller.setRootElement(rootElement),[controller,rootElement]);useEffect(()=>controller.setRootWidth(width),[controller,width]);useEffect(()=>controller.subscribe(setState),[controller]);useEffect(()=>{if(collapsed===void 0)return;if(collapsed&&onCollapse)onCollapse();if(!collapsed&&onExpand)onExpand();},[collapsed,onCollapse,onExpand]);const paneLayout=useMemo(()=>({collapse:controller.collapse,collapsed,expand:controller.expand,expandedElement:state.expandedElement,mount:controller.mount,panes:state.panes,resize:controller.resize,resizing:state.resizing}),[collapsed,controller,state.expandedElement,state.panes,state.resizing]);return/* @__PURE__ */jsx(PaneLayoutContext.Provider,{value:paneLayout,children:/* @__PURE__ */jsx(Root$o,_objectSpread(_objectSpread({"data-ui":"PaneLayout"},restProps),{},{"data-collapsed":collapsed?"":void 0,"data-resizing":state.resizing?"":void 0,"data-mounted":width?"":void 0,ref:setRootElement,children}))});}const IntentButton=forwardRef(function IntentButton2(props,ref){const{intent}=props,restProps=_objectWithoutProperties(props,_excluded34);const Link=useMemo(()=>forwardRef(function Link2(linkProps,linkRef){return/* @__PURE__ */jsx(IntentLink,_objectSpread(_objectSpread({},linkProps),{},{intent:intent.type,params:intent.params,ref:linkRef}));}),[intent]);return props.disabled?/* @__PURE__ */jsx(Button,_objectSpread(_objectSpread({},props),{},{as:"a",role:"link","aria-disabled":"true"})):/* @__PURE__ */jsx(Button,_objectSpread(_objectSpread({},restProps),{},{as:Link,"data-as":"a",ref}));});function InsufficientPermissionsMessageTooltip(_ref172){let{reveal,loading,children}=_ref172;const currentUser=useCurrentUser();if(!reveal){return/* @__PURE__ */jsx(Fragment,{children});}return/* @__PURE__ */jsx(Tooltip,{content:loading?/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{children:"Loading\u2026"})}):/* @__PURE__ */jsx(InsufficientPermissionsMessage,{currentUser}),portal:true,children:/* @__PURE__ */jsx("div",{children})});}const POPOVER_PROPS$1={constrainSize:true,placement:"bottom",portal:true};const getIntent=(schema,templates,item)=>{var _a;const typeName=(_a=templates.find(t=>t.id===item.templateId))==null?void 0:_a.schemaType;if(!typeName)return null;const baseParams={template:item.templateId,type:typeName,id:item.initialDocumentId};return{type:"create",params:item.parameters?[baseParams,item.parameters]:baseParams};};function PaneHeaderCreateButton(_ref173){let{templateItems}=_ref173;const schema=useSchema();const templates=useTemplates();const[templatePermissions,isTemplatePermissionsLoading]=useTemplatePermissions({templateItems});const nothingGranted=useMemo(()=>{return!isTemplatePermissionsLoading&&(templatePermissions==null?void 0:templatePermissions.every(permission=>!permission.granted));},[isTemplatePermissionsLoading,templatePermissions]);const permissionsById=useMemo(()=>{if(!templatePermissions)return{};return templatePermissions.reduce((acc,permission)=>{acc[permission.id]=permission;return acc;},{});},[templatePermissions]);if(nothingGranted){return/* @__PURE__ */jsx(InsufficientPermissionsMessageTooltip,{reveal:true,loading:isTemplatePermissionsLoading,children:/* @__PURE__ */jsx(Button,{"aria-label":"Insufficient permissions",icon:ComposeIcon,mode:"bleed",disabled:true,"data-testid":"action-intent-button"})});}if(templateItems.length===1){const firstItem=templateItems[0];const permissions=permissionsById[firstItem.id];const disabled=!(permissions==null?void 0:permissions.granted);const intent=getIntent(schema,templates,firstItem);if(!intent)return null;return/* @__PURE__ */jsx(InsufficientPermissionsMessageTooltip,{reveal:disabled,loading:isTemplatePermissionsLoading,children:/* @__PURE__ */jsx(IntentButton,{"aria-label":firstItem.title,icon:firstItem.icon||ComposeIcon,intent,mode:"bleed",disabled,"data-testid":"action-intent-button"})});}return/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{icon:ComposeIcon,mode:"bleed",padding:3,"data-testid":"multi-action-intent-button"}),id:"create-menu",menu:/* @__PURE__ */jsxs(Menu,{children:[/* @__PURE__ */jsx(Box,{paddingX:3,paddingTop:3,paddingBottom:2,children:/* @__PURE__ */jsx(Label,{muted:true,children:"Create"})}),templateItems.map((item,itemIndex)=>{const permissions=permissionsById[item.id];const disabled=!(permissions==null?void 0:permissions.granted);const intent=getIntent(schema,templates,item);const template=templates.find(t=>t.id===item.templateId);if(!template||!intent)return null;const Link=forwardRef((linkProps,linkRef)=>disabled?/* @__PURE__ */jsx("button",_objectSpread(_objectSpread({type:"button",disabled:true},linkProps),{},{ref:linkRef})):/* @__PURE__ */jsx(IntentLink,_objectSpread(_objectSpread({},linkProps),{},{intent:intent.type,params:intent.params,ref:linkRef})));Link.displayName="Link";return/* @__PURE__ */jsx(InsufficientPermissionsMessageTooltip,{reveal:disabled,loading:isTemplatePermissionsLoading,children:/* @__PURE__ */jsx(MenuItem,{as:Link,"data-as":disabled?"button":"a",text:item.title||template.title,"aria-label":disabled?"Insufficient permissions":item.title||template.title,disabled,"data-testid":"action-intent-button-".concat(itemIndex)})},item.id);})]}),popover:POPOVER_PROPS$1});}const emptyArray$1=[];const emptyObject$1={};function isNonNullable$1(value){return value!==null&&value!==void 0;}const hashObject=value=>{const sortObject=v=>{if(typeof v!=="object"||!v)return v;if(Array.isArray(v))return v.map(sortObject);return Object.entries(v).sort((_ref174,_ref175)=>{let[keyA]=_ref174;let[keyB]=_ref175;return keyA.localeCompare(keyB,"en");});};const normalize=v=>JSON.parse(JSON.stringify(v));return JSON.stringify(sortObject(normalize(value)));};const PaneHeaderActions=memo(_ref176=>{let{initialValueTemplateItems:initialValueTemplateItemsFromStructure=emptyArray$1,menuItems=emptyArray$1,menuItemGroups=emptyArray$1,actionHandlers=emptyObject$1}=_ref176;const templates=useTemplates();const handleAction=useCallback(item=>{if(typeof item.action==="string"&&!(item.action in actionHandlers)){console.warn("No handler for action:",item.action);return false;}const handler=typeof item.action==="function"?item.action:typeof item.action==="string"?actionHandlers[item.action]:null;if(handler){handler(item.params);return true;}return false;},[actionHandlers]);const[actionMenuItems,contextMenuItems]=useMemo(()=>{const nonCreateMenuItem=menuItems.filter(item=>{var _a;return((_a=item.intent)==null?void 0:_a.type)!=="create";});return partition$1(nonCreateMenuItem,item=>item.showAsAction);},[menuItems]);const initialValueTemplateItemFromMenuItems=useMemo(()=>{return menuItems.map((item,menuItemIndex)=>{var _a;if(((_a=item.intent)==null?void 0:_a.type)!=="create")return null;const{params}=item.intent;if(!params)return null;const intentParams=Array.isArray(params)?params[0]:params;const templateParams=Array.isArray(params)?params[1]:void 0;const templateId=intentParams.template||intentParams.type;if(!templateId)return null;const template=templates.find(t=>t.id===templateId);if(!template)return null;const initialDocumentId=intentParams.id;return{item,template,templateParams,menuItemIndex,initialDocumentId};}).filter(isNonNullable$1).map(_ref177=>{let{initialDocumentId,item,template,menuItemIndex,templateParams}=_ref177;const initialValueTemplateItem={id:"menuItem".concat(menuItemIndex),initialDocumentId,templateId:template.id,type:"initialValueTemplateItem",title:item.title||template.title,icon:item.icon,description:template.description,parameters:templateParams,schemaType:template.schemaType};return initialValueTemplateItem;});},[menuItems,templates]);const combinedInitialValueTemplates=useMemo(()=>{return uniqBy([...initialValueTemplateItemFromMenuItems,...initialValueTemplateItemsFromStructure],item=>hashObject([item.initialDocumentId,item.templateId,item.parameters]));},[initialValueTemplateItemFromMenuItems,initialValueTemplateItemsFromStructure]);return/* @__PURE__ */jsx(Inline,{space:1,children:[Boolean(combinedInitialValueTemplates.length)&&/* @__PURE__ */jsx(PaneHeaderCreateButton,{templateItems:combinedInitialValueTemplates},"$CreateMenuButton"),...actionMenuItems.map((actionItem,actionIndex)=>{return/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:actionItem.title})}),placement:"bottom",children:actionItem.intent?/* @__PURE__ */jsx(IntentButton,{intent:actionItem.intent,"aria-label":actionItem.title,icon:actionItem.icon||UnknownIcon,mode:"bleed"}):/* @__PURE__ */jsx(Button,{"aria-label":actionItem.title,icon:actionItem.icon||UnknownIcon,mode:"bleed",onClick:()=>handleAction(actionItem)})},"".concat(actionIndex,"-").concat(actionItem.title));}),Boolean(contextMenuItems.length)&&/* @__PURE__ */jsx(PaneContextMenuButton,{items:contextMenuItems,itemGroups:menuItemGroups,onAction:handleAction},"$ContextMenu")]});});PaneHeaderActions.displayName="PaneHeaderActions";const DeskToolContext=createContext(null);class SerializeError extends Error{constructor(message,parentPath,pathSegment,hint){super(message);const segment=typeof pathSegment==="undefined"?"<unknown>":"".concat(pathSegment);this.path=(parentPath||[]).concat(hint?"".concat(segment," (").concat(hint,")"):segment);}withHelpUrl(id){this.helpId=id;return this;}}var HELP_URL=/* @__PURE__ */(HELP_URL2=>{HELP_URL2["ID_REQUIRED"]="structure-node-id-required";HELP_URL2["TITLE_REQUIRED"]="structure-title-required";HELP_URL2["FILTER_REQUIRED"]="structure-filter-required";HELP_URL2["INVALID_LIST_ITEM"]="structure-invalid-list-item";HELP_URL2["COMPONENT_REQUIRED"]="structure-view-component-required";HELP_URL2["DOCUMENT_ID_REQUIRED"]="structure-document-id-required";HELP_URL2["DOCUMENT_TYPE_REQUIRED"]="structure-document-type-required";HELP_URL2["SCHEMA_TYPE_REQUIRED"]="structure-schema-type-required";HELP_URL2["SCHEMA_TYPE_NOT_FOUND"]="structure-schema-type-not-found";HELP_URL2["LIST_ITEMS_MUST_BE_ARRAY"]="structure-list-items-must-be-array";HELP_URL2["QUERY_PROVIDED_FOR_FILTER"]="structure-query-provided-for-filter";HELP_URL2["ACTION_OR_INTENT_REQUIRED"]="structure-action-or-intent-required";HELP_URL2["LIST_ITEM_IDS_MUST_BE_UNIQUE"]="structure-list-item-ids-must-be-unique";HELP_URL2["ACTION_AND_INTENT_MUTUALLY_EXCLUSIVE"]="structure-action-and-intent-mutually-exclusive";return HELP_URL2;})(HELP_URL||{});const IMPLICIT_FIELDS=["_id","_type","_createdAt","_updatedAt","_rev"];function joinReferences(schemaType,path){const[head,...tail]=path;if(!("fields"in schemaType)){return"";}const schemaField=schemaType.fields.find(field=>field.name===head);if(!schemaField){if(!IMPLICIT_FIELDS.includes(head)){console.warn('The current ordering config targeted the nonexistent field "%s" on schema type "%s". It should be one of %o',head,schemaType.name,schemaType.fields.map(field=>field.name));}return"";}if("to"in schemaField.type&&schemaField.type.name==="reference"){const refTypes=schemaField.type.to;return"".concat(head,"->{").concat(refTypes.map(refType=>joinReferences(refType,tail)).join(","),"}");}const tailFields=tail.length>0&&joinReferences(schemaField.type,tail);const tailWrapper=tailFields?"{".concat(tailFields,"}"):"";return tail.length>0?"".concat(head).concat(tailWrapper):head;}function getExtendedProjection(schemaType,orderBy){return orderBy.map(ordering=>joinReferences(schemaType,ordering.field.split("."))).join(", ");}const ORDER_BY_UPDATED_AT={title:"Last edited",name:"lastEditedDesc",by:[{field:"_updatedAt",direction:"desc"}]};const ORDER_BY_CREATED_AT={title:"Created",name:"lastCreatedDesc",by:[{field:"_createdAt",direction:"desc"}]};const DEFAULT_SELECTED_ORDERING_OPTION=ORDER_BY_UPDATED_AT;const DEFAULT_ORDERING_OPTIONS=[ORDER_BY_UPDATED_AT,ORDER_BY_CREATED_AT];function maybeSerializeMenuItem(item,index,path){return item instanceof MenuItemBuilder?item.serialize({path,index}):item;}class MenuItemBuilder{constructor(_context,spec){this._context=_context;this.spec=spec?spec:{};}action(action){return this.clone({action});}getAction(){return this.spec.action;}intent(intent){return this.clone({intent});}getIntent(){return this.spec.intent;}title(title){return this.clone({title});}getTitle(){return this.spec.title;}group(group){return this.clone({group});}getGroup(){return this.spec.group;}icon(icon){return this.clone({icon});}getIcon(){return this.spec.icon;}params(params){return this.clone({params});}getParams(){return this.spec.params;}showAsAction(){let showAsAction=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;return this.clone({showAsAction:Boolean(showAsAction)});}getShowAsAction(){return this.spec.showAsAction;}serialize(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{path:[]};const{title,action,intent}=this.spec;if(!title){const hint=typeof action==="string"?"action: \"".concat(action,"\""):void 0;throw new SerializeError("`title` is required for menu item",options.path,options.index,hint).withHelpUrl(HELP_URL.TITLE_REQUIRED);}if(!action&&!intent){throw new SerializeError("`action` or `intent` required for menu item with title ".concat(this.spec.title),options.path,options.index,"\"".concat(title,"\"")).withHelpUrl(HELP_URL.ACTION_OR_INTENT_REQUIRED);}if(intent&&action){throw new SerializeError("cannot set both `action` AND `intent`",options.path,options.index,"\"".concat(title,"\"")).withHelpUrl(HELP_URL.ACTION_AND_INTENT_MUTUALLY_EXCLUSIVE);}return _objectSpread(_objectSpread({},this.spec),{},{title});}clone(withSpec){const builder=new MenuItemBuilder(this._context);builder.spec=_objectSpread(_objectSpread({},this.spec),withSpec||{});return builder;}}function getOrderingMenuItem(context,ordering,extendedProjection){return new MenuItemBuilder(context).group("sorting").title("Sort by ".concat(ordering.title)).icon(SortIcon).action("setSortOrder").params({by:ordering.by,extendedProjection});}function getOrderingMenuItemsForSchemaType(context,typeName){const{schema}=context;const type=typeof typeName==="string"?schema.get(typeName):typeName;if(!type||!("orderings"in type)){return[];}return(type.orderings?type.orderings.concat(DEFAULT_ORDERING_OPTIONS):DEFAULT_ORDERING_OPTIONS).map(ordering=>getOrderingMenuItem(context,ordering,getExtendedProjection(type,ordering.by)));}function maybeSerializeMenuItemGroup(item,index,path){return item instanceof MenuItemGroupBuilder?item.serialize({path,index}):item;}class MenuItemGroupBuilder{constructor(_context,spec){this._context=_context;this._id=spec?spec.id:"";this._title=spec?spec.title:"";}id(id){return new MenuItemGroupBuilder(this._context,{id,title:this._title});}getId(){return this._id;}title(title){return new MenuItemGroupBuilder(this._context,{id:this._id,title});}getTitle(){return this._title;}serialize(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{path:[]};const{_id,_title}=this;if(!_id){throw new SerializeError("`id` is required for a menu item group",options.path,options.index,_title).withHelpUrl(HELP_URL.ID_REQUIRED);}if(!_title){throw new SerializeError("`title` is required for a menu item group",options.path,_id).withHelpUrl(HELP_URL.TITLE_REQUIRED);}return{id:_id,title:_title};}}const disallowedPattern=/([^A-Za-z0-9-_.])/;function validateId(id,parentPath,pathSegment){if(typeof id!=="string"){throw new SerializeError("Structure node id must be of type string, got ".concat(typeof id),parentPath,pathSegment);}const[disallowedChar]=id.match(disallowedPattern)||[];if(disallowedChar){throw new SerializeError("Structure node id cannot contain character \"".concat(disallowedChar,"\""),parentPath,pathSegment);}if(id.startsWith("__edit__")){throw new SerializeError("Structure node id cannot start with __edit__",parentPath,pathSegment);}return id;}class GenericViewBuilder{constructor(){this.spec={};}id(id){return this.clone({id});}getId(){return this.spec.id;}title(title){return this.clone({title,id:this.spec.id||kebabCase(title)});}getTitle(){return this.spec.title;}icon(icon){return this.clone({icon});}getIcon(){return this.spec.icon;}serialize(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{path:[]};const{id,title,icon}=this.spec;if(!id){throw new SerializeError("`id` is required for view item",options.path,options.index).withHelpUrl(HELP_URL.ID_REQUIRED);}if(!title){throw new SerializeError("`title` is required for view item",options.path,options.index).withHelpUrl(HELP_URL.TITLE_REQUIRED);}return{id:validateId(id,options.path,options.index),title,icon};}}function isSerializable$1(view){return typeof view.serialize==="function";}function maybeSerializeView(item,index,path){return isSerializable$1(item)?item.serialize({path,index}):item;}const isComponentSpec=spec=>isRecord$2(spec)&&spec.type==="component";class ComponentViewBuilder extends GenericViewBuilder{constructor(componentOrSpec){const spec=isComponentSpec(componentOrSpec)?_objectSpread({},componentOrSpec):{options:{}};super();this.spec=spec;const userComponent=typeof componentOrSpec==="function"?componentOrSpec:this.spec.component;if(userComponent){this.spec=this.component(userComponent).spec;}}component(component){return this.clone({component});}getComponent(){return this.spec.component;}options(options){return this.clone({options});}getOptions(){return this.spec.options||{};}serialize(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{path:[]};const base=super.serialize(options);const component=this.spec.component;if(typeof component!=="function"){throw new SerializeError("`component` is required and must be a function for `component()` view item",options.path,options.index).withHelpUrl(HELP_URL.COMPONENT_REQUIRED);}return _objectSpread(_objectSpread({},base),{},{component,options:this.spec.options||{},type:"component"});}clone(withSpec){const builder=new ComponentViewBuilder();builder.spec=_objectSpread(_objectSpread({},this.spec),withSpec||{});return builder;}}class FormViewBuilder extends GenericViewBuilder{constructor(spec){super();this.spec=_objectSpread({id:"editor",title:"Editor"},spec?spec:{});}serialize(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{path:[]};return _objectSpread(_objectSpread({},super.serialize(options)),{},{type:"form"});}clone(withSpec){const builder=new FormViewBuilder();builder.spec=_objectSpread(_objectSpread({},this.spec),withSpec||{});return builder;}}const form=spec=>new FormViewBuilder(spec);const component=componentOrSpec=>new ComponentViewBuilder(componentOrSpec);var views=/*#__PURE__*/Object.freeze({__proto__:null,form:form,component:component,FormViewBuilder:FormViewBuilder,ComponentViewBuilder:ComponentViewBuilder,GenericViewBuilder:GenericViewBuilder,maybeSerializeView:maybeSerializeView});const createDocumentChildResolver=_ref178=>{let{resolveDocumentNode}=_ref178;return(itemId,_ref179)=>{let{params,path}=_ref179;const{type}=params;const parentPath=path.slice(0,path.length-1);const currentSegment=path[path.length-1];if(!type){throw new SerializeError("Invalid link. Your link must contain a `type`.",parentPath,currentSegment);}return resolveDocumentNode({documentId:itemId,schemaType:type});};};class DocumentBuilder{constructor(_context,spec){this._context=_context;this.spec=spec?spec:{};}id(id){return this.clone({id});}getId(){return this.spec.id;}title(title){return this.clone({title,id:this.spec.id||camelCase(title)});}getTitle(){return this.spec.title;}child(child){return this.clone({child});}getChild(){return this.spec.child;}documentId(documentId){const paneId=this.spec.id||documentId;return this.clone({id:paneId,options:_objectSpread(_objectSpread({},this.spec.options||{}),{},{id:documentId})});}getDocumentId(){var _a;return(_a=this.spec.options)==null?void 0:_a.id;}schemaType(documentType){return this.clone({options:_objectSpread(_objectSpread({},this.spec.options||{}),{},{type:typeof documentType==="string"?documentType:documentType.name})});}getSchemaType(){var _a;return(_a=this.spec.options)==null?void 0:_a.type;}initialValueTemplate(templateId,parameters){return this.clone({options:_objectSpread(_objectSpread({},this.spec.options||{}),{},{template:templateId,templateParameters:parameters})});}getInitialValueTemplate(){var _a;return(_a=this.spec.options)==null?void 0:_a.template;}getInitialValueTemplateParameters(){var _a;return(_a=this.spec.options)==null?void 0:_a.templateParameters;}views(views){return this.clone({views});}getViews(){return this.spec.views||[];}serialize(){let{path=[],index,hint}=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{path:[]};const urlId=path[index||path.length-1];const id=this.spec.id||urlId&&"".concat(urlId)||"";const options=_objectSpread({id,type:void 0,template:void 0,templateParameters:void 0},this.spec.options);if(typeof id!=="string"||!id){throw new SerializeError("`id` is required for document nodes",path,index,hint).withHelpUrl(HELP_URL.ID_REQUIRED);}if(!options||!options.id){throw new SerializeError("document id (`id`) is required for document nodes",path,id,hint).withHelpUrl(HELP_URL.DOCUMENT_ID_REQUIRED);}if(!options||!options.type){throw new SerializeError("document type (`schemaType`) is required for document nodes",path,id,hint);}const views=(this.spec.views&&this.spec.views.length>0?this.spec.views:[form()]).map((item,i)=>maybeSerializeView(item,i,path));const viewIds=views.map(view=>view.id);const dupes=uniq(viewIds.filter((viewId,i)=>viewIds.includes(viewId,i+1)));if(dupes.length>0){throw new SerializeError("document node has views with duplicate IDs: ".concat(dupes.join(",  ")),path,id,hint);}return _objectSpread(_objectSpread({},this.spec),{},{child:this.spec.child||createDocumentChildResolver(this._context),id:validateId(id,path,index),type:"document",options:getDocumentOptions(options),views});}clone(){let withSpec=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const builder=new DocumentBuilder(this._context);const options=_objectSpread(_objectSpread({},this.spec.options||{}),withSpec.options||{});builder.spec=_objectSpread(_objectSpread(_objectSpread({},this.spec),withSpec),{},{options});return builder;}}function getDocumentOptions(spec){const opts={id:spec.id||"",type:spec.type||"*"};if(spec.template){opts.template=spec.template;}if(spec.templateParameters){opts.templateParameters=spec.templateParameters;}return opts;}function documentFromEditor(context,spec){let doc=(spec==null?void 0:spec.type)?context.resolveDocumentNode({schemaType:spec.type}):new DocumentBuilder(context);if(!spec)return doc;const{id,type,template,templateParameters}=spec.options;doc=doc.id(spec.id).documentId(id);if(type){doc=doc.schemaType(type);}if(template){doc=doc.initialValueTemplate(template,templateParameters);}if(spec.child){doc=doc.child(spec.child);}return doc;}function documentFromEditorWithInitialValue(_ref180,templateId,parameters){let{resolveDocumentNode,templates}=_ref180;const template=templates.find(t=>t.id===templateId);if(!template){throw new Error("Template with ID \"".concat(templateId,"\" not defined"));}return resolveDocumentNode({schemaType:template.schemaType}).initialValueTemplate(templateId,parameters);}const layoutOptions=["default","card","media","detail","block"];const DEFAULT_INTENT_HANDLER=Symbol("Document type list canHandleIntent");const defaultIntentChecker=(intentName,params,_ref181)=>{let{pane}=_ref181;var _a,_b;const isEdit=intentName==="edit";const isCreate=intentName==="create";const typedSpec=pane;const paneFilter=((_a=typedSpec.options)==null?void 0:_a.filter)||"";const paneParams=((_b=typedSpec.options)==null?void 0:_b.params)||{};const typeNames=typedSpec.schemaTypeName?[typedSpec.schemaTypeName]:getTypeNamesFromFilter(paneFilter,paneParams);const initialValueTemplates=typedSpec.initialValueTemplates||[];if(isCreate&&params.template){return initialValueTemplates.some(tpl=>tpl.templateId===params.template);}return isEdit&&params.id&&typeNames.includes(params.type)||isCreate&&typeNames.includes(params.type);};defaultIntentChecker.identity=DEFAULT_INTENT_HANDLER;class InitialValueTemplateItemBuilder{constructor(_context,spec){this._context=_context;this.spec=spec?spec:{};}id(id){return this.clone({id});}getId(){return this.spec.id;}title(title){return this.clone({title});}getTitle(){return this.spec.title;}description(description){return this.clone({description});}getDescription(){return this.spec.description;}templateId(templateId){const paneId=this.spec.id||templateId;return this.clone({id:paneId,templateId});}getTemplateId(){return this.spec.templateId;}parameters(parameters){return this.clone({parameters});}getParameters(){return this.spec.parameters;}serialize(){let{path=[],index,hint}=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{path:[]};const{spec,_context}=this;const{templates}=_context;if(typeof spec.id!=="string"||!spec.id){throw new SerializeError("`id` is required for initial value template item nodes",path,index,hint).withHelpUrl(HELP_URL.ID_REQUIRED);}if(!spec.templateId){throw new SerializeError("template id (`templateId`) is required for initial value template item nodes",path,spec.id,hint).withHelpUrl(HELP_URL.ID_REQUIRED);}const template=templates.find(t=>t.id===spec.templateId);if(!template){throw new SerializeError("template id (`templateId`) is required for initial value template item nodes",path,spec.id,hint).withHelpUrl(HELP_URL.ID_REQUIRED);}return{id:spec.id,templateId:spec.id,schemaType:template.schemaType,type:"initialValueTemplateItem",description:spec.description||template.description,title:spec.title||template.title,subtitle:spec.subtitle,icon:spec.icon||template.icon,initialDocumentId:spec.initialDocumentId,parameters:spec.parameters};}clone(){let withSpec=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const builder=new InitialValueTemplateItemBuilder(this._context);builder.spec=_objectSpread(_objectSpread({},this.spec),withSpec);return builder;}}function defaultInitialValueTemplateItems(context){const{schema,getStructureBuilder,templates}=context;const typeNames=schema.getTypeNames();const ordered=templates.filter(tpl=>{var _a;return!((_a=tpl.parameters)==null?void 0:_a.length);}).sort((a,b)=>typeNames.indexOf(a.schemaType)-typeNames.indexOf(b.schemaType));return ordered.map(tpl=>getStructureBuilder().initialValueTemplateItem(tpl.id));}function maybeSerializeInitialValueTemplateItem(item,index,path){return item instanceof InitialValueTemplateItemBuilder?item.serialize({path,index}):item;}function menuItemsFromInitialValueTemplateItems(context,templateItems){const{schema,templates}=context;return templateItems.map(item=>{const template=templates.find(t=>t.id===item.templateId);const title=item.title||(template==null?void 0:template.title)||"Create new";const params=pickBy({type:template&&template.schemaType,template:item.templateId},Boolean);const intentParams=item.parameters?[params,item.parameters]:params;const schemaType=template&&schema.get(template.schemaType);return new MenuItemBuilder(context).title(title).icon(template&&template.icon||(schemaType==null?void 0:schemaType.icon)||ComposeIcon).intent({type:"create",params:intentParams}).serialize();});}function noChildResolver(){return void 0;}const shallowIntentChecker=(intentName,params,_ref182)=>{let{pane,index}=_ref182;return index<=1&&defaultIntentChecker(intentName,params,{pane,index});};class GenericListBuilder{constructor(){this.initialValueTemplatesSpecified=false;this.spec={};}id(id){return this.clone({id});}getId(){return this.spec.id;}title(title){return this.clone({title,id:this.spec.id||camelCase(title)});}getTitle(){return this.spec.title;}defaultLayout(defaultLayout){return this.clone({defaultLayout});}getDefaultLayout(){return this.spec.defaultLayout;}menuItems(menuItems){return this.clone({menuItems});}getMenuItems(){return this.spec.menuItems;}menuItemGroups(menuItemGroups){return this.clone({menuItemGroups});}getMenuItemGroups(){return this.spec.menuItemGroups;}child(child){return this.clone({child});}getChild(){return this.spec.child;}canHandleIntent(canHandleIntent){return this.clone({canHandleIntent});}getCanHandleIntent(){return this.spec.canHandleIntent;}showIcons(){let enabled=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;return this.clone({displayOptions:_objectSpread(_objectSpread({},this.spec.displayOptions||{}),{},{showIcons:enabled})});}getShowIcons(){return this.spec.displayOptions?this.spec.displayOptions.showIcons:void 0;}initialValueTemplates(templates){this.initialValueTemplatesSpecified=true;return this.clone({initialValueTemplates:Array.isArray(templates)?templates:[templates]});}getInitialValueTemplates(){return this.spec.initialValueTemplates;}serialize(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{path:[]};const id=this.spec.id||"";const path=options.path;const defaultLayout=this.spec.defaultLayout;if(defaultLayout&&!layoutOptions.includes(defaultLayout)){throw new SerializeError("`layout` must be one of ".concat(layoutOptions.map(item=>"\"".concat(item,"\"")).join(", ")),path,id||options.index,this.spec.title);}const initialValueTemplates=(this.spec.initialValueTemplates||[]).map((item,i)=>maybeSerializeInitialValueTemplateItem(item,i,path));return{id:validateId(id,options.path,id||options.index),title:this.spec.title,type:"genericList",defaultLayout,child:this.spec.child||noChildResolver,canHandleIntent:this.spec.canHandleIntent||shallowIntentChecker,displayOptions:this.spec.displayOptions,initialValueTemplates,menuItems:(this.spec.menuItems||[]).map((item,i)=>maybeSerializeMenuItem(item,i,path)),menuItemGroups:(this.spec.menuItemGroups||[]).map((item,i)=>maybeSerializeMenuItemGroup(item,i,path))};}}const resolveTypeForDocument=async(getClient,id)=>{const query="*[_id in [$documentId, $draftId]]._type";const documentId=id.replace(/^drafts\./,"");const draftId="drafts.".concat(documentId);const types=await getClient(DEFAULT_STUDIO_CLIENT_OPTIONS).fetch(query,{documentId,draftId},{tag:"structure.resolve-type"});return types[0];};const validateFilter=(spec,options)=>{var _a;const filter=((_a=spec.options)==null?void 0:_a.filter.trim())||"";if(["*","{"].includes(filter[0])){throw new SerializeError("`filter` cannot start with `".concat(filter[0],"` - looks like you are providing a query, not a filter"),options.path,spec.id,spec.title).withHelpUrl(HELP_URL.QUERY_PROVIDED_FOR_FILTER);}return filter;};const createDocumentChildResolverForItem=context=>(itemId,options)=>{var _a;const parentItem=options.parent;const template=((_a=options.params)==null?void 0:_a.template)?context.templates.find(tpl=>tpl.id===options.params.template):void 0;const type=template?template.schemaType:parentItem.schemaTypeName||resolveTypeForDocument(context.getClient,itemId);return Promise.resolve(type).then(schemaType=>schemaType?context.resolveDocumentNode({schemaType,documentId:itemId}):new DocumentBuilder(context).id("editor").documentId(itemId).schemaType(""));};class DocumentListBuilder extends GenericListBuilder{constructor(_context,spec){super();this._context=_context;this.spec=spec||{};this.initialValueTemplatesSpecified=Boolean(spec==null?void 0:spec.initialValueTemplates);}apiVersion(apiVersion){return this.clone({options:_objectSpread(_objectSpread({},this.spec.options||{filter:""}),{},{apiVersion})});}getApiVersion(){var _a;return(_a=this.spec.options)==null?void 0:_a.apiVersion;}filter(filter){return this.clone({options:_objectSpread(_objectSpread({},this.spec.options||{}),{},{filter})});}getFilter(){var _a;return(_a=this.spec.options)==null?void 0:_a.filter;}schemaType(type){const schemaTypeName=typeof type==="string"?type:type.name;return this.clone({schemaTypeName});}getSchemaType(){return this.spec.schemaTypeName;}params(params){return this.clone({options:_objectSpread(_objectSpread({},this.spec.options||{filter:""}),{},{params})});}getParams(){var _a;return(_a=this.spec.options)==null?void 0:_a.params;}defaultOrdering(ordering){if(!Array.isArray(ordering)){throw new Error("`defaultOrdering` must be an array of order clauses");}return this.clone({options:_objectSpread(_objectSpread({},this.spec.options||{filter:""}),{},{defaultOrdering:ordering})});}getDefaultOrdering(){var _a;return(_a=this.spec.options)==null?void 0:_a.defaultOrdering;}serialize(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{path:[]};var _a;if(typeof this.spec.id!=="string"||!this.spec.id){throw new SerializeError("`id` is required for document lists",options.path,options.index,this.spec.title).withHelpUrl(HELP_URL.ID_REQUIRED);}if(!this.spec.options||!this.spec.options.filter){throw new SerializeError("`filter` is required for document lists",options.path,this.spec.id,this.spec.title).withHelpUrl(HELP_URL.FILTER_REQUIRED);}return _objectSpread(_objectSpread({},super.serialize(options)),{},{type:"documentList",schemaTypeName:this.spec.schemaTypeName,child:this.spec.child||createDocumentChildResolverForItem(this._context),options:_objectSpread(_objectSpread({},this.spec.options),{},{apiVersion:this.spec.options.apiVersion||(((_a=this.spec.options)==null?void 0:_a.filter)==="_type == $type"?"2021-06-07":"1"),filter:validateFilter(this.spec,options)})});}clone(withSpec){const builder=new DocumentListBuilder(this._context);builder.spec=_objectSpread(_objectSpread({},this.spec),withSpec||{});if(!this.initialValueTemplatesSpecified){builder.spec.initialValueTemplates=inferInitialValueTemplates(this._context,builder.spec);}if(!builder.spec.schemaTypeName){builder.spec.schemaTypeName=inferTypeName(builder.spec);}return builder;}getSpec(){return this.spec;}}function inferInitialValueTemplates(context,spec){const{document}=context;const{schemaTypeName,options}=spec;const{filter,params}=options||{filter:"",params:{}};const typeNames=schemaTypeName?[schemaTypeName]:Array.from(new Set(getTypeNamesFromFilter(filter,params)));if(typeNames.length===0){return void 0;}return typeNames.flatMap(schemaType=>document.resolveNewDocumentOptions({type:"structure",schemaType})).map(option=>_objectSpread(_objectSpread({},option),{},{icon:ComposeIcon}));}function inferTypeName(spec){const{options}=spec;const{filter,params}=options||{filter:"",params:{}};const typeNames=getTypeNamesFromFilter(filter,params);return typeNames.length===1?typeNames[0]:void 0;}function getTypeNamesFromFilter(filter){let params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};let typeNames=getTypeNamesFromEqualityFilter(filter,params);if(typeNames.length===0){typeNames=getTypeNamesFromInTypesFilter(filter,params);}return typeNames;}function getTypeNamesFromEqualityFilter(filter){let params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};const pattern=/\b_type\s*==\s*(['"].*?['"]|\$.*?(?:\s|$))|\B(['"].*?['"]|\$.*?(?:\s|$))\s*==\s*_type/g;const matches=[];let match;while((match=pattern.exec(filter))!==null){matches.push(match[1]||match[2]);}return matches.map(candidate=>{const typeName=candidate[0]==="$"?params[candidate.slice(1)]:candidate;const normalized=(typeName||"").trim().replace(/^["']|["']$/g,"");return normalized;}).filter(Boolean);}function getTypeNamesFromInTypesFilter(filter){let params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};const pattern=/\b_type\s+in\s+\[(.*?)\]/;const matches=filter.match(pattern);if(!matches){return[];}return matches[1].split(/,\s*/).map(match=>match.trim().replace(/^["']+|["']+$/g,"")).map(item=>item[0]==="$"?params[item.slice(1)]:item).filter(Boolean);}const _DEBUG=false;const EMPTY_PARAMS={};const LOADING_PANE=Symbol("LOADING_PANE");class PaneResolutionError extends Error{constructor(_ref183){let{message,context,helpId,cause}=_ref183;super(message);this.context=context;this.helpId=helpId;this.cause=cause;}}const randomIdCache=/* @__PURE__ */new WeakMap();function assignId(obj){const cachedValue=randomIdCache.get(obj);if(cachedValue)return cachedValue;const id=nanoid();randomIdCache.set(obj,id);return id;}const bindCache=/* @__PURE__ */new WeakMap();function memoBind(obj,methodKey){const boundMethods=bindCache.get(obj)||/* @__PURE__ */new Map();if(boundMethods){const bound2=boundMethods.get(methodKey);if(bound2)return bound2;}const method=obj[methodKey];if(typeof method!=="function"){throw new Error("Expected property `".concat(methodKey,"` to be a function but got ").concat(typeof method," instead."));}const bound=method.bind(obj);boundMethods.set(methodKey,bound);bindCache.set(obj,boundMethods);return bound;}const isSubscribable=thing=>{if(!isRecord$2(thing))return false;return typeof thing.subscribe==="function"||typeof thing.then==="function";};const isSerializable=thing=>{if(!isRecord$2(thing))return false;return typeof thing.serialize==="function";};const rethrowWithPaneResolutionErrors=next=>(unresolvedPane,context,flatIndex)=>{try{return next(unresolvedPane,context,flatIndex);}catch(e){if(e instanceof PaneResolutionError){throw e;}throw new PaneResolutionError({message:typeof(e==null?void 0:e.message)==="string"?e.message:"",context,cause:e});}};const wrapWithPublishReplay=next=>function(){return next(...arguments).pipe(publishReplay(1),refCount());};function createPaneResolver(middleware){const resolvePane=rethrowWithPaneResolutionErrors(wrapWithPublishReplay(middleware((unresolvedPane,context,flatIndex)=>{if(!unresolvedPane){throw new PaneResolutionError({message:"Pane returned no child",context,helpId:"structure-item-returned-no-child"});}if(isSubscribable(unresolvedPane)){return from(unresolvedPane).pipe(switchMap(result=>resolvePane(result,context,flatIndex)));}if(isSerializable(unresolvedPane)){return resolvePane(unresolvedPane.serialize(context),context,flatIndex);}if(typeof unresolvedPane==="function"){return resolvePane(unresolvedPane(context.id,context),context,flatIndex);}return of(unresolvedPane);})));return resolvePane;}function useDeskTool(){const deskTool=useContext(DeskToolContext);if(!deskTool)throw new Error("DeskTool: missing context value");return deskTool;}const fallbackEditorChild=(nodeId,context)=>{const id=nodeId.replace(/^__edit__/,"");const{params,payload,structureContext:{resolveDocumentNode}}=context;const{type,template}=params;if(!type){throw new Error("Document type for document with ID ".concat(id," was not provided in the router params."));}let defaultDocumentBuilder=resolveDocumentNode({schemaType:type,documentId:id});defaultDocumentBuilder=defaultDocumentBuilder.id("editor").title("Editor");if(template){defaultDocumentBuilder=defaultDocumentBuilder.initialValueTemplate(template,payload);}return defaultDocumentBuilder.serialize();};function hashContext(context){var _a,_b;return"contextHash(".concat(JSON.stringify({id:context.id,parentId:parent&&assignId(parent),path:context.path,index:context.index,splitIndex:context.splitIndex,serializeOptionsIndex:(_a=context.serializeOptions)==null?void 0:_a.index,serializeOptionsPath:(_b=context.serializeOptions)==null?void 0:_b.path}),")");}const hashResolvedPaneMeta=meta=>{const normalized={type:meta.type,id:meta.routerPaneSibling.id,params:meta.routerPaneSibling.params||{},payload:meta.routerPaneSibling.payload||null,flatIndex:meta.flatIndex,groupIndex:meta.groupIndex,siblingIndex:meta.siblingIndex,path:meta.path,paneNode:meta.type==="resolvedMeta"?assignId(meta.paneNode):null};return"metaHash(".concat(JSON.stringify(normalized),")");};function resolvePaneTree(_ref184){let{unresolvedPane,flattenedRouterPanes,parent:parent2,path,resolvePane,structureContext}=_ref184;const[current,...rest]=flattenedRouterPanes;const next=rest[0];const context={id:current.routerPaneSibling.id,splitIndex:current.siblingIndex,parent:parent2,path:[...path,current.routerPaneSibling.id],index:current.flatIndex,params:current.routerPaneSibling.params||{},payload:current.routerPaneSibling.payload,structureContext};try{return resolvePane(unresolvedPane,context,current.flatIndex).pipe(switchMap(paneNode=>{const resolvedPaneMeta=_objectSpread(_objectSpread({type:"resolvedMeta"},current),{},{paneNode,path:context.path});const loadingPanes=rest.map((i,restIndex)=>{const loadingPanePath=[...context.path,...rest.slice(restIndex).map((_,currentIndex)=>"[".concat(i.flatIndex+currentIndex,"]"))];const loadingPane=_objectSpread({type:"loading",path:loadingPanePath,paneNode:null},i);return loadingPane;});if(!rest.length){return of([resolvedPaneMeta]);}let nextStream;if(next==null?void 0:next.routerPaneSibling.id.startsWith("__edit__")){nextStream=resolvePaneTree({unresolvedPane:fallbackEditorChild,flattenedRouterPanes:rest,parent:parent2,path:context.path,resolvePane,structureContext});}else if(current.groupIndex===(next==null?void 0:next.groupIndex)){nextStream=resolvePaneTree({unresolvedPane,flattenedRouterPanes:rest,parent:parent2,path,resolvePane,structureContext});}else{nextStream=resolvePaneTree({unresolvedPane:typeof paneNode.child==="function"?memoBind(paneNode,"child"):paneNode.child,flattenedRouterPanes:rest,parent:paneNode,path:context.path,resolvePane,structureContext});}return concat(of([resolvedPaneMeta,...loadingPanes]),nextStream.pipe(map(nextResolvedPanes=>[resolvedPaneMeta,...nextResolvedPanes])));}));}catch(e){if(e instanceof PaneResolutionError){if(e.context){console.warn("Pane resolution error at index ".concat(e.context.index).concat(e.context.splitIndex>0?" for split pane index ".concat(e.context.splitIndex):"",": ").concat(e.message).concat(e.helpId?" - see ".concat(generateHelpUrl(e.helpId)):""),e);}if(e.helpId==="structure-item-returned-no-child"){return of([]);}}throw e;}}function createResolvedPaneNodeStream(_ref185){let{routerPanesStream,rootPaneNode,initialCacheState={cacheKeysByFlatIndex:[],flattenedRouterPanes:[],resolvedPaneCache:/* @__PURE__ */new Map(),resolvePane:()=>NEVER},structureContext}=_ref185;const resolvedPanes$=routerPanesStream.pipe(map(rawRouterPanes=>[[{id:"root"}],...rawRouterPanes]),map(routerPanes=>{const flattenedRouterPanes=routerPanes.flatMap((routerPaneGroup,groupIndex)=>routerPaneGroup.map((routerPaneSibling,siblingIndex)=>({routerPaneSibling,groupIndex,siblingIndex}))).map((i,index)=>_objectSpread(_objectSpread({},i),{},{flatIndex:index}));return flattenedRouterPanes;}),startWith([]),pairwise(),map(_ref186=>{let[prev,curr]=_ref186;for(let i=0;i<curr.length;i++){const prevValue=prev[i];const currValue=curr[i];if(!isEqual$1(prevValue,currValue)){return{flattenedRouterPanes:curr,diffIndex:i};}}return{flattenedRouterPanes:curr,diffIndex:curr.length};}),scan((acc,next)=>{const{cacheKeysByFlatIndex,resolvedPaneCache}=acc;const{flattenedRouterPanes,diffIndex}=next;const beforeDiffIndex=cacheKeysByFlatIndex.slice(0,diffIndex+1);const afterDiffIndex=cacheKeysByFlatIndex.slice(diffIndex+1);const keysToKeep=new Set(beforeDiffIndex.flatMap(keySet=>Array.from(keySet)));const keysToDelete=afterDiffIndex.flatMap(keySet=>Array.from(keySet)).filter(key=>!keysToKeep.has(key));for(const key of keysToDelete){resolvedPaneCache.delete(key);}const memoize=nextFn=>(unresolvedPane,context,flatIndex)=>{const key=unresolvedPane&&"".concat(assignId(unresolvedPane),"-").concat(hashContext(context));const cachedResolvedPane=key&&resolvedPaneCache.get(key);if(cachedResolvedPane)return cachedResolvedPane;const result=nextFn(unresolvedPane,context,flatIndex);if(!key)return result;const cacheKeySet=cacheKeysByFlatIndex[flatIndex]||/* @__PURE__ */new Set();cacheKeySet.add(key);cacheKeysByFlatIndex[flatIndex]=cacheKeySet;resolvedPaneCache.set(key,result);return result;};return{flattenedRouterPanes,cacheKeysByFlatIndex,resolvedPaneCache,resolvePane:createPaneResolver(memoize)};},initialCacheState),switchMap(_ref187=>{let{flattenedRouterPanes,resolvePane}=_ref187;return resolvePaneTree({unresolvedPane:rootPaneNode,flattenedRouterPanes,parent:null,path:[],resolvePane,structureContext});}));return resolvedPanes$.pipe(scan((prev,next)=>next.map((nextPane,index)=>{const prevPane=prev[index];if(!prevPane)return nextPane;if(nextPane.type!=="loading")return nextPane;if(prevPane.routerPaneSibling.id===nextPane.routerPaneSibling.id){return prevPane;}return nextPane;}),[]),distinctUntilChanged((prev,next)=>{if(prev.length!==next.length)return false;for(let i=0;i<next.length;i++){const prevValue=prev[i];const nextValue=next[i];if(hashResolvedPaneMeta(prevValue)!==hashResolvedPaneMeta(nextValue)){return false;}}return true;}));}function useRouterPanesStream(){const routerStateSubject=useMemo(()=>new ReplaySubject(1),[]);const routerPanes$=useMemo(()=>routerStateSubject.asObservable().pipe(map(_routerState=>(_routerState==null?void 0:_routerState.panes)||[])),[routerStateSubject]);const{state:routerState}=useRouter();useEffect(()=>{routerStateSubject.next(routerState);},[routerState,routerStateSubject]);return routerPanes$;}function useResolvedPanes(){const[error,setError]=useState();if(error)throw error;const{structureContext,rootPaneNode}=useDeskTool();const[data,setData]=useState({paneDataItems:[],resolvedPanes:[],routerPanes:[]});const routerPanesStream=useRouterPanesStream();useEffect(()=>{const resolvedPanes$=createResolvedPaneNodeStream({rootPaneNode,routerPanesStream,structureContext}).pipe(map(resolvedPanes=>{const routerPanes=resolvedPanes.reduce((acc,next)=>{const currentGroup=acc[next.groupIndex]||[];currentGroup[next.siblingIndex]=next.routerPaneSibling;acc[next.groupIndex]=currentGroup;return acc;},[]);const groupsLen=routerPanes.length;const paneDataItems=resolvedPanes.map(pane=>{var _a;const{groupIndex,flatIndex,siblingIndex,routerPaneSibling,path}=pane;const itemId=routerPaneSibling.id;const nextGroup=routerPanes[groupIndex+1];const paneDataItem={active:groupIndex===groupsLen-2,childItemId:(_a=nextGroup==null?void 0:nextGroup[0].id)!=null?_a:null,index:flatIndex,itemId:routerPaneSibling.id,groupIndex,key:"".concat(pane.type==="loading"?"unknown":pane.paneNode.id,"-").concat(itemId,"-").concat(siblingIndex),pane:pane.type==="loading"?LOADING_PANE:pane.paneNode,params:routerPaneSibling.params||{},path:path.join(";"),payload:routerPaneSibling.payload,selected:flatIndex===resolvedPanes.length-1,siblingIndex};return paneDataItem;});return{paneDataItems,routerPanes,resolvedPanes:paneDataItems.map(pane=>pane.pane)};}));const subscription=resolvedPanes$.subscribe({next:result=>setData(result),error:e=>setError(e)});return()=>subscription.unsubscribe();},[rootPaneNode,routerPanesStream,structureContext]);return data;}function Delay(_ref188){let{children,ms=0}=_ref188;const[ready,setReady]=useState(ms<=0);useEffect(()=>{if(ms<=0){return void 0;}const timeoutId=setTimeout(()=>setReady(true),ms);return()=>{clearTimeout(timeoutId);};},[ms]);if(!ready||!children){return/* @__PURE__ */jsx(Fragment,{});}return typeof children==="function"?children():children;}const PathSegment=styled.span(_templateObject118||(_templateObject118=_taggedTemplateLiteral(["\n  &:not(:last-child)::after {\n    content: ' \u279D ';\n    opacity: 0.5;\n  }\n"])));function formatStack(stack){return stack.replace(/\(\.\.\.\)\./g,"(...)\n  .").replace(/__WEBPACK_IMPORTED_MODULE_\d+_+/g,"").replace(/___default\./g,".").replace(new RegExp(" \\(https?:\\/\\/".concat(window.location.host),"g")," (");}function StructureError(_ref189){let{error}=_ref189;if(!(error instanceof PaneResolutionError)){throw error;}const{cause}=error;const stack=(cause==null?void 0:cause.stack)||error.stack;const showStack=stack&&!(cause instanceof SerializeError)&&!error.message.includes("Module build failed:");const path=cause instanceof SerializeError?cause.path:[];const helpId=cause instanceof SerializeError&&cause.helpId||error.helpId;const handleReload=useCallback(()=>{window.location.reload();},[]);return/* @__PURE__ */jsx(Card,{height:"fill",overflow:"auto",padding:4,sizing:"border",tone:"critical",children:/* @__PURE__ */jsxs(Container$1,{children:[/* @__PURE__ */jsx(Heading,{as:"h2",children:"Encountered an error while reading structure"}),/* @__PURE__ */jsxs(Card,{marginTop:4,padding:4,radius:2,overflow:"auto",shadow:1,tone:"inherit",children:[path.length>0&&/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsx(Label,{children:"Structure path"}),/* @__PURE__ */jsx(Code,{children:path.slice(1).map((segment,i)=>/* @__PURE__ */jsx(PathSegment,{children:segment},"".concat(segment,"-").concat(i)))})]}),/* @__PURE__ */jsxs(Stack,{marginTop:4,space:2,children:[/* @__PURE__ */jsx(Label,{children:"Error"}),/* @__PURE__ */jsx(Code,{children:showStack?formatStack(stack):error.message})]}),helpId&&/* @__PURE__ */jsx(Box,{marginTop:4,children:/* @__PURE__ */jsx(Text$1,{children:/* @__PURE__ */jsx("a",{href:generateHelpUrl(helpId),rel:"noopener noreferrer",target:"_blank",children:"View documentation"})})}),/* @__PURE__ */jsx(Box,{marginTop:4,children:/* @__PURE__ */jsx(Button,{text:"Reload",icon:SyncIcon,tone:"primary",onClick:handleReload})})]})]})});}function missingContext(){throw new Error("Pane is missing router context");}const PaneRouterContext=createContext({index:0,groupIndex:0,siblingIndex:0,payload:void 0,params:{},hasGroupSiblings:false,groupLength:0,routerPanesState:[],BackLink:()=>missingContext(),ChildLink:()=>missingContext(),ReferenceChildLink:()=>missingContext(),handleEditReference:()=>missingContext(),ParameterizedLink:()=>missingContext(),replaceCurrent:()=>missingContext(),closeCurrent:()=>missingContext(),duplicateCurrent:()=>missingContext(),setView:()=>missingContext(),setParams:()=>missingContext(),setPayload:()=>missingContext(),navigateIntent:()=>missingContext()});const BackLink=forwardRef(function BackLink2(props,ref){const{routerPanesState,groupIndex}=useContext(PaneRouterContext);const panes=useMemo(()=>routerPanesState.slice(0,groupIndex),[groupIndex,routerPanesState]);const state=useMemo(()=>({panes}),[panes]);return/* @__PURE__ */jsx(StateLink,_objectSpread(_objectSpread({},props),{},{ref,state}));});const ChildLink=forwardRef(function ChildLink2(props,ref){const{childId,childPayload,childParameters}=props,rest=_objectWithoutProperties(props,_excluded35);const{routerPanesState,groupIndex}=useContext(PaneRouterContext);return/* @__PURE__ */jsx(StateLink,_objectSpread(_objectSpread({},rest),{},{ref,state:{panes:[...routerPanesState.slice(0,groupIndex+1),[{id:childId,params:childParameters,payload:childPayload}]]}}));});const ReferenceChildLink=forwardRef(function ReferenceChildLink2(_ref190,ref){let{documentId,documentType,parentRefPath,children,template}=_ref190,rest=_objectWithoutProperties(_ref190,_excluded36);return/* @__PURE__ */jsx(ChildLink,_objectSpread(_objectSpread({},rest),{},{ref,childId:documentId,childPayload:template==null?void 0:template.params,childParameters:_objectSpread({type:documentType,parentRefPath:toString(parentRefPath)},template&&{template:template==null?void 0:template.id}),children}));});const ParameterizedLink=forwardRef(function ParameterizedLink2(props,ref){const{routerPanesState:currentPanes,groupIndex,siblingIndex}=useContext(PaneRouterContext);const{params,payload}=props,rest=_objectWithoutProperties(props,_excluded37);const nextParams=useUnique(params);const nextPayload=useUnique(payload);const nextState=useMemo(()=>{const currentGroup=currentPanes[groupIndex];const currentSibling=currentGroup[siblingIndex];const nextSibling=_objectSpread(_objectSpread({},currentSibling),{},{params:nextParams!=null?nextParams:currentSibling.params,payload:nextPayload!=null?nextPayload:currentSibling.payload});const nextGroup=[...currentGroup.slice(0,siblingIndex),nextSibling,...currentGroup.slice(siblingIndex+1)];const nextPanes=[...currentPanes.slice(0,groupIndex),nextGroup,...currentPanes.slice(groupIndex+1)];return{panes:nextPanes};},[currentPanes,groupIndex,nextParams,nextPayload,siblingIndex]);return/* @__PURE__ */jsx(StateLink,_objectSpread(_objectSpread({ref},rest),{},{state:nextState}));});const emptyArray=[];function PaneRouterProvider(props){const{children,flatIndex,index,params,payload,siblingIndex}=props;const{navigate,navigateIntent}=useRouter();const routerState=useRouterState$1();const routerPaneGroups=useMemo(()=>(routerState==null?void 0:routerState.panes)||emptyArray,[routerState==null?void 0:routerState.panes]);const groupIndex=index-1;const modifyCurrentGroup=useCallback(modifier=>{const currentGroup=routerPaneGroups[groupIndex]||[];const currentItem=currentGroup[siblingIndex];const nextGroup=modifier(currentGroup,currentItem);const nextPanes=[...routerPaneGroups.slice(0,groupIndex),nextGroup,...routerPaneGroups.slice(groupIndex+1)];const nextRouterState=_objectSpread(_objectSpread({},routerState||{}),{},{panes:nextPanes});setTimeout(()=>navigate(nextRouterState),0);return nextRouterState;},[groupIndex,navigate,routerPaneGroups,routerState,siblingIndex]);const setPayload=useCallback(nextPayload=>{modifyCurrentGroup((siblings,item)=>[...siblings.slice(0,siblingIndex),_objectSpread(_objectSpread({},item),{},{payload:nextPayload}),...siblings.slice(siblingIndex+1)]);},[modifyCurrentGroup,siblingIndex]);const setParams=useCallback(nextParams=>{modifyCurrentGroup((siblings,item)=>[...siblings.slice(0,siblingIndex),_objectSpread(_objectSpread({},item),{},{params:nextParams}),...siblings.slice(siblingIndex+1)]);},[modifyCurrentGroup,siblingIndex]);const handleEditReference=useCallback(_ref191=>{let{id,parentRefPath,type,template}=_ref191;navigate({panes:[...routerPaneGroups.slice(0,groupIndex+1),[{id,params:{template:template.id,parentRefPath:toString(parentRefPath),type},payload:template.params}]]});},[groupIndex,navigate,routerPaneGroups]);const ctx=useMemo(()=>({index:flatIndex,groupIndex,siblingIndex,payload,params,hasGroupSiblings:routerPaneGroups[groupIndex]?routerPaneGroups[groupIndex].length>1:false,groupLength:routerPaneGroups[groupIndex]?routerPaneGroups[groupIndex].length:0,routerPanesState:routerPaneGroups,ChildLink,BackLink,ReferenceChildLink,handleEditReference,ParameterizedLink,replaceCurrent:function(){let opts=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};modifyCurrentGroup(()=>[{id:opts.id||"",payload:opts.payload,params:opts.params||{}}]);},closeCurrent:()=>{modifyCurrentGroup((siblings,item)=>siblings.length>1?siblings.filter(sibling=>sibling!==item):siblings);},duplicateCurrent:options=>{modifyCurrentGroup((siblings,item)=>{const duplicatedItem=_objectSpread(_objectSpread({},item),{},{payload:(options==null?void 0:options.payload)||item.payload,params:(options==null?void 0:options.params)||item.params});return[...siblings.slice(0,siblingIndex),duplicatedItem,...siblings.slice(siblingIndex)];});},setView:viewId=>{const restParams=omit(params,"view");return setParams(viewId?_objectSpread(_objectSpread({},restParams),{},{view:viewId}):restParams);},setParams,setPayload,navigateIntent}),[flatIndex,groupIndex,handleEditReference,modifyCurrentGroup,navigateIntent,params,payload,routerPaneGroups,setParams,setPayload,siblingIndex]);return/* @__PURE__ */jsx(PaneRouterContext.Provider,{value:ctx,children});}function usePaneRouter(){return useContext(PaneRouterContext);}function UnknownPane(props){const{isSelected,pane,paneKey}=props;const type=isRecord$2(pane)&&pane.type||null;return/* @__PURE__ */jsxs(Pane,{id:paneKey,selected:isSelected,children:[/* @__PURE__ */jsx(PaneHeader,{title:"Unknown pane type"}),/* @__PURE__ */jsx(PaneContent,{children:/* @__PURE__ */jsx(Box,{padding:4,children:typeof type==="string"?/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,children:["Structure item of type ",/* @__PURE__ */jsx("code",{children:type})," is not a known entity."]}):/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,children:["Structure item is missing required ",/* @__PURE__ */jsx("code",{children:"type"})," property."]})})})]});}function getWaitMessages(path){const thresholds=[{ms:300,message:"Loading\u2026"},{ms:5e3,message:"Still loading\u2026"}];if(isDev){const message=["Check console for errors?","Is your observable/promise resolving?",path.length>0?"Structure path: ".concat(path.join(" \u279D ")):""];thresholds.push({ms:1e4,message:message.join("\n")});}const src=of(null);return merge(...thresholds.map(_ref192=>{let{ms,message}=_ref192;return src.pipe(mapTo(message),delay(ms));}));}const DEFAULT_MESSAGE="Loading\u2026";const Content$3=styled(Flex)(_templateObject119||(_templateObject119=_taggedTemplateLiteral(["\n  opacity: 0;\n  transition: opacity 200ms;\n\n  &[data-mounted] {\n    opacity: 1;\n  }\n"])));const LoadingPane=memo(props=>{const{delay=300,flex,message:messageProp=getWaitMessages,minWidth,paneKey,path,selected,title,tone}=props;const resolvedMessage=useMemo(()=>{if(typeof messageProp==="function"){return messageProp(path?path.split(";"):[]);}return messageProp;},[messageProp,path]);const[currentMessage,setCurrentMessage]=useState(()=>{if(typeof resolvedMessage==="string")return resolvedMessage;return DEFAULT_MESSAGE;});useEffect(()=>{if(typeof resolvedMessage!=="object")return void 0;if(typeof resolvedMessage.subscribe==="function")return void 0;const sub=resolvedMessage.subscribe(setCurrentMessage);return()=>sub.unsubscribe();},[resolvedMessage]);const[contentElement,setContentElement]=useState(null);const[mounted,setMounted]=useState(false);useEffect(()=>{if(!contentElement)return void 0;return _raf2(()=>setMounted(true));},[contentElement]);const content=/* @__PURE__ */jsxs(Content$3,{align:"center","data-mounted":mounted?"":void 0,direction:"column",height:"fill",justify:"center",ref:setContentElement,children:[/* @__PURE__ */jsx(Spinner,{muted:true}),(title||currentMessage)&&/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(Text$1,{align:"center",muted:true,size:1,children:title||currentMessage})})]});return/* @__PURE__ */jsx(Pane,{flex,id:paneKey,minWidth,selected,tone,children:/* @__PURE__ */jsx(PaneContent,{children:content})});});LoadingPane.displayName="LoadingPane";const paneMap={component:lazy(()=>import('./_index-15f14004.js')),document:lazy(()=>import('./_index-746d5002.js')),documentList:lazy(()=>import('./_index-24756d24.js')),list:lazy(()=>import('./_index-47e3084c.js'))};const DeskToolPane=memo(function DeskToolPane2(props){const{active,childItemId,groupIndex,index,itemId,pane,paneKey,params,payload,selected,siblingIndex}=props;const PaneComponent=paneMap[pane.type]||UnknownPane;return/* @__PURE__ */jsx(PaneRouterProvider,{flatIndex:index,index:groupIndex,params,payload,siblingIndex,children:/* @__PURE__ */jsx(Suspense,{fallback:/* @__PURE__ */jsx(LoadingPane,{paneKey}),children:/* @__PURE__ */jsx(PaneComponent,{childItemId:childItemId||"",index,itemId,isActive:active,isSelected:selected,paneKey,pane})})});},(_ref193,_ref194)=>{let{params:nextParams={},payload:nextPayload=null}=_ref194,next=_objectWithoutProperties(_ref194,_excluded38);let{params:prevParams={},payload:prevPayload=null}=_ref193,prev=_objectWithoutProperties(_ref193,_excluded39);if(!isEqual$1(prevParams,nextParams))return false;if(!isEqual$1(prevPayload,nextPayload))return false;const keys=/* @__PURE__ */new Set([...Object.keys(prev),...Object.keys(next)]);for(const key of keys){if(prev[key]!==next[key])return false;}return true;});function ErrorPane(props){const{children,flex,minWidth,paneKey,title="Error",tone="critical"}=props;return/* @__PURE__ */jsxs(Pane,{flex,id:paneKey,minWidth,tone,children:[/* @__PURE__ */jsx(PaneHeader,{title}),/* @__PURE__ */jsx(PaneContent,{overflow:"auto",children:/* @__PURE__ */jsx(Box,{paddingX:4,paddingY:5,children})})]});}const CORNER_RADIUS=4;const INTERACTIVE_STROKE_WIDTH=16;const CONNECTOR_MARGIN=8;const ARROW_MARGIN_X=8;const ARROW_MARGIN_Y=2;const ARROW_SIZE=4;const ARROW_THRESHOLD=12;const STROKE_WIDTH=2;const DEBUG=false;const DEBUG_LAYER_BOUNDS=false;const{Tracker,useReportedValues,useReporter}=createScope();const ConnectorContext=createContext({isReviewChangesOpen:false,onOpenReviewChanges:()=>void 0,onSetFocus:()=>void 0});const ChangeFieldWrapper=props=>{const ref=React.useRef(null);const{onSetFocus}=React.useContext(ConnectorContext);const[isHover,setHover]=React.useState(false);const onMouseEnter=React.useCallback(()=>{setHover(true);},[]);const onMouseLeave=React.useCallback(()=>{setHover(false);},[]);useReporter("change-".concat(PathUtils.toString(props.path)),()=>({element:ref.current,path:props.path,isChanged:true,hasFocus:false,hasHover:isHover,hasRevertHover:props.hasHover}),deepCompare);const handleClick=useCallback(event=>{setFocusWithStopPropagation(event,onSetFocus,props.path);},[onSetFocus,props.path]);return/* @__PURE__ */jsx("div",{ref,onClick:handleClick,onMouseLeave,onMouseEnter,children:props.children});};function setFocusWithStopPropagation(event,onSetFocus,path){event.stopPropagation();onSetFocus(path);}Object.freeze({});const EMPTY_ARRAY$4=Object.freeze([]);const animationSpeed=250;const ChangeBarWrapper$1=styled.div(_ref195=>{let{changed,disabled,isReviewChangeOpen}=_ref195;if(disabled)return css(_templateObject120||(_templateObject120=_taggedTemplateLiteral(["\n      "," {\n        display: none;\n      }\n    "])),ChangeBar);return css(_templateObject121||(_templateObject121=_taggedTemplateLiteral(["\n    --change-bar-offset: 2px;\n\n    display: flex;\n    position: relative;\n\n    @media (hover: hover) {\n      &:hover {\n        z-index: 10;\n      }\n    }\n\n    /* hide when field is not changed */\n    ","\n\n    /* hide hover effect when review changes is open */\n    ","\n  "])),!changed&&css(_templateObject122||(_templateObject122=_taggedTemplateLiteral(["\n      "," {\n        opacity: 0;\n        pointer-events: none;\n      }\n    "])),ChangeBar),isReviewChangeOpen&&css(_templateObject123||(_templateObject123=_taggedTemplateLiteral(["\n      "," {\n        opacity: 0;\n      }\n    "])),ChangeBarButton));});const FieldWrapper=styled.div(_templateObject124||(_templateObject124=_taggedTemplateLiteral(["\n  flex-grow: 1;\n  min-width: 0;\n"])));const ChangeBar=styled.div(_templateObject125||(_templateObject125=_taggedTemplateLiteral(["\n  position: relative;\n  opacity: 1;\n  transition: opacity 100ms;\n  z-index: ",";\n"])),_ref196=>{let{$zIndex}=_ref196;return $zIndex;});const ChangeBarMarker=styled.div(_ref197=>{let{theme}=_ref197;const notSelectedColor=theme.sanity.color.spot.yellow;const screenMedium=theme.sanity.media[0];return css(_templateObject126||(_templateObject126=_taggedTemplateLiteral(["\n    position: absolute;\n    top: 0;\n    left: var(--change-bar-offset);\n    width: 2px;\n    bottom: 0;\n    background-color: ",";\n    border-radius: 1px;\n\n    @media (min-width: ","px) {\n      display: unset;\n    }\n  "])),notSelectedColor,screenMedium);});const ChangeBarButton=styled.button(_ref198=>{let{theme,$withHoverEffect}=_ref198;const notSelectedColor=theme.sanity.color.spot.yellow;return css(_templateObject127||(_templateObject127=_taggedTemplateLiteral(["\n      appearance: none;\n      border: 0;\n      outline: 0;\n      display: block;\n      padding: 0;\n      background: transparent;\n      opacity: 0;\n      position: absolute;\n      height: 100%;\n      cursor: pointer;\n      pointer-events: all;\n      left: calc(-0.25rem + var(--change-bar-offset));\n      width: 1rem;\n      transition: opacity ","ms;\n\n      &:focus {\n        border: 0;\n        outline: 0;\n      }\n\n      &:after {\n        content: '';\n        width: 16px;\n        height: calc(100% + 14px);\n        display: block;\n        position: absolute;\n        top: -7px;\n        left: -3px;\n        border-radius: 8px;\n        background: ",";\n      }\n\n      &:focus {\n        border: 0;\n        outline: 0;\n      }\n\n      ","\n    "])),animationSpeed,notSelectedColor,$withHoverEffect&&css(_templateObject128||(_templateObject128=_taggedTemplateLiteral(["\n        @media (hover: hover) {\n          &:hover {\n            opacity: 0.2;\n          }\n        }\n      "]))));});function ElementWithChangeBar(props){const{children,disabled,hasFocus,isChanged,withHoverEffect=true}=props;const[hover,setHover]=useState(false);const{onOpenReviewChanges,isReviewChangesOpen}=React.useContext(ConnectorContext);const{zIndex}=useLayer();const handleMouseEnter=useCallback(()=>setHover(true),[]);const handleMouseLeave=useCallback(()=>setHover(false),[]);const changeBar=useMemo(()=>disabled||!isChanged?null:/* @__PURE__ */jsxs(ChangeBar,{"data-testid":"change-bar",$zIndex:zIndex,children:[/* @__PURE__ */jsx(ChangeBarMarker,{"data-testid":"change-bar__marker"}),/* @__PURE__ */jsx(ChangeBarButton,{"aria-label":"Review changes","data-testid":"change-bar__button",onClick:isReviewChangesOpen?void 0:onOpenReviewChanges,onMouseEnter:handleMouseEnter,onMouseLeave:handleMouseLeave,tabIndex:-1,type:"button",$withHoverEffect:withHoverEffect})]}),[disabled,isChanged,zIndex,isReviewChangesOpen,onOpenReviewChanges,handleMouseEnter,handleMouseLeave,withHoverEffect]);return/* @__PURE__ */jsxs(ChangeBarWrapper$1,{changed:isChanged,"data-testid":"change-bar-wrapper",disabled,focus:hasFocus,hover,isReviewChangeOpen:isReviewChangesOpen,children:[/* @__PURE__ */jsx(FieldWrapper,{"data-testid":"change-bar__field-wrapper",children}),changeBar]});}const ChangeBarWrapper=memo(function ChangeBarWrapper2(props){const{children,className,disabled,hasFocus,isChanged,path=EMPTY_ARRAY$4,withHoverEffect}=props;const layer=useLayer();const[hasHover,setHover]=React.useState(false);const onMouseEnter=React.useCallback(()=>setHover(true),[]);const onMouseLeave=React.useCallback(()=>setHover(false),[]);const ref=React.useRef(null);useReporter(disabled?null:"field-".concat(PathUtils.toString(path)),()=>({element:ref.current,path,isChanged,hasFocus,hasHover,zIndex:layer.zIndex}),deepCompare);return/* @__PURE__ */jsx("div",{ref,className,onMouseEnter,onMouseLeave,children:/* @__PURE__ */jsx(ElementWithChangeBar,{hasFocus,isChanged,disabled,withHoverEffect,children})});});function ChangeIndicator(props){const{children,className,disabled,hasFocus,isChanged,path,withHoverEffect}=props;return/* @__PURE__ */jsx(ChangeBarWrapper,{className,disabled,path,hasFocus,isChanged,withHoverEffect,children});}const ChangeIndicatorContext=React.createContext({path:[],fullPath:[],focusPath:[],isChanged:false});const ScrollContext=React.createContext(null);function useOnScroll(callback){const parentContext=React.useContext(ScrollContext);React.useEffect(()=>{return parentContext==null?void 0:parentContext.subscribe(callback);},[callback]);}const noop$3=()=>void 0;const ScrollContainer=React.forwardRef(function ScrollContainer2(props,ref){const{as="div",onScroll}=props,rest=_objectWithoutProperties(props,_excluded40);const forwardedRef=useForwardedRef(ref);const parentContext=useContext(ScrollContext);const childContext=useMemo(()=>createPubSub(),[]);useEffect(()=>{if(onScroll){return childContext.subscribe(onScroll);}return noop$3;},[childContext,onScroll]);useEffect(()=>{if(parentContext){return childContext.subscribe(parentContext.publish);}return noop$3;},[parentContext,childContext]);useEffect(()=>{const handleScroll=event=>{childContext.publish(event);};const el=forwardedRef.current;if(!el){return void 0;}el.addEventListener("scroll",handleScroll,{passive:true,capture:true});return()=>{el.removeEventListener("scroll",handleScroll);};},[childContext,forwardedRef]);return/* @__PURE__ */jsx(ScrollContext.Provider,{value:childContext,children:React.createElement(as,_objectSpread({ref:forwardedRef,"data-testid":"scroll-container"},rest))});});function ScrollMonitor(_ref199){let{onScroll,children}=_ref199;useOnScroll(onScroll);return/* @__PURE__ */jsx(Fragment,{children});}function findMostSpecificTarget(targetType,id,values){const pathString=id.slice(id.indexOf("-")+1)||"[]";const path=PathUtils.fromString(pathString);const exactId="".concat(targetType,"-").concat(PathUtils.toString(path));if(values.has(exactId)){return values.get(exactId);}let mostSpecific;for(const[targetId,target]of values){if(!("path"in target)||!targetId.startsWith(targetType)){continue;}const numEqual=PathUtils.numEqualSegments(path,target.path);const lastPathSegment=target.path[target.path.length-1];const pathOnlyDiffersByKey=numEqual===target.path.length-1&&isKeyedObject(lastPathSegment);if(numEqual===0){continue;}else if(numEqual!==target.path.length&&!pathOnlyDiffersByKey){continue;}mostSpecific=target;if(numEqual===path.length){break;}}return mostSpecific;}function isChangeBar(v){return v[0]!=="changePanel";}function hasOverflowScroll(el){const overflow=getComputedStyle(el).overflow;return overflow.includes("auto")||overflow.includes("scroll");}function isScrollable(el){const scrollableContent=el.scrollHeight!==el.offsetHeight||el.scrollWidth!==el.offsetWidth;return scrollableContent&&hasOverflowScroll(el);}const SCROLL_INTO_VIEW_TOP_PADDING=-15;function scrollIntoView(field){const element=field.element;let parentElementWithScroll=element;while(!isScrollable(parentElementWithScroll)){parentElementWithScroll=parentElementWithScroll.parentElement;if(!parentElementWithScroll){return;}}parentElementWithScroll.scroll({top:parentElementWithScroll.scrollTop+field.rect.top-field.bounds.top+SCROLL_INTO_VIEW_TOP_PADDING,left:0,behavior:"smooth"});}const getOffsetsTo=(source,target)=>{const bounds={top:0,left:0,height:target.offsetHeight,width:target.offsetWidth};const rect={top:0,left:0,height:source.offsetHeight,width:source.offsetWidth};let foundScrollContainer=false;let el=source;while(el&&el!==target&&target.contains(el)){if(foundScrollContainer){bounds.top+=el.offsetTop;bounds.left+=el.offsetLeft;}if(hasOverflowScroll(el)){bounds.top=el.offsetTop;bounds.height=el.offsetHeight;bounds.left=el.offsetLeft;bounds.width=el.offsetWidth;foundScrollContainer=true;}rect.top+=el.offsetTop-el.scrollTop;rect.left+=el.offsetLeft-el.scrollLeft;el=el.offsetParent;}return{rect,bounds};};function arrowPath(x,y,dir){return["M ".concat(x-ARROW_SIZE," ").concat(y-ARROW_SIZE*dir," "),"L ".concat(x," ").concat(y),"L ".concat(x+ARROW_SIZE," ").concat(y-ARROW_SIZE*dir)].join("");}function moveTo(x,y){return"M".concat(x," ").concat(y);}function lineTo(x,y){return"L".concat(x," ").concat(y);}function join$1(strings){let delim=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";return strings.join(delim);}function quadCurve(x1,y1,x,y){return"Q".concat(x1," ").concat(y1," ").concat(x," ").concat(y);}function generateConnectorPath(line){const{from,to}=line;const{left:fromX,top:fromY}=from;const{left:toX,top:toY}=to;const cmds=[];const r1=Math.min(CORNER_RADIUS,Math.abs(fromY-toY)/2);if(from.isAbove){cmds.push(moveTo(fromX+ARROW_MARGIN_X,fromY-ARROW_THRESHOLD+ARROW_MARGIN_Y),lineTo(fromX+ARROW_MARGIN_X,fromY-CORNER_RADIUS),quadCurve(fromX+ARROW_MARGIN_X,fromY,fromX+ARROW_MARGIN_X+CORNER_RADIUS,fromY));}else if(from.isBelow){cmds.push(moveTo(fromX+ARROW_MARGIN_X,fromY+ARROW_THRESHOLD-ARROW_MARGIN_Y),lineTo(fromX+ARROW_MARGIN_X,fromY+CORNER_RADIUS),quadCurve(fromX+ARROW_MARGIN_X,fromY,fromX+ARROW_MARGIN_X+CORNER_RADIUS,fromY));}else{cmds.push(moveTo(fromX,fromY));}if(to.isAbove){if(fromY<to.bounds.top){cmds.push(lineTo(to.bounds.left-8-r1,fromY),quadCurve(to.bounds.left-8,fromY,to.bounds.left-8,fromY+r1),lineTo(to.bounds.left-8,toY-r1),quadCurve(to.bounds.left-8,toY,to.bounds.left-8+r1,toY),lineTo(to.bounds.left+ARROW_MARGIN_X-CORNER_RADIUS,toY),quadCurve(to.bounds.left+ARROW_MARGIN_X,toY,to.bounds.left+ARROW_MARGIN_X,toY-CORNER_RADIUS),lineTo(to.bounds.left+ARROW_MARGIN_X,toY-ARROW_THRESHOLD+ARROW_MARGIN_Y));}else{cmds.push(lineTo(to.bounds.left+ARROW_MARGIN_X-CORNER_RADIUS,fromY),quadCurve(to.bounds.left+ARROW_MARGIN_X,fromY,to.bounds.left+ARROW_MARGIN_X,fromY-CORNER_RADIUS),lineTo(to.bounds.left+ARROW_MARGIN_X,toY-ARROW_THRESHOLD+ARROW_MARGIN_Y));}}else if(to.isBelow){if(fromY>to.bounds.top+to.bounds.height){cmds.push(lineTo(to.bounds.left-ARROW_MARGIN_X-r1,fromY),quadCurve(to.bounds.left-ARROW_MARGIN_X,fromY,to.bounds.left-ARROW_MARGIN_X,fromY-r1),lineTo(to.bounds.left-ARROW_MARGIN_X,toY+r1),quadCurve(to.bounds.left-ARROW_MARGIN_X,toY,to.bounds.left-ARROW_MARGIN_X+r1,toY),lineTo(to.bounds.left+ARROW_MARGIN_X-CORNER_RADIUS,toY),quadCurve(to.bounds.left+ARROW_MARGIN_X,toY,to.bounds.left+ARROW_MARGIN_X,toY+CORNER_RADIUS),lineTo(to.bounds.left+ARROW_MARGIN_X,toY+ARROW_THRESHOLD-ARROW_MARGIN_Y));}else{cmds.push(lineTo(to.bounds.left+ARROW_MARGIN_X-CORNER_RADIUS,fromY),quadCurve(to.bounds.left+ARROW_MARGIN_X,fromY,to.bounds.left+ARROW_MARGIN_X,fromY+CORNER_RADIUS),lineTo(to.bounds.left+ARROW_MARGIN_X,toY+ARROW_THRESHOLD-ARROW_MARGIN_Y));}}else if(fromY<toY){cmds.push(lineTo(to.bounds.left+ARROW_MARGIN_X-r1,fromY),quadCurve(to.bounds.left+ARROW_MARGIN_X,fromY,to.bounds.left+ARROW_MARGIN_X,fromY+r1),lineTo(to.bounds.left+ARROW_MARGIN_X,toY-r1),quadCurve(to.bounds.left+ARROW_MARGIN_X,toY,to.bounds.left+ARROW_MARGIN_X+r1,toY),lineTo(toX,toY));}else{cmds.push(lineTo(to.bounds.left+ARROW_MARGIN_X-r1,fromY),quadCurve(to.bounds.left+ARROW_MARGIN_X,fromY,to.bounds.left+ARROW_MARGIN_X,fromY-r1),lineTo(to.bounds.left+ARROW_MARGIN_X,toY+r1),quadCurve(to.bounds.left+ARROW_MARGIN_X,toY,to.bounds.left+ARROW_MARGIN_X+r1,toY),lineTo(toX,toY));}return join$1(cmds);}function getConnectorLinePoint(rect,bounds){const centerY=rect.top+rect.height/2;const isAbove=rect.top+rect.height<bounds.top+ARROW_MARGIN_Y;const isBelow=rect.top>bounds.top+bounds.height-ARROW_MARGIN_Y;return{bounds,left:rect.left,top:centerY,centerY,startY:rect.top+CONNECTOR_MARGIN,endY:rect.top+rect.height-CONNECTOR_MARGIN,isAbove,isBelow,outOfBounds:isAbove||isBelow};}function mapConnectorToLine(connector){const fromBounds={top:connector.from.bounds.top+ARROW_THRESHOLD,bottom:connector.from.bounds.top+connector.from.bounds.height-ARROW_THRESHOLD,left:connector.from.bounds.left,right:connector.from.bounds.left+connector.from.bounds.width,width:connector.from.bounds.width,height:connector.from.bounds.height-ARROW_THRESHOLD*2};const from=getConnectorLinePoint(connector.from.rect,fromBounds);from.left=connector.from.rect.left+connector.from.rect.width+1;const toBounds={top:connector.to.bounds.top+ARROW_THRESHOLD,bottom:connector.to.bounds.top+connector.to.bounds.height-ARROW_THRESHOLD,left:connector.to.bounds.left,right:connector.to.bounds.left+connector.to.bounds.width,width:connector.to.bounds.width,height:connector.to.bounds.height-ARROW_THRESHOLD*2};const to=getConnectorLinePoint(connector.to.rect,toBounds);const maxStartY=Math.max(to.startY,from.startY);from.top=Math.min(maxStartY,from.endY);if(from.top<toBounds.top){from.top=Math.min(toBounds.top,from.endY);}else if(from.top>toBounds.bottom){from.top=Math.max(toBounds.bottom,from.startY);}to.top=Math.min(maxStartY,to.endY);if(to.top<fromBounds.top){to.top=Math.min(fromBounds.top,to.endY);}else if(to.top>fromBounds.bottom){to.top=Math.max(fromBounds.bottom,to.startY);}from.top=Math.min(Math.max(from.top,fromBounds.top),fromBounds.bottom);to.top=Math.min(Math.max(to.top,toBounds.top),toBounds.bottom);return{from,to};}function ClampedRect(props){const{bounds}=props,rest=_objectWithoutProperties(props,_excluded41);const x=Math.max(bounds.left,props.left);const y=Math.max(props.top,bounds.top);const height=Math.max(0,props.height-(y-props.top));const width=Math.max(0,props.width-(x-props.left));return/* @__PURE__ */jsx("rect",_objectSpread(_objectSpread({},rest),{},{x,y,height,width}));}styled.rect(_templateObject129||(_templateObject129=_taggedTemplateLiteral(["\n  stroke: #ccc;\n  fill: none;\n  pointer-events: none;\n  stroke-linecap: round;\n"])));const ConnectorPath=styled.path(_ref200=>{let{theme}=_ref200;const strokeColor=theme.sanity.color.spot.yellow;return css(_templateObject130||(_templateObject130=_taggedTemplateLiteral(["\n    fill: none;\n    pointer-events: none;\n    stroke-linecap: round;\n    stroke-linejoin: round;\n    stroke: ",";\n  "])),strokeColor);});const InteractivePath=styled.path(_ref201=>{let{theme}=_ref201;const strokeColor=theme.sanity.color.spot.yellow;return css(_templateObject131||(_templateObject131=_taggedTemplateLiteral(["\n    fill: none;\n    pointer-events: stroke;\n    stroke: ",";\n    cursor: pointer;\n    stroke-linecap: round;\n    stroke-linejoin: round;\n    opacity: 0;\n\n    &:hover {\n      opacity: 0.2;\n    }\n  "])),strokeColor);});const RightBarWrapper=styled(ClampedRect)(_ref202=>{let{theme}=_ref202;const strokeColor=theme.sanity.color.spot.yellow;return css(_templateObject132||(_templateObject132=_taggedTemplateLiteral(["\n    stroke: none;\n    pointer-events: none;\n    fill: ",";\n  "])),strokeColor);});const Connector=memo(function Connector2(_ref203){let{from,to}=_ref203;const line=mapConnectorToLine({from,to});if(line.from.outOfBounds&&line.to.outOfBounds){return null;}const linePathDescription=generateConnectorPath(line);return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(InteractivePath,{d:linePathDescription,strokeWidth:INTERACTIVE_STROKE_WIDTH}),/* @__PURE__ */jsx(ConnectorPath,{d:linePathDescription,strokeWidth:STROKE_WIDTH}),/* @__PURE__ */jsx(RightBarWrapper,{top:to.rect.top,left:to.rect.left,height:to.rect.height,width:STROKE_WIDTH,bounds:to.bounds}),line.from.isAbove&&/* @__PURE__ */jsx(ConnectorPath,{d:arrowPath(line.from.left+ARROW_MARGIN_X,line.from.bounds.top-ARROW_THRESHOLD+ARROW_MARGIN_Y,-1),strokeWidth:STROKE_WIDTH}),line.from.isBelow&&/* @__PURE__ */jsx(ConnectorPath,{d:arrowPath(line.from.left+ARROW_MARGIN_X,line.from.bounds.top+line.from.bounds.height+ARROW_THRESHOLD-ARROW_MARGIN_Y,1),strokeWidth:STROKE_WIDTH}),line.to.isAbove&&/* @__PURE__ */jsx(ConnectorPath,{d:arrowPath(line.to.bounds.left+ARROW_MARGIN_X,line.to.bounds.top-ARROW_THRESHOLD+ARROW_MARGIN_Y,-1),strokeWidth:STROKE_WIDTH}),line.to.isBelow&&/* @__PURE__ */jsx(ConnectorPath,{d:arrowPath(line.to.bounds.left+ARROW_MARGIN_X,line.to.bounds.top+line.to.bounds.height+ARROW_THRESHOLD-ARROW_MARGIN_Y,1),strokeWidth:STROKE_WIDTH}),DEBUG]});});function useResizeObserver(element,onResize){useEffect(()=>resizeObserver.observe(element,onResize),[element,onResize]);}const SvgWrapper=styled.svg(_templateObject133||(_templateObject133=_taggedTemplateLiteral(["\n  pointer-events: none;\n  position: absolute;\n  left: 0;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  height: 100%;\n"])));function getState(allReportedValues,hovered,byId,rootElement){const changeBarsWithHover=[];const changeBarsWithFocus=[];for(const value of allReportedValues){if(!isChangeBar(value)||!value[1].isChanged){continue;}const[id,reportedChangeBar]=value;if(id===hovered){changeBarsWithHover.push(value);continue;}if(reportedChangeBar.hasHover){changeBarsWithHover.push(value);continue;}if(reportedChangeBar.hasFocus){changeBarsWithFocus.push(value);continue;}}const isHoverConnector=changeBarsWithHover.length>0;const changeBars=isHoverConnector?changeBarsWithHover:changeBarsWithFocus;const connectors=changeBars.map(_ref204=>{let[id]=_ref204;const field=findMostSpecificTarget("field",id,byId);const change=findMostSpecificTarget("change",id,byId);if(!field||!change)return null;return{field:_objectSpread({id},field),change:_objectSpread({id},change)};}).filter(isNonNullable$4).map(_ref205=>{let{field,change}=_ref205;return{hasHover:field.hasHover||change.hasHover,hasFocus:field.hasFocus,hasRevertHover:change.hasRevertHover,field:_objectSpread(_objectSpread({},field),getOffsetsTo(field.element,rootElement)),change:_objectSpread(_objectSpread({},change),getOffsetsTo(change.element,rootElement))};});return{connectors,isHoverConnector};}function ConnectorsOverlay(props){const{rootElement,onSetFocus}=props;const[hovered,setHovered]=React.useState(null);const allReportedValues=useReportedValues();const byId=useMemo(()=>new Map(allReportedValues),[allReportedValues]);const[{connectors},setState]=useState(()=>getState(allReportedValues,hovered,byId,rootElement));const visibleConnectors=useMemo(()=>sortBy(connectors,c=>0-c.field.path.length).slice(0,1),[connectors]);const handleScrollOrResize=useCallback(()=>{setState(getState(allReportedValues,hovered,byId,rootElement));},[byId,allReportedValues,hovered,rootElement]);useResizeObserver(rootElement,handleScrollOrResize);return/* @__PURE__ */jsx(ScrollMonitor,{onScroll:handleScrollOrResize,children:/* @__PURE__ */jsx(SvgWrapper,{style:{zIndex:visibleConnectors[0]&&visibleConnectors[0].field.zIndex},children:visibleConnectors.map(_ref206=>{let{field,change}=_ref206;if(!change){return null;}return/* @__PURE__ */jsx(ConnectorGroup,{field,change,onSetFocus,setHovered},field.id);})})});}function ConnectorGroup(props){const{change,field,onSetFocus,setHovered}=props;const onConnectorClick=useCallback(()=>{scrollIntoView(field);scrollIntoView(change);onSetFocus(field.path);},[field,change,onSetFocus]);const handleMouseEnter=useCallback(()=>setHovered(field.id),[field,setHovered]);const handleMouseLeave=useCallback(()=>setHovered(null),[setHovered]);const from=useMemo(()=>({rect:{left:field.rect.left+2,top:field.rect.top,height:field.rect.height,width:field.rect.width},bounds:field.bounds}),[field.bounds,field.rect]);const to=useMemo(()=>({rect:change.rect,bounds:change.bounds}),[change.bounds,change.rect]);return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx("g",{onClick:onConnectorClick,onMouseEnter:handleMouseEnter,onMouseLeave:handleMouseLeave,children:/* @__PURE__ */jsx(Connector,{from,to})}),DEBUG_LAYER_BOUNDS]});}function EnabledChangeConnectorRoot(_ref207){let{children,className,isReviewChangesOpen,onOpenReviewChanges,onSetFocus}=_ref207,restProps=_objectWithoutProperties(_ref207,_excluded42);const[rootElement,setRootElement]=React.useState();const contextValue=useMemo(()=>({isReviewChangesOpen,onOpenReviewChanges,onSetFocus}),[isReviewChangesOpen,onOpenReviewChanges,onSetFocus]);return/* @__PURE__ */jsx(ConnectorContext.Provider,{value:contextValue,children:/* @__PURE__ */jsx(Tracker,{children:/* @__PURE__ */jsxs(ScrollContainer,_objectSpread(_objectSpread({},restProps),{},{ref:setRootElement,className,children:[children,rootElement&&/* @__PURE__ */jsx(ConnectorsOverlay,{rootElement,onSetFocus})]}))})});}function DisabledChangeConnectorRoot(_ref208){let{children,className}=_ref208;return/* @__PURE__ */jsx(ScrollContainer,{className,children});}const ChangeConnectorRoot=EnabledChangeConnectorRoot;const ReviewChangesContext=createContext(null);const Context=createContext({});function useReferenceInputOptions(){return useContext(Context);}function ReferenceInputOptionsProvider(props){const{children,activePath,EditReferenceLinkComponent,onEditReference,initialValueTemplateItems}=props;const contextValue=useMemo(()=>({activePath,EditReferenceLinkComponent,onEditReference,initialValueTemplateItems}),[activePath,EditReferenceLinkComponent,onEditReference,initialValueTemplateItems]);return/* @__PURE__ */jsx(Context.Provider,{value:contextValue,children});}function createPatchChannel(){const _subscribers=[];return{publish(msg){for(const subscriber of _subscribers){subscriber(msg);}},subscribe(subscriber){_subscribers.push(subscriber);return()=>{const idx=_subscribers.indexOf(subscriber);if(idx>-1){_subscribers.splice(idx,1);}};}};}function setIfMissing(value){let path=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];return{type:"setIfMissing",path,value};}function insert(items,position){let path=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];return{type:"insert",path,position,items};}function set(value){let path=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];return{type:"set",path,value};}function unset(){let path=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];return{type:"unset",path};}function inc(){let amount=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;let path=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];return{type:"inc",path,value:amount};}function dec(){let amount=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1;let path=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];return{type:"dec",path,value:amount};}function prefixPath(patch,segment){return _objectSpread(_objectSpread({},patch),{},{path:[segment,...patch.path]});}class PatchEvent{static from(input){if(input instanceof PatchEvent){return input;}return new PatchEvent(Array.isArray(input)?flatten$1(input):[input]);}constructor(patches){this.patches=patches;}prepend(){for(var _len6=arguments.length,patches=new Array(_len6),_key7=0;_key7<_len6;_key7++){patches[_key7]=arguments[_key7];}return PatchEvent.from([...flatten$1(patches),...this.patches]);}append(){for(var _len7=arguments.length,patches=new Array(_len7),_key8=0;_key8<_len7;_key8++){patches[_key8]=arguments[_key8];}return PatchEvent.from([...this.patches,...flatten$1(patches)]);}prefixAll(segment){return PatchEvent.from(this.patches.map(patch=>prefixPath(patch,segment)));}}const FormBuilderContext=createContext(null);function useFormBuilder(){const formBuilder=useContext(FormBuilderContext);if(!formBuilder){throw new Error("FormBuilder: missing context value");}return formBuilder;}function DefaultArrayInputFunctions(props){const{type,readOnly,children,onCreateValue,onAppendItem}=props;const menuButtonId=useId();const insertItem=React.useCallback(itemType=>{const item=onCreateValue(itemType);onAppendItem(item);},[onCreateValue,onAppendItem]);const handleAddBtnClick=React.useCallback(()=>{insertItem(type.of[0]);},[type,insertItem]);const popoverProps=useMemo(()=>({constrainSize:true,portal:true}),[]);if(readOnly){return/* @__PURE__ */jsx(Tooltip,{portal:true,content:/* @__PURE__ */jsx(Box,{padding:2,sizing:"border",children:/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:"This field is read-only"})}),children:/* @__PURE__ */jsx(Grid,{children:/* @__PURE__ */jsx(Button,{icon:AddIcon,mode:"ghost",disabled:true,text:type.of.length===1?"Add item":"Add item..."})})});}return/* @__PURE__ */jsxs(Grid,{gap:1,style:{gridTemplateColumns:"repeat(auto-fit, minmax(100px, 1fr))"},children:[type.of.length===1?/* @__PURE__ */jsx(Button,{icon:AddIcon,mode:"ghost",onClick:handleAddBtnClick,text:"Add item"}):/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{icon:AddIcon,mode:"ghost",text:"Add item\u2026"}),id:menuButtonId||"",menu:/* @__PURE__ */jsx(Menu,{children:type.of.map((memberDef,i)=>{var _a,_b;const referenceIcon=isReferenceSchemaType(memberDef)&&(memberDef.to||[]).length===1&&memberDef.to[0].icon;const icon=memberDef.icon||((_a=memberDef.type)==null?void 0:_a.icon)||referenceIcon;return/* @__PURE__ */jsx(MenuItem,{text:memberDef.title||((_b=memberDef.type)==null?void 0:_b.name),onClick:()=>insertItem(memberDef),icon},i);})}),popover:popoverProps}),children]});}DefaultArrayInputFunctions.__SANITY_INTERNAL_IMPLEMENTATION=true;const getIcon=level=>{if(level==="error"){return/* @__PURE__ */jsx(ErrorOutlineIcon,{});}if(level==="warning"){return/* @__PURE__ */jsx(WarningOutlineIcon,{});}return/* @__PURE__ */jsx(InfoOutlineIcon,{});};const IconText=styled(Text$1)(_ref209=>{let{theme}=_ref209;return css(_templateObject134||(_templateObject134=_taggedTemplateLiteral(["\n    &[data-info] {\n      color: ",";\n    }\n\n    &[data-warning] {\n      color: ",";\n    }\n\n    &[data-error] {\n      color: ",";\n    }\n  "])),theme.sanity.color.muted.primary.enabled.fg,theme.sanity.color.muted.caution.enabled.fg,theme.sanity.color.muted.critical.enabled.fg);});function DefaultMarkers(props){const{markers,validation,renderCustomMarkers}=props;const{CustomMarkers}=useFormBuilder().__internal.components;if(markers.length===0&&validation.length===0){return null;}return/* @__PURE__ */jsxs(Stack,{space:1,children:[validation.length>0&&validation.map((_ref210,index)=>{let{message,level}=_ref210;return/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{marginRight:2,marginBottom:index+1===validation.length?0:2,children:/* @__PURE__ */jsx(IconText,{size:1,"data-error":level==="error"?"":void 0,"data-warning":level==="warning"?"":void 0,"data-info":level==="info"?"":void 0,children:getIcon(level)})}),/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{size:1,children:message||"Error"})})]},"validationItem-".concat(index));}),markers.length>0&&/* @__PURE__ */jsxs(Box,{marginTop:validation.length>0?3:0,children:[renderCustomMarkers&&renderCustomMarkers(markers),!renderCustomMarkers&&/* @__PURE__ */jsx(CustomMarkers,{markers})]})]});}function DefaultCustomMarkers(){return/* @__PURE__ */jsxs(Text$1,{size:1,children:["This is a example custom marker, please implement ",/* @__PURE__ */jsx("code",{children:"renderCustomMarkers"})," function."]});}const FormCallbacksContext=React.createContext(null);const FormCallbacksProvider=memo(function FormCallbacksProvider2(props){return/* @__PURE__ */jsx(FormCallbacksContext.Provider,{value:props,children:props.children});});function useFormCallbacks(){const ctx=useContext(FormCallbacksContext);if(!ctx){throw new Error("Form context not provided");}return ctx;}const PresenceContext=createContext([]);function PresenceProvider(props){return/* @__PURE__ */jsx(PresenceContext.Provider,{value:props.presence,children:props.children});}function useFormFieldPresence(){const ctx=useContext(PresenceContext);if(!ctx){throw new Error("Form context not provided");}return ctx;}function useChildPresence(path){const presence=useFormFieldPresence();return useMemo(()=>presence.filter(item=>startsWith(path,item.path)),[path,presence]);}const ValidationContext=createContext([]);function ValidationProvider(props){return/* @__PURE__ */jsx(ValidationContext.Provider,{value:props.validation,children:props.children});}function useValidationMarkers(){const ctx=useContext(ValidationContext);if(!ctx){throw new Error("Form context not provided");}return ctx;}function useChildValidation(path){const validation=useValidationMarkers();return useMemo(()=>validation.filter(item=>startsWith(path,item.path)).map(marker=>({message:marker.item.message,level:marker.level,path:marker.path})),[path,validation]);}const missingPatchChannel={publish:()=>void 0,subscribe:()=>{console.warn("No patch channel provided to form-builder. If you need input based patch updates, please provide one");return()=>void 0;}};function FormBuilderProvider(props){const{__internal_patchChannel:patchChannel=missingPatchChannel,autoFocus,changesOpen,children,collapsedFieldSets,collapsedPaths,file,filterField,focusPath,focused,groups,id,image,members,onChange,onFieldGroupSelect,onPathBlur,onPathFocus,onPathOpen,onSetFieldSetCollapsed,onSetPathCollapsed,presence,readOnly,renderField,renderInput,renderItem,renderPreview,schemaType,unstable,validation,value:documentValue}=props;const documentValueRef=useRef(documentValue);useEffect(()=>{documentValueRef.current=documentValue;},[documentValue]);const __internal=useMemo(()=>({patchChannel,components:{ArrayFunctions:(unstable==null?void 0:unstable.ArrayFunctions)||DefaultArrayInputFunctions,CustomMarkers:(unstable==null?void 0:unstable.CustomMarkers)||DefaultCustomMarkers,Markers:(unstable==null?void 0:unstable.Markers)||DefaultMarkers},file:{assetSources:(file==null?void 0:file.assetSources)?_ensureArrayOfSources(file.assetSources)||defaultFileAssetSources:defaultFileAssetSources,directUploads:(file==null?void 0:file.directUploads)!==false},filterField:filterField||(()=>true),image:{assetSources:(image==null?void 0:image.assetSources)?_ensureArrayOfSources(image.assetSources)||defaultImageAssetSources:defaultImageAssetSources,directUploads:(image==null?void 0:image.directUploads)!==false},getDocument:()=>documentValueRef.current,onChange}),[file,filterField,image,onChange,patchChannel,unstable]);const formBuilder=useMemo(()=>({__internal,autoFocus,changesOpen,collapsedFieldSets,collapsedPaths,focusPath,focused,groups,id,members,readOnly,renderField,renderInput,renderItem,renderPreview,schemaType,value:documentValue}),[__internal,autoFocus,changesOpen,collapsedFieldSets,collapsedPaths,documentValue,focusPath,focused,groups,id,members,readOnly,renderField,renderInput,renderItem,renderPreview,schemaType]);return/* @__PURE__ */jsx(FormBuilderContext.Provider,{value:formBuilder,children:/* @__PURE__ */jsx(FormCallbacksProvider,{onChange,onFieldGroupSelect,onPathBlur,onPathFocus,onPathOpen,onSetPathCollapsed,onSetFieldSetCollapsed,children:/* @__PURE__ */jsx(PresenceProvider,{presence,children:/* @__PURE__ */jsx(ValidationProvider,{validation,children})})})});}function _ensureArrayOfSources(sources){if(Array.isArray(sources)){return sources;}console.warn("Configured asset sources is not an array:",sources);return null;}function StudioFormBuilderProvider(props){const{__internal_patchChannel:patchChannel,autoFocus,changesOpen,children,collapsedFieldSets,collapsedPaths,focusPath,focused,groups,id,members,onChange,onPathBlur,onPathFocus,onPathOpen,onFieldGroupSelect,onSetPathCollapsed,onSetFieldSetCollapsed,presence,readOnly,schemaType,validation,value}=props;const{file,image,renderField,renderInput,renderItem,renderPreview}=useSource().form;return/* @__PURE__ */jsx(FormBuilderProvider,{__internal_patchChannel:patchChannel,autoFocus,changesOpen,collapsedFieldSets,collapsedPaths,file,focusPath,focused,groups,id,image,members,onChange,onPathBlur,onPathFocus,onPathOpen,onFieldGroupSelect,onSetPathCollapsed,onSetFieldSetCollapsed,presence,readOnly,renderField,renderInput,renderItem,renderPreview,schemaType,validation,value,children});}function StudioFormBuilder(props){const{__internal_patchChannel:patchChannel,autoFocus,changesOpen,collapsedFieldSets,collapsedPaths,focusPath,focused,groups,id,members,onChange,onPathBlur,onPathFocus,onPathOpen,onFieldGroupSelect,onSetFieldSetCollapsed,onSetPathCollapsed,presence,readOnly,schemaType,validation,value}=props;return/* @__PURE__ */jsx(StudioFormBuilderProvider,{__internal_patchChannel:patchChannel,autoFocus,changesOpen,collapsedFieldSets,collapsedPaths,focusPath,focused,groups,id,members,onChange,onPathBlur,onPathFocus,onPathOpen,onFieldGroupSelect,onSetPathCollapsed,onSetFieldSetCollapsed,presence,validation,readOnly,schemaType,value,children:/* @__PURE__ */jsx(RootInput,{})});}function RootInput(){const{focusPath,focused,groups,id,members,readOnly,renderField,renderInput,renderItem,renderPreview,schemaType,value}=useFormBuilder();const{onChange,onFieldGroupSelect,onPathBlur,onPathFocus,onPathOpen,onSetFieldSetCollapsed,onSetPathCollapsed}=useFormCallbacks();const handleCollapseField=useCallback(fieldName=>onSetPathCollapsed([fieldName],true),[onSetPathCollapsed]);const handleExpandField=useCallback(fieldName=>onSetPathCollapsed([fieldName],false),[onSetPathCollapsed]);const handleBlur=useCallback(()=>onPathBlur(EMPTY_ARRAY$4),[onPathBlur]);const handleFocus=useCallback(()=>onPathFocus(EMPTY_ARRAY$4),[onPathFocus]);const handleChange=useCallback(patch=>onChange(PatchEvent.from(patch)),[onChange]);const focusRef=useRef(null);const handleSelectFieldGroup=useCallback(groupName=>onFieldGroupSelect(EMPTY_ARRAY$4,groupName),[onFieldGroupSelect]);const handleOpenField=useCallback(fieldName=>onPathOpen([fieldName]),[onPathOpen]);const handleCloseField=useCallback(()=>onPathOpen([]),[onPathOpen]);const handleCollapseFieldSet=useCallback(fieldSetName=>onSetFieldSetCollapsed([fieldSetName],true),[onSetFieldSetCollapsed]);const handleExpandFieldSet=useCallback(fieldSetName=>onSetFieldSetCollapsed([fieldSetName],false),[onSetFieldSetCollapsed]);const rootInputProps={focusPath,elementProps:{ref:focusRef,id,onBlur:handleBlur,onFocus:handleFocus},changed:members.some(m=>m.kind==="field"&&m.field.changed),focused,groups,id,level:0,members,onChange:handleChange,onCloseField:handleCloseField,onCollapseField:handleCollapseField,onCollapseFieldSet:handleCollapseFieldSet,onExpandField:handleExpandField,onExpandFieldSet:handleExpandFieldSet,onFocusPath:onPathFocus,onOpenField:handleOpenField,onFieldGroupSelect:handleSelectFieldGroup,path:EMPTY_ARRAY$4,presence:EMPTY_ARRAY$4,readOnly,renderField,renderInput,renderItem,renderPreview,schemaType,validation:EMPTY_ARRAY$4,value};return/* @__PURE__ */jsx(Fragment,{children:renderInput(rootInputProps)});}const IS_NUMERIC=/^\d+$/;function unquote(str){return str.replace(/^['"]/,"").replace(/['"]$/,"");}function splitAttr(segment){const[attr,key]=segment.split("==");return{[attr]:unquote(key)};}function coerce(segment){return IS_NUMERIC.test(segment)?Number(segment):segment;}function parseGradientPath(focusPathStr){return focusPathStr.split(/[[.\]]/g).filter(Boolean).map(seg=>seg.includes("==")?splitAttr(seg):coerce(seg));}function encodePath(formBuilderPath){return arrayToJSONMatchPath(formBuilderPath);}function decodePath(gradientPath){return parseGradientPath(gradientPath);}function isMemberObject(member){return isObjectSchemaType(member.field.schemaType);}function isMemberArrayOfPrimitives(member){return isArraySchemaType(member.field.schemaType)&&member.field.schemaType.of.every(ofType=>isPrimitiveSchemaType(ofType));}function isMemberArrayOfObjects(member){return isArraySchemaType(member.field.schemaType)&&member.field.schemaType.of.every(ofType=>isObjectSchemaType(ofType));}const rePropName=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g;const reKeySegment=/_key\s*==\s*['"](.*)['"]/;function pathToString(path){if(!Array.isArray(path)){throw new Error("Path is not an array");}return path.reduce((target,segment,i)=>{const segmentType=typeof segment;if(segmentType==="number"){return"".concat(target,"[").concat(segment,"]");}if(segmentType==="string"){const separator=i===0?"":".";return"".concat(target).concat(separator).concat(segment);}if(isKeySegment(segment)&&segment._key){return"".concat(target,"[_key==\"").concat(segment._key,"\"]");}if(Array.isArray(segment)){const[from,to]=segment;return"".concat(target,"[").concat(from,":").concat(to,"]");}throw new Error("Unsupported path segment `".concat(JSON.stringify(segment),"`"));},"");}function getValueAtPath(rootValue,path){const segment=path[0];if(!segment){return rootValue;}const tail=path.slice(1);if(isIndexSegment(segment)){return getValueAtPath(Array.isArray(rootValue)?rootValue[segment]:void 0,tail);}if(isKeySegment(segment)){return getValueAtPath(Array.isArray(rootValue)?rootValue.find(item=>item._key===segment._key):void 0,tail);}if(typeof segment==="string"){return getValueAtPath(isRecord$2(rootValue)?rootValue[segment]:void 0,tail);}throw new Error("Unknown segment type ".concat(JSON.stringify(segment)));}function findIndex(array,segment){if(typeof segment!=="number"&&!isKeySegment(segment)){return-1;}return typeof segment==="number"?segment:array.findIndex(item=>isKeyedObject(item)&&item._key===segment._key);}function stringToPath(path){const segments=path.match(rePropName);if(!segments){throw new Error("Invalid path string");}return segments.map(normalizePathSegment);}function normalizePathSegment(segment){if(isIndexSegment(segment)){return normalizeIndexSegment(segment);}if(isKeySegment(segment)){return normalizeKeySegment(segment);}if(isIndexTuple(segment)){return normalizeIndexTupleSegment(segment);}return segment;}function normalizeIndexSegment(segment){return Number(segment.replace(/[^\d]/g,""));}function normalizeKeySegment(segment){const segments=segment.match(reKeySegment);if(!segments){throw new Error("Invalid key segment");}return{_key:segments[1]};}function normalizeIndexTupleSegment(segment){const[from,to]=segment.split(":").map(seg=>seg===""?seg:Number(seg));return[from,to];}function pathsAreEqual(pathA,pathB){if(pathA.length!==pathB.length){return false;}return pathA.every((segmentA,index)=>{const segmentB=pathB[index];if(isKeySegment(segmentA)&&isKeySegment(segmentB)){return segmentA._key===segmentB._key;}if(isIndexSegment(segmentA)){return Number(segmentA)===Number(segmentB);}if(isIndexTuple(segmentA)&&isIndexTuple(segmentB)){return segmentA[0]===segmentB[0]&&segmentA[1]===segmentB[1];}return segmentA===segmentB;});}function getItemKey(arrayItem){return isKeyedObject(arrayItem)?arrayItem._key:void 0;}function getItemKeySegment(arrayItem){const key=getItemKey(arrayItem);return key?{_key:key}:void 0;}function isEmptyObject$1(item){return typeof item==="object"&&item!==null&&Object.keys(item).length<=0;}const OverlayContainer=styled.div(_templateObject135||(_templateObject135=_taggedTemplateLiteral(["\n  position: relative;\n"])));const ContentContainer$1=styled.div(_templateObject136||(_templateObject136=_taggedTemplateLiteral(["\n  z-index: 13;\n  opacity: 0;\n  transition: opacity 300ms linear;\n"])));const CardContainer=styled(Card)(_templateObject137||(_templateObject137=_taggedTemplateLiteral(["\n  border: 1px solid var(--card-border-color);\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  z-index: 12;\n  transition: opacity 150ms ease-in-out;\n  opacity: 0;\n  box-sizing: border-box;\n"])));const FlexContainer$1=styled(Flex)(_templateObject138||(_templateObject138=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n\n  :hover,\n  :focus {\n    & "," {\n      opacity: 0.9;\n    }\n\n    & "," {\n      opacity: 1;\n    }\n  }\n"])),CardContainer,ContentContainer$1);function ActivateOnFocus(props){const{children,message,onActivate,isOverlayActive}=props;function handleClick(){if(onActivate){onActivate();}}function handleBlur(){if(onActivate&&isOverlayActive){onActivate();}}return/* @__PURE__ */jsxs(OverlayContainer,{onClick:handleClick,onBlur:handleBlur,children:[isOverlayActive&&/* @__PURE__ */jsxs(FlexContainer$1,{tabIndex:0,align:"center",justify:"center",children:[/* @__PURE__ */jsx(CardContainer,{radius:1}),/* @__PURE__ */jsx(ContentContainer$1,{children:message})]}),children]});}function isObjectInputProps$1(inputProps){return isObjectSchemaType(inputProps.schemaType);}function isArrayInputProps(inputProps){return isArraySchemaType(inputProps.schemaType);}function usePrevious(value,initial){const ref=useRef(initial||null);useEffect(()=>{ref.current=value;},[value]);return ref.current;}function useDidUpdate(current,didUpdate){let compare=arguments.length>2&&arguments[2]!==undefined?arguments[2]:shallowEquals;const previous=usePrevious(current);const initial=useRef(true);useEffect(()=>{if(initial.current){initial.current=false;return;}if(!compare(previous,current)){didUpdate(previous,current);}},[didUpdate,current,previous,compare]);}function whatwgRNG(){let length=arguments.length>0&&arguments[0]!==undefined?arguments[0]:16;const rnds8=new Uint8Array(length);getRandomValues(rnds8);return rnds8;}const getByteHexTable=(()=>{let table;return()=>{if(table){return table;}table=[];for(let i=0;i<256;++i){table[i]=(i+256).toString(16).substring(1);}return table;};})();function randomKey(length){const table=getByteHexTable();return whatwgRNG(length).reduce((str,n)=>str+table[n],"").slice(0,length);}function ensureKey(item){return item._key?item:_objectSpread(_objectSpread({},item),{},{_key:randomKey(12)});}function ArrayOfObjectsField(props){const{onPathBlur,onPathFocus,onChange,onSetPathCollapsed,onSetFieldSetCollapsed,onPathOpen,onFieldGroupSelect}=useFormCallbacks();const{member,renderField,renderInput,renderItem,renderPreview}=props;const focusRef=useRef();useDidUpdate(member.field.focused,(hadFocus,hasFocus)=>{var _a;if(!hadFocus&&hasFocus){(_a=focusRef.current)==null?void 0:_a.focus();}});const handleFocus=useCallback(event=>{if(event.currentTarget===event.target&&event.currentTarget===focusRef.current){onPathFocus(member.field.path);}},[member.field.path,onPathFocus]);const handleBlur=useCallback(event=>{if(event.currentTarget===event.target&&event.currentTarget===focusRef.current){onPathBlur(member.field.path);}},[member.field.path,onPathBlur]);const handleChange=useCallback(event=>{onChange(PatchEvent.from(event).prepend(setIfMissing([])).prefixAll(member.name));},[onChange,member.name]);const handleInsert=useCallback(event=>{onChange(PatchEvent.from([setIfMissing([]),insert(event.items.map(item=>ensureKey(item)),event.position,[event.referenceItem])]).prefixAll(member.name));},[member.name,onChange]);const handleMoveItem=useCallback(event=>{const value=member.field.value;const item=value==null?void 0:value[event.fromIndex];const refItem=value==null?void 0:value[event.toIndex];if(event.fromIndex===event.toIndex){return;}if(!(item==null?void 0:item._key)||!(refItem==null?void 0:refItem._key)){console.error("Neither the item you are moving nor the item you are moving to have a key. Cannot continue.");return;}onChange(PatchEvent.from([unset([{_key:item._key}]),insert([item],event.fromIndex>event.toIndex?"before":"after",[{_key:refItem._key}])]).prefixAll(member.name));},[member.field.value,member.name,onChange]);const handlePrependItem=useCallback(item=>{onChange(PatchEvent.from([setIfMissing([]),insert([ensureKey(item)],"before",[0])]).prefixAll(member.name));},[member.name,onChange]);const handleAppendItem=useCallback(item=>{onChange(PatchEvent.from([setIfMissing([]),insert([ensureKey(item)],"after",[-1])]).prefixAll(member.name));},[member.name,onChange]);const handleCollapse=useCallback(()=>{onSetPathCollapsed(member.field.path,true);},[onSetPathCollapsed,member.field.path]);const handleExpand=useCallback(()=>{onSetPathCollapsed(member.field.path,false);},[onSetPathCollapsed,member.field.path]);const handleCollapseItem=useCallback(itemKey=>{onSetPathCollapsed(member.field.path.concat({_key:itemKey}),true);},[onSetPathCollapsed,member.field.path]);const handleExpandItem=useCallback(itemKey=>{onSetPathCollapsed(member.field.path.concat({_key:itemKey}),false);},[onSetPathCollapsed,member.field.path]);const handleOpenItem=useCallback(path=>{onPathOpen(path);onSetPathCollapsed(path,false);},[onPathOpen,onSetPathCollapsed]);const handleCloseItem=useCallback(()=>{onPathOpen(member.field.path);onSetPathCollapsed(member.field.path,true);},[onPathOpen,member.field.path,onSetPathCollapsed]);const handleRemoveItem=useCallback(itemKey=>{onChange(PatchEvent.from([unset(member.field.path.concat({_key:itemKey}))]));},[onChange,member.field.path]);const handleFocusChildPath=useCallback(path=>{onPathFocus(member.field.path.concat(path));},[member.field.path,onPathFocus]);const elementProps=useMemo(()=>({onBlur:handleBlur,onFocus:handleFocus,id:member.field.id,ref:focusRef}),[handleBlur,handleFocus,member.field.id]);const resolveInitialValue=useResolveInitialValueForType();const inputProps=useMemo(()=>{return{level:member.field.level,members:member.field.members,value:member.field.value,readOnly:member.field.readOnly,schemaType:member.field.schemaType,changed:member.field.changed,id:member.field.id,onExpand:handleExpand,onCollapse:handleCollapse,onExpandItem:handleExpandItem,onCollapseItem:handleCollapseItem,onCloseItem:handleCloseItem,onOpenItem:handleOpenItem,focusPath:member.field.focusPath,focused:member.field.focused,path:member.field.path,onChange:handleChange,onInsert:handleInsert,onMoveItem:handleMoveItem,onRemoveItem:handleRemoveItem,onAppendItem:handleAppendItem,onPrependItem:handlePrependItem,onFocusPath:handleFocusChildPath,resolveInitialValue,validation:member.field.validation,presence:member.field.presence,renderInput,renderField,renderItem,renderPreview,elementProps};},[member.field.level,member.field.members,member.field.value,member.field.readOnly,member.field.schemaType,member.field.changed,member.field.id,member.field.focusPath,member.field.focused,member.field.path,member.field.validation,member.field.presence,handleExpand,handleCollapse,handleExpandItem,handleCollapseItem,handleCloseItem,handleOpenItem,handleChange,handleInsert,handleMoveItem,handleRemoveItem,handleAppendItem,handlePrependItem,handleFocusChildPath,renderInput,renderField,renderItem,renderPreview,elementProps]);const renderedInput=useMemo(()=>renderInput(inputProps),[inputProps,renderInput]);const fieldProps=useMemo(()=>{return{name:member.name,index:member.index,level:member.field.level,value:member.field.value,title:member.field.schemaType.title,description:member.field.schemaType.description,collapsible:member.collapsible,collapsed:member.collapsed,changed:member.field.changed,onCollapse:handleCollapse,onExpand:handleExpand,schemaType:member.field.schemaType,inputId:member.field.id,path:member.field.path,presence:member.field.presence,validation:member.field.validation,children:renderedInput,inputProps};},[member.name,member.index,member.field.level,member.field.value,member.field.schemaType,member.field.id,member.field.path,member.field.presence,member.field.changed,member.field.validation,member.collapsible,member.collapsed,handleCollapse,handleExpand,renderedInput,inputProps]);return/* @__PURE__ */jsx(FormCallbacksProvider,{onFieldGroupSelect,onChange:handleChange,onSetFieldSetCollapsed,onSetPathCollapsed,onPathOpen,onPathBlur,onPathFocus,children:useMemo(()=>renderField(fieldProps),[fieldProps,renderField])});}function PrimitiveField$1(props){const{member,renderInput,renderField}=props;const focusRef=useRef();const{onPathBlur,onPathFocus,onChange}=useFormCallbacks();useDidUpdate(member.field.focused,(hadFocus,hasFocus)=>{var _a;if(!hadFocus&&hasFocus){(_a=focusRef.current)==null?void 0:_a.focus();}});const handleBlur=useCallback(event=>{onPathBlur(member.field.path);},[member.field.path,onPathBlur]);const handleFocus=useCallback(event=>{onPathFocus(member.field.path);},[member.field.path,onPathFocus]);const handleChange=useCallback(event=>{onChange(PatchEvent.from(event).prefixAll(member.name));},[onChange,member.name]);const handleNativeChange=useCallback(event=>{let inputValue=event.currentTarget.value;if(isNumberSchemaType(member.field.schemaType)){inputValue=event.currentTarget.valueAsNumber;}else if(isBooleanSchemaType(member.field.schemaType)){inputValue=event.currentTarget.checked;}const hasEmptyValue=inputValue===""||typeof inputValue==="number"&&isNaN(inputValue);onChange(PatchEvent.from(hasEmptyValue?unset():set(inputValue)).prefixAll(member.name));},[member.name,member.field.schemaType,onChange]);const validationError=useMemo(()=>member.field.validation.filter(item=>item.level==="error").map(item=>item.message).join("\n"),[member.field.validation])||void 0;const elementProps=useMemo(()=>({onBlur:handleBlur,onFocus:handleFocus,id:member.field.id,ref:focusRef,onChange:handleNativeChange,value:String(member.field.value||""),readOnly:Boolean(member.field.readOnly),placeholder:member.field.schemaType.placeholder}),[handleBlur,handleFocus,handleNativeChange,member.field.id,member.field.readOnly,member.field.schemaType.placeholder,member.field.value]);const inputProps=useMemo(()=>{return{value:member.field.value,readOnly:member.field.readOnly,schemaType:member.field.schemaType,changed:member.field.changed,id:member.field.id,path:member.field.path,focused:member.field.focused,level:member.field.level,onChange:handleChange,validation:member.field.validation,presence:member.field.presence,validationError,elementProps};},[member.field.value,member.field.readOnly,member.field.schemaType,member.field.changed,member.field.id,member.field.path,member.field.focused,member.field.level,member.field.validation,member.field.presence,handleChange,validationError,elementProps]);const renderedInput=useMemo(()=>renderInput(inputProps),[inputProps,renderInput]);const fieldProps=useMemo(()=>{return{name:member.name,index:member.index,level:member.field.level,value:member.field.value,schemaType:member.field.schemaType,title:member.field.schemaType.title,description:member.field.schemaType.description,inputId:member.field.id,path:member.field.path,validation:member.field.validation,presence:member.field.presence,children:renderedInput,changed:member.field.changed,inputProps};},[member.name,member.index,member.field.level,member.field.value,member.field.schemaType,member.field.id,member.field.path,member.field.validation,member.field.presence,member.field.changed,renderedInput,inputProps]);return/* @__PURE__ */jsx(Fragment,{children:renderField(fieldProps)});}function createProtoValue$1(type){if(isObjectSchemaType(type)){return type.name==="object"?{}:{_type:type.name};}if(isArraySchemaType(type)){return[];}if(type.jsonType==="string"){return"";}if(type.jsonType==="number"){return 0;}if(type.jsonType==="boolean"){return false;}return void 0;}const ObjectField=function ObjectField2(props){const{onPathBlur,onPathFocus,onChange,onPathOpen,onSetPathCollapsed,onSetFieldSetCollapsed,onFieldGroupSelect}=useFormCallbacks();const{member,renderField,renderInput,renderItem,renderPreview}=props;const focusRef=useRef();useDidUpdate(member.field.focused,(hadFocus,hasFocus)=>{var _a;if(!hadFocus&&hasFocus){(_a=focusRef.current)==null?void 0:_a.focus();}});const handleBlur=useCallback(()=>{onPathBlur(member.field.path);},[member.field.path,onPathBlur]);const handleFocus=useCallback(()=>{onPathFocus(member.field.path);},[member.field.path,onPathFocus]);const handleFocusChildPath=useCallback(path=>{onPathFocus(member.field.path.concat(path));},[member.field.path,onPathFocus]);const handleChange=useCallback(event=>{onChange(PatchEvent.from(event).prepend(setIfMissing(createProtoValue$1(member.field.schemaType))).prefixAll(member.name));},[onChange,member.field.schemaType,member.name]);const handleCollapse=useCallback(()=>{onSetPathCollapsed(member.field.path,true);},[onSetPathCollapsed,member.field.path]);const handleExpand=useCallback(()=>{onSetPathCollapsed(member.field.path,false);},[onSetPathCollapsed,member.field.path]);const handleCollapseField=useCallback(fieldName=>{onSetPathCollapsed(member.field.path.concat(fieldName),true);},[onSetPathCollapsed,member.field.path]);const handleExpandField=useCallback(fieldName=>{onSetPathCollapsed(member.field.path.concat(fieldName),false);},[onSetPathCollapsed,member.field.path]);const handleOpenField=useCallback(fieldName=>{onPathOpen(member.field.path.concat(fieldName));},[onPathOpen,member.field.path]);const handleCloseField=useCallback(()=>{onPathOpen(member.field.path);},[onPathOpen,member.field.path]);const handleExpandFieldSet=useCallback(fieldsetName=>{onSetFieldSetCollapsed(member.field.path.concat(fieldsetName),false);},[onSetFieldSetCollapsed,member.field.path]);const handleCollapseFieldSet=useCallback(fieldsetName=>{onSetFieldSetCollapsed(member.field.path.concat(fieldsetName),true);},[onSetFieldSetCollapsed,member.field.path]);const handleOpen=useCallback(()=>{onPathOpen(member.field.path);},[onPathOpen,member.field.path]);const handleClose=useCallback(()=>{onPathOpen(member.field.path.slice(0,-1));},[onPathOpen,member.field.path]);const handleSelectFieldGroup=useCallback(groupName=>{onFieldGroupSelect(member.field.path,groupName);},[onFieldGroupSelect,member.field.path]);const elementProps=useMemo(()=>({onBlur:handleBlur,onFocus:handleFocus,id:member.field.id,ref:focusRef}),[handleBlur,handleFocus,member.field.id]);const inputProps=useMemo(()=>{return{elementProps,level:member.field.level,members:member.field.members,value:member.field.value,readOnly:member.field.readOnly,validation:member.field.validation,presence:member.field.presence,schemaType:member.field.schemaType,changed:member.field.changed,id:member.field.id,onFieldGroupSelect:handleSelectFieldGroup,onOpenField:handleOpenField,onCloseField:handleCloseField,onCollapseField:handleCollapseField,onExpandField:handleExpandField,onExpandFieldSet:handleExpandFieldSet,onCollapseFieldSet:handleCollapseFieldSet,onFocusPath:handleFocusChildPath,path:member.field.path,focusPath:member.field.focusPath,focused:member.field.focused,groups:member.field.groups,onChange:handleChange,renderField,renderInput,renderItem,renderPreview};},[member.field.level,member.field.members,member.field.value,member.field.readOnly,member.field.validation,member.field.presence,member.field.schemaType,member.field.changed,member.field.id,member.field.path,member.field.focusPath,member.field.focused,member.field.groups,handleBlur,handleSelectFieldGroup,handleOpenField,handleCloseField,handleCollapseField,handleExpandField,handleExpandFieldSet,handleCollapseFieldSet,handleFocus,handleFocusChildPath,handleChange,renderField,renderInput,renderItem,renderPreview]);const renderedInput=useMemo(()=>renderInput(inputProps),[inputProps,renderInput]);const fieldProps=useMemo(()=>{return{name:member.name,index:member.index,level:member.field.level,value:member.field.value,validation:member.field.validation,presence:member.field.presence,title:member.field.schemaType.title,description:member.field.schemaType.description,collapsible:member.collapsible,collapsed:member.collapsed,onCollapse:handleCollapse,onExpand:handleExpand,open:member.open,changed:member.field.changed,onOpen:handleOpen,onClose:handleClose,schemaType:member.field.schemaType,inputId:member.field.id,path:member.field.path,children:renderedInput,inputProps};},[member.name,member.index,member.field.changed,member.field.level,member.field.value,member.field.validation,member.field.presence,member.field.schemaType,member.field.id,member.field.path,member.collapsible,member.collapsed,member.open,handleCollapse,handleExpand,handleOpen,handleClose,renderedInput,inputProps]);return/* @__PURE__ */jsx(FormCallbacksProvider,{onFieldGroupSelect,onChange:handleChange,onSetFieldSetCollapsed,onPathOpen,onSetPathCollapsed,onPathBlur,onPathFocus,children:useMemo(()=>renderField(fieldProps),[fieldProps,renderField])});};function move$1(arr,from,to){const copy=arr.slice();const val=copy[from];copy.splice(from,1);copy.splice(to,0,val);return copy;}function insertAfter(index,arr,items){const copy=arr.slice();copy.splice(index+1,0,...items);return copy;}function ArrayOfPrimitivesField(props){const{onPathBlur,onPathFocus,onChange,onPathOpen,onSetPathCollapsed,onSetFieldSetCollapsed,onFieldGroupSelect}=useFormCallbacks();const{member,renderField,renderInput,renderItem,renderPreview}=props;const focusRef=useRef();useDidUpdate(member.field.focused,(hadFocus,hasFocus)=>{var _a;if(!hadFocus&&hasFocus){(_a=focusRef.current)==null?void 0:_a.focus();}});const handleFocus=useCallback(event=>{if(event.currentTarget===event.target&&event.currentTarget===focusRef.current){onPathFocus(member.field.path);}},[member.field.path,onPathFocus]);const handleBlur=useCallback(event=>{if(event.currentTarget===event.target&&event.currentTarget===focusRef.current){onPathBlur(member.field.path);}},[member.field.path,onPathBlur]);const handleChange=useCallback(event=>{onChange(PatchEvent.from(event).prepend(setIfMissing([])).prefixAll(member.name));},[onChange,member.name]);const handleSetCollapsed=useCallback(collapsed=>{onSetPathCollapsed(member.field.path,collapsed);},[onSetPathCollapsed,member.field.path]);const handleCollapse=useCallback(()=>{onSetPathCollapsed(member.field.path,true);},[onSetPathCollapsed,member.field.path]);const handleExpand=useCallback(()=>{onSetPathCollapsed(member.field.path,false);},[onSetPathCollapsed,member.field.path]);const setValue=useCallback(nextValue=>{onChange(PatchEvent.from(nextValue.length===0?unset():set(nextValue)).prefixAll(member.name));},[member.name,onChange]);const handleMoveItem=useCallback(event=>{const{value=[]}=member.field;if(event.fromIndex===event.toIndex){return;}setValue(move$1(value,event.fromIndex,event.toIndex));},[member.field,setValue]);const handleAppend=useCallback(itemValue=>{const{value=[]}=member.field;setValue(value.concat(itemValue));},[member.field,setValue]);const handlePrepend=useCallback(itemValue=>{const{value=[]}=member.field;setValue([itemValue].concat(value||[]));},[member.field,setValue]);const handleInsert=useCallback(event=>{const{value=[]}=member.field;const insertIndex=event.referenceIndex+(event.position==="before"?-1:0);setValue(insertAfter(insertIndex,value,event.items));},[member.field,setValue]);const handleRemoveItem=useCallback(index=>{onChange(PatchEvent.from([unset(member.field.path.concat(index))]));},[onChange,member.field.path]);const handleFocusIndex=useCallback(index=>{onPathFocus(member.field.path.concat([index]));},[member.field.path,onPathFocus]);const elementProps=useMemo(()=>({onBlur:handleBlur,onFocus:handleFocus,id:member.field.id,ref:focusRef}),[handleBlur,handleFocus,member.field.id]);const inputProps=useMemo(()=>{return{level:member.field.level,members:member.field.members,value:member.field.value,readOnly:member.field.readOnly,onSetCollapsed:handleSetCollapsed,schemaType:member.field.schemaType,changed:member.field.changed,id:member.field.id,elementProps,path:member.field.path,focusPath:member.field.focusPath,focused:member.field.focused,onChange:handleChange,onInsert:handleInsert,onMoveItem:handleMoveItem,onRemoveItem:handleRemoveItem,onAppendItem:handleAppend,onPrependItem:handlePrepend,validation:member.field.validation,presence:member.field.presence,renderInput,renderItem,onFocusIndex:handleFocusIndex,renderPreview};},[member.field.level,member.field.members,member.field.value,member.field.readOnly,member.field.schemaType,member.field.changed,member.field.id,member.field.path,member.field.focusPath,member.field.focused,member.field.validation,member.field.presence,handleSetCollapsed,elementProps,handleChange,handleInsert,handleMoveItem,handleRemoveItem,handleAppend,handlePrepend,renderInput,renderItem,handleFocusIndex,renderPreview]);const renderedInput=useMemo(()=>renderInput(inputProps),[inputProps,renderInput]);const fieldProps=useMemo(()=>{return{name:member.name,index:member.index,level:member.field.level,value:member.field.value,title:member.field.schemaType.title,description:member.field.schemaType.description,collapsible:member.collapsible,collapsed:member.collapsed,onExpand:handleExpand,changed:member.field.changed,onCollapse:handleCollapse,schemaType:member.field.schemaType,inputId:member.field.id,path:member.field.path,presence:member.field.presence,validation:member.field.validation,children:renderedInput,inputProps};},[member.name,member.index,member.field.level,member.field.value,member.field.schemaType,member.field.id,member.field.path,member.field.presence,member.field.validation,member.collapsible,member.collapsed,member.field.changed,handleExpand,handleCollapse,renderedInput,inputProps]);return/* @__PURE__ */jsx(FormCallbacksProvider,{onFieldGroupSelect,onChange:handleChange,onPathOpen,onSetFieldSetCollapsed,onSetPathCollapsed,onPathBlur,onPathFocus,children:useMemo(()=>renderField(fieldProps),[fieldProps,renderField])});}const MemberField=memo(function MemberField2(props){const{member,renderField,renderInput,renderItem,renderPreview}=props;if(isMemberObject(member)){return/* @__PURE__ */jsx(ObjectField,{member,renderField,renderInput,renderItem,renderPreview});}if(isMemberArrayOfPrimitives(member)){return/* @__PURE__ */jsx(ArrayOfPrimitivesField,{member,renderField,renderInput,renderItem,renderPreview});}if(isMemberArrayOfObjects(member)){return/* @__PURE__ */jsx(ArrayOfObjectsField,{member,renderField,renderInput,renderItem,renderPreview});}return/* @__PURE__ */jsx(PrimitiveField$1,{member,renderField,renderInput});});const STATUS_TONES$1={warning:"caution",error:"critical"};const SuffixBox=styled(Box)(_templateObject139||(_templateObject139=_taggedTemplateLiteral(["\n  border-top: 1px solid var(--card-border-color);\n"])));function Alert(props){const{children,status="warning",suffix,title}=props,rest=_objectWithoutProperties(props,_excluded43);return/* @__PURE__ */jsxs(Card,_objectSpread(_objectSpread({radius:2,tone:STATUS_TONES$1[status]},rest),{},{"data-ui":"Alert",children:[/* @__PURE__ */jsxs(Flex,{padding:4,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsxs(Text$1,{size:1,children:[status==="warning"&&/* @__PURE__ */jsx(WarningOutlineIcon,{}),status==="error"&&/* @__PURE__ */jsx(ErrorOutlineIcon,{})]})}),/* @__PURE__ */jsxs(Box,{flex:1,marginLeft:3,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:title}),children&&/* @__PURE__ */jsx(Box,{marginTop:3,children})]})]}),suffix&&/* @__PURE__ */jsx(SuffixBox,{children:suffix})]}));}const HeaderButton=styled.button(_templateObject140||(_templateObject140=_taggedTemplateLiteral(["\n  display: block;\n  -webkit-font-smoothing: inherit;\n  appearance: none;\n  font: inherit;\n  background: none;\n  width: 100%;\n  text-align: left;\n  border: 0;\n  margin: 0;\n  padding: 0;\n  outline: none;\n"])));const ToggleArrow=styled(ToggleArrowRightIcon)(_templateObject141||(_templateObject141=_taggedTemplateLiteral(["\n  transform: ",";\n"])),props=>props.open?"rotate(90deg)":"");const Header$1=styled(Flex)(_templateObject142||(_templateObject142=_taggedTemplateLiteral(["\n  cursor: default;\n"])));const IconBox$1=styled(Box)(_templateObject143||(_templateObject143=_taggedTemplateLiteral(["\n  & > div > svg {\n    transform: rotate(0);\n    transition: transform 100ms;\n  }\n\n  &[data-open] > div > svg {\n    transform: rotate(90deg);\n  }\n"])));function Details(props){const{children,open:openProp,icon,title="Details"}=props,restProps=_objectWithoutProperties(props,_excluded44);const[open,setOpen]=useState(openProp||false);const handleToggle=useCallback(()=>setOpen(v=>!v),[]);useEffect(()=>setOpen(openProp||false),[openProp]);return/* @__PURE__ */jsxs(Box,_objectSpread(_objectSpread({},restProps),{},{children:[/* @__PURE__ */jsx(HeaderButton,{type:"button",onClick:handleToggle,children:/* @__PURE__ */jsx(Header$1,{align:"center",children:/* @__PURE__ */jsxs(Inline,{children:[/* @__PURE__ */jsx(IconBox$1,{"data-open":open?"":void 0,children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(ToggleArrow,{open})})}),icon&&/* @__PURE__ */jsx(Box,{marginLeft:1,children:icon}),/* @__PURE__ */jsx(Box,{flex:1,marginLeft:1,children:/* @__PURE__ */jsx(Text$1,{size:1,weight:"medium",children:title})})]})})}),/* @__PURE__ */jsx(Box,{hidden:!open,marginTop:3,children})]}));}const TRUTHY_STRINGS=["yes","true","1"];const FALSEY_STRINGS=["false","no","false","0","null"];const BOOL_STRINGS=TRUTHY_STRINGS.concat(FALSEY_STRINGS);const TRUE=()=>true;const has=prop=>val=>val&&val[prop];const is$1=typeName=>val=>(val&&val._type)===typeName;function toLocalDate(input){const newDate=new Date(input.getTime()+input.getTimezoneOffset()*60*1e3);const offset=input.getTimezoneOffset()/60;const hours=input.getHours();newDate.setHours(hours-offset);return newDate;}function getTZName(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone;}catch(e){}return null;}const converters={string:{number:{test:Number,convert:Number},boolean:{test:value=>BOOL_STRINGS.includes(value.toLowerCase()),convert:value=>TRUTHY_STRINGS.includes(value.toLowerCase())||!FALSEY_STRINGS.includes(value.toLowerCase())},richDate:{test:value=>isValidDate$1(value),convert:value=>{return{_type:"richDate",local:toLocalDate(new Date(value)).toJSON(),utc:new Date(value).toJSON(),timezone:getTZName(),offset:new Date().getTimezoneOffset()};}}},date:{richDate:{test:is$1("date"),convert:value=>Object.assign({},value,{_type:"richDate"})}},richDate:{datetime:{test:has("utc"),convert:value=>value.utc}},number:{string:{test:TRUE,convert:String},boolean:{test:TRUE,convert:Number}},boolean:{string:{test:TRUE,convert:value=>value?"Yes":"No"},number:{test:TRUE,convert:Number}}};function SetMissingTypeButton(_ref211){let{value,targetType,onChange}=_ref211;const itemValue=useMemo(()=>_objectSpread(_objectSpread({},value),{},{_type:targetType}),[targetType,value]);const handleClick=useCallback(()=>onChange(PatchEvent.from(setIfMissing(targetType,["_type"])),itemValue),[itemValue,onChange,targetType]);return/* @__PURE__ */jsx(Button,{onClick:handleClick,text:/* @__PURE__ */jsxs(Fragment,{children:["Convert to ",/* @__PURE__ */jsx("code",{children:targetType})]})});}function UnsetItemButton(_ref212){let{value,onChange,validTypes}=_ref212;const itemValue=useMemo(()=>_objectSpread(_objectSpread({},value),{},{_type:validTypes[0]}),[validTypes,value]);const handleClick=useCallback(()=>onChange(PatchEvent.from(unset()),itemValue),[itemValue,onChange]);return/* @__PURE__ */jsx(Button,{onClick:handleClick,tone:"critical",text:"Unset value"});}function UntypedValueInput(_ref213){let{validTypes,value,onChange}=_ref213;const schema=useSchema();const isSingleValidType=validTypes.length===1;const isHoistedType=schema.has(validTypes[0]);return/* @__PURE__ */jsx(Alert,{status:"warning",title:/* @__PURE__ */jsxs(Fragment,{children:["Property value missing ",/* @__PURE__ */jsx("code",{children:"_type"})]}),children:/* @__PURE__ */jsx(Details,{open:isDev,title:/* @__PURE__ */jsx(Fragment,{children:"Developer info"}),children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["Encountered an object value without a ",/* @__PURE__ */jsx("code",{children:"_type"})," property."]}),isSingleValidType&&!isHoistedType&&/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["Either remove the ",/* @__PURE__ */jsx("code",{children:"name"})," property of the object declaration, or set"," ",/* @__PURE__ */jsx("code",{children:"_type"})," property on items."]}),!isSingleValidType&&/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"The following types are valid here according to schema:"}),!isSingleValidType&&/* @__PURE__ */jsx(Stack,{as:"ul",space:2,children:validTypes.map(validType=>/* @__PURE__ */jsx(Text$1,{as:"li",muted:true,size:1,children:/* @__PURE__ */jsx("code",{children:validType})},validType))}),/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsxs(Text$1,{as:"h4",weight:"semibold",size:1,children:["Current value (",/* @__PURE__ */jsx("code",{children:"object"}),"):"]}),/* @__PURE__ */jsx(Card,{border:true,overflow:"auto",padding:2,radius:2,tone:"inherit",children:/* @__PURE__ */jsx(Code,{language:"json",children:JSON.stringify(value,null,2)})})]}),/* @__PURE__ */jsxs(Grid,{columns:[1,2,2],gap:1,children:[isSingleValidType&&/* @__PURE__ */jsx(SetMissingTypeButton,{onChange,targetType:validTypes[0],value}),/* @__PURE__ */jsx(UnsetItemButton,{onChange,validTypes,value})]})]})})});}function getConverters(value,actualType,validTypes){if(!(actualType in converters)){return[];}return Object.keys(converters[actualType]).filter(targetType=>validTypes.includes(targetType)).map(targetType=>_objectSpread({from:actualType,to:targetType},converters[actualType][targetType])).filter(converter=>converter.test(value));}const InvalidValueInput=forwardRef((props,ref)=>{const{value,actualType,validTypes,onChange}=props;useImperativeHandle(ref,()=>({focus:()=>void 0}));const handleClearClick=useCallback(()=>{onChange(PatchEvent.from(unset()));},[onChange]);const handleConvertTo=useCallback(converted=>{onChange(PatchEvent.from(set(converted)));},[onChange]);const converters=useMemo(()=>getConverters(value,actualType,validTypes),[value,actualType,validTypes]);if(typeof value==="object"&&value!==null&&!("_type"in value)){return/* @__PURE__ */jsx(UntypedValueInput,{value,validTypes,onChange});}const suffix=/* @__PURE__ */jsx(Stack,{padding:2,children:/* @__PURE__ */jsx(Button,{onClick:handleClearClick,tone:"critical",text:"Reset value"})});return/* @__PURE__ */jsxs(Alert,{status:"error",suffix,title:/* @__PURE__ */jsx(Fragment,{children:"Invalid property value"}),children:[/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"The property value is stored as a value type that does not match the expected type."}),/* @__PURE__ */jsx(Details,{marginTop:4,open:isDev,title:/* @__PURE__ */jsx(Fragment,{children:"Developer info"}),children:/* @__PURE__ */jsxs(Stack,{space:3,children:[validTypes.length===1&&/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["The value of this property must be of type ",/* @__PURE__ */jsx("code",{children:validTypes[0]})," according to the schema."]}),validTypes.length===1&&/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"Mismatching value types typically occur when the schema has recently been changed."}),validTypes.length!==1&&/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"Only the following types are valid here according to schema:"}),validTypes.length!==1&&/* @__PURE__ */jsx(Stack,{as:"ul",space:2,children:validTypes.map(validType=>/* @__PURE__ */jsx(Text$1,{as:"li",children:/* @__PURE__ */jsx("code",{children:validType})},validType))}),/* @__PURE__ */jsxs(Stack,{marginTop:2,space:2,children:[/* @__PURE__ */jsxs(Text$1,{size:1,weight:"semibold",children:["The current value (",/* @__PURE__ */jsx("code",{children:actualType}),")"]}),/* @__PURE__ */jsx(Card,{border:true,padding:2,radius:2,tone:"inherit",children:/* @__PURE__ */jsx(Code,{language:"json",size:1,children:JSON.stringify(value,null,2)})})]}),converters.length>0&&/* @__PURE__ */jsx(Stack,{space:1,children:converters.map(converter=>/* @__PURE__ */jsx(ConvertButton,{converter,onConvert:handleConvertTo,value},"".concat(converter.from,"-").concat(converter.to)))})]})})]});});InvalidValueInput.displayName="InvalidValueInput";function ConvertButton(_ref214){let{converter,onConvert,value}=_ref214;const handleClick=useCallback(()=>onConvert(converter.convert(value)),[converter,onConvert,value]);return/* @__PURE__ */jsx(Button,{onClick:handleClick,text:/* @__PURE__ */jsxs(Fragment,{children:["Convert to ",/* @__PURE__ */jsx("code",{children:converter.to})]})});}const EMPTY_ARRAY$3=[];const VALIDATION_COLORS={error:hues.red[500].hex,warning:hues.yellow[500].hex,info:hues.blue[500].hex};const VALIDATION_ICONS={error:/* @__PURE__ */jsx(ErrorOutlineIcon,{"data-testid":"input-validation-icon-error"}),warning:/* @__PURE__ */jsx(WarningOutlineIcon,{"data-testid":"input-validation-icon-warning"}),info:/* @__PURE__ */jsx(InfoOutlineIcon,{"data-testid":"input-validation-icon-info"})};function FormFieldValidationStatus(props){const{validation=EMPTY_ARRAY$3,__unstable_showSummary:showSummary,fontSize,placement="top",portal}=props;const errors=validation.filter(v=>v.level==="error");const warnings=validation.filter(v=>v.level==="warning");const info=validation.filter(v=>v.level==="info");const hasErrors=errors.length>0;const hasWarnings=warnings.length>0;const hasInfo=info.length>0;const statusIcon=useMemo(()=>{if(hasErrors)return VALIDATION_ICONS.error;if(hasWarnings)return VALIDATION_ICONS.warning;if(hasInfo)return VALIDATION_ICONS.info;return void 0;},[hasErrors,hasInfo,hasWarnings]);const statusColor=useMemo(()=>{if(hasErrors)return VALIDATION_COLORS.error;if(hasWarnings)return VALIDATION_COLORS.warning;if(hasInfo)return VALIDATION_COLORS.info;return void 0;},[hasErrors,hasInfo,hasWarnings]);return/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsxs(Stack,{padding:3,space:3,children:[showSummary&&/* @__PURE__ */jsx(FormFieldValidationSummary,{validation}),!showSummary&&/* @__PURE__ */jsx(Fragment,{children:validation.map((item,itemIndex)=>/* @__PURE__ */jsx(FormFieldValidationStatusItem,{validation:item},itemIndex))})]}),portal,placement,fallbackPlacements:["bottom","right","left"],children:/* @__PURE__ */jsx("div",{children:/* @__PURE__ */jsx(Text$1,{muted:true,size:fontSize,weight:"semibold",style:{color:statusColor},children:statusIcon})})});}function FormFieldValidationStatusItem(props){const{validation}=props;const statusIcon=useMemo(()=>{if(validation.level==="error")return VALIDATION_ICONS.error;if(validation.level==="warning")return VALIDATION_ICONS.warning;if(validation.level==="info")return VALIDATION_ICONS.info;return void 0;},[validation]);const statusColor=useMemo(()=>{if(validation.level==="error")return VALIDATION_COLORS.error;if(validation.level==="warning")return VALIDATION_COLORS.warning;if(validation.level==="info")return VALIDATION_COLORS.info;return void 0;},[validation]);return/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{marginRight:2,children:/* @__PURE__ */jsx(Text$1,{size:1,style:{color:statusColor},children:statusIcon})}),/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:validation.message})})]});}function FormFieldValidationSummary(_ref215){let{validation}=_ref215;const errorMarkers=validation.filter(item=>item.level==="error");const warningMarkers=validation.filter(item=>item.level==="warning");const errorLen=errorMarkers.length;const warningLen=warningMarkers.length;const errorsStr="error".concat(errorLen===1?"":"s");const warningsStr="warning".concat(warningLen===1?"":"s");const errorText=errorLen&&"".concat(errorLen," ").concat(errorsStr);const warningText=warningLen&&"".concat(warningLen," ").concat(warningsStr);const hasErrors=errorLen>0;const hasWarnings=warningLen>0;const hasBoth=hasErrors&&hasWarnings;return/* @__PURE__ */jsxs(Text$1,{muted:true,size:1,children:[errorText||"",hasBoth&&/* @__PURE__ */jsx(Fragment,{children:" and "}),warningText||""]});}const EMPTY_ARRAY$2=[];const FormFieldHeaderText=memo(function FormFieldHeaderText2(props){const{description,inputId,title,validation=EMPTY_ARRAY$2}=props;const hasValidations=validation.length>0;return/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Text$1,{as:"label",htmlFor:inputId,weight:"semibold",size:1,children:title||/* @__PURE__ */jsx("span",{style:{color:"var(--card-muted-fg-color)"},children:"Untitled"})}),hasValidations&&/* @__PURE__ */jsx(Box,{marginLeft:2,children:/* @__PURE__ */jsx(FormFieldValidationStatus,{fontSize:1,validation})})]}),description&&/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:description})]});});const FormFieldHeader=memo(function FormFieldHeader2(props){const{validation,__unstable_presence:presence,description,inputId,title}=props;return/* @__PURE__ */jsxs(Flex,{align:"flex-end",children:[/* @__PURE__ */jsx(Box,{flex:1,paddingY:2,children:/* @__PURE__ */jsx(FormFieldHeaderText,{validation,description,inputId,title})}),presence&&presence.length>0&&/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(FieldPresence,{maxAvatars:4,presence})})]});});const FormField=memo(function FormField2(props){const{validation,__unstable_presence:presence,children,description,inputId,level,title}=props,restProps=_objectWithoutProperties(props,_excluded45);return/* @__PURE__ */jsxs(Stack,_objectSpread(_objectSpread({},restProps),{},{"data-level":level,space:1,children:[title&&/* @__PURE__ */jsx(FormFieldHeader,{validation,__unstable_presence:presence,description,inputId,title}),/* @__PURE__ */jsx("div",{children})]}));});function focusRingBorderStyle$2(border){return"inset 0 0 0 ".concat(border.width,"px ").concat(border.color);}function focusRingStyle$2(opts){const{base,border,focusRing}=opts;const focusRingOutsetWidth=focusRing.offset+focusRing.width;const focusRingInsetWidth=0-focusRing.offset;const bgColor=base?base.bg:"var(--card-bg-color)";return[focusRingInsetWidth>0&&"inset 0 0 0 ".concat(focusRingInsetWidth,"px var(--card-focus-ring-color)"),border&&focusRingBorderStyle$2(border),focusRingInsetWidth<0&&"0 0 0 ".concat(0-focusRingInsetWidth,"px ").concat(bgColor),focusRingOutsetWidth>0&&"0 0 0 ".concat(focusRingOutsetWidth,"px var(--card-focus-ring-color)")].filter(Boolean).join(",");}const Root$n=styled.legend(_templateObject144||(_templateObject144=_taggedTemplateLiteral(["\n  /* See: https://thatemil.com/blog/2015/01/03/reset-your-fieldset/ */\n  padding: 0;\n  display: table;\n"])));const ToggleButton=styled(Flex).attrs({forwardedAs:"button"})(props=>{const{theme}=props;const{focusRing,radius}=theme.sanity;const{base}=theme.sanity.color;return css(_templateObject145||(_templateObject145=_taggedTemplateLiteral(["\n    appearance: none;\n    border: 0;\n    background: none;\n    color: inherit;\n    -webkit-font-smoothing: inherit;\n    font: inherit;\n    outline: none;\n    border-radius: ",";\n\n    &:not([hidden]) {\n      display: flex;\n    }\n\n    &:focus {\n      box-shadow: ",";\n    }\n\n    &:focus:not(:focus-visible) {\n      box-shadow: none;\n    }\n  "])),rem(radius[1]),focusRingStyle$2({base,focusRing}));});const ToggleIconBox=styled(Box)(_templateObject146||(_templateObject146=_taggedTemplateLiteral(["\n  width: 9px;\n  height: 9px;\n  margin-right: 3px;\n\n  & svg {\n    transition: transform 100ms;\n  }\n"])));const FormFieldSetLegend=memo(function FormFieldSetLegend2(props){const{collapsed,collapsible,onClick,title}=props;const text=/* @__PURE__ */jsx(Text$1,{weight:"semibold",size:1,children:title||/* @__PURE__ */jsx("span",{style:{color:"var(--card-muted-fg-color)"},children:"Untitled"})});if(!collapsible){return/* @__PURE__ */jsx(Root$n,{children:text});}return/* @__PURE__ */jsx(Root$n,{children:/* @__PURE__ */jsxs(ToggleButton,{type:"button",onClick,children:[/* @__PURE__ */jsx(ToggleIconBox,{children:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:/* @__PURE__ */jsx(ToggleArrowRightIcon,{style:{transform:"rotate(".concat(collapsed?"0":"90deg",") translate3d(0, 0, 0)")}})})}),text]})});});function getChildren(children){return typeof children==="function"?children():children;}const Root$m=styled(Box).attrs({forwardedAs:"fieldset"})(_templateObject147||(_templateObject147=_taggedTemplateLiteral(["\n  border: none;\n\n  /* See: https://thatemil.com/blog/2015/01/03/reset-your-fieldset/ */\n  body:not(:-moz-handler-blocked) & {\n    display: table-cell;\n  }\n"])));const Content$2=styled(Box)(props=>{const{$borderLeft,theme}=props;const{focusRing,radius}=theme.sanity;const{base}=theme.sanity.color;return css(_templateObject148||(_templateObject148=_taggedTemplateLiteral(["\n    outline: none;\n    border-left: ",";\n    border-radius: ",";\n\n    &:focus {\n      box-shadow: ",";\n    }\n\n    &:focus:not(:focus-visible) {\n      box-shadow: none;\n    }\n  "])),$borderLeft?"1px solid var(--card-border-color)":void 0,rem(radius[1]),focusRingStyle$2({base,focusRing:_objectSpread(_objectSpread({},focusRing),{},{offset:2})}));});const EMPTY_ARRAY$1=[];const FormFieldSet=forwardRef(function FormFieldSet2(props,ref){const{validation=EMPTY_ARRAY$1,__unstable_presence:presence=EMPTY_ARRAY$1,children,collapsible,columns,description,level=0,onFocus,onCollapse,onExpand,collapsed,tabIndex,title}=props,restProps=_objectWithoutProperties(props,_excluded46);const hasValidationMarkers=validation.length>0;const forwardedRef=useForwardedRef(ref);const handleFocus=useCallback(event=>{const element=forwardedRef.current;if(element===event.target){if(onFocus)onFocus(event);}},[forwardedRef,onFocus]);const handleToggle=useCallback(()=>collapsed?onExpand==null?void 0:onExpand():onCollapse==null?void 0:onCollapse(),[collapsed,onCollapse,onExpand]);const content=useMemo(()=>{if(collapsed){return null;}return/* @__PURE__ */jsx(Grid,{columns,gapX:4,gapY:5,children:getChildren(children)});},[children,collapsed,columns]);return/* @__PURE__ */jsxs(Root$m,_objectSpread(_objectSpread({"data-level":level},restProps),{},{children:[title&&/* @__PURE__ */jsxs(Flex,{align:"flex-end",children:[/* @__PURE__ */jsx(Box,{flex:1,paddingY:2,children:/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(FormFieldSetLegend,{collapsed:Boolean(collapsed),collapsible,onClick:collapsible?handleToggle:void 0,title}),hasValidationMarkers&&/* @__PURE__ */jsx(Box,{marginLeft:2,children:/* @__PURE__ */jsx(FormFieldValidationStatus,{fontSize:1,validation})})]}),description&&/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:description})]})}),presence.length>0&&/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(FieldPresence,{maxAvatars:4,presence})})]}),/* @__PURE__ */jsx(Content$2,{$borderLeft:level>0,hidden:collapsed,marginTop:1,paddingLeft:level===0?0:3,onFocus:typeof tabIndex==="number"&&tabIndex>-1?handleFocus:void 0,ref:forwardedRef,tabIndex,children:!collapsed&&content})]}));});const Root$l=styled.div(_templateObject149||(_templateObject149=_taggedTemplateLiteral(["\n  display: flex;\n  justify-content: flex-end;\n  box-sizing: border-box;\n  min-height: var(--avatar-height);\n  width: 77px;\n  margin-left: var(--small-padding);\n\n  &[data-max-avatars='1'] {\n    max-width: 23px;\n  }\n\n  &[data-position='top'] {\n    align-self: flex-start;\n  }\n\n  &[data-position='bottom'] {\n    align-self: flex-end;\n  }\n"])));function FormFieldStatus(_ref216){let{children,maxAvatars,position="bottom"}=_ref216;return/* @__PURE__ */jsx(Root$l,{"data-max-avatars":maxAvatars,"data-position":position,children});}function MissingKeysAlert(props){const{error,onChange}=props;const handleFixMissingKeys=useCallback(()=>{onChange(PatchEvent.from((error.value||[]).map((val,i)=>setIfMissing(randomKey$1(),[i,"_key"]))));},[error.value,onChange]);return/* @__PURE__ */jsx(FormField,{title:error.schemaType.title,description:error.schemaType.description,children:/* @__PURE__ */jsxs(Alert,{status:"warning",suffix:/* @__PURE__ */jsx(Stack,{padding:2,children:/* @__PURE__ */jsx(Button,{onClick:handleFixMissingKeys,text:"Add missing keys",tone:"caution"})}),title:/* @__PURE__ */jsx(Fragment,{children:"Missing keys"}),children:[/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"Some items in the list are missing their keys. This must be fixed in order to edit the list."}),/* @__PURE__ */jsx(Details,{marginTop:4,open:isDev,title:/* @__PURE__ */jsx(Fragment,{children:"Developer info"}),children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["This usually happens when items are created using an API client, and the"," ",/* @__PURE__ */jsx("code",{children:"_key"})," property has not been included."]}),/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["The value of the ",/* @__PURE__ */jsx("code",{children:"_key"})," property must be a unique string."]})]})})]})});}function DuplicateKeysAlert(props){const{error,onChange}=props;const handleFixDuplicateKeys=useCallback(()=>{onChange(PatchEvent.from((error.duplicates||[]).map(_ref217=>{let[index,key]=_ref217;return set("".concat(key,"_deduped_").concat(index),[index,"_key"]);})));},[error.duplicates,onChange]);return/* @__PURE__ */jsx(FormField,{title:error.schemaType.title,description:error.schemaType.description,children:/* @__PURE__ */jsxs(Alert,{status:"warning",suffix:/* @__PURE__ */jsx(Stack,{padding:2,children:/* @__PURE__ */jsx(Button,{onClick:handleFixDuplicateKeys,text:"Generate unique keys",tone:"caution"})}),title:/* @__PURE__ */jsx(Fragment,{children:"Non-unique keys"}),children:[/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"Several items in this list share the same identifier (key). Every item must have an unique identifier."}),/* @__PURE__ */jsx(Details,{marginTop:4,open:isDev,title:/* @__PURE__ */jsx(Fragment,{children:"Developer info"}),children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["This usually happens when items are created using an API client, and the"," ",/* @__PURE__ */jsx("code",{children:"_key"})," property of each elements has been generated non-uniquely."]}),/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["The value of the ",/* @__PURE__ */jsx("code",{children:"_key"})," property must be a unique string."]})]})})]})});}function MemberFieldError(props){const{member}=props;const{onChange}=useFormCallbacks();const handleChange=useCallback(event=>{onChange(PatchEvent.from(event).prefixAll(member.fieldName));},[onChange,member.fieldName]);if(member.error.type==="INCOMPATIBLE_TYPE"){return/* @__PURE__ */jsx(InvalidValueInput,{value:member.error.value,onChange:handleChange,actualType:member.error.resolvedValueType,validTypes:[member.error.expectedSchemaType.name]});}if(member.error.type==="MISSING_KEYS"){return/* @__PURE__ */jsx(MissingKeysAlert,{error:member.error,onChange:handleChange});}if(member.error.type==="DUPLICATE_KEYS"){return/* @__PURE__ */jsx(DuplicateKeysAlert,{error:member.error,onChange:handleChange});}return/* @__PURE__ */jsxs(Box,{children:["Unexpected error: ",props.member.error.type]});}const MemberFieldSet=memo(function MemberFieldSet2(props){var _a;const{member,renderField,renderInput,renderItem,renderPreview}=props;const{onSetFieldSetCollapsed}=useFormCallbacks();const handleCollapse=useCallback(()=>{onSetFieldSetCollapsed(member.fieldSet.path,true);},[member.fieldSet.path,onSetFieldSetCollapsed]);const handleExpand=useCallback(()=>{onSetFieldSetCollapsed(member.fieldSet.path,false);},[member.fieldSet.path,onSetFieldSetCollapsed]);return/* @__PURE__ */jsx(FormFieldSet,{title:member.fieldSet.title,description:member.fieldSet.description,level:member.fieldSet.level,collapsible:member.fieldSet.collapsible,collapsed:member.fieldSet.collapsed,onCollapse:handleCollapse,onExpand:handleExpand,columns:(_a=member==null?void 0:member.fieldSet)==null?void 0:_a.columns,"data-testid":"fieldset-".concat(member.fieldSet.name),children:member.fieldSet.members.map(fieldsetMember=>{if(fieldsetMember.kind==="error"){return/* @__PURE__ */jsx(MemberFieldError,{member:fieldsetMember},member.key);}return/* @__PURE__ */jsx(MemberField,{member:fieldsetMember,renderField,renderInput,renderItem,renderPreview},fieldsetMember.key);})});});const IGNORE_KEYS=["_key","_type","_weak"];function isEmpty$1(value){return Object.keys(value).every(key=>IGNORE_KEYS.includes(key));}function ArrayOfObjectsItem(props){const focusRef=useRef();const{member,renderItem,renderInput,renderField,renderPreview}=props;const{onPathBlur,onPathFocus,onChange,onPathOpen,onSetPathCollapsed,onSetFieldSetCollapsed,onFieldGroupSelect}=useFormCallbacks();useDidUpdate(member.item.focused,(hadFocus,hasFocus)=>{var _a;if(!hadFocus&&hasFocus){(_a=focusRef.current)==null?void 0:_a.focus();}});const onRemove=useCallback(()=>{onChange(PatchEvent.from([unset([{_key:member.key}])]));},[member.key,onChange]);const onInsert=useCallback(event=>{onChange(PatchEvent.from([insert(event.items.map(item=>ensureKey(item)),event.position,[{_key:member.key}])]));},[member.key,onChange]);const handleBlur=useCallback(()=>{onPathBlur(member.item.path);},[member.item.path,onPathBlur]);const handleFocus=useCallback(()=>{onPathFocus(member.item.path);},[member.item.path,onPathFocus]);const handleFocusChildPath=useCallback(path=>{onPathFocus(member.item.path.concat(path));},[member.item.path,onPathFocus]);const handleChange=useCallback(event=>{onChange(PatchEvent.from(event).prepend(setIfMissing(createProtoValue$1(member.item.schemaType))).prefixAll({_key:member.key}));},[onChange,member.item.schemaType,member.key]);const handleCollapse=useCallback(()=>{onSetPathCollapsed(member.item.path,true);},[onSetPathCollapsed,member.item.path]);const handleExpand=useCallback(()=>{onSetPathCollapsed(member.item.path,false);},[onSetPathCollapsed,member.item.path]);const handleCollapseField=useCallback(fieldName=>{onSetPathCollapsed(member.item.path.concat(fieldName),true);},[onSetPathCollapsed,member.item.path]);const handleExpandField=useCallback(fieldName=>{onSetPathCollapsed(member.item.path.concat(fieldName),false);},[onSetPathCollapsed,member.item.path]);const handleCloseField=useCallback(()=>{onPathOpen(member.item.path);},[onPathOpen,member.item.path]);const handleOpenField=useCallback(fieldName=>{onPathOpen(member.item.path.concat(fieldName));},[onPathOpen,member.item.path]);const handleExpandFieldSet=useCallback(fieldsetName=>{onSetFieldSetCollapsed(member.item.path.concat(fieldsetName),false);},[onSetFieldSetCollapsed,member.item.path]);const handleCollapseFieldSet=useCallback(fieldsetName=>{onSetFieldSetCollapsed(member.item.path.concat(fieldsetName),true);},[onSetFieldSetCollapsed,member.item.path]);const handleOpen=useCallback(()=>{onPathOpen(member.item.path);},[onPathOpen,member.item.path]);const isEmptyValue=!member.item.value||isEmpty$1(member.item.value);const handleClose=useCallback(()=>{if(isEmptyValue){onRemove();}onPathOpen(member.item.path.slice(0,-1));},[onPathOpen,member.item.path,isEmptyValue,onRemove]);const handleSelectFieldGroup=useCallback(groupName=>{onFieldGroupSelect(member.item.path,groupName);},[onFieldGroupSelect,member.item.path]);const elementProps=useMemo(()=>({onBlur:handleBlur,onFocus:handleFocus,id:member.item.id,ref:focusRef}),[handleBlur,handleFocus,member.item.id]);const inputProps=useMemo(()=>{return{changed:member.item.changed,focusPath:member.item.focusPath,focused:member.item.focused,groups:member.item.groups,id:member.item.id,level:member.item.level,members:member.item.members,onChange:handleChange,onCloseField:handleCloseField,onCollapseField:handleCollapseField,onCollapseFieldSet:handleCollapseFieldSet,onExpandField:handleExpandField,onExpandFieldSet:handleExpandFieldSet,onFieldGroupSelect:handleSelectFieldGroup,onFocusPath:handleFocusChildPath,onOpenField:handleOpenField,path:member.item.path,presence:member.item.presence,readOnly:member.item.readOnly,renderField,renderInput,renderItem,renderPreview,schemaType:member.item.schemaType,validation:member.item.validation,value:member.item.value,elementProps};},[elementProps,handleChange,handleCloseField,handleCollapseField,handleCollapseFieldSet,handleExpandField,handleExpandFieldSet,handleFocusChildPath,handleOpenField,handleSelectFieldGroup,member.item.changed,member.item.focusPath,member.item.focused,member.item.groups,member.item.id,member.item.level,member.item.members,member.item.path,member.item.presence,member.item.readOnly,member.item.schemaType,member.item.validation,member.item.value,renderField,renderInput,renderItem,renderPreview]);const renderedInput=useMemo(()=>renderInput(inputProps),[inputProps,renderInput]);const itemProps=useMemo(()=>{return{key:member.key,index:member.index,level:member.item.level,value:member.item.value,title:member.item.schemaType.title,description:member.item.schemaType.description,collapsible:member.collapsible,collapsed:member.collapsed,schemaType:member.item.schemaType,onInsert,onRemove,presence:member.item.presence,validation:member.item.validation,open:member.open,onOpen:handleOpen,onClose:handleClose,onExpand:handleExpand,onCollapse:handleCollapse,readOnly:member.item.readOnly,focused:member.item.focused,onFocus:handleFocus,inputId:member.item.id,path:member.item.path,children:renderedInput,changed:member.item.changed};},[member.key,member.index,member.item.level,member.item.value,member.item.schemaType,member.item.presence,member.item.validation,member.item.readOnly,member.item.focused,member.item.id,member.item.path,member.item.changed,member.collapsible,member.collapsed,member.open,onInsert,onRemove,handleOpen,handleClose,handleExpand,handleCollapse,handleFocus,renderedInput]);return/* @__PURE__ */jsx(FormCallbacksProvider,{onFieldGroupSelect,onChange:handleChange,onPathOpen,onSetFieldSetCollapsed,onSetPathCollapsed,onPathBlur,onPathFocus,children:useMemo(()=>renderItem(itemProps),[itemProps,renderItem])});}function getEmptyValue(type){switch(type.jsonType){case"string":{return"";}case"number":{return 0;}case"boolean":{return false;}default:throw new Error("Unable to create value from type \"".concat(type.jsonType,"\""));}}function ArrayOfPrimitivesItem(props){const focusRef=useRef();const{member,renderItem,renderInput}=props;const{onPathBlur,onPathFocus,onChange}=useFormCallbacks();useDidUpdate(member.item.focused,(hadFocus,hasFocus)=>{var _a;if(!hadFocus&&hasFocus){(_a=focusRef.current)==null?void 0:_a.focus();}});const handleBlur=useCallback(event=>{onPathBlur(member.item.path);},[member.item.path,onPathBlur]);const handleFocus=useCallback(event=>{onPathFocus(member.item.path);},[member.item.path,onPathFocus]);const handleChange=useCallback(event=>{const patches=PatchEvent.from(event).patches.map(patch=>patch.path.length===0&&patch.type==="unset"?set(getEmptyValue(member.item.schemaType)):patch);onChange(PatchEvent.from(patches).prefixAll(member.index));},[onChange,member.item.schemaType,member.index]);const handleNativeChange=useCallback(event=>{let inputValue=event.currentTarget.value;if(isNumberSchemaType(member.item.schemaType)){inputValue=event.currentTarget.valueAsNumber;}else if(isBooleanSchemaType(member.item.schemaType)){inputValue=event.currentTarget.checked;}const hasEmptyValue=inputValue===""||typeof inputValue==="number"&&isNaN(inputValue);onChange(PatchEvent.from(hasEmptyValue?unset():set(inputValue)).prefixAll(member.index));},[member.index,member.item.schemaType,onChange]);const elementProps=useMemo(()=>({onBlur:handleBlur,onFocus:handleFocus,id:member.item.id,ref:focusRef,onChange:handleNativeChange,value:String(member.item.value||""),readOnly:Boolean(member.item.readOnly),placeholder:member.item.schemaType.placeholder}),[handleBlur,handleFocus,handleNativeChange,member.item.id,member.item.readOnly,member.item.schemaType.placeholder,member.item.value]);const inputProps=useMemo(()=>{return{changed:member.item.changed,level:member.item.level,value:member.item.value,readOnly:member.item.readOnly,schemaType:member.item.schemaType,id:member.item.id,path:member.item.path,focused:member.item.focused,onChange:handleChange,validation:member.item.validation,presence:member.item.presence,elementProps};},[member.item.changed,member.item.level,member.item.value,member.item.readOnly,member.item.schemaType,member.item.id,member.item.path,member.item.focused,member.item.validation,member.item.presence,handleChange,elementProps]);const renderedInput=useMemo(()=>renderInput(inputProps),[inputProps,renderInput]);const onRemove=useCallback(()=>{onChange(PatchEvent.from([unset([member.index])]));},[member.index,onChange]);const onInsert=useCallback(event=>{onChange(PatchEvent.from([insert(event.items,event.position,[member.index])]));},[member.index,onChange]);const itemProps=useMemo(()=>{return{key:member.key,index:member.index,level:member.item.level,value:member.item.value,title:member.item.schemaType.title,description:member.item.schemaType.description,schemaType:member.item.schemaType,onInsert,onRemove,presence:member.item.presence,validation:member.item.validation,readOnly:member.item.readOnly,focused:member.item.focused,onFocus:handleFocus,inputId:member.item.id,path:member.item.path,children:renderedInput};},[member.key,member.index,member.item.level,member.item.value,member.item.schemaType,member.item.presence,member.item.validation,member.item.readOnly,member.item.focused,member.item.id,member.item.path,onInsert,onRemove,handleFocus,renderedInput]);return/* @__PURE__ */jsx(Fragment,{children:useMemo(()=>renderItem(itemProps),[itemProps,renderItem])});}const PopoverCard=styled(Card)(_templateObject150||(_templateObject150=_taggedTemplateLiteral(["\n  max-width: ","px;\n"])),_ref218=>{let{theme}=_ref218;return theme.sanity.container[1];});function ItemWithMissingType(props){const{value,onFocus,vertical}=props,rest=_objectWithoutProperties(props,_excluded47);const[showDetails,setShowDetails]=React.useState(false);const[popoverRef,setPopoverRef]=React.useState(null);useClickOutside(()=>setShowDetails(false),[popoverRef]);const handleKeyDown=React.useCallback(e=>{if(e.key==="Escape"||e.key==="Tab"){setShowDetails(false);}},[]);const handleShowDetails=useCallback(()=>{setShowDetails(v=>!v);},[]);const typeName=resolveTypeName$1(value);return/* @__PURE__ */jsx(Popover,{open:showDetails,ref:setPopoverRef,onKeyDown:handleKeyDown,portal:true,constrainSize:true,tone:"default",content:/* @__PURE__ */jsx(PopoverCard,{margin:1,padding:3,onKeyDown:handleKeyDown,tabIndex:0,overflow:"auto",children:/* @__PURE__ */jsxs(Stack,{space:4,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{weight:"semibold",children:"Why is this happening?"})}),/* @__PURE__ */jsxs(Text$1,{size:1,children:["The current schema does not declare items of type ",/* @__PURE__ */jsx("code",{children:typeName})," as valid for this list. This could mean that the type has been removed as a valid item type, or that someone else has added it to their own local schema that is not yet deployed."]}),/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsxs(Text$1,{size:1,children:[/* @__PURE__ */jsx(BulbOutlineIcon,{})," You can still move or delete this item, but it cannot be edited since the schema definition for its type is nowhere to be found."]})}),/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:"JSON representation of this item:"}),/* @__PURE__ */jsx(Card,{padding:2,overflow:"auto",border:true,children:/* @__PURE__ */jsx(Code,{size:1,as:"pre",language:"json",children:JSON.stringify(value,null,2)})})]})]})}),children:/* @__PURE__ */jsxs(Card,_objectSpread(_objectSpread({as:"button",type:"button",radius:2,tone:"inherit",padding:2,onFocus,onClick:handleShowDetails,onKeyDown:handleKeyDown},rest),{},{children:[vertical&&/* @__PURE__ */jsxs(Stack,{space:4,children:[/* @__PURE__ */jsx(Text$1,{align:"center",children:/* @__PURE__ */jsx(UnknownIcon,{})}),/* @__PURE__ */jsxs(Text$1,{size:1,align:"center",children:["Item type ",/* @__PURE__ */jsx("code",{children:typeName})," not defined for this list"]})]}),!vertical&&/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Box,{marginRight:3,children:/* @__PURE__ */jsx(Text$1,{children:/* @__PURE__ */jsx(UnknownIcon,{})})}),/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsxs(Text$1,{size:1,textOverflow:"ellipsis",children:["Item type ",/* @__PURE__ */jsx("code",{children:typeName})," not defined for this list"]})})]})]}))});}function MemberItemError(props){const{member}=props;if(member.error.type==="INVALID_ITEM_TYPE"){return/* @__PURE__ */jsx(ItemWithMissingType,{value:member.error.value});}return/* @__PURE__ */jsxs("div",{children:["Unexpected Error: ",member.error.type]});}function ObjectMembers(props){const{members,renderInput,renderField,renderItem,renderPreview}=props;return/* @__PURE__ */jsx(Fragment,{children:members.map(member=>{if(member.kind==="field"){return/* @__PURE__ */jsx(MemberField,{member,renderInput,renderField,renderItem,renderPreview},member.key);}if(member.kind==="error"){return/* @__PURE__ */jsx(MemberFieldError,{member},member.key);}if(member.kind==="fieldSet"){return/* @__PURE__ */jsx(MemberFieldSet,{member,renderInput,renderField,renderItem,renderPreview},member.key);}console.warn(new Error("Unhandled member kind ".concat(member.kind)));return null;})});}const pass=_ref219=>{let{children}=_ref219;return children;};function hasAbsolutePath(a){return"absolutePath"in a;}const FormInput=memo(function FormInput2(props){const absolutePath=useMemo(()=>{return hasAbsolutePath(props)?props.absolutePath:props.path.concat(props.relativePath);},[props]);return/* @__PURE__ */jsx(FormInputInner,_objectSpread(_objectSpread({},props),{},{absolutePath,destinationRenderField:props.renderField,destinationRenderInput:props.renderInput,destinationRenderItem:props.renderItem,destinationRenderPreview:props.renderPreview}));});const FormInputInner=memo(function FormInputInner2(props){const{absolutePath,destinationRenderInput,destinationRenderItem,destinationRenderField,destinationRenderPreview}=props;const renderInput=useCallback(inputProps=>{const isDestinationReached=isEqual$2(inputProps.path,absolutePath)||startsWith(absolutePath,inputProps.path);if(isDestinationReached){return destinationRenderInput(inputProps);}if(!isObjectInputProps$1(inputProps)&&!isArrayInputProps(inputProps)){throw new Error("Expected either object input props or array input props for: ".concat(JSON.stringify(inputProps.path)));}return/* @__PURE__ */jsx(FormInputInner2,_objectSpread(_objectSpread({},inputProps),{},{absolutePath,destinationRenderInput,destinationRenderItem,destinationRenderField,destinationRenderPreview}));},[absolutePath,destinationRenderField,destinationRenderInput,destinationRenderItem,destinationRenderPreview]);const renderField=useCallback(fieldProps=>{const shouldRenderField=startsWith(absolutePath,fieldProps.path)&&(props.includeField||!isEqual$2(absolutePath,fieldProps.path));return shouldRenderField?destinationRenderField(fieldProps):pass(fieldProps);},[absolutePath,destinationRenderField,props.includeField]);if(isArrayInputProps(props)){const childPath=trimLeft(props.path,absolutePath);const itemMember=props.members.find(member=>member.kind=="item"&&isKeySegment(childPath[0])&&member.key===childPath[0]._key);if(!itemMember){const relativePath=trimLeft(props.path,absolutePath);const key=relativePath[0]._key;return/* @__PURE__ */jsxs("div",{children:["No array item with _key ",/* @__PURE__ */jsxs("code",{children:['"',key,'"']})," found at path ",JSON.stringify(props.path)]});}if(itemMember.kind==="error"){return/* @__PURE__ */jsx(MemberItemError,{member:itemMember});}return/* @__PURE__ */jsx(ArrayOfObjectsItem,{member:itemMember,renderInput,renderField,renderItem:pass,renderPreview:destinationRenderPreview});}if(isObjectInputProps$1(props)){const childPath=trimLeft(props.path,absolutePath);const fieldMember=props.members.find(member=>member.kind=="field"&&childPath[0]===member.name);if(!fieldMember){const fieldName=childPath[0];return/* @__PURE__ */jsxs("div",{children:["Field ",JSON.stringify(fieldName)," not found among members \u2013 please verify that it's both defined in the schema and that it has not been conditionally hidden."]});}return/* @__PURE__ */jsx(MemberField,{member:fieldMember,renderInput,renderField,renderItem:pass,renderPreview:destinationRenderPreview});}throw new Error("FormInput can only be used with arrays or objects");});function createInsertCallback(options){const{allowedDecorators,block,onChange}=options;let toInsert;return givenBlock=>{toInsert=Array.isArray(givenBlock)?givenBlock:[givenBlock];toInsert=toInsert.map(blk=>normalizeBlock(blk,{allowedDecorators}));const patches=[insert(toInsert,"after",[{_key:block._key}])];return onChange(patches);};}function createSetCallback(options){const{allowedDecorators,block,onChange}=options;return givenBlock=>{const patches=[set(normalizeBlock(givenBlock,{allowedDecorators}),[{_key:block._key}])];return onChange(patches);};}function createUnsetCallback(options){const{block,onChange}=options;return()=>{const patches=[unset([{_key:block._key}])];return onChange(patches);};}const Root$k=styled.div(_templateObject151||(_templateObject151=_taggedTemplateLiteral(["\n  display: flex;\n  pointer-events: 'all';\n"])));function BlockActions(props){const editor=usePortableTextEditor();const{block,onChange,renderBlockActions}=props;const decoratorValues=useMemo(()=>PortableTextEditor.getPortableTextFeatures(editor).decorators.map(d=>d.value),[editor]);const blockActions=useMemo(()=>{if(renderBlockActions){const blockActionProps={block,value:PortableTextEditor.getValue(editor),set:createSetCallback({allowedDecorators:decoratorValues,block,onChange}),unset:createUnsetCallback({block,onChange}),insert:createInsertCallback({allowedDecorators:decoratorValues,block,onChange})};return renderBlockActions(blockActionProps);}return void 0;},[renderBlockActions,block,editor,onChange,decoratorValues]);const handleClick=useCallback(()=>{PortableTextEditor.blur(editor);},[editor]);if(!blockActions)return null;return/* @__PURE__ */jsx(Root$k,{contentEditable:false,onKeyDown:handleClick,onMouseDown:handleClick,children:blockActions});}const ReviewChangesHighlightBlock=styled.div(_ref220=>{let{theme}=_ref220;const{radius,space,color}=theme.sanity;const bg=rgba(color.spot.yellow,0.2);return css(_templateObject152||(_templateObject152=_taggedTemplateLiteral(["\n    position: absolute;\n    border-radius: ","px;\n    top: -","px;\n    bottom: -","px;\n    left: ","px;\n    right: 0;\n    background-color: ",";\n  "])),radius[3],space[2],space[1]+space[1],space[4]+space[1],bg);});const StyledChangeIndicatorWithProvidedFullPath=styled(ChangeIndicator)(()=>{return css(_templateObject153||(_templateObject153=_taggedTemplateLiteral(["\n    width: 1px;\n    height: 100%;\n\n    & > div {\n      height: 100%;\n    }\n  "])));});function _isBlockType(type){if(type.type){return _isBlockType(type.type);}return type.name==="block";}function _isArrayOfObjectsFieldMember(member){return member.kind==="field"&&member.field.schemaType.jsonType==="array";}const NONEXISTENT_PATH=["@@_NONEXISTENT_PATH_@@"];function useMemberValidation(member){const memberValidation=(member==null?void 0:member.validation)||EMPTY_ARRAY$4;const childValidation=useChildValidation((member==null?void 0:member.path)||NONEXISTENT_PATH);const validation=useMemo(()=>(member==null?void 0:member.schemaType)&&_isBlockType(member==null?void 0:member.schemaType)?memberValidation:memberValidation.concat(childValidation),[childValidation,member,memberValidation]);const[hasError,hasWarning,hasInfo]=useMemo(()=>[validation.filter(v=>v.level==="error").length>0,validation.filter(v=>v.level==="warning").length>0,validation.filter(v=>v.level==="info").length>0],[validation]);return useMemo(()=>{return{validation,hasError,hasWarning,hasInfo};},[validation,hasError,hasWarning,hasInfo]);}const PortableTextMarkersContext=createContext([]);function PortableTextMarkersProvider(props){return/* @__PURE__ */jsx(PortableTextMarkersContext.Provider,{value:props.markers,children:props.children});}function usePortableTextMarkers(path){const ctx=useContext(PortableTextMarkersContext);if(!ctx){throw new Error("Form context not provided");}return ctx.filter(m=>isEqual$2(m.path,path));}const PortableTextMemberItemsContext=createContext([]);function PortableTextMemberItemsProvider(props){return/* @__PURE__ */jsx(PortableTextMemberItemsContext.Provider,{value:props.memberItems,children:props.children});}function usePortableTextMemberItem(key){const ctx=useContext(PortableTextMemberItemsContext);if(!ctx){throw new Error("Form context not provided");}return ctx.find(m=>m.key===key);}function usePortableTextMemberItems(){const ctx=useContext(PortableTextMemberItemsContext);if(!ctx){throw new Error("Form context not provided");}return ctx;}function is(typeName,type){return type.name===typeName||Boolean(type.type&&is(typeName,type.type));}const POPOVER_PROPS={constrainSize:true,placement:"bottom",portal:"default",tone:"default"};function BlockObjectPreview(props){var _a;const{focused,value,type,readOnly,onClickingEdit,onClickingDelete,renderPreview}=props;const{isTopLayer}=useLayer();const editor=usePortableTextEditor();const menuButtonId=useId()||"";const menuButton=useRef(null);const isTabbing=useRef(false);const isCustomPreviewComponent=Boolean((_a=type.preview)==null?void 0:_a.component);const isImageType=is("image",type);const referenceLink=useMemo(()=>forwardRef(function ReferenceLink(linkProps,ref){return/* @__PURE__ */jsx(IntentLink,_objectSpread(_objectSpread({},linkProps),{},{intent:"edit",params:{id:value._ref},ref}));}),[value==null?void 0:value._ref]);useGlobalKeyDown(useCallback(event=>{if(!focused){return;}if(event.key==="Escape"&&isTopLayer){isTabbing.current=false;PortableTextEditor.focus(editor);}if(event.key==="Tab"){if(menuButton.current&&!isTabbing.current){event.preventDefault();event.stopPropagation();menuButton.current.focus();isTabbing.current=true;}}},[focused,isTopLayer,editor]));const actions=/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{"aria-label":"Open menu",fontSize:1,iconRight:EllipsisVerticalIcon,mode:"bleed",paddingX:2}),ref:menuButton,id:menuButtonId,menu:/* @__PURE__ */jsxs(Menu,{children:[(value==null?void 0:value._ref)&&/* @__PURE__ */jsx(MenuItem,{as:referenceLink,"data-as":"a",icon:LinkIcon,text:"Open reference"}),readOnly&&/* @__PURE__ */jsx(MenuItem,{icon:EyeOpenIcon,onClick:onClickingEdit,text:"View"}),!readOnly&&/* @__PURE__ */jsx(MenuItem,{icon:EditIcon,onClick:onClickingEdit,text:"Edit"}),!readOnly&&/* @__PURE__ */jsx(MenuItem,{icon:TrashIcon,onClick:onClickingDelete,text:"Delete",tone:"critical"})]}),popover:POPOVER_PROPS});if(isCustomPreviewComponent){return/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{flex:1,children:renderPreview({layout:isImageType?"blockImage":"block",schemaType:type,value})}),/* @__PURE__ */jsx(Box,{marginLeft:1,children:actions})]});}return/* @__PURE__ */jsx(Fragment,{children:renderPreview({actions,layout:isImageType?"blockImage":"block",schemaType:type,value})});}const Root$j=styled(Card)(props=>{var _a;const{color,radius,space}=props.theme.sanity;const overlay=css(_templateObject154||(_templateObject154=_taggedTemplateLiteral(["\n    pointer-events: none;\n    content: '';\n    position: absolute;\n    top: -","px;\n    bottom: -","px;\n    left: -","px;\n    right: -","px;\n    border-radius: ","px;\n    mix-blend-mode: ",";\n  "])),space[1],space[1],space[1],space[1],radius[2],color.dark?"screen":"multiply");return css(_templateObject155||(_templateObject155=_taggedTemplateLiteral(["\n    box-shadow: 0 0 0 1px var(--card-border-color);\n    border-radius: ","px;\n    pointer-events: all;\n    position: relative;\n\n    &[data-focused] {\n      box-shadow: 0 0 0 1px ",";\n    }\n\n    &:not([data-focused]):not([data-selected]) {\n      @media (hover: hover) {\n        &:hover {\n          --card-border-color: ",";\n        }\n      }\n    }\n\n    &[data-markers] {\n      &:after {\n        ","\n        background-color: ",";\n      }\n    }\n\n    &[data-warning] {\n      &:after {\n        ","\n        background-color: ",";\n      }\n\n      @media (hover: hover) {\n        &:hover {\n          --card-border-color: ",";\n        }\n      }\n    }\n\n    &[data-invalid] {\n      &:after {\n        ","\n        background-color: ",";\n      }\n\n      @media (hover: hover) {\n        &:hover {\n          --card-border-color: ",";\n        }\n      }\n    }\n  "])),radius[1],(_a=color.selectable)==null?void 0:_a.primary.selected.border,color.input.default.hovered.border,overlay,color.dark?hues.purple[950].hex:hues.purple[50].hex,overlay,color.muted.caution.hovered.bg,color.muted.caution.hovered.border,overlay,color.input.invalid.enabled.bg,color.input.invalid.hovered.border);});const PreviewContainer$1=styled(Flex)(_templateObject156||(_templateObject156=_taggedTemplateLiteral(["\n  user-select: none;\n  pointer-events: none;\n"])));const ChangeIndicatorWrapper$1=styled.div(_ref221=>{let{theme,$hasChanges}=_ref221;const{space}=theme.sanity;return css(_templateObject157||(_templateObject157=_taggedTemplateLiteral(["\n      position: absolute;\n      width: ","px;\n      right: 0;\n      top: 0;\n      bottom: 0;\n      padding-left: ","px;\n      user-select: none;\n\n      ","\n\n      [data-dragged] & {\n        visibility: hidden;\n      }\n    "])),space[2],space[1],!$hasChanges&&css(_templateObject158||(_templateObject158=_taggedTemplateLiteral(["\n        display: none;\n      "]))));});const InnerFlex=styled(Flex)(_templateObject159||(_templateObject159=_taggedTemplateLiteral(["\n  position: relative;\n\n  [data-dragged] > & {\n    opacity: 0.5;\n  }\n"])));const BlockActionsOuter$1=styled(Box)(_templateObject160||(_templateObject160=_taggedTemplateLiteral(["\n  width: 25px;\n  position: relative;\n\n  [data-dragged] & {\n    visibility: hidden;\n  }\n"])));const BlockActionsInner$1=styled(Flex)(_templateObject161||(_templateObject161=_taggedTemplateLiteral(["\n  position: absolute;\n  right: 0;\n  [data-dragged] & {\n    visibility: hidden;\n  }\n"])));const TooltipBox$3=styled(Box)(_templateObject162||(_templateObject162=_taggedTemplateLiteral(["\n  max-width: 250px;\n"])));const BlockPreview=styled(Box)(props=>{const color=props.theme.sanity.color.input;return css(_templateObject163||(_templateObject163=_taggedTemplateLiteral(["\n    background-color: ",";\n  "])),color.default.enabled.bg);});function BlockObject(props){const{attributes:{focused,selected,path},block,isFullscreen,onChange,onOpenItem,readOnly,renderBlockActions,renderCustomMarkers,renderPreview,type}=props;const{Markers}=useFormBuilder().__internal.components;const elementRef=useRef(null);const[reviewChangesHovered,setReviewChangesHovered]=useState(false);const markers=usePortableTextMarkers(path);const editor=usePortableTextEditor();const memberItem=usePortableTextMemberItem(pathToString(path));const handleMouseOver=useCallback(()=>setReviewChangesHovered(true),[]);const handleMouseOut=useCallback(()=>setReviewChangesHovered(false),[]);const handleEdit=useCallback(()=>{if(memberItem){onOpenItem(memberItem.node.path);}},[onOpenItem,memberItem]);const handleDoubleClickToOpen=useCallback(e=>{e.preventDefault();e.stopPropagation();PortableTextEditor.blur(editor);handleEdit();},[editor,handleEdit]);const handleDelete=useCallback(e=>{e.stopPropagation();e.preventDefault();const sel={focus:{path,offset:0},anchor:{path,offset:0}};PortableTextEditor.delete(editor,sel,{mode:"blocks"});setTimeout(()=>PortableTextEditor.focus(editor));},[editor,path]);const blockPreview=useMemo(()=>{return/* @__PURE__ */jsx(BlockObjectPreview,{type,focused,value:block,readOnly,onClickingDelete:handleDelete,onClickingEdit:handleEdit,renderPreview});},[focused,type,block,readOnly,handleDelete,handleEdit,renderPreview]);const tone=selected||focused?"primary":"default";const innerPaddingProps=useMemo(()=>{if(isFullscreen&&!renderBlockActions){return{paddingX:5};}if(isFullscreen&&renderBlockActions){return{paddingLeft:5,paddingRight:2};}if(renderBlockActions){return{paddingLeft:3,paddingRight:2};}return{paddingX:3};},[isFullscreen,renderBlockActions]);const{validation,hasError,hasWarning,hasInfo}=useMemberValidation(memberItem==null?void 0:memberItem.node);const hasMarkers=Boolean(markers.length>0);const isImagePreview=(memberItem==null?void 0:memberItem.node.schemaType.name)==="image";const tooltipEnabled=hasError||hasWarning||hasInfo||hasMarkers&&renderCustomMarkers;return/* @__PURE__ */jsx(Flex,{paddingBottom:1,marginY:3,contentEditable:false,children:/* @__PURE__ */jsxs(InnerFlex,{flex:1,children:[/* @__PURE__ */jsx(PreviewContainer$1,_objectSpread(_objectSpread({flex:1},innerPaddingProps),{},{children:/* @__PURE__ */jsx(Tooltip,{placement:"top",portal:"editor",disabled:!tooltipEnabled,content:tooltipEnabled&&/* @__PURE__ */jsx(TooltipBox$3,{padding:2,children:/* @__PURE__ */jsx(Markers,{markers,validation,renderCustomMarkers})}),children:/* @__PURE__ */jsx(Root$j,{"data-focused":focused?"":void 0,"data-image-preview":isImagePreview?"":void 0,"data-invalid":hasError?"":void 0,"data-markers":hasMarkers&&renderCustomMarkers?"":void 0,"data-selected":selected?"":void 0,"data-testid":"pte-block-object","data-warning":hasWarning?"":void 0,flex:1,onDoubleClick:handleDoubleClickToOpen,padding:isImagePreview?0:1,ref:elementRef,tone,children:/* @__PURE__ */jsx(BlockPreview,{ref:memberItem==null?void 0:memberItem.elementRef,children:blockPreview})})})})),/* @__PURE__ */jsx(BlockActionsOuter$1,{marginRight:1,children:/* @__PURE__ */jsx(BlockActionsInner$1,{children:renderBlockActions&&block&&focused&&!readOnly&&/* @__PURE__ */jsx(BlockActions,{onChange,block,renderBlockActions})})}),isFullscreen&&memberItem&&/* @__PURE__ */jsx(ChangeIndicatorWrapper$1,{onMouseOver:handleMouseOver,onMouseOut:handleMouseOut,$hasChanges:memberItem.member.item.changed,children:/* @__PURE__ */jsx(StyledChangeIndicatorWithProvidedFullPath,{withHoverEffect:false,hasFocus:focused,path:memberItem.member.item.path,isChanged:memberItem.member.item.changed})}),reviewChangesHovered&&/* @__PURE__ */jsx(ReviewChangesHighlightBlock,{})]})});}const ToolbarPopover$1=styled(Popover)(_templateObject164||(_templateObject164=_taggedTemplateLiteral(["\n  &[data-popper-reference-hidden='true'] {\n    display: none !important;\n  }\n"])));const POPOVER_FALLBACK_PLACEMENTS$3=["top","bottom"];function InlineObjectToolbarPopover(props){const{open,onEdit,onDelete,referenceElement,scrollElement,setOpen,title}=props;const{sanity}=useTheme$1();const editButtonRef=useRef(null);const popoverScheme=sanity.color.dark?"light":"dark";const isTabbing=useRef(false);useGlobalKeyDown(useCallback(event=>{var _a;if(!open){return;}if(event.key==="Escape"){event.preventDefault();event.stopPropagation();isTabbing.current=false;setOpen(false);}if(event.key==="Tab"){if(!isTabbing.current){event.preventDefault();event.stopPropagation();(_a=editButtonRef.current)==null?void 0:_a.focus();isTabbing.current=true;}}},[open,setOpen]));useEffect(()=>{var _a;if(open&&isTabbing.current){(_a=editButtonRef.current)==null?void 0:_a.focus();}},[open]);return/* @__PURE__ */jsx("div",{contentEditable:false,children:/* @__PURE__ */jsx(ToolbarPopover$1,{boundaryElement:scrollElement,constrainSize:true,content:/* @__PURE__ */jsx(Box,{padding:1,children:/* @__PURE__ */jsxs(Inline,{space:1,children:[/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{weight:"semibold",size:1,children:title})}),/* @__PURE__ */jsx(Button,{icon:EditIcon,mode:"bleed",onClick:onEdit,padding:2,ref:editButtonRef,alt:"Edit object"}),/* @__PURE__ */jsx(Button,{icon:TrashIcon,mode:"bleed",padding:2,onClick:onDelete,tone:"critical",alt:"Remove object"})]})}),fallbackPlacements:POPOVER_FALLBACK_PLACEMENTS$3,open:true,placement:"top",portal:"editor",referenceElement,scheme:popoverScheme})});}function rootStyle(_ref222){let{theme}=_ref222;var _a,_b,_c;const{color,radius}=theme.sanity;return css(_templateObject165||(_templateObject165=_taggedTemplateLiteral(["\n    line-height: 0;\n    border-radius: ","px;\n    padding: 2px;\n    box-shadow: inset 0 0 0 1px var(--card-border-color);\n    height: calc(1em - 1px);\n    margin-top: 0.0625em;\n    cursor: default;\n\n    &:not([hidden]) {\n      display: inline-flex;\n      align-items: center;\n      vertical-align: top;\n    }\n\n    &[data-ready-only] {\n      cursor: default;\n    }\n\n    &[data-focused] {\n      box-shadow: inset 0 0 0 1px ",";\n      color: ",";\n    }\n\n    &[data-selected] {\n      background-color: ",";\n    }\n\n    &:not([data-focused]):not([data-selected]) {\n      @media (hover: hover) {\n        &:hover {\n          --card-border-color: ",";\n        }\n      }\n    }\n\n    &[data-markers] {\n      --card-bg-color: ",";\n    }\n\n    &[data-warning] {\n      --card-bg-color: ",";\n\n      @media (hover: hover) {\n        &:hover {\n          --card-border-color: ",";\n        }\n      }\n    }\n\n    &[data-invalid] {\n      --card-bg-color: ",";\n      --card-border-color: ",";\n\n      @media (hover: hover) {\n        &:hover {\n          --card-border-color: ",";\n        }\n      }\n    }\n  "])),radius[2],(_a=color.selectable)==null?void 0:_a.primary.selected.border,(_b=color.selectable)==null?void 0:_b.primary.pressed.fg,(_c=color.selectable)==null?void 0:_c.primary.pressed.bg,color.input.default.hovered.border,color.dark?hues.purple[950].hex:hues.purple[50].hex,color.muted.caution.hovered.bg,color.muted.caution.hovered.border,color.input.invalid.enabled.bg,color.input.invalid.enabled.border,color.input.invalid.hovered.border);}const Root$i=styled(Card)(rootStyle);const PreviewSpan=styled.span(_templateObject166||(_templateObject166=_taggedTemplateLiteral(["\n  display: block;\n  max-width: calc(5em + 80px);\n  position: relative;\n"])));const TooltipBox$2=styled(Box)(_templateObject167||(_templateObject167=_taggedTemplateLiteral(["\n  max-width: 250px;\n"])));const InlineObject$1=React.forwardRef(function InlineObject2(props,forwardedRef){var _a;const{attributes:{focused,selected,path},onOpenItem,readOnly,renderCustomMarkers,renderPreview,scrollElement,type,value}=props;const{Markers}=useFormBuilder().__internal.components;const editor=usePortableTextEditor();const editorSelection=usePortableTextEditorSelection();const markers=usePortableTextMarkers(path);const memberItem=usePortableTextMemberItem(pathToString(path));const{validation,hasError,hasWarning}=useMemberValidation(memberItem==null?void 0:memberItem.node);const hasValidationMarkers=validation.length>0;const[showPopover,setShowPopover]=useState(false);const tone=useMemo(()=>{if(hasError){return"critical";}if(hasWarning){return"caution";}if(selected||focused){return"primary";}return void 0;},[focused,hasError,hasWarning,selected]);useEffect(()=>{var _a2;if((_a2=memberItem==null?void 0:memberItem.elementRef)==null?void 0:_a2.current){setShowPopover(!readOnly&&focused&&selected);}},[focused,selected,editorSelection,memberItem==null?void 0:memberItem.elementRef,readOnly]);const preview=useMemo(()=>/* @__PURE__ */jsx(PreviewSpan,{children:renderPreview({fallbackTitle:"Click to edit",layout:"inline",schemaType:type,value})}),[renderPreview,type,value]);const markersToolTip=useMemo(()=>markers.length>0||validation.length>0?/* @__PURE__ */jsx(Tooltip,{placement:"bottom",portal:"editor",content:/* @__PURE__ */jsx(TooltipBox$2,{padding:2,children:/* @__PURE__ */jsx(Markers,{markers,validation,renderCustomMarkers})}),children:preview}):void 0,[Markers,markers,validation,preview,renderCustomMarkers]);const handleRemoveClick=useCallback(event=>{event.preventDefault();event.stopPropagation();setShowPopover(false);const point={path,offset:0};const selection={anchor:point,focus:point};PortableTextEditor.delete(editor,selection,{mode:"children"});PortableTextEditor.focus(editor);},[editor,path]);const handleEditClick=useCallback(()=>{setShowPopover(false);PortableTextEditor.blur(editor);if(memberItem){onOpenItem(memberItem.node.path);}},[editor,memberItem,onOpenItem]);return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Root$i,{"data-focused":focused||void 0,"data-invalid":hasError||void 0,"data-warning":hasWarning||void 0,"data-selected":selected||void 0,"data-read-only":readOnly||void 0,"data-markers":hasValidationMarkers||void 0,tone,forwardedAs:"span",contentEditable:false,ref:memberItem==null?void 0:memberItem.elementRef,children:/* @__PURE__ */jsx("span",{ref:forwardedRef,onDoubleClick:handleEditClick,children:markersToolTip||preview})}),showPopover&&/* @__PURE__ */jsx(InlineObjectToolbarPopover,{open:showPopover,setOpen:setShowPopover,onDelete:handleRemoveClick,onEdit:handleEditClick,referenceElement:((_a=memberItem==null?void 0:memberItem.elementRef)==null?void 0:_a.current)||null,scrollElement,title:(type==null?void 0:type.title)||type.name})]});});const ToolbarPopover=styled(Popover)(_templateObject168||(_templateObject168=_taggedTemplateLiteral(["\n  &[data-popper-reference-hidden='true'] {\n    display: none !important;\n  }\n"])));const POPOVER_FALLBACK_PLACEMENTS$2=["top","bottom"];function AnnotationToolbarPopover(props){const{scrollElement,annotationElement,focused,textElement,title,onEdit,onDelete}=props;const[open,setOpen]=useState(false);const[cursorRect,setCursorRect]=useState(null);const[selection,setSelection]=useState(null);const isClosingRef=useRef(false);const rangeRef=useRef(null);const editButtonRef=useRef(null);const isTabbing=useRef(false);const{sanity}=useTheme$1();const editor=usePortableTextEditor();const popoverScheme=sanity.color.dark?"light":"dark";const cursorElement=useMemo(()=>{if(!cursorRect){return null;}return{getBoundingClientRect:()=>{return cursorRect;}};},[cursorRect]);useEffect(()=>{if(!open){return void 0;}const handleScroll=()=>{if(rangeRef.current){setCursorRect(rangeRef.current.getBoundingClientRect());}};scrollElement==null?void 0:scrollElement.addEventListener("scroll",handleScroll,{passive:true});return()=>{scrollElement==null?void 0:scrollElement.removeEventListener("scroll",handleScroll);};},[open,scrollElement]);useGlobalKeyDown(useCallback(event=>{var _a;if(!open){return;}if(event.key==="Escape"){event.preventDefault();event.stopPropagation();setOpen(false);isTabbing.current=false;PortableTextEditor.focus(editor);}if(event.key==="Tab"){if(!isTabbing.current){event.preventDefault();event.stopPropagation();(_a=editButtonRef.current)==null?void 0:_a.focus();isTabbing.current=true;}}},[editor,open]));useEffect(()=>{function handleSelectionChange(){if(!textElement)return;const winSelection=window.getSelection();if(!winSelection){return;}const{anchorNode,anchorOffset,focusNode,focusOffset}=winSelection;setSelection({anchorNode,anchorOffset,focusNode,focusOffset});}document.addEventListener("selectionchange",handleSelectionChange,{passive:true});return()=>{document.removeEventListener("selectionchange",handleSelectionChange);};},[textElement]);useEffect(()=>{var _a;if(!selection)return;if(isClosingRef.current)return;const{anchorNode,focusNode}=selection;if(focused&&isTabbing.current){return;}if(annotationElement&&annotationElement.contains(anchorNode)&&anchorNode===focusNode){const range=(_a=window.getSelection())==null?void 0:_a.getRangeAt(0);const rect=range==null?void 0:range.getBoundingClientRect();rangeRef.current=range||null;if(rect){setCursorRect(rect);}setOpen(true);}else{setOpen(false);setCursorRect(null);rangeRef.current=null;}},[focused,selection,annotationElement]);return/* @__PURE__ */jsx(ToolbarPopover,{boundaryElement:scrollElement,constrainSize:true,content:/* @__PURE__ */jsx(Box,{padding:1,children:/* @__PURE__ */jsxs(Inline,{space:1,children:[/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{weight:"semibold",size:1,children:title})}),/* @__PURE__ */jsx(Button,{ref:editButtonRef,icon:EditIcon,mode:"bleed",onClick:onEdit,padding:2,alt:"Edit annotation"}),/* @__PURE__ */jsx(Button,{icon:TrashIcon,mode:"bleed",padding:2,onClick:onDelete,tone:"critical",alt:"Remove annotation"})]})}),fallbackPlacements:POPOVER_FALLBACK_PLACEMENTS$2,open,placement:"top",portal:"editor",referenceElement:cursorElement,scheme:popoverScheme});}const Root$h=styled.span(props=>{var _a,_b,_c,_d;const{$toneKey="default",theme}=props;return css(_templateObject169||(_templateObject169=_taggedTemplateLiteral(["\n      text-decoration: none;\n      display: inline;\n      background-color: ",";\n      border-bottom: 1px dashed ",";\n      color: ",";\n\n      &[data-link] {\n        border-bottom: 1px solid ",";\n      }\n\n      &[data-custom-markers] {\n        background-color: ",";\n      }\n\n      &[data-warning] {\n        background-color: ",";\n      }\n\n      &[data-error] {\n        background-color: ",";\n      }\n    "])),(_a=theme.sanity.color.selectable)==null?void 0:_a[$toneKey].enabled.bg,(_b=theme.sanity.color.selectable)==null?void 0:_b[$toneKey].enabled.fg,(_c=theme.sanity.color.selectable)==null?void 0:_c[$toneKey].enabled.fg,(_d=theme.sanity.color.selectable)==null?void 0:_d[$toneKey].enabled.fg,theme.sanity.color.dark?hues.purple[950].hex:hues.purple[50].hex,theme.sanity.color.muted.caution.hovered.bg,theme.sanity.color.muted.critical.hovered.bg);});const TooltipBox$1=styled(Box).attrs({forwardedAs:"span"})(_templateObject170||(_templateObject170=_taggedTemplateLiteral(["\n  max-width: 250px;\n"])));const Annotation$1=function Annotation2(props){const{attributes:{focused,path,selected},children,onOpenItem,renderCustomMarkers,scrollElement,readOnly,type,value}=props;const{Markers=DefaultMarkers}=useFormBuilder().__internal.components;const annotationRef=useRef(null);const editor=usePortableTextEditor();const editorSelection=usePortableTextEditorSelection();const markDefPath=useMemo(()=>[path[0]].concat(["markDefs",{_key:value._key}]),[path,value._key]);const[textElement,setTextElement]=useState(null);const memberItem=usePortableTextMemberItem(pathToString(markDefPath));const{validation,hasError,hasWarning}=useMemberValidation(memberItem==null?void 0:memberItem.node);const markers=usePortableTextMarkers(path);const[showPopover,setShowPopover]=useState(false);const text=useMemo(()=>/* @__PURE__ */jsx("span",{ref:setTextElement,"data-annotation":"",children}),[children]);useEffect(()=>{setShowPopover(true);},[editorSelection]);useEffect(()=>{var _a;if((_a=memberItem==null?void 0:memberItem.elementRef)==null?void 0:_a.current){setShowPopover(!readOnly&&focused&&selected);}},[focused,selected,memberItem==null?void 0:memberItem.elementRef,readOnly]);const markersToolTip=useMemo(()=>validation.length>0||markers.length>0?/* @__PURE__ */jsx(Tooltip,{placement:"bottom",portal:"default",content:/* @__PURE__ */jsx(TooltipBox$1,{padding:2,children:/* @__PURE__ */jsx(Markers,{markers,renderCustomMarkers,validation})}),children:/* @__PURE__ */jsx("span",{children:text})}):void 0,[Markers,markers,renderCustomMarkers,text,validation]);const handleEditClick=useCallback(event=>{setShowPopover(false);PortableTextEditor.blur(editor);event.preventDefault();event.stopPropagation();if(memberItem){onOpenItem(memberItem.node.path);}},[editor,memberItem,onOpenItem]);const handleRemoveClick=useCallback(event=>{event.preventDefault();event.stopPropagation();PortableTextEditor.removeAnnotation(editor,type);PortableTextEditor.focus(editor);},[editor,type]);const isLink=type.name==="link";const toneKey=useMemo(()=>{if(hasError){return"critical";}if(hasWarning){return"caution";}if(isLink){return"primary";}return"default";},[isLink,hasError,hasWarning]);const hasCustomMarkers=markers.length>0;return/* @__PURE__ */jsxs(Root$h,{$toneKey:toneKey,ref:annotationRef,"data-link":isLink?"":void 0,"data-error":hasError?"":void 0,"data-warning":hasWarning?"":void 0,"data-custom-markers":hasCustomMarkers?"":void 0,children:[/* @__PURE__ */jsx("span",{ref:memberItem==null?void 0:memberItem.elementRef,children:markersToolTip||text}),showPopover&&/* @__PURE__ */jsx(AnnotationToolbarPopover,{focused,textElement,annotationElement:annotationRef==null?void 0:annotationRef.current,scrollElement,onEdit:handleEditClick,onDelete:handleRemoveClick,title:(type==null?void 0:type.title)||type.name})]});};const TEXT_LEVELS=[1,2,3,4,5,6,7,8,9];const TEXT_BULLET_MARKERS=["\u25CF","\u25CB","\u25A0"];const TEXT_NUMBER_FORMATS=["number","lower-alpha","lower-roman"];const TEXT_DECORATOR_TAGS={em:"em","strike-through":"s",underline:"u",strong:"strong",code:"code"};const TEXT_STYLE_PADDING={h1:{paddingTop:5,paddingBottom:4},h2:{paddingTop:4,paddingBottom:4},h3:{paddingTop:4,paddingBottom:3},h4:{paddingTop:4,paddingBottom:3},h5:{paddingTop:4,paddingBottom:3},h6:{paddingTop:4,paddingBottom:2},normal:{paddingTop:2,paddingBottom:3},blockquote:{paddingTop:2,paddingBottom:3}};const Root$g=styled.span(_templateObject171||(_templateObject171=_taggedTemplateLiteral(["\n  /* Make sure the annotation styling is visible */\n  &[data-mark='code'] {\n    mix-blend-mode: multiply;\n    color: inherit;\n  }\n"])));function Decorator$1(props){const{mark,children}=props;const tag=TEXT_DECORATOR_TAGS[mark];return/* @__PURE__ */jsx(Root$g,{as:tag,"data-mark":mark,children});}function createListName(level){return"list-level-".concat(level);}function textBlockStyle(props){var _a;const{$level,theme}=props;const{color,fonts,radius,space}=theme.sanity;const numberMarker=TEXT_NUMBER_FORMATS[($level-1)%TEXT_NUMBER_FORMATS.length];const bulletMarker=TEXT_BULLET_MARKERS[($level-1)%TEXT_BULLET_MARKERS.length];return css(_templateObject172||(_templateObject172=_taggedTemplateLiteral(["\n    --marker-bg-color: transparent;\n\n    mix-blend-mode: ",";\n    position: relative;\n\n    & > [data-ui='TextBlock_inner'] {\n      position: relative;\n      flex: 1;\n    }\n\n    & > div:before {\n      content: '';\n      position: absolute;\n      top: -","px;\n      bottom: -","px;\n      left: -","px;\n      right: -","px;\n      border-radius: ","px;\n      background-color: var(--marker-bg-color);\n    }\n\n    &[data-custom-markers] {\n      --marker-bg-color: ",";\n    }\n\n    &[data-warning] {\n      --card-border-color: ",";\n      --marker-bg-color: ",";\n    }\n\n    &[data-error] {\n      --card-border-color: ",";\n      --marker-bg-color: ",";\n    }\n\n    & [data-list-prefix] {\n      position: absolute;\n      margin-left: -4.5rem;\n      width: 3.75rem;\n      text-align: right;\n      box-sizing: border-box;\n    }\n\n    &[data-list-item='number'] [data-list-prefix] {\n      font-variant-numeric: tabular-nums;\n\n      & > span:before {\n        content: counter(",") '.';\n        content: counter(",", ",") '.';\n      }\n    }\n\n    &[data-list-item='bullet'] [data-list-prefix] {\n      & > span {\n        position: relative;\n        top: -0.1875em;\n\n        &:before {\n          content: '","';\n          font-size: 0.46666em;\n        }\n      }\n    }\n\n    & [data-text] {\n      overflow-wrap: anywhere;\n      text-transform: none;\n      white-space: pre-wrap;\n      font-family: ",";\n      flex: 1;\n\n      *::selection {\n        background-color: ",";\n      }\n    }\n  "])),color.dark?"screen":"multiply",space[1],space[1],space[1],space[1],radius[2],color.dark?hues.purple[950].hex:hues.purple[50].hex,color.muted.caution.enabled.border,color.muted.caution.hovered.bg,color.muted.critical.enabled.border,color.muted.critical.hovered.bg,createListName($level),createListName($level),numberMarker,bulletMarker,fonts.text.family,(_a=color.selectable)==null?void 0:_a.primary.pressed.bg);}const TextRoot=styled.div(textBlockStyle);const TextBlockFlexWrapper=styled(Flex)(_templateObject173||(_templateObject173=_taggedTemplateLiteral(["\n  position: relative;\n"])));const ListPrefixWrapper=styled.div(_templateObject174||(_templateObject174=_taggedTemplateLiteral(["\n  user-select: none;\n  white-space: nowrap;\n"])));const BlockExtrasContainer=styled(Box)(_templateObject175||(_templateObject175=_taggedTemplateLiteral(["\n  user-select: none;\n"])));const BlockActionsOuter=styled(Box)(_templateObject176||(_templateObject176=_taggedTemplateLiteral(["\n  line-height: 0;\n  width: 25px;\n  position: relative;\n"])));const BlockActionsInner=styled(Flex)(_ref223=>{let{theme}=_ref223;const{fonts,space}=theme.sanity;const textSize1=fonts.text.sizes[1];const textSize2=fonts.text.sizes[2];const capHeight1=textSize1.lineHeight-textSize1.ascenderHeight-textSize1.descenderHeight;const capHeight2=textSize2.lineHeight-textSize2.ascenderHeight-textSize2.descenderHeight;const buttonHeight=capHeight1+space[2]+space[2];const negativeTop=0-(buttonHeight-capHeight2)/2;return css(_templateObject177||(_templateObject177=_taggedTemplateLiteral(["\n    user-select: none;\n    position: absolute;\n    right: 0;\n    top: ","px;\n  "])),negativeTop);});const TooltipBox=styled(Box)(_templateObject178||(_templateObject178=_taggedTemplateLiteral(["\n  max-width: 250px;\n"])));const TextFlex=styled(Flex)(_templateObject179||(_templateObject179=_taggedTemplateLiteral(["\n  position: relative;\n  padding-left: ","px;\n"])),_ref224=>{let{$level}=_ref224;return $level?$level*32:0;});const ChangeIndicatorWrapper=styled.div(_ref225=>{let{theme,$hasChanges}=_ref225;const{space}=theme.sanity;return css(_templateObject180||(_templateObject180=_taggedTemplateLiteral(["\n      position: absolute;\n      width: ","px;\n      right: 0;\n      top: 0;\n      bottom: 0;\n      padding-left: ","px;\n      user-select: none;\n\n      ","\n    "])),space[2],space[1],!$hasChanges&&css(_templateObject181||(_templateObject181=_taggedTemplateLiteral(["\n        display: none;\n      "]))));});const TextContainer=styled.div(_templateObject182||(_templateObject182=_taggedTemplateLiteral(["\n  display: block;\n"])));const Normal=_ref226=>{let{children}=_ref226,rest=_objectWithoutProperties(_ref226,_excluded48);return/* @__PURE__ */jsx(Text$1,_objectSpread(_objectSpread({"data-testid":"text-style--normal"},rest),{},{children:/* @__PURE__ */jsx(TextContainer,{children})}));};const Heading1=_ref227=>{let{children}=_ref227,rest=_objectWithoutProperties(_ref227,_excluded49);return/* @__PURE__ */jsx(Heading,_objectSpread(_objectSpread({as:"h1","data-testid":"text-style--h1",size:5},rest),{},{children:/* @__PURE__ */jsx(TextContainer,{children})}));};const Heading2=_ref228=>{let{children}=_ref228,rest=_objectWithoutProperties(_ref228,_excluded50);return/* @__PURE__ */jsx(Heading,_objectSpread(_objectSpread({as:"h2","data-testid":"text-style--h2",size:4},rest),{},{children:/* @__PURE__ */jsx(TextContainer,{children})}));};const Heading3=_ref229=>{let{children}=_ref229,rest=_objectWithoutProperties(_ref229,_excluded51);return/* @__PURE__ */jsx(Heading,_objectSpread(_objectSpread({as:"h3","data-testid":"text-style--h3",size:3},rest),{},{children:/* @__PURE__ */jsx(TextContainer,{children})}));};const Heading4=_ref230=>{let{children}=_ref230,rest=_objectWithoutProperties(_ref230,_excluded52);return/* @__PURE__ */jsx(Heading,_objectSpread(_objectSpread({as:"h4","data-testid":"text-style--h4",size:2},rest),{},{children:/* @__PURE__ */jsx(TextContainer,{children})}));};const Heading5=_ref231=>{let{children}=_ref231,rest=_objectWithoutProperties(_ref231,_excluded53);return/* @__PURE__ */jsx(Heading,_objectSpread(_objectSpread({as:"h5","data-testid":"text-style--h5",size:1},rest),{},{children:/* @__PURE__ */jsx(TextContainer,{children})}));};const Heading6=_ref232=>{let{children}=_ref232,rest=_objectWithoutProperties(_ref232,_excluded54);return/* @__PURE__ */jsx(Heading,_objectSpread(_objectSpread({as:"h6","data-testid":"text-style--h6",size:0},rest),{},{children:/* @__PURE__ */jsx(TextContainer,{children})}));};const BlockQuoteRoot=styled.blockquote(_templateObject183||(_templateObject183=_taggedTemplateLiteral(["\n  position: relative;\n  display: block;\n  margin: 0;\n  padding-left: ","px;\n\n  &::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: -4px;\n    bottom: -4px;\n    width: 3px;\n    background: var(--card-border-color);\n  }\n"])),_ref233=>{let{theme}=_ref233;return theme.sanity.space[3];});const BlockQuote=_ref234=>{let{children}=_ref234,rest=_objectWithoutProperties(_ref234,_excluded55);return/* @__PURE__ */jsx(BlockQuoteRoot,_objectSpread(_objectSpread({"data-testid":"text-style--blockquote"},rest),{},{children:/* @__PURE__ */jsx(Text$1,{as:"p",children})}));};const TEXT_STYLES={normal:Normal,h1:Heading1,h2:Heading2,h3:Heading3,h4:Heading4,h5:Heading5,h6:Heading6,blockquote:BlockQuote};function TextBlock(props){const{attributes:{path,focused},block,children,isFullscreen,onChange,readOnly,renderBlockActions,renderCustomMarkers,spellCheck}=props;const{Markers}=useFormBuilder().__internal.components;const[reviewChangesHovered,setReviewChangesHovered]=useState(false);const markers=usePortableTextMarkers(path);const memberItem=usePortableTextMemberItem(pathToString(path));const handleChangeIndicatorMouseEnter=useCallback(()=>setReviewChangesHovered(true),[]);const handleChangeIndicatorMouseLeave=useCallback(()=>setReviewChangesHovered(false),[]);const{validation,hasError,hasWarning,hasInfo}=useMemberValidation(memberItem==null?void 0:memberItem.node);const hasMarkers=Boolean(renderCustomMarkers)&&markers.length>0;const tooltipEnabled=hasError||hasWarning||hasMarkers||hasInfo;const text=useMemo(()=>{const TextStyle=TEXT_STYLES[block.style]||TEXT_STYLES.normal;return/* @__PURE__ */jsxs(TextFlex,{align:"flex-start",$level:block==null?void 0:block.level,children:[block.listItem&&/* @__PURE__ */jsx(ListPrefixWrapper,{contentEditable:false,children:/* @__PURE__ */jsx(TextStyle,{"data-list-prefix":""})}),/* @__PURE__ */jsx(TextStyle,{"data-text":"",style:void 0,children})]});},[block.style,block.listItem,block.level,children]);const innerPaddingProps=useMemo(()=>{if(isFullscreen&&!renderBlockActions){return{paddingX:5};}if(isFullscreen&&renderBlockActions){return{paddingLeft:5,paddingRight:2};}if(renderBlockActions){return{paddingLeft:3,paddingRight:2};}return{paddingX:3};},[isFullscreen,renderBlockActions]);const outerPaddingProps=useMemo(()=>{if(block.listItem){return{paddingY:2};}return TEXT_STYLE_PADDING[block.style]||{paddingY:2};},[block]);return/* @__PURE__ */jsx(Box,_objectSpread(_objectSpread({"data-testid":"text-block"},outerPaddingProps),{},{children:/* @__PURE__ */jsx(TextBlockFlexWrapper,{"data-testid":"text-block__wrapper",children:/* @__PURE__ */jsxs(Flex,_objectSpread(_objectSpread({flex:1},innerPaddingProps),{},{ref:memberItem==null?void 0:memberItem.elementRef,children:[/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(Tooltip,{placement:"top",portal:"editor",disabled:!tooltipEnabled,content:tooltipEnabled&&/* @__PURE__ */jsx(TooltipBox,{padding:2,children:/* @__PURE__ */jsx(Markers,{markers,validation,renderCustomMarkers})}),children:/* @__PURE__ */jsx(TextRoot,{$level:block.level,"data-error":hasError?"":void 0,"data-warning":hasWarning?"":void 0,"data-list-item":block.listItem,"data-custom-markers":hasMarkers?"":void 0,"data-testid":"text-block__text",spellCheck,children:text})})}),/* @__PURE__ */jsxs(BlockExtrasContainer,{contentEditable:false,children:[/* @__PURE__ */jsx(BlockActionsOuter,{marginRight:1,children:/* @__PURE__ */jsx(BlockActionsInner,{children:renderBlockActions&&focused&&!readOnly&&/* @__PURE__ */jsx(BlockActions,{onChange,block,renderBlockActions})})}),isFullscreen&&memberItem&&/* @__PURE__ */jsx(ChangeIndicatorWrapper,{$hasChanges:memberItem.member.item.changed,onMouseEnter:handleChangeIndicatorMouseEnter,onMouseLeave:handleChangeIndicatorMouseLeave,children:/* @__PURE__ */jsx(StyledChangeIndicatorWithProvidedFullPath,{hasFocus:focused,isChanged:memberItem.member.item.changed,path:memberItem.member.item.path,withHoverEffect:false})})]}),reviewChangesHovered&&/* @__PURE__ */jsx(ReviewChangesHighlightBlock,{})]}))})}));}const CustomIconDiv=styled.div(_templateObject184||(_templateObject184=_taggedTemplateLiteral(["\n  width: 1em;\n  height: 1em;\n  border-radius: inherit;\n  background-origin: content-box;\n  background-position: center;\n  background-repeat: no-repeat;\n  background-size: cover;\n  transform: scale(0.7);\n"])));function CustomIcon(props){const{icon,active}=props;const inlineStyle=useMemo(()=>({backgroundImage:"url(".concat(icon,")"),filter:active?"invert(100%)":"invert(0%)"}),[active,icon]);return/* @__PURE__ */jsx(CustomIconDiv,{style:inlineStyle});}function getPTEFormatActions(editor,disabled,hotkeyOpts){const features=PortableTextEditor.getPortableTextFeatures(editor);return features.decorators.map(decorator=>{var _a;const shortCutKey=Object.keys(hotkeyOpts.marks||{}).find(key=>{var _a2;return((_a2=hotkeyOpts.marks)==null?void 0:_a2[key])===decorator.value;});let hotkeys=[];if(shortCutKey){hotkeys=[shortCutKey];}return{type:"format",disabled,icon:(_a=decorator.blockEditor)==null?void 0:_a.icon,key:decorator.value,handle:()=>{PortableTextEditor.toggleMark(editor,decorator.value);PortableTextEditor.focus(editor);},hotkeys,title:decorator.title};});}function getPTEListActions(editor,disabled){const features=PortableTextEditor.getPortableTextFeatures(editor);return features.lists.map(listItem=>{var _a;return{type:"listStyle",key:listItem.value,disabled,icon:(_a=listItem.blockEditor)==null?void 0:_a.icon,handle:()=>{PortableTextEditor.toggleList(editor,listItem.value);},title:listItem.title};});}function getAnnotationIcon(item){return get$2(item,"icon")||get$2(item,"blockEditor.icon")||get$2(item,"type.icon")||get$2(item,"type.to.icon")||get$2(item,"type.to[0].icon");}function getPTEAnnotationActions(editor,disabled,onInsert){const features=PortableTextEditor.getPortableTextFeatures(editor);const focusChild=PortableTextEditor.focusChild(editor);const hasText=focusChild&&focusChild.text;return features.annotations.map(item=>{return{type:"annotation",disabled:!hasText||disabled,icon:getAnnotationIcon(item),key:item.value,handle:active=>{if(active){PortableTextEditor.removeAnnotation(editor,item.type);PortableTextEditor.focus(editor);}else{onInsert(item.type);}},title:item.title};});}function getPTEToolbarActionGroups(editor,disabled,onInsertAnnotation,hotkeyOpts){return[{name:"format",actions:getPTEFormatActions(editor,disabled,hotkeyOpts)},{name:"list",actions:getPTEListActions(editor,disabled)},{name:"annotation",actions:getPTEAnnotationActions(editor,disabled,onInsertAnnotation)}];}function getBlockStyles(features){return features.styles.map(style=>{return{key:"style-".concat(style.value),style:style.value,styleComponent:style&&style.blockEditor&&style.blockEditor.render,title:style.title};});}function getInsertMenuIcon(type,fallbackIcon){const referenceIcon=get$2(type,"to[0].icon");return type.icon||type.type&&type.type.icon||referenceIcon||fallbackIcon;}function getInsertMenuItems(features,disabled,onInsertBlock,onInsertInline){const blockItems=features.types.blockObjects.map((type,index)=>({handle:()=>onInsertBlock(type),icon:getInsertMenuIcon(type,BlockElementIcon),inline:false,key:"block-".concat(index),type}));const inlineItems=features.types.inlineObjects.map((type,index)=>({handle:()=>onInsertInline(type),icon:getInsertMenuIcon(type,InlineElementIcon),inline:true,key:"inline-".concat(index),type}));const filteredBlockItems=blockItems.concat(inlineItems).filter(item=>{var _a;return!((_a=item.type)==null?void 0:_a.hidden);});return filteredBlockItems;}const annotationIcons={link:LinkIcon};const formatIcons={strong:BoldIcon,em:ItalicIcon,"strike-through":StrikethroughIcon,underline:UnderlineIcon,code:CodeIcon};const listStyleIcons={number:OlistIcon,bullet:UlistIcon};function getActionIcon(action,active){if(action.icon){if(typeof action.icon==="string"){return/* @__PURE__ */jsx(CustomIcon,{active,icon:action.icon});}return action.icon;}if(action.type==="annotation"){return annotationIcons[action.key]||UnknownIcon;}if(action.type==="listStyle"){return listStyleIcons[action.key]||UnknownIcon;}return formatIcons[action.key]||UnknownIcon;}function useFocusBlock(){const editor=usePortableTextEditor();const selection=usePortableTextEditorSelection();return useMemo(()=>PortableTextEditor.focusBlock(editor),[editor,selection]);}function useFeatures(){const editor=usePortableTextEditor();return useMemo(()=>PortableTextEditor.getPortableTextFeatures(editor),[editor]);}function useActionGroups(_ref235){let{hotkeys,onExpand,resolveInitialValue,disabled}=_ref235;const editor=usePortableTextEditor();const handleInsertAnnotation=useCallback(async type=>{const initialValue=await resolveInitialValue(type);const paths=PortableTextEditor.addAnnotation(editor,type,initialValue);if(paths&&paths.markDefPath){PortableTextEditor.blur(editor);onExpand(paths.markDefPath);}},[editor,onExpand,resolveInitialValue]);return useMemo(()=>editor?getPTEToolbarActionGroups(editor,disabled,handleInsertAnnotation,hotkeys):[],[disabled,editor,handleInsertAnnotation,hotkeys]);}function useActiveActionKeys(_ref236){let{actions}=_ref236;const editor=usePortableTextEditor();const selection=usePortableTextEditorSelection();return useUnique(useMemo(()=>{const activeAnnotationKeys=PortableTextEditor.activeAnnotations(editor).map(a=>a._type);return actions.filter(a=>{if(a.type==="annotation"){return activeAnnotationKeys.includes(a.key);}if(a.type==="listStyle"){return PortableTextEditor.hasListStyle(editor,a.key);}return PortableTextEditor.isMarkActive(editor,a.key);}).map(a=>a.key);},[editor,selection]));}function useActiveStyleKeys(_ref237){let{items}=_ref237;const editor=usePortableTextEditor();const focusBlock=useFocusBlock();const selection=usePortableTextEditorSelection();return useUnique(useMemo(()=>items.filter(i=>PortableTextEditor.hasBlockStyle(editor,i.style)).map(i=>i.style),[focusBlock,selection]));}const CollapseMenuMemo$1=memo(CollapseMenu);const MENU_POPOVER_PROPS$4={constrainSize:true,portal:true};const COLLAPSE_BUTTON_PROPS={padding:2,mode:"bleed"};const ActionMenu=memo(function ActionMenu2(props){const{disabled:disabledProp,groups,isFullscreen,collapsed}=props;const focusBlock=useFocusBlock();const features=useFeatures();const editor=usePortableTextEditor();const isVoidBlock=(focusBlock==null?void 0:focusBlock._type)!==features.types.block.name;const isEmptyTextBlock=!isVoidBlock&&(focusBlock==null?void 0:focusBlock.children.length)===1&&(focusBlock==null?void 0:focusBlock.children[0].text)==="";const disabled=disabledProp||isVoidBlock;const actions=useMemo(()=>groups.reduce((acc,group)=>{return acc.concat(group.actions.map((action,actionIndex)=>{if(actionIndex===0)return _objectSpread(_objectSpread({},action),{},{firstInGroup:true});return action;}));},[]),[groups]);const activeKeys=useActiveActionKeys({actions});const handleMenuClose=useCallback(()=>{PortableTextEditor.focus(editor);},[editor]);const children=useMemo(()=>actions.map(action=>{const annotationDisabled=action.type==="annotation"&&isEmptyTextBlock;const active=activeKeys.includes(action.key);return/* @__PURE__ */createElement(CollapseMenuButton,_objectSpread(_objectSpread({disabled:disabled||annotationDisabled},COLLAPSE_BUTTON_PROPS),{},{dividerBefore:action.firstInGroup,icon:getActionIcon(action,active),key:action.key,onClick:()=>action.handle(active),selected:active,text:action.title||action.key,tooltipText:action.title||action.key,tooltipProps:{disabled:disabled||annotationDisabled,placement:isFullscreen?"bottom":"top",portal:"default"}}));}),[actions,activeKeys,disabled,isEmptyTextBlock,isFullscreen]);const menuButtonProps=useMemo(()=>({button:/* @__PURE__ */jsx(Button,{icon:EllipsisVerticalIcon,mode:"bleed",padding:2,disabled}),popover:MENU_POPOVER_PROPS$4}),[disabled]);return/* @__PURE__ */jsx(CollapseMenuMemo$1,{collapsed,disableRestoreFocusOnClose:true,gap:1,menuButtonProps,onMenuClose:handleMenuClose,children});});const MenuButtonMemo=memo(MenuButton);const StyledMenuItem=styled(MenuItem)(_templateObject185||(_templateObject185=_taggedTemplateLiteral(["\n  // Change the border color variable used by BlockQuote\n  // to make the border visible when the MenuItem is selected\n  &[data-selected] {\n    [data-option='blockquote'] {\n      --card-border-color: var(--card-muted-fg-color);\n    }\n  }\n"])));const StyledButton=styled(Button)(_templateObject186||(_templateObject186=_taggedTemplateLiteral(["\n  width: 100%;\n"])));const MENU_POPOVER_PROPS$3={constrainSize:true,placement:"bottom-start",portal:"default"};const TEXT_STYLE_OPTIONS={h1:title=>/* @__PURE__ */jsx(Heading1,{children:title}),h2:title=>/* @__PURE__ */jsx(Heading2,{children:title}),h3:title=>/* @__PURE__ */jsx(Heading3,{children:title}),h4:title=>/* @__PURE__ */jsx(Heading4,{children:title}),h5:title=>/* @__PURE__ */jsx(Heading5,{children:title}),h6:title=>/* @__PURE__ */jsx(Heading6,{children:title}),normal:title=>/* @__PURE__ */jsx(Normal,{children:title}),blockquote:title=>/* @__PURE__ */jsx(BlockQuote,{"data-option":"blockquote",children:title})};const TEXT_STYLE_KEYS=Object.keys(TEXT_STYLE_OPTIONS);const preventDefault$1=event=>event.preventDefault();const emptyStyle={key:"style-none",style:"",title:"No style"};const BlockStyleSelect=memo(function BlockStyleSelect2(props){const{disabled,items:itemsProp}=props;const editor=usePortableTextEditor();const features=useFeatures();const focusBlock=useFocusBlock();const[changed,setChanged]=useState(false);const _disabled=disabled||(focusBlock?features.types.block.name!==focusBlock._type:false);const activeKeys=useActiveStyleKeys({items:itemsProp});const{activeItems,items}=useMemo(()=>{const _activeItems=itemsProp.filter(item=>activeKeys.includes(item.style));let _items=itemsProp;if(_activeItems.length===0&&_items.length>1){_items=_items.concat([emptyStyle]);_activeItems.push(emptyStyle);}return{activeItems:_activeItems,items:_items};},[activeKeys,itemsProp]);const menuButtonText=useMemo(()=>{if(activeItems.length>1)return"Multiple";if(activeItems.length===1)return activeItems[0].title;return emptyStyle.title;},[activeItems]);const handleChange=useCallback(item=>{if(focusBlock&&item.style!==focusBlock.style){PortableTextEditor.toggleBlockStyle(editor,item.style);}setChanged(true);},[editor,focusBlock]);const renderOption=useCallback((style,title)=>{const hasTextStyle=TEXT_STYLE_KEYS.includes(style);const renderStyle=TEXT_STYLE_OPTIONS[style];if(hasTextStyle){return renderStyle(title);}return/* @__PURE__ */jsx(Text$1,{children:title});},[]);const button=useMemo(()=>/* @__PURE__ */jsx(StyledButton,{disabled:_disabled,iconRight:SelectIcon,mode:"bleed",onClick:preventDefault$1,padding:2,text:menuButtonText}),[_disabled,menuButtonText]);const menu=useMemo(()=>/* @__PURE__ */jsx(Menu,{disabled:_disabled,children:items.map(item=>{return/* @__PURE__ */jsx(StyledMenuItem,{pressed:activeItems.includes(item),onClick:_disabled?void 0:()=>handleChange(item),children:renderOption(item.style,(item==null?void 0:item.title)||item.style)},item.key);})}),[_disabled,activeItems,handleChange,items,renderOption]);useEffect(()=>{if(changed){PortableTextEditor.focus(editor);setChanged(false);}},[activeItems,changed,editor]);return/* @__PURE__ */jsx(MenuButtonMemo,{popover:MENU_POPOVER_PROPS$3,id:"block-style-select",button,menu});});const CollapseMenuMemo=memo(CollapseMenu);const MENU_POPOVER_PROPS$2={constrainSize:true,portal:true};const InsertMenu$1=memo(function InsertMenu2(props){const{disabled,items,isFullscreen,collapsed}=props;const features=useFeatures();const focusBlock=useFocusBlock();const editor=usePortableTextEditor();const isVoidFocus=focusBlock&&focusBlock._type!==features.types.block.name;const handleMenuClose=useCallback(()=>{PortableTextEditor.focus(editor);},[editor]);const children=useMemo(()=>{return items.map(item=>{var _a;const title=item.type.title||((_a=item.type.type)==null?void 0:_a.name);return/* @__PURE__ */jsx(CollapseMenuButton,{"aria-label":"Insert ".concat(title).concat(item.inline?" (inline)":" (block)"),padding:2,mode:"bleed",disabled:disabled||isVoidFocus&&item.inline===true,icon:item.icon,onClick:item.handle,text:title,tooltipText:"Insert ".concat(title),tooltipProps:{disabled,placement:isFullscreen?"bottom":"top",portal:"default"}},item.key);});},[items,disabled,isVoidFocus,isFullscreen]);const menuButtonProps=useMemo(()=>({button:/* @__PURE__ */jsx(Button,{icon:AddIcon,mode:"bleed",padding:2,disabled}),popover:MENU_POPOVER_PROPS$2}),[disabled]);return/* @__PURE__ */jsx(CollapseMenuMemo,{collapsed,collapseText:false,disableRestoreFocusOnClose:true,gap:1,menuButtonProps,onMenuClose:handleMenuClose,children});});const RootFlex$1=styled(Flex)(_templateObject187||(_templateObject187=_taggedTemplateLiteral(["\n  width: 100%;\n"])));const StyleSelectBox=styled(Box)(_templateObject188||(_templateObject188=_taggedTemplateLiteral(["\n  width: 8em;\n"])));const StyleSelectFlex=styled(Flex)(_templateObject189||(_templateObject189=_taggedTemplateLiteral(["\n  border-right: 1px solid var(--card-border-color);\n"])));const ActionMenuBox=styled(Box)(_templateObject190||(_templateObject190=_taggedTemplateLiteral(["\n  ","\n"])),_ref238=>{let{$withInsertMenu}=_ref238;return $withInsertMenu&&css(_templateObject191||(_templateObject191=_taggedTemplateLiteral(["\n      max-width: max-content;\n      border-right: 1px solid var(--card-border-color);\n    "])));});const FullscreenButtonBox=styled(Box)(_templateObject192||(_templateObject192=_taggedTemplateLiteral(["\n  border-left: 1px solid var(--card-border-color);\n"])));const SLOW_INITIAL_VALUE_LIMIT=300;const IS_MAC=typeof window!="undefined"&&/Mac|iPod|iPhone|iPad/.test(window.navigator.platform);const InnerToolbar=memo(function InnerToolbar2(_ref239){let{actionGroups,blockStyles,disabled,insertMenuItems,isFullscreen,onToggleFullscreen}=_ref239;const actionsLen=actionGroups.reduce((acc,x)=>acc+x.actions.length,0);const showActionMenu=actionsLen>0;const showInsertMenu=insertMenuItems.length>0;const[rootElement,setRootElement]=useState(null);const rootElementRect=useElementRect(rootElement);const collapsed=rootElementRect?(rootElementRect==null?void 0:rootElementRect.width)<400:false;useRovingFocus({rootElement});return/* @__PURE__ */jsxs(RootFlex$1,{align:"center",ref:setRootElement,children:[/* @__PURE__ */jsx(StyleSelectFlex,{flex:collapsed?1:void 0,children:/* @__PURE__ */jsx(StyleSelectBox,{padding:isFullscreen?2:1,children:/* @__PURE__ */jsx(BlockStyleSelect,{disabled,items:blockStyles})})}),/* @__PURE__ */jsxs(Flex,{flex:1,children:[showActionMenu&&/* @__PURE__ */jsx(ActionMenuBox,{flex:collapsed?void 0:1,padding:isFullscreen?2:1,$withInsertMenu:showInsertMenu,children:/* @__PURE__ */jsx(ActionMenu,{disabled,collapsed,groups:actionGroups,isFullscreen})}),showInsertMenu&&/* @__PURE__ */jsx(Box,{flex:collapsed?void 0:1,padding:isFullscreen?2:1,children:/* @__PURE__ */jsx(InsertMenu$1,{disabled,collapsed,items:insertMenuItems,isFullscreen})})]}),/* @__PURE__ */jsx(FullscreenButtonBox,{padding:isFullscreen?2:1,children:/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsxs(Flex,{align:"center",padding:1,children:[/* @__PURE__ */jsx(Box,{flex:1,paddingX:1,children:/* @__PURE__ */jsx(Text$1,{size:1,children:"".concat(isFullscreen?"Collapse":"Expand"," editor")})}),/* @__PURE__ */jsx(Box,{marginLeft:1,children:/* @__PURE__ */jsx(Hotkeys,{keys:["".concat(IS_MAC?"Cmd":"Ctrl"),"Enter"]})})]}),placement:isFullscreen?"bottom":"top",portal:"default",children:/* @__PURE__ */jsx(Button,{padding:2,icon:isFullscreen?CollapseIcon:ExpandIcon,mode:"bleed",onClick:onToggleFullscreen})})})]});});function Toolbar(props){const{hotkeys,isFullscreen,readOnly,onExpand,onToggleFullscreen}=props;const features=useFeatures();const editor=usePortableTextEditor();const selection=usePortableTextEditorSelection();const resolveInitialValueForType=useResolveInitialValueForType();const disabled=readOnly||!selection;const{push}=useToast();const resolveInitialValue=useCallback(type=>{let isSlow=false;const slowTimer=setTimeout(()=>{isSlow=true;push({id:"resolving-initial-value",status:"info",title:"Resolving initial value\u2026"});},SLOW_INITIAL_VALUE_LIMIT);return resolveInitialValueForType(type,{}).then(value=>{if(isSlow){push({id:"resolving-initial-value",status:"info",duration:500,title:"Initial value resolved"});}return value;}).catch(error=>{push({title:"Could not resolve initial value",id:"resolving-initial-value",description:"Unable to resolve initial value for type: ".concat(type.name,": ").concat(error.message,"."),status:"error"});return void 0;}).finally(()=>clearTimeout(slowTimer));},[push]);const handleInsertBlock=useCallback(async type=>{const initialValue=await resolveInitialValue(type);const path=PortableTextEditor.insertBlock(editor,type,initialValue);if(path){PortableTextEditor.blur(editor);onExpand(path);}},[editor,onExpand,resolveInitialValue]);const handleInsertInline=useCallback(async type=>{const initialValue=await resolveInitialValue(type);const path=PortableTextEditor.insertChild(editor,type,initialValue);if(path){PortableTextEditor.blur(editor);onExpand(path);}},[editor,onExpand,resolveInitialValue]);const actionGroups=useActionGroups({hotkeys,onExpand,resolveInitialValue,disabled:true});const blockStyles=useMemo(()=>getBlockStyles(features),[features]);const insertMenuItems=useMemo(()=>getInsertMenuItems(features,disabled,handleInsertBlock,handleInsertInline),[disabled,features,handleInsertBlock,handleInsertInline]);return/* @__PURE__ */jsx(InnerToolbar,{actionGroups,blockStyles,disabled,insertMenuItems,isFullscreen,onToggleFullscreen});}const Root$f=styled(Card)(_templateObject193||(_templateObject193=_taggedTemplateLiteral(["\n  height: ",";\n\n  &:not([hidden]) {\n    display: flex;\n  }\n\n  flex-direction: column;\n"])),_ref240=>{let{$fullscreen}=_ref240;return $fullscreen?"100%":"15em";});const ToolbarCard=styled(Card)(_templateObject194||(_templateObject194=_taggedTemplateLiteral(["\n  z-index: 10;\n  line-height: 0;\n"])));const EditableCard=styled(Card)(_templateObject195||(_templateObject195=_taggedTemplateLiteral(["\n  position: relative;\n  overflow: hidden;\n\n  & > [data-portal] {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    pointer-events: none;\n\n    & > * {\n      pointer-events: initial;\n    }\n  }\n\n  &::selection,\n  *::selection {\n    background-color: transparent;\n  }\n"])));const Scroller$2=styled(ScrollContainer)(_templateObject196||(_templateObject196=_taggedTemplateLiteral(["\n  position: relative;\n  overflow: auto;\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n\n  & > * {\n    flex: 1;\n    min-height: auto;\n  }\n"])));const EditableContainer=styled(Container$1)(_templateObject197||(_templateObject197=_taggedTemplateLiteral(["\n  /* @todo: calculate from theme */\n  /* max-width: 728px; */\n"])));const EditableWrapper=styled(Card)(_templateObject198||(_templateObject198=_taggedTemplateLiteral(["\n  height: 100%;\n  width: 100%;\n  counter-reset: ",";\n  overflow: hidden;\n\n  & > div {\n    height: 100%;\n  }\n\n  & .pt-editable {\n    display: block;\n    width: 100%;\n    height: 100%;\n\n    ","\n\n    & > .pt-list-item-bullet + .pt-list-item-number,\n    & > .pt-list-item-number + .pt-list-item-bullet {\n      margin-top: ","px;\n      counter-reset: ",";\n    }\n\n    & > :not(.pt-list-item) + .pt-list-item {\n      margin-top: ","px;\n    }\n\n    /* Reset the list count if the element is not a numbered list item */\n    & > :not(.pt-list-item-number) {\n      counter-reset: ",";\n    }\n\n    ","\n\n    & > .pt-list-item + :not(.pt-list-item) {\n      margin-top: ","px;\n    }\n\n    & > :first-child {\n      padding-top: ","px;\n    }\n\n    & > :last-child {\n      padding-bottom: ","px;\n    }\n\n    /* & > .pt-block {\n      & .pt-inline-object {\n      }\n    } */\n\n    & .pt-drop-indicator {\n      pointer-events: none;\n      border: 1px solid var(--card-focus-ring-color) !important;\n      height: 0px !important;\n      border-radius: 1px;\n      margin-top: -3px;\n      left: calc(\n        "," - 1px\n      );\n      right: calc(\n        "," - 1px\n      );\n      width: calc(\n        100% -\n          "," + 2px\n      ) !important;\n    }\n  }\n"])),TEXT_LEVELS.map(l=>createListName(l)).join(" "),TEXT_LEVELS.map(l=>{return css(_templateObject199||(_templateObject199=_taggedTemplateLiteral(["\n        & > .pt-list-item-number[class~='pt-list-item-level-","'] {\n          counter-increment: ",";\n        }\n      "])),l,createListName(l));}),_ref241=>{let{theme}=_ref241;return theme.sanity.space[3];},TEXT_LEVELS.map(l=>createListName(l)).join(" "),_ref242=>{let{theme}=_ref242;return theme.sanity.space[2];},TEXT_LEVELS.map(l=>createListName(l)).join(" "),TEXT_LEVELS.slice(1).map(l=>{return css(_templateObject200||(_templateObject200=_taggedTemplateLiteral(["\n        & > .pt-list-item-level-"," + .pt-list-item-level-"," {\n          counter-reset: ",";\n        }\n      "])),l,l-1,createListName(l));}),_ref243=>{let{theme}=_ref243;return theme.sanity.space[3];},_ref244=>{let{$isFullscreen,theme}=_ref244;return theme.sanity.space[$isFullscreen?5:3];},_ref245=>{let{$isFullscreen,theme}=_ref245;return theme.sanity.space[$isFullscreen?9:5];},_ref246=>{let{$isFullscreen,theme}=_ref246;return $isFullscreen?rem(theme.sanity.space[5]):rem(theme.sanity.space[3]);},_ref247=>{let{$isFullscreen,theme}=_ref247;return $isFullscreen?rem(theme.sanity.space[5]):rem(theme.sanity.space[3]);},_ref248=>{let{$isFullscreen,theme}=_ref248;return $isFullscreen?rem(theme.sanity.space[5]*2):rem(theme.sanity.space[3]*2);});function useSpellcheck(){const editor=usePortableTextEditor();return useMemo(()=>{var _a;const spellCheckOption=(_a=editor.portableTextFeatures.types.block.options)==null?void 0:_a.spellCheck;const isChrome96=typeof navigator==="undefined"?false:/Chrome\/96/.test(navigator.userAgent);return spellCheckOption===void 0&&isChrome96===true?false:spellCheckOption;},[editor]);}function useScrollSelectionIntoView(scrollElement){return useMemo(()=>(editor,domRange)=>{const selection=PortableTextEditor.getSelection(editor);if(selection){const leafEl=domRange.startContainer.parentElement;if(!leafEl){return;}scrollIntoView$1(leafEl,{scrollMode:"if-needed",boundary:scrollElement,block:"start",inline:"nearest"});}},[scrollElement]);}const renderDecorator=(mark,mType,attributes,defaultRender)=>{return/* @__PURE__ */jsx(Decorator$1,{mark,children:defaultRender()});};function Editor(props){const{hotkeys,initialSelection,isFullscreen,onCopy,onOpenItem,onPaste,onToggleFullscreen,path,readOnly,renderAnnotation,renderBlock,renderChild,scrollElement,setPortalElement,setScrollElement}=props;const{isTopLayer}=useLayer();const editableRef=useRef(null);const{element:boundaryElement}=useBoundaryElement();useGlobalKeyDown(useCallback(event=>{if(!isTopLayer||!isFullscreen){return;}if(event.key==="Escape"){onToggleFullscreen();}},[onToggleFullscreen,isFullscreen,isTopLayer]));const handleMouseDown=useCallback(event=>{var _a;if(event.target instanceof Node&&!((_a=editableRef.current)==null?void 0:_a.contains(event.target))){event.preventDefault();event.stopPropagation();}},[]);const renderPlaceholder=useCallback(()=>/* @__PURE__ */jsx(Fragment,{children:"Empty"}),[]);const spellcheck=useSpellcheck();const scrollSelectionIntoView=useScrollSelectionIntoView(scrollElement);const editable=useMemo(()=>/* @__PURE__ */jsx(PortableTextEditable,{hotkeys,onCopy,onPaste,ref:editableRef,readOnly,renderAnnotation,renderBlock,renderChild,renderDecorator,renderPlaceholder,scrollSelectionIntoView,selection:initialSelection,spellCheck:spellcheck}),[hotkeys,initialSelection,onCopy,onPaste,readOnly,renderAnnotation,renderBlock,renderChild,renderPlaceholder,scrollSelectionIntoView,spellcheck]);const handleToolBarOnExpand=useCallback(relativePath=>{onOpenItem(path.concat(relativePath));},[onOpenItem,path]);return/* @__PURE__ */jsxs(Root$f,{$fullscreen:isFullscreen,"data-testid":"pt-editor",onMouseDown:handleMouseDown,children:[!readOnly&&/* @__PURE__ */jsx(ToolbarCard,{"data-testid":"pt-editor__toolbar-card",shadow:1,children:/* @__PURE__ */jsx(Toolbar,{isFullscreen,hotkeys,onExpand:handleToolBarOnExpand,readOnly,onToggleFullscreen})}),/* @__PURE__ */jsxs(EditableCard,{flex:1,children:[/* @__PURE__ */jsx(Scroller$2,{ref:setScrollElement,children:/* @__PURE__ */jsx(EditableContainer,{padding:isFullscreen?2:0,sizing:"border",width:1,children:/* @__PURE__ */jsx(EditableWrapper,{$isFullscreen:isFullscreen,$readOnly:readOnly,children:/* @__PURE__ */jsx(BoundaryElementProvider,{element:isFullscreen?scrollElement:boundaryElement,children:editable})})})}),/* @__PURE__ */jsx("div",{"data-portal":"",ref:setPortalElement})]})]});}function focusRingBorderStyle$1(border){return"inset 0 0 0 ".concat(border.width,"px ").concat(border.color);}function focusRingStyle$1(opts){const{base,border,focusRing}=opts;const focusRingOutsetWidth=focusRing.offset+focusRing.width;const focusRingInsetWidth=0-focusRing.offset;const bgColor=base?base.bg:"var(--card-bg-color)";return[focusRingInsetWidth>0&&"inset 0 0 0 ".concat(focusRingInsetWidth,"px var(--card-focus-ring-color)"),border&&focusRingBorderStyle$1(border),focusRingInsetWidth<0&&"0 0 0 ".concat(0-focusRingInsetWidth,"px ").concat(bgColor),focusRingOutsetWidth>0&&"0 0 0 ".concat(focusRingOutsetWidth,"px var(--card-focus-ring-color)")].filter(Boolean).join(",");}const Root$e=styled.div(_ref249=>{let{theme}=_ref249;const{focusRing,input}=theme.sanity;const base=theme.sanity.color.base;const color=theme.sanity.color.input;const border={color:color.default.enabled.border,width:input.border.width};return css(_templateObject201||(_templateObject201=_taggedTemplateLiteral(["\n    --input-box-shadow: ",";\n\n    position: relative;\n\n    & [data-wrapper] {\n      overflow: hidden;\n      position: relative;\n      z-index: 1;\n      padding: ","px;\n    }\n\n    & [data-border] {\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      box-shadow: var(--input-box-shadow);\n      z-index: 2;\n      border-radius: 1px;\n      pointer-events: none;\n    }\n\n    &:not([data-read-only])[data-focused] [data-border] {\n      --input-box-shadow: ",";\n    }\n  "])),focusRingBorderStyle$1(border),input.border.width,focusRingStyle$1({base,border,focusRing}));});const ExpandedLayer=styled(Layer)(_templateObject202||(_templateObject202=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  &:not([data-fullscreen]) {\n    position: relative;\n  }\n"])));function useHotkeys(hotkeys){const editor=usePortableTextEditor();const initialHotkeys=useMemo(()=>hotkeys,[]);if(initialHotkeys!==hotkeys){console.warn("Make sure that hotkeys are a stable object across renders, or there will be issues with key handling in the Portable Text Editor.");}return useMemo(()=>{const defaultHotkeys={marks:{}};const ptFeatures=PortableTextEditor.getPortableTextFeatures(editor);ptFeatures.decorators.forEach(dec=>{switch(dec.value){case"strong":defaultHotkeys.marks["mod+b"]=dec.value;break;case"em":defaultHotkeys.marks["mod+i"]=dec.value;break;case"underline":defaultHotkeys.marks["mod+u"]=dec.value;break;case"code":defaultHotkeys.marks["mod+'"]=dec.value;break;}});return{marks:_objectSpread(_objectSpread({},defaultHotkeys.marks),(initialHotkeys||{}).marks),custom:initialHotkeys.custom};},[editor,initialHotkeys]);}function _getModalOption(opts){const{schemaType}=opts;return get$2(schemaType,"options.modal")||{};}function DefaultEditDialog(props){var _a;const{onClose,children,title,width=1}=props;const dialogId=useId();const portal=usePortal();return/* @__PURE__ */jsx(Dialog,{__unstable_autoFocus:true,id:dialogId||"",onClose,onClickOutside:onClose,header:title,portal:"default",width,children:/* @__PURE__ */jsx(PresenceOverlay,{margins:[0,0,1,0],children:/* @__PURE__ */jsx(Box,{padding:4,children:/* @__PURE__ */jsx(PortalProvider,{element:(_a=portal.elements)==null?void 0:_a.default,children})})})});}const debugElement=process.env.NODE_ENV==="production"?null:{getBoundingClientRect:()=>{const x=200;const y=200;return{left:x,top:y,right:x,bottom:y,width:0,height:0};}};const RootPopover=styled(Popover)(_templateObject203||(_templateObject203=_taggedTemplateLiteral(["\n  &[data-popper-reference-hidden='true'] {\n    visibility: hidden;\n    pointer-events: none;\n  }\n\n  & > div {\n    overflow: hidden;\n  }\n"])));const ContentContainer=styled(Container$1)(_templateObject204||(_templateObject204=_taggedTemplateLiteral(["\n  &:not([hidden]) {\n    display: flex;\n  }\n  direction: column;\n"])));const ContentScrollerBox=styled(Box)(_templateObject205||(_templateObject205=_taggedTemplateLiteral(["\n  /* Prevent overflow caused by change indicator */\n  overflow-x: hidden;\n  overflow-y: auto;\n"])));const ContentHeaderBox=styled(Box)(_templateObject206||(_templateObject206=_taggedTemplateLiteral(["\n  background-color: var(--card-bg-color);\n  box-shadow: 0 1px 0 var(--card-shadow-outline-color);\n  position: relative;\n  z-index: 10;\n  min-height: auto;\n"])));const POPOVER_FALLBACK_PLACEMENTS$1=["top","bottom"];function PopoverEditDialog(props){const{width,elementRef,onClose,scrollElement}=props;useGlobalKeyDown(useCallback(event=>{if(event.key==="Escape"){onClose();}},[onClose]));const[forceUpdate,setForceUpdate]=useState(0);const virtualElement=useMemo(()=>{var _a;if(!((_a=elementRef==null?void 0:elementRef.current)==null?void 0:_a.getBoundingClientRect())){return null;}return{contextElement:elementRef.current||void 0,getBoundingClientRect:()=>{var _a2;return((_a2=elementRef.current)==null?void 0:_a2.getBoundingClientRect())||null;}};},[elementRef==null?void 0:elementRef.current,forceUpdate]);const[rootElement,setRootElement]=useState(null);const handleScrollOrResize=useCallback(()=>{setForceUpdate(forceUpdate+1);},[forceUpdate]);useEffect(()=>{if(scrollElement){scrollElement.addEventListener("scroll",handleScrollOrResize,true);}return()=>{if(scrollElement){scrollElement.removeEventListener("scroll",handleScrollOrResize,true);}};},[handleScrollOrResize,scrollElement]);return/* @__PURE__ */jsx(RootPopover,{constrainSize:true,content:/* @__PURE__ */jsx(Content$1,_objectSpread(_objectSpread({},props),{},{rootElement,width})),fallbackPlacements:POPOVER_FALLBACK_PLACEMENTS$1,placement:"bottom",open:true,portal:"default",ref:setRootElement,referenceElement:virtualElement||debugElement});}function Content$1(props){var _a;const{onClose,rootElement,width=0,title}=props;const{element:boundaryElement}=useBoundaryElement();const portal=usePortal();useClickOutside(onClose,[rootElement],boundaryElement);return/* @__PURE__ */jsx(ContentContainer,{width,children:/* @__PURE__ */jsxs(Flex,{direction:"column",flex:1,children:[/* @__PURE__ */jsx(ContentHeaderBox,{padding:1,children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Box,{flex:1,padding:2,children:/* @__PURE__ */jsx(Text$1,{weight:"semibold",children:title})}),/* @__PURE__ */jsx(Button,{icon:CloseIcon,mode:"bleed",onClick:onClose,padding:2})]})}),/* @__PURE__ */jsx(ContentScrollerBox,{flex:1,children:/* @__PURE__ */jsx(PresenceOverlay,{margins:[0,0,1,0],children:/* @__PURE__ */jsx(Box,{padding:3,children:/* @__PURE__ */jsx(PortalProvider,{element:(_a=portal.elements)==null?void 0:_a.default,children:props.children})})})})]})});}function ObjectEditModal(props){const{memberItem,onClose,scrollElement,kind}=props;const{schemaType}=memberItem.node;const modalOption=useMemo(()=>_getModalOption({schemaType}),[schemaType]);const modalType=useMemo(()=>{if(modalOption.type)return modalOption.type;if(kind==="inlineObject"||kind==="annotation")return"popover";return"dialog";},[kind,modalOption]);const[firstField,setFirstField]=useState(null);const editor=usePortableTextEditor();const initialSelection=useRef(PortableTextEditor.getSelection(editor));const handleClose=useCallback(()=>{onClose();PortableTextEditor.select(editor,null);PortableTextEditor.focus(editor);PortableTextEditor.select(editor,initialSelection.current);},[editor,onClose]);const title=/* @__PURE__ */jsxs(Fragment,{children:["Edit ",memberItem.node.schemaType.title]});useEffect(()=>{if(firstField){return;}const firstFieldMember=memberItem.node.members.find(m=>m.kind==="field");if(firstFieldMember&&firstFieldMember.kind==="field"){const firstFieldElm=document.getElementById(firstFieldMember.field.id);if(firstFieldElm){setFirstField(firstFieldElm);firstFieldElm.focus();}}},[firstField,memberItem]);if(modalType==="popover"){return/* @__PURE__ */jsx(PopoverEditDialog,{elementRef:memberItem.elementRef,onClose:handleClose,scrollElement,title,children:props.children});}return/* @__PURE__ */jsx(DefaultEditDialog,{title,onClose:handleClose,children:props.children});}function useScrollToOpenedMember(props){const{editorRootPath,scrollElement,hasFocus,onCloseItem}=props;const portableTextMemberItems=usePortableTextMemberItems();const editor=usePortableTextEditor();const memberItem=useMemo(()=>{return portableTextMemberItems.filter(item=>item.member.open).sort((a,b)=>b.member.item.path.length-a.member.item.path.length)[0];},[portableTextMemberItems]);useEffect(()=>{var _a,_b;if(hasFocus){return;}if((_a=memberItem==null?void 0:memberItem.elementRef)==null?void 0:_a.current){scrollIntoView$1((_b=memberItem.elementRef)==null?void 0:_b.current,{boundary:scrollElement,scrollMode:"if-needed"});if(memberItem.kind==="textBlock"){const relativePath=memberItem.member.item.path.slice(editorRootPath.length);PortableTextEditor.select(editor,{anchor:{path:relativePath,offset:0},focus:{path:relativePath,offset:0}});PortableTextEditor.focus(editor);onCloseItem();}}},[editor,hasFocus,editorRootPath.length,memberItem,scrollElement,onCloseItem]);}function isTouchDevice(){return typeof window!=="undefined"&&"ontouchstart"in window||typeof navigator!=="undefined"&&navigator.maxTouchPoints>0;}const activateVerb=isTouchDevice()?"Tap":"Click";const ACTIVATE_ON_FOCUS_MESSAGE=/* @__PURE__ */jsxs(Text$1,{weight:"semibold",children:[activateVerb," to activate"]});function Compositor(props){const{changed,focusPath=EMPTY_ARRAY$4,focused,hasFocus,hotkeys,isActive,isFullscreen,onChange,onCopy,onActivate,onOpenItem,onCloseItem,onPaste,onToggleFullscreen,path,renderBlockActions,renderCustomMarkers,value,readOnly,renderPreview}=props;const editor=usePortableTextEditor();const[wrapperElement,setWrapperElement]=useState(null);const[scrollElement,setScrollElement]=useState(null);const portableTextMemberItems=usePortableTextMemberItems();const{element:boundaryElement}=useBoundaryElement();useScrollToOpenedMember({hasFocus,editorRootPath:path,scrollElement,onCloseItem});const handleToggleFullscreen=useCallback(()=>{onToggleFullscreen();},[onToggleFullscreen]);const hotkeysWithFullscreenToggle=useMemo(()=>_objectSpread(_objectSpread({},hotkeys),{},{custom:_objectSpread({"mod+enter":onToggleFullscreen},(hotkeys==null?void 0:hotkeys.custom)||{})}),[hotkeys,onToggleFullscreen]);const editorHotkeys=useHotkeys(hotkeysWithFullscreenToggle);const ptFeatures=useMemo(()=>PortableTextEditor.getPortableTextFeatures(editor),[editor]);const hasContent=!!value;const initialSelection=useMemo(()=>focusPath.length>0?{anchor:{path:focusPath,offset:0},focus:{path:focusPath,offset:0}}:null,[]);const renderBlock=useCallback((block,blockType,attributes,defaultRender)=>{const isTextBlock=block._type===ptFeatures.types.block.name;if(isTextBlock){return/* @__PURE__ */jsx(TextBlock,{attributes,block,isFullscreen,onChange,readOnly,renderBlockActions:hasContent?renderBlockActions:void 0,renderCustomMarkers:hasContent?renderCustomMarkers:void 0,children:defaultRender(block)});}return/* @__PURE__ */jsx(BlockObject,{attributes,block,isFullscreen,onChange,onOpenItem,readOnly,renderBlockActions:hasContent?renderBlockActions:void 0,renderCustomMarkers:hasContent?renderCustomMarkers:void 0,renderPreview,type:blockType});},[hasContent,isFullscreen,onChange,onOpenItem,ptFeatures.types.block.name,readOnly,renderBlockActions,renderCustomMarkers,renderPreview]);const renderChild=useCallback((child,childType,attributes,defaultRender)=>{const isSpan=child._type===ptFeatures.types.span.name;if(isSpan){return defaultRender(child);}return/* @__PURE__ */jsx(InlineObject$1,{attributes,onOpenItem,readOnly,renderCustomMarkers,scrollElement,type:childType,value:child,renderPreview});},[onOpenItem,ptFeatures.types.span.name,readOnly,renderCustomMarkers,renderPreview,scrollElement]);const renderAnnotation=useCallback((annotation,annotationType,attributes,defaultRender)=>{return/* @__PURE__ */jsx(Annotation$1,{attributes,onOpenItem,readOnly,renderCustomMarkers,scrollElement,value:annotation,type:annotationType,children:defaultRender()});},[onOpenItem,readOnly,renderCustomMarkers,scrollElement]);const[portalElement,setPortalElement]=useState(null);const openMemberItems=useMemo(()=>portableTextMemberItems.filter(m=>m.member.open&&!_isBlockType(m.node.schemaType)),[portableTextMemberItems]);const editorNode=useMemo(()=>/* @__PURE__ */jsx(Editor,{hotkeys:editorHotkeys,initialSelection,isFullscreen,onOpenItem,onCopy,onPaste,onToggleFullscreen:handleToggleFullscreen,path,readOnly,renderAnnotation,renderBlock,renderChild,setPortalElement,scrollElement,setScrollElement}),[editorHotkeys,handleToggleFullscreen,initialSelection,isFullscreen,onCopy,onOpenItem,onPaste,path,readOnly,renderAnnotation,renderBlock,renderChild,scrollElement]);const boundaryElm=isFullscreen?scrollElement:boundaryElement;const children=useMemo(()=>boundaryElm&&/* @__PURE__ */jsxs(Fragment,{children:[editorNode,/* @__PURE__ */jsx(BoundaryElementProvider,{element:boundaryElm,children:openMemberItems.map(dMemberItem=>{return/* @__PURE__ */jsx(ObjectEditModal,{kind:dMemberItem.kind,memberItem:dMemberItem,onClose:onCloseItem,scrollElement:boundaryElm,children:/* @__PURE__ */jsx(FormInput,_objectSpread({absolutePath:dMemberItem.node.path},props))},dMemberItem.member.key);})})]}),[boundaryElm,editorNode,openMemberItems,onCloseItem,props]);const portal=usePortal();const portalElements=useMemo(()=>({collapsed:wrapperElement,default:portal.element,editor:portalElement,expanded:portal.element}),[portal.element,portalElement,wrapperElement]);const editorLayer=useMemo(()=>/* @__PURE__ */jsx(Portal,{__unstable_name:isFullscreen?"expanded":"collapsed",children:/* @__PURE__ */jsx(ExpandedLayer,{"data-fullscreen":isFullscreen?"":void 0,children})}),[children,isFullscreen]);return/* @__PURE__ */jsx(PortalProvider,{__unstable_elements:portalElements,children:/* @__PURE__ */jsx(ActivateOnFocus,{message:ACTIVATE_ON_FOCUS_MESSAGE,onActivate,isOverlayActive:!isActive,children:/* @__PURE__ */jsx(ChangeIndicator,{disabled:isFullscreen,hasFocus:Boolean(focused),isChanged:changed,path,children:/* @__PURE__ */jsxs(Root$e,{"data-focused":hasFocus?"":void 0,"data-read-only":readOnly?"":void 0,children:[/* @__PURE__ */jsx("div",{"data-wrapper":"",ref:setWrapperElement,children:editorLayer}),/* @__PURE__ */jsx("div",{"data-border":""})]})})})});}function InvalidValue(props){const{onChange,onIgnore,resolution}=props;const handleAction=useCallback(()=>{if(resolution){onChange({type:"mutation",patches:resolution.patches});}},[onChange,resolution]);if(!resolution)return null;return/* @__PURE__ */jsx(Alert,{suffix:/* @__PURE__ */jsxs(Stack,{padding:2,children:[resolution.action&&/* @__PURE__ */jsxs(Grid,{columns:[1,2],gap:1,children:[/* @__PURE__ */jsx(Button,{mode:"ghost",onClick:onIgnore,text:"Ignore"}),/* @__PURE__ */jsx(Button,{onClick:handleAction,text:resolution.action,tone:"caution"})]}),/* @__PURE__ */jsx(Box,{padding:3,children:resolution.action&&/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"NOTE: It\u2019s generally safe to perform the action above, but if you are in doubt, get in touch with those responsible for configuring your studio."})})]}),title:/* @__PURE__ */jsx(Fragment,{children:"Invalid block value"}),children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:resolution.description}),/* @__PURE__ */jsx(Card,{border:true,overflow:"auto",padding:2,tone:"inherit",children:/* @__PURE__ */jsx(Code,{language:"json",children:JSON.stringify(resolution.item,null,2)})})]})});}function usePatches(props){const{path}=props;const{patchChannel}=useFormBuilder().__internal;const subscribe=useCallback(subscriber=>{return patchChannel.subscribe(_ref250=>{let{snapshot,patches}=_ref250;const filteredPatches=patches.filter(patch=>_startsWith(patch.path,path)).map(patch=>_objectSpread(_objectSpread({},patch),{},{path:patch.path.slice(path.length)}));if(filteredPatches.length){subscriber({shouldReset:_shouldReset(path,patches),snapshot:isRecord$2(snapshot)?_getValueAtPath(snapshot,path):{},patches:filteredPatches});}});},[path,patchChannel]);return{subscribe};}function _isSegmentEqual(segment1,segment2){const segment1Type=typeof segment1;if(segment1Type!==typeof segment2){return false;}if(segment1Type==="object"){return shallowEquals(segment1,segment2);}return segment1===segment2;}function _startsWith(subjectPath,checkPath){if(subjectPath===checkPath){return true;}if(!Array.isArray(subjectPath)||!Array.isArray(checkPath)){return false;}if(subjectPath.length<checkPath.length){return false;}for(let i=0,len=checkPath.length;i<len;i++){if(!_isSegmentEqual(checkPath[i],subjectPath[i])){return false;}}return true;}function _isAncestor(path1,path2){return path1.length===0||_startsWith(path2,path1)&&!_startsWith(path1,path2);}function _shouldReset(path,patches){return patches.some(patch=>_isAncestor(patch.path,path)&&(patch.type==="set"||patch.type==="unset"));}function _getValueAtPath(value,path){return path.reduce((result,segment)=>{if(typeof segment==="object"){return find(result,segment);}return get$2(result,segment);},value);}const Root$d=styled(Button)(_templateObject207||(_templateObject207=_taggedTemplateLiteral(["\n  position: absolute;\n  z-index: ",";\n  margin: 1px;\n\n  &:not(:focus) {\n    height: 1px;\n    width: 1px;\n    overflow: hidden;\n    clip: rect(1px, 1px, 1px, 1px);\n  }\n"])),_ref251=>{let{$zIndex}=_ref251;return $zIndex;});function VisibleOnFocusButton(props){const{children,onClick}=props;const{zIndex}=useLayer();return/* @__PURE__ */jsx(Root$d,{mode:"ghost",onClick,$zIndex:zIndex+1,children});}function PortableTextInput(props){const{focused,focusPath,hotkeys,markers=EMPTY_ARRAY$4,members,onChange,onCopy,onFocusPath,onInsert,onPaste,path,readOnly:readOnlyFromProps,renderBlockActions,renderCustomMarkers,schemaType:type,value,elementProps}=props;useImperativeHandle(elementProps.ref,()=>({focus(){if(editorRef.current){PortableTextEditor.focus(editorRef.current);}}}));const{subscribe}=usePatches({path});const editorRef=useRef(null);const[hasFocus,setHasFocus]=useState(false);const[ignoreValidationError,setIgnoreValidationError]=useState(false);const[invalidValue,setInvalidValue]=useState(null);const[isFullscreen,setIsFullscreen]=useState(false);const[isActive,setIsActive]=useState(false);const readOnly=useMemo(()=>{return isActive?Boolean(readOnlyFromProps):true;},[isActive,readOnlyFromProps]);const toast=useToast();const portableTextMemberItemsRef=useRef([]);const patchSubject=useMemo(()=>new Subject(),[]);const remotePatch$=useMemo(()=>patchSubject.asObservable(),[patchSubject]);const innerElementRef=useRef(null);const handleToggleFullscreen=useCallback(()=>{if(editorRef.current){const prevSel=PortableTextEditor.getSelection(editorRef.current);setIsFullscreen(v=>!v);setTimeout(()=>{if(editorRef.current){PortableTextEditor.focus(editorRef.current);if(prevSel){PortableTextEditor.select(editorRef.current,_objectSpread({},prevSel));}}});}},[]);useEffect(()=>{if(invalidValue&&value!==invalidValue.value){setInvalidValue(null);}},[invalidValue,value]);useEffect(()=>{return subscribe(_ref252=>{let{patches,snapshot}=_ref252;patchSubject.next({patches,snapshot});});},[patchSubject,subscribe]);const portableTextMemberItems=useMemo(()=>{const result=[];for(const member of members){if(member.kind==="item"){if(!_isBlockType(member.item.schemaType)){result.push({kind:"objectBlock",member,node:member.item});}else if(member.item.validation.length>0||member.item.changed){result.push({kind:"textBlock",member,node:member.item});}if(_isBlockType(member.item.schemaType)){const childrenField=member.item.members.find(f=>f.kind==="field"&&f.name==="children");if(childrenField&&childrenField.kind==="field"&&isMemberArrayOfObjects(childrenField)){for(const child of childrenField.field.members){if(child.kind==="item"&&child.item.schemaType.name!=="span"){result.push({kind:"inlineObject",member:child,node:child.item});}}}const markDefArrayMember=member.item.members.filter(_isArrayOfObjectsFieldMember).find(f=>f.name==="markDefs");if(markDefArrayMember){for(const child of markDefArrayMember.field.members){if(child.kind==="item"&&child.item.schemaType.jsonType==="object"){result.push({kind:"annotation",member:child,node:child.item});}}}}}}const items=result.map(r=>{const key=pathToString(r.node.path.slice(path.length));const existingItem=portableTextMemberItemsRef.current.find(ref=>ref.key===key);if(existingItem){existingItem.member=r.member;existingItem.node=r.node;return existingItem;}return{kind:r.kind,key,member:r.member,node:r.node,elementRef:createRef()};});portableTextMemberItemsRef.current=items;return items;},[members,path]);const hasOpenItem=useMemo(()=>{return portableTextMemberItems.some(item=>item.member.open);},[portableTextMemberItems]);const setFocusPathDebounced=useMemo(()=>debounce(sel=>{if(sel&&hasFocus)onFocusPath(sel.focus.path);},500,{trailing:true,leading:false}),[hasFocus,onFocusPath]);const handleEditorChange=useCallback(change=>{switch(change.type){case"mutation":onChange(change.patches);break;case"selection":setFocusPathDebounced(change.selection);break;case"focus":setHasFocus(true);break;case"blur":setHasFocus(false);break;case"undo":case"redo":onChange(change.patches);break;case"invalidValue":setInvalidValue(change);break;case"error":toast.push({status:change.level,description:change.description});break;}},[onChange,toast,setFocusPathDebounced]);const handleFocusSkipperClick=useCallback(()=>{if(editorRef.current){PortableTextEditor.focus(editorRef.current);}},[editorRef]);const handleIgnoreInvalidValue=useCallback(()=>{setIgnoreValidationError(true);},[]);const respondToInvalidContent=useMemo(()=>{if(invalidValue&&invalidValue.resolution){return/* @__PURE__ */jsx(Box,{marginBottom:2,children:/* @__PURE__ */jsx(InvalidValue,{onChange:handleEditorChange,onIgnore:handleIgnoreInvalidValue,resolution:invalidValue.resolution})});}return null;},[handleEditorChange,handleIgnoreInvalidValue,invalidValue]);const handleActivate=useCallback(()=>{if(!isActive){setIsActive(true);if(!hasFocus){setTimeout(()=>{if(editorRef.current){PortableTextEditor.focus(editorRef.current);}});}}},[hasFocus,isActive]);useEffect(()=>{if(!hasFocus&&hasOpenItem&&innerElementRef.current){scrollIntoView$1(innerElementRef.current,{scrollMode:"if-needed"});}},[focused,hasFocus,hasOpenItem]);return/* @__PURE__ */jsxs(Box,{ref:innerElementRef,children:[!readOnly&&/* @__PURE__ */jsx(VisibleOnFocusButton,{onClick:handleFocusSkipperClick,children:/* @__PURE__ */jsx(Text$1,{children:"Go to content"})}),!ignoreValidationError&&respondToInvalidContent,(!invalidValue||ignoreValidationError)&&/* @__PURE__ */jsx(PortableTextMarkersProvider,{markers,children:/* @__PURE__ */jsx(PortableTextMemberItemsProvider,{memberItems:portableTextMemberItems,children:/* @__PURE__ */jsx(PortableTextEditor,{ref:editorRef,incomingPatches$:remotePatch$,onChange:handleEditorChange,maxBlocks:void 0,readOnly,type,value,children:/* @__PURE__ */jsx(Compositor,_objectSpread(_objectSpread({},props),{},{focused,focusPath,hasFocus,hotkeys,isActive,isFullscreen,onActivate:handleActivate,onChange,onCopy,onInsert,onPaste,onToggleFullscreen:handleToggleFullscreen,readOnly,renderBlockActions,renderCustomMarkers,value}))})})})]});}function isObjectItemProps(item){return isObjectSchemaType(item.schemaType);}function isObjectInputProps(inputProps){return isObjectSchemaType(inputProps.schemaType);}function isStringInputProps(inputProps){return isStringSchemaType(inputProps.schemaType);}function isNumberInputProps(inputProps){return isNumberSchemaType(inputProps.schemaType);}function isBooleanInputProps(inputProps){return isBooleanSchemaType(inputProps.schemaType);}function isArrayOfObjectsInputProps(inputProps){return isArrayOfObjectsSchemaType(inputProps.schemaType);}function isArrayOfPrimitivesInputProps(inputProps){return isArrayOfPrimitivesSchemaType(inputProps.schemaType);}function resolveConditionalProperty(property,context){const{currentUser,document,parent,value}=context;if(typeof property==="boolean"||property===void 0){return Boolean(property);}return property({document,parent,value,currentUser})===true;}const MAX_FIELD_DEPTH=20;const AUTO_COLLAPSE_DEPTH=3;function getItemType(arrayType,item){const itemTypeName=resolveTypeName$1(item);return itemTypeName==="object"&&arrayType.of.length===1?arrayType.of[0]:arrayType.of.find(memberType=>memberType.name===itemTypeName);}function getPrimitiveItemType(arrayType,item){const itemTypeName=resolveTypeName$1(item);return arrayType==null?void 0:arrayType.of.find(memberType=>memberType.name===itemTypeName||memberType.jsonType===itemTypeName);}function getCollapsedWithDefaults(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};let level=arguments.length>1?arguments[1]:undefined;if((options==null?void 0:options.collapsible)===false||(options==null?void 0:options.collapsable)===false){return{collapsible:false,collapsed:false};}const collapsed=typeof(options==null?void 0:options.collapsed)==="boolean"?options.collapsed:level>=AUTO_COLLAPSE_DEPTH;const collapsible=collapsed||(options==null?void 0:options.collapsible)===true||(options==null?void 0:options.collapsable)===true;return{collapsible,collapsed};}function getOption(type,optionName){return get$2(type.options,optionName);}const PSEUDO_OBJECTS=["array","file","image","reference","slug"];const HIDDEN_FIELDS=["asset","crop","hotspot","_ref","_weak"];const NO_LEVEL_LAYOUTS=["tags"];const NO_LEVEL_TYPES=["slug"];function getFieldLevel(schemaType,currentLevel){return isArraySchemaType(schemaType)?getArrayFieldLevel(schemaType,currentLevel):getObjectFieldLevel(schemaType,currentLevel);}function getObjectFieldLevel(schemaType,currentLevel){var _a,_b,_c;const{type,options}=schemaType;const typeIfRelevant=asType(type,PSEUDO_OBJECTS);const fields=(schemaType==null?void 0:schemaType.jsonType)==="object"?schemaType.fields:void 0;const typeName=(typeIfRelevant==null?void 0:typeIfRelevant.name)||"";if(NO_LEVEL_TYPES.includes(typeName)){return 0;}const isPseudoObject=PSEUDO_OBJECTS.includes(typeName);const hasVisibleFields=((_a=fields==null?void 0:fields.filter(f=>!HIDDEN_FIELDS.includes(f.name)).length)!=null?_a:0)>0;const hasListOptions=((_c=(_b=options==null?void 0:options.list)==null?void 0:_b.length)!=null?_c:0)>0;if(hasVisibleFields||hasListOptions||!isPseudoObject){return currentLevel;}return 0;}function getArrayFieldLevel(schemaType,currentLevel){var _a;const{options}=schemaType;const hasListOptions=((_a=(options==null?void 0:options.list)||[])==null?void 0:_a.length)>0;const isNoLevelLayout=NO_LEVEL_LAYOUTS.includes((options==null?void 0:options.layout)||"");if(hasListOptions&&!isNoLevelLayout){return currentLevel;}return 0;}function asType(schemaType,asOneOfTypes){if((schemaType==null?void 0:schemaType.name)&&asOneOfTypes.includes(schemaType==null?void 0:schemaType.name)){return schemaType;}if(!schemaType){return void 0;}return asType(schemaType.type,asOneOfTypes);}const ALL_FIELDS_GROUP={name:"all-fields",title:"All fields",hidden:false};function isFieldEnabledByGroupFilter(groupsConfig,field,currentGroup){if(currentGroup.name===ALL_FIELDS_GROUP.name){return true;}if(groupsConfig.length===0){return true;}return castArray(field.group).includes(currentGroup.name);}function isAcceptedObjectValue(value){return typeof value==="undefined"||isRecord$2(value);}function isValidArrayOfObjectsValue(value){return typeof value==="undefined"||Array.isArray(value);}function isValidArrayOfPrimitivesValue(value){return typeof value==="undefined"||Array.isArray(value);}function everyItemIsObject(value){return value.length===0||value.every(item=>isRecord$2(item));}function findDuplicateKeyEntries(array){const seenKeys=/* @__PURE__ */new Set();return array.reduce((acc,item,index)=>{if(seenKeys.has(item._key)){acc.push([index,item._key]);}seenKeys.add(item._key);return acc;},[]);}function hasKey(value){return"_key"in value;}function everyItemHasKey(array){return array==null?void 0:array.every(item=>isRecord$2(item)&&hasKey(item));}function isChangedValue(value,comparisonValue){if(value&&!comparisonValue){return true;}return!isEqual$1(value,comparisonValue);}function prepareFieldMember(props){var _a,_b,_c,_d,_e,_f,_g,_h,_i,_j,_k,_l,_m,_n,_o,_p,_q,_r;const{parent,field,index}=props;const fieldPath=pathFor([...parent.path,field.name]);const fieldLevel=getFieldLevel(field.type,parent.level+1);const parentValue=parent.value;const parentComparisonValue=parent.comparisonValue;if(!isAcceptedObjectValue(parentValue)){throw new Error("Unexpected non-object value");}if(isObjectSchemaType(field.type)){const fieldValue=parentValue==null?void 0:parentValue[field.name];const fieldComparisonValue=isRecord$2(parentComparisonValue)?parentComparisonValue==null?void 0:parentComparisonValue[field.name]:void 0;if(!isAcceptedObjectValue(fieldValue)){return{kind:"error",key:field.name,fieldName:field.name,error:{type:"INCOMPATIBLE_TYPE",expectedSchemaType:field.type,resolvedValueType:resolveTypeName$1(fieldValue),value:fieldValue}};}const fieldGroupState=(_b=(_a=parent.fieldGroupState)==null?void 0:_a.children)==null?void 0:_b[field.name];const scopedCollapsedPaths=(_d=(_c=parent.collapsedPaths)==null?void 0:_c.children)==null?void 0:_d[field.name];const scopedCollapsedFieldsets=(_f=(_e=parent.collapsedFieldSets)==null?void 0:_e.children)==null?void 0:_f[field.name];const inputState=prepareObjectInputState({schemaType:field.type,currentUser:parent.currentUser,parent:parent.value,document:parent.document,value:fieldValue,changed:isChangedValue(fieldValue,fieldComparisonValue),comparisonValue:fieldComparisonValue,presence:parent.presence,validation:parent.validation,fieldGroupState,path:fieldPath,level:fieldLevel,focusPath:parent.focusPath,openPath:parent.openPath,collapsedPaths:scopedCollapsedPaths,collapsedFieldSets:scopedCollapsedFieldsets,readOnly:parent.readOnly});if(inputState===null){return null;}const defaultCollapsedState=getCollapsedWithDefaults(field.type.options,fieldLevel);const collapsed=scopedCollapsedPaths?scopedCollapsedPaths.value:defaultCollapsedState.collapsed;return{kind:"field",key:"field-".concat(field.name),name:field.name,index,open:startsWith(fieldPath,parent.openPath),field:inputState,collapsed,collapsible:defaultCollapsedState.collapsible};}else if(isArraySchemaType(field.type)){const fieldValue=parentValue==null?void 0:parentValue[field.name];const fieldComparisonValue=isRecord$2(parentComparisonValue)?parentComparisonValue==null?void 0:parentComparisonValue[field.name]:void 0;if(isArrayOfObjectsSchemaType(field.type)){const hasValue=typeof fieldValue!=="undefined";if(hasValue&&!isValidArrayOfObjectsValue(fieldValue)){const resolvedValueType=resolveTypeName$1(fieldValue);return{kind:"error",key:field.name,fieldName:field.name,error:{type:"INCOMPATIBLE_TYPE",expectedSchemaType:field.type,resolvedValueType,value:fieldValue}};}if(hasValue&&!everyItemIsObject(fieldValue)){return{kind:"error",key:field.name,fieldName:field.name,error:{type:"MIXED_ARRAY",schemaType:field.type}};}if(hasValue&&!everyItemHasKey(fieldValue)){return{kind:"error",key:field.name,fieldName:field.name,error:{type:"MISSING_KEYS",value:fieldValue,schemaType:field.type}};}const duplicateKeyEntries=hasValue?findDuplicateKeyEntries(fieldValue):[];if(duplicateKeyEntries.length>0){return{kind:"error",key:field.name,fieldName:field.name,error:{type:"DUPLICATE_KEYS",duplicates:duplicateKeyEntries,schemaType:field.type}};}const fieldGroupState=(_h=(_g=parent.fieldGroupState)==null?void 0:_g.children)==null?void 0:_h[field.name];const scopedCollapsedPaths=(_j=(_i=parent.collapsedPaths)==null?void 0:_i.children)==null?void 0:_j[field.name];const scopedCollapsedFieldSets=(_l=(_k=parent.collapsedFieldSets)==null?void 0:_k.children)==null?void 0:_l[field.name];const readOnly=parent.readOnly||resolveConditionalProperty(field.type.readOnly,{value:fieldValue,parent:parent.value,document:parent.document,currentUser:parent.currentUser});const fieldState=prepareArrayOfObjectsInputState({schemaType:field.type,parent:parent.value,currentUser:parent.currentUser,document:parent.document,value:fieldValue,changed:isChangedValue(fieldValue,fieldComparisonValue),comparisonValue:fieldComparisonValue,fieldGroupState,focusPath:parent.focusPath,openPath:parent.openPath,presence:parent.presence,validation:parent.validation,collapsedPaths:scopedCollapsedPaths,collapsedFieldSets:scopedCollapsedFieldSets,level:fieldLevel,path:fieldPath,readOnly});if(fieldState===null){return null;}return{kind:"field",key:"field-".concat(field.name),name:field.name,index,open:startsWith(fieldPath,parent.openPath),collapsible:false,collapsed:false,field:fieldState};}else{if(!isValidArrayOfPrimitivesValue(fieldValue)){const resolvedValueType=resolveTypeName$1(fieldValue);return{kind:"error",key:field.name,fieldName:field.name,error:{type:"INCOMPATIBLE_TYPE",expectedSchemaType:field.type,resolvedValueType,value:fieldValue}};}const fieldGroupState=(_n=(_m=parent.fieldGroupState)==null?void 0:_m.children)==null?void 0:_n[field.name];const scopedCollapsedPaths=(_p=(_o=parent.collapsedPaths)==null?void 0:_o.children)==null?void 0:_p[field.name];const scopedCollapsedFieldSets=(_r=(_q=parent.collapsedFieldSets)==null?void 0:_q.children)==null?void 0:_r[field.name];const readOnly=parent.readOnly||resolveConditionalProperty(field.type.readOnly,{value:fieldValue,parent:parent.value,document:parent.document,currentUser:parent.currentUser});const fieldState=prepareArrayOfPrimitivesInputState({changed:isChangedValue(fieldValue,fieldComparisonValue),comparisonValue:fieldComparisonValue,schemaType:field.type,parent:parent.value,currentUser:parent.currentUser,document:parent.document,value:fieldValue,fieldGroupState,focusPath:parent.focusPath,openPath:parent.openPath,presence:parent.presence,validation:parent.validation,collapsedPaths:scopedCollapsedPaths,collapsedFieldSets:scopedCollapsedFieldSets,level:fieldLevel,path:fieldPath,readOnly});if(fieldState===null){return null;}return{kind:"field",key:"field-".concat(field.name),name:field.name,index,open:startsWith(fieldPath,parent.openPath),collapsible:false,collapsed:false,field:fieldState};}}else{const fieldValue=parentValue==null?void 0:parentValue[field.name];const fieldComparisonValue=isRecord$2(parentComparisonValue)?parentComparisonValue==null?void 0:parentComparisonValue[field.name]:void 0;const conditionalPropertyContext={value:fieldValue,parent:parent.value,document:parent.document,currentUser:parent.currentUser};const hidden=resolveConditionalProperty(field.type.hidden,conditionalPropertyContext);if(hidden){return null;}const readOnly=parent.readOnly||resolveConditionalProperty(field.type.readOnly,conditionalPropertyContext);const fieldState=preparePrimitiveInputState(_objectSpread(_objectSpread({},parent),{},{comparisonValue:fieldComparisonValue,value:fieldValue,schemaType:field.type,path:fieldPath,readOnly}));return{kind:"field",key:"field-".concat(field.name),name:field.name,index,open:startsWith(fieldPath,parent.openPath),collapsible:false,collapsed:false,field:fieldState};}}function prepareObjectInputState(props){let enableHiddenCheck=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var _a;if(props.level===MAX_FIELD_DEPTH){return null;}const conditionalPropertyContext={value:props.value,parent:props.parent,document:props.document,currentUser:props.currentUser};const hidden=enableHiddenCheck&&resolveConditionalProperty(props.schemaType.hidden,conditionalPropertyContext);if(hidden){return null;}const readOnly=props.readOnly||resolveConditionalProperty(props.schemaType.readOnly,conditionalPropertyContext);const schemaTypeGroupConfig=props.schemaType.groups||[];const defaultGroupName=(_a=schemaTypeGroupConfig.find(g=>g.default)||ALL_FIELDS_GROUP)==null?void 0:_a.name;const groups=[ALL_FIELDS_GROUP,...schemaTypeGroupConfig].flatMap(group=>{var _a2;const groupHidden=resolveConditionalProperty(group.hidden,conditionalPropertyContext);const selected=group.name===(((_a2=props.fieldGroupState)==null?void 0:_a2.value)||defaultGroupName);return groupHidden?[]:[{icon:group==null?void 0:group.icon,name:group.name,selected,title:group.title}];});const selectedGroup=groups.find(group=>group.selected);const parentProps=_objectSpread(_objectSpread({},props),{},{hidden,readOnly});const normalizedSchemaMembers=props.schemaType.fieldsets?props.schemaType.fieldsets:props.schemaType.fields.map(field=>({single:true,field}));const members=normalizedSchemaMembers.flatMap((fieldSet,index)=>{var _a2,_b,_c,_d;if(fieldSet.single){const fieldMember=prepareFieldMember({field:fieldSet.field,parent:parentProps,index});if(fieldMember===null||!isFieldEnabledByGroupFilter(groups,fieldSet.field,selectedGroup)){return[];}return[fieldMember];}const fieldsetFieldNames=fieldSet.fields.map(f=>f.name);const fieldsetHidden=resolveConditionalProperty(fieldSet.hidden,{currentUser:props.currentUser,document:props.document,parent:props.value,value:pick(props.value,fieldsetFieldNames)});if(fieldsetHidden){return[];}const fieldsetReadOnly=resolveConditionalProperty(fieldSet.readOnly,{currentUser:props.currentUser,document:props.document,parent:props.value,value:pick(props.value,fieldsetFieldNames)});const fieldsetMembers=fieldSet.fields.flatMap(field=>{const fieldState=prepareFieldMember({field,parent:parentProps,index});if(fieldState===null||!isFieldEnabledByGroupFilter(groups,field,selectedGroup)){return[];}const fieldStateWithReadOnly=_objectSpread(_objectSpread({},fieldState),{},{field:_objectSpread(_objectSpread({},fieldState==null?void 0:fieldState.field),{},{readOnly:readOnly||fieldsetReadOnly})});return[fieldStateWithReadOnly];});if(fieldsetMembers.length===0){return[];}const defaultCollapsedState=getCollapsedWithDefaults(fieldSet.options,props.level);const collapsed=(_c=(_b=(((_a2=props.collapsedFieldSets)==null?void 0:_a2.children)||{})[fieldSet.name])==null?void 0:_b.value)!=null?_c:defaultCollapsedState.collapsed;return[{kind:"fieldSet",key:"fieldset-".concat(fieldSet.name),fieldSet:{path:pathFor(props.path.concat(fieldSet.name)),name:fieldSet.name,title:fieldSet.title,description:fieldSet.description,hidden:false,level:props.level+1,members:fieldsetMembers,collapsible:defaultCollapsedState==null?void 0:defaultCollapsedState.collapsible,collapsed,columns:(_d=fieldSet==null?void 0:fieldSet.options)==null?void 0:_d.columns}}];});const hasFieldGroups=schemaTypeGroupConfig.length>0;const presence=props.presence.filter(item=>isEqual$2(item.path,props.path));const validation=props.validation.filter(item=>isEqual$2(item.path,props.path)).map(v=>({level:v.level,message:v.item.message,path:v.path}));if(members.length===0){return null;}return{value:props.value,changed:isChangedValue(props.value,props.comparisonValue),schemaType:props.schemaType,readOnly:props.readOnly||readOnly,path:props.path,id:toString(props.path),level:props.level,focused:isEqual$2(props.path,props.focusPath),focusPath:trimChildPath(props.path,props.focusPath),presence,validation,members,groups:hasFieldGroups?groups:[]};}function prepareArrayOfPrimitivesInputState(props){if(props.level===MAX_FIELD_DEPTH){return null;}const conditionalPropertyContext={comparisonValue:props.comparisonValue,value:props.value,parent:props.parent,document:props.document,currentUser:props.currentUser};const hidden=resolveConditionalProperty(props.schemaType.hidden,conditionalPropertyContext);if(hidden){return null;}const readOnly=props.readOnly||resolveConditionalProperty(props.schemaType.readOnly,conditionalPropertyContext);const items=Array.isArray(props.value)?props.value:[];const presence=props.presence.filter(item=>isEqual$2(item.path,props.path));const validation=props.validation.filter(item=>isEqual$2(item.path,props.path)).map(v=>({level:v.level,message:v.item.message,path:v.path}));const members=items.flatMap((item,index)=>prepareArrayOfPrimitivesMember({arrayItem:item,parent:props,index}));return{changed:members.some(m=>m.kind==="item"&&m.item.changed),value:props.value,readOnly,schemaType:props.schemaType,focused:isEqual$2(props.path,props.focusPath),focusPath:trimChildPath(props.path,props.focusPath),path:props.path,id:toString(props.path),level:props.level,validation,presence,members};}function prepareArrayOfObjectsInputState(props){if(props.level===MAX_FIELD_DEPTH){return null;}const conditionalPropertyContext={value:props.value,parent:props.parent,document:props.document,currentUser:props.currentUser};const hidden=resolveConditionalProperty(props.schemaType.hidden,conditionalPropertyContext);if(hidden){return null;}const readOnly=props.readOnly||resolveConditionalProperty(props.schemaType.readOnly,conditionalPropertyContext);const items=Array.isArray(props.value)?props.value:[];const presence=props.presence.filter(item=>isEqual$2(item.path,props.path));const validation=props.validation.filter(item=>isEqual$2(item.path,props.path)).map(v=>({level:v.level,message:v.item.message,path:v.path}));const members=items.flatMap((item,index)=>prepareArrayOfObjectsMember({arrayItem:item,parent:props,index}));return{changed:members.some(m=>m.kind==="item"&&m.item.changed),value:props.value,readOnly,schemaType:props.schemaType,focused:isEqual$2(props.path,props.focusPath),focusPath:trimChildPath(props.path,props.focusPath),path:props.path,id:toString(props.path),level:props.level,validation,presence,members};}function prepareArrayOfObjectsMember(props){var _a,_b,_c;const{arrayItem,parent,index}=props;const itemType=getItemType(parent.schemaType,arrayItem);const key=arrayItem._key;if(!itemType){const itemTypeName=resolveTypeName$1(arrayItem);return{kind:"error",key,index,error:{type:"INVALID_ITEM_TYPE",resolvedValueType:itemTypeName,value:arrayItem,validTypes:parent.schemaType.of}};}const itemPath=pathFor([...parent.path,{_key:key}]);const itemLevel=parent.level+1;const conditionalPropertyContext={value:parent.value,parent:props.parent,document:parent.document,currentUser:parent.currentUser};const readOnly=parent.readOnly||resolveConditionalProperty(parent.schemaType.readOnly,conditionalPropertyContext);const collapsedItemPaths=(_b=(_a=parent.collapsedPaths)==null?void 0:_a.children)==null?void 0:_b[key];const comparisonValue=Array.isArray(parent.comparisonValue)&&parent.comparisonValue.find(i=>i._key===arrayItem._key)||void 0;const itemState=prepareObjectInputState({schemaType:itemType,level:itemLevel,document:parent.document,value:arrayItem,comparisonValue,changed:isChangedValue(arrayItem,comparisonValue),path:itemPath,focusPath:parent.focusPath,openPath:parent.openPath,currentUser:parent.currentUser,collapsedPaths:collapsedItemPaths,presence:parent.presence,validation:parent.validation,readOnly},false);const defaultCollapsedState=getCollapsedWithDefaults(itemType.options,itemLevel);const collapsed=(_c=collapsedItemPaths==null?void 0:collapsedItemPaths.value)!=null?_c:defaultCollapsedState.collapsed;return{kind:"item",key,index,open:startsWith(itemPath,parent.openPath),collapsed,collapsible:true,item:itemState};}function prepareArrayOfPrimitivesMember(props){var _a,_b;const{arrayItem,parent,index}=props;const itemType=getPrimitiveItemType(parent.schemaType,arrayItem);const itemPath=pathFor([...parent.path,index]);const itemValue=(_a=parent.value)==null?void 0:_a[index];const itemComparisonValue=(_b=parent.comparisonValue)==null?void 0:_b[index];const itemLevel=parent.level+1;const key="".concat((itemType==null?void 0:itemType.name)||"invalid-type","-").concat(String(index));if(!itemType){return{kind:"error",key,index,error:{type:"INVALID_ITEM_TYPE",validTypes:parent.schemaType.of,resolvedValueType:resolveTypeName$1(itemType),value:itemValue}};}const readOnly=parent.readOnly||resolveConditionalProperty(itemType.readOnly,{value:itemValue,parent:parent.value,document:parent.document,currentUser:parent.currentUser});const item=preparePrimitiveInputState(_objectSpread(_objectSpread({},parent),{},{path:itemPath,schemaType:itemType,level:itemLevel,value:itemValue,comparisonValue:itemComparisonValue,readOnly}));return{kind:"item",key,index,open:isEqual$2(itemPath,parent.openPath),item};}function preparePrimitiveInputState(props){const presence=props.presence.filter(item=>isEqual$2(item.path,props.path));const validation=props.validation.filter(item=>isEqual$2(item.path,props.path)).map(v=>({level:v.level,message:v.item.message,path:v.path}));return{schemaType:props.schemaType,changed:isChangedValue(props.value,props.comparisonValue),value:props.value,level:props.level,id:toString(props.path),readOnly:props.readOnly,focused:isEqual$2(props.path,props.focusPath),path:props.path,presence,validation};}function prepareFormState(props){return prepareObjectInputState(props);}function immutableReconcile(previous,next){return _immutableReconcile(previous,next,/* @__PURE__ */new WeakSet());}function _immutableReconcile(previous,next,parents){if(previous===next)return previous;if(previous==null||next==null)return next;const prevType=typeof previous;const nextType=typeof next;if(prevType!==nextType)return next;if(Array.isArray(next)){parents.add(next);let allEqual=previous.length===next.length;const result=[];for(let index=0;index<next.length;index++){if(parents.has(next[index])){return next;}const nextItem=_immutableReconcile(previous[index],next[index],parents);if(nextItem!==previous[index]){allEqual=false;}result[index]=nextItem;}return allEqual?previous:result;}if(typeof next==="object"){parents.add(next);let allEqual=true;const result={};for(const key of Object.keys(next)){if(parents.has(next[key])){return next;}const nextValue=_immutableReconcile(previous[key],next[key],parents);if(nextValue!==previous[key]){allEqual=false;}result[key]=nextValue;}return allEqual?previous:result;}return next;}function useFormState(schemaType,_ref253){let{comparisonValue,value,fieldGroupState,collapsedFieldSets,collapsedPaths,focusPath,openPath,presence,validation}=_ref253;const currentUser=useCurrentUser();const prev=useRef(null);useLayoutEffect(()=>{prev.current=null;},[schemaType]);return useMemo(()=>{const next=prepareFormState({schemaType,document:value,fieldGroupState,collapsedFieldSets,collapsedPaths,value,comparisonValue,focusPath,openPath,path:pathFor([]),level:0,currentUser,presence,validation});const reconciled=immutableReconcile(prev.current,next);prev.current=reconciled;return reconciled;},[schemaType,value,fieldGroupState,collapsedFieldSets,collapsedPaths,comparisonValue,focusPath,openPath,currentUser,presence,validation]);}function useFormValue(path){const uniquePath=useUnique(path);const{getDocument,patchChannel}=useFormBuilder().__internal;const documentValueSubject=useMemo(()=>new Subject(),[]);const documentValue$=useMemo(()=>documentValueSubject.asObservable(),[documentValueSubject]);const[value,setValue]=useState(()=>getValueAtPath(getDocument(),uniquePath));useEffect(()=>patchChannel.subscribe(()=>documentValueSubject.next(getDocument())),[documentValueSubject,getDocument,patchChannel]);useEffect(()=>{const value$=documentValue$.pipe(map(documentValue=>uniquePath.length===0?documentValue:getValueAtPath(documentValue,uniquePath)),distinctUntilChanged((x,y)=>isEqual$1(x,y)));const sub=value$.subscribe(setValue);return()=>sub.unsubscribe();},[documentValue$,uniquePath]);return value;}function toMutationPatches(patches){return patches.map(toMutationPatch);}function fromMutationPatches(origin,patches){return flatten$1(patches.map(patch=>toFormBuilderPatches(origin,patch)));}const notIn=values=>value=>!values.includes(value);function toFormBuilderPatches(origin,patch){return flatten$1(Object.keys(patch).filter(notIn(["id","ifRevisionID","query"])).map(type=>{if(type==="unset"){return patch.unset.map(path=>{return{type:"unset",path:decodePath(path),origin};});}if(type==="insert"){const position="before"in patch.insert?"before":"after";return{type:"insert",position,path:decodePath(patch.insert[position]),items:patch.insert.items,origin};}return Object.keys(patch[type]).map(gradientPath=>{if(type==="set"){return{type:"set",path:decodePath(gradientPath),value:patch[type][gradientPath],origin};}if(type==="inc"||type==="dec"){return{type,path:decodePath(gradientPath),value:patch[type][gradientPath],origin};}if(type==="setIfMissing"){return{type:"setIfMissing",path:decodePath(gradientPath),value:patch[type][gradientPath],origin};}if(type==="diffMatchPatch"){return{type:"diffMatchPatch",path:decodePath(gradientPath),value:patch[type][gradientPath],origin};}console.warn(new Error("Unsupported patch type: ".concat(type)));return null;}).filter(Boolean);}));}function toMutationPatch(patch){const matchPath=arrayToJSONMatchPath(patch.path||[]);if(patch.type==="insert"){const{position,items}=patch;return{insert:{[position]:matchPath,items}};}if(patch.type==="unset"){return{unset:[matchPath]};}if(!patch.type){throw new Error("Missing patch type in patch ".concat(JSON.stringify(patch)));}if(matchPath){return{[patch.type]:{[matchPath]:patch.value}};}return{[patch.type]:patch.value};}function getAnnotationColor(colorManager,annotation){return colorManager.get((annotation==null?void 0:annotation.author)||null);}function getAnnotationAtPath(diff,diffPath){const path=Array.isArray(diffPath)?diffPath:stringToPath(diffPath);return getAnnotationAt(diff,path);}function getDiffAtPath(diff,diffPath){const path=Array.isArray(diffPath)?diffPath:stringToPath(diffPath);return getDiffAt(diff,path);}function getAnnotationAt(diff,path){const diffAt=getDiffAt(diff,path);if(!diffAt){return void 0;}if(diffAt.action==="unchanged"){return void 0;}return diffAt.annotation||void 0;}function getDiffAt(diff,path){let parentPath=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];if(path.length===0){return diff;}const segment=path[0];const tail=path.slice(1);if(isIndexTuple(segment)){throw new Error("Index tuples are not supported in diff paths");}if(isIndexSegment(segment)||isKeySegment(segment)){const location=isIndexSegment(segment)?"at index ".concat(segment):"with key ".concat(segment._key);if(diff.type!=="array"){warn("Failed to get item ".concat(location," at path ").concat(pathToString(parentPath)," (not an array)"));return void 0;}const itemDiff=diff.items.find(isIndexSegment(segment)?item=>item.toIndex===segment:item=>itemMatchesKey(item,segment));if(!itemDiff){warn("Failed to get item ".concat(location," at path ").concat(pathToString(parentPath)," (item missing)"));return void 0;}return getDiffAt(itemDiff.diff,tail,parentPath.concat(segment));}if(diff.type!=="object"){warn("Failed to get property ".concat(segment," at path ").concat(pathToString(parentPath)," (not an object)"));return void 0;}const fieldDiff=diff.fields[segment];if(typeof fieldDiff==="undefined"){warn("Failed to get property ".concat(segment," at path ").concat(pathToString(parentPath)," (field did not exist)"));return void 0;}return getDiffAt(fieldDiff,tail,parentPath.concat(segment));}function warn(msg){}function itemMatchesKey(item,key){const itemDiff=item.diff;return itemDiff.type!=="object"||!itemDiff.toValue?false:itemDiff.toValue._key===key;}function visitDiff(diff,visitor){let path=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];if(!visitor(diff,path)){return;}if(diff.type==="array"){visitArrayDiff(diff,visitor,path);return;}if(diff.type==="object"){visitObjectDiff(diff,visitor,path);return;}if(diff.type==="string"){visitStringDiff(diff,visitor,path);}}function visitArrayDiff(diff,visitor,path){if(diff.action==="unchanged"){return;}diff.items.forEach(itemDiff=>{var _a;const _key=itemDiff.diff.type==="object"&&((_a=itemDiff.diff.toValue)==null?void 0:_a._key);const segment=_key?{_key}:getItemDiffIndex(itemDiff);visitDiff(itemDiff.diff,visitor,path.concat(segment));});}function visitObjectDiff(diff,visitor,path){if(diff.action==="unchanged"){return;}Object.keys(diff.fields).forEach(fieldName=>{const fieldDiff=diff.fields[fieldName];visitDiff(fieldDiff,visitor,path.concat(fieldName));});}function visitStringDiff(diff,visitor,path){if(diff.action==="unchanged"){return;}diff.segments.forEach(segment=>{visitDiff(segment,visitor,path);});}function getItemDiffIndex(itemDiff){return typeof itemDiff.toIndex==="undefined"?itemDiff.fromIndex||0:itemDiff.toIndex;}function useAnnotationColor(annotation){const userColorManager=useUserColorManager();return getAnnotationColor(userColorManager,annotation);}function useDiffAnnotationColor(diff){let path=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];const userColorManager=useUserColorManager();const annotation=useMemo(()=>getAnnotationAtPath(diff,path),[diff,path]);return useMemo(()=>getAnnotationColor(userColorManager,annotation),[annotation,userColorManager]);}function isThenable(value){return isRecord$2(value)&&typeof(value==null?void 0:value.then)==="function";}function useCheckCondition(checkProperty,checkPropertyName,context){const{currentUser,document,parent,value}=context;const didWarn=useRef(false);return useMemo(()=>{let isTrueIsh=false;if(typeof checkProperty==="boolean"||checkProperty===void 0){return checkProperty||false;}try{isTrueIsh=checkProperty({document,parent,value,currentUser});}catch(err){console.error("An error occurred while running the callback from `".concat(checkPropertyName,"`: ").concat(err.message));return false;}if(isThenable(isTrueIsh)&&!didWarn.current){console.warn("The `".concat(checkPropertyName,"` option is either a promise or a promise returning function. Async callbacks for `").concat(checkPropertyName,"` option is not currently supported."));return false;}if(typeof isTrueIsh==="undefined"){console.warn("The `".concat(checkPropertyName,"` option is or returned `undefined`. `").concat(checkPropertyName,"` should return a boolean."));}return isTrueIsh;},[checkProperty,document,parent,value,currentUser,checkPropertyName]);}const useConditionalProperty=props=>{const{checkProperty=false,checkPropertyKey,document,parent,value:valueProp}=props;const value=useUnique(valueProp);const currentUser=useCurrentUser();const isPropertyTruthy=useCheckCondition(checkProperty,checkPropertyKey,{currentUser,document,parent,value});return isPropertyTruthy;};const DiffContext=createContext({path:[]});function getValueError(value,schemaType){const{jsonType}=schemaType;const valueType=Array.isArray(value)?"array":typeof value;if(value===null||valueType==="undefined"){return void 0;}if(valueType!==jsonType){return{message:"Value is ".concat(valueType,", expected ").concat(jsonType),value};}if(isObjectType(schemaType)&&isObjectValue(value)){for(const field of schemaType.fields){const fieldError=getValueError(value[field.name],field.type);if(fieldError){return fieldError;}}}return void 0;}function isObjectType(schemaType){return schemaType.jsonType==="object";}function isObjectValue(value){return value!==null&&!Array.isArray(value)&&typeof value==="object";}function resolveTypeName(value){return isTypedObject(value)?value._type:resolveJSType(value);}function getArrayDiffItemType(diff,schemaType){if(diff.action==="added"){return{toType:resolveArrayMemberType(schemaType,diff.toValue)};}if(diff.action==="changed"){return{fromType:resolveArrayMemberType(schemaType,diff.fromValue),toType:resolveArrayMemberType(schemaType,diff.toValue)};}if(diff.action==="removed"){return{fromType:resolveArrayMemberType(schemaType,diff.fromValue)};}return{toType:resolveArrayMemberType(schemaType,diff.toValue)};}function resolveArrayMemberType(schemaType,value){const typeName=resolveTypeName(value);const declared=schemaType.of.find(candidate=>candidate.name===typeName);if(declared){return declared;}return schemaType.of.length===1?schemaType.of[0]:void 0;}function resolveJSType(val){if(Array.isArray(val)){return"array";}if(val===null){return"null";}return typeof val;}const ANNOTATION_SYMBOLS=[["\uF050","\uF051"],["\uF052","\uF053"],["\uF054","\uF055"],["\uF056","\uF057"],["\uF058","\uF059"],["\uF05A","\uF05B"],["\uF05C","\uF05D"],["\uF05F","\uF060"],["\uF061","\uF062"],["\uF063","\uF064"],["\uF065","\uF066"],["\uF067","\uF068"],["\uF069","\uF06A"],["\uF06B","\uF06C"],["\uF06E","\uF06F"],["\uF070","\uF071"],["\uF072","\uF073"],["\uF074","\uF075"],["\uF076","\uF077"],["\uF078","\uF079"],["\uF07A","\uF07B"],["\uF07C","\uF07D"],["\uF07E","\uF07F"],["\uF080","\uF081"],["\uF082","\uF083"],["\uF084","\uF085"],["\uF086","\uF087"],["\uF088","\uF089"],["\uF08A","\uF08B"],["\uF08C","\uF08D"],["\uF08E","\uF08F"]];const CHILD_SYMBOL="\uF0D0";const DECORATOR_SYMBOLS=[["\uF000","\uF001"],["\uF002","\uF003"],["\uF004","\uF005"],["\uF006","\uF007"],["\uF008","\uF009"],["\uF00A","\uF00B"],["\uF00C","\uF00D"],["\uF00F","\uF010"],["\uF011","\uF012"],["\uF013","\uF014"],["\uF015","\uF016"],["\uF017","\uF018"],["\uF019","\uF01A"],["\uF01B","\uF01C"],["\uF01E","\uF01F"],["\uF020","\uF021"]];const EMPTY_BLOCK_SYMBOL="\u21B2";const INLINE_SYMBOLS=["\uF090","\uF091","\uF092","\uF093","\uF094","\uF095","\uF096","\uF097","\uF098","\uF099","\uF09A","\uF09B","\uF09C","\uF09D","\uF09E","\uF09F","\uF0A0","\uF0A1","\uF0A2","\uF0A3","\uF0A4","\uF0A5","\uF0A6","\uF0A7","\uF0A8","\uF0A9","\uF0AA","\uF0AB","\uF0AC","\uF0AD","\uF0AE","\uF0AF","\uF0B0","\uF0B1","\uF0B2","\uF0B3","\uF0B4","\uF0B5","\uF0B6","\uF0B7","\uF0B8","\uF0B9","\uF0BA","\uF0BB","\uF0BC","\uF0BD","\uF0BE","\uF0BF"];const TRAILING_SPACE_SYMBOL="\u205F";const SEGMENT_START_SYMBOL="\u2060";const dmp$1=new diff_match_patch();function hasPTMemberType(schemaType){return schemaType.of.some(isPTSchemaType);}const startMarkSymbols=DECORATOR_SYMBOLS.map(set=>set[0]).concat(ANNOTATION_SYMBOLS.map(set=>set[0]));const endMarkSymbols=DECORATOR_SYMBOLS.map(set=>set[1]).concat(ANNOTATION_SYMBOLS.map(set=>set[1]));const allSymbols=startMarkSymbols.concat(endMarkSymbols).concat(INLINE_SYMBOLS).concat(CHILD_SYMBOL).concat(SEGMENT_START_SYMBOL);const symbolRegex=new RegExp("".concat(allSymbols.join("|")),"g");const segmentRegex=new RegExp("".concat(allSymbols.join("|"),"|\n"),"g");function isPTSchemaType(schemaType){return schemaType.jsonType==="object"&&schemaType.name==="block";}function isHeader(node){return!!node.style&&["h1","h2","h3","h4","h5","h6"].includes(node.style);}function findChildDiff(diff,child){const childrenDiff=diff.fields.children;return childrenDiff.items.filter(item=>item.diff.isChanged&&(item.diff.toValue===child||item.diff.fromValue===child)).map(item=>item.diff).map(childDiff=>childDiff)[0];}function getChildSchemaType(fields,child){const childrenField=fields.find(f=>f.name==="children");const cSchemaType=childrenField&&childrenField.type&&childrenField.type.jsonType==="array"&&childrenField.type.of.find(type=>type.name===child._type)||void 0;return cSchemaType;}function getDecorators(spanSchemaType){if(spanSchemaType.decorators){return orderBy(spanSchemaType.decorators,["value"],["asc"]);}return[];}function isDecorator(name,schemaType){return getDecorators(schemaType).some(dec=>dec.value===name);}function blockToSymbolizedText(diff,block,decoratorMap,annotationMap,inlineMap){if(!block){return"";}return block.children.map(child=>{var _a;let returned=((_a=child.text)==null?void 0:_a.replace(symbolRegex,""))||"";if(child._type==="span"){const spanDiff=findSpanDiffFromChild(diff,child);const textDiff=spanDiff==null?void 0:spanDiff.fields.text;if(textDiff&&textDiff.toValue===child.text&&textDiff.type==="string"&&textDiff.action!=="unchanged"){returned=textDiff.segments.filter(seg=>seg.action!=="removed").map(seg=>seg.text.replace(symbolRegex,"")).join(SEGMENT_START_SYMBOL);}if(child.marks){child.marks.forEach(mark=>{const _isDecorator=!!decoratorMap[mark];if(_isDecorator){returned="".concat(decoratorMap[mark][0]).concat(returned).concat(decoratorMap[mark][1]);}else if(annotationMap[mark]){returned="".concat(annotationMap[mark][0]).concat(returned).concat(annotationMap[mark][1]);}});}}else{returned=inlineMap[child._key];}return"".concat(CHILD_SYMBOL).concat(returned);}).join("");}function createPortableTextDiff(diff,schemaType){const displayValue=diff.action==="removed"?diff.fromValue:diff.toValue;const _diff=_objectSpread(_objectSpread({},diff),{},{origin:diff,displayValue});if(displayValue){const annotationMap={};const decoratorMap={};const inlineMap={};const spanSchemaType=getChildSchemaType(schemaType.fields,{_key:"bogus",_type:"span"});if(spanSchemaType){getDecorators(spanSchemaType).forEach((dec,index)=>{decoratorMap[dec.value]=DECORATOR_SYMBOLS[index];});}const allMarkDefs=getAllMarkDefs(_diff.origin);allMarkDefs.forEach((markDef,index)=>{annotationMap[markDef._key]=ANNOTATION_SYMBOLS[index];});const inlines=getInlineObjects(_diff.origin);inlines.forEach((inline,index)=>{inlineMap[inline._key]=INLINE_SYMBOLS[index];});const fromText=blockToSymbolizedText(_diff.origin,_diff.fromValue,decoratorMap,annotationMap,inlineMap);const toText=blockToSymbolizedText(_diff.origin,_diff.toValue,decoratorMap,annotationMap,inlineMap);const toPseudoValue=_objectSpread(_objectSpread({},displayValue),{},{children:[{_type:"span",_key:"pseudoSpanKey",text:toText,marks:[]}]});const fromPseudoValue={displayValue,children:[{_type:"span",_key:"pseudoSpanKey",text:fromText,marks:[]}]};const pseudoDiff={origin:diff,action:"changed",type:"object",displayValue:toPseudoValue,fromValue:fromPseudoValue,toValue:toPseudoValue,isChanged:true,fields:{children:{action:"changed",type:"array",isChanged:true,items:[{diff:{action:"changed",type:"object",isChanged:true,fields:{text:{type:"string",action:"changed",isChanged:true,fromValue:fromText,toValue:toText,segments:buildSegments(fromText,toText).map(seg=>_objectSpread(_objectSpread({},seg),_diff.action!=="unchanged"&&_diff.annotation?{annotation:_diff.annotation}:{}))}},fromValue:fromPseudoValue.children[0],toValue:toPseudoValue.children[0]},annotation:null,fromIndex:0,toIndex:0,hasMoved:false}],fromValue:fromPseudoValue.children,toValue:toPseudoValue.children}}};return pseudoDiff;}throw new Error("Can not display this diff");}function buildSegments(fromInput,toInput){const segments=[];const dmpDiffs=dmp$1.diff_main(fromInput,toInput);dmp$1.diff_cleanupEfficiency(dmpDiffs);let fromIdx=0;let toIdx=0;for(const[op,text]of dmpDiffs){switch(op){case DIFF_EQUAL:segments.push({type:"stringSegment",action:"unchanged",text});fromIdx+=text.length;toIdx+=text.length;break;case DIFF_DELETE:segments.push({type:"stringSegment",action:"removed",text:fromInput.substring(fromIdx,fromIdx+text.length),annotation:null});fromIdx+=text.length;break;case DIFF_INSERT:segments.push({type:"stringSegment",action:"added",text:toInput.substring(toIdx,toIdx+text.length),annotation:null});toIdx+=text.length;break;}}return flatten$1(segments.map(seg=>{const newSegments=[];if(seg.text.length>1){const markMatches=[...seg.text.matchAll(segmentRegex)];let lastIndex=-1;markMatches.forEach(match=>{const index=match.index||0;if(index>lastIndex){newSegments.push(_objectSpread(_objectSpread({},seg),{},{text:seg.text.substring(lastIndex+1,index)}));newSegments.push(_objectSpread(_objectSpread({},seg),{},{text:match[0]}));}if(match===markMatches[markMatches.length-1]){newSegments.push(_objectSpread(_objectSpread({},seg),{},{text:seg.text.substring(index+1)}));}lastIndex=index;});if(markMatches.length===0){newSegments.push(seg);}}else{newSegments.push(seg);}return newSegments;}));}function getInlineObjects(diff){const allChildren=[...(diff.toValue?diff.toValue.children.filter(cld=>cld._type!=="span"):[])];const previousChildren=diff.fromValue?diff.fromValue.children.filter(cld=>cld._type!=="span"):[];previousChildren.forEach(oCld=>{if(!allChildren.some(cld=>oCld._key===cld._key)){allChildren.push(oCld);}});return orderBy(allChildren,["_key"],["asc"]);}function findSpanDiffFromChild(diff,child){const candidate=diff.fields.children&&diff.fields.children.action!=="unchanged"&&diff.fields.children.type==="array"&&diff.fields.children.items.find(item=>item.diff&&item.diff.type==="object"&&(item.diff.action==="removed"?item.diff.fromValue&&item.diff.fromValue._key===child._key:(item.diff.toValue&&item.diff.toValue._key)===child._key));if(candidate){return candidate.diff;}return void 0;}function findAnnotationDiff(diff,markDefKey){var _a;return diff.fields.markDefs&&diff.fields.markDefs.isChanged&&diff.fields.markDefs.type==="array"&&((_a=diff.fields.markDefs.items.find(item=>item.diff&&item.diff.type==="object"&&(item.diff.toValue&&item.diff.toValue._key&&item.diff.toValue._key===markDefKey||item.diff.fromValue&&item.diff.fromValue._key&&item.diff.fromValue._key===markDefKey)))==null?void 0:_a.diff)||void 0;}function isEmptyObject(object){return object&&isEqual$1(Object.keys(object),["_key","_type"])||false;}function escapeRegExp(text){return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");}function getAllMarkDefs(diff){const allDefs=[...(diff.toValue&&diff.toValue.markDefs?diff.toValue.markDefs:[])];const oldDefs=diff.fromValue&&diff.fromValue.markDefs?diff.fromValue.markDefs:[];oldDefs.forEach(oDef=>{if(!allDefs.some(def=>oDef._key===def._key)){allDefs.push(oDef);}});return orderBy(allDefs,["_key"],["asc"]);}const diffResolvers=[];function Checkbox(_ref254){let{checked,color}=_ref254;return/* @__PURE__ */jsxs("svg",{width:"17",height:"17",viewBox:"0 0 17 17",xmlns:"http://www.w3.org/2000/svg",fill:color==null?void 0:color.background,children:[/* @__PURE__ */jsx("rect",{x:"0",y:"0",width:"17",height:"17",rx:"2.5"}),typeof checked==="undefined"&&/* @__PURE__ */jsx("path",{d:"M4.07996 8.5H12.92",stroke:color==null?void 0:color.text,strokeWidth:"2"}),checked&&/* @__PURE__ */jsx("path",{d:"M3.5 8L7 11.5L13.5 5",stroke:color==null?void 0:color.text,strokeWidth:"2"})]});}function Switch(_ref255){let{checked,color}=_ref255;return/* @__PURE__ */jsxs("svg",{width:"38",height:"22",viewBox:"0 0 38 22",xmlns:"http://www.w3.org/2000/svg",children:[/* @__PURE__ */jsx("rect",{width:"38",height:"22",rx:"11",fill:checked?color==null?void 0:color.border:color==null?void 0:color.background}),typeof checked==="undefined"&&/* @__PURE__ */jsx("rect",{x:"11",y:"3",width:"16",height:"16",rx:"8",fill:"white"}),checked&&/* @__PURE__ */jsx("rect",{x:"18",y:"3",width:"16",height:"16",rx:"8",fill:"white"}),typeof checked==="boolean"&&!checked&&/* @__PURE__ */jsx("rect",{x:"4",y:"3",width:"16",height:"16",rx:"8",fill:"white"})]});}const BooleanFieldDiff=_ref256=>{let{diff,schemaType}=_ref256;const{fromValue,toValue}=diff;const{title,options}=schemaType;const Preview=(options==null?void 0:options.layout)==="checkbox"?Checkbox:Switch;const userColor=useDiffAnnotationColor(diff,[]);const showToValue=toValue!==void 0&&toValue!==null;return/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(DiffTooltip,{diff,children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Preview,{checked:fromValue,color:userColor}),showToValue&&/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Box,{marginX:2,children:/* @__PURE__ */jsx(FromToArrow,{})}),/* @__PURE__ */jsx(Preview,{checked:toValue,color:userColor})]})]})}),showToValue&&title&&/* @__PURE__ */jsx(Box,{marginLeft:2,children:/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:title})})]});};const DocumentChangeContext=createContext(null);function useDocumentChange(){const documentChange=useContext(DocumentChangeContext);if(!documentChange){throw new Error("DocumentChange: missing context value");}return documentChange;}function useRefValue(refId){const[value,setValue]=useState(void 0);const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);useEffect(()=>{if(!refId){return void 0;}const subscription=client.observable.getDocument(refId).subscribe(setValue);return()=>{subscription.unsubscribe();};},[client,refId]);return refId?value:void 0;}function getSizeDiff(prev,next){if(!prev||!next){return 0;}const increase=next-prev;const pct=Math.round(increase/prev*100);return pct;}const SizeDiff=styled.div(_templateObject208||(_templateObject208=_taggedTemplateLiteral(["\n  ","\n  &:not([hidden]) {\n    display: inline-block;\n  }\n\n  [data-number='positive'] {\n    color: var(--size-diff-positive);\n  }\n\n  [data-number='negative'] {\n    color: var(--size-diff-negative);\n  }\n"])),_ref257=>{let{theme}=_ref257;return"\n    --size-diff-positive: ".concat(theme.sanity.color.solid.positive.enabled.bg,";\n    --size-diff-negative: ").concat(theme.sanity.color.solid.critical.enabled.bg,";\n  ");});const FileFieldDiff=_ref258=>{let{diff,schemaType}=_ref258;const{fromValue,toValue,fields}=diff;const fromAsset=fromValue==null?void 0:fromValue.asset;const toAsset=toValue==null?void 0:toValue.asset;const prev=useRefValue(fromAsset==null?void 0:fromAsset._ref);const next=useRefValue(toAsset==null?void 0:toAsset._ref);const changedFields=Object.entries(fields).filter(_ref259=>{let[name,field]=_ref259;return field.isChanged&&name!=="_type";}).map(_ref260=>{let[name]=_ref260;return name;});const didAssetChange=changedFields.includes("asset");const nestedFields=schemaType.fields.filter(field=>field.name!=="asset"&&changedFields.includes(field.name)).map(field=>field.name);const prevSize=(prev==null?void 0:prev.size)&&prev.size/1e3/1e3;const nextSize=(next==null?void 0:next.size)&&next.size/1e3/1e3;const pctDiff=getSizeDiff(prevSize,nextSize);const roundedPrevSize=prevSize?prevSize.toFixed(2):void 0;const roundedNextSize=nextSize?nextSize.toFixed(2):void 0;const cardStyles=useMemo(()=>({display:"block",flex:1}),[]);const from=prev&&/* @__PURE__ */jsx(DiffCard,{as:"del",diff,path:"asset._ref",style:cardStyles,children:/* @__PURE__ */jsx(MetaInfo,{title:prev.originalFilename||"Untitled",icon:DocumentIcon,children:/* @__PURE__ */jsx(Text$1,{size:0,style:{color:"inherit"},children:"".concat(roundedPrevSize,"MB")})})});const to=next&&/* @__PURE__ */jsx(DiffCard,{as:"ins",diff,path:"asset._ref",style:cardStyles,children:/* @__PURE__ */jsx(MetaInfo,{title:next.originalFilename||"Untitled",icon:DocumentIcon,children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Text$1,{size:0,style:{color:"inherit"},children:"".concat(roundedNextSize,"MB")}),pctDiff!==0&&/* @__PURE__ */jsx(Card,{radius:2,padding:1,as:SizeDiff,marginLeft:2,children:/* @__PURE__ */jsxs(Text$1,{size:0,"data-number":pctDiff>0?"positive":"negative",children:[pctDiff>0&&"+",pctDiff,"%"]})})]})})});const FileAssetChange=/* @__PURE__ */jsxs(Fragment,{children:[from&&!to&&/* @__PURE__ */jsx(DiffTooltip,{diff,path:"asset._ref",description:"Removed",children:from}),from&&to&&/* @__PURE__ */jsx(DiffTooltip,{diff,path:"asset._ref",children:/* @__PURE__ */jsx(FromTo,{from,layout:"grid",to})}),!from&&to&&/* @__PURE__ */jsx(DiffTooltip,{diff,path:"asset._ref",description:"Added",children:to})]});return/* @__PURE__ */jsxs(Fragment,{children:[didAssetChange&&FileAssetChange,nestedFields.length>0&&/* @__PURE__ */jsx(Box,{marginTop:didAssetChange?4:3,children:/* @__PURE__ */jsx(ChangeList,{diff,schemaType,fields:nestedFields})})]});};function hexToRgba(hex,opacity){const rgba=(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)||[]).slice(1).map(num=>parseInt(num,16)).concat(opacity);return"rgba(".concat(rgba.join(", "),")");}function simpleHash(str){let hash=0;if(str.length==0){return hash.toString();}for(let i=0;i<str.length;i++){const char=str.charCodeAt(i);hash=(hash<<5)-hash+char;hash&=hash;}return hash.toString();}function getDeviceDpr(){const base=Math.ceil(window.devicePixelRatio||1);return Math.min(3,Math.max(1,base));}function HotspotCropSVG(props){const{crop,diff,hash,hotspot,width=100,height=100}=props,restProps=_objectWithoutProperties(props,_excluded56);const cropColor=useDiffAnnotationColor(diff,"crop");const hotspotColor=useDiffAnnotationColor(diff,"hotspot");return/* @__PURE__ */jsxs("svg",_objectSpread(_objectSpread({},restProps),{},{fill:"none",width,height,viewBox:"0 0 ".concat(width," ").concat(height),children:[/* @__PURE__ */jsx("defs",{children:crop&&hotspot&&/* @__PURE__ */jsxs("mask",{id:"mask-hotspot-".concat(hash),children:[/* @__PURE__ */jsx("rect",{x:0,y:0,width,height,fill:"#fff"}),/* @__PURE__ */jsx(HotspotSVG,{hotspot,fill:"#000",offset:1,width,height,stroke:"#000",strokeWidth:3})]})}),crop&&/* @__PURE__ */jsx(DiffTooltip,{diff,path:"crop",description:"Crop changed",children:/* @__PURE__ */jsx("g",{children:/* @__PURE__ */jsx(CropSVG,{crop,fill:hexToRgba(cropColor.border,0.25),mask:hotspot?"url(#mask-hotspot-".concat(hash,")"):void 0,stroke:cropColor.border,strokeWidth:1,width,height})})}),hotspot&&/* @__PURE__ */jsx(DiffTooltip,{diff,path:"hotspot",description:"Hotspot changed",children:/* @__PURE__ */jsx("g",{children:/* @__PURE__ */jsx(HotspotSVG,{hotspot,fill:hexToRgba(hotspotColor.border,0.25),stroke:hotspotColor.border,strokeWidth:1,width,height})})})]}));}function CropSVG(_ref261){let{crop,width,height}=_ref261,restProps=_objectWithoutProperties(_ref261,_excluded57);const rectProps={x:crop.left*width,y:crop.top*height,width:(1-crop.right-crop.left)*width,height:(1-crop.bottom-crop.top)*height};return/* @__PURE__ */jsx("rect",_objectSpread(_objectSpread(_objectSpread({},restProps),rectProps),{},{style:{vectorEffect:"non-scaling-stroke"}}));}function HotspotSVG(_ref262){let{hotspot,offset=0,width,height}=_ref262,restProps=_objectWithoutProperties(_ref262,_excluded58);const ellipseProps={cx:hotspot.x*width,cy:hotspot.y*height,rx:hotspot.width/2*width+offset,ry:hotspot.height/2*height+offset};return/* @__PURE__ */jsx("ellipse",_objectSpread(_objectSpread(_objectSpread({},restProps),ellipseProps),{},{style:{vectorEffect:"non-scaling-stroke"}}));}const ASSET_FIELDS=["originalFilename"];const NoImagePreview=()=>/* @__PURE__ */jsx(Card,{flex:1,tone:"transparent",padding:4,radius:2,height:"stretch",children:/* @__PURE__ */jsx(Flex,{align:"center",justify:"center",height:"fill",children:/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:"(no image)"})})});const ImageWrapper=styled.div(_templateObject209||(_templateObject209=_taggedTemplateLiteral(["\n  height: 100%;\n  max-height: 190px;\n  position: relative;\n\n  /* Ideally the checkerboard component currently in the form builder should be made available and used here */\n  background-color: ",";\n  background-image: linear-gradient(45deg, "," 25%, transparent 25%),\n    linear-gradient(-45deg, "," 25%, transparent 25%),\n    linear-gradient(45deg, transparent 75%, "," 75%),\n    linear-gradient(-45deg, transparent 75%, "," 75%);\n  background-size: 16px 16px;\n  background-position: 0 0, 0 8px, 8px -8px, -8px 0;\n\n  &::after {\n    content: '';\n    display: block;\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    box-shadow: inset 0 0 0 1px var(--card-border-color);\n    pointer-events: none;\n  }\n\n  &[data-changed] {\n    opacity: 0.45;\n  }\n"])),hues.gray[100].hex,hues.gray[50].hex,hues.gray[50].hex,hues.gray[50].hex,hues.gray[50].hex);const Image$1=styled.img(_templateObject210||(_templateObject210=_taggedTemplateLiteral(["\n  display: block;\n  flex: 1;\n  min-height: 0;\n  object-fit: contain;\n  width: 100%;\n  height: 100%;\n\n  &[data-action='removed'] {\n    opacity: 0.45;\n  }\n"])));const HotspotDiff=styled.div(_templateObject211||(_templateObject211=_taggedTemplateLiteral(["\n  svg {\n    display: block;\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n  }\n"])));function ImagePreview$1(props){var _a,_b,_c,_d;const{id,action,diff,hotspot,crop,is}=props;const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const[imageError,setImageError]=React.useState();const{value:asset}=useDocumentValues(id,ASSET_FIELDS);const dimensions=getImageDimensions(id);const imageBuilder=useMemo(()=>imageUrlBuilder(client),[client]);const assetIsDeleted=asset===null;const title=asset&&asset.originalFilename||"Untitled";const imageSource=imageBuilder.image(id).height(190).dpr(getDeviceDpr()).fit("max");const assetChanged=((_b=(_a=diff.fromValue)==null?void 0:_a.asset)==null?void 0:_b._ref)!==((_d=(_c=diff.toValue)==null?void 0:_c.asset)==null?void 0:_d._ref);const metaAction=action==="changed"?void 0:action;return/* @__PURE__ */jsxs(Flex,{direction:"column",height:"fill",flex:1,children:[/* @__PURE__ */jsx(Box,{flex:1,padding:2,paddingBottom:0,children:/* @__PURE__ */jsxs(Flex,{as:ImageWrapper,direction:"column","data-changed":is==="from"&&assetChanged?"":void 0,"data-error":imageError?"":void 0,children:[!assetIsDeleted&&!imageError&&/* @__PURE__ */jsx(Image$1,{src:imageSource.toString()||"",alt:title,"data-action":metaAction,onError:setImageError,width:dimensions.width,height:dimensions.height}),(assetIsDeleted||imageError)&&/* @__PURE__ */jsx(Box,{paddingY:5,children:/* @__PURE__ */jsx(Text$1,{size:1,muted:true,align:"center",children:assetIsDeleted?"Image is deleted":"Error loading image"})}),/* @__PURE__ */jsx(HotspotDiff,{children:/* @__PURE__ */jsx(HotspotCropSVG,{crop:crop&&!isDefaultCrop(crop)?crop:void 0,diff,hash:simpleHash("".concat(imageSource.toString()||"","-").concat(is)),hotspot:hotspot&&!isDefaultHotspot(hotspot)?hotspot:void 0,width:dimensions.width,height:dimensions.height})})]})}),/* @__PURE__ */jsx(MetaInfo,{title,icon:ImageIcon,markRemoved:assetChanged&&is==="from",children:metaAction?/* @__PURE__ */jsx("div",{children:metaAction}):/* @__PURE__ */jsxs("div",{children:[dimensions.width," \xD7 ",dimensions.height]})})]});}const IMAGE_META_FIELDS=["crop","hotspot"];const BASE_IMAGE_FIELDS=["asset",...IMAGE_META_FIELDS];const CARD_STYLES={flex:1};const ImageFieldDiff=_ref263=>{let{diff,schemaType}=_ref263;var _a,_b;const{fromValue,toValue,fields,isChanged}=diff;const fromRef=(_a=fromValue==null?void 0:fromValue.asset)==null?void 0:_a._ref;const toRef=(_b=toValue==null?void 0:toValue.asset)==null?void 0:_b._ref;const assetAnnotation=getAnnotationAtPath(diff,["asset","_ref"]);const changedFields=Object.keys(fields).filter(name=>fields[name].isChanged&&name!=="_type");const nestedFields=schemaType.fields.filter(field=>!BASE_IMAGE_FIELDS.includes(field.name)&&changedFields.includes(field.name)).map(field=>field.name);let assetAction="changed";if(!fromRef&&toRef){assetAction="added";}else if(!toRef&&fromRef){assetAction="removed";}const didAssetChange=changedFields.includes("asset");const didCropChange=changedFields.includes("crop");const didHotspotChange=changedFields.includes("hotspot");const didMetaChange=didCropChange||didHotspotChange;const showImageDiff=didAssetChange||didMetaChange;const showMetaChange=didMetaChange&&!didAssetChange;const from=fromValue&&fromRef?/* @__PURE__ */jsx(DiffCard,{annotation:assetAnnotation,style:CARD_STYLES,children:/* @__PURE__ */jsx(ImagePreview$1,{is:"from",id:fromRef,diff,action:assetAction,hotspot:showMetaChange&&didHotspotChange?fromValue.hotspot:void 0,crop:showMetaChange&&didCropChange?fromValue.crop:void 0})}):/* @__PURE__ */jsx(NoImagePreview,{});const to=toValue&&toRef?/* @__PURE__ */jsx(DiffCard,{annotation:assetAnnotation,style:CARD_STYLES,children:/* @__PURE__ */jsx(ImagePreview$1,{is:"to",id:toRef,diff,hotspot:showMetaChange&&didHotspotChange?toValue.hotspot:void 0,crop:showMetaChange&&didCropChange?toValue.crop:void 0})}):/* @__PURE__ */jsx(NoImagePreview,{});if(!from&&!to){return/* @__PURE__ */jsx(Card,{padding:4,radius:2,tone:"transparent",children:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,align:"center",children:"Image not set"})});}if(!isChanged){return toRef?/* @__PURE__ */jsx(DiffCard,{annotation:assetAnnotation,style:CARD_STYLES,children:/* @__PURE__ */jsx(ImagePreview$1,{id:toRef,is:"to",diff})}):null;}const imageDiff=/* @__PURE__ */jsx(FromTo,{align:"center",from,layout:"grid",to});return/* @__PURE__ */jsxs(Fragment,{children:[showImageDiff&&(didAssetChange?/* @__PURE__ */jsx(DiffTooltip,{annotations:assetAnnotation?[assetAnnotation]:[],description:"".concat(assetAction[0].toUpperCase()).concat(assetAction.slice(1)),children:imageDiff}):imageDiff),nestedFields.length>0&&/* @__PURE__ */jsx(Box,{marginTop:showImageDiff?4:3,children:/* @__PURE__ */jsx(ChangeList,{diff,schemaType,fields:nestedFields})})]});};const NumberWrapper=styled.div(_templateObject212||(_templateObject212=_taggedTemplateLiteral(["\n  display: inline-block;\n  word-break: break-all;\n"])));const NumberPreview=props=>{const{value}=props;return/* @__PURE__ */jsx(Box,{as:NumberWrapper,paddingX:2,paddingY:1,children:value});};const NumberFieldDiff=_ref264=>{let{diff,schemaType}=_ref264;return/* @__PURE__ */jsx(DiffFromTo,{diff,schemaType,previewComponent:NumberPreview,layout:"inline"});};const Quote=styled.blockquote(_templateObject213||(_templateObject213=_taggedTemplateLiteral(["\n  margin: 0;\n"])));function Blockquote(_ref265){let{children}=_ref265;return/* @__PURE__ */jsx("div",{children:/* @__PURE__ */jsx(Quote,{children})});}const headingSizes={h1:2,h2:1,h3:0,h4:0,h5:0,h6:0};const StyledHeading=styled(Heading)(_templateObject214||(_templateObject214=_taggedTemplateLiteral(["\n  &:not([hidden]) {\n    display: inline;\n    text-transform: none;\n    margin: 0;\n\n    &::before,\n    &::after {\n      content: unset;\n    }\n  }\n"])));function Header(_ref266){let{style,children}=_ref266;return/* @__PURE__ */jsx(StyledHeading,{size:headingSizes[style],children});}const StyledParagraph=styled.p(_templateObject215||(_templateObject215=_taggedTemplateLiteral(["\n  text-transform: none;\n  white-space: wrap;\n  overflow-wrap: break-word;\n  margin: 0;\n"])));function Paragraph(_ref267){let{children}=_ref267;return/* @__PURE__ */jsx(StyledParagraph,{children});}const EMPTY_PATH$1=[];function Block(props){var _a,_b,_c;const{diff,block,children}=props;const color=useDiffAnnotationColor(diff,EMPTY_PATH$1);const{path:fullPath}=useContext(DiffContext);const{onSetFocus}=useContext(ConnectorContext);const isRemoved=diff.action==="removed";let returned=children;const handleClick=useCallback(event=>{event.stopPropagation();if(!isRemoved){onSetFocus(fullPath);}},[fullPath,isRemoved,onSetFocus]);if(block.style==="blockquote"){returned=/* @__PURE__ */jsx(Blockquote,{children:returned});}else if(block.style&&isHeader(block)){returned=/* @__PURE__ */jsx(Header,{style:block.style,children:returned});}else{returned=/* @__PURE__ */jsx(Paragraph,{children:returned});}let fromStyle;if(diff.origin.action==="changed"&&diff.origin.fields.style&&diff.origin.fields.style.action==="changed"&&diff.origin.fields.style.annotation){fromStyle=(_b=(_a=diff==null?void 0:diff.origin)==null?void 0:_a.fromValue)==null?void 0:_b.style;const style=color?{background:color.background,color:color.text}:{};returned=/* @__PURE__ */jsx(Card,{padding:3,border:true,radius:2,style:{borderStyle:"dotted"},"diff-block-action":diff.action,"data-block-note":"changed_from_style_".concat(fromStyle||"undefined"),children:/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsx(DiffTooltip,{annotations:[(_c=diff.origin.fields.style)==null?void 0:_c.annotation],diff:diff.origin.fields.style,children:/* @__PURE__ */jsxs(Text$1,{size:0,children:["Changed block style from '",fromStyle,"'"]})}),/* @__PURE__ */jsx(Box,{style,children:returned})]})});}return/* @__PURE__ */jsx("div",{onClick:handleClick,"diff-block-action":diff.action,"data-block-note":"changed_from_style_".concat(fromStyle||"undefined"),children:returned});}const InlineBox=styled(Box)(_templateObject216||(_templateObject216=_taggedTemplateLiteral(["\n  &:not([hidden]) {\n    display: inline;\n    align-items: center;\n\n    &[data-changed] {\n      cursor: pointer;\n    }\n  }\n"])));const InlineText=styled(Text$1)(_templateObject217||(_templateObject217=_taggedTemplateLiteral(["\n  &:not([hidden]) {\n    display: inline;\n    color: inherit;\n  }\n"])));const PreviewContainer=styled(Box)(_templateObject218||(_templateObject218=_taggedTemplateLiteral(["\n  &:not([hidden]) {\n    display: inline-flex;\n    align-items: center;\n\n    "," [data-ui=\"Text\"] {\n      opacity: 0.5;\n    }\n  }\n"])),InlineBox);const PopoverContainer=styled(Box)(_templateObject219||(_templateObject219=_taggedTemplateLiteral(["\n  min-width: 160px;\n  max-height: 40vh;\n  overflow-y: auto;\n"])));const AnnotationWrapper=styled.div(_templateObject220||(_templateObject220=_taggedTemplateLiteral(["\n  text-decoration: none;\n  display: inline;\n  position: relative;\n  border: 0;\n  padding: 0;\n  border-bottom: 2px dotted currentColor;\n  box-shadow: inset 0 0 0 1px var(--card-border-color);\n  white-space: nowrap;\n  align-items: center;\n  background-color: color(var(--card-fg-color) a(10%));\n\n  &[data-changed] {\n    cursor: pointer;\n  }\n\n  &[data-removed] {\n    text-decoration: line-through;\n  }\n\n  &:hover "," {\n    opacity: 1;\n  }\n"])),PreviewContainer);function Annotation(_ref268){let{children,diff,object,schemaType,path}=_ref268,restProps=_objectWithoutProperties(_ref268,_excluded59);if(!schemaType){return/* @__PURE__ */jsx(AnnotationWrapper,_objectSpread(_objectSpread({},restProps),{},{children:"Unknown schema type"}));}if(diff&&diff.action!=="unchanged"){return/* @__PURE__ */jsx(AnnnotationWithDiff,_objectSpread(_objectSpread({},restProps),{},{diff,object,schemaType,path,children}));}return/* @__PURE__ */jsx(AnnotationWrapper,{children});}function AnnnotationWithDiff(_ref269){let{diff,children,object,schemaType,path}=_ref269,restProps=_objectWithoutProperties(_ref269,_excluded60);const{onSetFocus}=useContext(ConnectorContext);const{path:fullPath}=useContext(DiffContext);const[popoverElement,setPopoverElement]=useState(null);const color=useDiffAnnotationColor(diff,[]);const style=useMemo(()=>color?{background:color.background,color:color.text}:{},[color]);const isRemoved=diff.action==="removed";const[open,setOpen]=useState(false);const emptyObject=object&&isEmptyObject(object);const markDefPath=useMemo(()=>[path[0]].concat(["markDefs",{_key:object._key}]),[object._key,path]);const prefix=useMemo(()=>fullPath.slice(0,fullPath.findIndex(seg=>isKeySegment(seg)&&seg._key===object._key)),[fullPath,object._key]);const annotationPath=useMemo(()=>prefix.concat(path),[path,prefix]);const myPath=useMemo(()=>prefix.concat(markDefPath),[markDefPath,prefix]);const myValue="field-".concat(toString(myPath));const values=useReportedValues();const isEditing=useMemo(()=>values.filter(_ref270=>{let[p]=_ref270;return p.startsWith(myValue);}).length>0,[myValue,values]);useEffect(()=>{if(!open&&isEditing){setOpen(true);onSetFocus(myPath);}},[isEditing,myPath,onSetFocus,open]);const handleOpenPopup=useCallback(event=>{event.stopPropagation();setOpen(true);if(!isRemoved){event.preventDefault();onSetFocus(annotationPath);setTimeout(()=>onSetFocus(myPath),10);}},[annotationPath,isRemoved,myPath,onSetFocus]);const handleClickOutside=useCallback(()=>{if(!isEditing){setOpen(false);}},[isEditing]);useClickOutside(handleClickOutside,[popoverElement]);const annotation=diff.action!=="unchanged"&&diff.annotation||null;const annotations=useMemo(()=>annotation?[annotation]:[],[annotation]);const popoverContent=/* @__PURE__ */jsx(DiffContext.Provider,{value:{path:myPath},children:/* @__PURE__ */jsx(PopoverContainer,{padding:3,children:/* @__PURE__ */jsxs("div",{children:[emptyObject&&/* @__PURE__ */jsxs(Label,{size:1,muted:true,children:["Empty ",schemaType.title]}),!emptyObject&&/* @__PURE__ */jsx(ChangeList,{diff,schemaType})]})})});return/* @__PURE__ */jsx(AnnotationWrapper,_objectSpread(_objectSpread({},restProps),{},{onClick:handleOpenPopup,style,"data-changed":"","data-removed":diff.action==="removed"?"":void 0,children:/* @__PURE__ */jsx(Popover,{content:popoverContent,open,ref:setPopoverElement,portal:true,children:/* @__PURE__ */jsx(PreviewContainer,{paddingLeft:1,children:/* @__PURE__ */jsx(DiffTooltip,{annotations,description:"".concat(diff.action," annotation"),children:/* @__PURE__ */jsxs(InlineBox,{style:{display:"inline-flex"},children:[/* @__PURE__ */jsx("span",{children}),/* @__PURE__ */jsx(Flex,{align:"center",paddingX:1,children:/* @__PURE__ */jsx(InlineText,{size:0,children:/* @__PURE__ */jsx(ChevronDownIcon,{})})})]})})})})}));}const DecoratorWrapper=styled.span(_templateObject221||(_templateObject221=_taggedTemplateLiteral(["\n  display: inline;\n  ","\n"])),_ref271=>{let{theme,decoration}=_ref271;switch(decoration){case"strong":return"font-weight: bold;";case"em":return"font-style: italic;";case"underline":return"text-decoration: underline;";case"overline":return"text-decoration: overline;";case"strike-through":return"text-decoration: line-through;";case"code":return"\n          font-family: ".concat(theme.sanity.fonts.code.family,";\n          background: ").concat(theme.sanity.color.muted.default.enabled.bg,";\n        ");default:return"";}});function Decorator(_ref272){let{mark,children}=_ref272;return/* @__PURE__ */jsx(DecoratorWrapper,{decoration:mark,children});}const InlineObjectWrapper=styled(Card)(_templateObject222||(_templateObject222=_taggedTemplateLiteral(["\n  &:not([hidden]) {\n    display: inline;\n    cursor: pointer;\n    white-space: nowrap;\n    align-items: center;\n\n    &[data-removed] {\n      text-decoration: line-through;\n    }\n\n    "," {\n      display: inline-flex;\n    }\n  }\n"])),InlineBox);function InlineObject(_ref273){let{diff,object,schemaType}=_ref273,restProps=_objectWithoutProperties(_ref273,_excluded61);if(!schemaType){return/* @__PURE__ */jsxs(InlineObjectWrapper,_objectSpread(_objectSpread({},restProps),{},{border:true,radius:1,children:["Unknown schema type: ",object._type]}));}if(diff){return/* @__PURE__ */jsx(InlineObjectWithDiff,_objectSpread(_objectSpread({},restProps),{},{diff,object,schemaType}));}return/* @__PURE__ */jsx(InlineObjectWrapper,{children:/* @__PURE__ */jsx(SanityPreview,{schemaType,value:object,layout:"inline"})});}function InlineObjectWithDiff(_ref274){let{diff,object,path,schemaType}=_ref274,restProps=_objectWithoutProperties(_ref274,_excluded62);const{path:fullPath}=useContext(DiffContext);const{onSetFocus}=useContext(ConnectorContext);const color=useDiffAnnotationColor(diff,[]);const style=useMemo(()=>color?{background:color.background,color:color.text}:{},[color]);const[open,setOpen]=useState(false);const emptyObject=object&&isEmptyObject(object);const isRemoved=diff.action==="removed";const prefix=fullPath.slice(0,fullPath.findIndex(seg=>isKeySegment(seg)&&seg._key===object._key));const myPath=prefix.concat(path);const myValue="field-".concat(toString(myPath));const values=useReportedValues();const isEditing=values.filter(_ref275=>{let[p]=_ref275;return p.startsWith(myValue);}).length>0;const focusPath=fullPath.slice(0,-1).concat(path).concat([FOCUS_TERMINATOR]);useEffect(()=>{if(isEditing){setOpen(true);onSetFocus(focusPath);}},[isEditing]);const handleOpenPopup=useCallback(event=>{event.stopPropagation();setOpen(true);if(!isRemoved){onSetFocus(focusPath);return;}event.preventDefault();},[focusPath]);const handleClose=useCallback(()=>{setOpen(false);},[]);const popoverContent=/* @__PURE__ */jsx(DiffContext.Provider,{value:{path:myPath},children:/* @__PURE__ */jsx(PopoverContent,{diff,emptyObject,onClose:handleClose,schemaType})});const annotation=diff.action!=="unchanged"&&diff.annotation||null;const annotations=annotation?[annotation]:[];return/* @__PURE__ */jsx(InlineObjectWrapper,_objectSpread(_objectSpread({},restProps),{},{onClick:handleOpenPopup,style,"data-removed":diff.action==="removed"?"":void 0,border:true,radius:2,children:/* @__PURE__ */jsx(Popover,{content:popoverContent,open,portal:true,children:/* @__PURE__ */jsx(PreviewContainer,{children:/* @__PURE__ */jsx(DiffTooltip,{annotations,description:"".concat(diff.action," inline object"),children:/* @__PURE__ */jsxs(InlineBox,{children:[/* @__PURE__ */jsx(SanityPreview,{schemaType,value:object,layout:"inline"}),/* @__PURE__ */jsx(Flex,{align:"center",paddingX:1,children:/* @__PURE__ */jsx(InlineText,{size:0,children:/* @__PURE__ */jsx(ChevronDownIcon,{})})})]})})})})}));}function PopoverContent(_ref276){let{diff,emptyObject,onClose,schemaType}=_ref276;const[popoverElement,setPopoverElement]=useState(null);const handleClickOutside=useCallback(()=>{onClose();},[onClose]);useClickOutside(handleClickOutside,[popoverElement]);return/* @__PURE__ */jsxs(PopoverContainer,{ref:setPopoverElement,padding:3,children:[emptyObject&&/* @__PURE__ */jsxs(Label,{size:1,muted:true,children:["Empty ",schemaType.title]}),!emptyObject&&/* @__PURE__ */jsx(ChangeList,{diff,schemaType})]});}function Text(_ref277){let{diff,childDiff,children,path,segment}=_ref277,restProps=_objectWithoutProperties(_ref277,_excluded63);const diffWithFallback=diff||childDiff;const hasChanged=diffWithFallback&&diffWithFallback.action!=="unchanged"&&segment.action!=="unchanged";if(hasChanged){return/* @__PURE__ */jsx(TextWithDiff,_objectSpread(_objectSpread({},restProps),{},{childDiff,diff,segment,path,children}));}return/* @__PURE__ */jsx(InlineBox,{children});}function TextWithDiff(_ref278){let{diff,childDiff,children,path,segment}=_ref278,restProps=_objectWithoutProperties(_ref278,_excluded64);const{onSetFocus}=React.useContext(ConnectorContext);const{path:fullPath}=React.useContext(DiffContext);const spanSegment=useMemo(()=>path.slice(-2,1)[0],[path]);const isRemoved=diff&&diff.action==="removed";const prefix=fullPath.slice(0,fullPath.findIndex(seg=>isKeySegment(seg)&&isKeySegment(spanSegment)&&seg._key===spanSegment._key));const focusPath=prefix.concat(path);const handleClick=useCallback(event=>{event.stopPropagation();if(!isRemoved){event.preventDefault();onSetFocus(focusPath);}},[focusPath,isRemoved,onSetFocus]);const realSeg=diff&&diff.segments.find(rSeg=>rSeg.text===segment.text);const diffWithFallback=realSeg||diff||childDiff;const annotation=diffWithFallback&&diffWithFallback.action!=="unchanged"&&diffWithFallback.annotation||null;const diffCard=annotation&&segment.action!=="unchanged"?/* @__PURE__ */jsx(DiffCard,{annotation,as:segment.action==="removed"?"del":"ins",tooltip:{description:"".concat(startCase(segment.action)," text")},children}):null;return/* @__PURE__ */jsx(InlineBox,_objectSpread(_objectSpread({},restProps),{},{onClick:handleClick,"data-changed":"",children:/* @__PURE__ */jsx("span",{children:/* @__PURE__ */jsx(Fragment,{children:diffCard||children})})}));}const decoratorSymbolsStart=DECORATOR_SYMBOLS.map(set=>set[0]);const decoratorSymbolsEnd=DECORATOR_SYMBOLS.map(set=>set[1]);const annotationSymbolsStart=ANNOTATION_SYMBOLS.map(set=>set[0]);const annotationSymbolsEnd=ANNOTATION_SYMBOLS.map(set=>set[1]);const allSymbolsStart=decoratorSymbolsStart.concat(annotationSymbolsStart);const allSymbolsEnd=decoratorSymbolsEnd.concat(annotationSymbolsEnd);const allDecoratorSymbols=decoratorSymbolsStart.concat(decoratorSymbolsEnd);const markRegex=new RegExp("".concat(allDecoratorSymbols.concat(allSymbolsEnd).join("|")),"g");function PortableText(props){const{diff,schemaType}=props;const block=diff.origin.toValue||diff.origin.fromValue;const inlineObjects=useMemo(()=>diff.origin.toValue?getInlineObjects(diff.origin):[],[diff.origin]);const renderChild=useCallback(ptDiffChild=>{const spanSchemaType=getChildSchemaType(schemaType.fields,ptDiffChild);let decoratorTypes=[];if(spanSchemaType){decoratorTypes=getDecorators(spanSchemaType);const childrenDiff=diff.fields.children;const segments=childrenDiff.items[0].diff&&childrenDiff.items[0].diff.type==="object"&&childrenDiff.items[0].diff.fields.text.type==="string"&&childrenDiff.items[0].diff.fields.text.segments||[];const returnedChildren=[];const annotationSegments={};if(isEmptyTextChange(block,diff)&&(diff.origin.action==="added"||diff.origin.action==="removed")){const textDiff=findChildDiff(diff.origin,block.children[0])||diff.origin;if(textDiff&&textDiff.action!=="unchanged"){return/* @__PURE__ */jsx(DiffCard,{annotation:textDiff.annotation,as:textDiff.action==="removed"?"del":"ins",tooltip:{description:"".concat(startCase(textDiff.action)," empty text")},children:/* @__PURE__ */jsx("span",{children:EMPTY_BLOCK_SYMBOL})},"empty-block-".concat(block._key));}}let childToIndex=-1;let segIndex=-1;const activeAnnotations=[];let endedAnnotation;const allMarkDefs=getAllMarkDefs(diff.origin);segments.forEach(seg=>{var _a,_b,_c;segIndex++;const isInline=INLINE_SYMBOLS.includes(seg.text);const isMarkStart=allSymbolsStart.includes(seg.text);const isMarkEnd=allSymbolsEnd.includes(seg.text);const isChildStart=seg.text===CHILD_SYMBOL;const isRemoved=seg.action==="removed";if(isChildStart){if(!isRemoved){childToIndex++;}}else if(isMarkStart||isMarkEnd){if(isMarkStart&&annotationSymbolsStart.includes(seg.text)){const object=allMarkDefs[annotationSymbolsStart.indexOf(seg.text)];if(object){activeAnnotations.push({mark:object._key,symbols:[seg.text,annotationSymbolsEnd[annotationSymbolsStart.indexOf(seg.text)]],object});}}if(isMarkEnd&&annotationSymbolsEnd.includes(seg.text)){endedAnnotation=activeAnnotations.pop();}}else if(isInline){const indexOfSymbol=INLINE_SYMBOLS.findIndex(sym=>sym===seg.text);const key=(_a=inlineObjects[indexOfSymbol])==null?void 0:_a._key;const originChild=inlineObjects[indexOfSymbol];if(key){const objectSchemaType=getChildSchemaType(schemaType.fields,originChild);const objectDiff=findChildDiff(diff.origin,originChild);returnedChildren.push(/* @__PURE__ */jsx(InlineObject,{object:originChild,path:[{_key:block._key},"children",{_key:originChild._key}],diff:objectDiff,schemaType:objectSchemaType},"inline-object-".concat(originChild._key)));}}else if(seg.text){const getChildFromFromValue=()=>{var _a2;return(_a2=diff.origin.fromValue)==null?void 0:_a2.children.find(cld=>cld.text&&cld.text.match(escapeRegExp(seg.text)));};const child=block.children[childToIndex]||getChildFromFromValue();const childDiff=child&&findSpanDiffFromChild(diff.origin,child);if(!child){throw new Error("Could not find child");}const textDiff=((_b=childDiff==null?void 0:childDiff.fields)==null?void 0:_b.text)?(_c=childDiff==null?void 0:childDiff.fields)==null?void 0:_c.text:void 0;const text=/* @__PURE__ */jsx(Text,{diff:textDiff,path:[{_key:block._key},"children",{_key:child._key}],childDiff,segment:seg,children:renderTextSegment({diff,child,decoratorTypes,seg,segIndex,spanSchemaType})},"text-".concat(child._key,"-").concat(segIndex));if(activeAnnotations.length>0){activeAnnotations.forEach(active=>{annotationSegments[active.mark]=annotationSegments[active.mark]||[];annotationSegments[active.mark].push(text);});}if(endedAnnotation){const key="annotation-".concat(endedAnnotation.object._key);const lastChild=returnedChildren[returnedChildren.length-1];if(lastChild&&lastChild.key!==key){const annotationDiff=findAnnotationDiff(diff.origin,endedAnnotation.mark);const objectSchemaType=endedAnnotation&&spanSchemaType.annotations&&spanSchemaType.annotations.find(type=>endedAnnotation&&endedAnnotation.object&&type.name===endedAnnotation.object._type);returnedChildren.push(/* @__PURE__ */jsx(Annotation,{object:endedAnnotation.object,diff:annotationDiff,path:[{_key:block._key},"children",{_key:child._key}],schemaType:objectSchemaType,children:/* @__PURE__ */jsx(Fragment,{children:annotationSegments[endedAnnotation.mark]})},key));}endedAnnotation=void 0;}if(activeAnnotations.length===0){returnedChildren.push(text);}}});return React.createElement("div",{key:block._key},...returnedChildren);}throw new Error("'span' schemaType not found");},[block,diff,inlineObjects,schemaType]);return/* @__PURE__ */jsx(Block,{block:diff.displayValue,diff,children:/* @__PURE__ */jsx(Fragment,{children:(diff.displayValue.children||[]).map(child=>renderChild(child))})});}function renderTextSegment(_ref279){let{diff,child,decoratorTypes,seg,segIndex,spanSchemaType}=_ref279;if(seg.text==="\n"){return/* @__PURE__ */jsx("br",{});}let children=/* @__PURE__ */jsx("span",{children:seg.text.replace(/ /g,TRAILING_SPACE_SYMBOL)},"text-".concat(segIndex));const spanDiff=child&&findSpanDiffFromChild(diff.origin,child);const activeMarks=child.marks||[];if(spanDiff){children=renderDecorators({activeMarks,decoratorTypes,diff,children,seg,segIndex,spanDiff,spanSchemaType});}if(activeMarks&&activeMarks.length>0){activeMarks.forEach(mark=>{if(isDecorator(mark,spanSchemaType)){children=/* @__PURE__ */jsx(Decorator,{mark,children},"decorator-".concat(mark,"-").concat(child._key,"-").concat(segIndex));}});}return children;}function renderDecorators(_ref280){let{activeMarks,decoratorTypes,diff,children,seg,segIndex,spanDiff,spanSchemaType}=_ref280;var _a;let returned=/* @__PURE__ */jsx("span",{children},"text-segment-".concat(segIndex));const fromPtDiffText=diff.origin.fromValue&&diff.fromValue&&diff.fromValue.children[0].text||"";const indirectMarksAnnotation=spanDiff&&spanDiff.action!=="unchanged"&&spanDiff.annotation||void 0;const marksDiff=(_a=spanDiff==null?void 0:spanDiff.fields)==null?void 0:_a.marks;const marksAnnotation=marksDiff&&marksDiff.action!=="unchanged"&&marksDiff.annotation||indirectMarksAnnotation;let marksChanged=[];const ptDiffChildren=fromPtDiffText.split(CHILD_SYMBOL).filter(text=>!!text).join("");const ptDiffMatchString=ptDiffChildren;const controlString=ptDiffMatchString.substring(0,ptDiffMatchString.indexOf(seg.text)+seg.text.length);const toTest=controlString.substring(0,controlString.indexOf(seg.text));const marks=[];const matches=[...toTest.matchAll(markRegex)];matches.forEach(match=>{var _a2;const sym=match[0];const set=DECORATOR_SYMBOLS.concat(ANNOTATION_SYMBOLS).find(aSet=>aSet.indexOf(sym)>-1);if(set){const isMarkStart=sym===set[0];const mark=((_a2=decoratorTypes[isMarkStart?decoratorSymbolsStart.indexOf(sym):decoratorSymbolsEnd.indexOf(sym)])==null?void 0:_a2.value)||sym;const notClosed=toTest.lastIndexOf(sym)>toTest.lastIndexOf(set[1]);if(notClosed){marks.push(mark);}}});marksChanged=xor(activeMarks,uniq(marks));if(marksAnnotation&&marksChanged.length>0&&marksChanged.some(m=>isDecorator(m,spanSchemaType))){returned=/* @__PURE__ */jsx(DiffCard,{annotation:marksAnnotation,as:"ins",tooltip:{description:"Changed formatting"},children:returned},"diffcard-annotation-".concat(segIndex,"-").concat(marksChanged.join("-")));}return returned;}function isEmptyTextChange(block,diff){return block.children.length===1&&block.children[0]._type==="span"&&typeof block.children[0].text==="string"&&block.children[0].text===""&&diff.origin.action!=="unchanged";}const PTDiff=props=>{const{diff,schemaType}=props;const ptDiff=useMemo(()=>createPortableTextDiff(diff,schemaType),[diff,schemaType]);return/* @__PURE__ */jsx("div",{"data-diff-action":diff.action,children:/* @__PURE__ */jsx(PortableText,{diff:ptDiff,schemaType})});};const ReferenceWrapper=styled.div(_templateObject223||(_templateObject223=_taggedTemplateLiteral(["\n  word-wrap: break-word;\n"])));const ReferencePreview$1=_ref281=>{let{value,schemaType}=_ref281;return/* @__PURE__ */jsx(Box,{as:ReferenceWrapper,padding:2,children:/* @__PURE__ */jsx(SanityPreview,{schemaType,value,layout:"default"})});};const ReferenceFieldDiff=_ref282=>{let{diff,schemaType}=_ref282;return/* @__PURE__ */jsx(DiffFromTo,{align:"center",diff,layout:"grid",path:"_ref",previewComponent:ReferencePreview$1,schemaType});};const StringWrapper$1=styled.div(_templateObject224||(_templateObject224=_taggedTemplateLiteral(["\n  display: inline-block;\n  word-break: break-all;\n  white-space: pre-wrap;\n"])));const StringPreview=props=>{const{value}=props;return/* @__PURE__ */jsx(Box,{as:StringWrapper$1,paddingX:2,paddingY:1,children:value});};const StringWrapper=styled.div(_templateObject225||(_templateObject225=_taggedTemplateLiteral(["\n  white-space: pre-wrap;\n  word-wrap: break-word;\n"])));const StringFieldDiff=_ref283=>{let{diff,schemaType}=_ref283;const{options}=schemaType;if(options==null?void 0:options.list){return/* @__PURE__ */jsx(DiffFromTo,{diff,previewComponent:StringPreview,schemaType});}return/* @__PURE__ */jsx(StringWrapper,{children:/* @__PURE__ */jsx(DiffString,{diff})});};const defaultComponents={block:PTDiff,boolean:{component:BooleanFieldDiff,showHeader:false},file:FileFieldDiff,image:ImageFieldDiff,number:NumberFieldDiff,reference:ReferenceFieldDiff,string:StringFieldDiff};function resolveDiffComponent(type,parentSchemaType){var _a;let itType=type;while(itType){const resolved=((_a=itType==null?void 0:itType.components)==null?void 0:_a.diff)||tryResolve(itType,parentSchemaType)||defaultComponents[itType.name];if(resolved){return resolved;}itType=itType.type;}return defaultComponents[type.jsonType];}function tryResolve(schemaType,parentSchemaType){const resolvers=diffResolvers;let resolved;for(const resolver of resolvers){if(typeof resolver!=="function"){console.error("Diff component resolver is not a function: ",resolver);continue;}resolved=resolver({schemaType,parentSchemaType});if(resolved){return resolved;}}return void 0;}function getChangeVerb(diff){const hadPrevValue=hasValue(diff.fromValue);const hasNextValue=hasValue(diff.toValue);if(!hadPrevValue&&hasNextValue){return"Added";}if(!hasNextValue&&hadPrevValue){return"Removed";}return"Changed";}function noop$2(){}function isFieldChange(change){return change.type==="field";}function isGroupChange(change){return change.type==="group";}function isAddedItemDiff(item){return item.diff.action==="added";}function isRemovedItemDiff(item){return item.diff.action==="removed";}function isUnchangedDiff(diff){return diff.action==="unchanged";}function hasValue(value){return value!==null&&typeof value!=="undefined"&&value!=="";}function buildChangeList(schemaType,diff){let path=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];let titlePath=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];let context=arguments.length>4&&arguments[4]!==undefined?arguments[4]:{};const diffComponent=resolveDiffComponent(schemaType,context.parentSchema);if(!diffComponent){if(schemaType.jsonType==="object"&&diff.type==="object"){return buildObjectChangeList(schemaType,diff,path,titlePath,context);}if(schemaType.jsonType==="array"&&diff.type==="array"){return buildArrayChangeList(schemaType,diff,path,titlePath);}}return getFieldChange(schemaType,diff,path,titlePath,context);}function buildObjectChangeList(schemaType,diff){let path=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];let titlePath=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];let diffContext=arguments.length>4&&arguments[4]!==undefined?arguments[4]:{};const changes=[];const childContext=_objectSpread(_objectSpread({},diffContext),{},{parentSchema:schemaType});const fieldSets=schemaType.fieldsets||schemaType.fields.map(field=>({single:true,field}));for(const fieldSet of fieldSets){if(fieldSet.single){changes.push(...buildFieldChange(fieldSet.field,diff,path,titlePath,childContext));}else{changes.push(...buildFieldsetChangeList(fieldSet,diff,path,titlePath,childContext));}}if(changes.length<2){return changes;}return[{type:"group",key:pathToString(path)||"root",path,titlePath,changes:reduceTitlePaths(changes,titlePath.length),schemaType}];}function buildFieldChange(field,diff,path,titlePath){let diffContext=arguments.length>4&&arguments[4]!==undefined?arguments[4]:{};const{fieldFilter}=diffContext,context=_objectWithoutProperties(diffContext,_excluded65);const fieldDiff=diff.fields[field.name];if(!fieldDiff||!fieldDiff.isChanged||fieldFilter&&!fieldFilter.includes(field.name)){return[];}const fieldPath=path.concat([field.name]);const fieldTitlePath=titlePath.concat([field.type.title||field.name]);return buildChangeList(field.type,fieldDiff,fieldPath,fieldTitlePath,context);}function buildFieldsetChangeList(fieldSet,diff,path,titlePath){let diffContext=arguments.length>4&&arguments[4]!==undefined?arguments[4]:{};const{fields,name,title,readOnly,hidden}=fieldSet;const{fieldFilter}=diffContext,context=_objectWithoutProperties(diffContext,_excluded66);const fieldSetHidden=hidden;const fieldsetReadOnly=readOnly;const fieldSetTitlePath=titlePath.concat([title||name]);const changes=[];for(const field of fields){const fieldDiff=diff.fields[field.name];if(!fieldDiff||!fieldDiff.isChanged||fieldFilter&&!fieldFilter.includes(field.name)){continue;}const fieldPath=path.concat([field.name]);const fieldTitlePath=fieldSetTitlePath.concat([field.type.title||field.name]);changes.push(...buildChangeList(_objectSpread({readOnly:fieldsetReadOnly,hidden:fieldSetHidden},field.type),fieldDiff,fieldPath,fieldTitlePath,context));}if(changes.length<2){return changes;}return[{type:"group",key:pathToString(path)||"root",fieldsetName:name,path,titlePath:fieldSetTitlePath,changes:reduceTitlePaths(changes,fieldSetTitlePath.length),readOnly:fieldsetReadOnly,hidden:fieldSetHidden}];}function buildArrayChangeList(schemaType,diff){let path=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];let titlePath=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];const changedOrMoved=diff.items.filter(item=>item.hasMoved&&item.fromIndex!==item.toIndex||item.diff.action!=="unchanged");if(changedOrMoved.length===0){return[];}const isPortableText=hasPTMemberType(schemaType);const list=[];const changes=changedOrMoved.reduce((acc,itemDiff)=>{const memberTypes=getArrayDiffItemType(itemDiff.diff,schemaType);const memberType=memberTypes.toType||memberTypes.fromType;if(!memberType){console.warn("Could not determine schema type for item at %s",pathToString(path));return acc;}const segment=getItemKeySegment(itemDiff.diff.fromValue)||getItemKeySegment(itemDiff.diff.toValue)||diff.items.indexOf(itemDiff);const itemPath=path.concat(segment);const itemContext={itemDiff,parentDiff:diff,parentSchema:schemaType};const itemTitlePath=titlePath.concat({hasMoved:itemDiff.hasMoved,toIndex:itemDiff.toIndex,fromIndex:itemDiff.fromIndex,annotation:itemDiff.diff.action==="unchanged"?itemDiff.annotation:itemDiff.diff.annotation});const attachItemDiff=change=>{if(change.type==="field"&&pathsAreEqual(itemPath,change.path)){change.itemDiff=itemDiff;}return change;};const children=buildChangeList(memberType,itemDiff.diff,itemPath,itemTitlePath,itemContext).map(attachItemDiff);if(isPortableText){children.filter(isFieldChange).forEach((field,index,siblings)=>{field.showHeader=siblings.length===1;field.showIndex=itemDiff.fromIndex!==itemDiff.toIndex&&itemDiff.hasMoved;});}if(children.length===0){acc.push(...getFieldChange(memberType,itemDiff.diff,itemPath,itemTitlePath,itemContext));}else{acc.push(...children);}return acc;},list);if(changes.length>1){return[{type:"group",key:pathToString(path)||"root",path,titlePath,changes:reduceTitlePaths(changes,titlePath.length),schemaType}];}return changes;}function getFieldChange(schemaType,diff,path,titlePath){let{itemDiff,parentDiff,parentSchema}=arguments.length>4&&arguments[4]!==undefined?arguments[4]:{};const{fromValue,toValue,type}=diff;if(type==="array"&&isEmpty(fromValue)&&isEmpty(toValue)){return[];}let error;if(typeof fromValue!=="undefined"){error=getValueError(fromValue,schemaType);}if(!error&&typeof toValue!=="undefined"){error=getValueError(toValue,schemaType);}let showHeader=true;let component;const diffComponent=resolveDiffComponent(schemaType,parentSchema);if(diffComponent&&typeof diffComponent==="function"){component=diffComponent;}else if(diffComponent){component=diffComponent.component;showHeader=typeof diffComponent.showHeader==="undefined"?showHeader:diffComponent.showHeader;}return[{type:"field",diff,path,error,itemDiff,parentDiff,titlePath,schemaType,showHeader,showIndex:true,key:pathToString(path)||"root",diffComponent:error?void 0:component,parentSchema}];}function reduceTitlePaths(changes){let byLength=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;return changes.map(change=>{change.titlePath=change.titlePath.slice(byLength);return change;});}function isEmpty(item){return Array.isArray(item)&&item.length===0||item===null||typeof item==="undefined";}const isAddedAction=change=>{return change.type==="field"&&change.diff.action==="added";};const flattenChangeNode=changeNode=>{if(changeNode.type!=="group"){return[changeNode];}const newSubChanges=[];changeNode.changes.forEach(cChange=>{newSubChanges.push(...flattenChangeNode(cChange));});return newSubChanges;};const isSubpathOf=(subPath,parentPath)=>{if(parentPath.length>=subPath.length){return false;}for(let i=0;i<parentPath.length;i++){if(parentPath[i]!==subPath[i]){return false;}}return true;};const pathSegmentOfCorrectType=(item,child)=>{const nextItem=item[child];const key=getItemKey(nextItem);if(key){return{_key:key};}const isArray=Array.isArray(item);if(isArray){return parseInt(child,10);}return child;};const diffOptions={diffMatchPatch:{enabled:false}};function undoChange(change,rootDiff,documentOperations){if(!rootDiff){return;}const patches=[];if(change.type==="group"){const allChanges=flattenChangeNode(change);const unsetChanges=allChanges.filter(isAddedAction);allChanges.filter(child=>!isAddedAction(child)).forEach(child=>undoChange(child,rootDiff,documentOperations));patches.push(...buildUnsetPatches(rootDiff,unsetChanges.map(unsetChange=>unsetChange.path)));}else if(change.diff.action==="added"){patches.push(...buildUnsetPatches(rootDiff,[change.path]));}else if(change.type==="field"&&change.itemDiff&&change.parentDiff&&change.parentDiff.type==="array"&&change.itemDiff.hasMoved){patches.push(...buildMovePatches(change.itemDiff,change.parentDiff,change.path));}else{patches.push(...buildUndoPatches(change.diff,rootDiff,change.path));}documentOperations.patch.execute(patches);}function buildUnsetPatch(rootDiff,path,concurrentUnsetPaths){const previousValue=rootDiff.toValue;return furthestEmptyAncestor(previousValue,path,concurrentUnsetPaths);}function buildUnsetPatches(rootDiff,paths){const patches=[];for(let i=0;i<paths.length;i++){const unsetByEarlierPatch=patches.some(patch=>isSubpathOf(paths[i],patch));if(unsetByEarlierPatch){continue;}patches.push(buildUnsetPatch(rootDiff,paths[i],paths));}return[{unset:[...new Set(patches.map(pathToString))]}];}function furthestEmptyAncestor(previousValue,currentPath){let ignorePaths=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];let initialPath=arguments.length>3?arguments[3]:undefined;if(currentPath.length<=0){if(!initialPath){throw new Error("Root has no ancestor");}return initialPath;}const ancestorPath=currentPath.slice(0,-1);const ancestorValue=getValueAtPath(previousValue,ancestorPath);const updatedIgnorePaths=[ancestorPath,...ignorePaths.filter(path=>!isSubpathOf(path,ancestorPath))];return isStub(ancestorValue,ancestorPath,ignorePaths)?furthestEmptyAncestor(previousValue,ancestorPath,updatedIgnorePaths,initialPath):currentPath;}function buildMovePatches(itemDiff,parentDiff,path){const basePath=path.slice(0,-1);const{parentValue,fromIndex,fromValue}=getFromItem(parentDiff,itemDiff);let insertLocation;if(fromIndex===0){insertLocation={before:pathToString([...basePath,0])};}else{const prevIndex=fromIndex-1;const prevItemKey=getItemKeySegment(parentValue[prevIndex]);const prevSegment=prevItemKey||prevIndex;insertLocation={after:pathToString([...basePath,prevSegment])};}return[{unset:[pathToString(path)]},{insert:_objectSpread(_objectSpread({},insertLocation),{},{items:[fromValue]})}];}function buildUndoPatches(diff,rootDiff,path){const patches=diffItem(diff.toValue,diff.fromValue,diffOptions,path);const inserts=patches.filter(patch=>patch.op==="insert").map(_ref284=>{let{after,items}=_ref284;return{insert:{after:pathToString(after),items}};});const unsets=patches.filter(patch=>patch.op==="unset").reduce((acc,patch)=>acc.concat(pathToString(patch.path)),[]);const stubbedPaths=/* @__PURE__ */new Set();const stubs=[];let hasSets=false;const sets=patches.filter(patch=>patch.op==="set").reduce((acc,patch)=>{hasSets=true;stubs.push(...getParentStubs(patch.path,rootDiff,stubbedPaths));acc[pathToString(patch.path)]=patch.value;return acc;},{});return[...stubs,...inserts,...(unsets.length>0?[{unset:unsets}]:[]),...(hasSets?[{set:sets}]:[])];}function getParentStubs(path,rootDiff,stubbed){const value=rootDiff.fromValue;const nextValue=rootDiff.toValue;const stubs=[];for(let i=1;i<=path.length;i++){const subPath=path.slice(0,i);const pathStr=pathToString(subPath);if(stubbed.has(pathStr)){continue;}const nextSegment=path[i];const nextIsArrayElement=isKeySegment(nextSegment)||isIndexSegment(nextSegment);const itemValue=getValueAtPath(value,subPath);const stub=getStubValue(itemValue);if(nextIsArrayElement&&Array.isArray(itemValue)&&!getValueAtPath(nextValue,path.slice(0,i+1))){const indexAtPrev=findIndex(itemValue,nextSegment);const prevItem=itemValue[indexAtPrev-1];const nextItem=getValueAtPath(value,subPath.concat(nextSegment));const prevSeg=isKeyedObject(prevItem)?{_key:prevItem._key}:indexAtPrev-1;const after=pathToString(subPath.concat(indexAtPrev<1?0:prevSeg));stubs.push({setIfMissing:{[pathStr]:[]}});stubs.push({insert:{after,items:[getStubValue(nextItem)]}});i++;continue;}if(typeof stub==="undefined"){continue;}stubbed.add(pathStr);stubs.push({setIfMissing:{[pathStr]:stub}});}return stubs;}function onlyContainsStubs(item,path,ignorePaths){if(!isRecord$2(item)||!Array.isArray(item)){return false;}for(const child in item){if(!Object.prototype.hasOwnProperty.call(item,child)){continue;}if(child==="_type"||child==="_key"){continue;}const nextPath=[...path,pathSegmentOfCorrectType(item,child)];if(!isStub(item[child],nextPath,ignorePaths)){return false;}}return true;}function isStub(item,path,ignorePaths){const isIgnoredPath=ignorePaths==null?void 0:ignorePaths.some(ignorePath=>pathToString(ignorePath)===pathToString(path));const isEmptyArray=Array.isArray(item)&&item.length<=0;return isIgnoredPath||item===void 0||item===null||isEmptyArray||isEmptyObject$1(item)||onlyContainsStubs(item,path,ignorePaths);}function getStubValue(item){if(Array.isArray(item)){return[];}if(typeof item!=="object"||item===null){return void 0;}const props={};if(isKeyedObject(item)){props._key=item._key;}if(isTypedObject(item)){props._type=item._type;}return props;}function getFromItem(parentDiff,itemDiff){if(parentDiff.fromValue&&typeof itemDiff.fromIndex==="number"){const fromValue=parentDiff.fromValue[itemDiff.fromIndex];return{parentValue:parentDiff.fromValue,fromIndex:itemDiff.fromIndex,fromValue};}throw new Error("Failed to find item at index ".concat(itemDiff.fromIndex));}const ConditionalReadOnlyContext=createContext(null);function useConditionalReadOnly(){const context=useContext(ConditionalReadOnlyContext);if(!context){return null;}return context.readOnly||null;}function DiffTooltip(props){if("diff"in props){const{diff,path=[]}=props,restProps=_objectWithoutProperties(props,_excluded67);const annotation=getAnnotationAtPath(diff,path);return/* @__PURE__ */jsx(DiffTooltipWithAnnotation,_objectSpread(_objectSpread({},restProps),{},{annotations:annotation?[annotation]:[]}));}return/* @__PURE__ */jsx(DiffTooltipWithAnnotation,_objectSpread({},props));}function DiffTooltipWithAnnotation(props){const{annotations,children,description="Changed"}=props,restProps=_objectWithoutProperties(props,_excluded68);if(!annotations){return children;}const content=/* @__PURE__ */jsxs(Stack,{padding:3,space:2,children:[/* @__PURE__ */jsx(Label,{size:1,style:{textTransform:"uppercase"},muted:true,children:description}),/* @__PURE__ */jsx(Stack,{space:2,children:annotations.map((annotation,idx)=>/* @__PURE__ */jsx(AnnotationItem,{annotation},idx))})]});return/* @__PURE__ */jsx(LegacyLayerProvider,{zOffset:"paneFooter",children:/* @__PURE__ */jsx(Tooltip,_objectSpread(_objectSpread({content,portal:true,allowedAutoPlacements:["top","bottom"]},restProps),{},{children}))});}function AnnotationItem(_ref285){let{annotation}=_ref285;const{author,timestamp}=annotation;const[user]=useUser(author);const color=useAnnotationColor(annotation);const timeAgo=useTimeAgo(timestamp,{minimal:true});return/* @__PURE__ */jsxs(Inline,{space:2,children:[/* @__PURE__ */jsxs(Flex,{align:"center",paddingRight:3,style:{backgroundColor:color.background,color:color.text,borderRadius:"calc(23px / 2)"},children:[/* @__PURE__ */jsx(UserAvatar,{user:author}),/* @__PURE__ */jsx(Inline,{paddingLeft:2,children:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,style:{color:color.text},children:user?user.displayName:"Loading\u2026"})})]}),/* @__PURE__ */jsx(Text$1,{as:"time",muted:true,size:1,dateTime:timestamp,children:timeAgo})]});}const StyledCard=styled(Card)(_templateObject226||(_templateObject226=_taggedTemplateLiteral(["\n  --diff-card-radius: ",";\n  --diff-card-bg-color: ",";\n\n  max-width: 100%;\n  position: relative;\n  border-radius: var(--diff-card-radius);\n\n  &:not(del) {\n    text-decoration: none;\n  }\n\n  &[data-hover] {\n    &::after {\n      content: '';\n      display: block;\n      position: absolute;\n      left: 0;\n      right: 0;\n      bottom: 0;\n    }\n\n    &:hover {\n      border-bottom-left-radius: 0;\n      border-bottom-right-radius: 0;\n\n      &::after {\n        bottom: -3px;\n        border-top: 1px solid var(---diff-card-bg-color);\n        border-bottom: 2px solid currentColor;\n        border-bottom-left-radius: var(--diff-card-radius);\n        border-bottom-right-radius: var(--diff-card-radius);\n      }\n    }\n\n    [data-from-to-layout]:hover & {\n      border-bottom-left-radius: 0;\n      border-bottom-right-radius: 0;\n\n      &::after {\n        bottom: -3px;\n        border-top: 1px solid var(---diff-card-bg-color);\n        border-bottom: 2px solid currentColor;\n        border-bottom-left-radius: var(--diff-card-radius);\n        border-bottom-right-radius: var(--diff-card-radius);\n      }\n    }\n  }\n"])),_ref286=>{let{theme}=_ref286;return rem(theme.sanity.radius[2]);},_ref287=>{let{theme}=_ref287;return theme.sanity.color.card.enabled.bg;});const EMPTY_PATH=[];const DiffCard=forwardRef(function DiffCard2(props,ref){const{annotation:annotationProp,as="div",children,className,diff,disableHoverEffect,path=EMPTY_PATH,style={},tooltip}=props,restProps=_objectWithoutProperties(props,_excluded69);const annotation=useMemo(()=>annotationProp||getAnnotationAtPath(diff,path),[annotationProp,diff,path]);const color=useAnnotationColor(annotation);const element=/* @__PURE__ */jsx(StyledCard,_objectSpread(_objectSpread({},restProps),{},{as,className,"data-hover":disableHoverEffect||!annotation?void 0:"",ref,radius:1,style:_objectSpread(_objectSpread({},style),{},{backgroundColor:color.background,color:color.text}),children}));if(tooltip&&annotation){return/* @__PURE__ */jsx(DiffTooltip,{annotations:[annotation],description:tooltip&&typeof tooltip==="object"&&tooltip.description,children:element});}return element;});const RoundedCard$1=styled.div(_templateObject227||(_templateObject227=_taggedTemplateLiteral(["\n  border-radius: ",";\n  padding: ",";\n"])),_ref288=>{let{theme}=_ref288;return rem(theme.sanity.radius[2]);},_ref289=>{let{theme}=_ref289;return rem(theme.sanity.space[1]);});const AnnotationText=styled(Text$1)(_templateObject228||(_templateObject228=_taggedTemplateLiteral(["\n  &:not([hidden]) {\n    color: inherit;\n  }\n"])));function ChangeTitleSegment(props){const{change,segment}=props;if(typeof segment==="string"){return/* @__PURE__ */jsx(Box,{style:segment.length>30?{maxWidth:100}:{},children:/* @__PURE__ */jsx(Text$1,{title:segment,size:1,weight:"semibold",textOverflow:"ellipsis",children:segment})});}const{hasMoved,fromIndex,toIndex,annotation}=segment;const created=typeof fromIndex==="undefined";const deleted=typeof toIndex==="undefined";if(created){return/* @__PURE__ */jsx(CreatedTitleSegment,{annotation,change,toIndex});}if(deleted){return/* @__PURE__ */jsx(DeletedTitleSegment,{annotation,fromIndex});}if(hasMoved&&typeof toIndex!=="undefined"&&typeof fromIndex!=="undefined"){return/* @__PURE__ */jsx(MovedTitleSegment,{annotation,fromIndex,toIndex});}const readableIndex=(toIndex||0)+1;return/* @__PURE__ */jsx(Box,{padding:1,children:/* @__PURE__ */jsxs(Text$1,{size:1,weight:"semibold",children:["#",readableIndex]})});}function CreatedTitleSegment(props){const{annotation:annotationProp,change,toIndex=0}=props;const readableIndex=toIndex+1;const description="Added in position ".concat(readableIndex);const content=/* @__PURE__ */jsxs(Fragment,{children:["#",readableIndex]});const diffAnnotation=(change==null?void 0:change.diff)?getAnnotationAtPath(change.diff,[]):void 0;const annotation=diffAnnotation||annotationProp;if(annotation){return/* @__PURE__ */jsx(DiffCard,{annotation,tooltip:{description},as:RoundedCard$1,children:/* @__PURE__ */jsx(AnnotationText,{size:1,weight:"semibold",forwardedAs:"ins",style:{textDecoration:"none"},children:content})});}return/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:content});}function DeletedTitleSegment(props){const{annotation,fromIndex=0}=props;const readableIndex=fromIndex+1;const description="Removed from position ".concat(readableIndex);return/* @__PURE__ */jsx(DiffCard,{annotation:annotation||null,as:RoundedCard$1,tooltip:{description},children:/* @__PURE__ */jsxs(AnnotationText,{size:1,weight:"semibold",forwardedAs:"del",children:["#",readableIndex]})});}function MovedTitleSegment(props){const{annotation,fromIndex,toIndex}=props;const indexDiff=toIndex-fromIndex;const indexSymbol=indexDiff<0?"\u2191":"\u2193";const positions=Math.abs(indexDiff);const description="Moved ".concat(positions," position").concat(positions===1?"":"s"," ").concat(indexDiff<0?"up":"down");return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Box,{padding:1,children:/* @__PURE__ */jsxs(AnnotationText,{size:1,weight:"semibold",children:["#",toIndex+1]})}),/* @__PURE__ */jsx(DiffCard,{annotation,as:RoundedCard$1,tooltip:{description},children:/* @__PURE__ */jsxs(AnnotationText,{size:1,weight:"semibold",children:[indexSymbol,Math.abs(indexDiff)]})})]});}function ChangeBreadcrumb(props){const{change,titlePath}=props;return/* @__PURE__ */jsx(Breadcrumbs,{separator:/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:"/"}),children:titlePath.map((titleSegment,idx)=>{const showSegment=typeof titleSegment==="string"||!change||change.showIndex;if(!showSegment){return null;}return/* @__PURE__ */jsx(ChangeTitleSegment,{change,segment:titleSegment},idx);})});}class DiffErrorBoundary extends React.Component{constructor(){super(...arguments);this.state={};}static getDerivedStateFromError(error){return{error};}componentDidCatch(error){console.error("Error rendering diff component: ");console.error(error);}render(){const{error}=this.state;if(!error){return this.props.children;}return/* @__PURE__ */jsx(Card,{padding:3,radius:2,tone:"critical",children:/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(ErrorOutlineIcon,{})}),/* @__PURE__ */jsxs(Box,{paddingLeft:3,children:[/* @__PURE__ */jsx(Text$1,{as:"h3",size:1,weight:"medium",children:"Rendering the changes to this field caused an error"}),isDev&&/* @__PURE__ */jsx(Box,{marginTop:2,children:/* @__PURE__ */jsx(Text$1,{as:"p",size:1,children:"Check the developer console for more information"})})]})]})});}}const arrowComponents={down:ArrowDownIcon,right:ArrowRightIcon};function FromToArrow(props){const{direction="right"}=props,restProps=_objectWithoutProperties(props,_excluded70);const arrowComponent=arrowComponents[direction];return/* @__PURE__ */jsx(Text$1,_objectSpread(_objectSpread({muted:true,size:1},restProps),{},{children:createElement(arrowComponent)}));}const CodeWrapper$1=styled.pre(_templateObject229||(_templateObject229=_taggedTemplateLiteral(["\n  overflow-x: auto;\n  position: relative;\n"])));const Meta=styled.div(_templateObject230||(_templateObject230=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  right: 0;\n"])));function DiffInspectWrapper(props){const{children,as,change}=props,restProps=_objectWithoutProperties(props,_excluded71);const isHovering=useRef(false);const[isInspecting,setIsInspecting]=useState(false);const toggleInspect=useCallback(()=>setIsInspecting(state=>!state),[setIsInspecting]);const handleMouseEnter=useCallback(()=>isHovering.current=true,[]);const handleMouseLeave=useCallback(()=>isHovering.current=false,[isHovering]);useEffect(()=>{function onKeyDown(evt){const{metaKey,key}=evt;if(metaKey&&key==="i"&&isHovering.current){toggleInspect();}}window.addEventListener("keydown",onKeyDown,false);return()=>window.removeEventListener("keydown",onKeyDown,false);},[toggleInspect]);return/* @__PURE__ */jsx(Box,_objectSpread(_objectSpread({as,onMouseEnter:handleMouseEnter,onMouseLeave:handleMouseLeave},restProps),{},{children:isInspecting?/* @__PURE__ */jsx(DiffInspector,{change}):children}));}const MetaLabel=_ref290=>{let{title}=_ref290;return/* @__PURE__ */jsx(Box,{padding:3,display:"inline-block",as:Meta,children:/* @__PURE__ */jsx(Label,{size:1,muted:true,children:title})});};function DiffInspector(_ref291){let{change}=_ref291;var _a,_b,_c;return/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Card,{padding:3,tone:"transparent",as:CodeWrapper$1,radius:1,children:[/* @__PURE__ */jsx(MetaLabel,{title:"meta"}),/* @__PURE__ */jsx(Code,{language:"json",size:1,children:printMeta({path:pathToString(change.path),fromIndex:(_a=change.itemDiff)==null?void 0:_a.fromIndex,toIndex:(_b=change.itemDiff)==null?void 0:_b.toIndex,hasMoved:(_c=change.itemDiff)==null?void 0:_c.hasMoved,action:change.diff.action,isChanged:change.diff.isChanged})})]}),/* @__PURE__ */jsxs(Card,{as:CodeWrapper$1,tone:"critical",padding:3,radius:1,children:[/* @__PURE__ */jsx(MetaLabel,{title:"from"}),/* @__PURE__ */jsx(Code,{language:"json",size:1,children:jsonify(change.diff.fromValue)})]}),/* @__PURE__ */jsx(Card,{children:/* @__PURE__ */jsx(FromToArrow,{direction:"down",align:"center"})}),/* @__PURE__ */jsxs(Card,{as:CodeWrapper$1,tone:"positive",padding:3,radius:1,children:[/* @__PURE__ */jsx(MetaLabel,{title:"to"}),/* @__PURE__ */jsx(Code,{language:"json",size:1,children:jsonify(change.diff.toValue)})]})]});}function jsonify(value){if(typeof value==="undefined"){return"undefined";}return JSON.stringify(value,null,2);}function printMeta(keys){const lines=[];Object.entries(keys).forEach(_ref292=>{let[key,value]=_ref292;if(typeof value!=="undefined"&&value!==null){lines.push("".concat(key,": ").concat(value));}});return lines.join("\n");}const INLINE_COLUMN_STYLES={flexShrink:0};const BLOCK_COLUMN_STYLES={alignItems:"stretch"};const FLEX_ALIGN={top:"flex-start",center:"center",bottom:"flex-end",default:"flex-start"};const FromTo=forwardRef(function FromTo2(props,ref){const{align="top",layout="inline",from,to,style}=props,restProps=_objectWithoutProperties(props,_excluded72);const theme=useTheme$1();const Layout=layout==="inline"?Flex:Grid;const layoutStyles=useMemo(()=>_objectSpread(_objectSpread({},style),layout==="inline"?{maxWidth:"100%",display:"inline-flex"}:{gridTemplateColumns:"minmax(0, 1fr) ".concat(rem(theme.sanity.space[5])," minmax(0, 1fr)")}),[layout,style,theme]);const columnStyles=layout==="inline"?INLINE_COLUMN_STYLES:BLOCK_COLUMN_STYLES;return/* @__PURE__ */jsxs(Layout,_objectSpread(_objectSpread({},restProps),{},{ref,style:layoutStyles,"data-from-to-layout":true,children:[from&&/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Flex,{align:FLEX_ALIGN[align],style:columnStyles,children:from}),/* @__PURE__ */jsx(Flex,{align:"center",justify:"center",padding:2,children:/* @__PURE__ */jsx(FromToArrow,{})})]}),/* @__PURE__ */jsx(Flex,{align:FLEX_ALIGN[align],style:columnStyles,children:to})]}));});const cardStyles={flex:1,minWidth:0,display:"block",whiteSpace:"break-spaces"};function DiffFromTo(props){const{align,cardClassName,diff,layout,path,previewComponent,schemaType}=props;const{action}=diff;const changeVerb=getChangeVerb(diff);if(action==="unchanged"){return/* @__PURE__ */jsx(DiffCard,{className:cardClassName,style:cardStyles,children:createElement(previewComponent,{schemaType,value:diff.toValue})});}const from=diff.fromValue!==void 0&&diff.fromValue!==null&&/* @__PURE__ */jsx(DiffCard,{as:"del",className:cardClassName,diff,path,style:cardStyles,children:createElement(previewComponent,{schemaType,value:diff.fromValue})});const to=diff.toValue!==void 0&&diff.toValue!==null&&/* @__PURE__ */jsx(DiffCard,{as:"ins",className:cardClassName,diff,path,style:cardStyles,children:createElement(previewComponent,{schemaType,value:diff.toValue})});if(from&&!to){return/* @__PURE__ */jsx(DiffTooltip,{description:changeVerb,diff,path,children:from});}if(!from&&to){return/* @__PURE__ */jsx(DiffTooltip,{description:changeVerb,diff,path,children:to});}return/* @__PURE__ */jsx(DiffTooltip,{description:changeVerb,diff,path,children:/* @__PURE__ */jsx(FromTo,{align,from,layout,to})});}const FallbackPreview=_ref293=>{let{value,schemaType}=_ref293;return/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(SanityPreview,{schemaType,value,layout:"default"})});};const FallbackDiff=props=>{const{diff,schemaType}=props;return/* @__PURE__ */jsx(DiffFromTo,{diff,schemaType,previewComponent:FallbackPreview,layout:"grid"});};const Root$c=styled(Button)(_templateObject231||(_templateObject231=_taggedTemplateLiteral(["\n  [data-ui='Text'] {\n    font-weight: normal;\n  }\n\n  div[data-ui='Box'] {\n    display: none;\n  }\n\n  &:not([data-disabled='true']):hover,\n  &:not([data-disabled='true']):focus {\n    --card-fg-color: ",";\n    --card-bg-color: transparent;\n    --card-border-color: transparent;\n\n    div[data-ui='Box'] {\n      display: block;\n    }\n  }\n"])),_ref294=>{let{theme}=_ref294;return theme.sanity.color.solid.critical.enabled.bg;});const RevertChangesButton=forwardRef(function RevertChangesButton2(props,ref){const{selected}=props,restProps=_objectWithoutProperties(props,_excluded73);return/* @__PURE__ */jsx(Root$c,_objectSpread({icon:RevertIcon,selected,text:"Revert changes",mode:"bleed",padding:1,fontSize:1,space:2,ref},restProps));});function ValueError(_ref295){let{error}=_ref295;return/* @__PURE__ */jsx(Card,{tone:"critical",padding:3,children:/* @__PURE__ */jsxs(Flex,{align:"flex-start",children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{children:/* @__PURE__ */jsx(ErrorOutlineIcon,{})})}),/* @__PURE__ */jsx(Box,{flex:1,paddingLeft:3,children:/* @__PURE__ */jsxs(Text$1,{size:1,as:"p",children:["Value error: ",error.message]})})]})});}const FieldChangeContainer=styled.div(_templateObject232||(_templateObject232=_taggedTemplateLiteral(["\n  --field-change-error: ",";\n  &[data-revert-all-changes-hover] [data-revert-all-hover]::before {\n    border-left: 2px solid var(--field-change-error);\n  }\n"])),_ref296=>{let{theme}=_ref296;return theme.sanity.color.solid.critical.enabled.bg;});const DiffBorder=styled.div(_templateObject233||(_templateObject233=_taggedTemplateLiteral(["\n  --field-change-error: ",";\n  --diff-inspect-padding-xsmall: ",";\n  --diff-inspect-padding-small: ",";\n\n  position: relative;\n  padding: var(--diff-inspect-padding-xsmall) 0 var(--diff-inspect-padding-xsmall)\n    var(--diff-inspect-padding-small);\n\n  &::before {\n    content: '';\n    display: block;\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    border-left: 1px solid var(--card-border-color);\n  }\n\n  &[data-error]:hover::before,\n  &[data-revert-field-hover]:hover::before {\n    border-left: 2px solid var(--field-change-error);\n  }\n"])),_ref297=>{let{theme}=_ref297;return theme.sanity.color.solid.critical.enabled.bg;},_ref298=>{let{theme}=_ref298;return rem(theme.sanity.space[1]);},_ref299=>{let{theme}=_ref299;return rem(theme.sanity.space[2]);});const PopoverWrapper$2=styled(Popover)(_templateObject234||(_templateObject234=_taggedTemplateLiteral(["\n  /* hides the popover when the target of it has left the visible part of the window.\n   without it, the popover will be on top of the headers (document title & changes)\n   and footers (changed notifications, publish button etc)*/\n  &[data-popper-reference-hidden='true'] {\n    display: none;\n  }\n"])));function FieldChange(props){var _a;const{change,hidden,readOnly}=props;const conditionalReadOnly=(_a=useConditionalReadOnly())!=null?_a:readOnly;const DiffComponent=change.diffComponent||FallbackDiff;const{documentId,schemaType,rootDiff,isComparingCurrent,FieldWrapper=React.Fragment}=useDocumentChange();const ops=useDocumentOperation(documentId,schemaType.name);const[confirmRevertOpen,setConfirmRevertOpen]=useState(false);const[revertHovered,setRevertHovered]=useState(false);const[revertButtonElement,setRevertButtonElement]=useState(null);const[permissions,isPermissionsLoading]=useDocumentPairPermissions({id:documentId,type:schemaType.name,permission:"update"});const handleRevertChanges=useCallback(()=>{undoChange(change,rootDiff,ops);},[change,rootDiff,ops]);const handleRevertChangesConfirm=useCallback(()=>{setConfirmRevertOpen(true);},[]);const closeRevertChangesConfirmDialog=React.useCallback(()=>{setConfirmRevertOpen(false);},[]);const handleRevertButtonMouseEnter=useCallback(()=>{setRevertHovered(true);},[]);const handleRevertButtonMouseLeave=useCallback(()=>{setRevertHovered(false);},[]);const handleClickOutside=useCallback(()=>setConfirmRevertOpen(false),[]);useClickOutside(handleClickOutside,[revertButtonElement]);const content=useMemo(()=>hidden?null:/* @__PURE__ */jsxs(Stack,{space:1,as:FieldChangeContainer,children:[change.showHeader&&/* @__PURE__ */jsx(ChangeBreadcrumb,{change,titlePath:change.titlePath}),/* @__PURE__ */jsx(FieldWrapper,{path:change.path,hasHover:revertHovered,children:/* @__PURE__ */jsxs(DiffInspectWrapper,{change,as:DiffBorder,"data-revert-field-hover":revertHovered?"":void 0,"data-error":change.error?"":void 0,"data-revert-all-hover":true,children:[change.error?/* @__PURE__ */jsx(ValueError,{error:change.error}):/* @__PURE__ */jsx(DiffErrorBoundary,{children:/* @__PURE__ */jsx(DiffContext.Provider,{value:{path:change.path},children:/* @__PURE__ */jsx(DiffComponent,{diff:change.diff,schemaType:change.schemaType})})}),isComparingCurrent&&!isPermissionsLoading&&(permissions==null?void 0:permissions.granted)&&/* @__PURE__ */jsx(PopoverWrapper$2,{content:/* @__PURE__ */jsxs(Box,{padding:3,sizing:"border",children:["Are you sure you want to revert the changes?",/* @__PURE__ */jsxs(Grid,{columns:2,gap:2,marginTop:2,children:[/* @__PURE__ */jsx(Button,{mode:"ghost",onClick:closeRevertChangesConfirmDialog,children:/* @__PURE__ */jsx(Text$1,{align:"center",children:"Cancel"})}),/* @__PURE__ */jsx(Button,{tone:"critical",onClick:handleRevertChanges,children:/* @__PURE__ */jsx(Text$1,{align:"center",children:"Revert change"})})]})]}),open:confirmRevertOpen,portal:true,placement:"left",ref:setRevertButtonElement,children:/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(RevertChangesButton,{onClick:handleRevertChangesConfirm,onMouseEnter:handleRevertButtonMouseEnter,onMouseLeave:handleRevertButtonMouseLeave,selected:confirmRevertOpen,disabled:conditionalReadOnly,"data-testid":"single-change-revert-button-".concat(change==null?void 0:change.key)})})})]})})]}),[change,closeRevertChangesConfirmDialog,conditionalReadOnly,confirmRevertOpen,DiffComponent,FieldWrapper,hidden,handleRevertButtonMouseEnter,handleRevertButtonMouseLeave,handleRevertChanges,handleRevertChangesConfirm,isComparingCurrent,isPermissionsLoading,permissions,revertHovered]);return content;}function useHover(){const ref=useRef(null);const[value,setValue]=useState(false);useEffect(()=>{const node=ref.current;if(!node){return()=>void 0;}const handleMouseOver=()=>setValue(true);const handleMouseOut=()=>setValue(false);node.addEventListener("mouseover",handleMouseOver);node.addEventListener("mouseout",handleMouseOut);return()=>{node.removeEventListener("mouseover",handleMouseOver);node.removeEventListener("mouseout",handleMouseOut);};},[]);return[ref,value];}const ChangeListWrapper$1=styled.div(_templateObject235||(_templateObject235=_taggedTemplateLiteral(["\n  display: grid;\n  grid-template-columns: minmax(0, 1fr);\n"])));const GroupChangeContainer=styled.div(_templateObject236||(_templateObject236=_taggedTemplateLiteral(["\n  --field-change-error: ",";\n  --diff-inspect-padding-xsmall: ",";\n  --diff-inspect-padding-small: ",";\n\n  position: relative;\n  padding: var(--diff-inspect-padding-xsmall) var(--diff-inspect-padding-small);\n\n  &::before {\n    content: '';\n    display: block;\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    border-left: 1px solid var(--card-border-color);\n  }\n\n  &[data-error]:hover::before,\n  &[data-revert-group-hover]:hover::before,\n  &[data-revert-all-groups-hover]::before {\n    border-left: 2px solid var(--field-change-error);\n  }\n"])),_ref300=>{let{theme}=_ref300;return theme.sanity.color.solid.critical.enabled.bg;},_ref301=>{let{theme}=_ref301;return rem(theme.sanity.space[1]);},_ref302=>{let{theme}=_ref302;return rem(theme.sanity.space[2]);});const PopoverWrapper$1=styled(Popover)(_templateObject237||(_templateObject237=_taggedTemplateLiteral(["\n  /* hides the popover when the target of it has left the visible part of the window.\n   without it, the popover will be on top of the headers (document title & changes)\n   and footers (changed notifications, publish button etc)*/\n  &[data-popper-reference-hidden='true'] {\n    display: none;\n  }\n"])));function GroupChange(props){const{change:group,readOnly,hidden}=props,restProps=_objectWithoutProperties(props,_excluded74);const{titlePath,changes,path:groupPath}=group;const{path:diffPath}=useContext(DiffContext);const{documentId,schemaType,FieldWrapper,rootDiff,isComparingCurrent}=useDocumentChange();const isPortableText=changes.every(change=>isFieldChange(change)&&isPTSchemaType(change.schemaType));const isNestedInDiff=pathsAreEqual(diffPath,groupPath);const[revertButtonRef,isRevertButtonHovered]=useHover();const docOperations=useDocumentOperation(documentId,schemaType.name);const[confirmRevertOpen,setConfirmRevertOpen]=useState(false);const[revertPopoverElement,setRevertPopoverElement]=useState(null);const[permissions,isPermissionsLoading]=useDocumentPairPermissions({id:documentId,type:schemaType.name,permission:"update"});const handleRevertChanges=useCallback(()=>undoChange(group,rootDiff,docOperations),[group,rootDiff,docOperations]);const handleRevertChangesConfirm=useCallback(()=>{setConfirmRevertOpen(true);},[]);const closeRevertChangesConfirmDialog=useCallback(()=>{setConfirmRevertOpen(false);},[]);useClickOutside(()=>setConfirmRevertOpen(false),[revertPopoverElement]);const content=useMemo(()=>hidden?null:/* @__PURE__ */jsxs(Stack,{space:1,as:GroupChangeContainer,"data-revert-group-hover":isRevertButtonHovered?"":void 0,"data-portable-text":isPortableText?"":void 0,children:[/* @__PURE__ */jsx(Stack,{as:ChangeListWrapper$1,space:5,children:changes.map(change=>/* @__PURE__ */jsx(ChangeResolver,{change,readOnly,hidden},change.key))}),isComparingCurrent&&!isPermissionsLoading&&(permissions==null?void 0:permissions.granted)&&/* @__PURE__ */jsx(PopoverWrapper$1,{content:/* @__PURE__ */jsxs(Box,{children:["Are you sure you want to revert the changes?",/* @__PURE__ */jsxs(Grid,{columns:2,gap:2,marginTop:2,children:[/* @__PURE__ */jsx(Button,{mode:"ghost",onClick:closeRevertChangesConfirmDialog,children:/* @__PURE__ */jsx(Text$1,{align:"center",children:"Cancel"})}),/* @__PURE__ */jsx(Button,{tone:"critical",onClick:handleRevertChanges,children:/* @__PURE__ */jsx(Text$1,{align:"center",children:"Revert change"})})]})]}),portal:true,padding:4,placement:"left",open:confirmRevertOpen,ref:setRevertPopoverElement,children:/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(RevertChangesButton,{onClick:handleRevertChangesConfirm,ref:revertButtonRef,selected:confirmRevertOpen,disabled:readOnly,"data-testid":"group-change-revert-button-".concat(group.fieldsetName)})})})]}),[changes,closeRevertChangesConfirmDialog,confirmRevertOpen,readOnly,group.fieldsetName,handleRevertChanges,handleRevertChangesConfirm,hidden,isComparingCurrent,isRevertButtonHovered,isPermissionsLoading,isPortableText,permissions,revertButtonRef]);return hidden?null:/* @__PURE__ */jsxs(Stack,_objectSpread(_objectSpread({space:1},restProps),{},{children:[/* @__PURE__ */jsx(ChangeBreadcrumb,{titlePath}),isNestedInDiff||!FieldWrapper?content:/* @__PURE__ */jsx(FieldWrapper,{hasHover:isRevertButtonHovered,path:group.path,children:content})]}));}function ChangeResolver(props){var _a,_b;const{change,hidden,readOnly}=props;const{value}=useDocumentChange();const isHidden=useConditionalProperty({document:value,checkProperty:hidden||((_a=change.schemaType)==null?void 0:_a.hidden),checkPropertyKey:"hidden",value:change.type==="field"?change.diff.toValue:void 0});const isReadOnly=useConditionalProperty({document:value,checkProperty:readOnly||((_b=change.schemaType)==null?void 0:_b.readOnly),checkPropertyKey:"readOnly",value:change.type==="field"?change.diff.toValue:void 0});if(isHidden)return null;if(change.type==="field"){return/* @__PURE__ */jsx(FieldChange,{change,readOnly:isReadOnly});}if(change.type==="group"){return/* @__PURE__ */jsx(GroupChange,{change,"data-testid":"group-change-".concat(change.fieldsetName),readOnly:isReadOnly});}return/* @__PURE__ */jsxs(Text$1,{children:["Unknown change type: ",/* @__PURE__ */jsx("code",{children:change.type||"undefined"})]});}function NoChanges(){return/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",as:"h3",children:"There are no changes"}),/* @__PURE__ */jsx(Text$1,{as:"p",size:1,muted:true,children:"Edit the document or select an older version in the timeline to see a list of changes appear in this panel."})]});}const ChangeListWrapper=styled.div(_templateObject238||(_templateObject238=_taggedTemplateLiteral(["\n  display: grid;\n  grid-template-columns: minmax(0, 1fr);\n"])));const PopoverWrapper=styled(Popover)(_templateObject239||(_templateObject239=_taggedTemplateLiteral(["\n  /* hides the popover when the target of it has left the visible part of the window.\n   without it, the popover will be on top of the headers (document title & changes)\n   and footers (changed notifications, publish button etc)*/\n  &[data-popper-reference-hidden='true'] {\n    display: none;\n  }\n"])));function ChangeList(_ref303){let{diff,fields,schemaType}=_ref303;const{documentId,isComparingCurrent,value}=useDocumentChange();const docOperations=useDocumentOperation(documentId,schemaType.name);const{path}=useContext(DiffContext);const isRoot=path.length===0;const[confirmRevertAllOpen,setConfirmRevertAllOpen]=useState(false);const[confirmRevertAllHover,setConfirmRevertAllHover]=useState(false);const isReadOnly=useConditionalProperty({document:value,value:void 0,checkProperty:schemaType.readOnly,checkPropertyKey:"readOnly"});if(schemaType.jsonType!=="object"){throw new Error("Only object schema types are allowed in ChangeList");}const[permissions,isPermissionsLoading]=useDocumentPairPermissions({id:documentId,type:schemaType.name,permission:"update"});const allChanges=useMemo(()=>buildObjectChangeList(schemaType,diff,path,[],{fieldFilter:fields}),[schemaType,fields,path,diff]);const changes=useMemo(()=>fields&&fields.length===0?[]:maybeFlatten(allChanges),[allChanges,fields]);const rootChange=allChanges[0];const revertAllChanges=useCallback(()=>{undoChange(rootChange,diff,docOperations);setConfirmRevertAllOpen(false);},[rootChange,diff,docOperations]);const handleRevertAllChangesClick=useCallback(()=>{setConfirmRevertAllOpen(true);},[]);const handleRevertAllChangesMouseEnter=useCallback(()=>{setConfirmRevertAllHover(true);},[]);const handleRevertAllChangesMouseLeave=useCallback(()=>{setConfirmRevertAllHover(false);},[]);const closeRevertAllChangesConfirmDialog=useCallback(()=>{setConfirmRevertAllOpen(false);},[]);const[revertAllContainerElement,setRevertAllContainerElement]=useState(null);const handleClickOutside=useCallback(()=>setConfirmRevertAllOpen(false),[]);useClickOutside(handleClickOutside,[revertAllContainerElement]);if(changes.length===0){return isRoot?/* @__PURE__ */jsx(NoChanges,{}):null;}const showFooter=isRoot&&changes.length>1;return/* @__PURE__ */jsx(Card,{children:/* @__PURE__ */jsxs(Stack,{space:5,children:[/* @__PURE__ */jsx(Stack,{as:ChangeListWrapper,space:5,children:changes.map(change=>/* @__PURE__ */jsx("div",{children:/* @__PURE__ */jsx(ChangeResolver,{change,"data-revert-all-changes-hover":confirmRevertAllHover?"":void 0,readOnly:isReadOnly||(change==null?void 0:change.readOnly),hidden:change==null?void 0:change.hidden},change.key)},change.key))}),showFooter&&isComparingCurrent&&!isPermissionsLoading&&(permissions==null?void 0:permissions.granted)&&/* @__PURE__ */jsx(PopoverWrapper,{content:/* @__PURE__ */jsxs(Box,{children:["Are you sure you want to revert all ",changes.length," changes?",/* @__PURE__ */jsxs(Grid,{columns:2,gap:2,marginTop:2,children:[/* @__PURE__ */jsx(Button,{mode:"ghost",text:"Cancel",onClick:closeRevertAllChangesConfirmDialog}),/* @__PURE__ */jsx(Button,{tone:"critical",text:"Revert all",onClick:revertAllChanges})]})]}),open:confirmRevertAllOpen,padding:4,placement:"left",portal:true,ref:setRevertAllContainerElement,children:/* @__PURE__ */jsx(Stack,{children:/* @__PURE__ */jsx(Button,{tone:"critical",mode:"ghost",text:"Revert all changes",icon:RevertIcon,onClick:handleRevertAllChangesClick,onMouseEnter:handleRevertAllChangesMouseEnter,onMouseLeave:handleRevertAllChangesMouseLeave,disabled:isReadOnly})})})]})});}function maybeFlatten(changes){return changes.length===1&&changes[0].type==="group"&&changes[0].path.length===0?changes[0].changes:changes;}const RoundedCard=styled.span(_templateObject240||(_templateObject240=_taggedTemplateLiteral(["\n  border-radius: ",";\n"])),_ref304=>{let{theme}=_ref304;return rem(theme.sanity.radius[1]);});const ChangeSegment=styled(Text$1)(_templateObject241||(_templateObject241=_taggedTemplateLiteral(["\n  &:not([hidden]) {\n    display: inline;\n    line-height: calc(1.25em + 2px);\n  }\n\n  &:hover {\n    background-color: none !important;\n    background-image: linear-gradient(\n      to bottom,\n      var(--card-bg-color) 0,\n      var(--card-bg-color) 33.333%,\n      currentColor 33.333%,\n      currentColor 100%\n    );\n    background-size: 1px 3px;\n    background-repeat: repeat-x;\n    background-position-y: bottom;\n    padding-bottom: 3px;\n    box-shadow: 0 0 0 1px var(--card-bg-color);\n    z-index: 1;\n  }\n"])));function DiffStringSegment(props){const{segment}=props;const{text}=segment;if(segment.action==="added"){return/* @__PURE__ */jsx(DiffCard,{annotation:segment.annotation,disableHoverEffect:true,tooltip:{description:"Added"},as:RoundedCard,children:/* @__PURE__ */jsx(ChangeSegment,{as:"ins",style:{textDecoration:"none"},children:text})});}if(segment.action==="removed"){return/* @__PURE__ */jsx(DiffCard,{annotation:segment.annotation,as:RoundedCard,disableHoverEffect:true,tooltip:{description:"Removed"},children:/* @__PURE__ */jsx(ChangeSegment,{as:"del",children:text})});}return/* @__PURE__ */jsx(Card,{as:"span",radius:2,style:{display:"inline"},children:text});}function DiffString(props){const{diff}=props;return/* @__PURE__ */jsx(Fragment,{children:(diff.segments||[]).map((segment,segmentIndex)=>/* @__PURE__ */jsx(DiffStringSegment,{segment},segmentIndex))});}const MetaText=styled(Text$1)(_templateObject242||(_templateObject242=_taggedTemplateLiteral(["\n  color: inherit;\n"])));function MetaInfo(props){const{title,action,icon,children,markRemoved}=props;return/* @__PURE__ */jsxs(Flex,{padding:2,align:"center",children:[icon&&/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(MetaText,{size:4,forwardedAs:markRemoved?"del":"div",children:createElement(icon)})}),/* @__PURE__ */jsxs(Stack,{space:2,paddingLeft:2,children:[/* @__PURE__ */jsx(MetaText,{size:1,weight:"semibold",forwardedAs:markRemoved?"del":"h3",textOverflow:"ellipsis",children:title}),action&&/* @__PURE__ */jsx("div",{children:action}),/* @__PURE__ */jsx(MetaText,{size:0,textOverflow:"ellipsis",children})]})]});}const DEFAULT_DATE_FORMAT$2="YYYY-MM-DD";const DEFAULT_TIME_FORMAT$1="HH:mm";const DatetimeWrapper=styled.div(_templateObject243||(_templateObject243=_taggedTemplateLiteral(["\n  display: inline-block;\n  word-wrap: break-word;\n"])));const DatetimePreview=function DatetimePreview2(_ref305){let{value,schemaType}=_ref305;return/* @__PURE__ */jsx(Box,{as:DatetimeWrapper,paddingX:2,paddingY:1,children:formatDateTime(value,schemaType)});};function formatDateTime(value,schemaType){const{options,name}=schemaType;const dateFormat=(options==null?void 0:options.dateFormat)||DEFAULT_DATE_FORMAT$2;const timeFormat=(options==null?void 0:options.timeFormat)||DEFAULT_TIME_FORMAT$1;return legacyDateFormat.format(new Date(value),name==="date"?dateFormat:"".concat(dateFormat," ").concat(timeFormat));}const SlugWrapper=styled.div(_templateObject244||(_templateObject244=_taggedTemplateLiteral(["\n  display: inline-block;\n  word-break: break-all;\n  white-space: pre-wrap;\n"])));const SlugPreview=props=>{const{value}=props;return/* @__PURE__ */jsx(Box,{as:SlugWrapper,paddingX:2,paddingY:1,children:value.current});};const TIMELINE_LABELS={create:"created",delete:"deleted",discardDraft:"discarded draft",initial:"created",editDraft:"edited",editLive:"live edited",publish:"published",unpublish:"unpublished"};const TIMELINE_ICON_COMPONENTS={create:AddCircleIcon,delete:TrashIcon,discardDraft:CloseIcon,initial:AddCircleIcon,editDraft:EditIcon,editLive:EditIcon,publish:PublishIcon,unpublish:UnpublishIcon};function formatTimelineEventLabel(type){return TIMELINE_LABELS[type];}function getTimelineEventIconComponent(type){return TIMELINE_ICON_COMPONENTS[type];}function sinceTimelineProps(since,rev){return{topSelection:rev,bottomSelection:since,disabledBeforeSelection:true};}function revTimelineProps(rev){return{topSelection:rev,bottomSelection:rev};}function UserAvatarStack(_ref306){let{maxLength,userIds}=_ref306;return/* @__PURE__ */jsx(AvatarStack,{maxLength,children:userIds.map(userId=>/* @__PURE__ */jsx(UserAvatar,{user:userId,withTooltip:true},userId))});}const IconWrapper=styled(Flex)(_ref307=>{let{theme}=_ref307;var _a;const borderColor=(_a=theme.sanity.color.base.skeleton)==null?void 0:_a.from;return css(_templateObject245||(_templateObject245=_taggedTemplateLiteral(["\n    --timeline-hairline-width: 1px;\n    position: relative;\n    z-index: 2;\n    margin: 0;\n    padding: 0;\n\n    &::before {\n      position: absolute;\n      content: '';\n      height: 100%;\n      width: var(--timeline-hairline-width);\n      background: ",";\n      top: 0;\n      left: calc((100% - var(--timeline-hairline-width)) / 2);\n      z-index: 1;\n    }\n  "])),borderColor);});const Root$b=styled(MenuItem)(_ref308=>{let{state="enabled",isHovered,theme}=_ref308;const{color}=theme.sanity;const selectedState=color.button.default.primary.enabled;return css(_templateObject246||(_templateObject246=_taggedTemplateLiteral(["\n    position: relative;\n    min-width: 244px;\n\n    ","\n\n    ","\n\n      ","\n\n    // line styling \uD83D\uDC47\n      &:first-child ","::before {\n      height: 50%;\n      top: unset;\n      bottom: 0;\n    }\n\n    &:last-child ","::before {\n      height: 50%;\n    }\n\n    ","\n\n    // Remove timeline lines when using the keyboard to navigate timeline items\n    &:focus ","::before {\n      background: transparent;\n    }\n  "])),state==="selected"&&css(_templateObject247||(_templateObject247=_taggedTemplateLiteral(["\n      --card-bg-color: ",";\n      --card-fg-color: ",";\n      --card-muted-fg-color: ",";\n      --card-border-color: ",";\n      &:not([data-selection-bottom='true']) {\n        border-top-left-radius: 0;\n        border-top-right-radius: 0;\n      }\n    "])),selectedState.bg,selectedState.fg,selectedState.muted,selectedState.bg),state==="withinSelection"&&css(_templateObject248||(_templateObject248=_taggedTemplateLiteral(["\n      border-bottom-left-radius: 0;\n      border-bottom-right-radius: 0;\n      box-shadow: 0px 3px 0px 0px var(--card-bg-color);\n      &:not([data-selection-top='true']) {\n        border-radius: 0;\n      }\n\n      "," {\n        &::before {\n          background: var(--card-hairline-soft-color);\n        }\n      }\n    "])),IconWrapper),state==="disabled"&&css(_templateObject249||(_templateObject249=_taggedTemplateLiteral(["\n      [data-ui='Avatar'] {\n        opacity: 0.2;\n      }\n    "]))),IconWrapper,IconWrapper,(isHovered||state==="selected")&&css(_templateObject250||(_templateObject250=_taggedTemplateLiteral(["\n      ","::before {\n        background: transparent;\n      }\n    "])),IconWrapper),IconWrapper);});const IconBox=styled(Box)(_templateObject251||(_templateObject251=_taggedTemplateLiteral(["\n  background: var(--card-bg-color);\n  border-radius: 50px;\n  position: relative;\n  z-index: 2;\n"])));const EventLabel=styled(Text$1)(_templateObject252||(_templateObject252=_taggedTemplateLiteral(["\n  text-transform: capitalize;\n"])));const TIMELINE_ITEM_EVENT_TONE={initial:"primary",create:"primary",publish:"positive",editLive:"caution",editDraft:"caution",unpublish:"critical",discardDraft:"critical",delete:"critical",withinSelection:"primary"};function TimelineItem(props){const{isSelectionBottom,isSelectionTop,state,onSelect,timestamp,chunk,type}=props;const iconComponent=getTimelineEventIconComponent(type);const authorUserIds=Array.from(chunk.authors);const timeAgo=useTimeAgo(timestamp,{minimal:true});const isSelected=state==="selected";const isWithinSelection=state==="withinSelection";const[isHovered,setHovered]=useState(false);const handleClick=useCallback(evt=>{evt.preventDefault();evt.stopPropagation();onSelect(chunk);},[onSelect,chunk]);return/* @__PURE__ */jsx(Root$b,{"data-ui":"timelineItem",radius:2,"data-chunk-id":chunk.id,paddingY:0,paddingX:2,tone:isHovered||isSelected||isWithinSelection?"default":TIMELINE_ITEM_EVENT_TONE[type],pressed:isWithinSelection,state,selected:isSelected,isHovered,disabled:state==="disabled","data-selection-bottom":isSelectionBottom,"data-selection-top":isSelectionTop,onClick:handleClick,children:/* @__PURE__ */jsx("div",{onMouseEnter:()=>setHovered(true),onMouseLeave:()=>setHovered(false),children:/* @__PURE__ */jsxs(Flex,{align:"stretch",children:[/* @__PURE__ */jsx(IconWrapper,{align:"center",children:/* @__PURE__ */jsx(IconBox,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:2,children:iconComponent&&createElement(iconComponent)})})}),/* @__PURE__ */jsxs(Stack,{space:2,margin:2,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(EventLabel,{size:1,weight:"medium",children:formatTimelineEventLabel(type)||/* @__PURE__ */jsx("code",{children:type})})}),/* @__PURE__ */jsx(Text$1,{size:0,muted:true,children:timeAgo})]}),/* @__PURE__ */jsx(Flex,{flex:1,justify:"flex-end",align:"center",children:/* @__PURE__ */jsx(UserAvatarStack,{maxLength:3,userIds:authorUserIds})})]})})});}const Root$a=styled(Box)(_templateObject253||(_templateObject253=_taggedTemplateLiteral(["\n  overflow: auto;\n  -webkit-overflow-scrolling: touch;\n"])));const StackWrapper=styled(Stack)(_templateObject254||(_templateObject254=_taggedTemplateLiteral(["\n  max-width: 200px;\n"])));const MenuWrapper=styled(Menu)(_templateObject255||(_templateObject255=_taggedTemplateLiteral(["\n  overflow: auto;\n  box-sizing: border-box;\n  max-height: calc(100vh - 198px);\n"])));const LOAD_MORE_OFFSET=20;const Timeline=_ref309=>{let{timeline,disabledBeforeSelection,topSelection,bottomSelection,onSelect,onLoadMore}=_ref309;const rootRef=useRef(null);const listRef=useRef(null);const[loadingElement,setLoadingElement]=useState(null);let state=disabledBeforeSelection?"disabled":"enabled";const checkIfLoadIsNeeded=useCallback(()=>{const rootEl=rootRef.current;if(loadingElement&&rootEl){const{offsetHeight,scrollTop}=rootEl;const bottomPosition=offsetHeight+scrollTop+LOAD_MORE_OFFSET;const isVisible=loadingElement.offsetTop<bottomPosition;if(isVisible){requestAnimationFrame(()=>onLoadMore(isVisible));}}},[onLoadMore,loadingElement]);useEffect(checkIfLoadIsNeeded,[checkIfLoadIsNeeded]);return/* @__PURE__ */jsxs(Root$a,{ref:rootRef,onScroll:checkIfLoadIsNeeded,"data-ui":"timeline",children:[timeline.chunkCount===0&&/* @__PURE__ */jsxs(StackWrapper,{padding:3,space:3,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:"No document history"}),/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:"When changing the content of the document, the document versions will appear in this menu."})]}),timeline.chunkCount>0&&/* @__PURE__ */jsx(MenuWrapper,{ref:listRef,padding:1,space:0,children:timeline.mapChunks(chunk=>{const isSelectionTop=topSelection===chunk;const isSelectionBottom=bottomSelection===chunk;if(isSelectionTop){state="withinSelection";}if(isSelectionBottom){state="selected";}const item=/* @__PURE__ */jsx(TimelineItem,{chunk,isSelectionBottom,isSelectionTop,state,onSelect,type:chunk.type,timestamp:chunk.endTimestamp},chunk.id);if(state==="selected"){state="enabled";}return item;})}),!timeline.reachedEarliestEntry&&/* @__PURE__ */jsx(Flex,{align:"center",justify:"center",padding:4,ref:setLoadingElement,children:/* @__PURE__ */jsx(Spinner,{muted:true})})]});};Timeline.displayName="Timeline";const DocumentPaneContext=createContext(null);function useDocumentPane(){const documentPane=useContext(DocumentPaneContext);if(!documentPane){throw new Error("DocumentPane: missing context value");}return documentPane;}const Root$9=styled(Popover)(_templateObject256||(_templateObject256=_taggedTemplateLiteral(["\n  & > div {\n    display: flex;\n    flex-direction: column;\n\n    & > [data-ui='Card'] {\n      flex: 1;\n      min-height: 0;\n      display: flex;\n      flex-direction: column;\n\n      /* This is the scrollable container rendered by <Timeline /> */\n      & > div {\n        flex: 1;\n        min-height: 0;\n      }\n    }\n  }\n"])));function TimelineMenu(_ref310){let{chunk,mode}=_ref310;const{historyController,setTimelineRange,setTimelineMode,timeline,ready}=useDocumentPane();const[open,setOpen]=useState(false);const[buttonRef,setButtonRef]=useState(null);const[menuContent,setMenuContent]=useState(null);const handleOpen=useCallback(()=>{setTimelineMode(mode);setOpen(true);},[mode,setTimelineMode]);const handleClose=useCallback(()=>{setTimelineMode("closed");setOpen(false);},[setTimelineMode]);const handleClickOutside=useCallback(()=>{handleClose();},[handleClose]);useClickOutside(handleClickOutside,[menuContent,buttonRef]);const selectRev=useCallback(revChunk=>{const[sinceId,revId]=historyController.findRangeForNewRev(revChunk);setTimelineMode("closed");setOpen(false);setTimelineRange(sinceId,revId);},[historyController,setTimelineMode,setTimelineRange]);const selectSince=useCallback(sinceChunk=>{const[sinceId,revId]=historyController.findRangeForNewSince(sinceChunk);setTimelineMode("closed");setOpen(false);setTimelineRange(sinceId,revId);},[historyController,setTimelineMode,setTimelineRange]);const loadMoreHistory=useCallback(state=>{historyController.setLoadMore(state);},[historyController]);const content=open&&/* @__PURE__ */jsx("div",{ref:setMenuContent,children:mode==="rev"?/* @__PURE__ */jsx(Timeline,_objectSpread({onSelect:selectRev,onLoadMore:loadMoreHistory,timeline},revTimelineProps(historyController.realRevChunk))):/* @__PURE__ */jsx(Timeline,_objectSpread({onSelect:selectSince,onLoadMore:loadMoreHistory,timeline},sinceTimelineProps(historyController.sinceTime,historyController.realRevChunk)))});const timeAgo=useTimeAgo((chunk==null?void 0:chunk.endTimestamp)||"",{agoSuffix:true});const revLabel=chunk?"".concat(upperFirst(formatTimelineEventLabel(chunk.type))," ").concat(timeAgo):"Current version";const sinceLabel=chunk?"Since ".concat(formatTimelineEventLabel(chunk.type)," ").concat(timeAgo):"Since unknown version";const openLabel=mode==="rev"?"Select version":"Review changes since";const buttonLabel=mode==="rev"?revLabel:sinceLabel;return/* @__PURE__ */jsx(Root$9,{constrainSize:true,content,"data-ui":"versionMenu",open,portal:true,referenceElement:buttonRef,children:/* @__PURE__ */jsx(Button,{disabled:!ready,mode:"bleed",fontSize:1,padding:2,iconRight:SelectIcon,onClick:open?handleClose:handleOpen,ref:setButtonRef,selected:open,text:open?openLabel:buttonLabel})});}function collectLatestAuthorAnnotations(diff){const authorMap=/* @__PURE__ */new Map();visitDiff(diff,child=>{if(child.action==="unchanged"||!("annotation"in child)||!child.annotation){return true;}const{author,timestamp}=child.annotation;const previous=authorMap.get(author);if(!previous||previous.timestamp<timestamp){authorMap.set(author,child.annotation);}return true;});return Array.from(authorMap.values()).sort((a,b)=>a.timestamp<b.timestamp?1:-1);}function LoadingContent(){return/* @__PURE__ */jsxs(Flex,{align:"center",justify:"center",children:[/* @__PURE__ */jsx(Spinner,{muted:true}),/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(Text$1,{align:"center",children:"Loading changes\u2026"})})]});}const Scroller$1=styled(ScrollContainer)(_templateObject257||(_templateObject257=_taggedTemplateLiteral(["\n  height: 100%;\n  overflow: auto;\n  position: relative;\n  scroll-behavior: smooth;\n"])));function ChangesPanel(){const{documentId,onHistoryClose,historyController,schemaType,value}=useDocumentPane();const{collapsed}=usePane();const scrollRef=useRef(null);const historyState=historyController.selectionState;const loading=historyState==="loading";const since=historyController.sinceTime;const diff=historyController.currentObjectDiff();const isComparingCurrent=!historyController.onOlderRevision();const documentContext=React.useMemo(()=>({documentId,schemaType,FieldWrapper:ChangeFieldWrapper,rootDiff:diff,isComparingCurrent,value}),[documentId,diff,isComparingCurrent,schemaType,value]);const changeAnnotations=React.useMemo(()=>diff?collectLatestAuthorAnnotations(diff):[],[diff]);if(collapsed){return null;}return/* @__PURE__ */jsxs(Flex,{direction:"column",flex:1,style:{borderLeft:"1px dashed var(--card-border-color)",overflow:"hidden",minWidth:320},"data-testid":"review-changes-pane",children:[/* @__PURE__ */jsx(PaneHeader,{actions:/* @__PURE__ */jsx(Button,{icon:CloseIcon,mode:"bleed",onClick:onHistoryClose,padding:3,title:"Hide changes panel"}),subActions:changeAnnotations.length>0&&/* @__PURE__ */jsx(Box,{paddingRight:1,children:/* @__PURE__ */jsx(DiffTooltip,{annotations:changeAnnotations,description:"Changes by",placement:"bottom-end",children:/* @__PURE__ */jsx(AvatarStack,{maxLength:4,children:changeAnnotations.map(_ref311=>{let{author}=_ref311;return/* @__PURE__ */jsx(UserAvatar,{user:author},author);})})})}),tabs:/* @__PURE__ */jsx(TimelineMenu,{mode:"since",chunk:since}),title:"Changes"}),/* @__PURE__ */jsx(PaneContent,{children:/* @__PURE__ */jsx(BoundaryElementProvider,{element:scrollRef.current,children:/* @__PURE__ */jsx(Scroller$1,{"data-ui":"Scroller",ref:scrollRef,children:/* @__PURE__ */jsx(Box,{flex:1,padding:4,children:/* @__PURE__ */jsx(Content,{diff,documentContext,loading})})})})})]});}function Content(_ref312){let{diff,documentContext,loading}=_ref312;const{schemaType}=useDocumentPane();if(loading){return/* @__PURE__ */jsx(LoadingContent,{});}if(!diff){return/* @__PURE__ */jsx(NoChanges,{});}return/* @__PURE__ */jsx(DocumentChangeContext.Provider,{value:documentContext,children:/* @__PURE__ */jsx(ChangeList,{diff,schemaType})});}function useDeskToolSetting(namespace,key,defaultValue){const settingsStore=useSettingsStore();const[value,setValue]=useState(defaultValue);const deskToolSettings=useMemo(()=>settingsStore.forNamespace("desk-tool"),[settingsStore]);const settings=useMemo(()=>{if(namespace){return deskToolSettings.forNamespace(namespace).forKey(key);}return deskToolSettings.forKey(key);},[deskToolSettings,namespace,key]);useEffect(()=>{const sub=settings.listen(defaultValue).subscribe({next:setValue});return()=>sub==null?void 0:sub.unsubscribe();},[defaultValue,key,namespace,settings]);const set=useCallback(newValue=>{setValue(newValue);settings.set(newValue);},[settings]);return useMemo(()=>[value,set],[set,value]);}const VIEW_MODE_PARSED={id:"parsed",title:"Parsed"};const VIEW_MODE_RAW={id:"raw",title:"Raw JSON"};const VIEW_MODES=[VIEW_MODE_PARSED,VIEW_MODE_RAW];const lru=HLRU(1e3);function isExpanded(keyPath,value){const cached=lru.get(keyPath);if(cached===void 0){lru.set(keyPath,Array.isArray(value)||isRecord$2(value));return isExpanded(keyPath,value);}return cached;}function toggleExpanded(event){const{path}=event;const current=lru.get(path);if(current===void 0){return;}lru.set(path,!current);}function selectElement(element){const sel=window.getSelection();if(sel){const range=document.createRange();sel.removeAllRanges();range.selectNodeContents(element);sel.addRange(range);}}function select$1(event){selectElement(event.currentTarget);}function maybeSelectAll(event){const selectAll=event.keyCode===65&&(event.metaKey||event.ctrlKey);if(!selectAll){return;}event.preventDefault();selectElement(event.currentTarget);}function isDocumentLike(value){return isRecord$2(value)&&isString(value._id)&&isString(value._type);}const JSONInspectorWrapper=styled.div(_ref313=>{let{theme}=_ref313;const{color,fonts,space}=theme.sanity;return css(_templateObject258||(_templateObject258=_taggedTemplateLiteral(["\n    & .json-inspector,\n    & .json-inspector .json-inspector__selection {\n      font-family: ",";\n      font-size: ","px;\n      line-height: ","px;\n      color: var(--card-code-fg-color);\n    }\n\n    & .json-inspector .json-inspector__leaf {\n      padding-left: ",";\n    }\n\n    & .json-inspector .json-inspector__leaf.json-inspector__leaf_root {\n      padding-top: ",";\n      padding-left: 0;\n    }\n\n    & .json-inspector > .json-inspector__leaf_root > .json-inspector__line > .json-inspector__key {\n      display: none;\n    }\n\n    & .json-inspector .json-inspector__line {\n      display: block;\n      position: relative;\n      cursor: default;\n    }\n\n    & .json-inspector .json-inspector__line::after {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: -200px;\n      right: -50px;\n      bottom: 0;\n      z-index: -1;\n      pointer-events: none;\n    }\n\n    & .json-inspector .json-inspector__line:hover::after {\n      background: var(--card-code-bg-color);\n    }\n\n    & .json-inspector .json-inspector__leaf_composite > .json-inspector__line {\n      cursor: pointer;\n    }\n\n    & .json-inspector .json-inspector__leaf_composite > .json-inspector__line::before {\n      content: '\u25B8 ';\n      margin-left: calc(0 - "," + 3px);\n      font-size: ","px;\n      line-height: ","px;\n    }\n\n    &\n      .json-inspector\n      .json-inspector__leaf_expanded.json-inspector__leaf_composite\n      > .json-inspector__line::before {\n      content: '\u25BE ';\n      font-size: ","px;\n      line-height: ","px;\n    }\n\n    & .json-inspector .json-inspector__radio,\n    & .json-inspector .json-inspector__flatpath {\n      display: none;\n    }\n\n    & .json-inspector .json-inspector__value {\n      margin-left: ",";\n    }\n\n    &\n      .json-inspector\n      > .json-inspector__leaf_root\n      > .json-inspector__line\n      > .json-inspector__key\n      + .json-inspector__value {\n      margin: 0;\n    }\n\n    & .json-inspector .json-inspector__key {\n      color: ",";\n    }\n\n    & .json-inspector .json-inspector__value_helper,\n    & .json-inspector .json-inspector__value_null {\n      color: ",";\n    }\n\n    & .json-inspector .json-inspector__not-found {\n      padding-top: ",";\n    }\n\n    & .json-inspector .json-inspector__value_string {\n      color: ",";\n    }\n\n    & .json-inspector .json-inspector__value_boolean {\n      color: ",";\n    }\n\n    & .json-inspector .json-inspector__value_number {\n      color: ",";\n    }\n\n    & .json-inspector .json-inspector__show-original {\n      display: inline-block;\n      padding: 0 6px;\n      cursor: pointer;\n    }\n\n    & .json-inspector .json-inspector__show-original:hover {\n      color: inherit;\n    }\n\n    & .json-inspector .json-inspector__show-original::before {\n      content: '\u2194';\n    }\n\n    & .json-inspector .json-inspector__show-original:hover::after {\n      content: ' expand';\n    }\n  "])),fonts.code.family,fonts.code.sizes[2].fontSize,fonts.code.sizes[2].lineHeight,rem(space[4]),rem(space[3]),rem(space[4]),fonts.code.sizes[2].fontSize,fonts.code.sizes[2].lineHeight,fonts.code.sizes[2].fontSize,fonts.code.sizes[2].lineHeight,rem(space[4]/2),color.syntax.property,color.syntax.constant,rem(space[3]),color.syntax.string,color.syntax.boolean,color.syntax.number);});function Search(props){const{onChange,query}=props;const handleChange=useCallback(event=>onChange(event.target.value),[onChange]);return/* @__PURE__ */jsx(TextInput$1,{icon:SearchIcon,onChange:handleChange,placeholder:"Search",radius:2,value:query||""});}function InspectDialog(props){const{value}=props;const{onInspectClose,paneKey}=useDocumentPane();const dialogIdPrefix="".concat(paneKey,"_inspect_");const[viewModeId,onViewModeChange]=useDeskToolSetting("desk-tool","inspect-view-preferred-view-mode-".concat(paneKey),"parsed");const viewMode=VIEW_MODES.find(mode=>mode.id===viewModeId);const setParsedViewMode=useCallback(()=>{onViewModeChange(VIEW_MODE_PARSED.id);},[onViewModeChange]);const setRawViewMode=useCallback(()=>{onViewModeChange(VIEW_MODE_RAW.id);},[onViewModeChange]);return/* @__PURE__ */jsx(Dialog,{id:"".concat(dialogIdPrefix,"dialog"),header:isDocumentLike(value)?/* @__PURE__ */jsxs(Fragment,{children:["Inspecting"," ",/* @__PURE__ */jsx("em",{children:/* @__PURE__ */jsx(DocTitle,{document:value})})]}):/* @__PURE__ */jsx("em",{children:"No value"}),onClose:onInspectClose,width:3,children:/* @__PURE__ */jsxs(Flex,{direction:"column",height:"fill",children:[/* @__PURE__ */jsx(Card,{padding:3,shadow:1,style:{position:"sticky",bottom:0,zIndex:3},children:/* @__PURE__ */jsxs(TabList,{space:1,children:[/* @__PURE__ */jsx(Tab,{"aria-controls":"".concat(dialogIdPrefix,"tabpanel"),fontSize:1,id:"".concat(dialogIdPrefix,"tab-").concat(VIEW_MODE_PARSED.id),label:VIEW_MODE_PARSED.title,onClick:setParsedViewMode,selected:viewMode===VIEW_MODE_PARSED}),/* @__PURE__ */jsx(Tab,{"aria-controls":"".concat(dialogIdPrefix,"tabpanel"),fontSize:1,id:"".concat(dialogIdPrefix,"tab-").concat(VIEW_MODE_RAW.id),label:VIEW_MODE_RAW.title,onClick:setRawViewMode,selected:viewMode===VIEW_MODE_RAW})]})}),/* @__PURE__ */jsxs(TabPanel,{"aria-labelledby":"".concat(dialogIdPrefix,"tab-").concat(viewModeId),flex:1,id:"".concat(dialogIdPrefix,"tabpanel"),overflow:"auto",padding:4,style:{outline:"none"},children:[viewMode===VIEW_MODE_PARSED&&/* @__PURE__ */jsx(JSONInspectorWrapper,{children:/* @__PURE__ */jsx(JSONInspector,{data:value,isExpanded,onClick:toggleExpanded,search:Search})}),viewMode===VIEW_MODE_RAW&&/* @__PURE__ */jsx(Code,{language:"json",tabIndex:0,onKeyDown:maybeSelectAll,onDoubleClick:select$1,onFocus:select$1,children:JSON.stringify(value,null,2)})]})]})});}const Root$8=styled(Card)(_templateObject259||(_templateObject259=_taggedTemplateLiteral(["\n  position: relative;\n  z-index: 50;\n"])));const TextOneLine=styled(Text$1)(_templateObject260||(_templateObject260=_taggedTemplateLiteral(["\n  & > * {\n    overflow: hidden;\n    white-space: nowrap;\n    text-overflow: ellipsis;\n  }\n"])));const ReferenceChangedBanner=memo(()=>{var _a,_b,_c,_d,_e,_f;const documentPreviewStore=useDocumentPreviewStore();const{params,groupIndex,routerPanesState,replaceCurrent,BackLink}=usePaneRouter();const routerReferenceId=(_a=routerPanesState[groupIndex])==null?void 0:_a[0].id;const parentGroup=routerPanesState[groupIndex-1];const parentSibling=parentGroup==null?void 0:parentGroup[0];const parentId=parentSibling==null?void 0:parentSibling.id;const hasHistoryOpen=Boolean((_b=parentSibling==null?void 0:parentSibling.params)==null?void 0:_b.rev);const parentRefPath=useMemo(()=>{return(params==null?void 0:params.parentRefPath)&&fromString(params.parentRefPath)||null;},[params==null?void 0:params.parentRefPath]);const referenceInfo=useMemoObservable(()=>{const parentRefPathSegment=parentRefPath==null?void 0:parentRefPath[0];if(!parentId||!parentRefPathSegment||!parentRefPath){return of({loading:false});}const publishedId=getPublishedId(parentId);const path=fromString(parentRefPathSegment);const keyedSegmentIndex=path.findIndex(p=>typeof p=="object"&&"_key"in p);return concat(of({loading:true}),documentPreviewStore.unstable_observePathsDocumentPair({_type:"reference",_ref:publishedId},keyedSegmentIndex===-1?path:path.slice(0,keyedSegmentIndex)).pipe(debounceTime(750),map(_ref314=>{let{draft,published}=_ref314;var _a2;return{loading:false,result:{availability:{draft:draft.availability,published:published.availability},refValue:(_a2=get$3(draft.snapshot||published.snapshot,parentRefPath))==null?void 0:_a2._ref}};})));},[parentId,parentRefPath],{loading:true});const handleReloadReference=useCallback(()=>{var _a2;if(referenceInfo.loading)return;if((_a2=referenceInfo.result)==null?void 0:_a2.refValue){replaceCurrent({id:referenceInfo.result.refValue,params});}},[referenceInfo.loading,referenceInfo.result,replaceCurrent,params]);const shouldHide=!parentId||!parentRefPath||hasHistoryOpen||referenceInfo.loading||!((_c=referenceInfo.result)==null?void 0:_c.availability.draft.available)&&!((_d=referenceInfo.result)==null?void 0:_d.availability.published.available)||((_e=referenceInfo.result)==null?void 0:_e.refValue)===routerReferenceId;if(shouldHide)return null;return/* @__PURE__ */jsx(Root$8,{shadow:1,tone:"caution","data-testid":"reference-changed-banner",children:/* @__PURE__ */jsx(Container$1,{paddingX:4,paddingY:2,sizing:"border",width:1,children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(WarningOutlineIcon,{})}),((_f=referenceInfo.result)==null?void 0:_f.refValue)?/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Box,{flex:1,marginLeft:3,children:/* @__PURE__ */jsx(TextOneLine,{title:"This reference has changed since you opened it.",size:1,children:"This reference has changed since you opened it."})}),/* @__PURE__ */jsx(Box,{marginLeft:3,children:/* @__PURE__ */jsx(Button,{onClick:handleReloadReference,icon:SyncIcon,fontSize:1,mode:"ghost",padding:2,space:2,text:"Reload reference"})})]}):/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Box,{flex:1,marginLeft:3,children:/* @__PURE__ */jsx(TextOneLine,{title:"This reference has been removed since you opened it.",size:1,children:"This reference has been removed since you opened it."})}),/* @__PURE__ */jsx(Box,{marginLeft:3,children:/* @__PURE__ */jsx(Button,{as:BackLink,icon:CloseIcon,fontSize:1,mode:"ghost",padding:2,space:2,text:"Close reference"})})]})]})})});});ReferenceChangedBanner.displayName="ReferenceChangedBanner";const Root$7=styled(Card)(_templateObject261||(_templateObject261=_taggedTemplateLiteral(["\n  position: relative;\n  z-index: 50;\n"])));function PermissionCheckBanner(_ref315){let{granted,requiredPermission}=_ref315;var _a,_b;const currentUser=useCurrentUser();const plural=((_a=currentUser==null?void 0:currentUser.roles)==null?void 0:_a.length)!==1;const roles=join(((_b=currentUser==null?void 0:currentUser.roles)==null?void 0:_b.map(r=>/* @__PURE__ */jsx("code",{children:r.title},r.name)))||[],", ");if(granted)return null;return/* @__PURE__ */jsx(Root$7,{"data-testid":"permission-check-banner",shadow:1,tone:"transparent",children:/* @__PURE__ */jsx(Container$1,{paddingX:4,paddingY:3,sizing:"border",width:1,children:/* @__PURE__ */jsxs(Flex,{align:"flex-start",children:[/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(ReadOnlyIcon,{})}),/* @__PURE__ */jsx(Box,{flex:1,marginLeft:3,children:/* @__PURE__ */jsxs(Text$1,{size:1,children:["Your role",plural&&"s"," ",roles," ",plural?"do":"does"," not have permissions to"," ",requiredPermission," this document."]})})]})})});}function join(array,sep){return array.reduce((result,item)=>{if(result===null){return[item];}return result.concat([sep,item]);},null);}const preventDefault=ev=>ev.preventDefault();function FormView(props){const{hidden,margins,granted}=props;const{collapsedFieldSets,collapsedPaths,displayed:value,documentId,documentType,onChange:_handleChange,historyController,validation,ready,formState,onFocus,onBlur,onSetCollapsedPath,onPathOpen,onSetCollapsedFieldSet,onSetActiveFieldGroup,schemaType}=useDocumentPane();const documentStore=useDocumentStore();const{revTime:rev}=historyController;const isNonExistent=!value||!value._id;const presence=useDocumentPresence(documentId);const patchChannel=useMemo(()=>createPatchChannel(),[]);const isReadOnly=useMemo(()=>{return formState===null||formState.readOnly||!ready||rev!==null||!granted||!isActionEnabled(schemaType,"update")||isNonExistent&&!isActionEnabled(schemaType,"create");},[formState,ready,rev,granted,isNonExistent,schemaType]);const handleChange=useCallback(patchEvent=>{if(!isReadOnly)_handleChange(patchEvent);},[_handleChange,isReadOnly]);useEffect(()=>{const sub=documentStore.pair.documentEvents(documentId,documentType).pipe(tap(event=>{if(event.type==="mutation"){patchChannel.publish(prepareMutationEvent(event));}if(event.type==="rebase"){patchChannel.publish(prepareRebaseEvent(event));}})).subscribe();return()=>{sub.unsubscribe();};},[documentId,documentStore,documentType,patchChannel]);const hasRev=Boolean(value==null?void 0:value._rev);useEffect(()=>{if(hasRev){patchChannel.publish({type:"mutation",patches:[],snapshot:value});}},[hasRev]);return/* @__PURE__ */jsx(Container$1,{hidden,paddingX:4,paddingTop:5,paddingBottom:9,sizing:"border",width:1,children:/* @__PURE__ */jsx(PresenceOverlay,{margins,children:/* @__PURE__ */jsx(Box,{as:"form",onSubmit:preventDefault,children:ready?formState===null?/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{children:"This form is hidden"})}):/* @__PURE__ */jsx(StudioFormBuilder,{__internal_patchChannel:patchChannel,collapsedFieldSets,collapsedPaths,focusPath:formState.focusPath,changed:formState.changed,focused:formState.focused,groups:formState.groups,id:"root",members:formState.members,onChange:handleChange,onFieldGroupSelect:onSetActiveFieldGroup,onPathBlur:onBlur,onPathFocus:onFocus,onPathOpen,onSetFieldSetCollapsed:onSetCollapsedFieldSet,onSetPathCollapsed:onSetCollapsedPath,presence,readOnly:isReadOnly,schemaType:formState.schemaType,validation,value:formState.value}):/* @__PURE__ */jsx(Delay,{ms:300,children:/* @__PURE__ */jsxs(Flex,{align:"center",direction:"column",height:"fill",justify:"center",children:[/* @__PURE__ */jsx(Spinner,{muted:true}),/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(Text$1,{align:"center",muted:true,size:1,children:"Loading document"})})]})})})})});}function prepareMutationEvent(event){const patches=event.mutations.map(mut=>mut.patch).filter(Boolean);return{type:"mutation",snapshot:event.document,patches:fromMutationPatches(event.origin,patches)};}function prepareRebaseEvent(event){const remotePatches=event.remoteMutations.map(mut=>mut.patch).filter(Boolean);const localPatches=event.localMutations.map(mut=>mut.patch).filter(Boolean);return{type:"rebase",snapshot:event.document,patches:fromMutationPatches("remote",remotePatches).concat(fromMutationPatches("local",localPatches))};}function DocumentHeaderTabs(){const{activeViewId,paneKey,views}=useDocumentPane();const tabPanelId="".concat(paneKey,"tabpanel");return/* @__PURE__ */jsx(TabList,{space:1,children:views.map((view,index)=>{var _a;return/* @__PURE__ */jsx(DocumentHeaderTab,{icon:view.icon,id:"".concat(paneKey,"tab-").concat(view.id),isActive:activeViewId===view.id,label:/* @__PURE__ */jsx(Fragment,{children:view.title}),tabPanelId,viewId:index===0?null:(_a=view.id)!=null?_a:null},view.id);})});}function DocumentHeaderTab(props){const{icon,id,isActive,label,tabPanelId,viewId}=props;const{ready}=useDocumentPane();const{setView}=usePaneRouter();const handleClick=useCallback(()=>setView(viewId),[setView,viewId]);return/* @__PURE__ */jsx(Tab,{"aria-controls":tabPanelId,disabled:!ready,fontSize:1,icon,id,selected:isActive,label,onClick:handleClick});}const StyledText$2=styled(Text$1)(_templateObject262||(_templateObject262=_taggedTemplateLiteral(["\n  white-space: initial;\n"])));const MENU_ITEM_TONES={error:"critical",warning:"caution",info:"primary"};function ListItem$1(props){const{marker,onClick,path,truncate}=props;const handleClick=useCallback(()=>{if(onClick){onClick(marker.path);}},[marker.path,onClick]);const menuItemTone=MENU_ITEM_TONES[marker==null?void 0:marker.level]||void 0;const children=/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsxs(Text$1,{size:1,children:[marker.level==="error"&&/* @__PURE__ */jsx(ErrorOutlineIcon,{}),marker.level==="warning"&&/* @__PURE__ */jsx(WarningOutlineIcon,{}),marker.level==="info"&&/* @__PURE__ */jsx(InfoOutlineIcon,{})]})}),/* @__PURE__ */jsxs(Stack,{space:2,flex:1,paddingLeft:3,children:[path&&/* @__PURE__ */jsx(StyledText$2,{size:1,weight:"semibold",children:path}),marker.item.message&&/* @__PURE__ */jsx(StyledText$2,{muted:true,size:1,textOverflow:truncate?"ellipsis":void 0,children:marker.item.message})]})]});return/* @__PURE__ */jsx(MenuItem,{padding:1,onClick:handleClick,radius:2,tone:menuItemTone,children:/* @__PURE__ */jsx(Box,{padding:2,children})});}function ValidationList(props){const{documentType,kind,validation,onFocus,onClose,truncate}=props;const errors=validation.filter(isValidationErrorMarker);const warnings=validation.filter(isValidationWarningMarker);const info=validation.filter(isValidationInfoMarker);const handleClick=useCallback(function(){let path=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];if(onFocus)onFocus(path);if(onClose)onClose();},[onFocus,onClose]);const resolvePathTitle=path=>{const fields=documentType&&documentType.fields;const field=fields&&fields.find(curr=>curr.name===path[0]);return field&&field.type.title||"";};const hasErrors=errors.length>0;const hasWarnings=warnings.length>0;const hasInfo=info.length>0;if(!hasErrors&&!hasWarnings&&!hasInfo){return null;}return/* @__PURE__ */jsxs(Container$1,{width:0,"data-kind":kind,"data-testid":"validation-list",children:[hasErrors&&errors.map((_error,i)=>/* @__PURE__ */jsx(ListItem$1,{truncate,path:resolvePathTitle(_error.path),marker:_error,onClick:handleClick},i)),hasWarnings&&warnings.map((_warning,i)=>/* @__PURE__ */jsx(ListItem$1,{truncate,path:resolvePathTitle(_warning.path),marker:_warning,onClick:handleClick},i)),hasInfo&&info.map((_info,i)=>/* @__PURE__ */jsx(ListItem$1,{truncate,path:resolvePathTitle(_info.path),marker:_info,onClick:handleClick},i))]});}const BUTTON_PROPS={error:{tone:"critical",icon:ErrorOutlineIcon},warning:{tone:"caution",icon:WarningOutlineIcon},info:{tone:"primary",icon:InfoOutlineIcon}};function ValidationMenu(props){const{boundaryElement,isOpen,setOpen}=props;const{onFocus,onPathOpen,schemaType,validation}=useDocumentPane();const id=useId();const hasValidationMarkers=validation.length>0;const hasErrorMarkers=validation.some(isValidationErrorMarker);const hasWarningMarkers=validation.some(isValidationWarningMarker);const hasInfoMarkers=validation.some(isValidationInfoMarker);const buttonProps=useMemo(()=>{if(hasErrorMarkers)return BUTTON_PROPS.error;if(hasWarningMarkers)return BUTTON_PROPS.warning;if(hasInfoMarkers)return BUTTON_PROPS.info;return void 0;},[hasErrorMarkers,hasInfoMarkers,hasWarningMarkers]);const handleClose=useCallback(()=>setOpen(false),[setOpen]);if(!hasValidationMarkers)return null;return/* @__PURE__ */jsx(MenuButton,{id:id||"",button:/* @__PURE__ */jsx(Button,_objectSpread(_objectSpread({},buttonProps),{},{title:"Show validation issues",mode:"bleed","data-testid":"validation-list-button"})),menu:/* @__PURE__ */jsx(Menu,{open:isOpen,children:/* @__PURE__ */jsx(ValidationList,{documentType:schemaType,validation,onClose:handleClose,onFocus:onPathOpen})}),popover:{portal:true,boundaryElement,constrainSize:true,preventOverflow:true,width:0},placement:"bottom-end"});}function DocumentHeaderTitle(){const{connectionState,schemaType,title,value:documentValue}=useDocumentPane();const subscribed=Boolean(documentValue)&&connectionState==="connected";const{error,value}=useDocumentPreview({enabled:subscribed,schemaType,value:documentValue});if(connectionState!=="connected"){return/* @__PURE__ */jsx(Fragment,{});}if(!documentValue){return/* @__PURE__ */jsxs(Fragment,{children:["New ",(schemaType==null?void 0:schemaType.title)||(schemaType==null?void 0:schemaType.name)]});}if(subscribed){if(error){return/* @__PURE__ */jsxs(Fragment,{children:["Error: ",error.message]});}return/* @__PURE__ */jsx(Fragment,{children:(value==null?void 0:value.title)||/* @__PURE__ */jsx("span",{style:{color:"var(--card-muted-fg-color)"},children:"Untitled"})});}return/* @__PURE__ */jsx(Fragment,{children:title});}const isActionButton=item=>Boolean(item.showAsAction);const isMenuButton=negate$1(isActionButton);const DocumentPanelHeader=memo(forwardRef((_ref316,ref)=>{let{rootElement}=_ref316;const{onMenuAction,onPaneClose,onPaneSplit,historyController,validation,menuItems,menuItemGroups,schemaType,ready,views,unstable_languageFilter}=useDocumentPane();const{revTime:rev}=historyController;const{features}=useDeskTool();const{index,BackLink,hasGroupSiblings}=usePaneRouter();const contextMenuItems=useMemo(()=>menuItems.filter(isMenuButton),[menuItems]);const[isValidationOpen,setValidationOpen]=React.useState(false);const showTabs=views.length>1;const showVersionMenu=features.reviewChanges;const showSplitPaneButton=features.splitViews&&onPaneSplit&&views.length>1;const showSplitPaneCloseButton=showSplitPaneButton&&hasGroupSiblings;const showPaneGroupCloseButton=!showSplitPaneCloseButton&&!features.backButton;return/* @__PURE__ */jsx(PaneHeader,{ref,loading:!ready,title:/* @__PURE__ */jsx(DocumentHeaderTitle,{}),tabs:showTabs&&/* @__PURE__ */jsx(DocumentHeaderTabs,{}),backButton:features.backButton&&index>0&&/* @__PURE__ */jsx(Button,{as:BackLink,"data-as":"a",icon:ArrowLeftIcon,mode:"bleed"}),subActions:showVersionMenu&&/* @__PURE__ */jsx(TimelineMenu,{chunk:rev,mode:"rev"}),actions:/* @__PURE__ */jsxs(Inline,{space:1,children:[unstable_languageFilter.length>0&&/* @__PURE__ */jsx(Fragment,{children:unstable_languageFilter.map((languageFilterComponent,idx)=>{return createElement(languageFilterComponent,{key:"language-filter-".concat(idx),schemaType});})}),validation.length>0&&/* @__PURE__ */jsx(ValidationMenu,{boundaryElement:rootElement,isOpen:isValidationOpen,setOpen:setValidationOpen},"validation-menu"),/* @__PURE__ */jsx(PaneContextMenuButton,{itemGroups:menuItemGroups,items:contextMenuItems,onAction:onMenuAction},"context-menu"),showSplitPaneButton&&/* @__PURE__ */jsx(Button,{icon:SplitVerticalIcon,mode:"bleed",onClick:onPaneSplit,title:"Split pane right"},"split-pane-button"),showSplitPaneCloseButton&&/* @__PURE__ */jsx(Button,{icon:CloseIcon,mode:"bleed",onClick:onPaneClose,title:"Close split pane"},"close-view-button"),showPaneGroupCloseButton&&/* @__PURE__ */jsx(Button,{icon:CloseIcon,mode:"bleed",title:"Close pane group",as:BackLink},"close-view-button")]})});}));DocumentPanelHeader.displayName="DocumentPanelHeader";const Scroller=styled(ScrollContainer)(_ref317=>{let{$disabled}=_ref317;if($disabled){return{height:"100%"};}return css(_templateObject263||(_templateObject263=_taggedTemplateLiteral(["\n    height: 100%;\n    overflow: auto;\n    position: relative;\n    scroll-behavior: smooth;\n    outline: none;\n  "])));});const DocumentPanel=function DocumentPanel2(props){const{footerHeight,isInspectOpen,rootElement}=props;const schema=useSchema();const{activeViewId,displayed,documentId,documentType,editState,value,views,ready,schemaType}=useDocumentPane();const{collapsed:layoutCollapsed}=usePaneLayout();const parentPortal=usePortal();const{features}=useDeskTool();const[headerElement,setHeaderElement]=useState(null);const headerRect=useElementRect(headerElement);const portalRef=useRef(null);const[documentScrollElement,setDocumentScrollElement]=useState(null);const requiredPermission=value._createdAt?"update":"create";const liveEdit=useMemo(()=>{var _a;return Boolean((_a=schema.get(documentType))==null?void 0:_a.liveEdit);},[documentType,schema]);const docId=value._id?value._id:"dummy-id";const docPermissionsInput=useMemo(()=>{return _objectSpread(_objectSpread({},value),{},{_id:liveEdit?getPublishedId(docId):getDraftId(docId)});},[liveEdit,value,docId]);const[permissions,isPermissionsLoading]=useDocumentValuePermissions({document:docPermissionsInput,permission:requiredPermission});const activeView=useMemo(()=>views.find(view=>view.id===activeViewId)||views[0]||{type:"form"},[activeViewId,views]);const portalElement=features.splitPanes?portalRef.current||parentPortal.element:parentPortal.element;const margins=useMemo(()=>{if(layoutCollapsed){return[(headerRect==null?void 0:headerRect.height)||0,0,footerHeight?footerHeight+2:2,0];}return[0,0,2,0];},[layoutCollapsed,footerHeight,headerRect]);const formViewHidden=activeView.type!=="form";const activeViewNode=useMemo(()=>activeView.type==="component"&&activeView.component&&createElement(activeView.component,{document:{draft:(editState==null?void 0:editState.draft)||null,displayed:displayed||value,historical:displayed,published:(editState==null?void 0:editState.published)||null},documentId,options:activeView.options,schemaType}),[activeView,displayed,documentId,editState==null?void 0:editState.draft,editState==null?void 0:editState.published,schemaType,value]);useEffect(()=>{if(!(documentScrollElement==null?void 0:documentScrollElement.scrollTo))return;documentScrollElement.scrollTo(0,0);},[documentId,documentScrollElement]);const inspectDialog=useMemo(()=>{return isInspectOpen?/* @__PURE__ */jsx(InspectDialog,{value:displayed||value}):null;},[isInspectOpen,displayed,value]);return/* @__PURE__ */jsxs(Flex,{direction:"column",flex:2,overflow:layoutCollapsed?void 0:"hidden",children:[/* @__PURE__ */jsx(DocumentPanelHeader,{rootElement,ref:setHeaderElement}),/* @__PURE__ */jsx(PaneContent,{children:/* @__PURE__ */jsx(PortalProvider,{element:portalElement,__unstable_elements:{documentScrollElement},children:/* @__PURE__ */jsxs(BoundaryElementProvider,{element:documentScrollElement,children:[activeView.type==="form"&&!isPermissionsLoading&&ready&&/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(PermissionCheckBanner,{granted:Boolean(permissions==null?void 0:permissions.granted),requiredPermission}),/* @__PURE__ */jsx(ReferenceChangedBanner,{})]}),/* @__PURE__ */jsxs(Scroller,{$disabled:layoutCollapsed||false,"data-testid":"document-panel-scroller",ref:setDocumentScrollElement,children:[/* @__PURE__ */jsx(FormView,{hidden:formViewHidden,margins,granted:Boolean(permissions==null?void 0:permissions.granted)},documentId+(ready?"_ready":"_pending")),activeViewNode]}),inspectDialog,/* @__PURE__ */jsx("div",{"data-testid":"document-panel-portal",ref:portalRef})]})})})]});};function getOpErrorTitle(op){if(op==="delete"){return"An error occurred while attempting to delete this document.\n      This usually means that there are other documents that refers to it.";}if(op==="unpublish"){return"An error occurred while attempting to unpublish this document.\n      This usually means that there are other documents that refers to it.";}return"An error occurred during ".concat(op);}function getOpSuccessTitle(op){if(op==="publish"){return"The document was published";}if(op==="unpublish"){return"The document was unpublished. A draft has been created from the latest published version.";}if(op==="discardChanges"){return"All changes since last publish has now been discarded. The discarded draft can still be recovered from history";}if(op==="delete"){return"This document was deleted. It can still be recovered from history and if you continue editing it will be recreated.";}return"Successfully performed ".concat(op," on document");}const IGNORE_OPS=["patch","commit"];const DocumentOperationResults=memo(function DocumentOperationResults2(){const{push:pushToast}=useToast();const{documentId,documentType}=useDocumentPane();const event=useDocumentOperationEvent(documentId,documentType);useEffect(()=>{if(!event)return;if(event.type==="error"){pushToast({closable:true,duration:3e4,status:"error",title:getOpErrorTitle(event.op),description:/* @__PURE__ */jsxs("details",{children:[/* @__PURE__ */jsx("summary",{children:"Details"}),event.error.message]})});}if(event.type==="success"&&!IGNORE_OPS.includes(event.op)){pushToast({closable:true,status:"success",title:getOpSuccessTitle(event.op)});}},[event,pushToast]);return null;});const POPOVER_FALLBACK_PLACEMENTS=["left","bottom"];const DIALOG_WIDTH_TO_UI_WIDTH={small:0,medium:1,large:2,full:"auto"};function ConfirmDialog(props){const{modal,referenceElement}=props;return/* @__PURE__ */jsx(Popover,{content:/* @__PURE__ */jsx(ConfirmDialogContent,{modal}),fallbackPlacements:POPOVER_FALLBACK_PLACEMENTS,open:true,placement:"top",portal:true,preventOverflow:true,referenceElement});}function ConfirmDialogContent(props){const{modal}=props;const{cancelButtonIcon,cancelButtonText,confirmButtonIcon,confirmButtonText,message,onCancel,onConfirm,tone}=modal;const{isTopLayer}=useLayer();const[element,setElement]=useState(null);const handleClickOutside=useCallback(()=>{if(isTopLayer)onCancel();},[isTopLayer,onCancel]);const handleGlobalKeyDown=useCallback(event=>{if(event.key==="Escape"&&isTopLayer)onCancel();},[isTopLayer,onCancel]);useClickOutside(handleClickOutside,[element]);useGlobalKeyDown(handleGlobalKeyDown);return/* @__PURE__ */jsxs(Flex,{direction:"column",ref:setElement,style:{minWidth:320-16,maxWidth:400},children:[/* @__PURE__ */jsx(Box,{flex:1,overflow:"auto",padding:4,children:message}),/* @__PURE__ */jsx(Box,{paddingX:4,paddingY:3,style:{borderTop:"1px solid var(--card-border-color)"},children:/* @__PURE__ */jsxs(Grid,{columns:2,gap:2,children:[/* @__PURE__ */jsx(Button,{icon:cancelButtonIcon,onClick:onCancel,mode:"ghost",text:cancelButtonText||"Cancel"}),/* @__PURE__ */jsx(Button,{icon:confirmButtonIcon,onClick:onConfirm,text:confirmButtonText||"Confirm",tone})]})})]});}function ModalDialog(props){const{modal}=props;const modalId=useId()||"";const footer=modal.footer&&/* @__PURE__ */jsx(Box,{paddingX:4,paddingY:3,children:modal.footer});return/* @__PURE__ */jsx(LegacyLayerProvider,{zOffset:"fullscreen",children:/* @__PURE__ */jsx(Dialog,{__unstable_hideCloseButton:modal.showCloseButton===false,footer,header:modal.header,id:modalId,onClose:modal.onClose,onClickOutside:modal.onClose,width:modal.width===void 0?1:DIALOG_WIDTH_TO_UI_WIDTH[modal.width],children:/* @__PURE__ */jsx(Box,{padding:4,children:modal.content})})});}function PopoverDialog(props){const{modal,referenceElement}=props;return/* @__PURE__ */jsx(Popover,{content:/* @__PURE__ */jsx(PopoverDialogContent,{modal}),fallbackPlacements:POPOVER_FALLBACK_PLACEMENTS,open:true,placement:"top",portal:true,preventOverflow:true,referenceElement});}function PopoverDialogContent(props){const{modal}=props;const{content,onClose}=modal;const{isTopLayer}=useLayer();const[element,setElement]=useState(null);const handleClickOutside=useCallback(()=>{if(isTopLayer)onClose();},[isTopLayer,onClose]);const handleGlobalKeyDown=useCallback(event=>{if(event.key==="Escape"&&isTopLayer)onClose();},[isTopLayer,onClose]);useClickOutside(handleClickOutside,[element]);useGlobalKeyDown(handleGlobalKeyDown);return/* @__PURE__ */jsx("div",{ref:setElement,children:content});}function ActionStateDialog(props){const{modal,referenceElement=null}=props;const modalId=useId()||"";if(modal.type==="confirm"){return/* @__PURE__ */jsx(ConfirmDialog,{modal,referenceElement});}if(modal.type==="dialog"){return/* @__PURE__ */jsx(ModalDialog,{modal});}if(modal.type==="popover"){return/* @__PURE__ */jsx(PopoverDialog,{modal,referenceElement});}const unknownModal=modal;console.warn("Unsupported modal type ".concat(unknownModal.type));return/* @__PURE__ */jsx(Dialog,{id:modalId,onClose:unknownModal.onClose,onClickOutside:unknownModal.onClose,width:2,children:/* @__PURE__ */jsx(Box,{padding:4,children:unknownModal.content||/* @__PURE__ */jsxs(Fragment,{children:["Unexpected modal type (",/* @__PURE__ */jsx("code",{children:unknownModal.type}),")"]})})});}function ActionMenuButton(props){const{actionStates,disabled}=props;const idPrefix=useId()||"";const buttonRef=useRef(null);const[actionIndex,setActionIndex]=useState(-1);const[referenceElement,setReferenceElement]=useState(null);const handleAction=useCallback(idx=>{setActionIndex(idx);},[]);const popoverProps=useMemo(()=>({placement:"top-end",portal:true,preventOverflow:true}),[]);const currentAction=actionStates[actionIndex];return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(MenuButton,{id:"".concat(idPrefix,"-action-menu"),button:/* @__PURE__ */jsx(Button,{"data-testid":"action-menu-button","aria-label":"Open document actions",disabled,icon:ChevronDownIcon,mode:"ghost",ref:buttonRef}),menu:/* @__PURE__ */jsx(Menu,{padding:1,children:actionStates.map((actionState,idx)=>/* @__PURE__ */jsx(ActionMenuListItem,{actionState,disabled,index:idx,onAction:handleAction},idx))}),popover:popoverProps,ref:setReferenceElement}),currentAction&&currentAction.modal&&/* @__PURE__ */jsx(LegacyLayerProvider,{zOffset:"paneFooter",children:/* @__PURE__ */jsx(ActionStateDialog,{modal:currentAction.modal,referenceElement})})]});}function ActionMenuListItem(props){const{actionState,disabled,index,onAction}=props;const{onHandle}=actionState;const handleClick=useCallback(()=>{onAction(index);if(onHandle)onHandle();},[index,onAction,onHandle]);const tooltipContent=actionState.title&&/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:actionState.title})});return/* @__PURE__ */jsx(MenuItem,{"data-testid":"action-".concat(actionState.label.replace(" ","")),disabled:disabled||Boolean(actionState.disabled),onClick:handleClick,padding:0,tone:actionState.tone,children:/* @__PURE__ */jsx(Tooltip,{content:tooltipContent,disabled:!tooltipContent,fallbackPlacements:["left","bottom"],placement:"top",portal:true,children:/* @__PURE__ */jsxs(Flex,{align:"center",paddingX:3,children:[/* @__PURE__ */jsxs(Flex,{flex:1,paddingY:3,children:[actionState.icon&&/* @__PURE__ */jsx(Box,{marginRight:3,children:/* @__PURE__ */jsxs(Text$1,{children:[isValidElement(actionState.icon)&&actionState.icon,isValidElementType(actionState.icon)&&createElement(actionState.icon)]})}),/* @__PURE__ */jsx(Text$1,{children:actionState.label})]}),actionState.shortcut&&/* @__PURE__ */jsx(Box,{marginLeft:3,children:/* @__PURE__ */jsx(Hotkeys,{keys:String(actionState.shortcut).split("+").map(s=>s.slice(0,1).toUpperCase()+s.slice(1))})})]})})});}function DocumentStatusBarActionsInner(props){const{disabled,showMenu,states}=props;const[firstActionState,...menuActionStates]=states;const[buttonElement,setButtonElement]=useState(null);const tooltipContent=useMemo(()=>{if(!firstActionState||!firstActionState.title&&!firstActionState.shortcut)return null;return/* @__PURE__ */jsxs(Flex,{padding:2,style:{maxWidth:300},align:"center",children:[/* @__PURE__ */jsx(Text$1,{size:1,children:firstActionState.title}),firstActionState.shortcut&&/* @__PURE__ */jsx(Box,{marginLeft:firstActionState.title?2:0,children:/* @__PURE__ */jsx(Hotkeys,{keys:String(firstActionState.shortcut).split("+").map(s=>s.slice(0,1).toUpperCase()+s.slice(1).toLowerCase())})})]});},[firstActionState]);return/* @__PURE__ */jsxs(Flex,{children:[firstActionState&&/* @__PURE__ */jsx(LayerProvider,{zOffset:200,children:/* @__PURE__ */jsx(Tooltip,{disabled:!tooltipContent,content:tooltipContent,portal:true,placement:"top",children:/* @__PURE__ */jsx(Stack,{flex:1,children:/* @__PURE__ */jsx(Button,{"data-testid":"action-".concat(firstActionState.label),disabled:disabled||Boolean(firstActionState.disabled),icon:firstActionState.icon,onClick:firstActionState.onHandle,ref:setButtonElement,text:firstActionState.label,tone:firstActionState.tone||"primary"})})})}),showMenu&&menuActionStates.length>0&&/* @__PURE__ */jsx(Box,{marginLeft:1,children:/* @__PURE__ */jsx(ActionMenuButton,{actionStates:menuActionStates,disabled})}),firstActionState&&firstActionState.modal&&/* @__PURE__ */jsx(ActionStateDialog,{modal:firstActionState.modal,referenceElement:buttonElement})]});}const DocumentStatusBarActions=memo(function DocumentStatusBarActions2(){const{actions,connectionState,editState}=useDocumentPane();if(!actions||!editState){return null;}return/* @__PURE__ */jsx(RenderActionCollectionState,{actions,actionProps:editState,children:_ref318=>{let{states}=_ref318;return/* @__PURE__ */jsx(DocumentStatusBarActionsInner,{disabled:connectionState!=="connected",showMenu:actions.length>1,states});}});});const HistoryStatusBarActions=memo(function HistoryStatusBarActions2(){var _a;const{connectionState,editState,historyController}=useDocumentPane();const revision=((_a=historyController.revTime)==null?void 0:_a.id)||"";const disabled=((editState==null?void 0:editState.draft)||(editState==null?void 0:editState.published)||{})._rev===revision;const actionProps=useMemo(()=>_objectSpread(_objectSpread({},editState||{}),{},{revision}),[editState,revision]);const historyActions=useMemo(()=>[HistoryRestoreAction],[]);return/* @__PURE__ */jsx(RenderActionCollectionState,{actions:historyActions,actionProps,children:_ref319=>{let{states}=_ref319;return/* @__PURE__ */jsx(DocumentStatusBarActionsInner,{disabled:connectionState!=="connected"||Boolean(disabled),showMenu:false,states});}});});const RenderBadgeCollectionState=props=>{const{badges,children,badgeProps}=props,rest=_objectWithoutProperties(props,_excluded75);return/* @__PURE__ */jsx(GetHookCollectionState,_objectSpread(_objectSpread({},rest),{},{hooks:badges,args:badgeProps,children}));};const LiveEditBadge=props=>{const{liveEdit}=props;if(liveEdit){return{label:"Live",color:"danger"};}return null;};const BADGE_TONES={primary:"primary",success:"positive",warning:"caution",danger:"critical"};function DocumentBadgesInner(_ref320){let{states}=_ref320;return/* @__PURE__ */jsx(Inline,{space:1,children:states.map((badge,index)=>/* @__PURE__ */jsx(Tooltip,{content:badge.title&&/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:badge.title})}),disabled:!badge.title,placement:"top",portal:true,children:/* @__PURE__ */jsx(Badge,{fontSize:1,mode:"outline",paddingX:2,paddingY:1,radius:4,tone:badge.color?BADGE_TONES[badge.color]:void 0,style:{whiteSpace:"nowrap"},children:badge.label})},String(index)))});}function DocumentBadges(){const{badges,editState}=useDocumentPane();if(!editState||!badges)return null;return/* @__PURE__ */jsx(RenderBadgeCollectionState,{badges,badgeProps:editState,children:_ref321=>{let{states}=_ref321;return/* @__PURE__ */jsx(DocumentBadgesInner,{states});}});}const Root$6=styled(Flex)(_templateObject264||(_templateObject264=_taggedTemplateLiteral(["\n  cursor: default;\n"])));function PublishStatus(props){const{collapsed,disabled,lastPublished,lastUpdated,liveEdit}=props;const lastPublishedTimeAgo=useTimeAgo(lastPublished||"",{minimal:true,agoSuffix:true});const lastPublishedTime=useTimeAgo(lastPublished||"",{minimal:true});const lastUpdatedTimeAgo=useTimeAgo(lastUpdated||"",{minimal:true,agoSuffix:true});const lastUpdatedTime=useTimeAgo(lastUpdated||"",{minimal:true});return/* @__PURE__ */jsx(Root$6,{align:"center","data-ui":"SessionLayout",sizing:"border",children:/* @__PURE__ */jsx(Tooltip,{portal:true,content:/* @__PURE__ */jsx(Stack,{padding:3,space:3,children:/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:liveEdit?/* @__PURE__ */jsxs(Fragment,{children:["Last updated ",lastUpdated?lastUpdatedTimeAgo:lastPublishedTimeAgo]}):/* @__PURE__ */jsxs(Fragment,{children:["Last published ",lastPublishedTimeAgo]})})}),children:/* @__PURE__ */jsx(Button,{mode:"bleed",tone:liveEdit?"critical":"positive",tabIndex:-1,disabled,children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Box,{marginRight:collapsed?0:3,children:/* @__PURE__ */jsx(Text$1,{size:2,children:liveEdit?/* @__PURE__ */jsx(PlayIcon,{}):/* @__PURE__ */jsx(PublishIcon,{})})}),!collapsed&&/* @__PURE__ */jsx(Text$1,{size:1,weight:"medium",children:liveEdit?/* @__PURE__ */jsx(Fragment,{children:lastUpdated?lastUpdatedTime:lastPublishedTime}):lastPublishedTime})]})})})});}const StyledMotionPath=styled(motion.path)(_templateObject265||(_templateObject265=_taggedTemplateLiteral(["\n  transform-origin: center;\n"])));const Circle=props=>/* @__PURE__ */jsx(motion.circle,_objectSpread({fill:"none",r:"8",cx:"12.5",cy:"12.5",strokeWidth:"1.2"},props));const Arrows=props=>/* @__PURE__ */jsx(StyledMotionPath,_objectSpread({fill:"none",d:"M14 17.5619L11.5 20.5L14.5 23.0619M11 7.43811L13.5 4.50001L10.5 1.93811"},props));const Checkmark=props=>/* @__PURE__ */jsx(motion.path,_objectSpread({d:"M9.5 12.1316L11.7414 14.5L16 10"},props));const Edit=props=>/* @__PURE__ */jsx(motion.path,_objectSpread({d:"M15 7L18 10M6 19L7 15L17 5L20 8L10 18L6 19Z"},props));const rotateAnimation=keyframes(_templateObject266||(_templateObject266=_taggedTemplateLiteral(["\n  0% {\n    transform: rotate(0);\n  }\n  100% {\n    transform: rotate(360deg);\n  }\n"])));const RotateGroup=styled.g(_templateObject267||(_templateObject267=_taggedTemplateLiteral(["\n  transform-origin: center;\n\n  &[data-rotate] {\n    animation: "," 1s ease-in-out infinite;\n  }\n"])),rotateAnimation);const root={syncing:{scale:1,transition:{duration:0}},saved:{scale:[1,0.8,1.2,0.9,1.1,0.95,1.05,0.99,1],transition:{duration:0.5,delay:0.2}},changes:{transition:{duration:0}}};const circle={syncing:{strokeDasharray:"0, 0, 23, 3, 23, 3",strokeDashoffset:10,opacity:1,transition:{duration:0}},saved:{strokeDasharray:"0, 0, 23, 0, 23, 0",strokeDashoffset:10,opacity:1,transition:{duration:0.2}},changes:{strokeDasharray:"0, 60, 23, 0, 23, 0",strokeDashoffset:0,opacity:0,transition:{duration:0.5}}};const arrows={syncing:{opacity:1,transition:{duration:0}},saved:{opacity:0,transition:{duration:0.2}},changes:{opacity:0}};const checkmark={syncing:{pathLength:0,transition:{duration:0}},saved:{pathLength:1,transition:{delay:0.4,duration:0.3}},changes:{pathLength:0,transition:{duration:0.2}}};const edit={syncing:{pathLength:0,transition:{duration:0}},saved:{pathLength:0,transition:{duration:0}},changes:{pathLength:1,transition:{duration:0.4,delay:0.5}}};function AnimatedStatusIcon(props){const{status}=props;if(!status){return null;}return/* @__PURE__ */jsx("svg",{width:"1em",height:"1em",viewBox:"0 0 25 25",fill:"none",stroke:"currentColor",strokeWidth:"1.2","data-sanity-icon":"",children:/* @__PURE__ */jsxs(motion.g,{variants:root,initial:status,animate:status,children:[/* @__PURE__ */jsxs(RotateGroup,{"data-rotate":status==="changes"?void 0:"",children:[/* @__PURE__ */jsx(Arrows,{variants:arrows,initial:status,animate:status}),/* @__PURE__ */jsx(Circle,{variants:circle,initial:status,animate:status})]}),/* @__PURE__ */jsx(Checkmark,{variants:checkmark,initial:status,animate:status}),/* @__PURE__ */jsx(Edit,{variants:edit,initial:status,animate:status})]})});}const ReviewButton=React.forwardRef(function ReviewButton2(props,ref){const{collapsed,status,lastUpdated}=props,rest=_objectWithoutProperties(props,_excluded76);const lastUpdatedTime=useTimeAgo(lastUpdated||"",{minimal:true});const lastUpdatedTimeAgo=useTimeAgo(lastUpdated||"",{minimal:true,agoSuffix:true});const buttonProps=useMemo(()=>{if(status==="syncing"){return{text:"Saving...",tone:void 0};}if(status==="changes"){return{text:lastUpdatedTime,tone:"caution"};}if(status==="saved"){return{text:"Saved!",tone:"positive"};}return{};},[status,lastUpdatedTime]);if(!status){return null;}return/* @__PURE__ */jsx(Tooltip,{portal:true,disabled:status!=="changes",content:/* @__PURE__ */jsxs(Stack,{padding:3,space:3,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:"Review changes"}),/* @__PURE__ */jsxs(Text$1,{size:1,muted:true,children:["Changes saved ",lastUpdatedTimeAgo]})]}),children:/* @__PURE__ */jsx(Button,_objectSpread(_objectSpread({mode:"bleed",justify:"flex-start",tone:buttonProps==null?void 0:buttonProps.tone},rest),{},{"data-testid":"review-changes-button",ref,children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Box,{marginRight:collapsed?0:3,children:/* @__PURE__ */jsx(Text$1,{children:/* @__PURE__ */jsx(AnimatedStatusIcon,{status})})}),!collapsed&&/* @__PURE__ */jsx(Text$1,{size:1,weight:"medium",children:buttonProps==null?void 0:buttonProps.text})]})}))});});const ReviewChangesButton=React.memo(ReviewButton);const SYNCING_TIMEOUT=1e3;const SAVED_TIMEOUT=3e3;const DocumentSparkline=memo(function DocumentSparkline2(){var _a;const{changesOpen,documentId,documentType,editState,onHistoryClose,onHistoryOpen,historyController,value}=useDocumentPane();const syncState=useSyncState(documentId,documentType);const lastUpdated=value==null?void 0:value._updatedAt;const lastPublished=(_a=editState==null?void 0:editState.published)==null?void 0:_a._updatedAt;const showingRevision=historyController.onOlderRevision();const liveEdit=Boolean(editState==null?void 0:editState.liveEdit);const published=Boolean(editState==null?void 0:editState.published);const changed=Boolean(editState==null?void 0:editState.draft);const[rootFlexElement,setRootFlexElement]=useState(null);const rootFlexRect=useElementRect(rootFlexElement);const collapsed=!rootFlexRect||(rootFlexRect==null?void 0:rootFlexRect.width)<300;const[status,setStatus]=useState(null);useEffect(()=>{if(status==="syncing"){const timerId=setTimeout(()=>setStatus("saved"),SYNCING_TIMEOUT);return()=>clearTimeout(timerId);}if(status==="saved"){const timerId=setTimeout(()=>setStatus(null),SAVED_TIMEOUT);return()=>clearTimeout(timerId);}},[status,lastUpdated]);useLayoutEffect(()=>{setStatus(null);},[documentId]);useLayoutEffect(()=>{if(syncState.isSyncing){setStatus("syncing");}},[syncState.isSyncing,lastUpdated]);const reviewButton=useMemo(()=>/* @__PURE__ */jsx(ReviewChangesButton,{lastUpdated,status:status||(changed?"changes":void 0),onClick:changesOpen?onHistoryClose:onHistoryOpen,disabled:showingRevision,selected:changesOpen,collapsed}),[changed,changesOpen,onHistoryClose,onHistoryOpen,lastUpdated,showingRevision,status,collapsed]);const publishStatus=useMemo(()=>(liveEdit||published)&&/* @__PURE__ */jsx(Box,{marginRight:1,children:/* @__PURE__ */jsx(PublishStatus,{disabled:showingRevision,lastPublished,lastUpdated,liveEdit,collapsed})}),[collapsed,lastPublished,lastUpdated,liveEdit,published,showingRevision]);return/* @__PURE__ */jsxs(Flex,{align:"center","data-ui":"DocumentSparkline",ref:setRootFlexElement,children:[publishStatus,/* @__PURE__ */jsxs(Flex,{align:"center",flex:1,children:[reviewButton,!collapsed&&/* @__PURE__ */jsx(Box,{marginLeft:3,children:/* @__PURE__ */jsx(DocumentBadges,{})})]})]});});const DocumentActionsBox=styled(Box)(_templateObject268||(_templateObject268=_taggedTemplateLiteral(["\n  min-width: 10em;\n  max-width: 16em;\n"])));function DocumentStatusBar(props){const{actionsBoxRef}=props;const{badges,historyController}=useDocumentPane();const showingRevision=historyController.onOlderRevision();return useMemo(()=>/* @__PURE__ */jsx(Box,{paddingLeft:2,paddingRight:[2,3],paddingY:2,children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Box,{flex:[1,2],children:badges&&/* @__PURE__ */jsx(DocumentSparkline,{})}),/* @__PURE__ */jsx(DocumentActionsBox,{flex:1,marginLeft:[1,3],ref:actionsBoxRef,children:showingRevision?/* @__PURE__ */jsx(HistoryStatusBarActions,{}):/* @__PURE__ */jsx(DocumentStatusBarActions,{})})]})}),[actionsBoxRef,badges,showingRevision]);}function KeyboardShortcutResponder(props){const{actionsBoxElement,activeIndex,children,id,onActionStart,onKeyDown,rootRef,states}=props,rest=_objectWithoutProperties(props,_excluded77);const activeAction=states[activeIndex];const handleKeyDown=useCallback(event=>{const matchingStates=states.filter(state=>state.shortcut&&isHotkey(state.shortcut,event));const matchingState=matchingStates[0];if(matchingStates.length>1){console.warn("Keyboard shortcut conflict: More than one document action matches the shortcut \"".concat(matchingState.shortcut,"\""));}if(matchingState&&!matchingState.disabled&&matchingState.onHandle){event.preventDefault();matchingState.onHandle();onActionStart(states.indexOf(matchingState));return;}if(onKeyDown){onKeyDown(event);}},[onActionStart,onKeyDown,states]);return/* @__PURE__ */jsxs(Pane,_objectSpread(_objectSpread({id,onKeyDown:handleKeyDown,tabIndex:-1},rest),{},{ref:rootRef,children:[children,activeAction&&activeAction.modal&&/* @__PURE__ */jsx(LegacyLayerProvider,{zOffset:"paneFooter",children:/* @__PURE__ */jsx(ActionStateDialog,{modal:activeAction.modal,referenceElement:actionsBoxElement})})]}));}const DocumentActionShortcuts=React.memo(props=>{const{actionsBoxElement,children}=props,rest=_objectWithoutProperties(props,_excluded78);const{actions,editState}=useDocumentPane();const[activeIndex,setActiveIndex]=useState(-1);const onActionStart=useCallback(idx=>{setActiveIndex(idx);},[]);const actionProps=useMemo(()=>editState&&_objectSpread(_objectSpread({},editState),{},{onComplete:()=>void 0,revision:void 0}),[editState]);if(!actionProps||!actions)return null;return/* @__PURE__ */jsx(RenderActionCollectionState,{actionProps,actions,children:_ref322=>{let{states}=_ref322;return/* @__PURE__ */jsx(KeyboardShortcutResponder,_objectSpread(_objectSpread({},rest),{},{activeIndex,actionsBoxElement,onActionStart,states,children}));}});});DocumentActionShortcuts.displayName="DocumentActionShortcuts";function setAtPath(currentTree,path,value){var _a;if(path.length===0){return _objectSpread(_objectSpread({},currentTree||{}),{},{value});}const[head,...tail]=path;const key=isKeySegment(head)?head._key:String(head);const children=(_a=currentTree==null?void 0:currentTree.children)!=null?_a:{};return{value:currentTree==null?void 0:currentTree.value,children:_objectSpread(_objectSpread({},children),{},{[key]:setAtPath(children[key]||{},tail,value)})};}function getExpandOperations(state,path){var _a;const[fieldName,...rest]=path;const fieldsetMember=state.members.find(member=>member.kind==="fieldSet"&&member.fieldSet.members.some(field=>field.kind==="field"&&field.name===fieldName));const ops=[{type:"expandPath",path}];if(fieldsetMember){ops.push({type:"expandFieldSet",path:fieldsetMember.fieldSet.path});}const fieldMember=state.members.find(member=>member.kind==="field"&&member.name===fieldName);const schemaField=state.schemaType.fields.find(field=>field.name===fieldName);const selectedGroupName=(_a=state.groups.find(group=>group.selected))==null?void 0:_a.name;const inSelectedGroup=selectedGroupName&&(selectedGroupName==="all-fields"||schemaField&&castArray(schemaField.group).includes(selectedGroupName));if(!inSelectedGroup){ops.push({type:"setSelectedGroup",path:state.path,groupName:"all-fields"});}if(fieldMember){ops.push({type:"expandPath",path:fieldMember.field.path});}if(rest.length===0){return ops;}if(fieldMember&&isMemberArrayOfObjects(fieldMember)){return ops.concat([{type:"expandPath",path:fieldMember.field.path},...expandArrayPath(fieldMember.field,rest)]);}return ops;}function expandArrayPath(state,path){const[segment,...rest]=path;if(!isKeySegment(segment)){throw new Error("Expected path segment to be an object with a _key property");}const foundMember=state.members.find(member=>member.key===segment._key);if(!foundMember){return[];}return[{type:"expandPath",path},...getExpandOperations(foundMember.item,rest)];}const getHistoryMenuItem=params=>{const{features,hasValue,changesOpen}=params;if(!features.reviewChanges)return null;return{action:"reviewChanges",title:"Review changes",icon:RestoreIcon,isDisabled:changesOpen||!hasValue};};const getInspectItem=_ref323=>{let{hasValue}=_ref323;return{action:"inspect",title:"Inspect",icon:BinaryDocumentIcon,isDisabled:!hasValue,shortcut:"Ctrl+Alt+I"};};const getProductionPreviewItem=_ref324=>{let{previewUrl}=_ref324;if(!previewUrl)return null;return{action:"production-preview",title:"Open preview",icon:EarthAmericasIcon,shortcut:"Ctrl+Alt+O"};};const getMenuItems=params=>{const items=[getProductionPreviewItem,getHistoryMenuItem,getInspectItem].filter(Boolean).map(fn=>fn(params));return items.filter(i=>i!==null);};const isSanityDocument=value=>isRecord$2(value)&&typeof value._id==="string"&&typeof value._type==="string";function usePreviewUrl(value){const[previewUrl,setPreviewUrl]=useState(void 0);const[error,setError]=useState(null);const{resolveProductionUrl}=useSource().document;const value$=useAsObservable(value);if(error)throw error;useEffect(()=>{value$.pipe(debounceTime(500),switchMap(document=>isSanityDocument(document)?from(resolveProductionUrl({document})):of(void 0)),catchError(e=>{const message=isRecord$2(e)&&typeof e.message==="string"?e.message:"Unknown error";throw new Error("An error was thrown while trying to get your preview url: ".concat(message));})).subscribe({next:setPreviewUrl,error:setError});},[resolveProductionUrl,value$]);return previewUrl;}function getInitialValueTemplateOpts(templates,opts){const payload=opts.panePayload||{};const structureNodeTemplate=opts.templateName;if(opts.urlTemplate&&structureNodeTemplate&&structureNodeTemplate!==opts.urlTemplate){console.warn("Conflicting templates: URL says \"".concat(opts.urlTemplate,"\", structure node says \"").concat(structureNodeTemplate,"\". Using \"").concat(structureNodeTemplate,"\"."));}const template=structureNodeTemplate||opts.urlTemplate;const typeTemplates=templates.filter(t=>t.schemaType===opts.documentType);const templateParams=_objectSpread(_objectSpread({},opts.templateParams),typeof payload==="object"?payload||{}:{});let templateName=template;if(!template&&typeTemplates.length===1){templateName=typeTemplates[0].id;}return{templateName,templateParams};}const emptyObject={};const DocumentPaneProvider=memo(props=>{const{children,index,pane,paneKey}=props;const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const schema=useSchema();const templates=useTemplates();const{actions:documentActions,badges:documentBadges,unstable_languageFilter:languageFilterResolver}=useSource().document;const historyStore=useHistoryStore();const presenceStore=usePresenceStore();const paneRouter=usePaneRouter();const{features}=useDeskTool();const{push:pushToast}=useToast();const{options,menuItemGroups,title=null,views:viewsProp=[]}=pane;const paneOptions=useUnique(options);const documentIdRaw=paneOptions.id;const documentId=getPublishedId(documentIdRaw);const documentType=options.type;const paneParams=useUnique(paneRouter.params);const panePayload=useUnique(paneRouter.payload);const{templateName,templateParams}=useMemo(()=>getInitialValueTemplateOpts(templates,{documentType,templateName:paneOptions.template,templateParams:paneOptions.templateParameters,panePayload,urlTemplate:paneParams==null?void 0:paneParams.template}),[documentType,paneOptions,paneParams,panePayload,templates]);const initialValueRaw=useInitialValue({documentId,documentType,templateName,templateParams});const initialValue=useUnique(initialValueRaw);const{patch}=useDocumentOperation(documentId,documentType);const editState=useEditState(documentId,documentType);const{validation:validationRaw}=useValidationStatus(documentId,documentType);const connectionState=useConnectionState(documentId,documentType);const schemaType=schema.get(documentType);const value=(editState==null?void 0:editState.draft)||(editState==null?void 0:editState.published)||initialValue.value;const actions=useMemo(()=>documentActions({schemaType:documentType,documentId}),[documentActions,documentId,documentType]);const badges=useMemo(()=>documentBadges({schemaType:documentType,documentId}),[documentBadges,documentId,documentType]);const languageFilter=useMemo(()=>languageFilterResolver({schemaType:documentType,documentId}),[documentId,documentType,languageFilterResolver]);const validation=useUnique(validationRaw);const views=useUnique(viewsProp);const params=paneRouter.params||emptyObject;const[focusPath,setFocusPath]=useState(()=>params.path?fromString(params.path):[]);const activeViewId=params.view||views[0]&&views[0].id||null;const timeline=useMemo(()=>historyStore.getTimeline({publishedId:documentId,enableTrace:isDev}),[documentId,historyStore]);const[timelineMode,setTimelineMode]=useState("closed");const{historyController}=useMemoObservable(()=>historyStore.getTimelineController({client,documentId,documentType,timeline}),[client,documentId,documentType,timeline]);historyController.setRange(params.since||null,params.rev||null);const changesOpen=historyController.changesPanelActive();const previewUrl=usePreviewUrl(value);const[presence,setPresence]=useState([]);useEffect(()=>{const subscription=presenceStore.documentPresence(documentId).subscribe(nextPresence=>{setPresence(nextPresence);});return()=>{subscription.unsubscribe();};},[documentId,presenceStore]);const hasValue=Boolean(value);const menuItems=useMemo(()=>getMenuItems({features,hasValue,changesOpen,previewUrl}),[features,hasValue,changesOpen,previewUrl]);const inspectOpen=params.inspect==="on";const compareValue=changesOpen?historyController.sinceAttributes():(editState==null?void 0:editState.published)||null;const ready=connectionState==="connected"&&editState.ready;const viewOlderVersion=historyController.onOlderRevision();const displayed=useMemo(()=>viewOlderVersion?historyController.displayed():value,[historyController,params.rev,params.since,value,viewOlderVersion]);const setTimelineRange=useCallback((newSince,newRev)=>{paneRouter.setParams(_objectSpread(_objectSpread({},paneRouter.params),{},{since:newSince,rev:newRev||void 0}));},[paneRouter]);const handleFocus=useCallback(nextFocusPath=>{setFocusPath(nextFocusPath);presenceStore.setLocation([{type:"document",documentId,path:nextFocusPath,lastActiveAt:new Date().toISOString()}]);},[documentId,presenceStore,setFocusPath]);const handleBlur=useCallback(blurredPath=>{setFocusPath([]);},[setFocusPath]);const patchRef=useRef(()=>{throw new Error("Nope");});patchRef.current=event=>{patch.execute(toMutationPatches(event.patches),initialValue.value);};const handleChange=useCallback(event=>patchRef.current(event),[]);const handleHistoryClose=useCallback(()=>{paneRouter.setParams(_objectSpread(_objectSpread({},params),{},{since:void 0}));},[paneRouter,params]);const handleHistoryOpen=useCallback(()=>{paneRouter.setParams(_objectSpread(_objectSpread({},params),{},{since:"@lastPublished"}));},[paneRouter,params]);const handlePaneClose=useCallback(()=>paneRouter.closeCurrent(),[paneRouter]);const handlePaneSplit=useCallback(()=>paneRouter.duplicateCurrent(),[paneRouter]);const toggleInspect=useCallback(function(){let toggle=arguments.length>0&&arguments[0]!==undefined?arguments[0]:!inspectOpen;if(toggle){paneRouter.setParams(_objectSpread(_objectSpread({},params),{},{inspect:"on"}));}else{paneRouter.setParams(omit(params,"inspect"));}},[inspectOpen,paneRouter,params]);const handleMenuAction=useCallback(item=>{if(item.action==="production-preview"&&previewUrl){window.open(previewUrl);return true;}if(item.action==="inspect"){toggleInspect(true);return true;}if(item.action==="reviewChanges"){handleHistoryOpen();return true;}return false;},[handleHistoryOpen,previewUrl,toggleInspect]);const handleKeyUp=useCallback(event=>{for(const item of menuItems){if(item.shortcut){if(isHotkey(item.shortcut,event)){event.preventDefault();event.stopPropagation();handleMenuAction(item);return;}}}},[handleMenuAction,menuItems]);const handleInspectClose=useCallback(()=>toggleInspect(false),[toggleInspect]);const[openPath,onSetOpenPath]=useState([]);const[fieldGroupState,onSetFieldGroupState]=useState();const[collapsedPaths,onSetCollapsedPath]=useState();const[collapsedFieldSets,onSetCollapsedFieldSets]=useState();const handleOnSetCollapsedPath=useCallback((path,collapsed)=>{onSetCollapsedPath(prevState=>setAtPath(prevState,path,collapsed));},[]);const handleOnSetCollapsedFieldSet=useCallback((path,collapsed)=>{onSetCollapsedFieldSets(prevState=>setAtPath(prevState,path,collapsed));},[]);const handleSetActiveFieldGroup=useCallback((path,groupName)=>onSetFieldGroupState(prevState=>setAtPath(prevState,path,groupName)),[]);const formState=useFormState(schemaType,{value,comparisonValue:compareValue,focusPath,openPath,collapsedPaths,presence,validation,collapsedFieldSets,fieldGroupState});const formStateRef=useRef(formState);formStateRef.current=formState;const handleOpenPath=useCallback(path=>{const ops=getExpandOperations(formStateRef.current,path);ops.forEach(op=>{if(op.type==="expandPath"){onSetCollapsedPath(prevState=>setAtPath(prevState,op.path,false));}if(op.type==="expandFieldSet"){onSetCollapsedFieldSets(prevState=>setAtPath(prevState,op.path,false));}if(op.type==="setSelectedGroup"){onSetFieldGroupState(prevState=>setAtPath(prevState,op.path,op.groupName));}});onSetOpenPath(path);},[formStateRef]);const documentPane={actions,activeViewId,badges,changesOpen,collapsedFieldSets,collapsedPaths,compareValue,connectionState,displayed,documentId,documentIdRaw,documentType,editState,focusPath,menuItems,onBlur:handleBlur,onChange:handleChange,onFocus:handleFocus,onPathOpen:handleOpenPath,onHistoryClose:handleHistoryClose,onHistoryOpen:handleHistoryOpen,onInspectClose:handleInspectClose,onKeyUp:handleKeyUp,onMenuAction:handleMenuAction,onPaneClose:handlePaneClose,onPaneSplit:handlePaneSplit,onSetActiveFieldGroup:handleSetActiveFieldGroup,onSetCollapsedPath:handleOnSetCollapsedPath,onSetCollapsedFieldSet:handleOnSetCollapsedFieldSet,historyController,index,inspectOpen,validation,menuItemGroups:menuItemGroups||[],paneKey,previewUrl,ready,schemaType,setTimelineMode,setTimelineRange,timeline,timelineMode,title,value,views,formState,unstable_languageFilter:languageFilter};useEffect(()=>{if(connectionState==="reconnecting"){pushToast({id:"sanity/desk/reconnecting",status:"warning",title:/* @__PURE__ */jsx(Fragment,{children:"Connection lost. Reconnecting\u2026"})});}},[connectionState,pushToast]);useEffect(()=>{setFocusPath(params.path?fromString(params.path):[]);},[documentId,params.path]);return/* @__PURE__ */jsx(DocumentPaneContext.Provider,{value:documentPane,children});});DocumentPaneProvider.displayName="DocumentPaneProvider";const DOCUMENT_PANEL_MIN_WIDTH=320;const DOCUMENT_PANEL_INITIAL_MIN_WIDTH=600;const CHANGES_PANEL_MIN_WIDTH=320;const DIALOG_PROVIDER_POSITION=["fixed","absolute"];const StyledChangeConnectorRoot=styled(ChangeConnectorRoot)(_templateObject269||(_templateObject269=_taggedTemplateLiteral(["\n  flex: 1;\n  display: flex;\n  min-height: 0;\n  min-width: 0;\n"])));const DocumentPane=memo(function DocumentPane2(props){const{name:parentSourceName}=useSource();return/* @__PURE__ */jsx(SourceProvider,{name:props.pane.source||parentSourceName,children:/* @__PURE__ */jsx(DocumentPaneInner,_objectSpread({},props))});});function DocumentPaneInner(props){var _a;const{pane,paneKey}=props;const{resolveNewDocumentOptions}=useSource().document;const paneRouter=usePaneRouter();const options=usePaneOptions(pane.options,paneRouter.params);const{documentType,isLoaded:isDocumentLoaded}=useDocumentType(options.id,options.type);const templateItems=useMemo(()=>{return resolveNewDocumentOptions({type:"global"});},[resolveNewDocumentOptions]);const[templatePermissions,isTemplatePermissionsLoading]=useTemplatePermissions({templateItems});const isLoaded=isDocumentLoaded&&!isTemplatePermissionsLoading;const providerProps=useMemo(()=>{return isLoaded&&documentType&&options.type!==documentType?mergeDocumentType(props,options,documentType):props;},[props,documentType,isLoaded,options]);const{ReferenceChildLink,handleEditReference,groupIndex,routerPanesState}=paneRouter;const childParams=((_a=routerPanesState[groupIndex+1])==null?void 0:_a[0].params)||{};const routerPanesStateLength=routerPanesState.length;const{parentRefPath}=childParams;const activePath=useMemo(()=>{return parentRefPath?{path:fromString(parentRefPath),state:groupIndex>=routerPanesStateLength-1?"none":groupIndex>=routerPanesStateLength-2?"selected":"pressed"}:{path:[],state:"none"};},[parentRefPath,groupIndex,routerPanesStateLength]);if(options.type==="*"&&!isLoaded){return/* @__PURE__ */jsx(LoadingPane,{flex:2.5,minWidth:320,paneKey,title:"Loading document\u2026"});}if(!documentType){return/* @__PURE__ */jsx(ErrorPane,{flex:2.5,minWidth:320,paneKey,title:/* @__PURE__ */jsx(Fragment,{children:"The document was not found"}),children:/* @__PURE__ */jsx(Stack,{space:4,children:/* @__PURE__ */jsxs(Text$1,{as:"p",children:["The document type is not defined, and a document with the ",/* @__PURE__ */jsx("code",{children:options.id})," ","identifier could not be found."]})})});}return/* @__PURE__ */jsx(DocumentPaneProvider,_objectSpread(_objectSpread({},providerProps),{},{children:/* @__PURE__ */jsx(ReferenceInputOptionsProvider,{EditReferenceLinkComponent:ReferenceChildLink,onEditReference:handleEditReference,initialValueTemplateItems:templatePermissions,activePath,children:/* @__PURE__ */jsx(InnerDocumentPane,{})})}));}function usePaneOptions(options){let params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};const templates=useTemplates();return useMemo(()=>{if(options.type&&options.type!=="*"){return options;}const templateName=options.template||params.template;const template=templateName?templates.find(t=>t.id===templateName):void 0;const documentType=template==null?void 0:template.schemaType;if(!documentType){return options;}return _objectSpread(_objectSpread({},options),{},{type:documentType});},[options,params.template,templates]);}function mergeDocumentType(props,options,documentType){return _objectSpread(_objectSpread({},props),{},{pane:_objectSpread(_objectSpread({},props.pane),{},{options:_objectSpread(_objectSpread({},options),{},{type:documentType})})});}function InnerDocumentPane(){const{changesOpen,documentType,onFocus,onPathOpen,onHistoryOpen,onKeyUp,inspectOpen,paneKey,schemaType,value}=useDocumentPane();const{features}=useDeskTool();const{collapsed:layoutCollapsed}=usePaneLayout();const zOffsets=useZIndex();const[rootElement,setRootElement]=useState(null);const[footerElement,setFooterElement]=useState(null);const[actionsBoxElement,setActionsBoxElement]=useState(null);const footerRect=useElementRect(footerElement);const footerH=footerRect==null?void 0:footerRect.height;const documentPanel=useMemo(()=>/* @__PURE__ */jsx(DocumentPanel,{footerHeight:footerH||null,rootElement,isInspectOpen:inspectOpen}),[footerH,rootElement,inspectOpen]);const footer=useMemo(()=>/* @__PURE__ */jsx(PaneFooter,{ref:setFooterElement,children:/* @__PURE__ */jsx(DocumentStatusBar,{actionsBoxRef:setActionsBoxElement})}),[]);const changesPanel=useMemo(()=>{if(!features.reviewChanges)return null;if(!changesOpen)return null;return/* @__PURE__ */jsx(BoundaryElementProvider,{element:rootElement,children:/* @__PURE__ */jsx(ChangesPanel,{})});},[changesOpen,features.reviewChanges,rootElement]);const onConnectorSetFocus=useCallback(path=>{onPathOpen(path);onFocus(path);},[onPathOpen,onFocus]);const children=useMemo(()=>{if(!schemaType){return/* @__PURE__ */jsx(ErrorPane,{flex:2.5,minWidth:320,paneKey,title:/* @__PURE__ */jsxs(Fragment,{children:["Unknown document type: ",/* @__PURE__ */jsx("code",{children:documentType})]}),tone:"caution",children:/* @__PURE__ */jsxs(Stack,{space:4,children:[documentType&&/* @__PURE__ */jsxs(Text$1,{as:"p",children:["This document has the schema type ",/* @__PURE__ */jsx("code",{children:documentType}),", which is not defined as a type in the local content studio schema."]}),!documentType&&/* @__PURE__ */jsx(Text$1,{as:"p",children:"This document does not exist, and no schema type was specified for it."}),isDev&&value&&/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Text$1,{as:"p",children:"Here is the JSON representation of the document:"}),/* @__PURE__ */jsx(Card,{padding:3,overflow:"auto",radius:2,shadow:1,tone:"inherit",children:/* @__PURE__ */jsx(Code,{language:"json",size:[1,1,2],children:JSON.stringify(value,null,2)})})]})]})});}return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(DialogProvider,{position:DIALOG_PROVIDER_POSITION,zOffset:zOffsets.portal,children:/* @__PURE__ */jsx(Flex,{direction:"column",flex:1,height:layoutCollapsed?void 0:"fill",children:/* @__PURE__ */jsxs(StyledChangeConnectorRoot,{"data-testid":"change-connector-root",isReviewChangesOpen:changesOpen,onOpenReviewChanges:onHistoryOpen,onSetFocus:onConnectorSetFocus,children:[documentPanel,changesPanel]})})}),footer,/* @__PURE__ */jsx(DocumentOperationResults,{})]});},[changesOpen,changesPanel,documentPanel,documentType,footer,onConnectorSetFocus,onHistoryOpen,layoutCollapsed,paneKey,schemaType,value,zOffsets.portal]);const currentMinWidth=changesOpen?DOCUMENT_PANEL_INITIAL_MIN_WIDTH+CHANGES_PANEL_MIN_WIDTH:DOCUMENT_PANEL_INITIAL_MIN_WIDTH;const minWidth=changesOpen?DOCUMENT_PANEL_MIN_WIDTH+CHANGES_PANEL_MIN_WIDTH:DOCUMENT_PANEL_MIN_WIDTH;return/* @__PURE__ */jsx(DocumentActionShortcuts,{actionsBoxElement,currentMinWidth,"data-testid":"document-pane",flex:2.5,id:paneKey,minWidth,onKeyUp,rootRef:setRootElement,children});}function NoDocumentTypesScreen(){return/* @__PURE__ */jsx(Card,{height:"fill",children:/* @__PURE__ */jsx(Flex,{align:"center",height:"fill",justify:"center",padding:4,sizing:"border",children:/* @__PURE__ */jsx(Container$1,{width:0,children:/* @__PURE__ */jsx(Card,{padding:4,radius:2,shadow:1,tone:"caution",children:/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(WarningOutlineIcon,{})})}),/* @__PURE__ */jsxs(Stack,{flex:1,marginLeft:3,space:3,children:[/* @__PURE__ */jsx(Text$1,{as:"h1",size:1,weight:"bold",children:"No document types"}),/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"Please define at least one document type in your schema."}),/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:/* @__PURE__ */jsx("a",{href:"https://beta.sanity.io/docs/platform/studio/config",target:"_blank",rel:"noreferrer",children:"Learn how to add a document type \u2192"})})]})]})})})})});}const StyledPaneLayout=styled(PaneLayout)(_templateObject270||(_templateObject270=_taggedTemplateLiteral(["\n  min-height: 100%;\n  min-width: 320px;\n"])));const isSaveHotkey=isHotkey("mod+s");const DeskTool=memo(function DeskTool2(_ref325){let{onPaneChange}=_ref325;var _a;const{navigate}=useRouter();const{push:pushToast}=useToast();const schema=useSchema();const{layoutCollapsed,setLayoutCollapsed}=useDeskTool();const{paneDataItems,resolvedPanes,routerPanes}=useResolvedPanes();const[portalElement,setPortalElement]=useState(null);const handleRootCollapse=useCallback(()=>setLayoutCollapsed(true),[setLayoutCollapsed]);const handleRootExpand=useCallback(()=>setLayoutCollapsed(false),[setLayoutCollapsed]);useEffect(()=>{if(resolvedPanes.length){onPaneChange(resolvedPanes);}},[onPaneChange,resolvedPanes]);useEffect(()=>{if(!layoutCollapsed)return;const hasSiblings=routerPanes.some(group=>group.length>1);if(!hasSiblings)return;const withoutSiblings=routerPanes.map(group=>[group[0]]);navigate({panes:withoutSiblings},{replace:true});},[navigate,layoutCollapsed,routerPanes]);useEffect(()=>{const handleGlobalKeyDown=event=>{if(isSaveHotkey(event)){event.preventDefault();pushToast({closable:true,id:"auto-save-message",status:"info",title:"Your work is automatically saved!",duration:4e3});}};window.addEventListener("keydown",handleGlobalKeyDown);return()=>window.removeEventListener("keydown",handleGlobalKeyDown);},[pushToast]);const hasDefinedDocumentTypes=(_a=schema._original)==null?void 0:_a.types.some(_isCustomDocumentTypeDefinition);if(!hasDefinedDocumentTypes){return/* @__PURE__ */jsx(NoDocumentTypesScreen,{});}return/* @__PURE__ */jsxs(PortalProvider,{element:portalElement||null,children:[/* @__PURE__ */jsx(StyledPaneLayout,{flex:1,height:layoutCollapsed?void 0:"fill",minWidth:512,onCollapse:handleRootCollapse,onExpand:handleRootExpand,children:paneDataItems.map(_ref326=>{let{active,childItemId,groupIndex,itemId,key:paneKey,pane,index:paneIndex,params:paneParams,path,payload,siblingIndex,selected}=_ref326;return/* @__PURE__ */jsx(Fragment$1,{children:pane===LOADING_PANE?/* @__PURE__ */jsx(LoadingPane,{paneKey,path,selected}):/* @__PURE__ */jsx(DeskToolPane,{active,groupIndex,index:paneIndex,pane,childItemId,itemId,paneKey,params:paneParams,payload,selected,siblingIndex})},"".concat(pane===LOADING_PANE?"loading":pane.type,"-").concat(paneIndex));})}),/* @__PURE__ */jsx("div",{"data-portal":"",ref:setPortalElement})]});});function DocTitle(props){const{document:documentValue}=props;const schema=useSchema();const schemaType=schema.get(documentValue._type);const{error,value}=useDocumentPreview({schemaType,value:documentValue});if(!schemaType){return/* @__PURE__ */jsxs("code",{children:["Unknown schema type: ",documentValue._type]});}if(error){return/* @__PURE__ */jsxs(Fragment,{children:["Error: ",error.message]});}return/* @__PURE__ */jsx(Fragment,{children:(value==null?void 0:value.title)||/* @__PURE__ */jsx("span",{style:{color:"var(--card-muted-fg-color)"},children:"Untitled"})});}function isClientError(e){if(typeof e!=="object")return false;if(!e)return false;return"statusCode"in e&&"response"in e;}const POLL_INTERVAL=5e3;let visiblePoll$;const getVisiblePoll$=()=>{if(!visiblePoll$){visiblePoll$=fromEvent(document,"visibilitychange").pipe(startWith(null),map(()=>document.visibilityState==="visible"),distinctUntilChanged(),switchMap(visible=>visible?timer(0,POLL_INTERVAL):EMPTY$1),shareReplay({refCount:true,bufferSize:1}));}return visiblePoll$;};function getDocumentExistence(documentId,_ref327){let{versionedClient}=_ref327;const draftId=getDraftId(documentId);const publishedId=getPublishedId(documentId);const requestOptions={uri:versionedClient.getDataUrl("doc","".concat(draftId,",").concat(publishedId)),json:true,query:{excludeContent:"true"},tag:"use-referring-documents.document-existence"};return versionedClient.observable.request(requestOptions).pipe(map(_ref328=>{let{omitted}=_ref328;const nonExistant=omitted.filter(doc=>doc.reason==="existence");if(nonExistant.length===2){return void 0;}if(nonExistant.length===0){return publishedId;}return nonExistant.some(doc=>doc.id===draftId)?publishedId:draftId;}));}function fetchCrossDatasetReferences(documentId,context){const{crossProjectTokenStore,versionedClient}=context;return getVisiblePoll$().pipe(switchMap(()=>forkJoin({checkDocumentId:getDocumentExistence(documentId,context),crossProjectTokens:crossProjectTokenStore.fetchAllCrossProjectTokens()})),switchMap(_ref329=>{let{checkDocumentId,crossProjectTokens}=_ref329;if(!checkDocumentId){return of({totalCount:0,references:[]});}const currentDataset=versionedClient.config().dataset;const headers=crossProjectTokens.length>0?{"sanity-project-tokens":crossProjectTokens.map(t=>"".concat(t.projectId,"=").concat(t.token)).join(",")}:{};return versionedClient.observable.request({url:"/data/references/".concat(currentDataset,"/documents/").concat(checkDocumentId,"/to?excludeInternalReferences=true&excludePaths=true"),headers,tag:"use-referring-documents.external"}).pipe(catchError(e=>{if(isClientError(e)&&e.statusCode===404){return of({totalCount:0,references:[]});}throw e;}));}));}const useInternalReferences=createHookFromObservableFactory((documentId,context)=>{const{documentStore}=context;const referencesClause="*[references($documentId)][0...100]{_id,_type}";const totalClause="count(*[references($documentId)])";const fetchQuery="{\"references\":".concat(referencesClause,",\"totalCount\":").concat(totalClause,"}");const listenQuery="*[references($documentId)]";return documentStore.listenQuery({fetch:fetchQuery,listen:listenQuery},{documentId},{tag:"use-referring-documents",transitions:["appear","disappear"],throttleTime:5e3});});const useCrossDatasetReferences=createHookFromObservableFactory((documentId,context,versionedClient)=>{const{crossProjectTokenStore}=context;return getVisiblePoll$().pipe(switchMap(()=>fetchCrossDatasetReferences(documentId,{versionedClient,crossProjectTokenStore})));});function useReferringDocuments(documentId){const versionedClient=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const documentStore=useDocumentStore();const crossProjectTokenStore=useCrossProjectTokenStore();const publishedId=getPublishedId(documentId);const[internalReferences,isInternalReferencesLoading]=useInternalReferences(publishedId,{documentStore});const[crossDatasetReferences,isCrossDatasetReferencesLoading]=useCrossDatasetReferences(publishedId,{crossProjectTokenStore},versionedClient);const projectIds=useMemo(()=>{return Array.from(new Set(crossDatasetReferences==null?void 0:crossDatasetReferences.references.map(crossDatasetReference=>crossDatasetReference.projectId).filter(Boolean))).sort();},[crossDatasetReferences==null?void 0:crossDatasetReferences.references]);return{totalCount:((internalReferences==null?void 0:internalReferences.totalCount)||0)+((crossDatasetReferences==null?void 0:crossDatasetReferences.totalCount)||0),projectIds,internalReferences,crossDatasetReferences,isLoading:isInternalReferencesLoading||isCrossDatasetReferencesLoading};}const TextWithToneStyle=styled(Text$1)(_ref330=>{let{$tone,theme}=_ref330;const tone=theme.sanity.color.muted[$tone];return css(_templateObject271||(_templateObject271=_taggedTemplateLiteral(["\n      &:not([data-muted]) {\n        --card-fg-color: ",";\n      }\n\n      &[data-dimmed] {\n        opacity: 0.3;\n      }\n    "])),tone?tone.enabled.fg:void 0);});const TextWithTone=React.forwardRef(function TextWithTone2(props,ref){const{tone,dimmed,muted}=props,rest=_objectWithoutProperties(props,_excluded79);return/* @__PURE__ */jsx(TextWithToneStyle,_objectSpread({"data-ui":"TextWithTone","data-dimmed":dimmed?"":void 0,"data-muted":muted?"":void 0,$tone:tone,muted,ref},rest));});function TimeAgo$1(_ref331){let{time}=_ref331;const timeAgo=useTimeAgo(time);return/* @__PURE__ */jsxs("span",{title:timeAgo,children:[timeAgo," ago"]});}function PublishedStatus(props){const{document}=props;const updatedAt=document&&"_updatedAt"in document&&document._updatedAt;return/* @__PURE__ */jsx(Tooltip,{portal:true,content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:document?/* @__PURE__ */jsxs(Fragment,{children:["Published ",updatedAt&&/* @__PURE__ */jsx(TimeAgo$1,{time:updatedAt})]}):/* @__PURE__ */jsx(Fragment,{children:"Not published"})})}),children:/* @__PURE__ */jsx(TextWithTone,{tone:"positive",dimmed:!document,muted:!document,size:1,children:/* @__PURE__ */jsx(PublishIcon,{})})});}function DraftStatus(props){const{document}=props;const updatedAt=document&&"_updatedAt"in document&&document._updatedAt;return/* @__PURE__ */jsx(Tooltip,{portal:true,content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:document?/* @__PURE__ */jsxs(Fragment,{children:["Edited ",updatedAt&&/* @__PURE__ */jsx(TimeAgo$1,{time:updatedAt})]}):/* @__PURE__ */jsx(Fragment,{children:"No unpublished edits"})})}),children:/* @__PURE__ */jsx(TextWithTone,{tone:"caution",dimmed:!document,muted:!document,size:1,children:/* @__PURE__ */jsx(EditIcon,{})})});}const isLiveEditEnabled=schemaType=>schemaType.liveEdit===true;const getMissingDocumentFallback=item=>({title:/* @__PURE__ */jsx("em",{children:item.title?String(item.title):"Missing document"}),subtitle:/* @__PURE__ */jsx("em",{children:item.title?"Missing document ID: ".concat(item._id):"Document ID: ".concat(item._id)}),media:WarningOutlineIcon});const getValueWithFallback=_ref332=>{let{value,draft,published}=_ref332;const snapshot=draft||published;if(!snapshot){return getMissingDocumentFallback(value);}return assignWith({},snapshot,value,(objValue,srcValue)=>{return typeof srcValue==="undefined"?objValue:srcValue;});};function getPreviewStateObservable(documentPreviewStore,schemaType,documentId,title){const draft$=isLiveEditEnabled(schemaType)?of({snapshot:null}):documentPreviewStore.observeForPreview({_type:"reference",_ref:getDraftId(documentId)},schemaType);const published$=documentPreviewStore.observeForPreview({_type:"reference",_ref:getPublishedId(documentId)},schemaType);return combineLatest([draft$,published$]).pipe(map(_ref333=>{let[draft,published]=_ref333;return{draft:draft.snapshot?_objectSpread({title},draft.snapshot||{}):null,isLoading:false,published:published.snapshot?_objectSpread({title},published.snapshot||{}):null};}),startWith({draft:null,isLoading:true,published:null}));}class PaneItemPreview extends React.Component{constructor(props){super(props);this.state={};const{value,schemaType}=props;const title=isRecord$2(value.title)&&isValidElement(value.title)||isString$1(value.title)||isNumber(value.title)?value.title:null;let sync=true;this.subscription=getPreviewStateObservable(props.documentPreviewStore,schemaType,value._id,title).subscribe(state=>{if(sync){this.state=state;}else{this.setState(state);}});sync=false;}componentWillUnmount(){if(this.subscription){this.subscription.unsubscribe();}}render(){const{icon,layout,presence,value}=this.props;const{draft,published,isLoading}=this.state;const status=isLoading?null:/* @__PURE__ */jsxs(Inline,{space:4,children:[presence&&presence.length>0&&/* @__PURE__ */jsx(DocumentPreviewPresence,{presence}),/* @__PURE__ */jsx(PublishedStatus,{document:published}),/* @__PURE__ */jsx(DraftStatus,{document:draft})]});return/* @__PURE__ */jsx(SanityDefaultPreview,_objectSpread(_objectSpread({},getValueWithFallback({value,draft,published})),{},{isPlaceholder:isLoading,icon,layout,status}));}}const EMPTY_ARRAY=[];function ReferencePreviewLink(props){const{onClick,type,value}=props;const publishedId=getPublishedId(value==null?void 0:value._id);const documentPresence=useDocumentPresence(publishedId);const documentPreviewStore=useDocumentPreviewStore();const{ReferenceChildLink}=usePaneRouter();const Link=useCallback(linkProps=>/* @__PURE__ */jsx(ReferenceChildLink,_objectSpread({documentId:value==null?void 0:value._id,documentType:type==null?void 0:type.name,parentRefPath:EMPTY_ARRAY},linkProps)),[ReferenceChildLink,type==null?void 0:type.name,value==null?void 0:value._id]);return/* @__PURE__ */jsx(PreviewCard$2,{__unstable_focusRing:true,as:Link,"data-as":"a",onClick,padding:2,radius:2,children:/* @__PURE__ */jsx(PaneItemPreview,{documentPreviewStore,icon:type==null?void 0:type.icon,layout:"default",presence:(documentPresence==null?void 0:documentPresence.length)>0?documentPresence:EMPTY_ARRAY,schemaType:type,value})});}const ChevronWrapper=styled(Box)(_templateObject272||(_templateObject272=_taggedTemplateLiteral(["\n  margin-left: auto;\n"])));const CrossDatasetReferencesDetails=styled.details(_templateObject273||(_templateObject273=_taggedTemplateLiteral(["\n  flex: none;\n\n  &[open] "," {\n    transform: rotate(180deg);\n  }\n"])),ChevronWrapper);const CrossDatasetReferencesSummary=styled.summary(_templateObject274||(_templateObject274=_taggedTemplateLiteral(["\n  list-style: none;\n\n  &::-webkit-details-marker {\n    display: none;\n  }\n"])));const TableContainer=styled(Box).attrs({paddingX:2,paddingBottom:2})(_templateObject275||(_templateObject275=_taggedTemplateLiteral(["\n  overflow: auto;\n  max-height: 150px;\n"])));const Table=styled.table(_templateObject276||(_templateObject276=_taggedTemplateLiteral(["\n  width: 100%;\n  text-align: left;\n  padding: 0 ",";\n  border-collapse: collapse;\n\n  th {\n    padding: ",";\n  }\n\n  thead > tr {\n    position: sticky;\n    top: 0;\n    background: var(--card-bg-color);\n    z-index: 1;\n  }\n\n  td {\n    padding: 0 ",";\n  }\n\n  tr > *:last-child {\n    text-align: right;\n  }\n"])),_ref334=>{let{theme}=_ref334;return rem(theme.sanity.space[2]);},_ref335=>{let{theme}=_ref335;return rem(theme.sanity.space[1]);},_ref336=>{let{theme}=_ref336;return rem(theme.sanity.space[1]);});const ReferencesCard=styled(Card).attrs({radius:2,shadow:1,marginBottom:4,flex:"auto"})(_templateObject277||(_templateObject277=_taggedTemplateLiteral(["\n  overflow: hidden;\n  min-height: 150px;\n"])));const OtherReferenceCount=props=>{const difference=props.totalCount-props.references.length;if(!difference)return null;return/* @__PURE__ */jsxs(Inline,{space:2,children:[/* @__PURE__ */jsxs(Text$1,{size:1,muted:true,children:[difference," other reference",difference===1?"":"s"," not shown"," "]}),/* @__PURE__ */jsx(Tooltip,{portal:true,placement:"top",content:/* @__PURE__ */jsx(Container$1,{width:0,children:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:"We can't show metadata about these references because no token with access to the datasets they are in was found."})})}),children:/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:/* @__PURE__ */jsx(InfoOutlineIcon,{})})})]});};function ConfirmDeleteDialogBody(_ref337){let{crossDatasetReferences,internalReferences,documentTitle,totalCount,action,projectIds,onReferenceLinkClick}=_ref337;const schema=useSchema();const toast=useToast();const renderPreviewItem=useCallback(item=>{const type=schema.get(item._type);if(type){return/* @__PURE__ */jsx(ReferencePreviewLink,{type,value:item,onClick:onReferenceLinkClick});}return/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(SanityDefaultPreview,{icon:UnknownIcon,title:"Preview Unavailable",subtitle:"ID: ".concat(item._id),layout:"default"})});},[schema,onReferenceLinkClick]);if((internalReferences==null?void 0:internalReferences.totalCount)===0&&(crossDatasetReferences==null?void 0:crossDatasetReferences.totalCount)===0){return/* @__PURE__ */jsxs(Text$1,{as:"p",children:["Are you sure you want to delete ",/* @__PURE__ */jsxs("strong",{children:["\u201C",documentTitle,"\u201D"]}),"?"]});}const documentCount=crossDatasetReferences.totalCount===1?"1 document":"".concat(crossDatasetReferences.totalCount.toLocaleString()," documents");const projectCount=projectIds.length===1?"another project":"".concat(projectIds.length," projects");const projectIdList="Project ID".concat(projectIds.length===1?"":"s",": ").concat(projectIds.join(", "));return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Card,{padding:3,radius:2,tone:"caution",marginBottom:4,flex:"none",children:/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Text$1,{"aria-hidden":"true",size:1,children:/* @__PURE__ */jsx(WarningOutlineIcon,{})}),/* @__PURE__ */jsx(Box,{flex:1,marginLeft:3,children:/* @__PURE__ */jsx(Text$1,{size:1,children:totalCount===1?/* @__PURE__ */jsxs(Fragment,{children:["1 document refers to \u201C",documentTitle,"\u201D"]}):/* @__PURE__ */jsxs(Fragment,{children:[totalCount.toLocaleString()," documents refer to \u201C",documentTitle,"\u201D"]})})})]})}),/* @__PURE__ */jsx(Box,{flex:"none",marginBottom:4,children:/* @__PURE__ */jsxs(Text$1,{children:["You may not be able to ",action," \u201C",documentTitle,"\u201D because the following documents refer to it:"]})}),/* @__PURE__ */jsx(ReferencesCard,{children:/* @__PURE__ */jsxs(Flex,{direction:"column",height:"fill",children:[internalReferences.totalCount>0&&/* @__PURE__ */jsxs(Stack,{as:"ul",padding:3,space:3,overflow:"auto","data-testid":"internal-references",children:[internalReferences==null?void 0:internalReferences.references.map(item=>/* @__PURE__ */jsx(Box,{as:"li",children:renderPreviewItem(item)},item._id)),internalReferences.totalCount>internalReferences.references.length&&/* @__PURE__ */jsx(Box,{as:"li",padding:3,children:/* @__PURE__ */jsx(OtherReferenceCount,_objectSpread({},internalReferences))})]}),crossDatasetReferences.totalCount>0&&/* @__PURE__ */jsxs(CrossDatasetReferencesDetails,{"data-testid":"cross-dataset-references",style:{borderTop:internalReferences.totalCount>0?"1px solid var(--card-shadow-outline-color)":void 0},children:[/* @__PURE__ */jsx(CrossDatasetReferencesSummary,{children:/* @__PURE__ */jsxs(Flex,{padding:4,align:"center",children:[/* @__PURE__ */jsx(Box,{marginRight:4,children:/* @__PURE__ */jsx(Text$1,{size:3,children:/* @__PURE__ */jsx(DocumentsIcon,{})})}),/* @__PURE__ */jsxs(Flex,{marginRight:4,direction:"column",children:[/* @__PURE__ */jsx(Box,{marginBottom:2,children:/* @__PURE__ */jsxs(Text$1,{children:[documentCount," in ",projectCount]})}),/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{title:projectIdList,textOverflow:"ellipsis",size:1,muted:true,children:projectIdList})})]}),/* @__PURE__ */jsx(ChevronWrapper,{children:/* @__PURE__ */jsx(Text$1,{muted:true,children:/* @__PURE__ */jsx(ChevronDownIcon,{})})})]})}),/* @__PURE__ */jsxs(TableContainer,{children:[/* @__PURE__ */jsxs(Table,{children:[/* @__PURE__ */jsx("thead",{children:/* @__PURE__ */jsxs("tr",{children:[/* @__PURE__ */jsx("th",{children:/* @__PURE__ */jsx(Label,{muted:true,size:0,children:"Project ID"})}),/* @__PURE__ */jsx("th",{children:/* @__PURE__ */jsx(Label,{muted:true,size:0,children:"Dataset"})}),/* @__PURE__ */jsx("th",{children:/* @__PURE__ */jsx(Label,{muted:true,size:0,children:"Document ID"})})]})}),/* @__PURE__ */jsx("tbody",{children:crossDatasetReferences.references.filter(reference=>{return"projectId"in reference&&"datasetName"in reference&&"documentId"in reference;}).map((_ref338,index)=>{let{projectId,datasetName,documentId}=_ref338;return/* @__PURE__ */jsxs("tr",{children:[/* @__PURE__ */jsx("td",{children:/* @__PURE__ */jsx(Text$1,{size:1,children:projectId})}),/* @__PURE__ */jsx("td",{children:/* @__PURE__ */jsx(Text$1,{size:1,children:datasetName})}),/* @__PURE__ */jsx("td",{children:/* @__PURE__ */jsxs(Flex,{align:"center",gap:2,justify:"flex-end",children:[/* @__PURE__ */jsx(Text$1,{textOverflow:"ellipsis",size:1,children:documentId}),/* @__PURE__ */jsx(CopyToClipboard,{text:documentId,onCopy:()=>{toast.push({title:"Copied document ID to clipboard!",status:"success"});},children:/* @__PURE__ */jsx(Button,{title:"Copy ID to clipboard",mode:"bleed",icon:ClipboardIcon,fontSize:0})})]})})]},"".concat(documentId,"-").concat(index));})})]}),/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(OtherReferenceCount,_objectSpread({},crossDatasetReferences))})]})]})]})}),/* @__PURE__ */jsx(Box,{flex:"none",children:/* @__PURE__ */jsxs(Text$1,{children:["If you ",action," this document, documents that refer to it will no longer be able to access it."]})})]});}const DialogBody=styled(Flex).attrs({padding:4,direction:"column",height:"fill"})(_templateObject278||(_templateObject278=_taggedTemplateLiteral(["\n  box-sizing: border-box;\n"])));const LoadingContainer=styled(Flex).attrs({align:"center",direction:"column",justify:"center"})(_templateObject279||(_templateObject279=_taggedTemplateLiteral(["\n  height: 300px;\n"])));function ConfirmDeleteDialog(_ref339){let{id,type,action="delete",onCancel,onConfirm}=_ref339;const dialogId="deletion-confirmation-".concat(useId());const{internalReferences,crossDatasetReferences,isLoading,totalCount,projectIds}=useReferringDocuments(id);const capitalizedAction="".concat(action.substring(0,1).toUpperCase()).concat(action.substring(1));const documentTitle=/* @__PURE__ */jsx(DocTitle,{document:useMemo(()=>({_id:id,_type:type}),[id,type])});const showConfirmButton=!isLoading;return/* @__PURE__ */jsx(Dialog,{width:1,id:dialogId,header:"".concat(capitalizedAction," document?"),footer:/* @__PURE__ */jsxs(Grid,{columns:showConfirmButton?2:1,gap:2,paddingX:4,paddingY:3,children:[/* @__PURE__ */jsx(Button,{mode:"ghost",onClick:onCancel,text:"Cancel"}),showConfirmButton&&/* @__PURE__ */jsx(Button,{"data-testid":"confirm-delete-button",text:totalCount>0?"".concat(capitalizedAction," anyway"):"".concat(capitalizedAction," now"),tone:"critical",onClick:onConfirm})]}),onClose:onCancel,onClickOutside:onCancel,children:/* @__PURE__ */jsx(DialogBody,{children:crossDatasetReferences&&internalReferences&&!isLoading?/* @__PURE__ */jsx(ConfirmDeleteDialogBody,{crossDatasetReferences,internalReferences,documentTitle,isLoading,totalCount,action,projectIds,onReferenceLinkClick:onCancel}):/* @__PURE__ */jsxs(LoadingContainer,{"data-testid":"loading-container",children:[/* @__PURE__ */jsx(Spinner,{muted:true}),/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(Text$1,{align:"center",muted:true,size:1,children:"Looking for referring documents\u2026"})})]})})});}function ConfirmDeleteDialogContainer(props){const id=useId();const[error,setError]=useState(null);const handleRetry=useCallback(()=>setError(null),[]);return error?/* @__PURE__ */jsx(Dialog,{id:"dialog-error-".concat(id),"data-testid":"confirm-delete-error-dialog",header:"Error",footer:/* @__PURE__ */jsx(Flex,{paddingX:4,paddingY:3,direction:"column",children:/* @__PURE__ */jsx(Button,{mode:"ghost",text:"Retry",onClick:handleRetry})}),onClose:props.onCancel,children:/* @__PURE__ */jsx(Box,{padding:4,children:/* @__PURE__ */jsx(Text$1,{children:"An error occurred while loading referencing documents."})})}):/* @__PURE__ */jsx(ErrorBoundary,{onCatch:setError,children:/* @__PURE__ */jsx(ConfirmDeleteDialog,_objectSpread({},props))});}const DISABLED_REASON_TITLE$4={NOTHING_TO_DELETE:"This document doesn\u2019t yet exist or is already deleted"};const DeleteAction=_ref340=>{let{id,type,draft,onComplete}=_ref340;const{delete:deleteOp}=useDocumentOperation(id,type);const[isDeleting,setIsDeleting]=useState(false);const[isConfirmDialogOpen,setConfirmDialogOpen]=useState(false);const handleCancel=useCallback(()=>{setConfirmDialogOpen(false);onComplete();},[onComplete]);const handleConfirm=useCallback(()=>{setIsDeleting(true);setConfirmDialogOpen(false);deleteOp.execute();onComplete();},[deleteOp,onComplete]);const handle=useCallback(()=>{setConfirmDialogOpen(true);},[]);const[permissions,isPermissionsLoading]=useDocumentPairPermissions({id,type,permission:"delete"});const currentUser=useCurrentUser();if(!isPermissionsLoading&&!(permissions==null?void 0:permissions.granted)){return{tone:"critical",icon:TrashIcon,disabled:true,label:"Delete",title:/* @__PURE__ */jsx(InsufficientPermissionsMessage,{operationLabel:"delete this document",currentUser})};}return{tone:"critical",icon:TrashIcon,disabled:isDeleting||Boolean(deleteOp.disabled)||isPermissionsLoading,title:deleteOp.disabled&&DISABLED_REASON_TITLE$4[deleteOp.disabled]||"",label:isDeleting?"Deleting\u2026":"Delete",shortcut:"Ctrl+Alt+D",onHandle:handle,modal:isConfirmDialogOpen&&{type:"dialog",onClose:onComplete,content:/* @__PURE__ */jsx(ConfirmDeleteDialogContainer,{action:"delete",id:(draft==null?void 0:draft._id)||id,type,onCancel:handleCancel,onConfirm:handleConfirm})}};};DeleteAction.action="delete";const DISABLED_REASON_TITLE$3={NO_CHANGES:"This document has no unpublished changes",NOT_PUBLISHED:"This document is not published"};const DiscardChangesAction=_ref341=>{let{id,type,published,liveEdit,onComplete}=_ref341;const{discardChanges}=useDocumentOperation(id,type);const[isConfirmDialogOpen,setConfirmDialogOpen]=useState(false);const[permissions,isPermissionsLoading]=useDocumentPairPermissions({id,type,permission:"discardDraft"});const currentUser=useCurrentUser();const handleConfirm=useCallback(()=>{discardChanges.execute();onComplete();},[discardChanges,onComplete]);const handle=useCallback(()=>{setConfirmDialogOpen(true);},[]);const modal=useMemo(()=>isConfirmDialogOpen&&{type:"confirm",tone:"critical",onCancel:onComplete,onConfirm:handleConfirm,message:/* @__PURE__ */jsx(Fragment,{children:"Are you sure you want to discard all changes since last published?"})},[handleConfirm,isConfirmDialogOpen,onComplete]);if(!published||liveEdit){return null;}if(!isPermissionsLoading&&!(permissions==null?void 0:permissions.granted)){return{tone:"critical",icon:ResetIcon,disabled:true,label:"Discard changes",title:/* @__PURE__ */jsx(InsufficientPermissionsMessage,{operationLabel:"discard changes in this document",currentUser})};}return{tone:"critical",icon:ResetIcon,disabled:Boolean(discardChanges.disabled)||isPermissionsLoading,title:discardChanges.disabled&&DISABLED_REASON_TITLE$3[discardChanges.disabled]||"",label:"Discard changes",onHandle:handle,modal};};DiscardChangesAction.action="discardChanges";const DISABLED_REASON_TITLE$2={NOTHING_TO_DUPLICATE:"This document doesn\u2019t yet exist so there\u2018s nothing to duplicate"};const DuplicateAction=_ref342=>{let{id,type,onComplete}=_ref342;const{duplicate}=useDocumentOperation(id,type);const router=useRouter();const[isDuplicating,setDuplicating]=useState(false);const[permissions,isPermissionsLoading]=useDocumentPairPermissions({id,type,permission:"duplicate"});const currentUser=useCurrentUser();const handle=useCallback(()=>{const dupeId=uuid();setDuplicating(true);duplicate.execute(dupeId);router.navigateIntent("edit",{id:dupeId,type});onComplete();},[duplicate,onComplete,router,type]);if(!isPermissionsLoading&&!(permissions==null?void 0:permissions.granted)){return{icon:CopyIcon,disabled:true,label:"Duplicate",title:/* @__PURE__ */jsx(InsufficientPermissionsMessage,{operationLabel:"duplicate this document",currentUser})};}return{icon:CopyIcon,disabled:isDuplicating||Boolean(duplicate.disabled)||isPermissionsLoading,label:isDuplicating?"Duplicating\u2026":"Duplicate",title:duplicate.disabled&&DISABLED_REASON_TITLE$2[duplicate.disabled]||"",onHandle:handle};};DuplicateAction.action="duplicate";const HistoryRestoreAction=_ref343=>{let{id,type,revision,onComplete}=_ref343;const{restore}=useDocumentOperation(id,type);const router=useRouter();const[isConfirmDialogOpen,setConfirmDialogOpen]=useState(false);const handleConfirm=useCallback(()=>{restore.execute(revision);router.navigateIntent("edit",{id,type});onComplete();},[revision,restore,router,onComplete,id,type]);const handle=useCallback(()=>{setConfirmDialogOpen(true);},[]);const modal=useMemo(()=>{if(isConfirmDialogOpen){return{type:"confirm",tone:"critical",onCancel:onComplete,onConfirm:handleConfirm,message:/* @__PURE__ */jsx(Fragment,{children:"Are you sure you want to restore this document?"})};}return null;},[handleConfirm,isConfirmDialogOpen,onComplete]);const isRevisionInitialVersion=revision==="@initial";return{label:"Restore",color:"primary",onHandle:handle,title:isRevisionInitialVersion?"You can't restore to the initial version":"Restore to this version",icon:RestoreIcon,modal,disabled:isRevisionInitialVersion};};HistoryRestoreAction.action="restore";const DISABLED_REASON_TITLE$1={LIVE_EDIT_ENABLED:"Cannot publish since liveEdit is enabled for this document type",ALREADY_PUBLISHED:"Already published",NO_CHANGES:"No unpublished changes"};function getDisabledReason(reason,publishedAt){if(reason==="ALREADY_PUBLISHED"&&publishedAt){return/* @__PURE__ */jsx(Fragment,{children:/* @__PURE__ */jsxs("span",{children:["Published ",/* @__PURE__ */jsx(TimeAgo$1,{time:publishedAt})]})});}return DISABLED_REASON_TITLE$1[reason];}const PublishAction=props=>{const{id,type,liveEdit,draft,published}=props;const[publishState,setPublishState]=useState(null);const{publish}=useDocumentOperation(id,type);const validationStatus=useValidationStatus(id,type);const syncState=useSyncState(id,type);const{changesOpen,onHistoryOpen}=useDocumentPane();const hasValidationErrors=validationStatus.validation.some(isValidationErrorMarker);const[publishScheduled,setPublishScheduled]=useState(false);const isNeitherSyncingNorValidating=!syncState.isSyncing&&!validationStatus.isValidating;const[permissions,isPermissionsLoading]=useDocumentPairPermissions({id,type,permission:"publish"});const currentUser=useCurrentUser();const title=publish.disabled?getDisabledReason(publish.disabled,(published||{})._updatedAt)||"":hasValidationErrors?"There are validation errors that need to be fixed before this document can be published":"";const hasDraft=Boolean(draft);const doPublish=useCallback(()=>{publish.execute();setPublishState("publishing");},[publish]);useEffect(()=>{if(publishScheduled&&isNeitherSyncingNorValidating){if(!hasValidationErrors){doPublish();}setPublishScheduled(false);}},[isNeitherSyncingNorValidating,doPublish,hasValidationErrors,publishScheduled]);useEffect(()=>{const didPublish=publishState==="publishing"&&!hasDraft;if(didPublish){if(changesOpen){onHistoryOpen();}}const nextState=didPublish?"published":null;const delay=didPublish?200:4e3;const timer=setTimeout(()=>{setPublishState(nextState);},delay);return()=>clearTimeout(timer);},[changesOpen,publishState,hasDraft,onHistoryOpen]);const handle=useCallback(()=>{if(syncState.isSyncing||validationStatus.isValidating){setPublishScheduled(true);}else{doPublish();}},[syncState.isSyncing,validationStatus.isValidating,doPublish]);if(liveEdit){return{tone:"positive",label:"Publish",title:"Live Edit is enabled for this content type and publishing happens automatically as you make changes",disabled:true};}if(!isPermissionsLoading&&!(permissions==null?void 0:permissions.granted)){return{tone:"positive",label:"Publish",title:/* @__PURE__ */jsx(InsufficientPermissionsMessage,{operationLabel:"publish this document",currentUser}),disabled:true};}const disabled=Boolean(publishScheduled||publishState==="publishing"||publishState==="published"||hasValidationErrors||publish.disabled);return{disabled:disabled||isPermissionsLoading,tone:"positive",label:publishState==="published"?"Published":publishScheduled||publishState==="publishing"?"Publishing\u2026":"Publish",icon:publishState==="published"?CheckmarkIcon:PublishIcon,title:publishScheduled?"Waiting for tasks to finish before publishing":publishState==="published"||publishState==="publishing"?null:title,shortcut:disabled||publishScheduled?null:"Ctrl+Alt+P",onHandle:handle};};PublishAction.action="publish";const DISABLED_REASON_TITLE={NOT_PUBLISHED:"This document is not published"};const UnpublishAction=_ref344=>{let{id,type,draft,onComplete,liveEdit}=_ref344;const{unpublish}=useDocumentOperation(id,type);const[isConfirmDialogOpen,setConfirmDialogOpen]=useState(false);const[permissions,isPermissionsLoading]=useDocumentPairPermissions({id,type,permission:"unpublish"});const currentUser=useCurrentUser();const handleCancel=useCallback(()=>{setConfirmDialogOpen(false);onComplete();},[onComplete]);const handleConfirm=useCallback(()=>{setConfirmDialogOpen(false);unpublish.execute();onComplete();},[onComplete,unpublish]);const modal=useMemo(()=>{if(isConfirmDialogOpen){return{type:"dialog",onClose:onComplete,content:/* @__PURE__ */jsx(ConfirmDeleteDialogContainer,{id:(draft==null?void 0:draft._id)||id,type,action:"unpublish",onCancel:handleCancel,onConfirm:handleConfirm})};}return null;},[draft,id,handleCancel,handleConfirm,isConfirmDialogOpen,onComplete,type]);if(liveEdit){return null;}if(!isPermissionsLoading&&!(permissions==null?void 0:permissions.granted)){return{tone:"critical",icon:UnpublishIcon,label:"Unpublish",title:/* @__PURE__ */jsx(InsufficientPermissionsMessage,{operationLabel:"unpublish this document",currentUser}),disabled:true};}return{tone:"critical",icon:UnpublishIcon,disabled:Boolean(unpublish.disabled)||isPermissionsLoading,label:"Unpublish",title:unpublish.disabled?DISABLED_REASON_TITLE[unpublish.disabled]:"",onHandle:()=>setConfirmDialogOpen(true),modal};};UnpublishAction.action="unpublish";const initialDocumentBadges=[LiveEditBadge];const initialDocumentActions=[PublishAction,DiscardChangesAction,UnpublishAction,DuplicateAction,DeleteAction];const initialLanguageFilter=[];const schemaTypesReducer=(prev,_ref345,context)=>{let{schema}=_ref345;const schemaTypes=schema==null?void 0:schema.types;if(!schemaTypes)return prev;if(typeof schemaTypes==="function")return schemaTypes(prev,context);if(Array.isArray(schemaTypes))return[...prev,...schemaTypes];throw new Error("Expected `schema.types` to an array or a function but found ".concat(typeof schemaTypes," instead."));};const resolveProductionUrlReducer=async(prev,_ref346,context)=>{let{document}=_ref346;const resolveProductionUrl=document==null?void 0:document.productionUrl;if(resolveProductionUrl)return await resolveProductionUrl(prev,context);return prev;};const toolsReducer=(prev,_ref347,context)=>{let{tools}=_ref347;if(!tools)return prev;if(typeof tools==="function")return tools(prev,context);if(Array.isArray(tools))return[...prev,...tools];throw new Error("Expected `tools` to an array or a function but found ".concat(typeof tools," instead."));};const schemaTemplatesReducer=(prev,_ref348,context)=>{let{schema}=_ref348;const schemaTemplates=schema==null?void 0:schema.templates;if(!schemaTemplates)return prev;if(typeof schemaTemplates==="function")return schemaTemplates(prev,context);if(Array.isArray(schemaTemplates))return[...prev,...schemaTemplates];throw new Error("Expected `schema.templates` to an array or a function but found ".concat(typeof schemaTemplates," instead."));};const documentBadgesReducer=(prev,_ref349,context)=>{let{document}=_ref349;const documentBadges=document==null?void 0:document.badges;if(!documentBadges)return prev;if(typeof documentBadges==="function")return documentBadges(prev,context);if(Array.isArray(documentBadges))return[...prev,...documentBadges];throw new Error("Expected `document.actions` to an array or a function but found ".concat(typeof documentBadges," instead."));};const documentActionsReducer=(prev,_ref350,context)=>{let{document}=_ref350;const documentActions=document==null?void 0:document.actions;if(!documentActions)return prev;if(typeof documentActions==="function")return documentActions(prev,context);if(Array.isArray(documentActions))return[...prev,...documentActions];throw new Error("Expected `document.actions` to an array or a function but found ".concat(typeof documentActions," instead."));};const newDocumentOptionsResolver=(prev,_ref351,context)=>{let{document}=_ref351;const resolveNewDocumentOptions=document==null?void 0:document.newDocumentOptions;if(!resolveNewDocumentOptions)return prev;if(typeof resolveNewDocumentOptions!=="function"){throw new Error("Expected `document.resolveNewDocumentOptions` a function but found ".concat(typeof resolveNewDocumentOptions," instead."));}return resolveNewDocumentOptions(prev,context);};const fileAssetSourceResolver=(prev,_ref352,context)=>{let{form}=_ref352;var _a;const assetSources=(_a=form==null?void 0:form.file)==null?void 0:_a.assetSources;if(!assetSources)return prev;if(typeof assetSources==="function")return assetSources(prev,context);if(Array.isArray(assetSources))return[...prev,...assetSources];throw new Error("Expected `file.assetSources` to an array or a function but found ".concat(typeof assetSources," instead."));};const imageAssetSourceResolver=(prev,_ref353,context)=>{let{form}=_ref353;var _a;const assetSources=(_a=form==null?void 0:form.image)==null?void 0:_a.assetSources;if(!assetSources)return prev;if(typeof assetSources==="function")return assetSources(prev,context);if(Array.isArray(assetSources))return[...prev,...assetSources];throw new Error("Expected `image.assetSources` to an array or a function but found ".concat(typeof assetSources," instead."));};const _documentLanguageFilterReducer=(prev,_ref354,context)=>{let{document}=_ref354;const resolveDocumentLanguageFilter=document==null?void 0:document.unstable_languageFilter;if(!resolveDocumentLanguageFilter)return prev;if(typeof resolveDocumentLanguageFilter==="function")return resolveDocumentLanguageFilter(prev,context);if(Array.isArray(resolveDocumentLanguageFilter))return[...prev,...resolveDocumentLanguageFilter];throw new Error("Expected `document.actions` to an array or a function but found ".concat(typeof resolveDocumentLanguageFilter," instead."));};class ConfigPropertyError extends Error{constructor(_ref355){let{propertyName,path,cause}=_ref355;const message=isRecord$2(cause)&&typeof(cause==null?void 0:cause.message)==="string"?": ".concat(cause.message):"";super("An error occurred while resolving `".concat(propertyName,"` from ").concat(path.join(" > ")).concat(message));this.propertyName=propertyName;this.cause=cause;this.path=path;}}const flattenConfig=(_ref356,path)=>{let{plugins=[]}=_ref356,currentConfig=_objectWithoutProperties(_ref356,_excluded80);return[{config:currentConfig,path:[...path,currentConfig.name]},...plugins.flatMap(config=>flattenConfig(config,[...path,currentConfig.name]))];};function resolveConfigProperty(_ref357){let{config:inputConfig,context,initialValue,propertyName}=_ref357,reducers=_objectWithoutProperties(_ref357,_excluded81);const configs=flattenConfig(inputConfig,[]);if("reducer"in reducers){return configs.reduce((acc,_ref358)=>{let{config,path}=_ref358;try{return reducers.reducer(acc,config,context);}catch(e){throw new ConfigPropertyError({propertyName,path,cause:e});}},initialValue);}const reducer=reducers.asyncReducer;return(async()=>{let current=initialValue;for(const{config,path}of configs){try{current=await reducer(current,config,context);}catch(e){throw new ConfigPropertyError({propertyName,path,cause:e});}}return current;})();}class ConfigResolutionError extends Error{constructor(_ref359){let{causes,name,type}=_ref359;const messages=causes.filter(Boolean).map(cause=>isRecord$2(cause)&&typeof(cause==null?void 0:cause.message)==="string"?cause.message:String(cause));super("Could not resolve ".concat(type).concat(name?" `".concat(name,"`"):"",":\n").concat(messages.map(message=>"\t- ".concat(message)).join("\n"),"\n\n"));this.name=name;this.causes=causes;this.type=type;}}class SchemaError extends Error{constructor(schema){super("SchemaError");this.schema=schema;}}function pseudoRandomNumber(seed){const hashCode=seed.split("").reduce((prevHash,currVal)=>(prevHash<<5)-prevHash+currVal.charCodeAt(0)|0,0);return Math.abs(hashCode*16807%2147483647)/2147483647;}const SvgText=styled.text(_templateObject280||(_templateObject280=_taggedTemplateLiteral(["\n  font-family: ",";\n  font-weight: ",";\n  font-size: 16px;\n  transform: translateY(1px);\n"])),_ref360=>{let{theme}=_ref360;return theme.sanity.fonts.heading.family;},_ref361=>{let{theme}=_ref361;return theme.sanity.fonts.heading.weights.bold;});function createDefaultIcon(title,subtitle){const rng1=pseudoRandomNumber("".concat(title," ").concat(subtitle));const huesWithoutGray=COLOR_HUES.filter(hue=>hue!=="gray");const colorHue=huesWithoutGray[Math.floor(rng1*huesWithoutGray.length)];const possibleTints=["300","400","500","600","700"];const rng2=pseudoRandomNumber(rng1.toString());const tint=possibleTints[Math.floor(rng2*possibleTints.length)];const color=hues[colorHue][tint].hex;const letters=title.split(/\s/g).map(word=>word.replace(/\\W/g,"")).filter(Boolean).slice(0,2).map(i=>i.charAt(0).toUpperCase());const darkened=darken(color,0.4);const lightened=lighten(color,0.4);const textColor=!hasBadContrast(color,"readable",darkened)?darkened:!hasBadContrast(color,"readable",lightened)?lightened:readableColor(color);return/* @__PURE__ */jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",children:[/* @__PURE__ */jsx("rect",{width:32,height:32,rx:2,fill:color}),/* @__PURE__ */jsx(SvgText,{x:"50%",y:"50%",textAnchor:"middle",alignmentBaseline:"middle",dominantBaseline:"middle",fill:textColor,children:letters})]});}const READABLE={available:true,reason:"READABLE"};const PERMISSION_DENIED={available:false,reason:"PERMISSION_DENIED"};const NOT_FOUND={available:false,reason:"NOT_FOUND"};function getReferenceInfo(documentPreviewStore,id,referenceType){const{publishedId,draftId}=getIdPair(id);const pairAvailability$=documentPreviewStore.unstable_observeDocumentPairAvailability({_type:"reference",_ref:id});return pairAvailability$.pipe(switchMap(pairAvailability=>{if(!pairAvailability.draft.available&&!pairAvailability.published.available){const availability=pairAvailability.draft.reason==="PERMISSION_DENIED"||pairAvailability.published.reason==="PERMISSION_DENIED"?PERMISSION_DENIED:NOT_FOUND;return of({id,type:void 0,availability,preview:{draft:void 0,published:void 0}});}const draftRef={_type:"reference",_ref:draftId};const publishedRef={_type:"reference",_ref:publishedId};const typeName$=combineLatest([documentPreviewStore.observeDocumentTypeFromId(draftId),documentPreviewStore.observeDocumentTypeFromId(publishedId)]).pipe(map(_ref362=>{let[draftTypeName,publishedTypeName]=_ref362;return draftTypeName||publishedTypeName;}));return typeName$.pipe(switchMap(typeName=>{if(!typeName){return EMPTY$1;}const refSchemaType=referenceType.to.find(memberType=>memberType.name===typeName);if(!refSchemaType){return EMPTY$1;}const previewPaths=[...(getPreviewPaths(refSchemaType==null?void 0:refSchemaType.preview)||[]),["_updatedAt"],["_createdAt"]];const draftPreview$=documentPreviewStore.observePaths(draftRef,previewPaths).pipe(map(result=>result?_objectSpread({_id:draftId},prepareForPreview(result,refSchemaType)):void 0),startWith(void 0));const publishedPreview$=documentPreviewStore.observePaths(publishedRef,previewPaths).pipe(map(result=>result?_objectSpread({_id:publishedId},prepareForPreview(result,refSchemaType)):void 0),startWith(void 0));const value$=combineLatest([draftPreview$,publishedPreview$]).pipe(map(_ref363=>{let[draft,published]=_ref363;return{draft,published};}));return value$.pipe(map(value=>{const availability=pairAvailability.draft.available||pairAvailability.published.available?READABLE:pairAvailability.draft.reason==="PERMISSION_DENIED"||pairAvailability.published.reason==="PERMISSION_DENIED"?PERMISSION_DENIED:NOT_FOUND;return{type:typeName,id:publishedId,availability,preview:{draft:isRecord$2(value.draft)?value.draft:void 0,published:isRecord$2(value.published)?value.published:void 0}};}));}));}));}function getCounterpartIds(collatedHits){return collatedHits.filter(collatedHit=>!collatedHit.draft||!collatedHit.published).map(collatedHit=>collatedHit.draft?collatedHit.id:getDraftId(collatedHit.id));}function getExistingCounterparts(client,ids){return ids.length===0?of([]):client.observable.fetch("*[_id in $ids]._id",{ids},{tag:"get-counterpart-ids"});}function referenceSearch(client,textTerm,type,options){const searchWeighted=createWeightedSearch(type.to,client,options);return searchWeighted(textTerm,{includeDrafts:true}).pipe(map(results=>results.map(result=>result.hit)),map(collate),map(collated=>collated.slice(0,100)),mergeMap(collated=>{return getExistingCounterparts(client,getCounterpartIds(collated)).pipe(map(existingCounterpartIds=>{return collated.map(entry=>{const draftId=getDraftId(entry.id);return{id:entry.id,type:entry.type,draft:entry.draft||existingCounterpartIds.includes(draftId)?{_id:draftId,_type:entry.type}:void 0,published:entry.published||existingCounterpartIds.includes(entry.id)?{_id:entry.id,_type:entry.type}:void 0};});}));}));}function isNonNullable(value){return!(value===null||value===void 0);}const STATUS_TONES={warning:"caution",error:"critical",info:"positive"};const STATUS_ICONS={warning:/* @__PURE__ */jsx(WarningOutlineIcon,{}),error:/* @__PURE__ */jsx(ErrorOutlineIcon,{}),info:/* @__PURE__ */jsx(InfoOutlineIcon,{})};function AlertStrip(props){const{children,status="warning",title}=props,rest=_objectWithoutProperties(props,_excluded82);return/* @__PURE__ */jsx(Card,_objectSpread(_objectSpread({radius:2,tone:STATUS_TONES[status]},rest),{},{"data-ui":"Alert",children:/* @__PURE__ */jsx(Flex,{padding:1,children:children&&/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(Details,{icon:STATUS_ICONS[status],title,children:/* @__PURE__ */jsx(Box,{marginLeft:3,marginTop:3,children})})})})}));}function useOnClickOutside(refs,handler){useEffect(()=>{const listener=event=>{const target=event.target;if(target instanceof HTMLElement){if(refs.some(ref=>{var _a;return(_a=ref.current)==null?void 0:_a.contains(target);})){return;}handler(event);}};document.addEventListener("mousedown",listener);document.addEventListener("touchstart",listener);return()=>{document.removeEventListener("mousedown",listener);document.removeEventListener("touchstart",listener);};},[refs,handler]);}const noop$1=()=>void 0;const INITIAL_LOADING_STATE$1={isLoading:true,result:void 0,error:void 0,retry:noop$1};const EMPTY_STATE$1={isLoading:false,result:void 0,error:void 0,retry:noop$1};function useReferenceInfo$1(id,getReferenceInfo){const msgSubject=useMemo(()=>new Subject(),[]);const msg$=useMemo(()=>msgSubject.asObservable(),[msgSubject]);const retry=useCallback(()=>{msgSubject.next({type:"retry"});},[msgSubject]);const stream$=useMemo(()=>concat(of(null),msg$).pipe(map(()=>id),concatMap(refId=>refId?getReferenceInfo(refId).pipe(map(result=>{return{isLoading:false,result,error:void 0,retry};}),startWith(INITIAL_LOADING_STATE$1),catchError(err=>{console.error(err);return of({isLoading:false,result:void 0,error:err,retry});})):of(EMPTY_STATE$1))),[getReferenceInfo,id,retry,msg$]);const referenceInfo=useObservable(stream$,INITIAL_LOADING_STATE$1);const previousId=usePrevious(id,id);if(id&&previousId!==id){return INITIAL_LOADING_STATE$1;}return referenceInfo;}function useInterval(ms){const[tick,update]=useReducer(n=>n+1,0);useEffect(()=>{const i=setInterval(update,ms);return()=>clearInterval(i);},[ms]);return tick;}function TimeAgo(_ref364){let{time}=_ref364;useInterval(1e3);const timeSince=formatDistanceToNow(new Date(time));return/* @__PURE__ */jsxs("span",{title:timeSince,children:[timeSince," ago"]});}function UnavailableMessage$1(props){const Icon=props.icon;return/* @__PURE__ */jsxs(Flex,{padding:3,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(Icon,{})})}),/* @__PURE__ */jsxs(Box,{flex:1,marginLeft:3,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:props.title}),/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:props.children})})]})]});}function ReferencePreview(props){var _a,_b,_c,_d;const{availability,id,layout,preview,refType,renderPreview,showTypeLabel}=props;const theme=useRootTheme();const documentPresence=useDocumentPresence(id);const notFound=availability.reason==="NOT_FOUND";const insufficientPermissions=availability.reason==="PERMISSION_DENIED";const previewId=((_a=preview.draft)==null?void 0:_a._id)||((_b=preview.published)==null?void 0:_b._id)||id;const previewStub=useMemo(()=>({_id:previewId,_type:refType.name}),[previewId,refType.name]);return/* @__PURE__ */jsxs(Flex,{align:"center",children:[availability.available?/* @__PURE__ */jsx(Box,{flex:1,children:renderPreview({layout,schemaType:refType,value:previewStub})}):/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(Flex,{align:"center",children:/* @__PURE__ */jsx(Box,{flex:1,paddingY:2,children:/* @__PURE__ */jsx(Text$1,{muted:true,children:"Document unavailable"})})})}),/* @__PURE__ */jsx(Box,{paddingLeft:3,children:/* @__PURE__ */jsxs(Inline,{space:3,children:[showTypeLabel&&/* @__PURE__ */jsx(Label,{size:1,muted:true,children:refType.title}),insufficientPermissions||notFound?/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Tooltip,{portal:true,content:notFound?/* @__PURE__ */jsxs(UnavailableMessage$1,{title:"Not found",icon:HelpCircleIcon,children:["The referenced document does not exist",/* @__PURE__ */jsx("br",{}),"(id: ",/* @__PURE__ */jsx("code",{children:id}),")"]}):/* @__PURE__ */jsx(UnavailableMessage$1,{title:"Insufficcient permissions",icon:AccessDeniedIcon,children:"The referenced document could not be accessed due to insufficient permissions"}),children:/* @__PURE__ */jsx(TextWithTone,{tone:"default",children:/* @__PURE__ */jsx(HelpCircleIcon,{})})})}):null,documentPresence&&documentPresence.length>0&&/* @__PURE__ */jsx(DocumentPreviewPresence,{presence:documentPresence}),/* @__PURE__ */jsxs(Inline,{space:4,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:((_c=preview.published)==null?void 0:_c._updatedAt)?/* @__PURE__ */jsxs(Fragment,{children:["Published ",/* @__PURE__ */jsx(TimeAgo,{time:preview.published._updatedAt})]}):/* @__PURE__ */jsx(Fragment,{children:"Not published"})})}),children:/* @__PURE__ */jsx(TextWithTone,{tone:theme.tone==="default"?"positive":"default",size:1,dimmed:!preview.published,muted:!preview.published,children:/* @__PURE__ */jsx(PublishIcon,{})})})}),/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{size:1,children:((_d=preview.draft)==null?void 0:_d._updatedAt)?/* @__PURE__ */jsxs(Fragment,{children:["Edited ",/* @__PURE__ */jsx(TimeAgo,{time:preview.draft._updatedAt})]}):/* @__PURE__ */jsx(Fragment,{children:"No unpublished edits"})})}),children:/* @__PURE__ */jsx(TextWithTone,{tone:theme.tone==="default"?"caution":"default",size:1,dimmed:!preview.draft,muted:!preview.draft,children:/* @__PURE__ */jsx(EditIcon,{})})})})]})]})})]});}function OptionPreview$1(props){const{getReferenceInfo,id:documentId,renderPreview}=props;const{isLoading,result:referenceInfo,error}=useReferenceInfo$1(documentId,getReferenceInfo);if(isLoading){return/* @__PURE__ */jsxs(Stack,{space:2,padding:1,children:[/* @__PURE__ */jsx(TextSkeleton,{style:{maxWidth:320},radius:1,animated:true}),/* @__PURE__ */jsx(TextSkeleton,{style:{maxWidth:200},radius:1,size:1,animated:true})]});}if(error){return/* @__PURE__ */jsx(Stack,{space:2,padding:1,children:/* @__PURE__ */jsx(Alert,{title:"Failed to load referenced document",children:/* @__PURE__ */jsxs(Text$1,{muted:true,size:1,children:["Error: ",error.message]})})});}if(!referenceInfo){return null;}if(referenceInfo.availability.reason==="PERMISSION_DENIED"){return/* @__PURE__ */jsx(Stack,{space:2,padding:1,children:"Insufficient permissions to view this document"});}const refType=props.type.to.find(toType=>toType.name===referenceInfo.type);if(!refType){return/* @__PURE__ */jsxs(Stack,{space:2,padding:1,children:["Search returned a type that's not valid for this reference: \"$",referenceInfo.type,'"']});}return referenceInfo&&refType&&/* @__PURE__ */jsx(ReferencePreview,{availability:referenceInfo.availability,id:referenceInfo.id,layout:"default",preview:referenceInfo.preview,refType,renderPreview,showTypeLabel:props.type.to.length>1});}function PreviewReferenceValue$1(props){var _a,_b,_c,_d,_e,_f;const{referenceInfo,renderPreview,type,value}=props;if(referenceInfo.isLoading||referenceInfo.error){return/* @__PURE__ */jsx(SanityDefaultPreview,{isPlaceholder:true});}const showTypeLabel=type.to.length>1;if(((_a=referenceInfo.result)==null?void 0:_a.availability.reason)==="NOT_FOUND"&&value._strengthenOnPublish){const refType2=type.to.find(toType=>{var _a2;return toType.name===((_a2=value==null?void 0:value._strengthenOnPublish)==null?void 0:_a2.type);});if(!refType2){return/* @__PURE__ */jsx("div",{children:"Invalid reference type"});}if(value._strengthenOnPublish){const stub=((_b=value._strengthenOnPublish)==null?void 0:_b.type)?{_id:value._ref,_type:(_c=value._strengthenOnPublish)==null?void 0:_c.type}:value;return/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Box,{flex:1,children:renderPreview({layout:"default",schemaType:refType2,value:stub})}),/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Inline,{space:4,children:showTypeLabel&&/* @__PURE__ */jsx(Label,{size:1,muted:true,children:refType2.title})})})]});}}const refTypeName=(_d=referenceInfo.result)==null?void 0:_d.type;const refType=type.to.find(toType=>toType.name===refTypeName);if(!refType){return/* @__PURE__ */jsxs(Stack,{space:2,padding:2,children:["The referenced document is of invalid type: (",refTypeName||"unknown",")",/* @__PURE__ */jsx("pre",{children:JSON.stringify(value,null,2)})]});}return/* @__PURE__ */jsx(ReferencePreview,{availability:(_e=referenceInfo.result)==null?void 0:_e.availability,id:value._ref,layout:"default",preview:(_f=referenceInfo.result)==null?void 0:_f.preview,refType,renderPreview,showTypeLabel});}function ConditionalTooltip(props){const{enabled}=props,rest=_objectWithoutProperties(props,_excluded83);return enabled?/* @__PURE__ */jsx(Tooltip,_objectSpread({},rest)):/* @__PURE__ */jsx(Fragment,{children:props.children});}const INLINE_BLOCK_STYLE={display:"inline-flex"};const FULL_WIDTH={width:"100%"};function CreateButton(props){const{createOptions,onCreate,id}=props,rest=_objectWithoutProperties(props,_excluded84);const canCreateAny=createOptions.some(option=>option.permission.granted);if(!canCreateAny){return/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(InsufficientPermissionsMessage,{operationLabel:"create a new reference"})}),children:/* @__PURE__ */jsx("div",{style:INLINE_BLOCK_STYLE,children:/* @__PURE__ */jsx(Button,{text:"Create new",mode:"ghost",disabled:true,icon:AddIcon,style:FULL_WIDTH})})});}return createOptions.length>1?/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,_objectSpread(_objectSpread({},rest),{},{text:"Create new\u2026",mode:"ghost",icon:AddIcon})),id,menu:/* @__PURE__ */jsx(Menu,{ref:props.menuRef,children:createOptions.map(createOption=>/* @__PURE__ */jsx(ConditionalTooltip,{enabled:!createOption.permission.granted,content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(InsufficientPermissionsMessage,{operationLabel:"create this type of document"})}),portal:true,children:/* @__PURE__ */jsx("div",{children:/* @__PURE__ */jsx(MenuItem,{disabled:!createOption.permission.granted,icon:createOption.icon,text:createOption.title,onClick:()=>onCreate(createOption)})})},createOption.id))}),placement:"right",popover:{portal:true,tone:"default",constrainSize:true}}):/* @__PURE__ */jsx(Button,_objectSpread(_objectSpread({},rest),{},{text:"Create new",mode:"ghost",disabled:!createOptions[0].permission.granted,onClick:()=>onCreate(createOptions[0]),icon:AddIcon}));}const StyledPopover$1=styled(Popover)(_templateObject281||(_templateObject281=_taggedTemplateLiteral(["\n  & > div {\n    overflow: auto;\n    -webkit-overflow-scrolling: touch;\n  }\n"])));const StyledText$1=styled(Text$1)(_templateObject282||(_templateObject282=_taggedTemplateLiteral(["\n  word-break: break-word;\n"])));const ReferenceAutocomplete$1=forwardRef(function ReferenceAutocomplete2(props,ref){const hasResults=props.options&&props.options.length>0;const renderPopover=useCallback((_ref365,contentRef)=>{let{content,hidden,inputElement,onMouseEnter,onMouseLeave}=_ref365;var _a;return/* @__PURE__ */jsx(StyledPopover$1,{placement:"bottom-start",arrow:false,constrainSize:true,onMouseEnter,onMouseLeave,content:/* @__PURE__ */jsx("div",{ref:contentRef,children:hasResults?content:/* @__PURE__ */jsx(Box,{padding:4,children:/* @__PURE__ */jsx(Flex,{align:"center",height:"fill",justify:"center",children:/* @__PURE__ */jsxs(StyledText$1,{align:"center",muted:true,children:["No results for ",/* @__PURE__ */jsxs("strong",{children:["\u201C",props.searchString,"\u201D"]}),((_a=props.searchString)==null?void 0:_a.toLowerCase())==="capybara"?/* @__PURE__ */jsx(Fragment,{children:". What a shame. There should be more Capybaras."}):null]})})})}),open:!props.loading&&!hidden,ref:props.portalRef,portal:true,referenceElement:props.referenceElement||inputElement,matchReferenceWidth:true});},[hasResults,props.searchString,props.loading,props.portalRef,props.referenceElement]);return/* @__PURE__ */jsx(Autocomplete,_objectSpread(_objectSpread({},props),{},{ref,renderPopover}));});const NARROW_LAYOUT=css(_templateObject283||(_templateObject283=_taggedTemplateLiteral(["\n  grid-template-columns: minmax(0px, 1fr);\n"])));const WIDE_LAYOUT=css(_templateObject284||(_templateObject284=_taggedTemplateLiteral(["\n  grid-template-columns: 1fr min-content;\n"])));const Root$5=styled(Grid)(props=>props.$narrow?NARROW_LAYOUT:WIDE_LAYOUT);const AutocompleteContainer=forwardRef(function AutocompleteContainer2(props,forwardedRef){const[rootElement,setRootElement]=useState(null);const handleNewRef=useCallback(element=>{setForwardedRef(forwardedRef,element);setRootElement(element);},[forwardedRef]);const inputWrapperRect=useElementRect(rootElement);return/* @__PURE__ */jsx(Root$5,{ref:handleNewRef,gap:1,$narrow:((inputWrapperRect==null?void 0:inputWrapperRect.width)||0)<480,children:props.children});});function setForwardedRef(ref,instance){if(typeof ref==="function"){ref(instance);}else if(ref){ref.current=instance;}}const StyledPreviewCard=styled(PreviewCard$2)(_templateObject285||(_templateObject285=_taggedTemplateLiteral(["\n  /* this is a hack to avoid layout jumps while previews are loading\n  there's probably better ways of solving this */\n  min-height: 36px;\n"])));const INITIAL_SEARCH_STATE$1={hits:[],isLoading:false};const NO_FILTER$1=()=>true;function nonNullable(v){return v!==null;}const REF_PATH$1=["_ref"];function ReferenceInput(props){var _a,_b,_c,_d,_e,_f,_g,_h,_i,_j,_k;const{createOptions,editReferenceLinkComponent:EditReferenceLink,focusPath=EMPTY_ARRAY$4,focused,path,getReferenceInfo,liveEdit,onChange,onEditReference,onSearch,selectedState,schemaType,changed,readOnly,onFocusPath,validation,value,renderPreview,elementProps}=props;const[searchState,setSearchState]=useState(INITIAL_SEARCH_STATE$1);const handleCreateNew=useCallback(option=>{const id=uuid();const patches=[setIfMissing({}),set(schemaType.name,["_type"]),set(id,["_ref"]),set(true,["_weak"]),set({type:option.type,weak:schemaType.weak,template:option.template},["_strengthenOnPublish"])].filter(isNonNullable);onChange(patches);onEditReference({id,type:option.type,template:option.template});onFocusPath([]);},[onChange,onEditReference,onFocusPath,schemaType]);const handleChange=useCallback(id=>{if(!id){onChange(unset());onFocusPath([]);return;}const hit=searchState.hits.find(h=>h.id===id);if(!hit){throw new Error("Selected an item that wasnt part of the result set");}const patches=[setIfMissing({}),set(schemaType.name,["_type"]),set(getPublishedId(id),["_ref"]),hit.published&&!schemaType.weak?unset(["_weak"]):set(true,["_weak"]),hit.published?unset(["_strengthenOnPublish"]):set({type:hit==null?void 0:hit.type,weak:schemaType.weak},["_strengthenOnPublish"])].filter(isNonNullable);onChange(patches);onFocusPath([]);},[searchState.hits,schemaType.name,schemaType.weak,onChange,onFocusPath]);const handleClear=useCallback(()=>{onChange(unset());},[onChange]);const handlePreviewKeyPress=useCallback(event=>{if(event.key!=="Enter"&&event.key!=="Space"){onFocusPath(["_ref"]);}},[onFocusPath]);const handleAutocompleteKeyDown=useCallback(event=>{if(event.keyCode===27){onFocusPath([]);}},[onFocusPath]);const getReferenceInfoMemo=useCallback(id=>getReferenceInfo(id,schemaType),[getReferenceInfo,schemaType]);const loadableReferenceInfo=useReferenceInfo$1(value==null?void 0:value._ref,getReferenceInfoMemo);const refTypeName=((_a=loadableReferenceInfo.result)==null?void 0:_a.type)||((_b=value==null?void 0:value._strengthenOnPublish)==null?void 0:_b.type);const refType=refTypeName?schemaType.to.find(toType=>toType.name===refTypeName):null;const autocompletePopoverReferenceElementRef=useRef(null);const hasFocusAtRef=focusPath.length===1&&focusPath[0]==="_ref";const forwardedRef=elementProps.ref;const weakIs=(value==null?void 0:value._weak)?"weak":"strong";const weakShouldBe=schemaType.weak===true?"weak":"strong";const hasRef=Boolean(value==null?void 0:value._ref);const weakWarningOverride=hasRef&&!loadableReferenceInfo.isLoading&&(value==null?void 0:value._strengthenOnPublish);const handleFixStrengthMismatch=useCallback(()=>{onChange(schemaType.weak===true?set(true,["_weak"]):unset(["_weak"]));},[onChange,schemaType]);const referenceExists=hasRef&&((_e=(_d=(_c=loadableReferenceInfo.result)==null?void 0:_c.preview)==null?void 0:_d.published)==null?void 0:_e._id);const handleRemoveStrengthenOnPublish=useCallback(()=>{onChange([schemaType.weak===true?set(true,["_weak"]):unset(["_weak"]),unset(["_strengthenOnPublish"])]);},[onChange,schemaType]);const{push}=useToast();const errors=useMemo(()=>validation.filter(item=>item.level==="error"),[validation]);const pressed=selectedState==="pressed";const selected=selectedState==="selected";const handleQueryChange=useObservableCallback(inputValue$=>{return inputValue$.pipe(filter(nonNullable),distinctUntilChanged(),switchMap(searchString=>concat(of({isLoading:true}),onSearch(searchString).pipe(map(hits=>({hits,searchString,isLoading:false})),catchError(error=>{push({title:"Reference search failed",description:error.message,status:"error",id:"reference-search-fail-".concat(inputId)});console.error(error);return of({hits:[]});})))),scan((prevState,nextState)=>_objectSpread(_objectSpread({},prevState),nextState),INITIAL_SEARCH_STATE$1),tap(setSearchState));},[]);const handleAutocompleteOpenButtonClick=useCallback(()=>{handleQueryChange("");},[handleQueryChange]);const showWeakRefMismatch=!loadableReferenceInfo.isLoading&&hasRef&&weakIs!==weakShouldBe&&!weakWarningOverride;const inputId=useId();const handleCreateButtonKeyDown=useCallback(e=>{var _a2;if(e.key==="Escape"){(_a2=forwardedRef==null?void 0:forwardedRef.current)==null?void 0:_a2.focus();}},[forwardedRef]);const renderOption=useCallback(option=>{var _a2,_b2;const id=((_a2=option.hit.draft)==null?void 0:_a2._id)||((_b2=option.hit.published)==null?void 0:_b2._id);return/* @__PURE__ */jsx(StyledPreviewCard,{forwardedAs:"button",type:"button",radius:2,tone:"inherit",children:/* @__PURE__ */jsx(Box,{paddingX:3,paddingY:1,children:/* @__PURE__ */jsx(OptionPreview$1,{getReferenceInfo:getReferenceInfoMemo,id,renderPreview,type:schemaType})})});},[schemaType,getReferenceInfoMemo,renderPreview]);const OpenLink=useMemo(()=>forwardRef(function OpenLink2(restProps,_ref){const template=((value==null?void 0:value._strengthenOnPublish)||{}).template;return/* @__PURE__ */jsx(IntentLink,_objectSpread(_objectSpread({},restProps),{},{intent:"edit",params:[{id:value==null?void 0:value._ref,type:refType==null?void 0:refType.name,template:template==null?void 0:template.id},{params:template==null?void 0:template.params}],target:"_blank",rel:"noopener noreferrer",ref:_ref}));}),[refType==null?void 0:refType.name,value==null?void 0:value._ref,value==null?void 0:value._strengthenOnPublish]);const preview=((_f=loadableReferenceInfo.result)==null?void 0:_f.preview.draft)||((_g=loadableReferenceInfo.result)==null?void 0:_g.preview.published);const isWeakRefToNonexistent=((_i=(_h=loadableReferenceInfo==null?void 0:loadableReferenceInfo.result)==null?void 0:_h.availability)==null?void 0:_i.reason)==="NOT_FOUND"&&!(value==null?void 0:value._strengthenOnPublish)&&(value==null?void 0:value._weak);const isEditing=hasFocusAtRef||!(value==null?void 0:value._ref);const clickOutsideBoundaryRef=useRef(null);const autocompletePortalRef=useRef(null);const createButtonMenuPortalRef=useRef(null);useOnClickOutside([clickOutsideBoundaryRef,autocompletePortalRef,createButtonMenuPortalRef],()=>{if(hasFocusAtRef){onFocusPath([]);}});const handleReplaceClick=useCallback(()=>{onFocusPath(["_ref"]);},[onFocusPath]);return/* @__PURE__ */jsx(Stack,{space:1,children:isEditing||isWeakRefToNonexistent?/* @__PURE__ */jsxs(Stack,{space:2,ref:clickOutsideBoundaryRef,children:[isWeakRefToNonexistent?/* @__PURE__ */jsx(Alert,{"data-testid":"alert-nonexistent-document",title:"Nonexistent document reference",suffix:/* @__PURE__ */jsx(Stack,{padding:2,children:/* @__PURE__ */jsx(Button,{text:"Clear",onClick:handleClear})}),children:/* @__PURE__ */jsxs(Text$1,{size:1,children:["This field is currently referencing a document that doesn't exist (ID:",/* @__PURE__ */jsx("code",{children:value._ref}),"). You can either remove the reference or replace it with another document."]})}):null,/* @__PURE__ */jsx(ChangeIndicator,{path:REF_PATH$1,hasFocus:!!focused,isChanged:changed,children:/* @__PURE__ */jsxs(AutocompleteContainer,{ref:autocompletePopoverReferenceElementRef,children:[/* @__PURE__ */jsx(ReferenceAutocomplete$1,_objectSpread(_objectSpread({},elementProps),{},{"data-testid":"autocomplete",loading:searchState.isLoading,referenceElement:autocompletePopoverReferenceElementRef.current,portalRef:autocompletePortalRef,options:searchState.hits.map(hit=>({value:hit.id,hit})),radius:1,placeholder:"Type to search",onKeyDown:handleAutocompleteKeyDown,readOnly,disabled:loadableReferenceInfo.isLoading,onQueryChange:handleQueryChange,searchString:searchState.searchString,onChange:handleChange,filterOption:NO_FILTER$1,renderOption,openButton:{onClick:handleAutocompleteOpenButtonClick}})),!readOnly&&createOptions.length>0&&/* @__PURE__ */jsx(CreateButton,{id:"".concat(inputId,"-selectTypeMenuButton"),createOptions,onCreate:handleCreateNew,onKeyDown:handleCreateButtonKeyDown,menuRef:createButtonMenuPortalRef})]})})]}):/* @__PURE__ */jsx(ChangeIndicator,{path,hasFocus:!!focused,isChanged:changed,children:/* @__PURE__ */jsxs(Card,{border:true,radius:1,tone:readOnly?"transparent":loadableReferenceInfo.error||errors.length>0?"critical":"inherit",children:[/* @__PURE__ */jsxs(Flex,{align:"center",padding:1,children:[/* @__PURE__ */jsx(StyledPreviewCard,_objectSpread(_objectSpread({},elementProps),{},{__unstable_focusRing:true,forwardedAs:EditReferenceLink,"data-as":"a","data-pressed":pressed?true:void 0,"data-selected":selected?true:void 0,documentId:value==null?void 0:value._ref,documentType:refType==null?void 0:refType.name,flex:1,onKeyPress:handlePreviewKeyPress,padding:1,paddingRight:3,pressed,radius:2,selected,tabIndex:0,tone:selected?"default":"inherit",children:/* @__PURE__ */jsx(PreviewReferenceValue$1,{referenceInfo:loadableReferenceInfo,renderPreview,type:schemaType,value})})),/* @__PURE__ */jsx(Inline,{paddingX:1,children:/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{padding:2,mode:"bleed",icon:EllipsisVerticalIcon}),id:"".concat(inputId,"-menuButton"),menu:/* @__PURE__ */jsxs(Menu,{children:[!readOnly&&/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(MenuItem,{text:"Clear",tone:"critical",icon:ResetIcon,onClick:handleClear}),/* @__PURE__ */jsx(MenuItem,{text:"Replace",icon:SyncIcon,onClick:handleReplaceClick}),/* @__PURE__ */jsx(MenuDivider,{})]}),/* @__PURE__ */jsx(MenuItem,{as:OpenLink,"data-as":"a",text:"Open in new tab",icon:LaunchIcon})]}),placement:"right",popover:{portal:true,tone:"default"}})})]}),liveEdit&&referenceExists&&value._strengthenOnPublish&&/* @__PURE__ */jsx(AlertStrip,{padding:1,title:schemaType.weak?"Finalize reference":"Convert to strong reference",status:"info","data-testid":"alert-reference-published",children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:[/* @__PURE__ */jsx("strong",{children:(_k=(_j=loadableReferenceInfo.result)==null?void 0:_j.preview.published)==null?void 0:_k.title})," is published and this reference should now be"," ",schemaType.weak?/* @__PURE__ */jsx(Fragment,{children:"finalized"}):/* @__PURE__ */jsx(Fragment,{children:"converted to a strong reference"}),"."]}),/* @__PURE__ */jsx(Button,{onClick:handleRemoveStrengthenOnPublish,text:/* @__PURE__ */jsx(Fragment,{children:"Convert to strong reference"}),tone:"positive"})]})}),showWeakRefMismatch&&/* @__PURE__ */jsx(AlertStrip,{padding:1,title:"Reference strength mismatch",status:"warning","data-testid":"alert-reference-strength-mismatch",children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["This reference is ",/* @__PURE__ */jsx("em",{children:weakIs}),", but according to the current schema it should be ",/* @__PURE__ */jsxs("em",{children:[weakShouldBe,"."]})]}),/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:schemaType.weak?/* @__PURE__ */jsxs(Fragment,{children:['It will not be possible to delete the "',preview==null?void 0:preview.title,'"-document without first removing this reference.']}):/* @__PURE__ */jsxs(Fragment,{children:['This makes it possible to delete the "',preview==null?void 0:preview.title,'"-document without first deleting this reference, leaving this field referencing a nonexisting document.']})}),/* @__PURE__ */jsx(Button,{onClick:handleFixStrengthMismatch,text:/* @__PURE__ */jsxs(Fragment,{children:["Convert to ",weakShouldBe," reference"]}),tone:"caution"})]})}),loadableReferenceInfo.error&&/* @__PURE__ */jsx(AlertStrip,{padding:1,title:"Unable to load reference metadata",status:"warning","data-testid":"alert-reference-info-failed",children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["Error: ",loadableReferenceInfo.error.message]}),/* @__PURE__ */jsx(Button,{onClick:loadableReferenceInfo.retry,text:/* @__PURE__ */jsx(Fragment,{children:"Retry"}),tone:"primary"})]})})]})})});}async function resolveUserDefinedFilter$1(options,document,valuePath){if(!options){return{};}if(typeof options.filter==="function"){const parentPath=valuePath.slice(0,-1);const parent=get$3(document,parentPath);return options.filter({document,parentPath,parent});}return{filter:options.filter,params:"filterParams"in options?options.filterParams:void 0};}function useValueRef$1(value){const ref=useRef(value);ref.current=value;return ref;}function StudioReferenceInput(props){var _a,_b,_c,_d;const searchClient=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const schema=useSchema();const documentPreviewStore=useDocumentPreviewStore();const{path,schemaType}=props;const{EditReferenceLinkComponent,onEditReference,activePath,initialValueTemplateItems}=useReferenceInputOptions();const documentValue=useFormValue([]);const documentRef=useValueRef$1(documentValue);const documentTypeName=(_a=documentRef.current)==null?void 0:_a._type;const refType=schema.get(documentTypeName);const isDocumentLiveEdit=useMemo(()=>refType==null?void 0:refType.liveEdit,[refType]);const disableNew=((_b=schemaType.options)==null?void 0:_b.disableNew)===true;const handleSearch=useCallback(searchString=>from(resolveUserDefinedFilter$1(schemaType.options,documentRef.current,path)).pipe(mergeMap(_ref366=>{let{filter,params}=_ref366;return referenceSearch(searchClient,searchString,schemaType,_objectSpread(_objectSpread({},schemaType.options),{},{filter,params,tag:"search.reference"}));}),catchError(err=>{var _a2;const isQueryError=err.details&&err.details.type==="queryParseError";if(((_a2=schemaType.options)==null?void 0:_a2.filter)&&isQueryError){err.message="Invalid reference filter, please check the custom \"filter\" option";}return throwError(err);})),[documentRef,path,searchClient,schemaType]);const template=(_d=(_c=props.value)==null?void 0:_c._strengthenOnPublish)==null?void 0:_d.template;const EditReferenceLink=useMemo(()=>forwardRef(function EditReferenceLink_(_props,forwardedRef){return EditReferenceLinkComponent?/* @__PURE__ */jsx(EditReferenceLinkComponent,_objectSpread(_objectSpread({},_props),{},{ref:forwardedRef,parentRefPath:path,template})):null;}),[EditReferenceLinkComponent,path,template]);const handleEditReference=useCallback(event=>{onEditReference==null?void 0:onEditReference({parentRefPath:path,id:event.id,type:event.type,template:event.template});},[onEditReference,path]);const selectedState=PathUtils.startsWith(path,(activePath==null?void 0:activePath.path)||[])?activePath==null?void 0:activePath.state:"none";const createOptions=useMemo(()=>{if(disableNew){return[];}return(initialValueTemplateItems||[]).filter(i=>{return schemaType.to.some(_refType=>{var _a2;return _refType.name===((_a2=i.template)==null?void 0:_a2.schemaType);});}).map(item=>{var _a2,_b2,_c2;return((_a2=item.template)==null?void 0:_a2.schemaType)?{id:item.id,title:item.title||"".concat(item.template.schemaType," from template ").concat((_b2=item.template)==null?void 0:_b2.id),type:item.template.schemaType,icon:item.icon,template:{id:(_c2=item.template)==null?void 0:_c2.id,params:item.parameters},permission:{granted:item.granted,reason:item.reason}}:void 0;}).filter(isNonNullable$4);},[disableNew,initialValueTemplateItems,schemaType.to]);const getReferenceInfo$1=useCallback((id,_type)=>getReferenceInfo(documentPreviewStore,id,_type),[documentPreviewStore]);return/* @__PURE__ */jsx(ReferenceInput,_objectSpread(_objectSpread({},props),{},{onSearch:handleSearch,liveEdit:isDocumentLiveEdit,getReferenceInfo:getReferenceInfo$1,selectedState,editReferenceLinkComponent:EditReferenceLink,createOptions,onEditReference:handleEditReference}));}const warnInputTypeNotSupported=once(()=>console.warn('The option "inputType" on references is removed.'));const warnSearchableOptionNotSupported=once(()=>console.warn('The option "searchable" on references has been removed.'));function resolveReferenceInput(type){const options=type.options||{};if("inputType"in options){warnInputTypeNotSupported();}if("searchable"in options){warnSearchableOptionNotSupported();}return StudioReferenceInput;}const MOVING_ITEM_CLASS_NAME="moving";const DRAG_HANDLE_ATTRIBUTE="data-drag-handle";function sortableHandle(Component){return SortableHandle(Component);}function sortableItem(Component){return SortableElement(Component);}function sortableContainer(Component,options){const Container=SortableContainer(React.forwardRef(function Sortable(props,forwardedRef){return/* @__PURE__ */jsx(Component,_objectSpread(_objectSpread({},props),{},{ref:forwardedRef}));}));return React.forwardRef(function SortableList(props,ref){return/* @__PURE__ */jsx(Container,_objectSpread(_objectSpread(_objectSpread({},props),options),{},{ref}));});}const KeyCode={Space:32,Enter:13,Esc:27,Up:38,Left:37,Right:39,Down:40};const KEYCODES={lift:[KeyCode.Space,KeyCode.Enter],drop:[KeyCode.Space,KeyCode.Enter],cancel:[KeyCode.Esc],up:[KeyCode.Left,KeyCode.Up],down:[KeyCode.Right,KeyCode.Down]};function sortableGrid(Component){return sortableContainer(Component,{helperClass:MOVING_ITEM_CLASS_NAME,keyCodes:KEYCODES,axis:"xy",lockAxis:"xy",useDragHandle:true,shouldCancelStart});}function sortableList(Component){return sortableContainer(Component,{helperClass:MOVING_ITEM_CLASS_NAME,keyCodes:KEYCODES,axis:"y",lockAxis:"y",useDragHandle:true,shouldCancelStart});}function shouldCancelStart(event){return!isDragHandle(event.target);}function isDragHandle(element){return element.matches("[".concat(DRAG_HANDLE_ATTRIBUTE,"=\"true\"],[").concat(DRAG_HANDLE_ATTRIBUTE,"=\"true\"] *"));}const ListItem=styled(Card)(_templateObject286||(_templateObject286=_taggedTemplateLiteral(["\n  &."," {\n    z-index: 10000;\n    border-radius: ","px;\n    box-shadow: 0 0 0 0, 0 8px 17px 2px var(--card-shadow-umbra-color),\n      0 3px 14px 2px var(--card-shadow-penumbra-color),\n      0 5px 5px -3px var(--card-shadow-ambient-color);\n\n    // Used inside CellItem\n    [data-ui='DragHandleCard'] {\n      opacity: 1;\n    }\n\n    [data-ui='DragHandleButton'] {\n      background-color: ",";\n      color: ",";\n      [data-ui='Text'] {\n        color: inherit;\n      }\n    }\n  }\n"])),MOVING_ITEM_CLASS_NAME,_ref367=>{let{theme}=_ref367;return theme.sanity.radius[2];},_ref368=>{let{theme}=_ref368;return theme.sanity.color.button.bleed.primary.pressed.bg;},_ref369=>{let{theme}=_ref369;return theme.sanity.color.button.bleed.primary.pressed.fg;});const GridItem=ListItem;const SortableList=sortableList(Grid);const SortableListItem=sortableItem(ListItem);const SortableGrid=sortableGrid(Grid);const SortableGridItem=SortableListItem;function List(props){const{isSortable,isGrid,onSortEnd}=props,rest=_objectWithoutProperties(props,_excluded85);if(isGrid){return isSortable?/* @__PURE__ */jsx(SortableGrid,_objectSpread({columns:[2,3,4],gap:3,onSortEnd},rest)):/* @__PURE__ */jsx(Grid,_objectSpread({columns:[2,3,4],gap:3},rest));}return isSortable?/* @__PURE__ */jsx(SortableList,_objectSpread({gap:1,onSortEnd},rest)):/* @__PURE__ */jsx(Grid,_objectSpread({gap:1},rest));}function Item(props){const{isSortable,isGrid}=props,rest=_objectWithoutProperties(props,_excluded86);if(isGrid){const ItemComponent2=isSortable?SortableGridItem:GridItem;return/* @__PURE__ */jsx(ItemComponent2,_objectSpread({},rest));}const ItemComponent=isSortable?SortableListItem:ListItem;return/* @__PURE__ */jsx(ItemComponent,_objectSpread({},rest));}function isLegacyOptionsItem(item){if(item&&typeof item==="object"){const keys=Object.keys(item);if(keys.length<=2&&"value"in item){return true;}}return false;}function resolveValueWithLegacyOptionsSupport(item){return isLegacyOptionsItem(item)?item.value:item;}function isEqual(item,otherItem){if(isLegacyOptionsItem(item)||isLegacyOptionsItem(otherItem)){return item.value===otherItem.value;}if(item===otherItem){return true;}if(typeof item!==typeof otherItem){return false;}if(typeof item!=="object"&&!Array.isArray(item)){return item===otherItem;}if(item._key&&item._key===otherItem._key){return true;}if(Array.isArray(item)){if(!item.length!==otherItem.length){return false;}return item.every((it,i)=>isEqual(item[i],otherItem[i]));}const keys=Object.keys(item);const otherKeys=Object.keys(item);if(keys.length!==otherKeys.length){return false;}return keys.every(keyName=>isEqual(item[keyName],otherItem[keyName]));}function inArray(array,candidate){return array?array.some(item=>isEqual(item,candidate)):false;}class OptionsArrayInput extends React.PureComponent{constructor(){super(...arguments);this._element=null;this.handleChange=(isChecked,optionValue)=>{const{schemaType,value=[]}=this.props;const list=get$2(schemaType.options,"list");if(!isChecked&&optionValue._key){this.props.onChange(unset([{_key:optionValue._key}]));}const nextValue=list.filter(item=>isEqual(optionValue,item)?isChecked:inArray(value,resolveValueWithLegacyOptionsSupport(item))).map(resolveValueWithLegacyOptionsSupport);this.props.onChange(nextValue.length>0?set(nextValue):unset());};this.setElement=el=>{this._element=el;};this.handleFocus=index=>{const{onFocusIndex}=this.props;onFocusIndex(index);};}getMemberTypeOfItem(option){const{schemaType}=this.props;return schemaType.of.find(memberType=>memberType.name===resolveTypeName$1(resolveValueWithLegacyOptionsSupport(option)));}focus(){if(this._element){this._element.focus();}}render(){var _a,_b,_c;const{renderPreview,schemaType,value,readOnly,elementProps}=this.props;const options=((_a=schemaType.options)==null?void 0:_a.list)||[];const isGrid=((_b=schemaType.options)==null?void 0:_b.direction)==="horizontal"||((_c=schemaType.options)==null?void 0:_c.layout)==="grid";return/* @__PURE__ */jsx(List,_objectSpread(_objectSpread({isGrid,tabIndex:0},elementProps),{},{children:options.map((option,index)=>{const optionType=this.getMemberTypeOfItem(option);const checked=inArray(value||[],resolveValueWithLegacyOptionsSupport(option));const disabled=!optionType;const title=(option==null?void 0:option.title)||startCase(option==null?void 0:option.value)||option;return/* @__PURE__ */jsx(Item,{index,isGrid,children:/* @__PURE__ */jsxs(Flex,{align:"center",as:"label",muted:disabled,children:[/* @__PURE__ */jsx(WrappedCheckbox,{disabled,checked,onChange:e=>this.handleChange(e.currentTarget.checked,option),onFocus:()=>this.handleFocus(index),readOnly}),optionType&&(title?/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Text$1,{children:title})}):/* @__PURE__ */jsx(Box,{marginLeft:2,children:renderPreview({layout:"media",schemaType:optionType,value:resolveValueWithLegacyOptionsSupport(option)})})),!optionType&&/* @__PURE__ */jsx(ItemWithMissingType,{value:option,onFocus:()=>this.handleFocus(index)})]})},index);})}));}}const WrappedCheckbox=props=>{const{disabled,checked,onChange,onFocus,readOnly,onBlur}=props;return/* @__PURE__ */jsx(Checkbox$1,{disabled,checked,readOnly,onChange,onFocus,onBlur});};function focusRingBorderStyle(border){return"inset 0 0 0 ".concat(border.width,"px ").concat(border.color);}function focusRingStyle(opts){const{base,border,focusRing}=opts;const focusRingOutsetWidth=focusRing.offset+focusRing.width;const focusRingInsetWidth=0-focusRing.offset;const bgColor=base?base.bg:"var(--card-bg-color)";return[focusRingInsetWidth>0&&"inset 0 0 0 ".concat(focusRingInsetWidth,"px var(--card-focus-ring-color)"),border&&focusRingBorderStyle(border),focusRingInsetWidth<0&&"0 0 0 ".concat(0-focusRingInsetWidth,"px ").concat(bgColor),focusRingOutsetWidth>0&&"0 0 0 ".concat(focusRingOutsetWidth,"px var(--card-focus-ring-color)")].filter(Boolean).join(",");}const Root$4=styled(Box)(props=>{const{theme}=props;const{focusRing,input,radius}=theme.sanity;const color=theme.sanity.color.input;const space=rem(theme.sanity.space[1]);return{position:"relative",borderRadius:"".concat(radius[1],"px"),color:color.default.enabled.fg,backgroundColor:color.default.enabled.bg,boxShadow:focusRingBorderStyle({color:color.default.enabled.border,width:input.border.width}),"& > .content":{position:"relative",lineHeight:0,margin:"-".concat(space," 0 0 -").concat(space)},"& > .content > div":{display:"inline-block",verticalAlign:"top",padding:"".concat(space," 0 0 ").concat(space)},"&:not([data-read-only])":{cursor:"text"},"@media(hover:hover)":{"&:not([data-disabled]):not([data-read-only]):hover":{borderColor:color.default.hovered.border}},"&:not([data-disabled]):not([data-read-only])[data-focused]":{boxShadow:focusRingStyle({border:{color:color.default.enabled.border,width:input.border.width},focusRing})},"*:disabled + &":{color:color.default.disabled.fg,backgroundColor:color.default.disabled.bg,boxShadow:focusRingBorderStyle({color:color.default.disabled.border,width:input.border.width})}};});const Input=styled.input(props=>{const{theme}=props;const font=theme.sanity.fonts.text;const color=theme.sanity.color.input;const p=theme.sanity.space[2];const size=theme.sanity.fonts.text.sizes[2];return{appearance:"none",background:"none",border:0,borderRadius:0,outline:"none",fontSize:rem(size.fontSize),lineHeight:size.lineHeight/size.fontSize,fontFamily:font.family,fontWeight:font.weights.regular,margin:0,display:"block",minWidth:"1px",maxWidth:"100%",boxSizing:"border-box",paddingTop:rem(p-size.ascenderHeight),paddingRight:rem(p),paddingBottom:rem(p-size.descenderHeight),paddingLeft:rem(p),"&:not(:invalid):not(:disabled)":{color:color.default.enabled.fg},"&:not(:invalid):disabled":{color:color.default.disabled.fg}};});const Placeholder$1=styled(Box)(props=>{const{theme}=props;const color=theme.sanity.color.input;return css(_templateObject287||(_templateObject287=_taggedTemplateLiteral(["\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    pointer-events: none;\n    --card-fg-color: ",";\n  "])),color.default.enabled.placeholder);});const TagInput=forwardRef((props,ref)=>{const{disabled,onChange,onFocus,placeholder:placeholderProp,readOnly,value=[]}=props,restProps=_objectWithoutProperties(props,_excluded87);const placeholder=useMemo(()=>{if(placeholderProp)return placeholderProp;if(typeof window!=="undefined"&&"ontouchstart"in window){return"Enter tag\u2026";}return"Enter tag and press ENTER\u2026";},[placeholderProp]);const[inputValue,setInputValue]=useState("");const enabled=!disabled&&!readOnly;const[focused,setFocused]=useState(false);const forwardedRef=useForwardedRef(ref);const rootRef=useRef(null);const handleRootPointerDown=useCallback(event=>{const isTagElement=isHTMLElement(event.target)&&event.target.closest('[data-ui="Tag"]');if(isTagElement)return;const inputElement=forwardedRef.current;if(inputElement){setTimeout(()=>inputElement.focus(),0);}},[forwardedRef]);const handleInputBlur=useCallback(()=>{setFocused(false);},[]);const handleInputChange=useCallback(event=>{setInputValue(event.currentTarget.value);},[]);const handleInputFocus=useCallback(event=>{setFocused(true);if(onFocus)onFocus(event);},[onFocus]);const handleInputKeyDown=useCallback(event=>{if(event.key==="Enter"){event.preventDefault();event.stopPropagation();if(onChange&&inputValue){const newValue=value.concat([{value:inputValue}]);setInputValue("");if(onChange)onChange(newValue);}}},[inputValue,onChange,value]);const handleTagRemove=useCallback(index=>{if(!onChange)return;const newValue=value.slice(0);newValue.splice(index,1);onChange(newValue);},[onChange,value]);useEffect(()=>{const inputElement=forwardedRef.current;if(inputElement){inputElement.style.width="0";inputElement.style.width="".concat(inputElement.scrollWidth,"px");}},[forwardedRef,inputValue]);return/* @__PURE__ */jsxs(Root$4,{"data-disabled":disabled?"":void 0,"data-focused":focused?"":void 0,"data-read-only":readOnly?"":void 0,"data-ui":"TagInput",onPointerDown:handleRootPointerDown,padding:1,ref:rootRef,children:[enabled&&/* @__PURE__ */jsx(Placeholder$1,{hidden:Boolean(inputValue||value.length),padding:3,children:/* @__PURE__ */jsx(Text$1,{textOverflow:"ellipsis",children:placeholder})}),/* @__PURE__ */jsxs("div",{className:"content",children:[value.map((tag,tagIndex)=>/* @__PURE__ */jsx("div",{children:/* @__PURE__ */jsx(Tag,{enabled,index:tagIndex,muted:disabled,onRemove:handleTagRemove,tag})},"tag-".concat(tagIndex))),/* @__PURE__ */jsx("div",{children:/* @__PURE__ */jsx(Input,_objectSpread(_objectSpread({},restProps),{},{disabled:!enabled,onBlur:handleInputBlur,onChange:handleInputChange,onFocus:handleInputFocus,onKeyDown:handleInputKeyDown,ref:forwardedRef,type:"text",value:inputValue}))},"tag-input")]})]});});TagInput.displayName="TagInput";function Tag(props){const{enabled,index,muted,onRemove,tag}=props;const handleRemoveClick=useCallback(()=>{onRemove(index);},[index,onRemove]);return/* @__PURE__ */jsx(Card,{"data-ui":"Tag",padding:1,radius:2,tone:"transparent",children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsx(Box,{flex:1,padding:1,children:/* @__PURE__ */jsx(Text$1,{muted,children:tag.value})}),enabled&&/* @__PURE__ */jsx(Box,{marginLeft:1,children:/* @__PURE__ */jsx(Button,{icon:CloseIcon,mode:"bleed",onClick:handleRemoveClick,padding:1})})]})});}function TagsArrayInput(props){const{onChange,readOnly,value=[],elementProps}=props;const tagInputValue=useMemo(()=>value==null?void 0:value.map(v=>({value:v})),[value]);const handleChange=useCallback(nextValue=>{onChange(nextValue.length===0?unset():set(nextValue.map(v=>v.value)));},[onChange]);return/* @__PURE__ */jsx(TagInput,_objectSpread({onChange:handleChange,readOnly,value:tagInputValue},elementProps));}const DEFAULT_CONCURRENCY=4;function remove(array,item){const index=array.indexOf(item);if(index>-1){array.splice(index,1);}return array;}function withMaxConcurrency(func){let concurrency=arguments.length>1&&arguments[1]!==undefined?arguments[1]:DEFAULT_CONCURRENCY;const throttler=createThrottler(concurrency);return function(){return from(throttler(func(...arguments)));};}function createThrottler(){let concurrency=arguments.length>0&&arguments[0]!==undefined?arguments[0]:DEFAULT_CONCURRENCY;const currentSubscriptions=[];const pendingObservables=[];const ready$=new Subject();return request;function request(observable){return new Observable(observer=>{if(currentSubscriptions.length>=concurrency){return scheduleAndWait(observable).pipe(mergeMap(request)).subscribe(observer);}const subscription=observable.subscribe(observer);currentSubscriptions.push(subscription);return()=>{remove(currentSubscriptions,subscription);remove(pendingObservables,observable);subscription.unsubscribe();check();};});}function scheduleAndWait(observable){pendingObservables.push(observable);return ready$.asObservable().pipe(first(obs=>obs===observable));}function check(){while(pendingObservables.length>0&&currentSubscriptions.length<concurrency){ready$.next(pendingObservables.shift());}}}const MAX_CONCURRENT_UPLOADS=4;function uploadSanityAsset(client,assetType,file){let options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};const extract=options.metadata;const preserveFilename=options.storeOriginalFilename;const{label,title,description,creditLine,source}=options;return hashFile(file).pipe(catchError(()=>of(null)),mergeMap(hash=>hash?fetchExisting(client,"sanity.".concat(assetType,"Asset"),hash):of(null)),mergeMap(existing=>{if(existing){return of({type:"complete",id:existing._id,asset:existing});}return client.observable.assets.upload(assetType,file,{tag:"asset.upload",extract,preserveFilename,label,title,description,creditLine,source}).pipe(map(event=>event.type==="response"?{type:"complete",id:event.body.document._id,asset:event.body.document}:event));}));}const uploadAsset=withMaxConcurrency(uploadSanityAsset,MAX_CONCURRENT_UPLOADS);const uploadImageAsset=(client,file,options)=>uploadAsset(client,"image",file,options);const uploadFileAsset=(client,file,options)=>uploadAsset(client,"file",file,options);function observeAssetDoc(documentPreviewStore,id){return documentPreviewStore.observePaths({_type:"reference",_ref:id},["originalFilename","url","metadata","label","title","description","creditLine","source","size"]);}function observeImageAsset(documentPreviewStore,id){return observeAssetDoc(documentPreviewStore,id);}function observeFileAsset(documentPreviewStore,id){return observeAssetDoc(documentPreviewStore,id);}function fetchExisting(client,type,hash){return client.observable.fetch("*[_type == $documentType && sha1hash == $hash][0]",{documentType:type,hash},{tag:"asset.find-duplicate"});}function readFile(file){return new Observable(subscriber=>{const reader=new FileReader();reader.onload=()=>{subscriber.next(reader.result);subscriber.complete();};reader.onerror=err=>{subscriber.error(err);};reader.readAsArrayBuffer(file);return()=>{reader.abort();};});}function hashFile(file){if(!window.crypto||!window.crypto.subtle||!window.FileReader){return of(null);}return readFile(file).pipe(mergeMap(arrayBuffer=>crypto.subtle.digest("SHA-1",arrayBuffer)),map(hexFromBuffer));}function hexFromBuffer(buffer){return Array.prototype.map.call(new Uint8Array(buffer),x=>"00".concat(x.toString(16)).slice(-2)).join("");}function readFileAsArrayBuffer(file,length){return new Observable(observer=>{const reader=new window.FileReader();reader.onerror=err=>observer.error(err);reader.onload=()=>{observer.next(reader.result);observer.complete();};reader.readAsArrayBuffer(length===void 0?file:file.slice(0,length));return()=>reader.abort();});}const SKIP_EXIF_ERROR_RE=/(invalid image format)|(No exif data)/i;const EXIF_BUFFER_LENGTH=128e3;function readExif(file){return from(readFileAsArrayBuffer(file,EXIF_BUFFER_LENGTH)).pipe(map(buf=>exif(buf)),catchError(error=>{if(!SKIP_EXIF_ERROR_RE.test(error.message)){console.warn("Exif read failed, continuing anyway: ".concat(error.message));}return of({});}));}function rotated(n){return[5,6,7,8].indexOf(n)>-1;}function rotate(ctx,options){const x=options.x;const y=options.y;const radians=(options.degrees||0)*(Math.PI/180);ctx==null?void 0:ctx.translate(x,y);ctx==null?void 0:ctx.rotate(radians);ctx==null?void 0:ctx.translate(-x,-y);}function flip(canvas,x,y){const ctx=canvas.getContext("2d");ctx==null?void 0:ctx.translate(x?canvas.width:0,y?canvas.height:0);ctx==null?void 0:ctx.scale(x?-1:1,y?-1:1);}const ORIENTATION_OPS=[{op:"none",degrees:0},{op:"flip-x",degrees:0},{op:"none",degrees:180},{op:"flip-y",degrees:0},{op:"flip-x",degrees:90},{op:"none",degrees:90},{op:"flip-x",degrees:-90},{op:"none",degrees:-90}];const ORIENTATIONS=["top-left","top-right","bottom-right","bottom-left","left-top","right-top","right-bottom","left-bottom"];const DEFAULT_ORIENTATION="top-left";const THUMB_SIZE=120;function _orient(img,orientationNumber){const orientation=ORIENTATION_OPS[orientationNumber-1];const ratio=img.height/img.width;img.width=THUMB_SIZE/ratio;img.height=img.width*ratio;const canvas=document.createElement("canvas");const ctx=canvas.getContext("2d");if(rotated(orientationNumber)){canvas.height=img.width;canvas.width=img.height;}else{canvas.width=img.width;canvas.height=img.height;}if(orientation.op==="flip-x"){flip(canvas,true,false);}if(orientation.op==="flip-y"){flip(canvas,false,true);}if(orientation.degrees){rotate(ctx,{degrees:orientation.degrees,x:canvas.width/2,y:canvas.height/2});if(rotated(orientationNumber)){const d=canvas.width-canvas.height;ctx==null?void 0:ctx.translate(d/2,-d/2);}}ctx==null?void 0:ctx.drawImage(img,0,0,img.width,img.height);return canvas;}function orient(image,orientationId){return new Observable(observer=>{const orientation=ORIENTATIONS.indexOf(orientationId)+1;const canvas=_orient(image,orientation);observer.next(canvas.toDataURL("image/jpeg",0.1));observer.complete();});}function loadImage$1(url){return new Observable(observer=>{const image=new window.Image();image.onerror=()=>{observer.error(new Error("Could not load image from url \"".concat(url,"\". Image may be of an unsupported format")));};image.onload=()=>{observer.next(image);observer.complete();};image.src=url;return()=>{};});}function rotateImage(file,orientation){return loadImage$1(window.URL.createObjectURL(file)).pipe(mergeMap(image=>orient(image,orientation)));}const UPLOAD_STATUS_KEY="_upload";const UNSET_UPLOAD_PATCH=unset([UPLOAD_STATUS_KEY]);function createUploadEvent(){let patches=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];return{type:"uploadEvent",patches};}const CLEANUP_EVENT=createUploadEvent([UNSET_UPLOAD_PATCH]);function createInitialUploadEvent(file){const now=new Date().toISOString();const value={progress:2,initiated:now,updated:now,file:{name:file.name,type:file.type}};return createUploadEvent([setIfMissing({[UPLOAD_STATUS_KEY]:value},[]),set(value,[UPLOAD_STATUS_KEY])]);}function uploadImage(client,file,options){const upload$=uploadImageAsset(client,file,options).pipe(filter(event=>event.stage!=="download"),map(event=>_objectSpread(_objectSpread({},event),{},{progress:2+event.percent/100*98})),map(event=>{if(event.type==="complete"){return createUploadEvent([set({_type:"reference",_ref:event.asset._id},["asset"]),set(100,[UPLOAD_STATUS_KEY,"progress"]),set(new Date().toISOString(),[UPLOAD_STATUS_KEY,"updated"])]);}return createUploadEvent([set(event.percent,[UPLOAD_STATUS_KEY,"progress"]),set(new Date().toISOString(),[UPLOAD_STATUS_KEY,"updated"])]);}));const setPreviewUrl$=readExif(file).pipe(mergeMap(exifData=>rotateImage(file,exifData.orientation||DEFAULT_ORIENTATION)),catchError(error=>{console.warn('Image preprocessing failed for "%s" with the error: %s',file.name,error.message);return of(null);}),filter(Boolean),map(imageUrl=>createUploadEvent([set(imageUrl,[UPLOAD_STATUS_KEY,"previewImage"])])));return of(createInitialUploadEvent(file)).pipe(concat$1(from(upload$).pipe(merge$1(setPreviewUrl$))),concat$1(of(CLEANUP_EVENT)));}function uploadFile(client,file,options){const upload$=uploadFileAsset(client,file,options).pipe(map(event=>{if(event.type==="complete"){return createUploadEvent([set({_type:"reference",_ref:event.asset._id},["asset"]),set(100,[UPLOAD_STATUS_KEY,"progress"]),set(new Date().toISOString(),[UPLOAD_STATUS_KEY,"updated"])]);}return createUploadEvent([set(event.percent,[UPLOAD_STATUS_KEY,"progress"]),set(new Date().toISOString(),[UPLOAD_STATUS_KEY,"updated"])]);}));return of(createInitialUploadEvent(file)).pipe(concat$1(upload$),concat$1(of(CLEANUP_EVENT)));}const UPLOAD_IMAGE={type:"image",accepts:"image/*",upload:(client,file,type,options)=>uploadImage(client,file,options)};const UPLOAD_FILE={type:"file",accepts:"",upload:(client,file,type,options)=>uploadFile(client,file,options)};const UPLOAD_TEXT={type:"string",accepts:"text/*",upload:(client,file,type,options)=>uploadFile(client,file,options).pipe(map(content=>({type:"uploadEvent",patches:[set(content)]})))};const uploaders=[UPLOAD_IMAGE,UPLOAD_TEXT,UPLOAD_FILE].map((uploader,i)=>_objectSpread(_objectSpread({},uploader),{},{priority:i}));function accepts(file,acceptedFiles){if(!file||!acceptedFiles){return true;}const acceptedFilesArray=Array.isArray(acceptedFiles)?acceptedFiles:acceptedFiles.split(",");const fileName=file.name||"";const mimeType=(file.type||"").toLowerCase();const baseMimeType=mimeType.replace(/\/.*$/,"");return acceptedFilesArray.some(type=>{const validType=type.trim().toLowerCase();if(validType.charAt(0)==="."){return fileName.toLowerCase().endsWith(validType);}if(validType.endsWith("/*")){return baseMimeType===validType.replace(/\/.*$/,"");}return mimeType===validType;});}function resolveUploader(type,file){return uploaders.find(uploader=>{var _a;return is(uploader.type,type)&&accepts(file,uploader.accepts)&&accepts(file,((_a=type.options)==null?void 0:_a.accept)||"");})||null;}function getSchemaTypeTitle(type){if(typeof type.title==="string"){return type.title;}if(type.type){return getSchemaTypeTitle(type.type);}return type.name||type.jsonType;}const BEFORE="before";const AFTER="after";function arrayInsert(array,position,index){if(position!==BEFORE&&position!==AFTER){throw new Error("Invalid position \"".concat(position,"\", must be either ").concat(BEFORE," or ").concat(AFTER));}for(var _len8=arguments.length,args=new Array(_len8>3?_len8-3:0),_key9=3;_key9<_len8;_key9++){args[_key9-3]=arguments[_key9];}const items=flatten(...args);if(array.length===0){return items;}const len=array.length;const idx=Math.abs((len+index)%len)%len;const normalizedIdx=position==="after"?idx+1:idx;const copy=array.slice();copy.splice(normalizedIdx,0,...flatten(items));return copy;}function flatten(){for(var _len9=arguments.length,values=new Array(_len9),_key10=0;_key10<_len9;_key10++){values[_key10]=arguments[_key10];}return values.reduce((prev,item)=>prev.concat(item),[]);}const hasOwn=(obj,property)=>Object.prototype.hasOwnProperty.call(obj,property);function move(arr,from,to){const nextValue=arr.slice();const val=nextValue[from];nextValue.splice(from,1);nextValue.splice(to,0,val);return nextValue;}function findTargetIndex(array,pathSegment){if(typeof pathSegment==="number"){return pathSegment;}const index=findIndex$1(array,pathSegment);return index===-1?false:index;}function _arrayApply(value,patch){const nextValue=value.slice();if(patch.path.length===0){if(patch.type==="setIfMissing"){if(!Array.isArray(patch.value)){throw new Error("Cannot set value of an array to a non-array");}return value===void 0?patch.value:value;}else if(patch.type==="set"){if(!Array.isArray(patch.value)){throw new Error("Cannot set value of an array to a non-array");}return patch.value;}else if(patch.type==="unset"){return void 0;}else if(patch.type==="move"){if(!patch.value||!hasOwn(patch.value,"from")||!hasOwn(patch.value,"to")){throw new Error("Invalid value of 'move' patch. Expected a value with \"from\" and \"to\" indexes, instead got: ".concat(JSON.stringify(patch.value)));}return move(nextValue,patch.value.from,patch.value.to);}throw new Error("Invalid array operation: ".concat(patch.type));}const[head,...tail]=patch.path;const index=findTargetIndex(value,head);if(index===false){return nextValue;}if(tail.length===0){if(patch.type==="insert"){const{position,items}=patch;return arrayInsert(value,position,index,items);}else if(patch.type==="unset"){if(typeof index!=="number"){throw new Error("Expected array index to be a number, instead got \"".concat(index,"\""));}nextValue.splice(index,1);return nextValue;}}nextValue[index]=applyPatch(nextValue[index],_objectSpread(_objectSpread({},patch),{},{path:tail}));return nextValue;}function _objectApply(value,patch){const nextValue=clone(value);if(patch.path.length===0){if(patch.type==="set"){if(!isObject(patch.value)){throw new Error("Cannot set value of an object to a non-object");}return patch.value;}else if(patch.type==="unset"){return void 0;}else if(patch.type==="setIfMissing"){return value===void 0?patch.value:value;}throw new Error("Invalid object operation: ".concat(patch.type));}const[head,...tail]=patch.path;if(typeof head!=="string"){throw new Error("Expected field name to be a string, instad got: ".concat(head));}if(tail.length===0&&patch.type==="unset"){return omit(nextValue,head);}nextValue[head]=applyPatch(nextValue[head],_objectSpread(_objectSpread({},patch),{},{path:tail}));return nextValue;}const OPERATIONS$1={replace(currentValue,nextValue){return nextValue;},set(currentValue,nextValue){return nextValue;},setIfMissing(currentValue,nextValue){return currentValue===void 0?nextValue:currentValue;},unset(currentValue,nextValue){return void 0;},inc(currentValue,nextValue){return currentValue+nextValue;},dec(currentValue,nextValue){return currentValue-nextValue;}};const SUPPORTED_PATCH_TYPES$1=Object.keys(OPERATIONS$1);function _primitiveApply(value,patch){if(!SUPPORTED_PATCH_TYPES$1.includes(patch.type)){throw new Error("Received patch of unsupported type \"".concat(patch.type,"\" for primitives. This is most likely a bug."));}if(patch.path.length>0){throw new Error("Cannot apply deep operations on primitive values. Received patch with type \"".concat(patch.type,"\" and path \"").concat(patch.path.map(path=>JSON.stringify(path)).join(".")," that targeted the value \"").concat(JSON.stringify(value),"\""));}return OPERATIONS$1[patch.type](value,patch.value);}const dmp=new DMP.diff_match_patch();const OPERATIONS={replace(currentValue,nextValue){return nextValue;},set(currentValue,nextValue){return nextValue;},setIfMissing(currentValue,nextValue){return currentValue===void 0?nextValue:currentValue;},unset(currentValue,nextValue){return void 0;},diffMatchPatch(currentValue,nextValue){return dmp.patch_apply(dmp.patch_fromText(nextValue),currentValue)[0];}};const SUPPORTED_PATCH_TYPES=Object.keys(OPERATIONS);function _stringApply(value,patch){if(!SUPPORTED_PATCH_TYPES.includes(patch.type)){throw new Error("Received patch of unsupported type: \"".concat(JSON.stringify(patch.type),"\" for string. This is most likely a bug."));}if(patch.path.length>0){throw new Error("Cannot apply deep operations on string values. Received patch with type \"".concat(patch.type,"\" and path \"").concat(patch.path.join(".")," that targeted the value \"").concat(JSON.stringify(value),"\""));}return OPERATIONS[patch.type](value,patch.value);}function applyAll(value,patches){return patches.reduce(applyPatch,value);}function _applyPatch(value,patch){if(Array.isArray(value)){return _arrayApply(value,patch);}if(isString$1(value)){return _stringApply(value,patch);}if(isObject(value)){return _objectApply(value,patch);}return _primitiveApply(value,patch);}function applyPatch(value,patch){const res=_applyPatch(value,patch);return res;}function withFocusRing(component){return styled(component)(props=>{const border={width:props.$border?1:0,color:"var(--card-border-color)"};return css(_templateObject288||(_templateObject288=_taggedTemplateLiteral(["\n        --card-focus-box-shadow: ",";\n\n        border-radius: ",";\n        outline: none;\n        box-shadow: var(--card-focus-box-shadow);\n\n        &:focus {\n          --card-focus-box-shadow: ",";\n        }\n      "])),focusRingBorderStyle$1(border),rem(props.theme.sanity.radius[1]),focusRingStyle$1({base:props.theme.sanity.color.base,border,focusRing:props.theme.sanity.focusRing}));});}function extractPastedFiles(dataTransfer){if(dataTransfer.files&&dataTransfer.files.length>0){return Promise.resolve(Array.from(dataTransfer.files||[]));}return normalizeItems(Array.from(dataTransfer.items||[])).then(flatten$1);}function extractDroppedFiles(dataTransfer){const files=Array.from(dataTransfer.files||[]);const items=Array.from(dataTransfer.items||[]);if(files&&files.length>0){return Promise.resolve(files);}return normalizeItems(items).then(flatten$1);}function toArray(v){return v===null?[]:[v];}function normalizeItems(items){return Promise.all(items.map(item=>{if(item.kind==="file"&&item.webkitGetAsEntry){let entry;try{entry=item.webkitGetAsEntry();}catch(err){return toArray(item.getAsFile());}if(!entry){return[];}return entry.isDirectory?walk(entry):toArray(item.getAsFile());}if(item.kind==="file"){const file=item.getAsFile();return Promise.resolve(file?[file]:[]);}if(item.kind==="string"){console.warn('DataTransfer with kind="string" is currently not supported');return Promise.resolve([]);}console.warn("Unknown DataTransferItem.kind: %s",item.kind);return Promise.resolve([]);}));}function walk(entry){if(entry.isFile){return new Promise((resolve,reject)=>entry.file(resolve,reject)).then(file=>[file]);}if(entry.isDirectory){const dir=entry.createReader();return new Promise((resolve,reject)=>dir.readEntries(resolve,reject)).then(entries=>entries.filter(entr=>!entr.name.startsWith("."))).then(entries=>Promise.all(entries.map(walk)).then(flatten$1));}return Promise.resolve([]);}function imageUrlToBlob(imageUrl){let format=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"image/jpeg";let quality=arguments.length>2&&arguments[2]!==undefined?arguments[2]:1;if(imageUrl.match(/^webkit-fake-url:\/\//)){return Promise.reject(new Error("Cannot read image contents from webkit fake url"));}return new Promise((resolve,reject)=>{const loader=new Image();loader.crossOrigin="anonymous";loader.referrerPolicy="strict-origin-when-cross-origin";loader.onload=()=>{const canvas=document.createElement("canvas");canvas.width=loader.width;canvas.height=loader.height;const ctx=canvas.getContext("2d");ctx==null?void 0:ctx.drawImage(loader,0,0,canvas.width,canvas.height);try{canvas.toBlob(resolve,format,quality);}catch(error){reject(error);}};loader.src=imageUrl;});}const PASTE_INPUT_STYLE={opacity:0,position:"absolute"};function fileTarget(Component){return React.forwardRef(function FileTarget(props,ref){const{onFiles,onFilesOver,onFilesOut,disabled}=props,rest=_objectWithoutProperties(props,_excluded88);const[showPasteInput,setShowPasteInput]=React.useState(false);const pasteInput=React.useRef(null);const forwardedRef=useForwardedRef(ref);const enteredElements=React.useRef([]);const emitFiles=useCallback(files=>{onFiles==null?void 0:onFiles(files);},[onFiles]);const handleKeyDown=useCallback(event=>{if(event.target===forwardedRef.current&&(event.ctrlKey||event.metaKey)&&event.key==="v"){setShowPasteInput(true);}},[forwardedRef]);const handlePaste=useCallback(event=>{extractPastedFiles(event.clipboardData).then(files=>{if(!pasteInput.current){return[];}return files.length>0?files:convertImagesToFilesAndClearContentEditable(pasteInput.current,"image/jpeg");}).then(files=>{var _a;emitFiles(files);setShowPasteInput(false);(_a=forwardedRef.current)==null?void 0:_a.focus();});},[emitFiles,forwardedRef]);const handleDrop=useCallback(event=>{enteredElements.current=[];event.preventDefault();event.stopPropagation();const dataTransfer=event.nativeEvent.dataTransfer;if(onFiles&&dataTransfer){extractDroppedFiles(dataTransfer).then(files=>{if(files){emitFiles(files);}});}onFilesOut==null?void 0:onFilesOut();},[emitFiles,onFiles,onFilesOut]);const handleDragOver=useCallback(event=>{if(onFiles){event.preventDefault();event.stopPropagation();}},[onFiles]);const handleDragEnter=useCallback(event=>{event.stopPropagation();if(onFilesOver&&forwardedRef.current===event.currentTarget){enteredElements.current=[...new Set(enteredElements.current),event.currentTarget];const fileTypes=Array.from(event.dataTransfer.items).map(item=>({type:item.type,kind:item.kind}));onFilesOver(fileTypes);}},[onFilesOver,forwardedRef]);const handleDragLeave=useCallback(event=>{event.stopPropagation();const idx=enteredElements.current.indexOf(event.currentTarget);if(idx>-1){enteredElements.current.splice(idx,1);}if(enteredElements.current.length===0){onFilesOut==null?void 0:onFilesOut();}},[onFilesOut]);const prevShowPasteInput=React.useRef(false);React.useEffect(()=>{var _a;if(!prevShowPasteInput.current&&showPasteInput&&pasteInput.current){pasteInput.current.focus();select(pasteInput.current);}else if(prevShowPasteInput.current&&!showPasteInput){(_a=pasteInput.current)==null?void 0:_a.focus();}prevShowPasteInput.current=showPasteInput;},[showPasteInput]);return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Component,_objectSpread(_objectSpread({},rest),{},{ref:forwardedRef,onKeyDown:disabled?void 0:handleKeyDown,onDragOver:disabled?void 0:handleDragOver,onDragEnter:disabled?void 0:handleDragEnter,onDragLeave:disabled?void 0:handleDragLeave,onDrop:disabled?void 0:handleDrop})),!disabled&&showPasteInput&&/* @__PURE__ */jsx("div",{contentEditable:true,onPaste:handlePaste,ref:pasteInput,style:PASTE_INPUT_STYLE})]});});}function convertImagesToFilesAndClearContentEditable(element){let targetFormat=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"image/jpeg";if(!element.isContentEditable){return Promise.reject(new Error("Expected element to be contentEditable=\"true\". Instead found a non contenteditable ".concat(element.tagName)));}return new Promise(resolve=>setTimeout(resolve,10)).then(()=>Array.from(element.querySelectorAll("img"))).then(imageElements=>{element.innerHTML="";return imageElements;}).then(images=>Promise.all(images.map(img=>imageUrlToBlob(img.src)))).then(imageBlobs=>imageBlobs.map(blob=>new File([blob],"pasted-image.jpg",{type:targetFormat})));}function select(el){const range=document.createRange();range.selectNodeContents(el);const sel=window.getSelection();sel==null?void 0:sel.removeAllRanges();sel==null?void 0:sel.addRange(range);}function DropMessage(props){const{hoveringFiles,types,resolveUploader}=props;const acceptedFiles=hoveringFiles.filter(file=>types.some(type=>resolveUploader(type,file)));const rejectedFilesCount=hoveringFiles.length-acceptedFiles.length;const multiple=types.length>1;return/* @__PURE__ */jsx(Fragment,{children:acceptedFiles.length>0?/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsxs(Inline,{space:2,children:[/* @__PURE__ */jsx(Text$1,{children:/* @__PURE__ */jsx(UploadIcon,{})}),/* @__PURE__ */jsxs(Text$1,{children:["Drop to upload"," ",multiple&&/* @__PURE__ */jsxs(Fragment,{children:[acceptedFiles.length," file",acceptedFiles.length>1?"s":""]})]})]}),rejectedFilesCount>0&&/* @__PURE__ */jsx(Box,{marginTop:4,children:/* @__PURE__ */jsxs(Inline,{space:2,children:[/* @__PURE__ */jsx(Text$1,{muted:true,size:1,children:/* @__PURE__ */jsx(AccessDeniedIcon,{})}),/* @__PURE__ */jsxs(Text$1,{muted:true,size:1,children:[rejectedFilesCount," file",rejectedFilesCount>1?"s":""," can't be uploaded here"]})]})})]}):/* @__PURE__ */jsxs(Inline,{space:2,children:[/* @__PURE__ */jsx(Text$1,{children:/* @__PURE__ */jsx(AccessDeniedIcon,{})}),/* @__PURE__ */jsxs(Text$1,{children:["Can't upload ",hoveringFiles.length>1?"any of these files":"this file"," here"]})]})});}const Overlay$1=styled(Layer)(_templateObject289||(_templateObject289=_taggedTemplateLiteral(["\n  position: absolute;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  top: -2px;\n  left: -2px;\n  right: -2px;\n  bottom: -2px;\n  background-color: var(--card-bg-color);\n  opacity: 0.8;\n"])));const Root$3=styled.div(_templateObject290||(_templateObject290=_taggedTemplateLiteral(["\n  position: relative;\n"])));function getUploadCandidates(types,resolveUploader,file){return types.map(memberType=>({type:memberType,uploader:resolveUploader(memberType,file)})).filter(member=>member.uploader);}function uploadTarget(Component){const FileTarget=fileTarget(Component);return React.forwardRef(function UploadTarget(props,forwardedRef){const{children,resolveUploader,onUpload,types}=props,rest=_objectWithoutProperties(props,_excluded89);const{push:pushToast}=useToast();const uploadFile=React.useCallback((file,resolvedUploader)=>{const{type,uploader}=resolvedUploader;onUpload==null?void 0:onUpload({file,type,uploader});},[onUpload]);const handleFiles=React.useCallback(files=>{if(!resolveUploader){return;}const tasks=files.map(file=>({file,uploaderCandidates:getUploadCandidates(types,resolveUploader,file)}));const ready=tasks.filter(task=>task.uploaderCandidates.length>0);const rejected=tasks.filter(task=>task.uploaderCandidates.length===0);if(rejected.length>0){const plural=rejected.length>1;pushToast({closable:true,status:"warning",title:"The following item".concat(plural?"s":""," can't be uploaded because there's no known conversion from content type").concat(plural?"s":""," to array item:"),description:rejected.map((task,i)=>/* @__PURE__ */jsxs(Flex,{padding:2,children:[/* @__PURE__ */jsx(Box,{marginLeft:1,children:/* @__PURE__ */jsx(Text$1,{weight:"semibold",children:task.file.name})}),/* @__PURE__ */jsx(Box,{paddingLeft:2,children:/* @__PURE__ */jsxs(Text$1,{size:1,children:["(",task.file.type,")"]})})]},i))});}ready.forEach(task=>{uploadFile(task.file,sortBy(task.uploaderCandidates,candidate=>candidate.uploader.priority)[0]);});},[pushToast,resolveUploader,types,uploadFile]);const[hoveringFiles,setHoveringFiles]=React.useState([]);const handleFilesOut=React.useCallback(()=>setHoveringFiles([]),[]);return/* @__PURE__ */jsx(Root$3,{children:/* @__PURE__ */jsxs(FileTarget,_objectSpread(_objectSpread({},rest),{},{ref:forwardedRef,onFiles:handleFiles,onFilesOver:setHoveringFiles,onFilesOut:handleFilesOut,children:[resolveUploader&&hoveringFiles.length>0&&/* @__PURE__ */jsx(Overlay$1,{zOffset:10,children:/* @__PURE__ */jsx(DropMessage,{hoveringFiles,types,resolveUploader})}),children]}))});});}const SCROLL_OPTIONS={scrollMode:"if-needed"};function useScrollIntoViewOnFocusWithin(elementRef,hasFocusWithin){return useDidUpdate(hasFocusWithin,useCallback((hadFocus,hasFocus)=>{if(elementRef.current&&!hadFocus&&hasFocus){scrollIntoView$1(elementRef.current,SCROLL_OPTIONS);}},[elementRef]));}const DragHandleButton=styled(Button)(_templateObject291||(_templateObject291=_taggedTemplateLiteral(["\n  cursor: ",";\n"])),props=>props.grid?"move":"ns-resize");const DRAG_HANDLE_PROPS={[DRAG_HANDLE_ATTRIBUTE]:true};const DragHandle=sortableHandle(function DragHandle2(props){return/* @__PURE__ */jsx(DragHandleButton,_objectSpread(_objectSpread({icon:DragHandleIcon,mode:"bleed",tabIndex:0,"data-ui":"DragHandleButton"},props),DRAG_HANDLE_PROPS));});const MENU_POPOVER_PROPS$1={portal:true,tone:"default",placement:"left",constrainSize:true};const InsertMenu=memo(function InsertMenu2(props){const{types,onInsert}=props;return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(InsertMenuGroup,{pos:"before",types,onInsert,text:"Add item before",icon:InsertAboveIcon}),/* @__PURE__ */jsx(InsertMenuGroup,{pos:"after",types,onInsert,text:"Add item after",icon:InsertBelowIcon})]});});function InsertMenuGroup(props){const{types,onInsert,pos,text,icon}=props;if((types==null?void 0:types.length)===1){return/* @__PURE__ */jsx(MenuItem,{text,icon,onClick:()=>onInsert(pos,types[0])},pos);}return/* @__PURE__ */jsx(MenuGroup,{text,popover:MENU_POPOVER_PROPS$1,children:types==null?void 0:types.map(insertableType=>/* @__PURE__ */jsx(MenuItem,{icon:insertableType.icon,text:insertableType.title,onClick:()=>onInsert(pos,insertableType)},insertableType.name))},pos);}const Root$2=styled(Card)(_templateObject292||(_templateObject292=_taggedTemplateLiteral(["\n  position: relative;\n  border: 1px solid transparent;\n  .dragHandle {\n    color: var(--card-shadow-umbra-color);\n  }\n  &:hover {\n    border-color: var(--card-shadow-umbra-color);\n    .dragHandle {\n      color: inherit;\n    }\n  }\n  &[aria-selected='true'] {\n    border-color: var(--card-focus-ring-color);\n  }\n  ."," & {\n    box-shadow: 0 0 0 0, 0 8px 17px 2px var(--card-shadow-umbra-color),\n      0 3px 14px 2px var(--card-shadow-penumbra-color),\n      0 5px 5px -3px var(--card-shadow-ambient-color);\n  }\n"])),MOVING_ITEM_CLASS_NAME);const RowWrapper=React.forwardRef(function RowWrapper2(props,ref){const{children}=props,rest=_objectWithoutProperties(props,_excluded90);return/* @__PURE__ */jsx(Root$2,_objectSpread(_objectSpread({},rest),{},{ref,tone:props.tone,tabIndex:-1,children}));});const dragHandle$2=/* @__PURE__ */jsx(DragHandle,{paddingX:1,paddingY:3});const MENU_POPOVER_PROPS={portal:true,tone:"default"};const RowItem=React.forwardRef(function RegularItem(props,ref){var _a;const focusRef=React.useRef(null);const{isSortable,value,onClick,onFocus,type,readOnly,presence,onInsert,insertableTypes,onRemove,renderPreview,validation=EMPTY_ARRAY$4}=props,rest=_objectWithoutProperties(props,_excluded91);const hasErrors=validation.some(v=>v.level==="error");const hasWarnings=validation.some(v=>v.level==="warning");const handleDuplicate=useCallback(()=>{onInsert({items:[_objectSpread(_objectSpread({},value),{},{_key:randomKey()})],position:"after"});},[onInsert,value]);const handleInsert=useCallback((pos,insertType)=>{onInsert({items:[_objectSpread(_objectSpread({},createProtoValue(insertType)),{},{_key:randomKey()})],position:pos});},[onInsert]);const id=useId();return/* @__PURE__ */jsx(RowWrapper,_objectSpread(_objectSpread({},rest),{},{ref,radius:2,padding:1,tone:readOnly?"transparent":hasErrors?"critical":hasWarnings?"caution":"default",children:/* @__PURE__ */jsxs(Flex,{align:"center",children:[isSortable&&/* @__PURE__ */jsx(Card,{className:"dragHandle",tone:"inherit",marginRight:1,children:dragHandle$2}),type?/* @__PURE__ */jsx(Card,{as:"button",type:"button",tone:"inherit",radius:2,padding:1,flex:1,onClick,ref:focusRef,onFocus,__unstable_focusRing:true,children:renderPreview({layout:type.options&&"layout"in type.options&&((_a=type.options)==null?void 0:_a.layout)==="grid"?"media":"default",schemaType:type,value})}):/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(ItemWithMissingType,{value,onFocus})}),/* @__PURE__ */jsxs(Flex,{align:"center",children:[!readOnly&&presence.length>0&&/* @__PURE__ */jsx(Box,{marginLeft:1,children:/* @__PURE__ */jsx(FieldPresence,{presence,maxAvatars:1})}),validation.length>0&&/* @__PURE__ */jsx(Box,{marginLeft:1,paddingX:1,paddingY:3,children:/* @__PURE__ */jsx(FormFieldValidationStatus,{__unstable_showSummary:!(value==null?void 0:value._ref)})}),!readOnly&&/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{padding:2,mode:"bleed",icon:EllipsisVerticalIcon}),id:"".concat(id,"-menuButton"),menu:/* @__PURE__ */jsxs(Menu,{children:[/* @__PURE__ */jsx(MenuItem,{text:"Remove",tone:"critical",icon:TrashIcon,onClick:onRemove}),/* @__PURE__ */jsx(MenuItem,{text:"Duplicate",icon:CopyIcon,onClick:handleDuplicate}),/* @__PURE__ */jsx(InsertMenu,{types:insertableTypes,onInsert:handleInsert})]}),placement:"right",popover:MENU_POPOVER_PROPS}),!value._key&&/* @__PURE__ */jsx(Box,{marginLeft:1,children:/* @__PURE__ */jsx(Tooltip,{content:/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsxs(Text$1,{muted:true,size:1,children:["This item is missing the required ",/* @__PURE__ */jsx("code",{children:"_key"})," property."]})}),placement:"top",children:/* @__PURE__ */jsx(Badge,{mode:"outline",tone:"caution",children:"Missing key"})})})]})]})}));});const dragHandle$1=/* @__PURE__ */jsx(DragHandle,{grid:true,padding:2,mode:"ghost"});const DragHandleCard=styled(Card)(_templateObject293||(_templateObject293=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  left: 0;\n"])));const PresenceFlex=styled(Flex)(_templateObject294||(_templateObject294=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  right: 0;\n  height: 35px;\n"])));const Root$1=styled(Card)(_templateObject295||(_templateObject295=_taggedTemplateLiteral(["\n  transition: border-color 250ms;\n  position: relative;\n\n  @media (hover: hover) {\n    "," {\n      opacity: 0;\n    }\n\n    &:hover,\n    &:focus-within {\n      "," {\n        opacity: 1;\n      }\n    }\n  }\n\n  &[aria-selected='true'] {\n    box-shadow: 0 0 0 2px var(--card-focus-ring-color);\n  }\n"])),DragHandleCard,DragHandleCard);const FooterFlex=styled(Flex)(_templateObject296||(_templateObject296=_taggedTemplateLiteral(["\n  min-height: 35px;\n"])));const PreviewCard$1=styled(Card)(_templateObject297||(_templateObject297=_taggedTemplateLiteral(["\n  border-top-right-radius: inherit;\n  border-top-left-radius: inherit;\n  height: 100%;\n\n  @media (hover: hover) {\n    &:hover {\n      filter: brightness(95%);\n    }\n  }\n\n  &:focus:focus-visible {\n    box-shadow: 0 0 0 2px var(--card-focus-ring-color);\n  }\n"])));const MissingTypeBox=styled(Box)(_templateObject298||(_templateObject298=_taggedTemplateLiteral(["\n  padding-bottom: 100%;\n"])));const StyledItemWithMissingType=styled(ItemWithMissingType)(_templateObject299||(_templateObject299=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  left: 0;\n  height: 100%;\n"])));const CellItem=React.forwardRef(function ItemCell(props,ref){const focusRef=React.useRef(null);const{isSortable,value,onClick,onFocus,onInsert,insertableTypes,type,readOnly,presence,onRemove,renderPreview,validation=EMPTY_ARRAY$4}=props,rest=_objectWithoutProperties(props,_excluded92);const hasError=validation.filter(item=>item.level==="error").length>0;const hasWarning=validation.filter(item=>item.level==="warning").length>0;const tone=useMemo(()=>{if(!value._key){return"caution";}if(hasError){return"critical";}if(hasWarning){return"caution";}return void 0;},[hasError,hasWarning,value._key]);const handleDuplicate=useCallback(()=>{onInsert==null?void 0:onInsert({items:[_objectSpread(_objectSpread({},value),{},{_key:randomKey()})],position:"after"});},[onInsert,value]);const handleInsert=useCallback((pos,insertType)=>{onInsert==null?void 0:onInsert({items:[createProtoValue(insertType)],position:pos});},[onInsert,value._key]);const id=useId();return/* @__PURE__ */jsxs(Root$1,_objectSpread(_objectSpread({},rest),{},{radius:2,ref,border:true,tone,children:[type?/* @__PURE__ */jsx(PreviewCard$1,{tone:"inherit","data-ui":"PreviewCard",forwardedAs:"button",type:"button",overflow:"auto",flex:1,tabIndex:0,onClick,ref:focusRef,onFocus,__unstable_focusRing:true,children:renderPreview({layout:"media",schemaType:type,value,withBorder:false,withRadius:false})}):/* @__PURE__ */jsx(MissingTypeBox,{flex:1,children:/* @__PURE__ */jsx(StyledItemWithMissingType,{value,onFocus,vertical:true})}),/* @__PURE__ */jsx(DragHandleCard,{margin:1,radius:2,display:"flex",tone:"inherit","data-ui":"DragHandleCard",children:!readOnly&&isSortable&&dragHandle$1}),/* @__PURE__ */jsx(PresenceFlex,{align:"center",marginX:1,children:!readOnly&&/* @__PURE__ */jsx(FieldPresence,{presence,maxAvatars:1})}),/* @__PURE__ */jsxs(FooterFlex,{align:"center",paddingX:1,sizing:"border",justify:"space-between",children:[/* @__PURE__ */jsxs(Flex,{children:[(value==null?void 0:value._key)&&validation.length>0&&/* @__PURE__ */jsx(Box,{marginLeft:1,paddingX:1,paddingY:3,children:/* @__PURE__ */jsx(FormFieldValidationStatus,{validation,__unstable_showSummary:!(value==null?void 0:value._ref),placement:"bottom",portal:true})}),!value._key&&/* @__PURE__ */jsx(Tooltip,{portal:true,content:/* @__PURE__ */jsx(Card,{padding:2,children:/* @__PURE__ */jsxs(Text$1,{size:1,children:["This item is missing a required ",/* @__PURE__ */jsx("code",{children:"_key"})," property."]})}),children:/* @__PURE__ */jsxs(Badge,{mode:"outline",tone:"caution",margin:1,padding:2,fontSize:1,children:[/* @__PURE__ */jsx(WarningOutlineIcon,{})," key"]})})]}),!readOnly&&/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{padding:2,mode:"bleed",icon:EllipsisVerticalIcon}),id:"".concat(id,"-menuButton"),portal:true,menu:/* @__PURE__ */jsxs(Menu,{children:[/* @__PURE__ */jsx(MenuItem,{text:"Remove",tone:"critical",icon:TrashIcon,onClick:onRemove}),/* @__PURE__ */jsx(MenuItem,{text:"Duplicate",icon:CopyIcon,onClick:handleDuplicate}),/* @__PURE__ */jsx(InsertMenu,{types:insertableTypes,onInsert:handleInsert})]})})})]})]}));});const ArrayItem=memo(function ArrayItem2(props){const{changed,value,insertableTypes,schemaType,index,open,path,onClick,layout,readOnly,presence=[],validation=[],focused,onRemove,onInsert,onFocus,children,renderPreview}=props;const innerElementRef=useRef(null);useScrollIntoViewOnFocusWithin(innerElementRef,open);useDidUpdate(focused,(hadFocus,hasFocus)=>{var _a;if(!hadFocus&&hasFocus&&innerElementRef.current){(_a=innerElementRef.current)==null?void 0:_a.focus();}});const childPresence=useChildPresence(path);const handleRemove=useCallback(()=>onRemove(value),[onRemove,value]);const options=schemaType.options||{};const isSortable=!readOnly&&options.sortable!==false;const isGrid=layout==="grid";const ItemComponent=isGrid?CellItem:RowItem;const isReference=schemaType&&isReferenceSchemaType(schemaType);const item=/* @__PURE__ */jsx(ItemComponent,{"aria-selected":open,index,onFocus,value,readOnly,type:schemaType,insertableTypes,presence:open?presence:childPresence,validation,isSortable,onInsert,onClick,onRemove:handleRemove,ref:innerElementRef,renderPreview});return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(ChangeIndicator,{path,disabled:open&&!isReference,isChanged:changed,hasFocus:!!focused,children:isGrid?item:/* @__PURE__ */jsx(Box,{marginX:1,children:item})}),children]});});function createProtoValue(type){if(!isObjectSchemaType(type)){throw new Error("Invalid item type: \"".concat(type.type,"\". Default array input can only contain objects (for now)"));}const _key=randomKey$1(12);return type.name==="object"?{_key}:{_type:type.name,_key};}const UploadTarget=uploadTarget(withFocusRing(Card));class ArrayInput extends React.PureComponent{constructor(){super(...arguments);this._focusArea=null;this.toast=null;this.uploadSubscriptions={};this.state={isResolvingInitialValue:false};this.insert=(item,position,referenceItem)=>{const{onInsert}=this.props;onInsert({items:[item],position,referenceItem});};this.handlePrepend=value=>{this.handleInsert({item:value,position:"before",referenceItem:0});};this.handleAppend=value=>{this.handleInsert({item:value,position:"after",referenceItem:-1});};this.handleInsert=event=>{const{onFocusPath,onOpenItem,resolveInitialValue}=this.props;this.setState({isResolvingInitialValue:true});const memberType=this.getMemberTypeOfItem(event.item);if(!memberType){throw new Error("Type \"".concat(event.item._type,"\" not valid for this array"));}const resolvedInitialValue=isEmpty$1(event.item)&&resolveInitialValue?resolveInitialValue(memberType,event.item):Promise.resolve({});resolvedInitialValue.then(initial=>_objectSpread(_objectSpread({},event.item),initial)).then(value=>{this.insert(value,event.position,event.referenceItem);},error=>{var _a;(_a=this.toast)==null?void 0:_a.push({title:"Could not resolve initial value",description:"Unable to resolve initial value for type: ".concat(memberType.name,": ").concat(error.message,"."),status:"error"});this.insert(event.item,event.position,event.referenceItem);}).finally(()=>{this.setState({isResolvingInitialValue:false});if(event.edit!==false){onOpenItem(this.props.path.concat([{_key:event.item._key}]));}onFocusPath([{_key:event.item._key}]);});};this.handleRemoveItem=item=>{this.removeItem(item);};this.handleSortEnd=event=>{const{value,onMoveItem}=this.props;const item=value==null?void 0:value[event.oldIndex];const refItem=value==null?void 0:value[event.newIndex];if(!(item==null?void 0:item._key)||!(refItem==null?void 0:refItem._key)){console.error("Neither the item you are moving nor the item you are moving to have a key. Cannot continue.");return;}if(event.oldIndex===event.newIndex||item._key===refItem._key){return;}onMoveItem({fromIndex:event.oldIndex,toIndex:event.newIndex});};this.setFocusArea=el=>{this._focusArea=el;};this.setToast=toast=>{this.toast=toast;};this.handleRemoveNonObjectValues=()=>{const{onChange,value}=this.props;const nonObjects=(value||[]).reduce((acc,val,i)=>isPlainObject(val)?acc:acc.concat(i),[]).reverse();const patches=nonObjects.map(index=>unset([index]));onChange(patches);};this.handleUpload=_ref370=>{let{file,type,uploader}=_ref370;const{onChange,client}=this.props;const item=createProtoValue(type);const key=item._key;this.insert(item,"after",-1);const events$=uploader.upload(client,file,type).pipe(map(uploadEvent=>PatchEvent.from(uploadEvent.patches||[]).prefixAll({_key:key})));this.uploadSubscriptions=_objectSpread(_objectSpread({},this.uploadSubscriptions),{},{[key]:events$.subscribe(event=>onChange(event.patches))});};this.renderItem=itemProps=>{var _a;if(!isObjectItemProps(itemProps)){throw new Error("Expected item to be of object type");}const{id,renderPreview,schemaType}=this.props;if(isReferenceSchemaType(itemProps.schemaType)){return itemProps.children;}const focused=itemProps.focused&&!itemProps.open;const typeTitle=getSchemaTypeTitle(itemProps.schemaType);return/* @__PURE__ */jsx(ArrayItem,{changed:itemProps.changed,validation:itemProps.validation,readOnly:itemProps.readOnly,onInsert:itemProps.onInsert,onRemove:itemProps.onRemove,onFocus:itemProps.onFocus,index:itemProps.index,schemaType:itemProps.schemaType,layout:(_a=schemaType.options)==null?void 0:_a.layout,insertableTypes:schemaType.of,value:itemProps.value,focused,open:itemProps.open,path:itemProps.path,onClick:itemProps.onOpen,presence:itemProps.presence,renderPreview,children:itemProps.open?/* @__PURE__ */jsx(Dialog,{width:1,header:"Edit ".concat(typeTitle),id:"".concat(id,"-item-").concat(itemProps.key,"-dialog"),onClose:itemProps.onClose,children:/* @__PURE__ */jsx(Box,{padding:4,children:itemProps.children})}):null});};}getMemberTypeOfItem(item){const{schemaType}=this.props;const itemTypeName=resolveTypeName$1(item);return schemaType.of.find(memberType=>memberType.name===itemTypeName);}removeItem(item){const{onChange,onFocusPath,value}=this.props;const patch=unset(isKeySegment(item)?[{_key:item._key}]:[(value==null?void 0:value.indexOf(item))||-1]);const result=applyAll(value||[],[patch]);if(Array.isArray(result)&&!result.length){onChange(unset());}else{onChange(patch);}if(item._key in this.uploadSubscriptions){this.uploadSubscriptions[item._key].unsubscribe();}const idx=(value==null?void 0:value.indexOf(item))||-1;const nearestSibling=(value==null?void 0:value[idx+1])||(value==null?void 0:value[idx-1]);onFocusPath(nearestSibling?[{_key:nearestSibling._key}]:[]);}focus(){if(this._focusArea){this._focusArea.focus();}}renderMember(member){const{renderField,renderInput,renderPreview}=this.props;if(member.kind==="item"){return/* @__PURE__ */jsx(ArrayOfObjectsItem,{member,renderItem:this.renderItem,renderField,renderInput,renderPreview});}if(member.kind==="error"){return/* @__PURE__ */jsx(MemberItemError,{member});}return/* @__PURE__ */jsxs(Fragment,{children:["Unknown member kind: $",member.kind]});}render(){const{schemaType,onChange,value=[],readOnly,members,elementProps,resolveUploader}=this.props;const{isResolvingInitialValue}=this.state;const hasNonObjectValues=(value||[]).some(item=>!isPlainObject(item));if(hasNonObjectValues){return/* @__PURE__ */jsxs(Alert,{status:"error",suffix:/* @__PURE__ */jsx(Stack,{padding:2,children:/* @__PURE__ */jsx(Button,{onClick:this.handleRemoveNonObjectValues,text:"Remove non-object values",tone:"critical"})}),title:/* @__PURE__ */jsx(Fragment,{children:"Invalid list values"}),children:[/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"Some items in this list are not objects. This must be fixed in order to edit the list."}),/* @__PURE__ */jsx(Details,{marginTop:4,open:isDev,title:/* @__PURE__ */jsx(Fragment,{children:"Developer info"}),children:/* @__PURE__ */jsx(Stack,{space:3,children:/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:"This usually happens when items are created using an API client, or when a custom input component has added invalid data to the list."})})})]});}const options=schemaType.options||{};const isSortable=options.sortable!==false;const isGrid=options.layout==="grid";return/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(UploadTarget,_objectSpread(_objectSpread({types:schemaType.of,resolveUploader,onUpload:this.handleUpload},elementProps),{},{tabIndex:0,children:/* @__PURE__ */jsxs(Stack,{"data-ui":"ArrayInput__content",space:3,children:[(members==null?void 0:members.length)===0&&/* @__PURE__ */jsx(Card,{padding:3,border:true,style:{borderStyle:"dashed"},radius:2,children:/* @__PURE__ */jsx(Text$1,{align:"center",muted:true,size:1,children:schemaType.placeholder||/* @__PURE__ */jsx(Fragment,{children:"No items"})})}),((members==null?void 0:members.length)>0||isResolvingInitialValue)&&/* @__PURE__ */jsx(Card,{border:true,radius:1,paddingY:isGrid?2:1,paddingX:isGrid?2:void 0,children:/* @__PURE__ */jsxs(List,{onSortEnd:this.handleSortEnd,isSortable,isGrid,children:[members.map((member,index)=>{return/* @__PURE__ */jsx(Item,{isSortable,isGrid,index,children:this.renderMember(member)},member.key);}),isResolvingInitialValue&&/* @__PURE__ */jsx(Item,{isGrid,index:-1,children:/* @__PURE__ */jsx(Card,{radius:1,padding:1,children:/* @__PURE__ */jsxs(Flex,{align:"center",justify:"center",padding:3,children:[/* @__PURE__ */jsx(Box,{marginX:3,children:/* @__PURE__ */jsx(Spinner,{muted:true})}),/* @__PURE__ */jsx(Text$1,{children:"Resolving initial value\u2026"})]})})})]})})]})})),/* @__PURE__ */jsx(DefaultArrayInputFunctions,{type:schemaType,value,readOnly,onAppendItem:this.handleAppend,onPrependItem:this.handlePrepend,onCreateValue:createProtoValue,onChange})]});}}function nearestIndexOf(array,startIdx,searchElement){return nearestIndex(array,startIdx,element=>element===searchElement);}function nearestIndex(array,startIdx,predicate){let lowerIdx=startIdx-1;let upperIdx=startIdx;const len=array.length;while(lowerIdx>-1||upperIdx<len){const upper=array[upperIdx];if(upperIdx<len&&predicate(upper,upperIdx)){return upperIdx;}const lower=array[lowerIdx];if(lowerIdx>-1&&predicate(lower,lowerIdx)){return lowerIdx;}lowerIdx--;upperIdx++;}return-1;}const dragHandle=/* @__PURE__ */jsx(DragHandle,{paddingX:1,paddingY:3});const ItemRow=React.forwardRef(function ItemRow2(props,ref){const{isSortable,value,index,onEscapeKey,onEnterKey,insertableTypes,onInsert,onRemove,readOnly,onFocus,validation,schemaType}=props;const hasError=validation.filter(item=>item.level==="error").length>0;const hasWarning=validation.filter(item=>item.level==="warning").length>0;const showValidationStatus=!readOnly&&validation.length>0&&!(schemaType==null?void 0:schemaType.title);const handleRemove=useCallback(()=>{onRemove();},[onRemove]);const handleInsert=useCallback((pos,insertType)=>{onInsert({position:pos,items:[getEmptyValue(insertType)]});},[onInsert]);const handleDuplicate=useCallback(()=>{if(value)onInsert({position:"after",items:[value]});},[onInsert,value]);useCallback(event=>{if(event.key==="Enter"){onEnterKey(index);}},[index,onEnterKey]);useCallback(event=>{if(event.shiftKey&&event.key==="Backspace"&&value===""){onRemove();}if(event.key==="Escape"){onEscapeKey(index);}},[index,onEscapeKey,onRemove,value]);const tone=useMemo(()=>{if(hasError){return"critical";}if(hasWarning){return"caution";}return void 0;},[hasError,hasWarning]);const id=useId();return/* @__PURE__ */jsx(Card,{tone,radius:2,paddingX:1,paddingY:2,children:/* @__PURE__ */jsxs(Flex,{align:schemaType?"flex-end":"center",ref,children:[schemaType?/* @__PURE__ */jsxs(Flex,{align:"flex-end",flex:1,children:[isSortable&&/* @__PURE__ */jsx(Box,{marginRight:1,children:dragHandle}),/* @__PURE__ */jsx(Box,{flex:1,marginRight:2,children:props.children})]}):/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(ItemWithMissingType,{value,onFocus})}),/* @__PURE__ */jsxs(Flex,{align:"center",marginLeft:2,children:[showValidationStatus&&/* @__PURE__ */jsx(Box,{marginRight:3,children:/* @__PURE__ */jsx(FormFieldValidationStatus,{validation})}),!readOnly&&/* @__PURE__ */jsx(Box,{paddingY:1,children:/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{padding:2,mode:"bleed",icon:EllipsisVerticalIcon}),id:"".concat(id,"-menuButton"),portal:true,popover:{portal:true,tone:"default"},menu:/* @__PURE__ */jsxs(Menu,{children:[/* @__PURE__ */jsx(MenuItem,{text:"Remove",tone:"critical",icon:TrashIcon,onClick:handleRemove}),/* @__PURE__ */jsx(MenuItem,{text:"Duplicate",icon:CopyIcon,onClick:handleDuplicate}),/* @__PURE__ */jsx(InsertMenu,{types:insertableTypes,onInsert:handleInsert})]})})})]})]})});});function ArrayOfPrimitivesFunctions(props){const{type,readOnly,children,onCreateValue,onAppendItem}=props;const menuButtonId=useId();const insertItem=React.useCallback(itemType=>{onAppendItem(onCreateValue(itemType));},[onCreateValue,onAppendItem]);const handleAddBtnClick=React.useCallback(()=>{insertItem(type.of[0]);},[type,insertItem]);const popoverProps=useMemo(()=>({constrainSize:true,portal:true}),[]);if(readOnly){return/* @__PURE__ */jsx(Tooltip,{portal:true,content:/* @__PURE__ */jsx(Box,{padding:2,sizing:"border",children:/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:"This field is read-only"})}),children:/* @__PURE__ */jsx(Grid,{children:/* @__PURE__ */jsx(Button,{icon:AddIcon,mode:"ghost",disabled:true,text:type.of.length===1?"Add item":"Add item..."})})});}return/* @__PURE__ */jsxs(Grid,{gap:1,style:{gridTemplateColumns:"repeat(auto-fit, minmax(100px, 1fr))"},children:[type.of.length===1?/* @__PURE__ */jsx(Button,{icon:AddIcon,mode:"ghost",onClick:handleAddBtnClick,text:"Add item"}):/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{icon:AddIcon,mode:"ghost",text:"Add item\u2026"}),id:menuButtonId||"",menu:/* @__PURE__ */jsx(Menu,{children:type.of.map((memberDef,i)=>{var _a,_b;const referenceIcon=isReferenceSchemaType(memberDef)&&(memberDef.to||[]).length===1&&memberDef.to[0].icon;const icon=memberDef.icon||((_a=memberDef.type)==null?void 0:_a.icon)||referenceIcon;return/* @__PURE__ */jsx(MenuItem,{text:memberDef.title||((_b=memberDef.type)==null?void 0:_b.name),onClick:()=>insertItem(memberDef),icon},i);})}),popover:popoverProps}),children]});}ArrayOfPrimitivesFunctions.__SANITY_INTERNAL_IMPLEMENTATION=true;class ArrayOfPrimitivesInput extends React.PureComponent{constructor(){super(...arguments);this._element=null;this._lastAddedIndex=-1;this.handleAppend=itemValue=>{const{value=[],onFocusIndex,onAppendItem}=this.props;onAppendItem(itemValue);onFocusIndex(value.length);};this.handlePrepend=itemValue=>{const{onFocusIndex,value=[],onPrependItem}=this.props;onPrependItem(itemValue);onFocusIndex(value.length);};this.handleItemEnterKey=index=>{const{schemaType,onInsert}=this.props;const firstType=schemaType==null?void 0:schemaType.of[0];if(firstType){onInsert({referenceIndex:index,position:"after",items:[getEmptyValue(firstType)]});this._lastAddedIndex=index+1;}};this.handleItemEscapeKey=index=>{const{value,onRemoveItem}=this.props;if(index===this._lastAddedIndex&&(value==null?void 0:value[index])===""){onRemoveItem(index);}};this.handleSortEnd=event=>{const{onFocusIndex,onMoveItem,value}=this.props;if(value)onMoveItem({fromIndex:event.oldIndex,toIndex:event.newIndex});onFocusIndex(event.newIndex);};this.setElement=el=>{this._element=el;};this.renderItem=props=>{const{schemaType,readOnly}=this.props;const isSortable=!readOnly&&get$2(schemaType,"options.sortable")!==false;return/* @__PURE__ */jsx(ItemRow,_objectSpread(_objectSpread({},props),{},{isSortable,insertableTypes:schemaType.of,onEnterKey:this.handleItemEnterKey,onEscapeKey:this.handleItemEscapeKey}));};}focus(){if(this._element){this._element.focus();}}getSnapshotBeforeUpdate(prevProps){var _a;const{focusPath:prevFocusPath=[],value:prevValue=[]}=prevProps;const{focusPath=[],value=[]}=this.props;if(prevFocusPath[0]===focusPath[0]&&prevValue.length!==value.length){const focusIndex=focusPath[0];const selection=window.getSelection();if(!((selection==null?void 0:selection.focusNode)instanceof HTMLElement)){return null;}const input=(_a=selection.focusNode)==null?void 0:_a.querySelector("input,textarea");return input instanceof HTMLInputElement?{prevFocusedIndex:focusIndex,restoreSelection:{text:selection.toString(),start:input.selectionStart,end:input.selectionEnd,value:input.value}}:{};}return null;}componentDidUpdate(prevProps,prevState,snapshot){var _a;const{onFocusIndex}=this.props;if((snapshot==null?void 0:snapshot.restoreSelection)&&prevProps.value){const prevFocusedValue=prevProps.value[snapshot.prevFocusedIndex];const nearestIndex=nearestIndexOf(this.props.value||[],snapshot.prevFocusedIndex,prevFocusedValue);if(nearestIndex===-1){return;}const newInput=(_a=this._element)==null?void 0:_a.querySelector("[data-item-index='".concat(nearestIndex,"'] input,textarea"));if(newInput instanceof HTMLInputElement){newInput.focus();try{newInput.setSelectionRange(snapshot.restoreSelection.start,snapshot.restoreSelection.end);}catch{}}onFocusIndex(nearestIndex);}}render(){const{schemaType,members,readOnly,value,onChange,renderInput}=this.props;const isSortable=!readOnly&&get$2(schemaType,"options.sortable")!==false;return/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(Stack,{space:1,children:members.length>0&&/* @__PURE__ */jsx(Card,{padding:1,border:true,children:/* @__PURE__ */jsx(List,{onSortEnd:this.handleSortEnd,isSortable,children:members.map((member,index)=>{if(member.kind==="item"){return/* @__PURE__ */jsx(Item,{index,"data-item-index":index,isSortable,children:/* @__PURE__ */jsx(ArrayOfPrimitivesItem,{member,renderInput,renderItem:this.renderItem})},member.key);}if(member.kind==="error"){return/* @__PURE__ */jsx(MemberItemError,{member},member.key);}return/* @__PURE__ */jsxs(Fragment,{children:["Unknown member kind: $",member.kind]});})})})}),/* @__PURE__ */jsx(ArrayOfPrimitivesFunctions,{type:schemaType,value,readOnly,onAppendItem:this.handleAppend,onPrependItem:this.handlePrepend,onCreateValue:getEmptyValue,onChange})]});}}function StudioArrayInput(props){const formBuilder=useFormBuilder();const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const supportsImageUploads=formBuilder.__internal.image.directUploads;const supportsFileUploads=formBuilder.__internal.file.directUploads;const resolveUploader$1=useCallback((type,file)=>{if(is("image",type)&&!supportsImageUploads){return null;}if(is("file",type)&&!supportsFileUploads){return null;}return resolveUploader(type,file);},[supportsFileUploads,supportsImageUploads]);const resolveInitialValue=useResolveInitialValueForType();return/* @__PURE__ */jsx(ArrayInput,_objectSpread(_objectSpread({},props),{},{resolveInitialValue,resolveUploader:resolveUploader$1,client}));}const StudioArrayOfPrimitivesInput=forwardRef(function StudioArrayOfPrimitivesInput2(props,ref){const formBuilder=useFormBuilder();return/* @__PURE__ */jsx(ArrayOfPrimitivesInput,_objectSpread(_objectSpread({},props),{},{ArrayFunctionsImpl:formBuilder.__internal.components.ArrayFunctions,ref}));});const PRIMITIVES=["string","number","boolean"];function isArrayOfPrimitives(type){return type.of.every(ofType=>PRIMITIVES.includes(ofType.jsonType));}function isStringArray(type){return type.of.length===1&&is("string",type.of[0]);}function isTagsArray(type){var _a;return((_a=type.options)==null?void 0:_a.layout)==="tags";}function isPortableText(type){return type.of.some(memberType=>is("block",memberType));}function hasOptionsList(type){var _a;return Boolean((_a=type.options)==null?void 0:_a.list);}function resolveArrayInput(type){if(isStringArray(type)&&isTagsArray(type)){return TagsArrayInput;}if(hasOptionsList(type)){return OptionsArrayInput;}if(isArrayOfPrimitives(type)){return StudioArrayOfPrimitivesInput;}if(isPortableText(type)){return PortableTextInput;}return StudioArrayInput;}function toSelectItem(option){return isTitledListValue(option)?option:{title:capitalize("".concat(option)),value:option};}const EMPTY_ITEM={title:"",value:void 0};function SelectInput(props){var _a,_b;const{value,readOnly,validationError,schemaType,onChange,path,changed,focused,elementProps}=props;const items=useMemo(()=>{var _a2;return(((_a2=schemaType.options)==null?void 0:_a2.list)||[]).map(toSelectItem);},[(_a=schemaType.options)==null?void 0:_a.list]);const currentItem=items.find(item=>item.value===value);const isRadio=schemaType.options&&schemaType.options.layout==="radio";const itemFromOptionValue=useCallback(optionValue=>{const index=Number(optionValue);return items[index];},[items]);const optionValueFromItem=useCallback(item=>{return String(items.indexOf(item));},[items]);const inputId=useId();const handleChange=React.useCallback(nextItem=>{onChange(PatchEvent.from(typeof(nextItem==null?void 0:nextItem.value)==="undefined"?unset():set(nextItem.value)));},[onChange]);const handleSelectChange=useCallback(event=>{const nextItem=itemFromOptionValue(event.currentTarget.value);if(!nextItem){handleChange(EMPTY_ITEM);return;}handleChange(nextItem);},[handleChange,itemFromOptionValue]);const content=isRadio?/* @__PURE__ */jsx(RadioSelect,_objectSpread(_objectSpread({},elementProps),{},{value:currentItem,inputId,items,direction:((_b=schemaType.options)==null?void 0:_b.direction)||"vertical",customValidity:validationError,onChange:handleChange})):/* @__PURE__ */jsx(Select,_objectSpread(_objectSpread({},elementProps),{},{customValidity:validationError,value:optionValueFromItem(currentItem),onChange:handleSelectChange,children:[EMPTY_ITEM,...items].map((item,i)=>/* @__PURE__ */jsx("option",{value:i-1,children:item.title},"".concat(i-1)))}));return/* @__PURE__ */jsx(ChangeIndicator,{path,isChanged:changed,hasFocus:!!focused,children:content});}const RadioSelect=forwardRef(function RadioSelect2(props,ref){const{items,value,onChange,onFocus,readOnly,customValidity,direction,inputId}=props;const Layout=direction==="horizontal"?Inline:Stack;return/* @__PURE__ */jsx(Card,{border:true,padding:3,radius:1,children:/* @__PURE__ */jsx(Layout,{space:3,role:"group",children:items.map((item,index)=>/* @__PURE__ */jsx(RadioSelectItem,{customValidity,inputId,item,onChange,onFocus,readOnly,ref:index===0?ref:null,value},index))})});});const RadioSelectItem=forwardRef(function RadioSelectItem2(props,ref){const{customValidity,inputId,item,onChange,onFocus,readOnly,value}=props;const handleChange=useCallback(()=>{onChange(item);},[item,onChange]);return/* @__PURE__ */jsxs(Flex,{as:"label",align:"center",children:[/* @__PURE__ */jsx(Radio,{ref,checked:value===item,onChange:handleChange,onFocus,readOnly,customValidity,name:inputId}),/* @__PURE__ */jsx(Box,{marginLeft:2,children:/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:item.title})})]});});function StringInput(props){const{validationError,elementProps}=props;return/* @__PURE__ */jsx(TextInput$1,_objectSpread(_objectSpread({},elementProps),{},{customValidity:validationError}));}function resolveStringInput(type){return getOption(type,"list")?SelectInput:StringInput;}const normalizeRules=(validation,type)=>{if(typeof validation==="function"){throw new Error("Schema type \"".concat((type==null?void 0:type.name)||"<not-found>","\"'s `validation` was not run though `inferFromSchema`"));}if(!validation)return[];if(Array.isArray(validation))return validation;return[validation];};function getValidationRule(type,ruleName){for(const rule of normalizeRules(type==null?void 0:type.validation,type)){for(const ruleSpec of rule._rules){if(ruleSpec.flag===ruleName){return ruleSpec;}}}return null;}function NumberInput(props){const{schemaType,validationError,value,elementProps}=props;const minRule=getValidationRule(schemaType,"min");const onlyPositiveNumber=((minRule==null?void 0:minRule.constraint)||0)>=0;return/* @__PURE__ */jsx(TextInput$1,_objectSpread(_objectSpread({},elementProps),{},{type:"number",step:"any",inputMode:onlyPositiveNumber?"numeric":"text",customValidity:validationError,value,placeholder:schemaType.placeholder,pattern:onlyPositiveNumber?"[d]*":void 0}));}function resolveNumberInput(type){return getOption(type,"list")?SelectInput:NumberInput;}const CenterAlignedBox=styled(Box)(_templateObject300||(_templateObject300=_taggedTemplateLiteral(["\n  align-self: center;\n"])));const ZeroLineHeightBox=styled(Box)(_templateObject301||(_templateObject301=_taggedTemplateLiteral(["\n  line-height: 0;\n"])));function BooleanInput(props){var _a;const{id,value,schemaType,readOnly,elementProps}=props;const layout=((_a=schemaType.options)==null?void 0:_a.layout)||"switch";const indeterminate=typeof value!=="boolean";const checked=value||false;const LayoutSpecificInput=layout==="checkbox"?Checkbox$1:Switch$1;return/* @__PURE__ */jsx(Card,{border:true,radius:1,children:/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(ZeroLineHeightBox,{padding:3,children:/* @__PURE__ */jsx(LayoutSpecificInput,_objectSpread(_objectSpread({label:schemaType.title},elementProps),{},{indeterminate,checked,style:{margin:-4},disabled:readOnly}))}),/* @__PURE__ */jsx(Box,{flex:1,paddingY:3,children:/* @__PURE__ */jsx(FormFieldHeaderText,{description:schemaType.description,inputId:id,title:schemaType.title})}),/* @__PURE__ */jsx(CenterAlignedBox,{paddingX:3,paddingY:1,children:/* @__PURE__ */jsx(FormFieldStatus,{maxAvatars:1,position:"top"})})]})});}function EmailInput(props){const{validationError,elementProps}=props;return/* @__PURE__ */jsx(TextInput$1,_objectSpread(_objectSpread({},elementProps),{},{type:"email",inputMode:"email",customValidity:validationError}));}function UnknownFields(props){const{fieldNames,onChange,readOnly,value}=props;const fieldsLen=fieldNames.length;const handleUnsetClick=useCallback(fieldName=>{onChange(unset([fieldName]));},[onChange]);return/* @__PURE__ */jsxs(Alert,{status:"warning",title:/* @__PURE__ */jsxs(Fragment,{children:[fieldsLen===1&&/* @__PURE__ */jsx(Fragment,{children:"Unknown field found"}),fieldsLen>1&&/* @__PURE__ */jsx(Fragment,{children:"Unknown fields found"})]}),children:[/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:fieldsLen===1?/* @__PURE__ */jsx(Fragment,{children:"Encountered a field that is not defined in the schema."}):/* @__PURE__ */jsxs(Fragment,{children:["Encountered ",fieldsLen," fields that are not defined in the schema."]})}),/* @__PURE__ */jsxs(Details,{marginTop:4,open:isDev,title:/* @__PURE__ */jsx(Fragment,{children:"Developer info"}),children:[/* @__PURE__ */jsx(Box,{marginBottom:3,children:/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:fieldsLen===1?/* @__PURE__ */jsx(Fragment,{children:"This field is not defined in the schema, which could mean that the field definition has been removed or that someone else has added it to their own local project and have not deployed their changes yet."}):/* @__PURE__ */jsx(Fragment,{children:"These fields are not defined in the document\u2019s schema, which could mean that the field definitions have been removed or that someone else has added them to their own local project and have not deployed their changes yet."})})}),/* @__PURE__ */jsx(Stack,{as:"ul",space:3,children:fieldNames.map(fieldName=>{return/* @__PURE__ */jsx(UnknownField,{fieldName,onUnsetClick:handleUnsetClick,readOnly,value:value==null?void 0:value[fieldName]},fieldName);})})]})]});}function UnknownField(_ref371){let{fieldName,onUnsetClick,readOnly,value}=_ref371;const handleUnsetClick=useCallback(()=>{onUnsetClick(fieldName);},[fieldName,onUnsetClick]);return/* @__PURE__ */jsx(Card,{as:"li",padding:3,radius:2,shadow:1,tone:"caution",children:/* @__PURE__ */jsxs(Stack,{space:2,children:[/* @__PURE__ */jsxs(Card,{border:true,radius:1,children:[/* @__PURE__ */jsx(Card,{borderBottom:true,padding:3,children:/* @__PURE__ */jsx(Code,{weight:"medium",children:fieldName})}),/* @__PURE__ */jsx(Box,{overflow:"auto",padding:3,children:/* @__PURE__ */jsx(Code,{language:"json",children:JSON.stringify(value,null,2)})})]}),readOnly&&/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["This field is ",/* @__PURE__ */jsx("strong",{children:"read only"})," according to the document\u2019s schema and cannot be unset. If you want to be able to unset this in Studio, make sure you remove the"," ",/* @__PURE__ */jsx("code",{children:"readOnly"})," field from the enclosing type in the schema."]}),!readOnly&&/* @__PURE__ */jsx(Button,{icon:TrashIcon,onClick:handleUnsetClick,tone:"critical",text:/* @__PURE__ */jsx(Fragment,{children:"Remove field"})})]})});}const FieldGroupTabsWrapper=styled(Card)(_templateObject302||(_templateObject302=_taggedTemplateLiteral(["\n  margin-bottom: ","px;\n  padding-bottom: ","px;\n"])),_ref372=>{let{$level,theme}=_ref372;return $level===0?0:theme.sanity.space[5]*-1;},_ref373=>{let{$level,theme}=_ref373;return $level===0?theme.sanity.space[4]:theme.sanity.space[4];});const GroupTab=forwardRef(function GroupTab2(props,ref){const{onClick}=props;const handleClick=React.useCallback(()=>{onClick==null?void 0:onClick(props.name);},[props.name,onClick]);return/* @__PURE__ */jsx(Tab,_objectSpread(_objectSpread({"data-testid":"group-tab-".concat(name),size:1,id:"".concat(props.name,"-tab"),label:props.title,ref},props),{},{onClick:handleClick}));});const GroupOption=props=>{const{name:name2,title}=props,rest=_objectWithoutProperties(props,_excluded93);const{selected}=props;return/* @__PURE__ */jsx("option",{title,value:name2,id:"".concat(name2,"-tab"),"aria-controls":rest["aria-controls"],"data-testid":"group-select-".concat(name2),"aria-selected":selected?"true":"false",children:title||name2});};const Root=styled(ElementQuery)(_templateObject303||(_templateObject303=_taggedTemplateLiteral(["\n  /* Hide on small screens */\n  &[data-eq-max~='0'] [data-ui='TabList'] {\n    display: none;\n  }\n\n  /* Hide on medium to large screens */\n  [data-ui='Select'] {\n    display: none;\n  }\n\n  /* Show on small screens */\n  &[data-eq-max~='0'] [data-ui='Select'] {\n    display: block;\n  }\n"])));const GroupTabs=_ref374=>{let{inputId,groups,onClick,shouldAutoFocus=true,disabled}=_ref374;return/* @__PURE__ */jsx(TabList,{space:2,"data-testid":"field-group-tabs",children:groups.map(group=>{return/* @__PURE__ */jsx(GroupTab,{"aria-controls":"".concat(inputId,"-field-group-fields"),autoFocus:shouldAutoFocus&&group.selected,disabled,icon:group==null?void 0:group.icon,name:group.name,onClick,selected:Boolean(group.selected),title:group.title||group.name},"".concat(inputId,"-").concat(group.name,"-tab"));}).filter(Boolean)});};const GroupSelect=_ref375=>{let{groups,inputId,onSelect,shouldAutoFocus=true,disabled}=_ref375;var _a;const handleSelect=useCallback(event=>{onSelect(event.currentTarget.value);},[onSelect]);return/* @__PURE__ */jsx(Select,{fontSize:2,onChange:handleSelect,muted:true,"data-testid":"field-group-select","aria-label":"Field groups",autoFocus:shouldAutoFocus,disabled,value:(_a=groups.find(g=>g.selected))==null?void 0:_a.name,children:groups.map(group=>{return/* @__PURE__ */jsx(GroupOption,{"aria-controls":"".concat(inputId,"-field-group-fields"),selected:Boolean(group.selected),disabled:group.disabled,name:group.name,title:group.title||group.name},"".concat(inputId,"-").concat(group.name,"-tab"));})});};const FieldGroupTabs=React.memo(function FieldGroupTabs2(_ref376){let{onClick,disabled=false}=_ref376,props=_objectWithoutProperties(_ref376,_excluded94);const handleClick=useCallback(groupName=>{onClick==null?void 0:onClick(groupName);},[onClick]);return/* @__PURE__ */jsxs(Root,{"data-testid":"field-group-root",children:[/* @__PURE__ */jsx(GroupTabs,_objectSpread(_objectSpread({},props),{},{disabled,onClick:handleClick})),/* @__PURE__ */jsx(GroupSelect,_objectSpread(_objectSpread({},props),{},{disabled,onSelect:handleClick}))]});});const ObjectInput=memo(function ObjectInput2(props){const{schemaType,groups,members,onChange,renderInput,renderField,renderItem,renderPreview,level,value,id,path,onFieldGroupSelect}=props;const{columns}=schemaType.options||{};const renderedUnknownFields=useMemo(()=>{if(!schemaType.fields){return null;}const knownFieldNames=schemaType.fields.map(field=>field.name);const unknownFields=Object.keys(value||{}).filter(key=>!key.startsWith("_")&&!knownFieldNames.includes(key));if(unknownFields.length===0){return null;}return/* @__PURE__ */jsx(UnknownFields,{fieldNames:unknownFields,value,onChange});},[onChange,schemaType.fields,value]);const renderObjectMembers=useCallback(()=>/* @__PURE__ */jsx(ObjectMembers,{members,renderInput,renderField,renderItem,renderPreview}),[members,renderField,renderInput,renderItem,renderPreview]);if(members.length===0){return null;}return/* @__PURE__ */jsxs(Stack,{space:5,children:[groups.length>0?/* @__PURE__ */jsx(FieldGroupTabsWrapper,{$level:level,"data-testid":"field-groups",children:/* @__PURE__ */jsx(FieldGroupTabs,{inputId:id,onClick:onFieldGroupSelect,groups,shouldAutoFocus:path.length===0})}):null,columns?/* @__PURE__ */jsx(Grid,{columns,gap:4,marginTop:1,children:renderObjectMembers()}):renderObjectMembers(),renderedUnknownFields]});});function CalendarDay(props){const{date,focused,isCurrentMonth,isToday,onSelect,selected}=props;const handleClick=useCallback(()=>{onSelect(date);},[date,onSelect]);return/* @__PURE__ */jsx("div",{"aria-selected":selected,"data-ui":"CalendarDay",children:/* @__PURE__ */jsx(Card,{"aria-label":date.toDateString(),"aria-pressed":selected,as:"button",__unstable_focusRing:true,"data-weekday":true,"data-focused":focused?"true":"",role:"button",tabIndex:-1,onClick:handleClick,padding:3,radius:2,selected,tone:isToday||selected?"primary":"default",children:/* @__PURE__ */jsx(Text$1,{muted:!selected&&!isCurrentMonth,style:{textAlign:"center"},weight:isCurrentMonth?"medium":"regular",children:date.getDate()})})});}const MONTH_NAMES=["January","February","March","April","May","June","July","August","September","October","November","December"];const WEEK_DAY_NAMES=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];const HOURS_24=range(0,24);const ARROW_KEYS=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];const TAIL_WEEKDAYS=[1,2,3,4,5,6];const getWeekStartsOfMonth=date=>{const firstDay=startOfMonth(date);return eachWeekOfInterval({start:firstDay,end:lastDayOfMonth(firstDay)});};const getWeekDaysFromWeekStarts=weekStarts=>{return weekStarts.map(weekStart=>[weekStart,...TAIL_WEEKDAYS.map(d=>addDays(weekStart,d))]);};const getWeeksOfMonth=date=>getWeekDaysFromWeekStarts(getWeekStartsOfMonth(date)).map(days=>({number:getWeek(days[0]),days}));function CalendarMonth(props){return/* @__PURE__ */jsx(Box,{"aria-hidden":props.hidden||false,"data-ui":"CalendarMonth",children:/* @__PURE__ */jsxs(Grid,{gap:1,style:{gridTemplateColumns:"repeat(7, minmax(44px, 46px))"},children:[WEEK_DAY_NAMES.map(weekday=>/* @__PURE__ */jsx(Box,{paddingY:2,children:/* @__PURE__ */jsx(Text$1,{size:1,weight:"medium",style:{textAlign:"center"},children:weekday})},weekday)),getWeeksOfMonth(props.date).map((week,weekIdx)=>week.days.map((date,dayIdx)=>{const focused=props.focused&&isSameDay(date,props.focused);const selected=props.selected&&isSameDay(date,props.selected);const isToday=isSameDay(date,new Date());const isCurrentMonth=props.focused&&isSameMonth(date,props.focused);return/* @__PURE__ */jsx(CalendarDay,{date,focused,isCurrentMonth,isToday,onSelect:props.onSelect,selected},"".concat(weekIdx,"-").concat(dayIdx));}))]})});}const features={dayPresets:false,timePresets:false};const LazyTextInput=React.forwardRef(function LazyTextInput2(_ref377,forwardedRef){let{onChange,onBlur,onKeyPress,value}=_ref377,rest=_objectWithoutProperties(_ref377,_excluded95);const[inputValue,setInputValue]=React.useState();const handleChange=React.useCallback(event=>{setInputValue(event.currentTarget.value);},[]);const checkEvent=React.useCallback(event=>{const currentValue=event.currentTarget.value;if(currentValue!=="".concat(value)){if(onChange){onChange(event);}}setInputValue(void 0);},[onChange,value]);const handleBlur=React.useCallback(e=>{checkEvent(e);if(onBlur){onBlur(e);}},[checkEvent,onBlur]);const handleKeyPress=React.useCallback(e=>{if(e.key==="Enter"){checkEvent(e);}if(onKeyPress){onKeyPress(e);}},[checkEvent,onKeyPress]);return/* @__PURE__ */jsx(TextInput$1,_objectSpread(_objectSpread({},rest),{},{"data-testid":"date-input",ref:forwardedRef,value:inputValue===void 0?value:inputValue,onChange:handleChange,onBlur:handleBlur,onKeyPress:handleKeyPress}));});const YearInput=_ref378=>{let{onChange}=_ref378,props=_objectWithoutProperties(_ref378,_excluded96);const handleChange=React.useCallback(event=>{const numericValue=parseInt(event.currentTarget.value,10);if(!isNaN(numericValue)){onChange(numericValue);}},[onChange]);return/* @__PURE__ */jsx(LazyTextInput,_objectSpread(_objectSpread({},props),{},{onChange:handleChange,inputMode:"numeric"}));};const PRESERVE_FOCUS_ELEMENT=/* @__PURE__ */jsx("span",{"data-preserve-focus":true,style:{overflow:"hidden",position:"absolute",outline:"none"},tabIndex:-1});const Calendar=forwardRef(function Calendar2(props,forwardedRef){const{selectTime,onFocusedDateChange,selectedDate=new Date(),focusedDate=selectedDate,timeStep=1,onSelect}=props,restProps=_objectWithoutProperties(props,_excluded97);const setFocusedDate=useCallback(date=>onFocusedDateChange(date),[onFocusedDateChange]);const setFocusedDateMonth=useCallback(month=>setFocusedDate(setDate(setMonth(focusedDate,month),1)),[focusedDate,setFocusedDate]);const handleFocusedMonthChange=useCallback(e=>setFocusedDateMonth(Number(e.currentTarget.value)),[setFocusedDateMonth]);const moveFocusedDate=useCallback(by=>setFocusedDate(addMonths(focusedDate,by)),[focusedDate,setFocusedDate]);const setFocusedDateYear=useCallback(year=>setFocusedDate(setYear(focusedDate,year)),[focusedDate,setFocusedDate]);const handleDateChange=useCallback(date=>{onSelect(setMinutes(setHours(date,selectedDate.getHours()),selectedDate.getMinutes()));},[onSelect,selectedDate]);const handleMinutesChange=useCallback(event=>{const m=Number(event.currentTarget.value);onSelect(setMinutes(selectedDate,m));},[onSelect,selectedDate]);const handleHoursChange=useCallback(event=>{const m=Number(event.currentTarget.value);onSelect(setHours(selectedDate,m));},[onSelect,selectedDate]);useCallback((hours,mins)=>{onSelect(setHours(setMinutes(selectedDate,mins),hours));},[onSelect,selectedDate]);const ref=useForwardedRef(forwardedRef);const focusCurrentWeekDay=useCallback(()=>{var _a,_b;(_b=(_a=ref.current)==null?void 0:_a.querySelector("[data-focused=\"true\"]"))==null?void 0:_b.focus();},[ref]);const handleKeyDown=useCallback(event=>{var _a,_b;if(!ARROW_KEYS.includes(event.key)){return;}event.preventDefault();if(event.target.hasAttribute("data-calendar-grid")){focusCurrentWeekDay();return;}if(event.key==="ArrowUp"){onFocusedDateChange(addDays(focusedDate,-7));}if(event.key==="ArrowDown"){onFocusedDateChange(addDays(focusedDate,7));}if(event.key==="ArrowLeft"){onFocusedDateChange(addDays(focusedDate,-1));}if(event.key==="ArrowRight"){onFocusedDateChange(addDays(focusedDate,1));}(_b=(_a=ref.current)==null?void 0:_a.querySelector("[data-preserve-focus]"))==null?void 0:_b.focus();},[ref,focusCurrentWeekDay,onFocusedDateChange,focusedDate]);useEffect(()=>{focusCurrentWeekDay();},[focusCurrentWeekDay]);useEffect(()=>{var _a;const currentFocusInCalendarGrid=(_a=document.activeElement)==null?void 0:_a.matches("[data-calendar-grid], [data-calendar-grid] [data-preserve-focus]");if(currentFocusInCalendarGrid){focusCurrentWeekDay();}},[ref,focusCurrentWeekDay,focusedDate]);useCallback(()=>handleDateChange(addDays(new Date(),-1)),[handleDateChange]);useCallback(()=>handleDateChange(new Date()),[handleDateChange]);useCallback(()=>handleDateChange(addDays(new Date(),1)),[handleDateChange]);const handleNowClick=useCallback(()=>onSelect(new Date()),[onSelect]);return/* @__PURE__ */jsxs(Box,_objectSpread(_objectSpread({"data-ui":"Calendar"},restProps),{},{ref,children:[/* @__PURE__ */jsxs(Box,{padding:2,children:[features.dayPresets,/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(CalendarMonthSelect,{moveFocusedDate,onChange:handleFocusedMonthChange,value:focusedDate==null?void 0:focusedDate.getMonth()})}),/* @__PURE__ */jsx(Box,{marginLeft:2,children:/* @__PURE__ */jsx(CalendarYearSelect,{moveFocusedDate,onChange:setFocusedDateYear,value:focusedDate.getFullYear()})})]}),/* @__PURE__ */jsxs(Box,{"data-calendar-grid":true,onKeyDown:handleKeyDown,marginTop:2,overflow:"hidden",tabIndex:0,children:[/* @__PURE__ */jsx(CalendarMonth,{date:focusedDate,focused:focusedDate,onSelect:handleDateChange,selected:selectedDate}),PRESERVE_FOCUS_ELEMENT]})]}),selectTime&&/* @__PURE__ */jsxs(Box,{padding:2,style:{borderTop:"1px solid var(--card-border-color)"},children:[/* @__PURE__ */jsxs(Flex,{align:"center",children:[/* @__PURE__ */jsxs(Flex,{align:"center",flex:1,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Select,{"aria-label":"Select hour",value:selectedDate==null?void 0:selectedDate.getHours(),onChange:handleHoursChange,children:HOURS_24.map(h=>/* @__PURE__ */jsx("option",{value:h,children:"".concat(h).padStart(2,"0")},h))})}),/* @__PURE__ */jsx(Box,{paddingX:1,children:/* @__PURE__ */jsx(Text$1,{children:":"})}),/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Select,{"aria-label":"Select minutes",value:selectedDate==null?void 0:selectedDate.getMinutes(),onChange:handleMinutesChange,children:range(0,60,timeStep).map(m=>/* @__PURE__ */jsx("option",{value:m,children:"".concat(m).padStart(2,"0")},m))})})]}),/* @__PURE__ */jsx(Box,{marginLeft:2,children:/* @__PURE__ */jsx(Button,{text:"Set to current time",mode:"bleed",onClick:handleNowClick})})]}),features.timePresets]})]}));});function CalendarMonthSelect(props){const{moveFocusedDate,onChange,value}=props;const handlePrevMonthClick=useCallback(()=>moveFocusedDate(-1),[moveFocusedDate]);const handleNextMonthClick=useCallback(()=>moveFocusedDate(1),[moveFocusedDate]);return/* @__PURE__ */jsxs(Flex,{flex:1,children:[/* @__PURE__ */jsx(Button,{"aria-label":"Go to previous month",onClick:handlePrevMonthClick,mode:"bleed",icon:ChevronLeftIcon,paddingX:2,radius:0}),/* @__PURE__ */jsx(Box,{flex:1,children:/* @__PURE__ */jsx(Select,{radius:0,value,onChange,children:MONTH_NAMES.map((m,i)=>/* @__PURE__ */jsx("option",{value:i,children:m},i))})}),/* @__PURE__ */jsx(Button,{"aria-label":"Go to next month",mode:"bleed",icon:ChevronRightIcon,onClick:handleNextMonthClick,paddingX:2,radius:0})]});}function CalendarYearSelect(props){const{moveFocusedDate,onChange,value}=props;const handlePrevYearClick=useCallback(()=>moveFocusedDate(-12),[moveFocusedDate]);const handleNextYearClick=useCallback(()=>moveFocusedDate(12),[moveFocusedDate]);return/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsx(Button,{"aria-label":"Previous year",onClick:handlePrevYearClick,mode:"bleed",icon:ChevronLeftIcon,paddingX:2,radius:0}),/* @__PURE__ */jsx(YearInput,{value,onChange,radius:0,style:{width:65}}),/* @__PURE__ */jsx(Button,{"aria-label":"Next year",onClick:handleNextYearClick,mode:"bleed",icon:ChevronRightIcon,paddingX:2,radius:0})]});}const DatePicker=React.forwardRef(function DatePicker2(props,ref){const{value=new Date(),onChange}=props,rest=_objectWithoutProperties(props,_excluded98);const[focusedDate,setFocusedDay]=React.useState();const handleSelect=React.useCallback(nextDate=>{onChange(nextDate);setFocusedDay(void 0);},[onChange]);return/* @__PURE__ */jsx(Calendar,_objectSpread(_objectSpread({},rest),{},{ref,selectedDate:value,onSelect:handleSelect,focusedDate:focusedDate||value,onFocusedDateChange:setFocusedDay}));});const DateTimeInput$1=forwardRef(function DateTimeInput2(props,ref){const{value,inputValue,onInputChange,onChange,selectTime,timeStep}=props,rest=_objectWithoutProperties(props,_excluded99);const[popoverRef,setPopoverRef]=useState(null);const forwardedRef=useForwardedRef(ref);const buttonRef=useRef(null);const[isPickerOpen,setPickerOpen]=useState(false);useClickOutside(()=>setPickerOpen(false),[popoverRef]);const handleDeactivation=useCallback(()=>{var _a,_b;(_a=forwardedRef.current)==null?void 0:_a.focus();(_b=forwardedRef.current)==null?void 0:_b.select();},[forwardedRef]);const handleKeyUp=useCallback(e=>{if(e.key==="Escape"){setPickerOpen(false);}},[]);const handleClick=useCallback(()=>setPickerOpen(true),[]);const suffix=/* @__PURE__ */jsx(Box,{padding:1,children:/* @__PURE__ */jsx(Button,{ref:buttonRef,icon:CalendarIcon,mode:"bleed",padding:2,onClick:handleClick,style:{display:"block"},"data-testid":"select-date-button"})});return/* @__PURE__ */jsx(LazyTextInput,_objectSpread(_objectSpread({ref:forwardedRef},rest),{},{value:inputValue,onChange:onInputChange,suffix:isPickerOpen?/* @__PURE__ */jsx(LayerProvider,{zOffset:1e3,children:/* @__PURE__ */jsx(Popover,{constrainSize:true,"data-testid":"date-input-dialog",portal:true,content:/* @__PURE__ */jsx(Box,{overflow:"auto",children:/* @__PURE__ */jsx(FocusLock,{onDeactivation:handleDeactivation,children:/* @__PURE__ */jsx(DatePicker,{selectTime,timeStep,onKeyUp:handleKeyUp,value,onChange})})}),open:true,placement:"bottom-end",ref:setPopoverRef,radius:2,children:suffix})}):suffix}));});const DEFAULT_PLACEHOLDER_TIME=new Date();const CommonDateTimeInput=React.forwardRef(function CommonDateTimeInput2(props,ref){const{id,deserialize,formatInputValue,onChange,parseInputValue,placeholder,readOnly,selectTime,serialize,timeStep,value}=props,restProps=_objectWithoutProperties(props,_excluded100);const[localValue,setLocalValue]=React.useState(null);useEffect(()=>{setLocalValue(null);},[value]);const handleDatePickerInputChange=React.useCallback(event=>{const nextInputValue=event.currentTarget.value;const result=nextInputValue===""?null:parseInputValue(nextInputValue);if(result===null){onChange(null);if(typeof value==="undefined"&&localValue){setLocalValue(null);}}else if(result.isValid){onChange(serialize(result.date));}else{setLocalValue(nextInputValue);}},[localValue,serialize,onChange,parseInputValue]);const handleDatePickerChange=React.useCallback(nextDate=>{onChange(nextDate?serialize(nextDate):null);},[serialize,onChange]);const forwardedRef=useForwardedRef(ref);const parseResult=localValue?parseInputValue(localValue):value?deserialize(value):null;const inputValue=localValue?localValue:(parseResult==null?void 0:parseResult.isValid)?formatInputValue(parseResult.date):value;return readOnly?/* @__PURE__ */jsx(TextInput$1,{value:inputValue,readOnly:true}):/* @__PURE__ */jsx(DateTimeInput$1,_objectSpread(_objectSpread({},restProps),{},{id,selectTime,timeStep,placeholder:placeholder||"e.g. ".concat(formatInputValue(DEFAULT_PLACEHOLDER_TIME)),ref:forwardedRef,value:parseResult==null?void 0:parseResult.date,inputValue:inputValue||"",readOnly:Boolean(readOnly),onInputChange:handleDatePickerInputChange,onChange:handleDatePickerChange,customValidity:parseResult==null?void 0:parseResult.error}));});function isValidDate(date){return date instanceof Date&&!isNaN(date.valueOf());}const DEFAULT_DATE_FORMAT$1="YYYY-MM-DD";const DEFAULT_TIME_FORMAT="HH:mm";function parseOptions$1(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return{dateFormat:options.dateFormat||DEFAULT_DATE_FORMAT$1,timeFormat:options.timeFormat||DEFAULT_TIME_FORMAT,timeStep:"timeStep"in options&&Number(options.timeStep)||1,calendarTodayLabel:options.calendarTodayLabel||"Today"};}function serialize$1(date){return date.toISOString();}function deserialize$1(isoString){const deserialized=new Date(isoString);if(isValidDate(deserialized)){return{isValid:true,date:deserialized};}return{isValid:false,error:"Invalid date value: \"".concat(isoString,"\"")};}function enforceTimeStep(dateString,timeStep){if(!timeStep||timeStep===1){return dateString;}const date=parseISO(dateString);const minutes=getMinutes(date);const leftOver=minutes%timeStep;if(leftOver!==0){return serialize$1(setMinutes(date,minutes-leftOver));}return serialize$1(date);}function DateTimeInput(props){const{onChange,schemaType,value,elementProps}=props;const{dateFormat,timeFormat,timeStep}=parseOptions$1(schemaType.options);const handleChange=useCallback(nextDate=>{let date=nextDate;if(date!==null&&timeStep>1){date=enforceTimeStep(date,timeStep);}onChange(date===null?unset():set(date));},[onChange,timeStep]);const formatInputValue=React.useCallback(date=>format$1(date,"".concat(dateFormat," ").concat(timeFormat)),[dateFormat,timeFormat]);const parseInputValue=React.useCallback(inputValue=>parse$1(inputValue,"".concat(dateFormat," ").concat(timeFormat)),[dateFormat,timeFormat]);return/* @__PURE__ */jsx(CommonDateTimeInput,_objectSpread(_objectSpread({},elementProps),{},{onChange:handleChange,deserialize:deserialize$1,formatInputValue,parseInputValue,placeholder:schemaType.placeholder,selectTime:true,serialize:serialize$1,timeStep,value}));}const VALUE_FORMAT="YYYY-MM-DD";const DEFAULT_DATE_FORMAT=VALUE_FORMAT;function parseOptions(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return{dateFormat:options.dateFormat||DEFAULT_DATE_FORMAT,calendarTodayLabel:options.calendarTodayLabel||"Today"};}const deserialize=value=>parse$1(value,VALUE_FORMAT);const serialize=date=>format$1(date,VALUE_FORMAT);function DateInput(props){const{readOnly,onChange,schemaType,elementProps,value}=props;const{dateFormat}=parseOptions(schemaType.options);const handleChange=useCallback(nextDate=>{onChange(nextDate===null?unset():set(nextDate));},[onChange]);const formatInputValue=useCallback(date=>format$1(date,dateFormat),[dateFormat]);const parseInputValue=useCallback(inputValue=>parse$1(inputValue,dateFormat),[dateFormat]);return/* @__PURE__ */jsx(CommonDateTimeInput,_objectSpread(_objectSpread({},elementProps),{},{deserialize,formatInputValue,onChange:handleChange,parseInputValue,placeholder:schemaType.placeholder,readOnly,selectTime:false,serialize,value}));}const StyledTextArea=styled(TextArea)(_templateObject304||(_templateObject304=_taggedTemplateLiteral(["\n  &[data-as='textarea'] {\n    resize: vertical;\n  }\n"])));function TextInput(props){const{schemaType,validationError,value,elementProps}=props;return/* @__PURE__ */jsx(StyledTextArea,_objectSpread({customValidity:validationError,value:value||"",placeholder:schemaType.placeholder,rows:typeof schemaType.rows==="number"?schemaType.rows:10},elementProps));}function UrlInput(props){var _a,_b;const{schemaType,validationError,elementProps}=props;const uriRule=getValidationRule(schemaType,"uri");const inputType=((_b=(_a=uriRule==null?void 0:uriRule.constraint)==null?void 0:_a.options)==null?void 0:_b.allowRelative)?"text":"url";return/* @__PURE__ */jsx(TextInput$1,_objectSpread({type:inputType,inputMode:"url",customValidity:validationError},elementProps));}const defaultSlugify=(value,type)=>{var _a;const maxLength=(_a=type.options)==null?void 0:_a.maxLength;const slugifyOpts={truncate:typeof maxLength==="number"?maxLength:200,symbols:true};return value?speakingurl(value,slugifyOpts):"";};function slugify(sourceValue,type){var _a;if(!sourceValue){return Promise.resolve(sourceValue);}const slugifier=((_a=type.options)==null?void 0:_a.slugify)||defaultSlugify;return Promise.resolve(slugifier(sourceValue,type));}function useAsync(fn,dependencies){const[state,setState]=React.useState(null);const lastId=React.useRef(0);const wrappedCallback=React.useCallback(arg=>{const asyncId=++lastId.current;setState({status:"pending"});Promise.resolve().then(()=>fn(arg)).then(res=>{if(asyncId===lastId.current){setState({status:"complete",result:res});}},err=>{if(asyncId===lastId.current){setState({status:"error",error:err});}});},[fn,...dependencies]);return[state,wrappedCallback];}function getNewFromSource(source,valuePath,document2){const parentPath=valuePath.slice(0,-1);const parent=PathUtils.get(document2,parentPath);return Promise.resolve(typeof source==="function"?source(document2,{parentPath,parent}):PathUtils.get(document2,source));}function SlugInput(props){var _a;const{getDocument}=useFormBuilder().__internal;const{path,value,schemaType,validation,onChange,onFocusPath,readOnly,elementProps}=props;const sourceField=(_a=schemaType.options)==null?void 0:_a.source;const errors=useMemo(()=>validation.filter(item=>item.level==="error"),[validation]);const updateSlug=useCallback(nextSlug=>{if(!nextSlug){onChange(PatchEvent.from(unset([])));return;}onChange(PatchEvent.from([setIfMissing({_type:schemaType.name}),set(nextSlug,["current"])]));},[onChange,schemaType.name]);const[generateState,handleGenerateSlug]=useAsync(()=>{if(!sourceField){return Promise.reject(new Error("Source is missing. Check source on type \"".concat(schemaType.name,"\" in schema")));}return getNewFromSource(sourceField,path,getDocument()||{_type:schemaType.name}).then(newFromSource=>slugify(newFromSource||"",schemaType)).then(newSlug=>updateSlug(newSlug));},[path,updateSlug,document,schemaType]);const isUpdating=(generateState==null?void 0:generateState.status)==="pending";const handleChange=React.useCallback(event=>updateSlug(event.currentTarget.value),[updateSlug]);return/* @__PURE__ */jsx(Stack,{space:3,children:/* @__PURE__ */jsxs(Flex,{children:[/* @__PURE__ */jsxs(Box,{flex:1,children:[/* @__PURE__ */jsx(TextInput$1,_objectSpread({customValidity:errors.length>0?errors[0].message:"",disabled:isUpdating,onChange:handleChange,value:(value==null?void 0:value.current)||"",readOnly},elementProps)),(generateState==null?void 0:generateState.status)==="error"&&/* @__PURE__ */jsx(Card,{padding:2,tone:"critical",children:generateState.error.message})]}),sourceField&&/* @__PURE__ */jsx(Box,{marginLeft:1,children:/* @__PURE__ */jsx(Button,{mode:"ghost",type:"button",disabled:readOnly||isUpdating,onClick:handleGenerateSlug,text:(generateState==null?void 0:generateState.status)==="pending"?"Generating\u2026":"Generate"})})]})});}const FileButton$1=styled(Button).attrs({forwardedAs:"label"})(_ref379=>{let{theme}=_ref379;const{focusRing}=theme.sanity;const base=theme.sanity.color.base;const border={width:1,color:"var(--card-border-color)"};return css(_templateObject305||(_templateObject305=_taggedTemplateLiteral(["\n      &:not([data-disabled='true']) {\n        &:focus-within {\n          box-shadow: ",";\n        }\n      }\n\n      & input {\n        overflow: hidden;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        position: absolute;\n        min-width: 0;\n        display: block;\n        appearance: none;\n        padding: 0;\n        margin: 0;\n        border: 0;\n        opacity: 0;\n      }\n    "])),focusRingStyle$1({base,border,focusRing}));});const FileInputButton=React.forwardRef(function FileInputButton2(props,forwardedRef){const{icon,id:idProp,accept,capture,fontSize,multiple,onSelect,padding=3,space=3,textAlign,text,disabled}=props,rest=_objectWithoutProperties(props,_excluded101);const id=useId(idProp);const theme=useTheme$1();const handleChange=React.useCallback(event=>{if(onSelect&&event.target.files){onSelect(Array.from(event.target.files));}},[onSelect]);const content=/* @__PURE__ */jsxs(Flex,{align:"center",justify:"center",padding,children:[icon&&/* @__PURE__ */jsx(Box,{marginRight:text?space:void 0,children:/* @__PURE__ */jsxs(Text$1,{size:fontSize,children:[isValidElement(icon)&&icon,isValidElementType(icon)&&createElement(icon)]})}),text&&/* @__PURE__ */jsx(Text$1,{align:textAlign,size:fontSize,textOverflow:"ellipsis",weight:theme.sanity.button.textWeight,children:text})]});return/* @__PURE__ */jsxs(FileButton$1,_objectSpread(_objectSpread({},rest),{},{htmlFor:id,padding:0,fontSize:2,disabled,children:[content,/* @__PURE__ */jsx("input",{"data-testid":"file-button-input",accept,capture,id,multiple,onChange:handleChange,ref:forwardedRef,type:"file",value:"",disabled})]}));});const RootFlex=styled(Flex)(_templateObject306||(_templateObject306=_taggedTemplateLiteral(["\n  pointer-events: none;\n"])));function PlaceholderText(props){const{hoveringFiles,type,readOnly,acceptedFiles,rejectedFilesCount,directUploads}=props;const isFileType=type==="file";const messageIcon=useMemo(()=>{if(readOnly){return/* @__PURE__ */jsx(ReadOnlyIcon,{});}if(hoveringFiles&&rejectedFilesCount>0||!directUploads){return/* @__PURE__ */jsx(AccessDeniedIcon,{});}return isFileType?/* @__PURE__ */jsx(BinaryDocumentIcon,{}):/* @__PURE__ */jsx(ImageIcon,{});},[directUploads,hoveringFiles,isFileType,readOnly,rejectedFilesCount]);const messageText=useMemo(()=>{let message="Drag or paste ".concat(type," here");if(!directUploads){return"Can't upload files here";}if(readOnly){message="Read only";}if(hoveringFiles&&directUploads&&!readOnly){if(acceptedFiles.length>0){message="Drop to upload ".concat(type);}if(rejectedFilesCount>0){message="Can't upload ".concat(rejectedFilesCount," file").concat(rejectedFilesCount>1?"s":""," here");}}return message;},[acceptedFiles.length,directUploads,hoveringFiles,readOnly,rejectedFilesCount,type]);return/* @__PURE__ */jsxs(RootFlex,{align:"center",gap:2,justify:"center",children:[/* @__PURE__ */jsx(Text$1,{muted:true,children:messageIcon}),/* @__PURE__ */jsx(Text$1,{size:1,muted:true,children:messageText})]});}const UploadPlaceholder=React.memo(function UploadPlaceholder2(_ref380){let{browse,onUpload,readOnly,type,hoveringFiles,acceptedFiles,rejectedFilesCount,accept,directUploads}=_ref380;return/* @__PURE__ */jsxs(Flex,{align:"center",justify:"space-between",gap:4,direction:["column","column","row"],paddingY:[2,2,0],children:[/* @__PURE__ */jsx(Flex,{align:"center",justify:"center",gap:2,flex:1,children:/* @__PURE__ */jsx(PlaceholderText,{readOnly,hoveringFiles,acceptedFiles,rejectedFilesCount,type,directUploads})}),/* @__PURE__ */jsxs(Inline,{space:2,children:[/* @__PURE__ */jsx(FileInputButton,{icon:UploadIcon,mode:"ghost",onSelect:onUpload,accept,text:"Upload","data-testid":"file-input-upload-button",disabled:readOnly||!directUploads}),browse]})]});});function WithReferencedAsset(props){const{reference,children,observeAsset,waitPlaceholder}=props;const documentId=reference==null?void 0:reference._ref;const asset=useMemoObservable(()=>observeAsset(documentId),[documentId]);return/* @__PURE__ */jsx(Fragment,{children:documentId&&asset?children(asset):waitPlaceholder});}const FileTarget=fileTarget(withFocusRing(Card));const CardWrapper=styled(Card)(_templateObject307||(_templateObject307=_taggedTemplateLiteral(["\n  min-height: 82px;\n  box-sizing: border-box;\n"])));const FlexWrapper=styled(Flex)(_templateObject308||(_templateObject308=_taggedTemplateLiteral(["\n  text-overflow: ellipsis;\n  overflow: hidden;\n"])));const LeftSection=styled(Stack)(_templateObject309||(_templateObject309=_taggedTemplateLiteral(["\n  position: relative;\n  width: 60%;\n"])));const CodeWrapper=styled(Code)(_templateObject310||(_templateObject310=_taggedTemplateLiteral(["\n  position: relative;\n  width: 100%;\n\n  code {\n    overflow: hidden;\n    text-overflow: ellipsis;\n    position: relative;\n    max-width: 200px;\n  }\n"])));const STALE_UPLOAD_MS=1e3*60*2;const elapsedMs=date=>new Date().getTime()-new Date(date).getTime();function UploadProgress(_ref381){let{uploadState,onCancel,onStale,height}=_ref381;const filename=uploadState.file.name;useEffect(()=>{if(elapsedMs(uploadState.updated)>STALE_UPLOAD_MS){onStale==null?void 0:onStale();}},[uploadState.updated,onStale]);return/* @__PURE__ */jsx(CardWrapper,{tone:"primary",padding:4,border:true,style:{height:"".concat(height,"px")},children:/* @__PURE__ */jsxs(FlexWrapper,{align:"center",justify:"space-between",height:"fill",direction:"row",gap:2,children:[/* @__PURE__ */jsxs(LeftSection,{children:[/* @__PURE__ */jsx(Flex,{justify:"center",gap:[3,3,2,2],direction:["column","column","row"],children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsxs(Inline,{space:2,children:["Uploading",/* @__PURE__ */jsx(CodeWrapper,{size:1,children:filename?filename:"..."})]})})}),/* @__PURE__ */jsx(Card,{marginTop:3,radius:5,shadow:1,children:/* @__PURE__ */jsx(LinearProgress,{value:uploadState.progress})})]}),onCancel?/* @__PURE__ */jsx(Button,{fontSize:2,text:"Cancel upload",mode:"ghost",tone:"critical",onClick:onCancel}):null]})});}function urlToFile(url,filename){return new Promise((resolve,reject)=>{const xhr=new XMLHttpRequest();xhr.onload=()=>{const reader=new FileReader();reader.onloadend=()=>{var _a;const string=(_a=reader.result)==null?void 0:_a.toString();const ext=string==null?void 0:string.substring("data:image/".length,string.indexOf(";base64"));if(!ext&&!filename){reject(new Error("Could not find mime type for image"));return;}resolve(dataURLtoFile(reader.result,filename||"".concat(uuid(),".").concat(ext)));};reader.readAsDataURL(xhr.response);};xhr.onerror=error=>{reject(error);};xhr.open("GET",url);xhr.responseType="blob";xhr.send();});}function base64ToFile(base64Data,filename){return new Promise((resolve,reject)=>{const string=base64Data.toString();const ext=string.substring("data:image/".length,string.indexOf(";base64"));if(!ext&&!filename){reject(new Error("Could not find mime type for image"));return;}resolve(dataURLtoFile(base64Data,filename||"".concat(uuid(),".").concat(ext)));});}function dataURLtoFile(dataurl,filename){var _a;const arr=dataurl.split(",");const mime=(_a=arr[0].match(/:(.*?);/))==null?void 0:_a[1];const bstr=atob(arr[1]);let n=bstr.length;const u8arr=new Uint8Array(n);while(n--){u8arr[n]=bstr.charCodeAt(n);}return new File([u8arr],filename,{type:mime});}function handleSelectAssetFromSource(_ref382){let{assetFromSource,onChange,type,resolveUploader,uploadWith,isImage}=_ref382;if(!assetFromSource){throw new Error("No asset given");}if(!Array.isArray(assetFromSource)||assetFromSource.length===0){throw new Error("Returned value must be an array with at least one item (asset)");}const firstAsset=assetFromSource[0];const originalFilename=get$2(firstAsset,"assetDocumentProps.originalFilename");const label=get$2(firstAsset,"assetDocumentProps.label");const title=get$2(firstAsset,"assetDocumentProps.title");const description=get$2(firstAsset,"assetDocumentProps.description");const creditLine=get$2(firstAsset,"assetDocumentProps.creditLine");const source=get$2(firstAsset,"assetDocumentProps.source");const imagePatches=isImage?[unset(["hotspot"]),unset(["crop"])]:[];switch(firstAsset.kind){case"assetDocumentId":onChange([setIfMissing({_type:type.name}),...imagePatches,set({_type:"reference",_ref:firstAsset.value},["asset"])]);break;case"file":{const uploader=resolveUploader(type,firstAsset.value);if(uploader){uploadWith(uploader,firstAsset.value,{label,title,description,creditLine,source});}break;}case"base64":base64ToFile(firstAsset.value,originalFilename).then(file=>{const uploader=resolveUploader(type,file);if(uploader){uploadWith(uploader,file,{label,title,description,creditLine,source});}});break;case"url":urlToFile(firstAsset.value,originalFilename).then(file=>{const uploader=resolveUploader(type,file);if(uploader){uploadWith(uploader,file,{label,title,description,creditLine,source});}});break;default:{throw new Error("Invalid value returned from asset source plugin");}}}const FileButton=styled(MenuItem)(_ref383=>{let{theme}=_ref383;const{focusRing}=theme.sanity;const base=theme.sanity.color.base;const border={width:1,color:"var(--card-border-color)"};return css(_templateObject311||(_templateObject311=_taggedTemplateLiteral(["\n    position: relative;\n\n    &:not([data-disabled='true']) {\n      &:focus-within {\n        box-shadow: ",";\n      }\n    }\n\n    & input {\n      overflow: hidden;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      position: absolute;\n      min-width: 0;\n      display: block;\n      appearance: none;\n      padding: 0;\n      margin: 0;\n      border: 0;\n      opacity: 0;\n    }\n  "])),focusRingStyle$1({base,border,focusRing}));});const FileInputMenuItem=React.forwardRef(function FileInputMenuItem2(props,forwardedRef){const{icon,id:idProp,accept,capture,fontSize,multiple,onSelect,padding=3,space=3,textAlign,text,disabled}=props,rest=_objectWithoutProperties(props,_excluded102);const id=useId(idProp);const handleChange=React.useCallback(event=>{if(onSelect&&event.target.files){onSelect(Array.from(event.target.files));}},[onSelect]);const content=/* @__PURE__ */jsxs(Flex,{align:"center",justify:"flex-start",padding,children:[icon&&/* @__PURE__ */jsx(Box,{marginRight:text?space:void 0,children:/* @__PURE__ */jsxs(Text$1,{size:fontSize,children:[isValidElement(icon)&&icon,isValidElementType(icon)&&createElement(icon)]})}),text&&/* @__PURE__ */jsx(Text$1,{align:textAlign,size:fontSize,textOverflow:"ellipsis",children:text})]});return/* @__PURE__ */jsxs(FileButton,_objectSpread(_objectSpread({},rest),{},{htmlFor:id,padding:0,fontSize:2,disabled,ref:forwardedRef,children:[content,/* @__PURE__ */jsx("input",{"data-testid":"file-button-input",accept,capture,id,multiple,onChange:handleChange,type:"file",value:"",disabled})]}));});function ActionsMenu(props){const{onUpload,onReset,readOnly,accept,directUploads,browse,downloadUrl,copyUrl}=props;const{push:pushToast}=useToast();const handleCopyURL=useCallback(()=>{navigator.clipboard.writeText(copyUrl||"");pushToast({closable:true,status:"success",title:"The url is copied to the clipboard"});},[pushToast,copyUrl]);return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Label,{muted:true,size:1,children:"Replace"})}),/* @__PURE__ */jsx(FileInputMenuItem,{icon:UploadIcon,mode:"bleed",onSelect:onUpload,accept,text:"Upload","data-testid":"file-input-upload-button",disabled:readOnly||!directUploads,fontSize:2}),browse,(downloadUrl||copyUrl)&&/* @__PURE__ */jsx(MenuDivider,{}),downloadUrl&&/* @__PURE__ */jsx(MenuItem,{as:"a",icon:DownloadIcon,text:"Download",href:downloadUrl}),copyUrl&&/* @__PURE__ */jsx(MenuItem,{icon:ClipboardIcon,text:"Copy URL",onClick:handleCopyURL}),/* @__PURE__ */jsx(MenuDivider,{}),/* @__PURE__ */jsx(MenuItem,{tone:"critical",icon:ResetIcon,text:"Clear field",onClick:onReset,disabled:readOnly,"data-testid":"file-input-clear"})]});}const ButtonWrapper$2=styled(Button)(_templateObject312||(_templateObject312=_taggedTemplateLiteral(["\n  width: 100%;\n"])));function UploadWarning(_ref384){let{onClearStale}=_ref384;return/* @__PURE__ */jsxs(Card,{tone:"caution",padding:4,border:true,radius:2,children:[/* @__PURE__ */jsxs(Flex,{gap:4,marginBottom:4,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(WarningOutlineIcon,{})})}),/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:"Incomplete upload"}),/* @__PURE__ */jsx(Text$1,{size:1,children:"An upload has made no progress in the last 6m and likely got interrupted. You can safely clear the incomplete upload and try uploading again."})]})]}),/* @__PURE__ */jsx(ButtonWrapper$2,{icon:ResetIcon,text:"Clear upload",onClick:onClearStale,mode:"ghost"})]});}const RatioBox$1=styled(Box)(_templateObject313||(_templateObject313=_taggedTemplateLiteral(["\n  position: relative;\n  padding-bottom: calc("," * 100%);\n\n  & > div {\n    position: absolute;\n    top: ","px;\n    left: ","px;\n    right: ","px;\n    bottom: ","px;\n  }\n"])),_ref385=>{let{ratio=3/2}=_ref385;return 1/ratio;},_ref386=>{let{padding=0}=_ref386;return padding;},_ref387=>{let{padding=0}=_ref387;return padding;},_ref388=>{let{padding=0}=_ref388;return padding;},_ref389=>{let{padding=0}=_ref389;return padding;});class ImageLoader extends React.Component{constructor(){super(...arguments);this.state={isLoading:true,image:null,error:null};}UNSAFE_componentWillMount(){this.loadImage(this.props.src);}loadImage(src){const image=new Image();this.setState({image:null,error:null});image.onload=()=>{this.setState({image,error:null,isLoading:false});};image.onerror=()=>{this.setState({error:new Error("Could not load image from ".concat(JSON.stringify(this.props.src))),isLoading:false});};image.referrerPolicy="strict-origin-when-cross-origin";image.src=src;}UNSAFE_componentWillReceiveProps(nextProps){if(nextProps.src!==this.props.src){this.loadImage(nextProps.src);}}render(){const{error,image,isLoading}=this.state;return this.props.children({image,error,isLoading});}}const testProperties=["","webkit","moz","ms","o"].map(prefix=>"".concat(prefix,"backingStoreRatio"));let foundProperty=-1;function getBackingStoreRatio(context){if(foundProperty===-1){foundProperty=testProperties.find(testProperty=>testProperty in context);}return foundProperty&&context[foundProperty];}function isPointInEllipse(point,ellipse){const center={x:ellipse.center.x,y:ellipse.center.y};const xradius=ellipse.width/2;const yradius=ellipse.height/2;if(xradius<=0||yradius<=0){return false;}const normalized={x:point.x-center.x,y:point.y-center.y};return Math.pow(normalized.x,2)/Math.pow(xradius,2)+Math.pow(normalized.y,2)/Math.pow(yradius,2)<=1;}function isPointInCircle(_ref390,circle){let{x,y}=_ref390;return Math.pow(x-circle.x,2)+Math.pow(y-circle.y,2)<Math.pow(circle.radius,2);}function isPointInRect(point,rect){return point.x>=rect.left&&point.x<=rect.left+rect.width&&point.y>=rect.top&&point.y<=rect.top+rect.height;}function getPointAtCircumference(radians,ellipse){return{x:ellipse.center.x-ellipse.width/2*Math.cos(radians),y:ellipse.center.y-ellipse.height/2*Math.sin(radians)};}class Point{constructor(x,y){this.x=x;this.y=y;}}class HLine{constructor(y,left,right){this.y=y;this._left=left;this._right=right;}get right(){return new Point(this._right,this.y);}get left(){return new Point(this._left,this.y);}get length(){return this._right-this._left;}}class Corners{constructor(rect){this.rect=rect;}get top(){return new HLine(this.rect.top,this.rect.left,this.rect.right);}get bottom(){return new HLine(this.rect.bottom,this.rect.left,this.rect.right);}}class Rect{static fromEdges(_ref391){let{left,right,top,bottom}=_ref391;return new Rect(left,top,1-left-right,1-top-bottom);}constructor(){let left=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;let top=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;let width=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;let height=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;this.left=left;this.top=top;this.width=width;this.height=height;}setTopLeft(left,top){return new Rect(left,top,this.width||0,this.height||0);}setSize(width,height){return new Rect(this.left||0,this.top||0,width,height);}setCenter(x,y){const width=this.width||0;const height=this.height||0;return new Rect(x-width/2,y-height/2,width||0,height||0);}get center(){return new Point(this.left+this.width/2,this.top+this.height/2);}get corners(){return new Corners(this);}get right(){return this.left+this.width;}get bottom(){return this.top+this.height;}multiply(rect){return new Rect((this.left||0)+this.width*rect.left,(this.top||0)+this.height*rect.top,this.width*rect.width,this.height*rect.height);}grow(delta){return new Rect(this.left-delta,this.top-delta,this.width+delta*2,this.height+delta*2);}shrink(delta){return this.grow(-delta);}cropRelative(crop){const top=this.top+crop.top*this.height;const left=this.left+crop.left*this.width;const height=this.height*crop.height;const width=this.width*crop.width;return new Rect(left,top,width,height);}clamp(bounds){let{left,top,width,height}=this;if(bounds.width<width){width=bounds.width;left=bounds.left;}if(bounds.height<height){height=bounds.height;top=bounds.top;}if(left+width>bounds.left+bounds.width){left=bounds.right-width;}if(top+height>bounds.top+bounds.height){top=bounds.bottom-height;}return new Rect(Math.max(left,bounds.left),Math.max(top,bounds.top),width,height);}}const debug$1=Debug("sanity-imagetool");const supportsTouch=typeof window!=="undefined"&&"ontouchstart"in window;function makeDragAware(Component){return class DragAware extends React.PureComponent{constructor(){super(...arguments);this.domNode=null;this.currentPos=null;this.isDragging=false;this.handleTouchMove=event=>{if(this.isDragging){event.preventDefault();}};this.handleDragStart=event=>{const{onDragStart,readOnly}=this.props;if(readOnly||!this.domNode){return;}if(this.isDragging){debug$1("Start cancelled, already a drag in progress");return;}this.isDragging=true;const nextPos=getPos(event);debug$1("Drag started %o",nextPos);onDragStart(getPositionRelativeToRect(nextPos.x,nextPos.y,this.domNode.getBoundingClientRect()));this.currentPos=nextPos;};this.handleDrag=event=>{if(!this.isDragging||this.props.readOnly||!this.currentPos){return;}const{onDrag}=this.props;const nextPos=getPos(event);const diff=diffPos(nextPos,this.currentPos);onDrag(diff);debug$1("moving by %o",diff);this.currentPos=nextPos;};this.handleDragEnd=event=>{const{onDragEnd,readOnly}=this.props;if(!this.isDragging||readOnly||!this.domNode){return;}const nextPos=getPos(event);onDragEnd(getPositionRelativeToRect(nextPos.x,nextPos.y,this.domNode.getBoundingClientRect()));this.isDragging=false;this.currentPos=null;debug$1("Done moving %o",nextPos);};this.handleDragCancel=()=>{if(!this.isDragging||this.props.readOnly||!this.currentPos||!this.domNode){return;}const{onDragEnd}=this.props;this.isDragging=false;onDragEnd(getPositionRelativeToRect(this.currentPos.x,this.currentPos.y,this.domNode.getBoundingClientRect()));this.currentPos=null;};this.setDomNode=node=>{this.domNode=node;};}componentDidMount(){if(supportsTouch){document.body.addEventListener("touchmove",this.handleTouchMove,{passive:false});document.body.addEventListener("touchend",this.handleDragEnd);document.body.addEventListener("touchcancel",this.handleDragCancel);}else{document.body.addEventListener("mousemove",this.handleDrag);document.body.addEventListener("mouseup",this.handleDragEnd);document.body.addEventListener("mouseleave",this.handleDragCancel);}}componentWillUnmount(){if(supportsTouch){document.body.removeEventListener("touchmove",this.handleTouchMove);document.body.removeEventListener("touchend",this.handleDragEnd);document.body.removeEventListener("touchcancel",this.handleDragCancel);}else{document.body.removeEventListener("mousemove",this.handleDrag);document.body.removeEventListener("mouseup",this.handleDragEnd);document.body.removeEventListener("mouseleave",this.handleDragCancel);}}render(){const _this$props=this.props,{readOnly,onDragStart,onDragEnd,onDrag}=_this$props,rest=_objectWithoutProperties(_this$props,_excluded103);return/* @__PURE__ */jsx(Component,_objectSpread({ref:this.setDomNode,onTouchStart:readOnly?void 0:this.handleDragStart,onMouseDown:readOnly?void 0:this.handleDragStart,onTouchMove:readOnly?void 0:this.handleDrag},rest));}};}function getPositionRelativeToRect(x,y,rect){return{x:x-rect.left,y:y-rect.top};}function getPos(event){if("touches"in event){return event.touches.length>0?{x:event.touches[0].clientX,y:event.touches[0].clientY}:{x:0,y:0};}return{x:event.clientX,y:event.clientY};}function diffPos(pos,otherPos){return{x:pos.x-otherPos.x,y:pos.y-otherPos.y};}const DragAwareCanvas=makeDragAware("canvas");const RootContainer=styled.div(_templateObject314||(_templateObject314=_taggedTemplateLiteral(["\n  width: 100%;\n  height: 100%;\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n"])));const CanvasContainer=styled(DragAwareCanvas)(_templateObject315||(_templateObject315=_taggedTemplateLiteral(["\n  display: block;\n  position: relative;\n  max-width: calc(100% - 0.5em); /* to prevent overlap with change bar */\n  max-height: calc(100% + 1em);\n  user-select: none;\n"])));const OPEN_HAND="data:image/png;base64,AAACAAEAICACAAcABQAwAQAAFgAAACgAAAAgAAAAQAAAAAEAAQAAAAAAAAEAAAAAAAAAAAAAAgAAAAAAAAAAAAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8AAAA/AAAAfwAAAP+AAAH/gAAB/8AAA//AAAd/wAAGf+AAAH9gAADbYAAA2yAAAZsAAAGbAAAAGAAAAAAAAA//////////////////////////////////////////////////////////////////////////////////////gH///4B///8Af//+AD///AA///wAH//4AB//8AAf//AAD//5AA///gAP//4AD//8AF///AB///5A////5///8=";const CLOSE_HAND="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAABdSURBVEjH7ZA7DsAwCEMN6v2vTCdESpLKQRl5gxfzMQDNRQyWlEK83QAIRh3cH/QbIhQwMDl8gORl7A16WD/xxAdq6N6SgycKUblf41+wbFBT44RiCi11NU3TLHgBxRUUD4ITqnIAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTUtMDEtMjFUMDA6MTM6NDMrMDE6MDC74T7AAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDEyLTA0LTAyVDA0OjEzOjM3KzAyOjAwQJ35wQAAAABJRU5ErkJggg==";const DEFAULT_HOTSPOT={x:0.5,y:0.5,height:1,width:1};const DEFAULT_CROP={top:0,left:0,right:0,bottom:0};const MARGIN_PX=8;const CROP_HANDLE_SIZE=12;const HOTSPOT_HANDLE_SIZE=10;function normalizeRect(rect){const flippedY=rect.top>rect.bottom;const flippedX=rect.left>rect.right;return{top:flippedY?rect.bottom:rect.top,bottom:flippedY?rect.top:rect.bottom,left:flippedX?rect.right:rect.left,right:flippedX?rect.left:rect.right};}function checkCropBoundaries(value,delta){if(!value||!value.crop||value.crop.top+delta.top<0||value.crop.left+delta.left<0||value.crop.right+delta.right<0||value.crop.bottom+delta.bottom<0){return false;}return true;}function limitToBoundaries(value,delta){const{top,right,bottom,left}=value.crop||DEFAULT_CROP;const newValue={hotspot:value.hotspot,crop:{top:top+(delta.top||0)>0?top:0,right:right+(delta.right||0)>0?right:0,bottom:bottom+(delta.bottom||0)>0?bottom:0,left:left+(delta.left||0)>0?left:0}};const newDelta={top:top+(delta.top||0)>0?delta.top||0:0,right:right+(delta.right||0)>0?delta.right||0:0,bottom:bottom+(delta.bottom||0)>0?delta.bottom||0:0,left:left+(delta.left||0)>0?delta.left||0:0};return{value:newValue,delta:newDelta};}function getCropCursorForHandle(handle){switch(handle){case"left":case"right":return"col-resize";case"top":case"bottom":return"row-resize";case"topRight":case"bottomLeft":return"nesw-resize";case"topLeft":case"bottomRight":return"nwse-resize";default:return null;}}const getDevicePixelRatio$1=memoize$1(()=>{const devicePixelRatio=window.devicePixelRatio||1;const ctx=document.createElement("canvas").getContext("2d");const backingStoreRatio=ctx&&getBackingStoreRatio(ctx)||1;return devicePixelRatio/backingStoreRatio;});const cropHandleKeys=["left","right","top","topLeft","topRight","bottom","bottomLeft","bottomRight"];class ToolCanvas extends React.PureComponent{constructor(){super(...arguments);this.state={cropping:false,cropMoving:false,moving:false,resizing:false,mousePosition:null};this.handleDragStart=_ref392=>{let{x,y}=_ref392;const mousePosition={x:x*this.getScale(),y:y*this.getScale()};const inHotspot=isPointInEllipse(mousePosition,this.getHotspotRect());const inDragHandle=isPointInCircle(mousePosition,this.getDragHandleCoords());const activeCropHandle=this.getActiveCropHandleFor(mousePosition);const inCropRect=isPointInRect(mousePosition,this.getCropRect());if(activeCropHandle){this.setState({cropping:activeCropHandle});}else if(inDragHandle){this.setState({resizing:true});}else if(inHotspot){this.setState({moving:true});}else if(inCropRect){this.setState({cropMoving:true});}};this.handleDrag=pos=>{if(this.state.cropping){this.emitCrop(this.state.cropping,pos);}else if(this.state.cropMoving){this.emitCropMove(pos);}else if(this.state.moving){this.emitMove(pos);}else if(this.state.resizing){this.emitResize(pos);}};this.handleDragEnd=()=>{const{onChange,onChangeEnd}=this.props;this.setState({moving:false,resizing:false,cropping:false,cropMoving:false});const{hotspot,crop:rawCrop}=this.getClampedValue();const crop=normalizeRect(rawCrop);const finalValue={crop:{top:crop.top,bottom:1-crop.bottom,left:crop.left,right:1-crop.right},hotspot:{x:hotspot.center.x,y:hotspot.center.y,height:Math.abs(hotspot.height),width:Math.abs(hotspot.width)}};onChange(finalValue);if(onChangeEnd){onChangeEnd(finalValue);}};this.handleMouseOut=()=>{this.setState({mousePosition:null});};this.handleMouseMove=event=>{const clientRect=event.currentTarget.getBoundingClientRect();this.setState({mousePosition:{x:(event.clientX-clientRect.left)*this.getScale(),y:(event.clientY-clientRect.top)*this.getScale()}});};this.setCanvas=node=>{this.canvas=node;};}getHotspotRect(){const{value,image}=this.props;const hotspot=value.hotspot||DEFAULT_HOTSPOT;const hotspotRect=new Rect().setSize(hotspot.width,hotspot.height).setCenter(hotspot.x,hotspot.y);return new Rect().setSize(image.width,image.height).shrink(MARGIN_PX*this.getScale()).multiply(hotspotRect);}getCropRect(){const{value,image}=this.props;return new Rect().setSize(image.width,image.height).shrink(MARGIN_PX*this.getScale()).cropRelative(Rect.fromEdges(value.crop||DEFAULT_CROP).clamp(new Rect(0,0,1,1)));}getCropHandles(){const inner=this.getCropRect();const handleSize=CROP_HANDLE_SIZE*this.getScale();const halfCropHandleSize=handleSize/2;const cropHandle=new Rect(0,0,handleSize,handleSize);return{left:cropHandle.setTopLeft(inner.left-halfCropHandleSize,inner.center.y-halfCropHandleSize),right:cropHandle.setTopLeft(inner.right-halfCropHandleSize,inner.center.y-halfCropHandleSize),top:cropHandle.setTopLeft(inner.center.x-halfCropHandleSize,inner.top-halfCropHandleSize),topLeft:cropHandle.setTopLeft(inner.left-halfCropHandleSize,inner.top-halfCropHandleSize),topRight:cropHandle.setTopLeft(inner.right-halfCropHandleSize,inner.top-halfCropHandleSize),bottom:cropHandle.setTopLeft(inner.center.x-halfCropHandleSize,inner.bottom-halfCropHandleSize),bottomLeft:cropHandle.setTopLeft(inner.left-halfCropHandleSize,inner.bottom-halfCropHandleSize),bottomRight:cropHandle.setTopLeft(inner.right-halfCropHandleSize,inner.bottom-halfCropHandleSize)};}getActiveCropHandleFor(_ref393){let{x,y}=_ref393;const cropHandles=this.getCropHandles();for(const position of cropHandleKeys){if(isPointInRect({x,y},cropHandles[position])){return position;}}return false;}emitMove(pos){const{image,value,onChange}=this.props;const scale=this.getScale();const delta={x:pos.x*scale/image.width,y:pos.y*scale/image.height};onChange(applyHotspotMoveBy(value,delta));}emitCropMove(pos){const{image,onChange,value}=this.props;const scale=this.getScale();const left=pos.x*scale/image.width;const right=-pos.x*scale/image.width;const top=pos.y*scale/image.height;const bottom=-pos.y*scale/image.height;const delta={left,right,top,bottom};if(checkCropBoundaries(value,delta)){onChange(applyCropMoveBy(value,delta));}}emitCrop(side,pos){const{image,onChange,value}=this.props;const scale=this.getScale();let left=0;let right=0;let top=0;let bottom=0;if(side=="left"||side==="topLeft"||side==="bottomLeft"){left=pos.x*scale/image.width;}else if(side=="right"||side==="topRight"||side==="bottomRight"){right=-pos.x*scale/image.width;}if(side=="top"||side==="topLeft"||side==="topRight"){top=pos.y*scale/image.height;}else if(side=="bottom"||side==="bottomLeft"||side==="bottomRight"){bottom=-pos.y*scale/image.height;}const delta={left,right,top,bottom};const newValue=limitToBoundaries(value,delta).value;const newDelta=limitToBoundaries(value,delta).delta;onChange(applyCropMoveBy(newValue,newDelta));}emitResize(pos){const{image,onChange,value}=this.props;const scale=this.getScale();const delta={x:pos.x*scale*2/image.width,y:pos.y*scale*2/image.height};onChange(applyHotspotResizeBy(value,{height:delta.y,width:delta.x}));}getClampedValue(){const value=this.props.value;const crop=Rect.fromEdges(value.crop||DEFAULT_CROP).clamp(new Rect(0,0,1,1));const hotspot=value.hotspot||DEFAULT_HOTSPOT;const hotspotRect=new Rect(0,0,1,1).setSize(hotspot.width,hotspot.height).setCenter(hotspot.x,hotspot.y).clamp(crop);return{crop,hotspot:hotspotRect};}paintHotspot(context,opacity){const{image,readOnly}=this.props;const imageRect=new Rect().setSize(image.width,image.height);const{hotspot,crop}=this.getClampedValue();const scale=this.getScale();const margin=MARGIN_PX*scale;context.save();drawBackdrop();drawEllipse();context.clip();drawHole();context.restore();if(!readOnly){drawDragHandle(Math.PI*1.25);}function drawEllipse(){context.save();const dest=imageRect.shrink(margin).multiply(hotspot);const scaleY=dest.height/dest.width;context.scale(1,scaleY);context.beginPath();context.globalAlpha=opacity;context.arc(dest.center.x,dest.center.y/scaleY,Math.abs(dest.width/2),0,2*Math.PI,false);context.strokeStyle="white";context.lineWidth=1.5*scale;context.stroke();context.closePath();context.restore();}function drawImage(srcLeft,srcTop,srcWidth,srcHeight,destLeft,destTop,destWidth,destHeight){context.save();context.drawImage(image,srcLeft,srcTop,srcWidth,srcHeight,destLeft,destTop,destWidth,destHeight);context.restore();}function drawHole(){const src=imageRect.multiply(hotspot);const dest=imageRect.shrink(margin).multiply(hotspot);drawImage(src.left,src.top,src.width,src.height,dest.left,dest.top,dest.width,dest.height);}function drawBackdrop(){const src=imageRect.cropRelative(crop);const dest=imageRect.shrink(margin).cropRelative(crop);context.save();drawImage(src.left,src.top,src.width,src.height,dest.left,dest.top,dest.width,dest.height);context.globalAlpha=0.5;context.fillStyle="black";context.fillRect(dest.left,dest.top,dest.width,dest.height);context.restore();}function drawDragHandle(radians){context.save();const radius=HOTSPOT_HANDLE_SIZE*scale;const dest=imageRect.shrink(margin).multiply(hotspot);const point=getPointAtCircumference(radians,dest);context.beginPath();context.arc(point.x,point.y,radius,0,2*Math.PI,false);context.fillStyle="rgb(255,255,255)";context.fill();context.closePath();context.restore();context.beginPath();context.arc(point.x,point.y,radius,0,2*Math.PI,false);context.strokeStyle="rgb(0, 0, 0)";context.lineWidth=0.5*scale;context.stroke();context.closePath();}}getActualSize(){var _a;const node=(_a=this.canvas)==null?void 0:_a.domNode;return node?{height:node.clientHeight,width:node.clientWidth}:{height:0,width:0};}getDragHandleCoords(){const bbox=this.getHotspotRect();const point=getPointAtCircumference(Math.PI*1.25,bbox);return{x:point.x,y:point.y,radius:8*this.getScale()};}debug(context){context.save();const{image}=this.props;const bbox=this.getHotspotRect();const scale=this.getScale();const margin=MARGIN_PX*scale;if(context.setLineDash){context.setLineDash([2*scale,2*scale]);}context.lineWidth=0.5*scale;context.strokeStyle="rgba(200, 200, 200, 0.5)";vline(bbox.center.x);hline(bbox.center.y);context.strokeStyle="rgba(150, 150, 150, 0.5)";hline(bbox.top);hline(bbox.bottom);vline(bbox.left);vline(bbox.right);context.restore();function vline(x){line(x,margin,x,image.height-margin);}function hline(y){line(margin,y,image.width-margin,y);}function line(x1,y1,x2,y2){context.beginPath();context.moveTo(x1,y1);context.lineTo(x2,y2);context.stroke();context.closePath();}}paintBackground(context){const{image}=this.props;const inner=new Rect().setSize(image.width,image.height).shrink(MARGIN_PX*this.getScale());context.save();context.fillStyle="white";context.clearRect(0,0,image.width,image.height);context.globalAlpha=0.3;context.drawImage(image,inner.left,inner.top,inner.width,inner.height);context.restore();}paint(context){const{readOnly}=this.props;context.save();const pxratio=getDevicePixelRatio$1();context.scale(pxratio,pxratio);const opacity=!readOnly&&this.state.mousePosition?0.8:0.2;this.paintBackground(context);this.paintHotspot(context,opacity);this.debug(context);this.paintCropBorder(context);if(!readOnly){this.highlightCropHandles(context,opacity);}context.restore();}paintMousePosition(context){if(!this.state.mousePosition){return;}const{x,y}=this.state.mousePosition;context.beginPath();context.arc(x,y,14*this.getScale(),0,2*Math.PI,false);context.fillStyle="lightblue";context.fill();context.restore();}paintCropBorder(context){const cropRect=this.getCropRect();context.save();context.beginPath();context.fillStyle="rgba(66, 66, 66, 0.9)";context.lineWidth=1;context.rect(cropRect.left,cropRect.top,cropRect.width,cropRect.height);context.stroke();context.closePath();context.restore();}highlightCropHandles(context,opacity){context.save();const cropHandles=this.getCropHandles();cropHandleKeys.forEach(handle=>{context.fillStyle=this.state.cropping===handle?"rgba(202, 54, 53, ".concat(opacity,")"):"rgba(230, 230, 230, ".concat(opacity+0.4,")");const{left,top,height,width}=cropHandles[handle];context.fillRect(left,top,width,height);context.beginPath();context.fillStyle="rgba(66, 66, 66, ".concat(opacity,")");context.rect(left,top,width,height);context.closePath();context.stroke();});context.restore();}getScale(){const actualSize=this.getActualSize();return this.props.image.width/actualSize.width;}getCursor(){const{mousePosition}=this.state;const{readOnly}=this.props;if(!mousePosition||readOnly){return"auto";}const activeCropArea=this.state.cropping||this.getActiveCropHandleFor(mousePosition);if(activeCropArea){return getCropCursorForHandle(activeCropArea)||"auto";}const mouseOverDragHandle=isPointInCircle(mousePosition,this.getDragHandleCoords());if(this.state.resizing||mouseOverDragHandle){return"move";}if(this.state.moving||this.state.cropMoving){return"url(".concat(CLOSE_HAND,"), move");}const mouseoverHotspot=isPointInEllipse(mousePosition,this.getHotspotRect());const mouseoverCropRect=isPointInRect(mousePosition,this.getCropRect());if(mouseoverHotspot||mouseoverCropRect){return"url(".concat(OPEN_HAND,"), move");}return"auto";}componentDidMount(){this.draw();}componentDidUpdate(){this.draw();}draw(){if(!this.canvas){return;}const domNode=this.canvas.domNode;const context=domNode.getContext("2d");if(!context){return;}this.paint(context);const currentCursor=domNode.style.cursor;const newCursor=this.getCursor();if(currentCursor!==newCursor){domNode.style.cursor=newCursor;}}render(){const{image,readOnly}=this.props;const ratio=getDevicePixelRatio$1();return/* @__PURE__ */jsx(RootContainer,{children:/* @__PURE__ */jsx(CanvasContainer,{readOnly,ref:this.setCanvas,onDrag:this.handleDrag,onDragStart:this.handleDragStart,onDragEnd:this.handleDragEnd,onMouseMove:this.handleMouseMove,onMouseOut:this.handleMouseOut,height:image.height*ratio,width:image.width*ratio})});}}function applyHotspotMoveBy(value,delta){const currentHotspot=value&&value.hotspot||DEFAULT_HOTSPOT;return _objectSpread(_objectSpread({},value),{},{hotspot:_objectSpread(_objectSpread({},currentHotspot),{},{x:currentHotspot.x+delta.x,y:currentHotspot.y+delta.y})});}function applyHotspotResizeBy(value,delta){const currentHotspot=value&&value.hotspot||DEFAULT_HOTSPOT;return _objectSpread(_objectSpread({},value),{},{hotspot:_objectSpread(_objectSpread({},currentHotspot),{},{height:currentHotspot.height+delta.height,width:currentHotspot.width+delta.width})});}function applyCropMoveBy(value,delta){const currentCrop=value&&value.crop||DEFAULT_CROP;return _objectSpread(_objectSpread({},value),{},{crop:{left:currentCrop.left+(delta.left||0),right:currentCrop.right+(delta.right||0),top:currentCrop.top+(delta.top||0),bottom:currentCrop.bottom+(delta.bottom||0)}});}class Resize extends React.Component{constructor(){super(...arguments);this._canvas=null;}componentWillUnmount(){if(this._canvas){document.body.removeChild(this._canvas);}}getCanvas(){if(!this._canvas){this._canvas=document.createElement("canvas");document.body.appendChild(this._canvas);this._canvas.style.display="none";}return this._canvas;}resize(image,maxHeight,maxWidth){const canvas=this.getCanvas();const ratio=image.width/image.height;const width=Math.min(image.width,maxWidth);const height=Math.min(image.height,maxHeight);const landscape=image.width>image.height;const targetWidth=landscape?width:height*ratio;const targetHeight=landscape?width/ratio:height;canvas.width=targetWidth;canvas.height=targetHeight;const ctx=canvas.getContext("2d");if(ctx){ctx.drawImage(image,0,0,image.width,image.height,0,0,targetWidth,targetHeight);}return canvas;}render(){const{image,maxHeight,maxWidth,children}=this.props;return children(this.resize(image,maxHeight,maxWidth));}}function ImageTool(props){return/* @__PURE__ */jsx(ImageLoader,{src:props.src,children:_ref394=>{let{isLoading,image,error}=_ref394;if(isLoading){return/* @__PURE__ */jsx("div",{children:"Loading..."});}if(error){return/* @__PURE__ */jsx("div",{children:error.message});}if(image){return/* @__PURE__ */jsx(Resize,{image,maxHeight:ImageTool.maxHeight,maxWidth:ImageTool.maxWidth,children:canvas=>/* @__PURE__ */jsx(ToolCanvas,_objectSpread({image:canvas},props))});}return null;}});}ImageTool.maxHeight=500;ImageTool.maxWidth=1e3;function calculateStyles(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const imageAspect=readAspectRatio(options.image)||1;const hotspot=options.hotspot||DEFAULT_HOTSPOT;const crop=options.crop||DEFAULT_CROP;const containerAspect=readAspectRatio(options.container)||imageAspect*readCropAspect(crop);const align=options.align||{x:"center",y:"center"};const result=calculateHotSpotCrop(imageAspect,{hotspot,crop},{aspect:containerAspect,align});const containerHeight=styleFormat(round(100/containerAspect));return{debug:{result},container:{overflow:"hidden",position:"relative",width:"100%",height:containerHeight},padding:{marginTop:containerHeight},crop:{position:"absolute",overflow:"hidden",height:toStylePercentage(result.crop.height),width:toStylePercentage(result.crop.width),top:toStylePercentage(result.crop.top),left:toStylePercentage(result.crop.left)},image:{position:"absolute",height:toStylePercentage(result.image.height),width:toStylePercentage(result.image.width),top:toStylePercentage(result.image.top),left:toStylePercentage(result.image.left)}};}function readAspectRatio(opts){if(!opts){return null;}if("aspectRatio"in opts){return opts.aspectRatio;}if("height"in opts||"width"in opts){if(typeof opts.height!=="number"&&typeof opts.width!=="number"){throw new Error("Height and width must be numbers, got ".concat(JSON.stringify(opts)));}return opts.width/opts.height;}return null;}function round(num){let decimals=arguments.length>1&&arguments[1]!==undefined?arguments[1]:2;const multiplier=Math.pow(10,decimals);return Math.round(num*multiplier)/multiplier;}function calculateHotSpotCrop(sourceAspect,descriptor,spec){const crop=descriptor.crop;const viewportAspect=spec.aspect;const alignment=spec.align;const netWidth=1-crop.left-crop.right;const netHeight=1-crop.top-crop.bottom;const outImg={top:-crop.top/netHeight,left:-crop.left/netWidth,width:1/netWidth,height:1/netHeight};const cropRationalAspect=netWidth/netHeight;const cropAspect=cropRationalAspect*sourceAspect;const hotspot={x:(descriptor.hotspot.x-crop.left)/netWidth,y:(descriptor.hotspot.y-crop.top)/netHeight,height:descriptor.hotspot.height/netHeight,width:descriptor.hotspot.width/netWidth};const maxHotspotXScale=1/hotspot.width;const maxHotspotYScale=1/hotspot.height*cropAspect/viewportAspect;const maxScale=Math.min(maxHotspotXScale,maxHotspotYScale);let minFullBleedScale;const cropIsTaller=cropAspect<=viewportAspect;if(cropIsTaller){minFullBleedScale=1;}else{minFullBleedScale=cropAspect/viewportAspect;}let method;let outCrop;if(minFullBleedScale>maxScale){method="letterbox";let letterboxScale;const diff=minFullBleedScale-maxScale;if(cropIsTaller){letterboxScale=1-diff;}else{letterboxScale=maxScale;}outCrop={width:letterboxScale,height:letterboxScale/cropAspect*viewportAspect,left:0,top:0};const hotspotLeft=hotspot.x*outCrop.width-hotspot.width*outCrop.width/2;switch(alignment.x){case"left":outCrop.left=cropIsTaller?0:-hotspotLeft;break;case"right":outCrop.left=cropIsTaller?1-outCrop.width:hotspotLeft;break;case"center":outCrop.left=cropIsTaller?(1-outCrop.width)/2:-hotspotLeft;break;default:throw new Error("Invalid x alignment: '".concat(alignment.x,"'. Must be either 'left', 'right' or 'center'"));}const hotspotTop=hotspot.y*outCrop.height-hotspot.height*outCrop.height/2;switch(alignment.y){case"top":outCrop.top=cropIsTaller?-hotspotTop:0;break;case"bottom":outCrop.top=hotspotTop;break;case"center":outCrop.top=cropIsTaller?-hotspotTop:(1-outCrop.height)/2;break;default:throw new Error("Invalid y alignment: '".concat(alignment.y,"'. Must be either 'top', 'bottom' or 'center'"));}}else if(cropIsTaller){method="full_width";let top=-hotspot.y/cropAspect*viewportAspect+0.5;const height=minFullBleedScale/cropAspect*viewportAspect;if(top>0){top=0;}else if(-top>height-1){top=-(height-1);}outCrop={width:minFullBleedScale,height,left:0,top};}else{method="full_height";const width=minFullBleedScale;let left=0.5-hotspot.x*minFullBleedScale;if(left>0){left=0;}else if(-left>width-1){left=-(width-1);}outCrop={width,height:minFullBleedScale/cropAspect*viewportAspect,top:0,left};}return{method,crop:outCrop,image:outImg};}function readCropAspect(crop){const height=1-crop.top-crop.bottom;const width=1-crop.left-crop.right;return width/height;}function styleFormat(num){return num===0?0:"".concat(num,"%");}function toStylePercentage(num){return styleFormat(round(num*100));}const HotspotImageContainer=styled.div(_templateObject316||(_templateObject316=_taggedTemplateLiteral(["\n  position: relative;\n  width: 100%;\n"])));const debug=Debug("sanity-imagetool");function getCropAspect(crop,srcAspect){const origHeight=1/srcAspect;const origWidth=srcAspect*origHeight;const cropWidth=origWidth-(crop.left+crop.right)*origWidth;const cropHeight=origHeight-(crop.top+crop.bottom)*origHeight;return cropWidth/cropHeight;}class HotspotImage extends React.PureComponent{constructor(){super(...arguments);this.state={containerAspect:null};this.containerElement=null;this.imageElement=null;this.setImageElement=el=>{this.imageElement=el;};this.handleResize=debounce(()=>this.updateContainerAspect(this.props));this.setContainerElement=el=>{this.containerElement=el;};}componentDidMount(){const imageElement=this.imageElement;const alreadyLoaded=imageElement&&imageElement.src&&imageElement.complete&&imageElement.naturalWidth!==void 0;if(alreadyLoaded){debug("Image '%s' already loaded, refreshing (from cache) to trigger onLoad / onError",this.props.src);imageElement.src=imageElement.src;}this.updateContainerAspect(this.props);if(typeof window!=="undefined"){window.addEventListener("resize",this.handleResize);}}componentWillUnmount(){if(typeof window!=="undefined"){window.removeEventListener("resize",this.handleResize);}}UNSAFE_componentWillReceiveProps(nextProps){if(nextProps.aspectRatio!==this.props.aspectRatio){this.updateContainerAspect(nextProps);}}updateContainerAspect(props){if(!this.containerElement)return;if(props.aspectRatio==="auto"){const parentNode=this.containerElement.parentNode;this.setState({containerAspect:parentNode.offsetWidth/parentNode.offsetHeight});}else{this.setState({containerAspect:null});}}getTargetAspectValue(){const{aspectRatio,srcAspectRatio,crop}=this.props;if(aspectRatio==="none"){return crop?getCropAspect(crop,srcAspectRatio):srcAspectRatio;}if(aspectRatio==="auto"){return this.state.containerAspect;}return aspectRatio||null;}render(){const{srcAspectRatio,crop,hotspot,src,srcSet,alignX="center",alignY="center",className,style,alt,onError,onLoad}=this.props;const targetAspect=this.getTargetAspectValue();const targetStyles=calculateStyles({container:{aspectRatio:targetAspect||srcAspectRatio},image:{aspectRatio:srcAspectRatio},hotspot,crop,align:{x:alignX,y:alignY}});return/* @__PURE__ */jsx(HotspotImageContainer,{className:"".concat(className),style,ref:this.setContainerElement,children:/* @__PURE__ */jsxs("div",{style:targetStyles.container,children:[/* @__PURE__ */jsx("div",{style:targetStyles.padding}),/* @__PURE__ */jsx("div",{style:targetStyles.crop,children:/* @__PURE__ */jsx("img",{ref:this.setImageElement,src,alt,srcSet,onLoad,onError,style:targetStyles.image})})]})});}}HotspotImage.defaultProps={alignX:"center",alignY:"center",className:"",crop:DEFAULT_CROP,hotspot:DEFAULT_HOTSPOT,aspectRatio:"none"};const PROBABLY_THE_TINIEST_GIF_EVER="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";function isBlob(src){return src.startsWith("blob:");}function loadImage(src){return new Observable(subscriber=>{const image=document.createElement("img");let completed=false;const onload=()=>{completed=true;subscriber.next(image);subscriber.complete();};const onerror=()=>{completed=true;subscriber.error(new Error("Could not load image from ".concat(isBlob(src)?"blob":src)));};image.onload=onload;image.onerror=onerror;image.src=src;return()=>{image.onload=null;image.onerror=null;if(!completed){image.src=PROBABLY_THE_TINIEST_GIF_EVER;}};});}const INITIAL_STATE={isLoading:true};function useLoadImage(url){const[state,setState]=useState(INITIAL_STATE);useEffect(()=>{setState(INITIAL_STATE);const subscription=loadImage(url).subscribe({error:err=>{setState({isLoading:false,error:err});},next:image=>{setState({image,isLoading:false});}});return()=>{subscription.unsubscribe();};},[url]);return state;}const HOTSPOT_PATH=["hotspot"];const PREVIEW_ASPECT_RATIOS=[["3:4",3/4],["Square",1/1],["16:9",16/9],["Panorama",4/1]];const DEFAULT_VALUE={crop:DEFAULT_CROP,hotspot:DEFAULT_HOTSPOT};const Placeholder=styled.div(_templateObject317||(_templateObject317=_taggedTemplateLiteral(["\n  min-height: 6em;\n"])));function LoadStatus(props){return/* @__PURE__ */jsx(Flex,{align:"center",justify:"center",padding:4,style:{overflowWrap:"break-word"},children:props.children});}function ImageToolInput(props){const{imageUrl,value,changed,level,path,focusPath=EMPTY_ARRAY$4,presence,onChange,schemaType,onFocusPath,readOnly,elementProps}=props;const[localValue,setLocalValue]=useState(value||DEFAULT_VALUE);const{image,isLoading:isImageLoading,error:imageLoadError}=useLoadImage(imageUrl);const handleFocus=useCallback(()=>{onFocusPath(HOTSPOT_PATH);},[onFocusPath]);useEffect(()=>{setLocalValue(value||DEFAULT_VALUE);},[value]);const hasFocus=focusPath[0]==="hotspot";useDidUpdate(hasFocus,hadFocus=>{var _a;if(!hadFocus&&hasFocus){(_a=elementProps.ref.current)==null?void 0:_a.focus();}});const handleChangeEnd=useCallback(finalValue=>{if(readOnly){return;}const cropField=schemaType.fields.find(field=>field.name==="crop"&&field.type.name!=="object");const hotspotField=schemaType.fields.find(field=>field.type.name!=="object"&&field.name==="hotspot");const crop=cropField?_objectSpread({_type:cropField.type.name},finalValue.crop||DEFAULT_CROP):finalValue.crop;const hotspot=hotspotField?_objectSpread({_type:hotspotField.type.name},finalValue.hotspot||DEFAULT_HOTSPOT):finalValue.hotspot;onChange([set(crop,["crop"]),set(hotspot,["hotspot"])]);},[onChange,readOnly,schemaType.fields]);return/* @__PURE__ */jsx(FormField,{title:"Hotspot & crop",level,description:"Adjust the rectangle to crop image. Adjust the circle to specify the area that should always be visible.",__unstable_presence:presence,children:/* @__PURE__ */jsxs("div",{children:[/* @__PURE__ */jsx(Card,{__unstable_checkered:true,__unstable_focusRing:true,tabIndex:0,ref:elementProps.ref,onFocus:handleFocus,children:/* @__PURE__ */jsx(ChangeIndicator,{path:path.concat(HOTSPOT_PATH),hasFocus:focusPath[0]==="hotspot",isChanged:changed,children:/* @__PURE__ */jsxs(RatioBox$1,{ratio:3/2,children:[(isImageLoading||imageLoadError)&&/* @__PURE__ */jsx(LoadStatus,{children:imageLoadError?/* @__PURE__ */jsx(Card,{padding:4,radius:2,tone:"critical",border:true,children:/* @__PURE__ */jsxs(Text$1,{children:["Error: ",imageLoadError.message]})}):/* @__PURE__ */jsx(Text$1,{muted:true,children:"Loading image\u2026 "})}),!isImageLoading&&image&&/* @__PURE__ */jsx(Box,{margin:1,children:/* @__PURE__ */jsx(ImageTool,{value:localValue,src:image.src,readOnly:Boolean(readOnly),onChangeEnd:handleChangeEnd,onChange:setLocalValue})})]})})}),/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(Grid,{columns:PREVIEW_ASPECT_RATIOS.length,gap:1,children:PREVIEW_ASPECT_RATIOS.map(_ref395=>{let[title,ratio]=_ref395;return/* @__PURE__ */jsxs("div",{children:[/* @__PURE__ */jsx(Heading,{as:"h4",size:0,children:title}),/* @__PURE__ */jsx(Box,{marginTop:2,children:/* @__PURE__ */jsx(RatioBox$1,{ratio,children:/* @__PURE__ */jsx(Card,{__unstable_checkered:true,children:!isImageLoading&&image?/* @__PURE__ */jsx(HotspotImage,{aspectRatio:ratio,src:image.src,srcAspectRatio:image.width/image.height,hotspot:localValue.hotspot||DEFAULT_HOTSPOT,crop:localValue.crop||DEFAULT_CROP}):/* @__PURE__ */jsx(Placeholder,{})})})})]},ratio);})})})]})});}const ButtonContainer=styled(Button)(_templateObject318||(_templateObject318=_taggedTemplateLiteral(["\n  z-index: 100;\n"])));const MenuActionsWrapper=styled(Inline)(_templateObject319||(_templateObject319=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  right: 0;\n  z-index: 1;\n"])));function ImageActionsMenu(props){const{onEdit,children,showEdit,isMenuOpen,onMenuOpen}=props;const[menuElement,setMenuRef]=useState(null);const[menuButtonRef,setMenuButtonRef]=useState(null);const handleClick=React.useCallback(()=>onMenuOpen(true),[onMenuOpen]);const handleClickOutside=useCallback(()=>{onMenuOpen(false);},[onMenuOpen]);const handleGlobalKeyDown=useCallback(e=>{if(e.key==="Escape"){onMenuOpen(false);menuButtonRef==null?void 0:menuButtonRef.focus();}},[menuButtonRef,onMenuOpen]);useClickOutside(handleClickOutside,[menuElement]);useGlobalKeyDown(handleGlobalKeyDown);return/* @__PURE__ */jsxs(MenuActionsWrapper,{"data-buttons":true,space:1,padding:2,children:[showEdit&&/* @__PURE__ */jsx(ButtonContainer,{icon:CropIcon,mode:"ghost",onClick:onEdit,"data-testid":"options-menu-edit-details"}),/* @__PURE__ */jsx(Popover,{content:/* @__PURE__ */jsx(Menu,{ref:setMenuRef,shouldFocus:"first",children}),portal:true,constrainSize:true,open:isMenuOpen,children:/* @__PURE__ */jsx(ButtonContainer,{icon:EllipsisVerticalIcon,mode:"ghost","data-testid":"options-menu-button",onClick:handleClick,ref:setMenuButtonRef})})]});}const MAX_DEFAULT_HEIGHT=30;const RatioBox=styled(Card)(_templateObject320||(_templateObject320=_taggedTemplateLiteral(["\n  position: relative;\n  width: 100%;\n  overflow: hidden;\n  min-height: 3.75rem;\n  max-height: 20rem;\n\n  & > div[data-container] {\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    display: flex !important;\n    align-items: center;\n    justify-content: center;\n  }\n\n  & img {\n    max-width: 100%;\n    max-height: 100%;\n  }\n"])));const SpinnerWrapper=styled(Spinner)(_templateObject321||(_templateObject321=_taggedTemplateLiteral(["\n  position: absolute;\n"])));const Overlay=styled(Flex)(_ref396=>{let{tone,drag}=_ref396;const textColor=studioTheme.color.light[tone].card.enabled.fg;const backgroundColor=rgba(studioTheme.color.light[tone].card.enabled.bg,0.8);return css(_templateObject322||(_templateObject322=_taggedTemplateLiteral(["\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      backdrop-filter: ",";\n      color: ",";\n      background-color: ",";\n    "])),drag?"blur(10px)":"",tone?textColor:"",drag?backgroundColor:"transparent");});const FlexOverlay=styled(Flex)(_templateObject323||(_templateObject323=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  left: 0;\n  bottom: 0;\n  right: 0;\n"])));const getImageSize=src=>{const imageUrlParams=new URLSearchParams(src.split("?")[1]);const rect=imageUrlParams.get("rect");if(rect){return[rect.split(",")[2],rect.split(",")[3]].map(Number);}return src.split("-")[1].split(".")[0].split("x").map(Number);};function ImagePreview(props){const{drag,readOnly,isRejected,src}=props,rest=_objectWithoutProperties(props,_excluded104);const[isLoaded,setLoaded]=useState(false);const[rootElement,setRootElement]=useState(null);const rootRect=useElementRect(rootElement);const rootWidth=(rootRect==null?void 0:rootRect.width)||0;const acceptTone=isRejected||readOnly?"critical":"primary";const tone=drag?acceptTone:"default";const maxHeightToPx=MAX_DEFAULT_HEIGHT*document.documentElement.clientHeight/100;const[imageWidth,imageHeight]=getImageSize(src);const imageRatio=imageWidth/imageHeight;const renderedImageHeight=imageWidth>rootWidth?rootWidth/imageRatio:imageHeight;const rootHeight=renderedImageHeight<maxHeightToPx?null:"".concat(MAX_DEFAULT_HEIGHT,"vh");useEffect(()=>{setLoaded(false);},[src]);const onLoadChange=useCallback(()=>{setLoaded(true);},[]);return/* @__PURE__ */jsxs(RatioBox,_objectSpread(_objectSpread({},rest),{},{ref:setRootElement,style:{height:rootHeight},tone:"transparent",children:[/* @__PURE__ */jsxs(Card,{"data-container":true,tone:"inherit",children:[!isLoaded&&/* @__PURE__ */jsx(OverlayComponent,{cardTone:"transparent",drag:true,content:/* @__PURE__ */jsx(SpinnerWrapper,{})}),/* @__PURE__ */jsx("img",{src,"data-testid":"hotspot-image-input",alt:props.alt,onLoad:onLoadChange,referrerPolicy:"strict-origin-when-cross-origin"})]}),drag&&/* @__PURE__ */jsx(OverlayComponent,{cardTone:tone,drag,content:/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(Box,{marginBottom:3,children:/* @__PURE__ */jsx(Heading,{children:/* @__PURE__ */jsx(HoverIcon,{isRejected,readOnly})})}),/* @__PURE__ */jsx(HoverText,{isRejected,readOnly})]})})]}));}function HoverIcon(_ref397){let{isRejected,readOnly}=_ref397;if(isRejected){return/* @__PURE__ */jsx(AccessDeniedIcon,{});}if(readOnly){return/* @__PURE__ */jsx(ReadOnlyIcon,{});}return/* @__PURE__ */jsx(ImageIcon,{});}function HoverText(_ref398){let{isRejected,readOnly}=_ref398;let message="Drop image to upload";if(isRejected){message="Cannot upload this file here";}if(readOnly){message="This field is read only";}return/* @__PURE__ */jsx(Text$1,{size:1,children:message});}function OverlayComponent(_ref399){let{cardTone,drag,content}=_ref399;return/* @__PURE__ */jsx(Overlay,{justify:"flex-end",padding:3,tone:cardTone,drag,children:/* @__PURE__ */jsx(FlexOverlay,{direction:"column",align:"center",justify:"center",children:content})});}const ButtonWrapper$1=styled(Button)(_templateObject324||(_templateObject324=_taggedTemplateLiteral(["\n  width: 100%;\n"])));function InvalidImageWarning(_ref400){let{onClearValue}=_ref400;return/* @__PURE__ */jsxs(Card,{tone:"caution",padding:4,border:true,radius:2,children:[/* @__PURE__ */jsxs(Flex,{gap:4,marginBottom:4,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(WarningOutlineIcon,{})})}),/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:"Invalid image value"}),/* @__PURE__ */jsx(Text$1,{size:1,children:"The value of this field is not a valid image. Resetting this field will let you choose a new image."})]})]}),/* @__PURE__ */jsx(ButtonWrapper$1,{icon:ResetIcon,text:"Reset value",onClick:onClearValue,mode:"ghost"})]});}const getDevicePixelRatio=()=>{if(typeof window==="undefined"||!window.devicePixelRatio){return 1;}return Math.round(Math.max(1,window.devicePixelRatio));};function passThrough$1(_ref401){let{children}=_ref401;return children;}const ASSET_FIELD_PATH$1=["asset"];const ASSET_IMAGE_MENU_POPOVER={portal:true};class ImageInput extends React.PureComponent{constructor(props){var _this;super(props);_this=this;this._assetElementRef=null;this.uploadSubscription=null;this.state={isUploading:false,selectedAssetSource:null,hoveringFiles:[],isStale:false,isMenuOpen:false};this.toast=null;this.setFocusElement=el=>{this._assetElementRef=el;};this.getUploadOptions=file=>{const{schemaType,resolveUploader}=this.props;const uploader=resolveUploader&&resolveUploader(schemaType,file);return uploader?[{type:schemaType,uploader}]:[];};this.uploadWith=function(uploader,file){let assetDocumentProps=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};const{schemaType,onChange,client}=_this.props;const{label,title,description,creditLine,source}=assetDocumentProps;const options={metadata:get$2(schemaType,"options.metadata"),storeOriginalFilename:get$2(schemaType,"options.storeOriginalFilename"),label,title,description,creditLine,source};_this.cancelUpload();_this.setState({isUploading:true});onChange(setIfMissing({_type:schemaType.name}));_this.uploadSubscription=uploader.upload(client,file,schemaType,options).subscribe({next:uploadEvent=>{if(uploadEvent.patches){onChange(uploadEvent.patches);}},error:err=>{var _a;console.error(err);(_a=_this.toast)==null?void 0:_a.push({status:"error",description:"The upload could not be completed at this time.",title:"Upload failed"});_this.clearUploadStatus();},complete:()=>{onChange([unset(["hotspot"]),unset(["crop"])]);_this.setState({isUploading:false});}});};this.handleRemoveButtonClick=()=>{const{value}=this.props;const allKeys=Object.keys(value||{});const remainingKeys=allKeys.filter(key=>!["_type","_key","_upload","asset","crop","hotspot"].includes(key));const isEmpty=remainingKeys.length===0;const removeKeys=["asset"].concat(allKeys.filter(key=>["crop","hotspot","_upload"].includes(key))).map(key=>unset([key]));this.props.onChange(isEmpty&&!this.valueIsArrayElement()?unset():removeKeys);};this.handleFieldChange=event=>{const{onChange,schemaType}=this.props;if(!this.valueIsArrayElement()&&this.eventIsUnsettingLastFilledField(event)){onChange(unset());return;}onChange(event.prepend(setIfMissing({_type:schemaType.name})).patches);};this.eventIsUnsettingLastFilledField=event=>{const patch=event.patches[0];if(event.patches.length!==1||patch.type!=="unset"){return false;}const allKeys=Object.keys(this.props.value||{});const remainingKeys=allKeys.filter(key=>!["_type","_key","crop","hotspot"].includes(key));const isEmpty=event.patches[0].path.length===1&&remainingKeys.length===1&&remainingKeys[0]===event.patches[0].path[0];return isEmpty;};this.valueIsArrayElement=()=>{const{path}=this.props;const parentPathSegment=path.slice(-1)[0];return typeof parentPathSegment!=="string";};this.handleOpenDialog=()=>{const{onOpenField}=this.props;onOpenField("hotspot");};this.handleCloseDialog=()=>{const{onCloseField}=this.props;onCloseField("hotspot");};this.handleSelectAssetFromSource=assetFromSource=>{const{onChange,schemaType,resolveUploader}=this.props;handleSelectAssetFromSource({assetFromSource,onChange,type:schemaType,resolveUploader,uploadWith:this.uploadWith,isImage:true});this.setState({selectedAssetSource:null});};this.handleFilesOver=hoveringFiles=>{this.setState({hoveringFiles});};this.handleFilesOut=()=>{this.setState({hoveringFiles:[]});};this.handleCancelUpload=()=>{this.cancelUpload();};this.handleClearUploadState=()=>{this.setState({isStale:false});this.clearUploadStatus();};this.handleStaleUpload=()=>{this.setState({isStale:true});};this.handleClearField=()=>{this.props.onChange([unset(["asset"]),unset(["crop"]),unset(["hotspot"])]);};this.handleSelectFiles=files=>{const{directUploads,readOnly}=this.props;const{hoveringFiles}=this.state;if(directUploads&&!readOnly){this.uploadFirstAccepted(files);}else if(hoveringFiles.length>0){this.handleFilesOut();}};this.handleSelectImageFromAssetSource=source=>{this.setState({selectedAssetSource:source});};this.handleAssetSourceClosed=()=>{this.setState({selectedAssetSource:null});};this.renderHotspotInput=hotspotInputProps=>{const{value,changed,id,imageUrlBuilder}=this.props;const withImageTool=this.isImageToolEnabled()&&value&&value.asset;return/* @__PURE__ */jsx(Dialog,{header:"Edit hotspot and crop",id:"".concat(id,"_dialog"),onClose:this.handleCloseDialog,width:1,__unstable_autoFocus:false,children:/* @__PURE__ */jsx(PresenceOverlay,{children:/* @__PURE__ */jsx(Box,{padding:4,children:/* @__PURE__ */jsx(Stack,{space:5,children:withImageTool&&(value==null?void 0:value.asset)&&/* @__PURE__ */jsx(ImageToolInput,_objectSpread(_objectSpread({},this.props),{},{imageUrl:imageUrlBuilder.image(value.asset).url(),value,presence:hotspotInputProps.presence,changed}))})})})});};this.renderPreview=()=>{const{value,schemaType,readOnly,directUploads,imageUrlBuilder,resolveUploader}=this.props;if(!value||!isImageSource(value)){return null;}const{hoveringFiles}=this.state;const acceptedFiles=hoveringFiles.filter(file=>resolveUploader(schemaType,file));const rejectedFilesCount=hoveringFiles.length-acceptedFiles.length;const imageUrl=imageUrlBuilder.width(2e3).fit("max").image(value).dpr(getDevicePixelRatio()).auto("format").url();return/* @__PURE__ */jsx(ImagePreview,{drag:!(value==null?void 0:value._upload)&&hoveringFiles.length>0,isRejected:rejectedFilesCount>0||!directUploads,readOnly,src:imageUrl,alt:"Preview of uploaded image"});};this.setToast=toast=>{this.toast=toast;};this._assetPath=props.path.concat(ASSET_FIELD_PATH$1);}focus(){if(this._assetElementRef){this._assetElementRef.focus();}}isImageToolEnabled(){return get$2(this.props.schemaType,"options.hotspot")===true;}clearUploadStatus(){var _a;if((_a=this.props.value)==null?void 0:_a._upload){this.props.onChange(unset(["_upload"]));}}cancelUpload(){if(this.uploadSubscription){this.uploadSubscription.unsubscribe();this.clearUploadStatus();}}uploadFirstAccepted(files){const{schemaType,resolveUploader}=this.props;const match=files.map(file=>({file,uploader:resolveUploader(schemaType,file)})).find(result=>result.uploader);if(match){this.uploadWith(match.uploader,match.file);}this.setState({isMenuOpen:false});}renderAssetMenu(){const{value,assetSources,schemaType,readOnly,directUploads,imageUrlBuilder,observeAsset}=this.props;const{isMenuOpen}=this.state;const asset=value==null?void 0:value.asset;if(!asset){return null;}const accept=get$2(schemaType,"options.accept","image/*");const showAdvancedEditButton=value&&asset&&this.isImageToolEnabled();let browseMenuItem=assetSources&&assetSources.length===0?null:/* @__PURE__ */jsx(MenuItem,{icon:SearchIcon,text:"Select",onClick:()=>{this.setState({isMenuOpen:false});this.handleSelectImageFromAssetSource(assetSources[0]);},disabled:readOnly,"data-testid":"file-input-browse-button"});if(assetSources&&assetSources.length>1){browseMenuItem=assetSources.map(assetSource=>{return/* @__PURE__ */jsx(MenuItem,{text:assetSource.title,onClick:()=>{this.setState({isMenuOpen:false});this.handleSelectImageFromAssetSource(assetSource);},icon:assetSource.icon||ImageIcon,"data-testid":"file-input-browse-button-".concat(assetSource.name),disabled:readOnly},assetSource.name);});}return/* @__PURE__ */jsx(WithReferencedAsset,{observeAsset,reference:asset,children:_ref402=>{let{_id,originalFilename,extension}=_ref402;let copyUrl;let downloadUrl;if(isImageSource(value)){const filename=originalFilename||"download.".concat(extension);downloadUrl=imageUrlBuilder.image(_id).forceDownload(filename).url();copyUrl=imageUrlBuilder.image(_id).url();}return/* @__PURE__ */jsx(ImageActionsMenu,{isMenuOpen,onEdit:this.handleOpenDialog,showEdit:showAdvancedEditButton,onMenuOpen:isOpen=>this.setState({isMenuOpen:isOpen}),children:/* @__PURE__ */jsx(ActionsMenu,{onUpload:this.handleSelectFiles,browse:browseMenuItem,onReset:this.handleRemoveButtonClick,downloadUrl,copyUrl,readOnly,directUploads,accept})});}});}renderBrowser(){const{assetSources,readOnly,directUploads,id}=this.props;if(assetSources&&assetSources.length===0)return null;if(assetSources&&assetSources.length>1&&!readOnly&&directUploads){return/* @__PURE__ */jsx(MenuButton,{id:"".concat(id,"_assetImageButton"),button:/* @__PURE__ */jsx(Button,{mode:"ghost",text:"Select","data-testid":"file-input-multi-browse-button",icon:SearchIcon,iconRight:ChevronDownIcon}),menu:/* @__PURE__ */jsx(Menu,{children:assetSources.map(assetSource=>{return/* @__PURE__ */jsx(MenuItem,{text:assetSource.title,onClick:()=>{this.setState({isMenuOpen:false});this.handleSelectImageFromAssetSource(assetSource);},icon:assetSource.icon||ImageIcon,disabled:readOnly,"data-testid":"file-input-browse-button-".concat(assetSource.name)},assetSource.name);})}),popover:ASSET_IMAGE_MENU_POPOVER});}return/* @__PURE__ */jsx(Button,{fontSize:2,text:"Select",icon:SearchIcon,mode:"ghost",onClick:()=>{this.setState({isMenuOpen:false});this.handleSelectImageFromAssetSource(assetSources[0]);},"data-testid":"file-input-browse-button",disabled:readOnly});}renderUploadPlaceholder(){const{schemaType,readOnly,directUploads,resolveUploader}=this.props;const{hoveringFiles}=this.state;const acceptedFiles=hoveringFiles.filter(file=>resolveUploader(schemaType,file));const rejectedFilesCount=hoveringFiles.length-acceptedFiles.length;const accept=get$2(schemaType,"options.accept","image/*");return/* @__PURE__ */jsx("div",{style:{padding:1},children:/* @__PURE__ */jsx(Card,{tone:readOnly?"transparent":"inherit",border:true,padding:3,style:hoveringFiles.length===0?{borderStyle:"dashed"}:{borderStyle:"dashed",borderColor:"transparent"},children:/* @__PURE__ */jsx(UploadPlaceholder,{browse:this.renderBrowser(),onUpload:this.handleSelectFiles,readOnly,hoveringFiles,acceptedFiles,rejectedFilesCount,type:"image",accept,directUploads})})});}renderUploadState(uploadState){var _a;const{isUploading}=this.state;const elementHeight=(_a=this._assetElementRef)==null?void 0:_a.offsetHeight;const height=elementHeight===0?void 0:elementHeight;return/* @__PURE__ */jsx(UploadProgress,{uploadState,onCancel:isUploading?this.handleCancelUpload:void 0,onStale:this.handleStaleUpload,height});}renderAssetSource(){const{selectedAssetSource}=this.state;const{value,observeAsset}=this.props;if(!selectedAssetSource){return null;}const Component=selectedAssetSource.component;if(value&&value.asset){return/* @__PURE__ */jsx(WithReferencedAsset,{observeAsset,reference:value.asset,children:imageAsset=>/* @__PURE__ */jsx(Component,{selectedAssets:[imageAsset],assetType:"image",selectionType:"single",onClose:this.handleAssetSourceClosed,onSelect:this.handleSelectAssetFromSource})});}return/* @__PURE__ */jsx(Component,{selectedAssets:[],selectionType:"single",assetType:"image",onClose:this.handleAssetSourceClosed,onSelect:this.handleSelectAssetFromSource});}getFileTone(){const{schemaType,value,readOnly,directUploads,resolveUploader}=this.props;const{hoveringFiles}=this.state;const acceptedFiles=hoveringFiles.filter(file=>resolveUploader(schemaType,file));const rejectedFilesCount=hoveringFiles.length-acceptedFiles.length;if(hoveringFiles.length>0){if(rejectedFilesCount>0||!directUploads){return"critical";}}if(!(value==null?void 0:value._upload)&&!readOnly&&hoveringFiles.length>0){return"primary";}if(readOnly){return"transparent";}return(value==null?void 0:value._upload)&&(value==null?void 0:value.asset)?"transparent":"default";}renderAsset(){const{value,readOnly,elementProps}=this.props;const{hoveringFiles,isStale}=this.state;const hasValueOrUpload=Boolean((value==null?void 0:value._upload)||(value==null?void 0:value.asset));if(value&&typeof value.asset!=="undefined"&&!(value==null?void 0:value._upload)&&!isImageSource(value)){return()=>/* @__PURE__ */jsx(InvalidImageWarning,{onClearValue:this.handleClearField});}return inputProps=>/* @__PURE__ */jsxs(Fragment,{children:[isStale&&/* @__PURE__ */jsx(Box,{marginBottom:2,children:/* @__PURE__ */jsx(UploadWarning,{onClearStale:this.handleClearUploadState})}),/* @__PURE__ */jsxs(ChangeIndicator,{path:inputProps.path.concat(ASSET_FIELD_PATH$1),hasFocus:!!inputProps.focused,isChanged:inputProps.changed,children:[!(value==null?void 0:value._upload)&&/* @__PURE__ */jsxs(FileTarget,_objectSpread(_objectSpread({},elementProps),{},{tabIndex:0,disabled:Boolean(readOnly),ref:this.setFocusElement,onFiles:this.handleSelectFiles,onFilesOver:this.handleFilesOver,onFilesOut:this.handleFilesOut,tone:this.getFileTone(),$border:hasValueOrUpload||hoveringFiles.length>0,style:{padding:1},sizing:"border",radius:2,children:[!(value==null?void 0:value.asset)&&this.renderUploadPlaceholder(),!(value==null?void 0:value._upload)&&(value==null?void 0:value.asset)&&/* @__PURE__ */jsxs("div",{style:{position:"relative"},children:[this.renderAssetMenu(),this.renderPreview()]})]})),(value==null?void 0:value._upload)&&this.renderUploadState(value._upload)]})]});}render(){const{members,renderInput,renderField,renderItem,renderPreview}=this.props;const{selectedAssetSource}=this.state;const hotspotField=members.find(member=>member.kind==="field"&&member.name==="hotspot");return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(ImperativeToast,{ref:this.setToast}),members.map(member=>{if(member.kind==="field"&&(member.name==="crop"||member.name==="hotspot")){return null;}if(member.kind==="field"){return/* @__PURE__ */jsx(MemberField,{member,renderInput:member.name==="asset"?this.renderAsset():renderInput,renderField:member.name==="asset"?passThrough$1:renderField,renderItem,renderPreview},member.key);}if(member.kind==="fieldSet"){return/* @__PURE__ */jsx(MemberFieldSet,{member,renderInput,renderField,renderItem,renderPreview},member.key);}if(member.kind==="error"){return/* @__PURE__ */jsx(MemberFieldError,{member});}return/* @__PURE__ */jsxs(Fragment,{children:["Unknown member kind: $",member.kind]});}),(hotspotField==null?void 0:hotspotField.open)&&/* @__PURE__ */jsx(FormInput,_objectSpread(_objectSpread({},this.props),{},{absolutePath:hotspotField.field.path,renderInput:this.renderHotspotInput})),selectedAssetSource&&this.renderAssetSource()]});}}function StudioImageInput(props){var _a;const sourcesFromSchema=(_a=props.schemaType.options)==null?void 0:_a.sources;const{image}=useFormBuilder().__internal;const documentPreviewStore=useDocumentPreviewStore();const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const formBuilder=useFormBuilder();const supportsImageUploads=formBuilder.__internal.image.directUploads;const resolveUploader$1=useCallback((type,file)=>{if(!supportsImageUploads){return null;}return resolveUploader(type,file);},[supportsImageUploads]);const assetSources=React.useMemo(()=>sourcesFromSchema||image.assetSources,[image,sourcesFromSchema]);const builder=React.useMemo(()=>imageUrlBuilder(client),[client]);const observeAsset=useCallback(id=>observeImageAsset(documentPreviewStore,id),[documentPreviewStore]);return/* @__PURE__ */jsx(ImageInput,_objectSpread(_objectSpread({},props),{},{client,assetSources,directUploads:image.directUploads,imageUrlBuilder:builder,observeAsset,resolveUploader:resolveUploader$1}));}const CardOverlay=styled(Card)(_templateObject325||(_templateObject325=_taggedTemplateLiteral(["\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n"])));const FlexContainer=styled(Flex)(_templateObject326||(_templateObject326=_taggedTemplateLiteral(["\n  height: 100%;\n"])));function formatBytes(bytes){let decimals=arguments.length>1&&arguments[1]!==undefined?arguments[1]:2;if(bytes===0)return"0 Bytes";const k=1024;const dm=decimals<0?0:decimals;const sizes=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"];const i=Math.floor(Math.log(bytes)/Math.log(k));return"".concat(parseFloat((bytes/Math.pow(k,i)).toFixed(dm))," ").concat(sizes[i]);}function FileDetails(props){const{originalFilename,size,children,muted,disabled,onClick,isMenuOpen,onMenuOpen}=props;const[menuElement,setMenuRef]=useState(null);const handleClick=React.useCallback(()=>onMenuOpen(true),[onMenuOpen]);useClickOutside(React.useCallback(()=>onMenuOpen(false),[onMenuOpen]),[menuElement]);return/* @__PURE__ */jsxs(Flex,{wrap:"nowrap",justify:"space-between",align:"center",children:[/* @__PURE__ */jsx(Card,{as:muted||disabled?void 0:"button",tabIndex:disabled?void 0:0,__unstable_focusRing:true,radius:2,padding:2,tone:"inherit",onClick,children:/* @__PURE__ */jsxs(Flex,{wrap:"nowrap",align:"center",children:[/* @__PURE__ */jsx(Card,{padding:3,tone:"transparent",shadow:1,radius:1,children:/* @__PURE__ */jsx(Text$1,{muted,children:/* @__PURE__ */jsx(BinaryDocumentIcon,{})})}),/* @__PURE__ */jsxs(Stack,{flex:1,space:2,marginLeft:3,children:[/* @__PURE__ */jsx(Text$1,{size:2,textOverflow:"ellipsis",muted,"data-testid":"file-name",children:originalFilename}),/* @__PURE__ */jsx(Text$1,{size:1,muted:true,"data-testid":"file-size",children:formatBytes(size)})]})]})}),/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Flex,{justify:"center",children:/* @__PURE__ */jsx(Popover,{content:/* @__PURE__ */jsx(Menu,{ref:setMenuRef,children}),portal:true,open:isMenuOpen,children:/* @__PURE__ */jsx(Button,{icon:EllipsisVerticalIcon,mode:"bleed","data-testid":"options-menu-button",onClick:handleClick})})})})]});}function FileSkeleton(){return/* @__PURE__ */jsxs(Flex,{align:"center",justify:"flex-start",padding:2,children:[/* @__PURE__ */jsx(Skeleton,{padding:3,radius:1,animated:true}),/* @__PURE__ */jsxs(Stack,{flex:1,space:2,marginLeft:3,children:[/* @__PURE__ */jsx(LabelSkeleton,{style:{width:"100%"},radius:1,animated:true}),/* @__PURE__ */jsx(LabelSkeleton,{style:{width:"100%"},radius:1,animated:true})]})]});}const ButtonWrapper=styled(Button)(_templateObject327||(_templateObject327=_taggedTemplateLiteral(["\n  width: 100%;\n"])));function InvalidFileWarning(_ref403){let{onClearValue}=_ref403;return/* @__PURE__ */jsxs(Card,{tone:"caution",padding:4,border:true,radius:2,children:[/* @__PURE__ */jsxs(Flex,{gap:4,marginBottom:4,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(WarningOutlineIcon,{})})}),/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:"Invalid file value"}),/* @__PURE__ */jsx(Text$1,{size:1,children:"The value of this field is not a valid file. Resetting this field will let you choose a new file."})]})]}),/* @__PURE__ */jsx(ButtonWrapper,{icon:ResetIcon,text:"Reset value",onClick:onClearValue,mode:"ghost"})]});}function passThrough(_ref404){let{children}=_ref404;return children;}const ASSET_FIELD_PATH=["asset"];class FileInput extends React.PureComponent{constructor(props){var _this2;super(props);_this2=this;this._focusRef=null;this.uploadSubscription=null;this.state={isUploading:false,selectedAssetSource:null,hoveringFiles:[],isStale:false,isMenuOpen:false};this.toast=null;this.handleRemoveButtonClick=()=>{const{path,value}=this.props;const parentPathSegment=path.slice(-1)[0];const isArrayElement=typeof parentPathSegment!=="string";const allKeys=Object.keys(value||{});const remainingKeys=allKeys.filter(key=>!["_type","_key","_upload","asset"].includes(key));const isEmpty=remainingKeys.length===0;const removeKeys=["asset"].concat(allKeys.filter(key=>["_upload"].includes(key))).map(key=>unset([key]));this.props.onChange(PatchEvent.from(isEmpty&&!isArrayElement?unset():removeKeys));};this.handleCancelUpload=()=>{this.cancelUpload();};this.handleClearUploadState=()=>{this.setState({isStale:false});this.clearUploadStatus();};this.handleStaleUpload=()=>{this.setState({isStale:true});};this.handleClearField=()=>{this.props.onChange(unset(["asset"]));};this.handleSelectFiles=files=>{const{directUploads,readOnly}=this.props;const{hoveringFiles}=this.state;if(directUploads&&!readOnly){this.uploadFirstAccepted(files);}else if(hoveringFiles.length>0){this.handleFilesOut();}};this.handleSelectFileFromAssetSource=source=>{this.setState({selectedAssetSource:source});};this.handleAssetSourceClosed=()=>{this.setState({selectedAssetSource:null});};this.uploadWith=function(uploader,file){let assetDocumentProps=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};const{schemaType,onChange,client}=_this2.props;const{source}=assetDocumentProps;const options={metadata:get$2(schemaType,"options.metadata"),storeOriginalFilename:get$2(schemaType,"options.storeOriginalFilename"),source};_this2.cancelUpload();_this2.setState({isUploading:true});onChange(PatchEvent.from([setIfMissing({_type:schemaType.name})]));_this2.uploadSubscription=uploader.upload(client,file,schemaType,options).subscribe({next:uploadEvent=>{if(uploadEvent.patches){onChange(PatchEvent.from(uploadEvent.patches));}},error:err=>{var _a;console.error(err);(_a=_this2.toast)==null?void 0:_a.push({status:"error",description:"The upload could not be completed at this time.",title:"Upload failed"});_this2.clearUploadStatus();},complete:()=>{_this2.setState({isUploading:false});}});};this.handleSelectAssetFromSource=assetFromSource=>{const{onChange,schemaType,resolveUploader}=this.props;handleSelectAssetFromSource({assetFromSource,onChange,type:schemaType,resolveUploader,uploadWith:this.uploadWith});this.setState({selectedAssetSource:null});};this.handleFileTargetFocus=event=>{if(event.currentTarget===event.target&&event.currentTarget===this._focusRef){this.props.onFocusPath(["asset"]);}};this.handleFilesOver=fileInfo=>{this.setState({hoveringFiles:fileInfo});};this.handleFilesOut=()=>{this.setState({hoveringFiles:[]});};this.setFocusElement=ref=>{this._focusRef=ref;};this.handleUpload=_ref405=>{let{file,uploader}=_ref405;this.uploadWith(uploader,file);};this.setToast=toast=>{this.toast=toast;};this._assetFieldPath=props.path.concat(ASSET_FIELD_PATH);}clearUploadStatus(){var _a;if((_a=this.props.value)==null?void 0:_a._upload){this.props.onChange(PatchEvent.from([unset(["_upload"])]));}}cancelUpload(){if(this.uploadSubscription){this.uploadSubscription.unsubscribe();this.clearUploadStatus();}}uploadFirstAccepted(files){const{schemaType}=this.props;const match=files.map(file=>{var _a,_b;return{file,uploader:(_b=(_a=this.props).resolveUploader)==null?void 0:_b.call(_a,schemaType,file)};}).find(result=>result.uploader);if(match){this.uploadWith(match.uploader,match.file);}this.setState({isMenuOpen:false});}renderUploadState(uploadState){const{isUploading}=this.state;return/* @__PURE__ */jsx(UploadProgress,{uploadState,onCancel:isUploading?this.handleCancelUpload:void 0,onStale:this.handleStaleUpload});}renderAssetSource(){const{selectedAssetSource}=this.state;const{value,observeAsset}=this.props;if(!selectedAssetSource){return null;}const Component=selectedAssetSource.component;if(value&&value.asset){return/* @__PURE__ */jsx(WithReferencedAsset,{observeAsset,reference:value.asset,waitPlaceholder:/* @__PURE__ */jsx(FileSkeleton,{}),children:fileAsset=>/* @__PURE__ */jsx(Component,{selectedAssets:[fileAsset],selectionType:"single",assetType:"file",dialogHeaderTitle:"Select file",onClose:this.handleAssetSourceClosed,onSelect:this.handleSelectAssetFromSource})});}return/* @__PURE__ */jsx(Component,{selectedAssets:[],selectionType:"single",assetType:"file",dialogHeaderTitle:"Select file",onClose:this.handleAssetSourceClosed,onSelect:this.handleSelectAssetFromSource});}hasFileTargetFocus(){var _a;return((_a=this.props.focusPath)==null?void 0:_a[0])==="asset";}renderAsset(){const{value,changed,readOnly,elementProps}=this.props;const{hoveringFiles,isStale}=this.state;const hasValueOrUpload=Boolean((value==null?void 0:value._upload)||(value==null?void 0:value.asset));if(value&&typeof value.asset!=="undefined"&&!(value==null?void 0:value._upload)&&!isFileSource(value)){return()=>/* @__PURE__ */jsx(InvalidFileWarning,{onClearValue:this.handleClearField});}return inputProps=>/* @__PURE__ */jsxs(Fragment,{children:[isStale&&/* @__PURE__ */jsx(Box,{marginBottom:2,children:/* @__PURE__ */jsx(UploadWarning,{onClearStale:this.handleClearUploadState})}),/* @__PURE__ */jsxs(ChangeIndicator,{path:this._assetFieldPath,hasFocus:!!inputProps.focused,isChanged:changed,children:[!(value==null?void 0:value._upload)&&/* @__PURE__ */jsx(FileTarget,_objectSpread(_objectSpread({},elementProps),{},{tabIndex:0,disabled:Boolean(readOnly),ref:this.setFocusElement,onFiles:this.handleSelectFiles,onFilesOver:this.handleFilesOver,onFilesOut:this.handleFilesOut,tone:this.getFileTone(),$border:hasValueOrUpload||hoveringFiles.length>0,style:{padding:1},sizing:"border",radius:2,children:/* @__PURE__ */jsxs("div",{style:{position:"relative"},children:[!(value==null?void 0:value.asset)&&this.renderUploadPlaceholder(),(value==null?void 0:value.asset)&&hoveringFiles.length>0?this.renderAssetMenu(this.getFileTone()):null,!(value==null?void 0:value._upload)&&(value==null?void 0:value.asset)&&this.renderPreview()]})})),(value==null?void 0:value._upload)&&this.renderUploadState(value._upload)]})]});}renderPreview(){const{value,readOnly,assetSources,schemaType,directUploads,observeAsset}=this.props;const{isMenuOpen}=this.state;const asset=value==null?void 0:value.asset;if(!asset){return null;}const accept=get$2(schemaType,"options.accept","");let browseMenuItem=assetSources&&(assetSources==null?void 0:assetSources.length)===0?null:/* @__PURE__ */jsx(MenuItem,{icon:SearchIcon,text:"Browse",onClick:()=>{this.setState({isMenuOpen:false});this.handleSelectFileFromAssetSource(assetSources[0]);},disabled:readOnly,"data-testid":"file-input-browse-button"});if(assetSources.length>1){browseMenuItem=assetSources.map(assetSource=>{return/* @__PURE__ */jsx(MenuItem,{text:assetSource.title,onClick:()=>{this.setState({isMenuOpen:false});this.handleSelectFileFromAssetSource(assetSource);},icon:assetSource.icon||ImageIcon,disabled:readOnly,"data-testid":"file-input-browse-button-".concat(assetSource.name)},assetSource.name);});}return/* @__PURE__ */jsx(WithReferencedAsset,{reference:asset,observeAsset,waitPlaceholder:/* @__PURE__ */jsx(FileSkeleton,{}),children:_ref406=>{let{originalFilename,extension,url,size}=_ref406;const filename=originalFilename||"download.".concat(extension);let copyUrl;let downloadUrl;if(isFileSource(value)){downloadUrl="".concat(url,"?dl");copyUrl=url;}return/* @__PURE__ */jsx(FileDetails,{size,originalFilename:filename,muted:!readOnly,onMenuOpen:isOpen=>this.setState({isMenuOpen:isOpen}),isMenuOpen,children:/* @__PURE__ */jsx(ActionsMenu,{onUpload:this.handleSelectFiles,browse:browseMenuItem,onReset:this.handleRemoveButtonClick,downloadUrl,copyUrl,readOnly,accept,directUploads})});}});}renderAssetMenu(tone){const{schemaType,readOnly,directUploads,resolveUploader}=this.props;const{hoveringFiles}=this.state;const acceptedFiles=hoveringFiles.filter(file=>resolveUploader==null?void 0:resolveUploader(schemaType,file));const rejectedFilesCount=hoveringFiles.length-acceptedFiles.length;return/* @__PURE__ */jsx(CardOverlay,{tone,children:/* @__PURE__ */jsx(FlexContainer,{align:"center",justify:"center",gap:2,flex:1,children:/* @__PURE__ */jsx(PlaceholderText,{readOnly,hoveringFiles,acceptedFiles,rejectedFilesCount,directUploads,type:"file"})})});}renderBrowser(){const{assetSources,readOnly,directUploads,id}=this.props;if(assetSources.length===0)return null;if(assetSources.length>1&&!readOnly&&directUploads){return/* @__PURE__ */jsx(MenuButton,{id:"".concat(id,"_assetFileButton"),button:/* @__PURE__ */jsx(Button,{mode:"ghost",text:"Select","data-testid":"file-input-multi-browse-button",icon:SearchIcon}),"data-testid":"input-select-button",menu:/* @__PURE__ */jsx(Menu,{children:assetSources.map(assetSource=>{return/* @__PURE__ */jsx(MenuItem,{text:assetSource.title,onClick:()=>{this.setState({isMenuOpen:false});this.handleSelectFileFromAssetSource(assetSource);},icon:assetSource.icon||ImageIcon,disabled:readOnly,"data-testid":"file-input-browse-button-".concat(assetSource.name)},assetSource.name);})})});}return/* @__PURE__ */jsx(Button,{fontSize:2,text:"Browse",icon:SearchIcon,mode:"ghost",onClick:()=>{this.setState({isMenuOpen:false});this.handleSelectFileFromAssetSource(assetSources[0]);},"data-testid":"file-input-browse-button",disabled:readOnly});}renderUploadPlaceholder(){const{readOnly,schemaType,directUploads,resolveUploader}=this.props;const{hoveringFiles}=this.state;const acceptedFiles=hoveringFiles.filter(file=>resolveUploader==null?void 0:resolveUploader(schemaType,file));const rejectedFilesCount=hoveringFiles.length-acceptedFiles.length;const accept=get$2(schemaType,"options.accept","");return/* @__PURE__ */jsx("div",{style:{padding:1},children:/* @__PURE__ */jsx(Card,{tone:readOnly?"transparent":"inherit",border:true,padding:3,style:hoveringFiles.length===0?{borderStyle:"dashed"}:{borderStyle:"dashed",borderColor:"transparent"},children:/* @__PURE__ */jsx(UploadPlaceholder,{browse:this.renderBrowser(),onUpload:this.handleSelectFiles,readOnly,hoveringFiles,acceptedFiles,rejectedFilesCount,type:"file",accept,directUploads})})});}focus(){if(this._focusRef){this._focusRef.focus();}}getFileTone(){const{directUploads,schemaType,value,readOnly,resolveUploader}=this.props;const{hoveringFiles}=this.state;const acceptedFiles=hoveringFiles.filter(file=>resolveUploader==null?void 0:resolveUploader(schemaType,file));const rejectedFilesCount=hoveringFiles.length-acceptedFiles.length;if(hoveringFiles.length>0){if(rejectedFilesCount>0||!directUploads){return"critical";}}if(!(value==null?void 0:value._upload)&&!readOnly&&hoveringFiles.length>0){return"primary";}return(value==null?void 0:value._upload)&&(value==null?void 0:value.asset)&&readOnly?"transparent":"default";}render(){const{members,renderItem,renderInput,renderField,renderPreview}=this.props;const{selectedAssetSource}=this.state;return/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(ImperativeToast,{ref:this.setToast}),members.map(member=>{if(member.kind==="field"&&(member.name==="crop"||member.name==="hotspot")){return null;}if(member.kind==="field"){return/* @__PURE__ */jsx(MemberField,{member,renderInput:member.name==="asset"?this.renderAsset():renderInput,renderField:member.name==="asset"?passThrough:renderField,renderItem,renderPreview},member.key);}if(member.kind==="fieldSet"){return/* @__PURE__ */jsx(MemberFieldSet,{member,renderInput,renderField,renderItem,renderPreview},member.key);}if(member.kind==="error"){return/* @__PURE__ */jsx(MemberFieldError,{member});}return/* @__PURE__ */jsxs(Fragment,{children:["Unknown member kind: $",member.kind]});}),selectedAssetSource&&this.renderAssetSource()]});}}function StudioFileInput(props){var _a;const sourcesFromSchema=(_a=props.schemaType.options)==null?void 0:_a.sources;const documentPreviewStore=useDocumentPreviewStore();const{file:fileConfig}=useFormBuilder().__internal;const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const resolveUploader$1=useCallback((type,file)=>{if(!fileConfig.directUploads){return null;}return resolveUploader(type,file);},[fileConfig.directUploads]);const assetSources=useMemo(()=>sourcesFromSchema||fileConfig.assetSources,[fileConfig,sourcesFromSchema]);const observeAsset=useCallback(id=>observeFileAsset(documentPreviewStore,id),[documentPreviewStore]);return/* @__PURE__ */jsx(FileInput,_objectSpread(_objectSpread({},props),{},{client,assetSources,directUploads:fileConfig.directUploads,observeAsset,resolveUploader:resolveUploader$1}));}const noop=()=>{};const INITIAL_LOADING_STATE={isLoading:true,result:void 0,error:void 0,retry:noop};const EMPTY_STATE={isLoading:false,result:void 0,error:void 0,retry:noop};function useReferenceInfo(doc,getReferenceInfo){const[retryAttempt,setRetryAttempt]=useState(0);const retry=useCallback(()=>{setRetryAttempt(current=>current+1);},[]);const referenceInfo=useMemoObservable(()=>doc._id?getReferenceInfo(doc).pipe(map(result=>({isLoading:false,result,error:void 0,retry})),startWith(INITIAL_LOADING_STATE),catchError(err=>{console.error(err);return of({isLoading:false,result:void 0,error:err,retry});})):of(EMPTY_STATE),[retryAttempt,getReferenceInfo,doc==null?void 0:doc._id,doc==null?void 0:doc._type,retry],INITIAL_LOADING_STATE);const previousId=usePrevious(doc._id,doc._id);if(previousId!==doc._id){return INITIAL_LOADING_STATE;}return referenceInfo;}function UnavailableMessage(props){const Icon=props.icon;return/* @__PURE__ */jsxs(Flex,{padding:3,children:[/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Text$1,{size:1,children:/* @__PURE__ */jsx(Icon,{})})}),/* @__PURE__ */jsxs(Box,{flex:1,marginLeft:3,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:props.title}),/* @__PURE__ */jsx(Box,{marginTop:3,children:/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:props.children})})]})]});}function CrossDatasetReferencePreview(props){var _a,_b,_c;const{refType,showStudioUrlIcon,hasStudioUrl,showTypeLabel,availability,preview,id,dataset,projectId}=props;const notFound=(availability==null?void 0:availability.reason)==="NOT_FOUND";const insufficientPermissions=(availability==null?void 0:availability.reason)==="PERMISSION_DENIED";const previewMedia=(_a=preview.published)==null?void 0:_a.media;const media=useMemo(()=>{if(previewMedia){return function MediaPreview(_ref407){let{dimensions}=_ref407;return React.isValidElement(previewMedia)?previewMedia:/* @__PURE__ */jsx("img",{src:imageUrlBuilder({dataset,projectId}).image(previewMedia).withOptions(dimensions).url(),alt:"Image preview of referenced document",referrerPolicy:"strict-origin-when-cross-origin"});};}return(refType==null?void 0:refType.icon)?createElement(refType.icon):null;},[previewMedia,dataset,projectId,refType==null?void 0:refType.icon]);return/* @__PURE__ */jsxs(Flex,{align:"center","data-testid":"preview",children:[(availability==null?void 0:availability.available)?/* @__PURE__ */jsx(Box,{flex:1,paddingX:2,paddingY:1,children:/* @__PURE__ */jsx(DefaultPreview,{title:(_b=preview.published)==null?void 0:_b.title,subtitle:(_c=preview.published)==null?void 0:_c.subtitle,media:media||false})}):/* @__PURE__ */jsx(Box,{flex:1,padding:2,children:/* @__PURE__ */jsx(Flex,{align:"center",justify:"center",children:/* @__PURE__ */jsx(Box,{flex:1,paddingY:2,children:/* @__PURE__ */jsx(Text$1,{muted:true,children:"Document unavailable"})})})}),/* @__PURE__ */jsx(Box,{paddingLeft:3,children:/* @__PURE__ */jsxs(Inline,{space:4,children:[refType&&showTypeLabel&&/* @__PURE__ */jsx(Label,{size:1,muted:true,children:refType.title||refType.type}),(insufficientPermissions||notFound)&&/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Tooltip,{portal:true,content:notFound?/* @__PURE__ */jsxs(UnavailableMessage,{title:"Not found",icon:HelpCircleIcon,children:["The referenced document does not exist",/* @__PURE__ */jsx("br",{}),"(id: ",/* @__PURE__ */jsx("code",{children:id}),")"]}):/* @__PURE__ */jsx(UnavailableMessage,{title:"Insufficient permissions",icon:AccessDeniedIcon,children:"The referenced document could not be accessed due to insufficient permissions"}),children:/* @__PURE__ */jsx(TextWithTone,{tone:"default",children:insufficientPermissions?/* @__PURE__ */jsx(AccessDeniedIcon,{}):/* @__PURE__ */jsx(HelpCircleIcon,{})})})}),!(notFound||insufficientPermissions)&&showStudioUrlIcon&&/* @__PURE__ */jsx(Box,{children:/* @__PURE__ */jsx(Tooltip,{portal:true,content:/* @__PURE__ */jsx(Box,{padding:2,children:hasStudioUrl?/* @__PURE__ */jsx(Text$1,{size:1,children:"This document opens in another Studio"}):/* @__PURE__ */jsx(Text$1,{size:1,children:"This document cannot be opened (unable to resolve URL to Studio)"})}),children:/* @__PURE__ */jsx(TextWithTone,{size:1,tone:"default",muted:!hasStudioUrl,children:/* @__PURE__ */jsx(LaunchIcon,{})})})})]})})]});}function OptionPreview(props){var _a;const{isLoading,result:referenceInfo,error}=useReferenceInfo(props.document,props.getReferenceInfo);if(isLoading){return/* @__PURE__ */jsxs(Stack,{space:2,padding:1,children:[/* @__PURE__ */jsx(TextSkeleton,{style:{maxWidth:320},radius:1,animated:true}),/* @__PURE__ */jsx(TextSkeleton,{style:{maxWidth:200},radius:1,size:1,animated:true})]});}if(error){return/* @__PURE__ */jsx(Stack,{space:2,padding:1,children:/* @__PURE__ */jsxs(Alert,{title:"Failed to load referenced document",children:["Error: ",error.message]})});}if(!referenceInfo){return null;}if(((_a=referenceInfo.availability)==null?void 0:_a.reason)==="PERMISSION_DENIED"){return/* @__PURE__ */jsx(Stack,{space:2,padding:1,children:"Insufficient permissions to view this document"});}const refType=props.referenceType.to.find(toEntry=>toEntry.type===referenceInfo.type);if(!refType){return/* @__PURE__ */jsxs(Stack,{space:2,padding:1,children:["Search returned a type that's not valid for this reference: \"$",referenceInfo.type,'"']});}return referenceInfo&&refType&&/* @__PURE__ */jsx(CrossDatasetReferencePreview,{id:referenceInfo.id,availability:referenceInfo.availability,preview:referenceInfo.preview,refType,dataset:props.referenceType.dataset,projectId:props.referenceType.projectId,showTypeLabel:props.referenceType.to.length>1});}function PreviewReferenceValue(props){var _a,_b;const{value,type,showStudioUrlIcon,hasStudioUrl,referenceInfo}=props;if(referenceInfo.isLoading||referenceInfo.error){return/* @__PURE__ */jsxs(Stack,{space:2,padding:1,children:[/* @__PURE__ */jsx(TextSkeleton,{style:{maxWidth:320},radius:1,animated:!referenceInfo.error}),/* @__PURE__ */jsx(TextSkeleton,{style:{maxWidth:200},radius:1,size:1,animated:!referenceInfo.error})]});}const showTypeLabel=type.to.length>1;const refTypeName=(_a=referenceInfo.result)==null?void 0:_a.type;const refType=type.to.find(toType=>toType.type===refTypeName);if(((_b=referenceInfo.result.availability)==null?void 0:_b.available)&&!refType){return/* @__PURE__ */jsx(Stack,{space:2,padding:2,children:/* @__PURE__ */jsxs(Text$1,{as:"p",children:["The referenced document is of invalid type: (",refTypeName||"unknown",")",/* @__PURE__ */jsx("pre",{children:JSON.stringify(value,null,2)})]})});}return/* @__PURE__ */jsx(CrossDatasetReferencePreview,{availability:referenceInfo.result.availability,hasStudioUrl,showStudioUrlIcon,preview:referenceInfo.result.preview,refType,projectId:type.projectId,dataset:type.dataset,id:value._ref,showTypeLabel});}const StyledPopover=styled(Popover)(_templateObject328||(_templateObject328=_taggedTemplateLiteral(["\n  & > div {\n    overflow: auto;\n    -webkit-overflow-scrolling: touch;\n  }\n"])));const StyledText=styled(Text$1)(_templateObject329||(_templateObject329=_taggedTemplateLiteral(["\n  word-break: break-word;\n"])));const ReferenceAutocomplete=forwardRef(function ReferenceAutocomplete2(props,ref){const hasResults=props.options&&props.options.length>0;const renderPopover=useCallback((_ref408,contentRef)=>{let{content,hidden,inputElement,onMouseEnter,onMouseLeave}=_ref408;return/* @__PURE__ */jsx(StyledPopover,{"data-testid":"autocomplete-popover",placement:"bottom-start",arrow:false,constrainSize:true,onMouseEnter,onMouseLeave,content:/* @__PURE__ */jsx("div",{ref:contentRef,children:hasResults?content:/* @__PURE__ */jsx(Box,{padding:4,children:/* @__PURE__ */jsx(Flex,{align:"center",height:"fill",justify:"center",children:/* @__PURE__ */jsxs(StyledText,{align:"center",muted:true,children:["No results for ",/* @__PURE__ */jsxs("strong",{children:["\u201C",props.searchString,"\u201D"]})]})})})}),open:!props.loading&&!hidden,ref:props.portalRef,portal:true,referenceElement:props.referenceElement||inputElement,matchReferenceWidth:true});},[hasResults,props.searchString,props.loading,props.portalRef,props.referenceElement]);return/* @__PURE__ */jsx(Autocomplete,_objectSpread(_objectSpread({},props),{},{ref,renderPopover}));});const PreviewCard=styled(Card)(_templateObject330||(_templateObject330=_taggedTemplateLiteral(["\n  /* this is a hack to avoid layout jumps while previews are loading\n  there's probably better ways of solving this */\n  min-height: 36px;\n\n  /* TextWithTone uses its own logic to set color, and we therefore need\n  to override this logic in order to set the correct color in different states */\n  &[data-selected],\n  &[data-pressed],\n  &:active {\n    [data-ui='TextWithTone'] {\n      color: inherit;\n    }\n  }\n"])));const INITIAL_SEARCH_STATE={hits:[],isLoading:false};const NO_FILTER=()=>true;const REF_PATH=["_ref"];function CrossDatasetReferenceInput(props){var _a,_b,_c;const{changed,focused,focusPath,getReferenceInfo,onChange,onFocusPath,onSearch,path,readOnly,schemaType,validation,value,elementProps}=props;const[searchState,setSearchState]=useState(INITIAL_SEARCH_STATE);const handleChange=useCallback(id=>{if(!id){onChange(unset());onFocusPath([]);return;}const hit=searchState.hits.find(h=>h.id===id);if(!hit){throw new Error("Selected an item that wasnt part of the result set");}onChange(set({_type:schemaType.name,_ref:getPublishedId(id),_projectId:schemaType.projectId,_dataset:schemaType.dataset,_weak:schemaType.weak,_key:value==null?void 0:value._key}));onFocusPath([]);},[value==null?void 0:value._key,searchState.hits,schemaType.name,schemaType.projectId,schemaType.dataset,schemaType.weak,onChange,onFocusPath]);const handleClear=useCallback(()=>{onChange(unset());},[onChange]);const handleAutocompleteKeyDown=useCallback(event=>{if(event.keyCode===27){onFocusPath==null?void 0:onFocusPath([]);}},[onFocusPath]);const getReferenceInfoMemo=useCallback(doc=>getReferenceInfo(doc,schemaType),[getReferenceInfo,schemaType]);const refDoc=useMemo(()=>({_id:value==null?void 0:value._ref}),[value==null?void 0:value._ref]);const loadableReferenceInfo=useReferenceInfo(refDoc,getReferenceInfoMemo);const autocompletePopoverReferenceElementRef=useRef(null);const hasFocusAtRef=focusPath.length===1&&focusPath[0]==="_ref";const weakIs=(value==null?void 0:value._weak)?"weak":"strong";const weakShouldBe=schemaType.weak===true?"weak":"strong";const hasRef=Boolean(value==null?void 0:value._ref);const handleFixStrengthMismatch=useCallback(()=>{onChange(schemaType.weak===true?set(true,["_weak"]):unset(["_weak"]));},[onChange,schemaType]);const{push}=useToast();const errors=useMemo(()=>validation.filter(item=>item.level==="error"),[validation]);const handleFocus=useCallback(event=>{if(onFocusPath&&event.currentTarget===elementProps.ref.current){onFocusPath([]);}},[elementProps.ref,onFocusPath]);const handleAutocompleteFocus=useCallback(event=>{if(onFocusPath&&event.currentTarget===elementProps.ref.current){onFocusPath(REF_PATH);}},[elementProps.ref,onFocusPath]);const handleQueryChange=useObservableCallback(inputValue$=>{return inputValue$.pipe(filter(isNonNullable),distinctUntilChanged(),switchMap(searchString=>concat(of({isLoading:true}),onSearch(searchString).pipe(map(hits=>({hits,searchString,isLoading:false})),catchError(error=>{push({title:"Reference search failed",description:error.message,status:"error",id:"reference-search-fail-".concat(inputId)});console.error(error);return of({hits:[]});})))),scan((prevState,nextState)=>_objectSpread(_objectSpread({},prevState),nextState),INITIAL_SEARCH_STATE),tap(setSearchState));},[]);const handleAutocompleteOpenButtonClick=useCallback(()=>{handleQueryChange("");},[handleQueryChange]);const showWeakRefMismatch=!loadableReferenceInfo.isLoading&&hasRef&&weakIs!==weakShouldBe;const inputId=useId();const studioUrl=(value==null?void 0:value._ref)&&((_b=schemaType.studioUrl)==null?void 0:_b.call(schemaType,{id:value==null?void 0:value._ref,type:(_a=loadableReferenceInfo==null?void 0:loadableReferenceInfo.result)==null?void 0:_a.type}))||null;const renderOption=useCallback(option=>{return/* @__PURE__ */jsx(PreviewCard,{forwardedAs:"button",type:"button",radius:2,children:/* @__PURE__ */jsx(Box,{paddingX:3,paddingY:1,children:/* @__PURE__ */jsx(OptionPreview,{referenceType:schemaType,document:option.hit.published,getReferenceInfo:getReferenceInfoMemo})})});},[schemaType,getReferenceInfoMemo]);const preview=(_c=loadableReferenceInfo.result)==null?void 0:_c.preview.published;const isEditing=hasFocusAtRef||!(value==null?void 0:value._ref);const clickOutsideBoundaryRef=useRef(null);const autocompletePortalRef=useRef(null);const createButtonMenuPortalRef=useRef(null);useOnClickOutside([clickOutsideBoundaryRef,autocompletePortalRef,createButtonMenuPortalRef],()=>{if(hasFocusAtRef){onFocusPath([]);}});return/* @__PURE__ */jsx(Stack,{space:1,marginY:isEditing?2:0,children:isEditing?/* @__PURE__ */jsx(Stack,{space:2,ref:clickOutsideBoundaryRef,children:/* @__PURE__ */jsx(ChangeIndicator,{path,isChanged:changed,hasFocus:!!focused,children:/* @__PURE__ */jsx("div",{ref:autocompletePopoverReferenceElementRef,children:/* @__PURE__ */jsx(ReferenceAutocomplete,_objectSpread(_objectSpread({},elementProps),{},{"data-testid":"autocomplete",loading:searchState.isLoading,referenceElement:autocompletePopoverReferenceElementRef.current,portalRef:autocompletePortalRef,id:inputId||"",options:searchState.hits.map(hit=>({value:hit.id,hit})),onFocus:handleAutocompleteFocus,radius:1,placeholder:"Type to search",onKeyDown:handleAutocompleteKeyDown,readOnly,disabled:loadableReferenceInfo.isLoading,onQueryChange:handleQueryChange,searchString:searchState.searchString,onChange:handleChange,filterOption:NO_FILTER,renderOption,openButton:{onClick:handleAutocompleteOpenButtonClick}}))})})}):/* @__PURE__ */jsx(ChangeIndicator,{path,isChanged:changed,hasFocus:!!focused,children:/* @__PURE__ */jsxs(Card,{padding:0,border:true,radius:1,tone:readOnly?"transparent":loadableReferenceInfo.error||errors.length>0?"critical":"default",children:[/* @__PURE__ */jsxs(Flex,{align:"center",padding:1,children:[studioUrl?/* @__PURE__ */jsx(PreviewCard,{forwardedAs:"a",target:"_blank",rel:"noopener noreferrer",href:studioUrl,"data-as":"a",flex:1,padding:1,paddingRight:3,radius:2,tone:"inherit",__unstable_focusRing:true,tabIndex:0,onFocus:handleFocus,ref:elementProps.ref,children:/* @__PURE__ */jsx(PreviewReferenceValue,{value,referenceInfo:loadableReferenceInfo,showStudioUrlIcon:true,hasStudioUrl:!!studioUrl,type:schemaType})}):/* @__PURE__ */jsx(PreviewCard,{flex:1,padding:1,paddingRight:3,radius:2,tone:"inherit",__unstable_focusRing:true,tabIndex:0,onFocus:handleFocus,ref:elementProps.ref,children:/* @__PURE__ */jsx(PreviewReferenceValue,{value,referenceInfo:loadableReferenceInfo,showStudioUrlIcon:true,type:schemaType})}),/* @__PURE__ */jsx(Inline,{paddingX:1,children:/* @__PURE__ */jsx(MenuButton,{button:/* @__PURE__ */jsx(Button,{padding:2,mode:"bleed",icon:EllipsisVerticalIcon,"data-testid":"menu-button"}),id:"".concat(inputId,"-menuButton"),menu:/* @__PURE__ */jsx(Menu,{children:!readOnly&&/* @__PURE__ */jsxs(Fragment,{children:[/* @__PURE__ */jsx(MenuItem,{text:"Clear",tone:"critical",icon:ResetIcon,"data-testid":"menu-item-clear",onClick:handleClear}),/* @__PURE__ */jsx(MenuItem,{text:"Replace",icon:SyncIcon,"data-testid":"menu-item-replace",onClick:()=>{onFocusPath(REF_PATH);}})]})}),placement:"right",popover:{portal:true,tone:"default"}})})]}),showWeakRefMismatch&&/* @__PURE__ */jsx(AlertStrip,{padding:1,title:"Reference strength mismatch",status:"warning","data-testid":"alert-reference-strength-mismatch",children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["This reference is ",/* @__PURE__ */jsx("em",{children:weakIs}),", but according to the current schema it should be ",/* @__PURE__ */jsxs("em",{children:[weakShouldBe,"."]})]}),/* @__PURE__ */jsx(Text$1,{as:"p",muted:true,size:1,children:schemaType.weak?/* @__PURE__ */jsxs(Fragment,{children:['It will not be possible to delete the "',preview==null?void 0:preview.title,'"-document without first removing this reference.']}):/* @__PURE__ */jsxs(Fragment,{children:['This makes it possible to delete the "',preview==null?void 0:preview.title,'"-document without first deleting this reference, leaving this field referencing a nonexisting document.']})}),/* @__PURE__ */jsx(Button,{onClick:handleFixStrengthMismatch,text:/* @__PURE__ */jsxs(Fragment,{children:["Convert to ",weakShouldBe," reference"]}),tone:"caution"})]})}),loadableReferenceInfo.error&&/* @__PURE__ */jsx(AlertStrip,{padding:1,title:"Unable to load reference metadata",status:"warning","data-testid":"alert-reference-info-failed",children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Text$1,{as:"p",muted:true,size:1,children:["Error: ",loadableReferenceInfo.error.message]}),/* @__PURE__ */jsx(Button,{onClick:loadableReferenceInfo.retry,text:/* @__PURE__ */jsx(Fragment,{children:"Retry"}),tone:"primary"})]})})]})})});}function search(client,textTerm,type,options){const searchWeighted=createWeightedSearch(type.to.map(crossDatasetType=>({name:crossDatasetType.type,__experimental_search:crossDatasetType.__experimental_search})),client,options);return searchWeighted(textTerm,{includeDrafts:false}).pipe(map(results=>results.map(result=>result.hit)),map(collate),map(collated=>collated.map(entry=>({id:entry.id,type:entry.type,published:entry.published}))));}const REQUEST_TAG_BASE="cross-dataset-refs";const AVAILABILITY_READABLE={available:true,reason:"READABLE"};const AVAILABILITY_PERMISSION_DENIED={available:false,reason:"PERMISSION_DENIED"};const AVAILABILITY_NOT_FOUND={available:false,reason:"NOT_FOUND"};function createGetReferenceInfo(context){const{client,documentPreviewStore}=context;const{dataset,projectId}=client.config();const apiConfig=dataset&&projectId?{dataset,projectId}:void 0;return function getReferenceInfo(doc,referenceType){return(doc._type?of(doc):documentPreviewStore.observeDocumentTypeFromId(doc._id,apiConfig).pipe(map(docType=>({_id:doc._id,_type:docType})))).pipe(switchMap(resolvedDoc=>{if(!resolvedDoc._type){return fetchDocumentAvailability(client,doc._id).pipe(map(availability=>({id:doc._id,type:void 0,availability,preview:{published:void 0}})));}const refSchemaType=referenceType.to.find(candidate=>candidate.type===resolvedDoc._type);const previewPaths=[...(getPreviewPaths(refSchemaType==null?void 0:refSchemaType.preview)||[]),["_updatedAt"],["_createdAt"]];const publishedPreview$=documentPreviewStore.observePaths(doc,previewPaths,apiConfig).pipe(map(result=>result?prepareForPreview(result,refSchemaType):result));return combineLatest([publishedPreview$]).pipe(map(_ref409=>{let[publishedPreview]=_ref409;return{type:resolvedDoc._type,id:doc._id,availability:AVAILABILITY_READABLE,preview:{published:isRecord$2(publishedPreview)?publishedPreview:void 0}};}));}));};}function fetchDocumentAvailability(client,id){const requestOptions={uri:client.getDataUrl("doc",id),json:true,query:{excludeContent:"true"},tag:"".concat(REQUEST_TAG_BASE,".availability")};return client.observable.request(requestOptions).pipe(map(response=>{const omitted=keyBy(response.omitted||[],entry=>entry.id);const omittedEntry=omitted[id];if(!omittedEntry){return AVAILABILITY_READABLE;}if(omittedEntry.reason==="existence"){return AVAILABILITY_NOT_FOUND;}if(omittedEntry.reason==="permission"){return AVAILABILITY_PERMISSION_DENIED;}return null;}));}function useCrossProjectToken(client,_ref410){let{projectId,tokenId}=_ref410;const documentPreviewStore=useDocumentPreviewStore();const crossProjectTokenStore=useCrossProjectTokenStore();return useMemoObservable(()=>{return documentPreviewStore.observePaths({_type:"reference",_ref:crossProjectTokenStore.getTokenDocumentId({projectId,tokenId})},["token"]).pipe(map(documentValue=>{const value=isRecord$2(documentValue)?documentValue:void 0;return{status:"loaded",result:typeof(value==null?void 0:value.token)==="string"?value==null?void 0:value.token:void 0};}),startWith({status:"loading"}));},[client,crossProjectTokenStore,documentPreviewStore,projectId,tokenId]);}async function resolveUserDefinedFilter(options,document,valuePath){if(!options){return{};}if(typeof options.filter==="function"){const parentPath=valuePath.slice(0,-1);const parent=get$3(document,parentPath);return options.filter({document,parentPath,parent});}return{filter:options.filter,params:"filterParams"in options?options.filterParams:void 0};}function useValueRef(value){const ref=useRef(value);ref.current=value;return ref;}function StudioCrossDatasetReferenceInput(props){const{path,schemaType}=props;const client=useClient(DEFAULT_STUDIO_CLIENT_OPTIONS);const projectId=useProjectId();const documentPreviewStore=useDocumentPreviewStore();const isCurrentProject=projectId===schemaType.projectId;const loadableToken=useCrossProjectToken(client,{projectId:schemaType.projectId,tokenId:schemaType.tokenId});const crossDatasetClient=useMemo(()=>{const token=isCurrentProject?void 0:(loadableToken==null?void 0:loadableToken.status)==="loaded"&&loadableToken.result;return client.withConfig({projectId:schemaType.projectId,dataset:schemaType.dataset,apiVersion:"2022-03-07",token:token||void 0,ignoreBrowserTokenWarning:true}).clone();},[client,isCurrentProject,loadableToken,schemaType.projectId,schemaType.dataset]);const documentValue=useFormValue([]);const documentRef=useValueRef(documentValue);const handleSearch=useCallback(searchString=>from(resolveUserDefinedFilter(schemaType.options,documentRef.current,path)).pipe(mergeMap(_ref411=>{let{filter,params}=_ref411;return search(crossDatasetClient,searchString,schemaType,_objectSpread(_objectSpread({},schemaType.options),{},{filter,params,tag:"search.cross-dataset-reference"}));}),catchError(err=>{var _a;const isQueryError=err.details&&err.details.type==="queryParseError";if(((_a=schemaType.options)==null?void 0:_a.filter)&&isQueryError){err.message="Invalid reference filter, please check the custom \"filter\" option";}return throwError(err);})),[crossDatasetClient,documentRef,path,schemaType]);const getReferenceInfo=useMemo(()=>createGetReferenceInfo({client:crossDatasetClient,documentPreviewStore}),[crossDatasetClient,documentPreviewStore]);if((loadableToken==null?void 0:loadableToken.status)==="loading"){return/* @__PURE__ */jsx(Box,{padding:2,children:/* @__PURE__ */jsx(Stack,{space:2,children:/* @__PURE__ */jsxs(Stack,{space:2,padding:1,children:[/* @__PURE__ */jsx(TextSkeleton,{style:{maxWidth:320},radius:1}),/* @__PURE__ */jsx(TextSkeleton,{style:{maxWidth:200},radius:1,size:1})]})})});}if(!isCurrentProject&&(loadableToken==null?void 0:loadableToken.status)==="loaded"&&!loadableToken.result){return/* @__PURE__ */jsxs(Stack,{space:2,marginY:2,children:[/* @__PURE__ */jsx(Text$1,{size:1,weight:"semibold",children:schemaType.title}),/* @__PURE__ */jsx(Alert,{title:"No cross dataset read token found",size:1,muted:true,children:/* @__PURE__ */jsxs(Stack,{space:3,children:[/* @__PURE__ */jsxs(Text$1,{size:1,children:["This cross dataset reference field requires a cross dataset token to be registered. Please configure a token"," ",schemaType.tokenId?/* @__PURE__ */jsxs(Fragment,{children:["with ID ",/* @__PURE__ */jsx("b",{children:schemaType.tokenId})]}):null," ","for project ",/* @__PURE__ */jsx("b",{children:schemaType.projectId})," that has read access to the"," ",/* @__PURE__ */jsx("b",{children:schemaType.dataset}),"-dataset."]}),/* @__PURE__ */jsxs(Text$1,{size:1,children:["See the documentation for"," ",/* @__PURE__ */jsx("a",{href:"https://www.sanity.io/docs/cross-dataset-references",children:"Cross Dataset References"})," ","for more details."]})]})})]});}return/* @__PURE__ */jsx(CrossDatasetReferenceInput,_objectSpread(_objectSpread({},props),{},{getReferenceInfo,onSearch:handleSearch}));}const defaultInputs={document:ObjectInput,object:ObjectInput,array:StudioArrayInput,boolean:BooleanInput,number:NumberInput,text:TextInput,email:EmailInput,datetime:DateTimeInput,date:DateInput,url:UrlInput,image:StudioImageInput,file:StudioFileInput,string:StringInput,slug:SlugInput,crossDatasetReference:StudioCrossDatasetReferenceInput};function resolveComponentFromTypeVariants(type){if(is("array",type)){return resolveArrayInput(type);}if(is("reference",type)){return resolveReferenceInput(type);}if(is("string",type)){return resolveStringInput(type);}if(is("number",type)){return resolveNumberInput(type);}return void 0;}function getTypeChain(type,visited){if(!type)return[];if(visited.has(type))return[];visited.add(type);const next=type.type?getTypeChain(type.type,visited):[];return[type,...next];}function defaultResolveInputComponent(schemaType){var _a;if((_a=schemaType.components)==null?void 0:_a.input)return schemaType.components.input;const componentFromTypeVariants=resolveComponentFromTypeVariants(schemaType);if(componentFromTypeVariants){return componentFromTypeVariants;}const typeChain=getTypeChain(schemaType,/* @__PURE__ */new Set());const deduped=typeChain.reduce((acc,type)=>{acc[type.name]=type;return acc;},{});const subType=Object.values(deduped).find(t=>defaultInputs[t.name]);if(subType){return defaultInputs[subType.name];}throw new Error("Could not find input component for schema type `".concat(schemaType.name,"`"));}function NoopField(_ref412){let{children}=_ref412;return/* @__PURE__ */jsx(Fragment,{children});}function PrimitiveField(field){return/* @__PURE__ */jsx(FormField,{"data-testid":"field-".concat(field.inputId),level:field.level,title:field.title,description:field.description,validation:field.validation,__unstable_presence:field.presence,children:/* @__PURE__ */jsx(ChangeIndicator,{path:field.path,hasFocus:Boolean(field.inputProps.focused),isChanged:field.inputProps.changed,children:field.children})});}function ObjectOrArrayField(field){return/* @__PURE__ */jsx(FormFieldSet,{"data-testid":"field-".concat(field.inputId),level:field.level,title:field.title,description:field.description,collapsed:field.collapsed,collapsible:field.collapsible,onCollapse:field.onCollapse,onExpand:field.onExpand,validation:field.validation,__unstable_presence:field.presence,children:field.children});}function ImageOrFileField(field){const hotspotField=field.inputProps.members.find(member=>member.kind==="field"&&member.name==="hotspot");const presence=(hotspotField==null?void 0:hotspotField.open)?field.presence:field.presence.concat((hotspotField==null?void 0:hotspotField.field.presence)||[]);return/* @__PURE__ */jsx(FormFieldSet,{level:field.level,title:field.title,description:field.description,collapsed:field.collapsed,collapsible:field.collapsible,onCollapse:field.onCollapse,onExpand:field.onExpand,validation:field.validation,__unstable_presence:presence,children:field.children});}function defaultResolveFieldComponent(schemaType){var _a;if((_a=schemaType.components)==null?void 0:_a.field)return schemaType.components.field;if(isBooleanSchemaType(schemaType)){return NoopField;}if(getTypeChain(schemaType,/* @__PURE__ */new Set()).some(t=>t.name==="image"||t.name==="file")){return ImageOrFileField;}if(schemaType.jsonType!=="object"&&schemaType.jsonType!=="array"){return PrimitiveField;}return ObjectOrArrayField;}function defaultResolveItemComponent(schemaType){var _a;if((_a=schemaType.components)==null?void 0:_a.item)return schemaType.components.item;return NoopField;}function defaultResolvePreviewComponent(){return SanityPreview;}const defaultRenderField=props=>{return createElement(defaultResolveFieldComponent(props.schemaType),props);};const defaultRenderInput=props=>{return createElement(defaultResolveInputComponent(props.schemaType),props);};const defaultRenderItem=props=>{return createElement(defaultResolveItemComponent(props.schemaType),props);};const defaultRenderPreview=props=>{return createElement(defaultResolvePreviewComponent(),props);};function _collectMiddleware$3(middlewares,plugins){var _a,_b;for(const plugin of plugins){if(plugin.plugins){_collectMiddleware$3(middlewares,plugin.plugins);}if((_a=plugin.form)==null?void 0:_a.renderField){middlewares.push((_b=plugin.form)==null?void 0:_b.renderField);}}}function _createRenderField(config){return props=>{var _a,_b;const middlewares=[];if(config.plugins){_collectMiddleware$3(middlewares,config.plugins);}if((_a=config.form)==null?void 0:_a.renderField){middlewares.push((_b=config.form)==null?void 0:_b.renderField);}let next=defaultRenderField;for(const middleware of middlewares){const defaultRender=next;next=fieldProps=>{return middleware(fieldProps,defaultRender)||defaultRender(fieldProps);};}return next(props);};}function _collectMiddleware$2(middlewares,plugins){var _a,_b;for(const plugin of plugins){if(plugin.plugins){_collectMiddleware$2(middlewares,plugin.plugins);}if((_a=plugin.form)==null?void 0:_a.renderInput){middlewares.push((_b=plugin.form)==null?void 0:_b.renderInput);}}}function _createRenderInput(config){return props=>{var _a,_b;const middlewares=[];if(config.plugins){_collectMiddleware$2(middlewares,config.plugins);}if((_a=config.form)==null?void 0:_a.renderInput){middlewares.push((_b=config.form)==null?void 0:_b.renderInput);}let next=defaultRenderInput;for(const middleware of middlewares){const defaultRender=next;next=inputProps=>{return middleware(inputProps,defaultRender)||defaultRender(inputProps);};}return next(props);};}function _collectMiddleware$1(middlewares,plugins){var _a,_b;for(const plugin of plugins){if(plugin.plugins){_collectMiddleware$1(middlewares,plugin.plugins);}if((_a=plugin.form)==null?void 0:_a.renderItem){middlewares.push((_b=plugin.form)==null?void 0:_b.renderItem);}}}function _createRenderItem(config){return props=>{var _a,_b;const middlewares=[];if(config.plugins){_collectMiddleware$1(middlewares,config.plugins);}if((_a=config.form)==null?void 0:_a.renderItem){middlewares.push((_b=config.form)==null?void 0:_b.renderItem);}let next=defaultRenderItem;for(const middleware of middlewares){const defaultRender=next;next=itemProps=>{return middleware(itemProps,defaultRender)||defaultRender(itemProps);};}return next(props);};}function _collectMiddleware(middlewares,plugins){var _a,_b;for(const plugin of plugins){if(plugin.plugins){_collectMiddleware(middlewares,plugin.plugins);}if((_a=plugin.form)==null?void 0:_a.renderPreview){middlewares.push((_b=plugin.form)==null?void 0:_b.renderPreview);}}}function _createRenderPreview(config){return props=>{var _a,_b;const middlewares=[];if(config.plugins){_collectMiddleware(middlewares,config.plugins);}if((_a=config.form)==null?void 0:_a.renderPreview){middlewares.push((_b=config.form)==null?void 0:_b.renderPreview);}let next=defaultRenderPreview;for(const middleware of middlewares){const defaultRender=next;next=previewProps=>{return middleware(previewProps,defaultRender)||defaultRender(previewProps);};}return next(props);};}function normalizeLogo(logo){if(isValidElementType(logo))return createElement(logo);if(isValidElement(logo))return logo;return void 0;}function normalizeIcon(icon,title){let subtitle=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";if(isValidElementType(icon))return createElement(icon);if(isValidElement(icon))return icon;return createDefaultIcon(title,subtitle);}function prepareConfig(config){const workspaceOptions=Array.isArray(config)?config:[config];try{validateWorkspaces({workspaces:workspaceOptions});}catch(e){throw new ConfigResolutionError({name:"",type:"workspace",causes:[e.message]});}const workspaces=workspaceOptions.map(_ref413=>{let{unstable_sources:nestedSources=[]}=_ref413,rootSource=_objectWithoutProperties(_ref413,_excluded105);const sources=[rootSource,...nestedSources];const resolvedSources=sources.map(source=>{const projectId=source.projectId;const dataset=source.dataset;const auth=source.auth||createAuthStore({dataset,projectId});let schemaTypes;try{schemaTypes=resolveConfigProperty({propertyName:"schema.types",config:source,context:{projectId,dataset},initialValue:[],reducer:schemaTypesReducer});}catch(e){throw new ConfigResolutionError({name:source.name,type:"source",causes:[e]});}const schema=createSchema({name:source.name,types:schemaTypes});const schemaValidationProblemGroups=schema._validation;const schemaErrors=schemaValidationProblemGroups==null?void 0:schemaValidationProblemGroups.filter(msg=>msg.problems.some(p=>p.severity==="error"));if(schemaValidationProblemGroups&&(schemaErrors==null?void 0:schemaErrors.length)){throw new SchemaError(schema);}const source$=auth.state.pipe(map(_ref414=>{let{client,authenticated,currentUser}=_ref414;return resolveSource({config:source,client,currentUser,schema,authenticated,auth});}),shareReplay(1));return Object.assign(source$,{name:source.name,projectId:source.projectId,dataset:source.dataset,title:source.title||startCase(source.name),auth,schema});});const title=rootSource.title||startCase(rootSource.name);const workspaceSummary={type:"workspace-summary",auth:resolvedSources[0].auth,basePath:rootSource.basePath||"/",dataset:rootSource.dataset,schema:resolvedSources[0].schema,logo:normalizeLogo(rootSource.logo),icon:normalizeIcon(rootSource.icon,title,"".concat(rootSource.projectId," ").concat(rootSource.dataset)),name:rootSource.name||"default",projectId:rootSource.projectId,theme:rootSource.theme||studioTheme,title,subtitle:rootSource.subtitle,__internal:{sources:resolvedSources}};return workspaceSummary;});return{type:"prepared-config",workspaces};}function getBifurClient(client,auth){const bifurVersionedClient=client.withConfig({apiVersion:"2022-06-30"});const dataset=bifurVersionedClient.config().dataset;const url=bifurVersionedClient.getUrl("/socket/".concat(dataset)).replace(/^http/,"ws");const options=auth.token?{token$:auth.token}:{};return fromUrl(url,options);}function resolveSource(_ref415){let{config,client,currentUser,schema,authenticated,auth}=_ref415;var _a,_b,_c,_d;const{dataset,projectId}=config;const bifur=getBifurClient(client,auth);const errors=[];const clients={};const getClient=options=>{if(!options||!options.apiVersion){throw new Error("Missing required `apiVersion` option");}if(!clients[options.apiVersion]){clients[options.apiVersion]=client.withConfig(options);}return clients[options.apiVersion];};const context={client,getClient,currentUser,dataset,projectId,schema};const wrappedClient=client;context.client=[...Object.keys(client),...Object.keys(wrappedClient.__proto__)].reduce((acc,key)=>{const original=Object.hasOwnProperty.call(client,key)?wrappedClient[key]:wrappedClient.__proto__[key];return Object.defineProperty(acc,key,{get(){console.warn('`configContext.client` is deprecated and will be removed in the next release! Use `context.getClient({apiVersion: "2021-06-07"})` instead');return original;}});},{});let templates;try{templates=resolveConfigProperty({config,context,propertyName:"schema.templates",reducer:schemaTemplatesReducer,initialValue:schema.getTypeNames().filter(typeName=>!/^sanity\./.test(typeName)).map(typeName=>schema.get(typeName)).filter(isNonNullable$4).filter(schemaType=>{var _a2;return((_a2=schemaType.type)==null?void 0:_a2.name)==="document";}).map(schemaType=>{const template={id:schemaType.name,schemaType:schemaType.name,title:schemaType.title||schemaType.name,icon:schemaType.icon,value:schemaType.initialValue||{_type:schemaType.name}};return template;})});}catch(e){errors.push(e);}let tools;try{tools=resolveConfigProperty({config,context,initialValue:[],propertyName:"tools",reducer:toolsReducer});}catch(e){errors.push(e);}const initialTemplatesResponses=templates.filter(template=>{var _a2;return!((_a2=template.parameters)==null?void 0:_a2.length);}).map(template=>({templateId:template.id,description:template.description,icon:template.icon,title:template.title}));const templateMap=templates.reduce((acc,template)=>{acc.set(template.id,template);return acc;},/* @__PURE__ */new Map());const resolveNewDocumentOptions=creationContext=>{const{schemaType:schemaTypeName}=creationContext;const templateResponses=resolveConfigProperty({config,context:_objectSpread(_objectSpread({},context),{},{creationContext}),initialValue:initialTemplatesResponses,propertyName:"document.resolveNewDocumentOptions",reducer:newDocumentOptionsResolver});const templateErrors=[];if(templateErrors.length){throw new ConfigResolutionError({name:config.name,type:"source",causes:templateErrors});}return templateResponses.map((response,index)=>{const template=templateMap.get(response.templateId);if(!template){throw new Error("Could not find template with ID `".concat(response.templateId,"`"));}const schemaType=schema.get(template.schemaType);if(!schemaType){throw new Error("Could not find matching schema type `".concat(template.schemaType,"` for template `").concat(template.id,"`"));}const title=response.title||template.title;const defaultSubtitle=(schemaType==null?void 0:schemaType.title)===title?void 0:schemaType==null?void 0:schemaType.title;return{id:"".concat(response.templateId,"-").concat(index),templateId:response.templateId,type:"initialValueTemplateItem",title,subtitle:response.subtitle||defaultSubtitle,description:response.description||template.description,icon:response.icon||template.icon||(schemaType==null?void 0:schemaType.icon),initialDocumentId:response.initialDocumentId,parameters:response.parameters,schemaType:template.schemaType};}).filter(item=>{var _a2;if(!schemaTypeName)return true;return schemaTypeName===((_a2=templateMap.get(item.templateId))==null?void 0:_a2.schemaType);});};let staticInitialValueTemplateItems;try{staticInitialValueTemplateItems=resolveNewDocumentOptions({type:"global"});}catch(e){errors.push(e);}if(errors.length){throw new ConfigResolutionError({name:config.name,type:"source",causes:errors});}const source={type:"source",name:config.name,title:config.title||startCase(config.name),schema,getClient,dataset,projectId,tools,currentUser,authenticated,templates,auth,document:{actions:partialContext=>resolveConfigProperty({config,context:_objectSpread(_objectSpread({},context),partialContext),initialValue:initialDocumentActions,propertyName:"document.actions",reducer:documentActionsReducer}),badges:partialContext=>resolveConfigProperty({config,context:_objectSpread(_objectSpread({},context),partialContext),initialValue:initialDocumentBadges,propertyName:"document.badges",reducer:documentBadgesReducer}),resolveProductionUrl:partialContext=>resolveConfigProperty({config,context:_objectSpread(_objectSpread({},context),partialContext),initialValue:void 0,propertyName:"resolveProductionUrl",asyncReducer:resolveProductionUrlReducer}),resolveNewDocumentOptions,unstable_languageFilter:partialContext=>resolveConfigProperty({config,context:_objectSpread(_objectSpread({},context),partialContext),initialValue:initialLanguageFilter,propertyName:"document.unstable_languageFilter",reducer:_documentLanguageFilterReducer})},form:{renderField:_createRenderField(config),renderInput:_createRenderInput(config),renderItem:_createRenderItem(config),renderPreview:_createRenderPreview(config),file:{assetSources:resolveConfigProperty({config,context,initialValue:defaultFileAssetSources,propertyName:"formBuilder.file.assetSources",reducer:fileAssetSourceResolver}),directUploads:((_b=(_a=config.form)==null?void 0:_a.file)==null?void 0:_b.directUploads)===void 0?true:config.form.file.directUploads},image:{assetSources:resolveConfigProperty({config,context,initialValue:defaultImageAssetSources,propertyName:"formBuilder.image.assetSources",reducer:imageAssetSourceResolver}),directUploads:((_d=(_c=config.form)==null?void 0:_c.file)==null?void 0:_d.directUploads)===void 0?true:config.form.file.directUploads}},__internal:{bifur,staticInitialValueTemplateItems}};return source;}export{DatetimePreview as $,StateLink as A,route as B,useIntentLink as C,useLink as D,useRouter as E,useRouterState$1 as F,useStateLink as G,withRouter as H,IntentLink as I,WithRouter as J,FormFieldPresenceContext as K,Link as L,useProjectStore as M,defaults as N,useUserColorManager as O,PatchEvent as P,getAnnotationColor as Q,RouteScope as R,StudioProvider as S,ToolLink as T,DiffTooltip as U,Checkbox as V,WorkspaceProvider as W,FromToArrow as X,SanityPreview as Y,ZIndexContext as Z,DiffFromTo as _,StudioLayout as a,usePresenceStore as a$,StringPreview as a0,SlugPreview as a1,ConfirmDeleteDialogContainer as a2,DocumentPreviewPresence as a3,FieldPresence as a4,FieldPresenceWithOverlay as a5,FieldPresenceWithoutOverlay as a6,OverlayDisabled as a7,PresenceOverlay as a8,SanityDefaultPreview as a9,TemplatePreview as aA,CircularProgress as aB,LinearProgress as aC,createScope as aD,createUseReporter as aE,useRovingFocus as aF,useOnScroll as aG,ScrollContainer as aH,ScrollMonitor as aI,ImperativeToast as aJ,LegacyLayerProvider as aK,ValidationList as aL,useZIndex as aM,_createAuthStore as aN,createAuthStore as aO,CONNECTING as aP,onRetry as aQ,createConnectionStatusStore as aR,CorsOriginError as aS,__tmp_wrap_crossProjectToken as aT,useUserStore as aU,useGrantsStore as aV,useHistoryStore as aW,useDocumentPreviewStore as aX,useCrossProjectTokenStore as aY,useDocumentStore as aZ,useConnectionStatusStore as a_,InsufficientPermissionsMessage as aa,StyledCard$1 as ab,usePreviewCard as ac,PreviewCard$2 as ad,TextWithToneStyle as ae,TextWithTone as af,UserAvatar as ag,WithReferringDocuments as ah,ChangeFieldWrapper as ai,ChangeIndicator as aj,ChangeIndicatorContext as ak,ConnectorContext as al,EnabledChangeConnectorRoot as am,DisabledChangeConnectorRoot as an,ChangeConnectorRoot as ao,Tracker as ap,useReportedValues as aq,useReporter as ar,CollapseMenu as as,CollapseMenuButton as at,DefaultPreview as au,DetailPreview as av,MediaPreview as aw,BlockImagePreview as ax,BlockPreview$1 as ay,InlinePreview as az,SANITY_VERSION as b,HELP_URL as b$,useSettingsStore as b0,useResolveInitialValueForType as b1,createBufferedDocument as b2,createObservableBufferedDocument as b3,checkoutPair as b4,editState as b5,GUARDED as b6,createOperationsAPI as b7,remoteSnapshots as b8,snapshotPair as b9,SESSION_ID as bA,__tmp_wrap_presenceStore as bB,useGlobalPresence as bC,useDocumentPresence as bD,createProjectStore as bE,createSettingsStore as bF,createUserStore as bG,DocumentBuilder as bH,documentFromEditor as bI,documentFromEditorWithInitialValue as bJ,DocumentListBuilder as bK,getTypeNamesFromFilter as bL,shallowIntentChecker as bM,GenericListBuilder as bN,InitialValueTemplateItemBuilder as bO,defaultInitialValueTemplateItems as bP,maybeSerializeInitialValueTemplateItem as bQ,menuItemsFromInitialValueTemplateItems as bR,DEFAULT_INTENT_HANDLER as bS,defaultIntentChecker as bT,maybeSerializeMenuItem as bU,MenuItemBuilder as bV,getOrderingMenuItem as bW,getOrderingMenuItemsForSchemaType as bX,maybeSerializeMenuItemGroup as bY,MenuItemGroupBuilder as bZ,SerializeError as b_,validation as ba,emitOperation as bb,getOperationEvents as bc,createDocumentStore as bd,getPairListener as be,useDocumentType as bf,useDocumentValues as bg,getInitialValueStream as bh,listenQuery as bi,useInitialValue as bj,useInitialValueResolverContext as bk,getDocumentPairPermissions as bl,useDocumentPairPermissionsFromHookFactory as bm,useDocumentPairPermissions as bn,getDocumentValuePermissions as bo,useDocumentValuePermissionsFromHookFactory as bp,useDocumentValuePermissions as bq,getTemplatePermissions as br,useTemplatePermissionsFromHookFactory as bs,useTemplatePermissions as bt,createGrantsStore as bu,removeMissingReferences as bv,createHistoryStore as bw,TimelineController as bx,createObservableController as by,Timeline$1 as bz,useCurrentUser as c,MemberItemError as c$,form as c0,component as c1,FormViewBuilder as c2,ComponentViewBuilder as c3,GenericViewBuilder as c4,maybeSerializeView as c5,useDocumentChange as c6,useAnnotationColor as c7,useDiffAnnotationColor as c8,getAnnotationAtPath as c9,FieldChange as cA,GroupChange as cB,RevertChangesButton as cC,ValueError as cD,useTimeAgo as cE,createSchema as cF,useUserColor as cG,createUserColorManager as cH,UserColorManagerProvider as cI,prepareConfig as cJ,validateId as cK,isRecord$2 as cL,DEFAULT_SELECTED_ORDERING_OPTION as cM,views as cN,EMPTY_PARAMS as cO,useDocumentPane as cP,DeleteAction as cQ,PublishAction as cR,DuplicateAction as cS,UnpublishAction as cT,DiscardChangesAction as cU,HistoryRestoreAction as cV,usePaneRouter as cW,ReviewChangesContext as cX,encodePath as cY,decodePath as cZ,ArrayOfObjectsItem as c_,getDiffAtPath as ca,visitDiff as cb,ChangeList as cc,ChangeResolver as cd,DiffCard as ce,DiffErrorBoundary as cf,DiffStringSegment as cg,DiffString as ch,FromTo as ci,MetaInfo as cj,NoChanges as ck,DiffContext as cl,DocumentChangeContext as cm,getChangeVerb as cn,noop$2 as co,isFieldChange as cp,isGroupChange as cq,isAddedItemDiff as cr,isRemovedItemDiff as cs,isUnchangedDiff as ct,resolveDiffComponent as cu,getValueError as cv,ChangeBreadcrumb as cw,ChangeTitleSegment as cx,DiffInspectWrapper as cy,FallbackDiff as cz,useUser as d,DeskTool as d$,StudioArrayInput as d0,useFormBuilder as d1,PortableTextInput as d2,FormInput as d3,useReferenceInputOptions as d4,ReferenceInputOptionsProvider as d5,StudioFormBuilder as d6,StudioFormBuilderProvider as d7,MemberField as d8,MemberFieldError as d9,FormFieldHeaderText as dA,FormFieldSet as dB,FormFieldStatus as dC,FormFieldValidationStatus as dD,useDeskTool as dE,PaneHeader as dF,PaneHeaderActions as dG,BackLink as dH,usePane as dI,Pane as dJ,DocumentPane as dK,DocumentPaneProvider as dL,collate as dM,usePaneLayout as dN,Delay as dO,PaneContent as dP,DEFAULT_STUDIO_CLIENT_OPTIONS as dQ,useDeskToolSetting as dR,useUnique as dS,_DEBUG as dT,PaneItemPreview as dU,DeskToolContext as dV,createPaneResolver as dW,assignId as dX,memoBind as dY,PaneResolutionError as dZ,StructureError as d_,MemberFieldSet as da,ArrayOfPrimitivesItem as db,ObjectMembers as dc,createPatchChannel as dd,setIfMissing as de,insert as df,set as dg,unset as dh,inc as di,dec as dj,prefixPath as dk,isObjectItemProps as dl,isObjectInputProps as dm,isStringInputProps as dn,isNumberInputProps as dp,isBooleanInputProps as dq,isArrayOfObjectsInputProps as dr,isArrayOfPrimitivesInputProps as ds,useFormState as dt,useFormValue as du,toMutationPatches as dv,fromMutationPatches as dw,ObjectInput as dx,ArrayInput as dy,FormField as dz,isProd as e,useClient as f,useConnectionState as g,useDataset as h,isDev as i,useDocumentOperation as j,useEditState as k,useProjectId as l,useSchema as m,useSyncState as n,useTemplates as o,useValidationStatus as p,SourceProvider as q,ToolMenu as r,useColorScheme as s,useWorkspace as t,useSource as u,useWorkspaces as v,getDraftId as w,getPublishedId as x,RouterContext as y,RouterProvider as z};
//# sourceMappingURL=_prepareConfig-56d87958.js.map
